# load libraries
# library(MASS)
# library(foreach)
# library(lattice)
# library(nnet)
# library(mlogit)
# library(mlogitBMA)
# library(ipred)
# library(lattice)
# library(mlogit)
# library(Hmisc)
# library(rms)
library(splines)
# library(BMA)
# library(relaimpo)
# library(car)
# library(DAAG)
# library(Hmisc)
# library(mice)
# library(rms)
# library(splines)
# library(randomForest)
# library(BMA)
# library(Hmisc)
# library(mice)
# library(rms)
# library(splines)
# library(randomForest)
# library(BMA)
# library(Hmisc)
# library(mice)
# library(rms)
# library(splines)
# library(randomForest)
# library(BMA)
# library(RColorBrewer)


#get.lung.incidence.pdf.small

# given a regression model, will turn things to NA if it isn't in the keep list
# to try to save spce
# form = y~x + z
# environment(form) = NULL
# result = nnet(form, ...)

stripModel <- function(model) {
    skinny_model <- model
    model_things <- names(model)
    keep_things <- c("coefficients","terms","rank","family","qr","deviance","null.deviance","aic")
    for (i in 1:length(model_things)) {
        if (!(model_things[i] %in% keep_things)) {
            skinny_model[model_things[i]] <- c()
        }
    }

    # all the other things to strip from (http://www.win-vector.com/blog/2014/05/trimming-the-fat-from-glm-models-in-r/)
      skinny_model$y = c()
      skinny_model$model = c()

      skinny_model$residuals = c()
      skinny_model$fitted.values = c()
      skinny_model$effects = c()
      skinny_model$qr$qr = c()
      skinny_model$linear.predictors = c()
      skinny_model$weights = c()
      skinny_model$prior.weights = c()
      skinny_model$data = c()

      skinny_model$family$variance = c()
      skinny_model$family$dev.resids = c()
      skinny_model$family$aic = c()
      skinny_model$family$validmu = c()
      skinny_model$family$simulate = c()
      attr(skinny_model$terms,".Environment") = c() # must strip this to reduce size - but can't do ns
      attr(skinny_model$formula,".Environment") = c()

    return(skinny_model)
    # return(model)  # actually doesn't save space
}

# returns serialized size
getSize = function(n) {
  length(serialize(n, NULL))
}


########################### [1] TSCE related functions ################################################

# ploting module for probability of tumor
p2.plot <-function (model = model, pars=pars, profile = profile, age=age, plt = T,  ...) {
        # compute tumor prob

		# > profile
		# $breaks
		# [1]  17  60 115  # start at 17, quit at 50 and death age 115
		#
		# $dose
		# [1]  0 30  0
		#
		if(max(age) > max(profile$breaks)) {

			warning("aligning last break point in profile$breaks ")
			profile$breaks[length(profile$breaks)] <- max(age)

		}

		Hi <- numeric(2)

		### this is the empty output
		prob <- numeric(length(age))
		# > prob[1:5]
		# [1] 0 0 0 0 0   # first age, second age, third age..
		# > Hi
		# [1] 0 0
		ic <- 1

		for (ti in age) {

			#ti=70  # until the age 70

			t2 <- c(profile$breaks[profile$breaks < ti], ti)
		   # [1] 17 60 70

			k <- length(t2) #[1] 3
			t1 <- c(0,t2[1:(k-1)])  #[1]  0 17 60
			t21 <- t2-t1   #[1] 17 43 10       # age increment

			Hi[1] <- 0
			Hval <- numeric(k)


			for (j in k:1) {  # for 3 2 1  or 2 1 depending on you're current or former smokers
					# > k
					# [1] 3

					## parameters for agiven dosage level
					p=model(pars,j,profile)   # j is entro of dose e.g. profile$dose[j]
					#[1]  1.000000e+00 -9.554762e-02  2.619092e-06  2.780533e-01  #c(a0, At, Bt, Ct))

					## hazard calculation ##
					# > t21[j]
					# [1] 10    # time increment
					# > Hi[1]
					# [1] 0     # baseline hazard?

					Hi = H(p, t21[j], w=Hi[1])
					#[1] -4.190187e-06 -4.911667e-06  #c(w,Ct*log((Bt-At)/f))

					Hval[j] <- Hi[2]  # Hi[2] -4.911667e-06  #Ct*log((Bt-At)/f)

					#Hval
					#[1] -0.07894224 -0.0138129 -4.911667e-06  # it's filled up from the last dosa

					# this is hazard for time between age 0-17, 17-60, 60-110
					#                                      0      30     0
					# hazard is the highest during 17-60


			}# end of for loop

			prob[ic] <- 1-exp(sum(Hval))
			ic <- ic + 1    # ic= 1, 2, 3, 4, ------>  first age, second age, third age..

		}# end of for (ti in age)


		if (plt) {  plot(spline(age, prob), type = "l", xlab = "age", ylab = "probability of tumor", ...) }

		else return(prob)
}


model.NHSHPFS <- function (pars,j,profile) {  # this returns a set of TSCE parmeters (reparametrized to be used for hazard calculation)
                                              # for given smoking history and stage (and its dosage) of your smoking (j)
                                              # what is j? jth entry in dose[] # j=1: dose at the first stage, j=2: dose at second stage
                                              # j=3: dose at last stage

	# profile
	# $breaks
	# [1]  17  60 115
	#
	# $dose
	# [1]  0 30  0
	# > j
	# [1] 3

	# notation as in
	#
	#       Heidenreich WF, Luebeck EG, Moolgavkar SH.
	#  Some properties of the hazard function of the two-mutation
	#	clonal expansion model. Risk Anal:391-399, 1997.
	#
	#       At: A tilde
	#       Bt: B tilde
	#       Ct: C tilde = nu X/alpha
	#       a0: alpha/alpha0
	#       g:  (alpha - beta - mu)
			x <- 1e+07
			al0 <- pars[1]

		if(profile$dose[j] ==0) {     # if dose is zero

			 al <- pars[1]
			 gi <- pars[2]
			 nu <- pars[3]
			 mu <- pars[3]
		}

		if(profile$dose[j] > 0) {    # if dose > 0

			 al <- pars[1]*(1 + pars[4]*profile$dose[j]^pars[5])
			 gi <- pars[2]*(1 + pars[4]*profile$dose[j]^pars[5])
			 nu <- pars[3]
			 mu <- pars[3]*(1 + pars[6]*profile$dose[j]^pars[7])

		}

			 Bt <- (-gi+sqrt(gi^2 + 4* al*mu ))/2
			 At <- (-gi-sqrt(gi^2 + 4* al*mu ))/2
			 Ct <- x*nu/al
			 a0 <- al/al0
			return(c(a0, At, Bt, Ct))
}


# recursion for cumulative hazard
H <- function (p, t21, w) {  # p is a set of TSCE parameters, t21 is time interval, w is some base..

        a0 <- p[1]
        At <- p[2]
        Bt <- p[3]
        Ct <- p[4]
        #!update w
        w <- w * a0

        f1 <- (Bt - w) * exp(-At * (t21))
        f2 <- (At - w) * exp(-Bt * (t21))
        f <- (f1 - f2)
        w <- (At*f1-Bt*f2)/f/a0
        return(c(w,Ct*log((Bt-At)/f))) # i think it is supposed to give -hazard value
}

# This R script computes the exact hazard function of the
# MVK model for acute initiation and piecewise constant parameters

# recursion for hazard
h <- function (p, t21, w, dw) {
        a0 <- p[1]
        At <- p[2]
        Bt <- p[3]
        Ct <- p[4]
        #!update w
        w <- w * a0
        #!update dw
        dw <- dw * a0

        f1 <- (Bt - w) * exp(-At * (t21))
        f2 <- (At - w) * exp(-Bt * (t21))
        f <- (f1 - f2)
        #!initialize dw=d tilde{y}/ dt
        if (dw == 0) {
                dw <- At * Bt
        }
        dfdt <- dw * (exp(-Bt * (t21)) - exp(-At * (t21)))
        dw <- ((Bt - At)^2) * exp(-(At + Bt) * t21) * dw/f/f/a0
        w <- (At * f1 - Bt * f2)/f/a0
        return(c(w,dw,Ct * dfdt/f))
}


# ploting module for survival function
s2.plot <-function (model = model, pars=pars,profile = profile, age=age, plt = T,  ...) {
        # compute tumor prob
	if(max(age) > max(profile$breaks)) {
	   warning("aligning last break point in profile$breaks ")
	   profile$breaks[length(profile$breaks)] <- max(age)
	}
        Hi <- numeric(2)
        surv <- numeric(length(age))
        ic <- 1

        for (ti in age) {
			t2 <- c(profile$breaks[profile$breaks < ti], ti)
			k <- length(t2)
			t1 <- c(0,t2[1:(k-1)])
			t21 <- t2-t1

			Hi[1] <- 0
			Hval <- numeric(k)
			for (j in k:1) {
					Hi <- H(model(pars,j), t21[j], Hi[1])
							Hval[j] <- Hi[2]
			}
			surv[ic] <- exp(sum(Hval))
			ic <- ic + 1
        }

        if (plt) {

                plot(spline(age, surv), type = "l", xlab = "age", ylab = "survival", ...)
        }
        else return(surv)
}






model.cpsI <- function (pars,j,profile) {
	# notation as in
	#
	#       Heidenreich WF, Luebeck EG, Moolgavkar SH.
	#  Some properties of the hazard function of the two-mutation
	#	clonal expansion model. Risk Anal:391-399, 1997.
	#
	#       At: A tilde
	#       Bt: B tilde
	#       Ct: C tilde = nu X/alpha
	#       a0: alpha/alpha0
	#       g:  (alpha - beta - mu)
			x <- 1e+07
			al0 <- pars[1]
			g0 <- pars[2]
			nu0 <- pars[3]
			mu0 <- pars[3]
			nuic <- pars[4]
			gic <- pars[5]
			gip <- pars[6]

		if(profile$dose[j] ==0) {
			 al <- pars[1]
			 gi <- pars[2]
			 nu <- pars[3]
			 mu <- pars[3]
		}
		if(profile$dose[j] > 0) {
			  al <- pars[1]*(1 + pars[5]*profile$dose[j]^pars[6])
			  gi <- pars[2]*(1 + pars[5]*profile$dose[j]^pars[6])
			  nu <- pars[3]*(1 + pars[4])
			  mu <- pars[3]
		}
		 Bt <- (-gi+sqrt(gi^2 + 4* al*mu ))/2
		 At <- (-gi-sqrt(gi^2 + 4* al*mu ))/2
		 Ct <- x*nu/al
		 a0 <- al/al0
		return(c(a0, At, Bt, Ct))
}

# ploting modules for hazard
h2.plot <- function (model = model, pars=pars,profile = profile, age=age, plt = T, ...) {
        # compute hazard by summing contrib. from time intervals
	if(max(age) > max(profile$breaks)) {
	    warning("aligning last break point in profile$breaks ")
	    profile$breaks[length(profile$breaks)] <- max(age)
	}
        hi <- numeric(3)
        hazard <- numeric(length(age))
        ic <- 1

        for (ti in age) {

			t2 <- c(profile$breaks[profile$breaks < ti], ti)
			k <- length(t2)
			t1 <- c(0,t2[1:(k-1)])
			t21 <- t2-t1

			hi[1] <- 0
			hi[2] <- 0
			hval <- numeric(k)

			for (j in k:1) {

				hi <- h(model(pars,j,profile), t21[j], hi[1], hi[2])
				hval[j] <- hi[3]
			}

			hazard[ic] <- sum(hval)
			ic <- ic + 1

        }#for (ti in age) {

        if (plt) {  plot(spline(age, hazard), type = "l", xlab = "age", ylab = "hazard", ...) }
        else return(hazard)
}





# profile0 <- list(aae=c(20,40,120),dose=c(0,10,0))
# h2a.plot(model0,profile0,age)

h2a.plot <- function (model = model0, profile = profile0, age, plt = T,  ...) {
          # compute hazard
            hazard <- numeric(0)
            #tilde vectors
            p <- model(u)
            ic <- 1
            for (ti in age) {
                    H <- 0
                    j <- 1
                    while (j <= length(profile$aae) & profile$aae[j] < ti) {
                            # acute dose
                            p[4] <- profile$dose[j] # init. cells/a0
                            H <- H + h2a(p, profile$aae[j], ti)
                            j <- j + 1
                    }
                    hazard[ic] <- H
                    ic <- ic + 1
            }
            if (plt) {
                    plot(spline(age, hazard), type = "l", xlab = "age",
                            ylab = "hazard", ...)
            }
            else return(hazard)
}

h2a <-function (p, t1, t2) {
            a0 <- p[1]
            At <- p[2]
            Bt <- p[3]
            Rt <- p[4]
            t21 <- (t2 - t1)
            if (t21 >= 0) {
                    f1 <- Bt * exp(-At * (t21))
                    f2 <- At * exp(-Bt * (t21))
                    f <- (f1 - f2)
                    dfdu <- At * f1 - Bt * f2
                    df2dudt <- Bt * Bt * f2 - At * At * f1
                    return(-Rt * (dfdu * dfdu + df2dudt * f)/f/f)
            }
            else return(0)
}

s2a <- function (p, t1, t2) {
        a0 <- p[1]
        At <- p[2]
        Bt <- p[3]
        Rt <- p[4]
        t21 <- (t2 - t1)
	if(t21 > 0) {
        f1 <- Bt * exp(-At * (t21))
        f2 <- At * exp(-Bt * (t21))
        f <- (f1 - f2)
	dfdu <- At*f1-Bt*f2
        return(Rt*dfdu/f)
	} else return(0)
}



################### Other cause of mortality related function ############################


hzocm=function(age,agerand,gender,pkyr,cigsmok) { # hazard for other cause of mortality given age, randomized age, pack-years, smoking status

	  # Other cause mortality rate model at Age=age
	  # age - Age(s) at which compute the OC mortality rates
	  # agerand: age at randomization
	  # gender: 1=Male, 2=Female
	  # pkyr: Pack years
	  # cigsmok: Smoking status at randomization 0=Former , 1=Current

	  # Examples:
	  #   hzocm(63,   63,1,40,1) computes the OCmortality rate at Age 63
	  #   hzocm(63:67,63,1,40,1) computes the OCmortality rate at Ages 63:67

	  # Author          Rafael Meza
	  # Organization    University of Michigan
	  # Last updated    February 7, 2012
	  # Version 1.

	  #### base mortality depending on randomized age group

	  A0f=c(0.23549E-04,0.57908E-05,0.19265E-06,0.88314E-05)  # female  mortality hazard is low
	  A0m=c(0.89569E-05,0.13540E-04,0.10503E-04,0.51381E-04)  # male

	  #### age effect coefficient
	  Gf=c(0.0540,0.0786,0.1269,0.0763) ## depending on the age group: gender effect is high when you get older
	  Gm=c(0.0782,0.0697,0.0764,0.0552)

	  b1=0.63016 # pack years coefficient
	  b2=-0.64628 # smoking status coefficient

	  smkstat=1-cigsmok  # 1 for Former, 0 for current (baseline current smokers)

	  ####### (1) Assing age group depending on randomization age:

	      # AGE GROUP 1  : if age.rand <=60
	      #           2  : if age.rand <=65
	      #           3  : if age.rand <=70
	      #           4  : if age.rand > 70

	  if (agerand<=60){

		  AGEGP=1

	  }else{

		  if (agerand<=65)

			 AGEGP=2

		  else
			{
			  if (agerand<=70)
				{
				  AGEGP=3}
			  else
				{
				  AGEGP=4}
			}
		}# end of else


	  ########## (2) Coefficient assignment A0: base mortality,  G: age effect

	  if (gender==2){  # female

		  A0=A0f[AGEGP]
		  G=Gf[AGEGP]

		}else{
		  if (gender==1) # Male
			{
			  A0=A0m[AGEGP]
			  G=Gm[AGEGP]}
		  else
			{
			  stop("Not valid Gender value")
			}
		}# end of else


	  hz=c()

	  for (i in 1:length(age)){  # age [1] 46 47 48 49   : start from randomized age why

		  hz=c(hz,A0*exp(G*age[i])*exp(b1*log(pkyr)+b2*smkstat))
	  }


	  hz   # accumulated hazard

}#hzocm=function(age,agerand,gender,pkyr,cigsmok) {











###################[2] Get incidence distribution ########################################


#x=c(
        ##### 12/18/2012: use hazard instead of f(t) derived from F(t) ###

        get.lung.incidence.pdf.small2 <- function(x,pars,doPlot=F,hazard=T){ # for the given smoking history, this will produce a prob for lung cancer incidence for a given age (p.d.f)
				 # x
				 # cigsmok  smokeage  age_quit  smokeday death.age
				 #         1         5         0        30       115

				 ######### (1) Make a profile for the argument ###########
				######### Make profile = list( breaks, dose) for each individual which is an argment for p2.plot() ######
				# current smoker: profile <- list(breaks=c(20,100),dose=c(0,20)):    until age 20, dose was 0 and from then on to 100, dose was 20 (current smoker)
				# former smoker: profile <- list(breaks=c(20,45,100),dose=c(0,40,0)): until age 20, dose=0, until age 45, dose 40, then quit

				 prof=NULL

				 if(x[1] == 1){   # if current smoker
													# start.age, death.time       0, cig/day
					  prof = list(breaks=as.vector(c(x[2],x[5])),dose=as.vector(c(0,x[4])))
						# > prof
						# $breaks
						# [1]   5 115    # until age 5, dose=0, until death, dose= 30
						#
						# $dose
						# [1]  0 30

				 } else{  # if former smoker
										   # start.age, quit.age, death.time
						prof = list(breaks=as.vector(c(x[2],x[3],x[5])), dose =as.vector(c(0,x[4],0)))
						# $breaks
						# [1]  17  60 115
						#
						# $dose
						# [1]  0 30  0    # until age 17, dose=0, until age 60, dose=30, until death zero dose

						#   cigsmok  smokeage  age_quit  smokeday death.age
						#         0        17        60        30       115

				 }# end of else

                 prof


				  ########(2) Use p2.plot() (TSCE model to get probabilty of incidence for each age? ############

				  model = model.NHSHPFS
				  profile=prof
				  age=c(0:death.age)  # this will calculate from 1 to death.age


				  doPlot2=F
				  if(doPlot2==T){

						hz0=h2.plot(model,pars,profile,age,plt=T,main="Hazard" )# ,main=paste("individual=",i,sep=""))   # cumulative probability of tumor-onset for this person
						abline(v=profile[[1]],col=c("red","blue","black"),lty="dotted",lwd=1.5)
						title(sub=paste("dose:",paste(profile$dose,collapse="-"),sep=""))

						pr0=p2.plot(model,pars,profile,age,plt=T,main="Cumulative risk for cancer incidence")# ,main=paste("individual=",i,sep=""))   # cumulative probability of tumor-onset for this person
						abline(v=profile[[1]],col=c("red","blue","black"),lty="dotted",lwd=1.5)
						title(sub=paste("dose:",paste(profile$dose,collapse="-"),sep=""))
						#hz=h2.plot(model,pars,profile,age,plt=F)# ,main=paste("individual=",i,sep=""))   # cumulative probability of tumor-onset for this person
						#pr=p2.plot(model,pars,profile,age,plt=F)# ,main=paste("individual=",i,sep=""))   # cumulative probability of tumor-onset for this person
																	  # detectable tumor
						# > length(hz)
						# [1] 115
						# > hz0[1:5]
						# [1] 7.301485e-08 1.533500e-07 2.417393e-07 3.389902e-07 4.459911e-07
						# > pr0[1:5]
						# [1] 3.592616e-08 1.484690e-07 3.453100e-07 6.349005e-07 1.026539e-06
						# > tt=80;1-exp(-sum(hz[1:tt])); pr[tt]
						# [1] 0.1677581
						# [1] 0.1612856

						#max(pr0)
						#[1]0.5126991   # cumlative risk of cancer incidence until you die: prob{you get cancer by the age 115}

				  }#do this

				#if(hazard==F){ # then use F(t) to get f(t) ####

					##### cumulative probability until a give age ####

					pr=p2.plot(model,pars,profile,age,plt=F)

					pmf = pr[-1] - pr[-length(pr)]
					pmf[1:5]
					pr[2]-pr[1]   # this is the prob betwen age 0 and 1
					# > pmf[1:5]
					# [1] 1.125429e-07 1.968410e-07 2.895905e-07 3.916386e-07 5.039174e-07
					# > pr[2]-pr[1]
					# [1] 1.125429e-07
					names(pmf)=age[-1]

					#if(doPlot==T) {

					  # cumulativeRisk = signif(sum(pmf),2)
					  # Main=paste("Probability Density Function for incidence",paste("\n Cumulative life time risk =", cumulativeRisk,sep=""))
					  # plot(spline(age[-1],pmf),type="l",main=Main,ylab="PDF",xlab="Age")
					  # abline(v=profile[[1]],col=c("red","blue","black"),lty="dotted",lwd=1.5)
					  # title(sub=paste("dose:",paste(profile$dose,collapse="-"),sep=""))

					#}# end of plot

				   #names(pmf)=paste(age[-1])

				   #ans=pmf


				#}#3nd ofif(hazard==F){


				if(hazard==T){ # then use F(t) to get f(t) ####

					##### cumulative probability until a give age ####

					hz=h2.plot(model,pars,profile,age,plt=F)
					names(hz)=age

					#hz2 = hz[-1] - hz[-length(hz)]
					#hz2[1:5]
					#hz[2]-hz[1]   # this is the prob betwen age 0 and 1
					# > pmf[1:5]
					# [1] 1.125429e-07 1.968410e-07 2.895905e-07 3.916386e-07 5.039174e-07
					# > pr[2]-pr[1]
					# [1] 1.125429e-07
					#names(hz2)=age[-1]

					if(doPlot==T) {

					   #cumulativeRisk = signif(sum(pmf),2)
					   #Main=paste("Probability Density Function for incidence",paste("\n Cumulative life time risk =", cumulativeRisk,sep=""))

					   #plot(spline(age,hz),type="l",main="Hazard",ylab="Hazard",xlab="Age",col="red")
					   #title(sub=paste("cumulative life time risk =", cumulativeRisk,sep=""))

					   plot(1:length(hz),hz,type="l",main="Hazard",ylab="Hazard",xlab="Age",col="red")
					   abline(v=profile[[1]],col=c("red","blue","black"),lty="dotted",lwd=1.5)
					   title(sub=paste("dose:",paste(profile$dose,collapse="-"),sep=""))

					   lines(1:length(pmf),pmf,type="l",col="blue")
					   #plot(spline(age,c(0,pmf)),col="blue",type="l",axes=F,xlab="",ylab="")
					   #legend(x="topleft",legend=c("Hazard","pdf"),fill=c("red","blue"),bg="white")

					   #par(new=T)
					   #plot(spline(age,c(0,pmf)),col="blue",type="l",axes=F,xlab="",ylab="")
					   legend(x="topleft",legend=c("Hazard","pdf"),fill=c("red","blue"),bg="white")






					}# end of plot

				   #names(pmf)=paste(age[-1])

				   ans=hz


				}#3nd ofif(hazard==F){





				doThis=F
				if(doThis==T){

					# > names(pr)=age
					# > pr2[1:10]
					#            0            1            2            3            4            5            6            7
					# 0.000000e+00 3.592616e-08 1.484690e-07 3.453100e-07 6.349005e-07 1.026539e-06 1.530456e-06 2.157909e-06
					#            8            9
					# 2.921281e-06 3.834199e-06

					# > pmf[1:5]
					# [1] 3.592616e-08 1.125429e-07 1.968410e-07 2.895905e-07 3.916386e-07
				     inc=1
				     age2=seq(0,115,by=inc)
					 pr2=p2.plot(model,pars,profile,age2,plt=F)
					 names(pr2)=age2
					# > pr2[1:10]
					#            0         0.01         0.02         0.03         0.04         0.05         0.06         0.07
					# 0.000000e+00 3.480216e-12 1.392531e-11 3.134193e-11 5.573686e-11 8.711654e-11 1.254878e-10 1.708573e-10
					#         0.08         0.09
					# 2.232318e-10 2.826178e-10
					plot(1:length(pr2),pr2,type="l",axes=F)
					axis(1,at=1:length(pr2),labels=age2);axis(2)
					max(pr2);text(95,0.2,round(max(pr2),2),col="red")





					  pmf2 = (pr2[-1] - pr2[-length(pr2)])/inc
					  pmf3=pmf2[names(pmf2) %in% age]

					  sum(pmf3)
					  max(pr2)

					  plot(1:length(pmf3),pmf3,type="l",axes=F,col="red")
					  axis(1,at=1:length(pmf3),labels=age[-1]);axis(2)
					  par(new=T)
					  plot(1:length(pmf),pmf,type="l",col="blue",axes=F)
					  par(new=T)
					  plot(1:length(hz0),hz0,type="l",col="dark green",axes=F)


					# > pmf2[1:5]
					#         0.01         0.02         0.03         0.04         0.05
					# 3.480216e-12 1.044509e-11 1.741662e-11 2.439493e-11 3.137968e-11


					hz0=h2.plot(model,pars,profile,age,plt=F,main="Hazard" )# ,main=paste("individual=",i,sep=""))   # cumulative probability of tumor-onset for this person
					abline(v=profile[[1]],col=c("red","blue","black"),lty="dotted",lwd=1.5)
					title(sub=paste("dose:",paste(profile$dose,collapse="-"),sep=""))


					pmf3=pmf2[names(pmf2) %in% age]
					pmf3[1:10]


					  pmf[1:5]
					  pr[2]-pr[1]   # this is the prob betwen age 0 and 1


				}#end of


			   hz

     }#end of get.lung.incidence.pdf.small



        get.lung.incidence.pdf.small <- function(x,pars,doPlot=F){ # for the given smoking history, this will produce a prob for lung cancer incidence for a given age (p.d.f)
				 # x
				 # cigsmok  smokeage  age_quit  smokeday death.age
				 #         1         5         0        30       115

				 ######### (1) Make a profile for the argument ###########
				######### Make profile = list( breaks, dose) for each individual which is an argment for p2.plot() ######
				# current smoker: profile <- list(breaks=c(20,100),dose=c(0,20)):    until age 20, dose was 0 and from then on to 100, dose was 20 (current smoker)
				# former smoker: profile <- list(breaks=c(20,45,100),dose=c(0,40,0)): until age 20, dose=0, until age 45, dose 40, then quit

				 prof=NULL

				 if(x[1] == 1){   # if current smoker
													# start.age, death.time       0, cig/day
					  prof = list(breaks=as.vector(c(x[2],x[5])),dose=as.vector(c(0,x[4])))
						# > prof
						# $breaks
						# [1]   5 115    # until age 5, dose=0, until death, dose= 30
						#
						# $dose
						# [1]  0 30

				 } else{  # if former smoker
										   # start.age, quit.age, death.time
						prof = list(breaks=as.vector(c(x[2],x[3],x[5])), dose =as.vector(c(0,x[4],0)))
						# $breaks
						# [1]  17  60 115
						#
						# $dose
						# [1]  0 30  0    # until age 17, dose=0, until age 60, dose=30, until death zero dose

						#   cigsmok  smokeage  age_quit  smokeday death.age
						#         0        17        60        30       115

				 }# end of else

                 prof


				  ########(2) Use p2.plot() (TSCE model to get probabilty of incidence for each age? ############

				  model = model.NHSHPFS
				  profile=prof
				  age=c(0:death.age)  # this will calculate from 1 to death.age



				  if(doPlot==T){

						hz0=h2.plot(model,pars,profile,age,plt=T,main="Hazard" )# ,main=paste("individual=",i,sep=""))   # cumulative probability of tumor-onset for this person
						abline(v=profile[[1]],col=c("red","blue","black"),lty="dotted",lwd=1.5)
						title(sub=paste("dose:",paste(profile$dose,collapse="-"),sep=""))

						pr0=p2.plot(model,pars,profile,age,plt=T,main="Cumulative risk for cancer incidence")# ,main=paste("individual=",i,sep=""))   # cumulative probability of tumor-onset for this person
						abline(v=profile[[1]],col=c("red","blue","black"),lty="dotted",lwd=1.5)
						title(sub=paste("dose:",paste(profile$dose,collapse="-"),sep=""))
						#hz=h2.plot(model,pars,profile,age,plt=F)# ,main=paste("individual=",i,sep=""))   # cumulative probability of tumor-onset for this person
						#pr=p2.plot(model,pars,profile,age,plt=F)# ,main=paste("individual=",i,sep=""))   # cumulative probability of tumor-onset for this person
																	  # detectable tumor
						# > length(hz)
						# [1] 115
						# > hz0[1:5]
						# [1] 7.301485e-08 1.533500e-07 2.417393e-07 3.389902e-07 4.459911e-07
						# > pr0[1:5]
						# [1] 3.592616e-08 1.484690e-07 3.453100e-07 6.349005e-07 1.026539e-06
						# > tt=80;1-exp(-sum(hz[1:tt])); pr[tt]
						# [1] 0.1677581
						# [1] 0.1612856

						#max(pr0)
						#[1]0.5126991   # cumlative risk of cancer incidence until you die: prob{you get cancer by the age 115}

				  }#do this

				##### cumulative probability until a give age ####

				pr=p2.plot(model,pars,profile,age,plt=F)

				pmf = pr[-1] - pr[-length(pr)]
				pmf[1:5]
				pr[2]-pr[1]   # this is the prob betwen age 0 and 1
				# > pmf[1:5]
				# [1] 1.125429e-07 1.968410e-07 2.895905e-07 3.916386e-07 5.039174e-07
				# > pr[2]-pr[1]
				# [1] 1.125429e-07
				names(pmf)=age[-1]

				doThis=F
				if(doThis==T){

					# > names(pr)=age
					# > pr2[1:10]
					#            0            1            2            3            4            5            6            7
					# 0.000000e+00 3.592616e-08 1.484690e-07 3.453100e-07 6.349005e-07 1.026539e-06 1.530456e-06 2.157909e-06
					#            8            9
					# 2.921281e-06 3.834199e-06

					# > pmf[1:5]
					# [1] 3.592616e-08 1.125429e-07 1.968410e-07 2.895905e-07 3.916386e-07
				     inc=1
				     age2=seq(0,115,by=inc)
					 pr2=p2.plot(model,pars,profile,age2,plt=F)
					 names(pr2)=age2
					# > pr2[1:10]
					#            0         0.01         0.02         0.03         0.04         0.05         0.06         0.07
					# 0.000000e+00 3.480216e-12 1.392531e-11 3.134193e-11 5.573686e-11 8.711654e-11 1.254878e-10 1.708573e-10
					#         0.08         0.09
					# 2.232318e-10 2.826178e-10
					plot(1:length(pr2),pr2,type="l",axes=F)
					axis(1,at=1:length(pr2),labels=age2);axis(2)
					max(pr2);text(95,0.2,round(max(pr2),2),col="red")





					  pmf2 = (pr2[-1] - pr2[-length(pr2)])/inc
					  pmf3=pmf2[names(pmf2) %in% age]

					  sum(pmf3)
					  max(pr2)

					  plot(1:length(pmf3),pmf3,type="l",axes=F,col="red")
					  axis(1,at=1:length(pmf3),labels=age[-1]);axis(2)
					  par(new=T)
					  plot(1:length(pmf),pmf,type="l",col="blue",axes=F)
					  par(new=T)
					  plot(1:length(hz0),hz0,type="l",col="dark green",axes=F)


					# > pmf2[1:5]
					#         0.01         0.02         0.03         0.04         0.05
					# 3.480216e-12 1.044509e-11 1.741662e-11 2.439493e-11 3.137968e-11


					hz0=h2.plot(model,pars,profile,age,plt=F,main="Hazard" )# ,main=paste("individual=",i,sep=""))   # cumulative probability of tumor-onset for this person
					abline(v=profile[[1]],col=c("red","blue","black"),lty="dotted",lwd=1.5)
					title(sub=paste("dose:",paste(profile$dose,collapse="-"),sep=""))


					pmf3=pmf2[names(pmf2) %in% age]
					pmf3[1:10]


					  pmf[1:5]
					  pr[2]-pr[1]   # this is the prob betwen age 0 and 1


				}#end of


				if(doPlot==T) {

				   cumulativeRisk = signif(sum(pmf),2)
				   Main=paste("Probability Density Function for incidence",paste("\n Cumulative life time risk =", cumulativeRisk,sep=""))
				   plot(spline(age[-1],pmf),type="l",main=Main,ylab="PDF",xlab="Age")
				   abline(v=profile[[1]],col=c("red","blue","black"),lty="dotted",lwd=1.5)
				   title(sub=paste("dose:",paste(profile$dose,collapse="-"),sep=""))
				   #title(sub=paste("cumulative life time risk =", cumulativeRisk,sep=""))

				}# end of plot

			   names(pmf)=paste(age[-1])
			   pmf


     }#end of get.lung.incidence.pdf.small




#########12/19/2012: bach model hazard ######

my.incidence.age.dist.bach <- function(myDAT,ID, start.age,quit.age, smoking.status,cig.day,death.age,doPlot,var.sex){   # this will show life time (from 1 to death.age) incidence probabilty for each given age


        ########## [3] Prepare input data for incidence age distribution #####################
	    Female = (myDAT[,var.sex]==0)*1

        smDAT = cbind( myDAT[,c(smoking.status, start.age, quit.age, cig.day)], death.age=rep(death.age,nrow(myDAT)),Female=Female)
		# > smDAT[1:5,]
		#      cigsmok smokeage age_quit smokeday death.age
		# [1,]       1        5        0       30       115
		# [2,]       1       20        0       30       115
		# [3,]       1       20        0       15       115
		# [4,]       0       17       60       30       115

        ######### [4] Get prob of getting cancer for each age: p.d.f (or p.m.f) ##########

        #Gender0 = myDAT[,var.sex]
        ### test for one person ##

		# > table(Gender)
		# Gender
		#     1
		# 15770




        doThis=F
        if(doThis==T){

			i=4; x=smDAT[i,]
			#x
			#   cigsmok  smokeage  age_quit  smokeday death.age
			#         0        17        60        30       115

			# for the given smoking history, this will produce a prob for lung cancer incidence for a given age (p.d.f)

			#pd = get.lung.incidence.pdf.small2(x,pars,doPlot=T,hazard=T)
			# > pd[1:10]
			#            1            2            3            4            5            6            7
			# 3.592616e-08 1.125429e-07 1.968410e-07 2.895905e-07 3.916386e-07 5.039174e-07 6.274525e-07
				#}#end of

				### calculate for everybody: this takes a while ##

						x=smDAT[i,]
							#x=smDAT[rows[i],]
							x
							# > 	i=3; x=smDAT[i,]
							# > 			x
							#   cigsmok  smokeage  age_quit  smokeday death.age
							#         0        15        61        40       115

							# for the given smoking history, this will produce a prob for lung cancer incidence for a given age (p.d.f)

							#par(mfrow=c(1,2))

							hz1= get.lung.incidence.hazard.small.bach(x,doPlot=F,XLIM=c(0,85))

							### rafael model ##
							pd = get.lung.incidence.pdf.small2(x,pars,doPlot=T,hazard=T)
							#par(new=T)
							lines(age,hz1,type="l",col="dark green",xlab="",ylab="")




					#}#3nd of

					#dev.off()


			}#end of
			### calculate for everybody: this takes a while ##

			ans = apply(smDAT[1:4,],1,get.lung.incidence.hazard.small.bach, doPlot=doPlot,XLIM=c(0,85),old=F)
			ans2= t(ans)
			dim(ans2);dim(smDAT)

			### shifting one age over: because: prob of risk after a year

			colnames(ans2)=as.numeric(colnames(ans2))+1
			ans3=cbind(xx=rep(0,nrow(ans2)),ans2); colnames(ans3)[1]="0"
			ans3[1:10,1:20]
			# > 			ans3[1:10,1:5]
			#       0            1            2            3            4
			#  [1,] 0 2.119636e-07 2.274059e-07 2.439732e-07 2.617476e-07
			#  [2,] 0 2.119636e-07 2.274059e-07 2.439732e-07 2.617476e-07
			#  [3,] 0 2.119636e-07 2.274059e-07 2.439732e-07 2.617476e-07
			#  [4,] 0 2.119636e-07 2.274059e-07 2.439732e-07 2.617476e-07
			#  [5,] 0 2.119636e-07 2.274059e-07 2.439732e-07 2.617476e-07


		ANS = cbind(pid = myDAT[,ID],ans3)
		ANS


}#end of my.incidence.age.dist



        ###### 12/19/2012: use Bach model #######################
        ##### 12/18/2012: use hazard instead of f(t) derived from F(t) ###

        get.lung.incidence.hazard.small.bach <- function(x,doPlot=F,XLIM=c(0,85),old=F){ # for the given smoking history, this will produce a prob for lung cancer incidence for a given age (p.d.f)

				# Female : 0 if male, 1 if female
				 # x
				 # cigsmok  smokeage  age_quit  smokeday death.age    Female
				 #         1         5         0        30       115     0

				 Female = x[6]

				P.lung.inc.bach.sm <- function(ag,cpd,smk,Quit,Female){ # one-year probability of lung cancer diagnosis

						# ag=60  # age
						# cpd = 40  # cigarette per day
						# smk = ag-15  # duration of smoking (in years)
						# Quit = 0  # duration of quit (for former smokers only
						# Female=0

				    lin.com =  -9.7960 + ( 0.0608*cpd - (1*(cpd > 15))*0.000146*(cpd - 15)^3
													 + (1*(cpd > 20))*0.0001848*(cpd - 20.185)^3
													 - (1*(cpd > 40))*0.00003834*(cpd - 40)^3     )  +

										( 0.11425*smk - (1*(smk > 27))*0.00008009*(smk - 27.6577)^3
													 + (1*(smk > 40))*0.0001706*(smk - 40)^3
													 - (1*(smk > 50))*0.00009060*(smk - 50.91)^3  )  +

										(- 0.08568*Quit + 0.0065499*(Quit)^3                        ## sing should be reversed beause of "-" at the benining
													  -(1*(Quit >  0))*0.0068305*(Quit - 0.505)^3
													  +(1*(Quit > 12))*0.0002806*(Quit - 12.29)^3 ) +

										( 0.070322*ag   -(1*(ag >  53))*0.00009382*(ag - 53.4590 )^3
													  +(1*(ag >  61))*0.0001828*(ag - 61.9548)^3
													  -(1*(ag > 70))*0.00008900*(ag - 70.910335)^3 )  -

										0.05827*(Female)


					1-0.9962^(exp(lin.com))
					#[1] 0.009948606
				     #this is

				 }#end of


		        #x=smDAT[i,]
			   #x=smDAT[rows[i],]
			    #x

				 ######## [1] Make a smoking history matrix by age ########
				 age=c(0:death.age)  # this will calculate from 1 to death.age
				if(old==F)  out=smoking.var(x,age)
				 if(old==T) out=smoking.var.old(x,age)   # the dosage is updated to be zero if you quit smoking, but I think bach model implies keep previous levels of smoking and update is done using "quit" variable
				# x
				#   cigsmok  smokeage  age_quit  smokeday death.age
				#         0        15        61        40       115
				# > mat
				# $prof
				# $prof$breaks
				# [1]  15  61 115
				#
				# $prof$dose
				# [1]  0 40  0
				#
				#
				# $cig
				#     cpd dur Quit   (cigarett per day, duration, quit year (row.name is age)
				# 0     0   0    0
				# 1     0   0    0
				# 2     0   0    0
				#
				# 12    0   0    0
				# 13    0   0    0
				# 14    0   0    0
				# 15   40   0    0
				# 16   40   1    0
				# 17   40   2    0
				# 18   40   3    0
				# 19   40   4    0
				# 20   40   5    0
				#
				# 58   40  43    0
				# 59   40  44    0
				# 60   40  45    0
				# 61    0  46    0
				# 62    0   0    1
				# 63    0   0    2
				# 64    0   0    3
				# 65    0   0    4
				# 66    0   0    5
				#
				# 112   0   0   51
				# 113   0   0   52
				# 114   0   0   53
				# 115   0   0   54
				mat=out$cig
				prof=out$prof


				mat2=cbind(ag=as.numeric(row.names(mat)),cpd=mat[,"cpd"],smk=mat[,"dur"],Quit=mat[,"Quit"],Female=rep(Female,nrow(mat)),nrow(mat))
				# > mat2[1:5,]
				#   ag cpd smk Quit Female
				# 0  0   0   0    0      0
				# 1  1   0   0    0      0
				# 2  2   0   0    0      0
				# 3  3   0   0    0      0
				# 4  4   0   0    0      0


				#haz=P.lung.inc.bach.sm(ag=mat2[,"ag"],cpd=mat[,"cpd"],smk=mat[,"smk"],Quit=mat[,"Quit"],Female=mat[,"Female"])


				#par(mfrow=c(1,2))
				ag=mat2[,"ag"];cpd=mat2[,"cpd"];smk=mat2[,"smk"];Quit=mat2[,"Quit"];Female=mat2[,"Female"]

				hz=P.lung.inc.bach.sm(ag,cpd,smk,Quit,Female)


				if(doPlot==T){

					pd = get.lung.incidence.pdf.small2(x,pars,doPlot=T,hazard=T)
					#par(new=T)
					lines(age,hz,type="l",col="dark green",xlab="",ylab="")


					#plot(spline(age,hz),type="l",xlab="Age",ylab="Hazard",main="Hazard using Bach model",xlim=XLIM)
					#abline(v=prof$breaks,col="red",lty="dotted")
					#title(sub=paste("dose:",paste(prof$dose,collapse="-"),sep=""))


				}#end of doPlot

				#pd = get.lung.incidence.pdf.small2(x,pars,doPlot=T,hazard=T)

				hz
				# > hz[1:10]
				#            0            1            2            3            4            5            6            7            8            9
				# 2.119636e-07 2.274059e-07 2.439732e-07 2.617476e-07 2.808168e-07 3.012753e-07 3.232243e-07 3.467723e-07 3.720359e-07 3.991401e-07


          }#3nd of get.lung.incidence.pdf.small.bach








######### 12/18/2012: hazard instead of f(t) based on F(t) (increment) ####

my.incidence.age.dist2 <- function(myDAT,pars,ID, start.age,quit.age, smoking.status,cig.day,death.age,doPlot){   # this will show life time (from 1 to death.age) incidence probabilty for each given age

        doThis=F
        if(doThis==T){

			mydat0=read.csv("/Users/summerhan/Dropbox/work/research/projects/CISNET/cisnet.lung/20111118_NLSTpopfile.csv")
			# > dim(mydat0)
			# [1] 53454    13
			# > colnames(mydat0)
			#  [1] "pid"       "study"     "rndgroup"  "gender"    "cigsmok"   "age_rnd"   "pkyr"      "smokeage"  "age_quit"  "smokeday"
			# [11] "smokeyr"   "rand_year" "ELIG"
			# > mydat0[1:5,]
			#      pid study rndgroup gender cigsmok age_rnd pkyr smokeage age_quit smokeday smokeyr rand_year ELIG
			# 1 100001     1        2      1       1      70   99        5        0       30      66      2003    2
			# 2 100002     1        1      1       1      66   52       14        0       20      52      2003    2
			# 3 100003     1        2      1       1      64   66       20        0       30      44      2003    2
			# 4 100004     1        1      1       0      60   34       22       45       40      17      2003    2
			# 5 100005     1        1      1       0      64   92       15       61       40      46      2003    2

			mydat = as.matrix(mydat0)
			colnames(mydat)=colnames(mydat0)

			#pop = "CT_male"
			pop = "CXR_male"
			#pop = "CT_female"
			#pop = "CXR_female"

			DAT=mydat

			var.rnd ="rndgroup" #1: CT 2: CXR
			var.sex ="gender" #1: male, 2: female

			ID="pid"
			start.age = "smokeage"
			quit.age = "age_quit"
			smoking.status ="cigsmok"  # 0 quit, 1 current
			cig.day = "smokeday"
			death.age = 115
			doPlot=F


			############ (1) Selecting the subset of the data for corresponding population ##########

			myDAT=NULL

			if(pop == "CT_male") myDAT = subset(DAT, DAT[,var.rnd]==1 & DAT[,var.sex]==1)
			if(pop == "CXR_male") myDAT = subset(DAT, DAT[,var.rnd]==2 & DAT[,var.sex]==1)
			if(pop == "CT_female") myDAT = subset(DAT, DAT[,var.rnd]==1 & DAT[,var.sex]==2)
			if(pop == "CXR_female") myDAT = subset(DAT, DAT[,var.rnd]==2 & DAT[,var.sex]==2)

			dim(myDAT);table(myDAT[,var.rnd]);table(myDAT[,var.sex])

			########## [2] Select TSCE parameter estimates for given population ######################

			if(pop == "CT_male") pars = c(3.000e+00,9.5545e-02,8.3416e-08,1.295e-01,4.892e-01,1.949e-01,6.254e-01) # HPFS  (other study estimates)

			if(pop == "CXR_male") pars = c(3.000e+00,9.5545e-02,8.3416e-08,1.295e-01,4.892e-01,1.949e-01,6.254e-01) # HPFS
			if(pop == "CT_female") pars = c(3.000e+00,9.5545e-02,8.3416e-08,1.620e-01,4.892e-01,1.138e-01,6.254e-01)  # NHS  (nurse health study?)

			if(pop == "CXR_female") pars = c(3.000e+00,9.5545e-02,8.3416e-08,1.620e-01,4.892e-01,1.138e-01,6.254e-01)  # NHS

        }#end of


        ########## [3] Prepare input data for incidence age distribution #####################

        smDAT = cbind( myDAT[,c(smoking.status, start.age, quit.age, cig.day)], death.age=rep(death.age,nrow(myDAT)))
		# > smDAT[1:5,]
		#      cigsmok smokeage age_quit smokeday death.age
		# [1,]       1        5        0       30       115
		# [2,]       1       20        0       30       115
		# [3,]       1       20        0       15       115
		# [4,]       0       17       60       30       115

        ######### [4] Get prob of getting cancer for each age: p.d.f (or p.m.f) ##########

        ### test for one person ##
        doThis=F
        if(doThis==T){

			i=4; x=smDAT[i,]
			#x
			#   cigsmok  smokeage  age_quit  smokeday death.age
			#         0        17        60        30       115

			# for the given smoking history, this will produce a prob for lung cancer incidence for a given age (p.d.f)

			pd = get.lung.incidence.pdf.small2(x,pars,doPlot=T,hazard=T)
			# > pd[1:10]
			#            1            2            3            4            5            6            7
			# 3.592616e-08 1.125429e-07 1.968410e-07 2.895905e-07 3.916386e-07 5.039174e-07 6.274525e-07
		}#end of

		### calculate for everybody: this takes a while ##

		ans = apply(smDAT,1,get.lung.incidence.pdf.small2, pars=pars,doPlot=doPlot,hazard=T)
		ans2= t(ans)
		dim(ans2);dim(smDAT)
		# > dim(ans2);dim(smDAT)
		# [1] 15762   115
		# [1] 15762     5
		# > ans2[1:10,50:60]
		#                 50           51           52           53           54           55
		#  [1,] 0.0026587386 0.0030645079 0.0035217707 0.0040337080 0.0046026092 0.0052295006
		#  [2,] 0.0013449696 0.0015682329 0.0018262511 0.0021236222 0.0024652650 0.0028563326
		#  [3,] 0.0006239692 0.0007169942 0.0008234536 0.0009451563 0.0010841128 0.0012425443
		#  [4,] 0.0015863326 0.0018466530 0.0021464364 0.0024905286 0.0028839725 0.0033318634
		#  [5,] 0.0003741907 0.0004109566 0.0004512386 0.0004953549 0.0005436481 0.0005964873
		#  [6,] 0.0011371564 0.0005635465 0.0006181409 0.0006778058 0.0007429689 0.0008140857
		#  [7,] 0.0014056778 0.0016172061 0.0007993000 0.0008751007 0.0009576215 0.0010473662
		#  [8,] 0.0008365497 0.0009668624 0.0011166557 0.0012885767 0.0014855441 0.0017107460
		#  [9,] 0.0010215693 0.0011867935 0.0013774668 0.0015970761 0.0018494372 0.0021386711
		# [10,] 0.0034741758 0.0040279619 0.0046523923 0.0053505099 0.0020182134 0.0021915323

		#cumRisk=apply(ans2,1,sum)
		#cols=rep("red",length(cumRisk)); indic = myDAT[,smoking.status]==1 # current
		#cols[!indic]="blue" # quitter

		#plot(myDAT[,cig.day],cumRisk,xlab="cig/day",ylab="Cumulative Risk",col=cols,main="Smoking intensity and cumulative Risk")
		#legend(x="bottomright",legend=c("Current smoker","Former smoker"),bg="white",fill=c("red","blue"))


		#plot(myDAT[,"pkyr"],cumRisk,xlab="Pack-years",ylab="Cumulative Risk",col=cols,main="Pack-years and cumulative Risk")
		#legend(x="bottomright",legend=c("Current smoker","Former smoker"),bg="white",fill=c("red","blue"))


		#plot(myDAT[,"smokeyr"],cumRisk,xlab="Duration",ylab="Cumulative Risk",col=cols,main="Smoking duration and cumulative Risk")
		#legend(x="bottomright",legend=c("Current smoker","Former smoker"),bg="white",fill=c("red","blue"))


		ANS = cbind(pid = myDAT[,ID],ans2)
		ANS


}#end of my.incidence.age.dist


my.incidence.age.dist <- function(myDAT,pars,ID, start.age,quit.age, smoking.status,cig.day,death.age,doPlot){   # this will show life time (from 1 to death.age) incidence probabilty for each given age

        doThis=F
        if(doThis==T){

			mydat0=read.csv("/Users/summerhan/Dropbox/work/research/projects/CISNET/cisnet.lung/20111118_NLSTpopfile.csv")
			# > dim(mydat0)
			# [1] 53454    13
			# > colnames(mydat0)
			#  [1] "pid"       "study"     "rndgroup"  "gender"    "cigsmok"   "age_rnd"   "pkyr"      "smokeage"  "age_quit"  "smokeday"
			# [11] "smokeyr"   "rand_year" "ELIG"
			# > mydat0[1:5,]
			#      pid study rndgroup gender cigsmok age_rnd pkyr smokeage age_quit smokeday smokeyr rand_year ELIG
			# 1 100001     1        2      1       1      70   99        5        0       30      66      2003    2
			# 2 100002     1        1      1       1      66   52       14        0       20      52      2003    2
			# 3 100003     1        2      1       1      64   66       20        0       30      44      2003    2
			# 4 100004     1        1      1       0      60   34       22       45       40      17      2003    2
			# 5 100005     1        1      1       0      64   92       15       61       40      46      2003    2

			mydat = as.matrix(mydat0)
			colnames(mydat)=colnames(mydat0)

			#pop = "CT_male"
			pop = "CXR_male"
			#pop = "CT_female"
			#pop = "CXR_female"

			DAT=mydat

			var.rnd ="rndgroup" #1: CT 2: CXR
			var.sex ="gender" #1: male, 2: female

			ID="pid"
			start.age = "smokeage"
			quit.age = "age_quit"
			smoking.status ="cigsmok"  # 0 quit, 1 current
			cig.day = "smokeday"
			death.age = 115
			doPlot=F


			############ (1) Selecting the subset of the data for corresponding population ##########

			myDAT=NULL

			if(pop == "CT_male") myDAT = subset(DAT, DAT[,var.rnd]==1 & DAT[,var.sex]==1)
			if(pop == "CXR_male") myDAT = subset(DAT, DAT[,var.rnd]==2 & DAT[,var.sex]==1)
			if(pop == "CT_female") myDAT = subset(DAT, DAT[,var.rnd]==1 & DAT[,var.sex]==2)
			if(pop == "CXR_female") myDAT = subset(DAT, DAT[,var.rnd]==2 & DAT[,var.sex]==2)

			dim(myDAT);table(myDAT[,var.rnd]);table(myDAT[,var.sex])

			########## [2] Select TSCE parameter estimates for given population ######################

			if(pop == "CT_male") pars = c(3.000e+00,9.5545e-02,8.3416e-08,1.295e-01,4.892e-01,1.949e-01,6.254e-01) # HPFS  (other study estimates)

			if(pop == "CXR_male") pars = c(3.000e+00,9.5545e-02,8.3416e-08,1.295e-01,4.892e-01,1.949e-01,6.254e-01) # HPFS
			if(pop == "CT_female") pars = c(3.000e+00,9.5545e-02,8.3416e-08,1.620e-01,4.892e-01,1.138e-01,6.254e-01)  # NHS  (nurse health study?)

			if(pop == "CXR_female") pars = c(3.000e+00,9.5545e-02,8.3416e-08,1.620e-01,4.892e-01,1.138e-01,6.254e-01)  # NHS

        }#end of


        ########## [3] Prepare input data for incidence age distribution #####################

        smDAT = cbind( myDAT[,c(smoking.status, start.age, quit.age, cig.day)], death.age=rep(death.age,nrow(myDAT)))
		# > smDAT[1:5,]
		#      cigsmok smokeage age_quit smokeday death.age
		# [1,]       1        5        0       30       115
		# [2,]       1       20        0       30       115
		# [3,]       1       20        0       15       115
		# [4,]       0       17       60       30       115

        ######### [4] Get prob of getting cancer for each age: p.d.f (or p.m.f) ##########

        ### test for one person ##
        doThis=F
        if(doThis==T){

			i=4; x=smDAT[4,]
			#x
			#   cigsmok  smokeage  age_quit  smokeday death.age
			#         0        17        60        30       115

			# for the given smoking history, this will produce a prob for lung cancer incidence for a given age (p.d.f)

			pd = get.lung.incidence.pdf.small(x,pars,doPlot=T)
			# > pd[1:10]
			#            1            2            3            4            5            6            7
			# 3.592616e-08 1.125429e-07 1.968410e-07 2.895905e-07 3.916386e-07 5.039174e-07 6.274525e-07
		}#end of

		### calculate for everybody: this takes a while ##

		ans = apply(smDAT,1,get.lung.incidence.pdf.small, pars=pars,doPlot=doPlot)
		ans2= t(ans)
		dim(ans2);dim(smDAT)
		# > dim(ans2);dim(smDAT)
		# [1] 15762   115
		# [1] 15762     5
		# > ans2[1:10,50:60]
		#                 50           51           52           53           54           55
		#  [1,] 0.0026587386 0.0030645079 0.0035217707 0.0040337080 0.0046026092 0.0052295006
		#  [2,] 0.0013449696 0.0015682329 0.0018262511 0.0021236222 0.0024652650 0.0028563326
		#  [3,] 0.0006239692 0.0007169942 0.0008234536 0.0009451563 0.0010841128 0.0012425443
		#  [4,] 0.0015863326 0.0018466530 0.0021464364 0.0024905286 0.0028839725 0.0033318634
		#  [5,] 0.0003741907 0.0004109566 0.0004512386 0.0004953549 0.0005436481 0.0005964873
		#  [6,] 0.0011371564 0.0005635465 0.0006181409 0.0006778058 0.0007429689 0.0008140857
		#  [7,] 0.0014056778 0.0016172061 0.0007993000 0.0008751007 0.0009576215 0.0010473662
		#  [8,] 0.0008365497 0.0009668624 0.0011166557 0.0012885767 0.0014855441 0.0017107460
		#  [9,] 0.0010215693 0.0011867935 0.0013774668 0.0015970761 0.0018494372 0.0021386711
		# [10,] 0.0034741758 0.0040279619 0.0046523923 0.0053505099 0.0020182134 0.0021915323

		cumRisk=apply(ans2,1,sum)
		cols=rep("red",length(cumRisk)); indic = myDAT[,smoking.status]==1 # current
		cols[!indic]="blue" # quitter

		plot(myDAT[,cig.day],cumRisk,xlab="cig/day",ylab="Cumulative Risk",col=cols,main="Smoking intensity and cumulative Risk")
		legend(x="bottomright",legend=c("Current smoker","Former smoker"),bg="white",fill=c("red","blue"))


		plot(myDAT[,"pkyr"],cumRisk,xlab="Pack-years",ylab="Cumulative Risk",col=cols,main="Pack-years and cumulative Risk")
		legend(x="bottomright",legend=c("Current smoker","Former smoker"),bg="white",fill=c("red","blue"))


		plot(myDAT[,"smokeyr"],cumRisk,xlab="Duration",ylab="Cumulative Risk",col=cols,main="Smoking duration and cumulative Risk")
		legend(x="bottomright",legend=c("Current smoker","Former smoker"),bg="white",fill=c("red","blue"))


		ANS = cbind(pid = myDAT[,ID],ans2)
		ANS


}#end of my.incidence.age.dist





################## Other cause of mortality ########################

my.ocm.age.dist.bach <- function(myDAT,ID, start.age,quit.age, smoking.status,cig.day,death.age,doPlot,var.sex){   # this will show life time (from 1 to death.age) incidence probabilty for each given age


        ########## [3] Prepare input data for incidence age distribution #####################
	    Female = (myDAT[,var.sex]==0)*1

        smDAT = cbind( myDAT[,c(smoking.status, start.age, quit.age, cig.day)], death.age=rep(death.age,nrow(myDAT)),Female=Female)

        #smDAT = cbind( myDAT[,c(smoking.status, start.age, quit.age, cig.day)], death.age=rep(death.age,nrow(myDAT)))
		# > smDAT[1:5,]
		#      cigsmok smokeage age_quit smokeday death.age
		# [1,]       1        5        0       30       115
		# [2,]       1       20        0       30       115
		# [3,]       1       20        0       15       115
		# [4,]       0       17       60       30       115

        ######### [4] Get prob of getting cancer for each age: p.d.f (or p.m.f) ##########

        ### test for one person ##
        doThis=F
        if(doThis==T){

			i=4; x=smDAT[i,]
			#x
			#   cigsmok  smokeage  age_quit  smokeday death.age
			#         0        17        60        30       115

			# for the given smoking history, this will produce a prob for lung cancer incidence for a given age (p.d.f)

			#pd = get.lung.incidence.pdf.small2(x,pars,doPlot=T,hazard=T)
			# > pd[1:10]
			#            1            2            3            4            5            6            7
			# 3.592616e-08 1.125429e-07 1.968410e-07 2.895905e-07 3.916386e-07 5.039174e-07 6.274525e-07
				#}#end of

				### calculate for everybody: this takes a while ##

						x=smDAT[i,]
							#x=smDAT[rows[i],]
							x
							# > 	i=3; x=smDAT[i,]
							# > 			x
							#   cigsmok  smokeage  age_quit  smokeday death.age
							#         0        15        61        40       115

							# for the given smoking history, this will produce a prob for lung cancer incidence for a given age (p.d.f)

							#par(mfrow=c(1,2))

							hz1= get.lung.ocm.hazard.small.bach(x,doPlot=F,XLIM=c(0,85))

							### rafael model ##
							#pd = get.lung.incidence.pdf.small2(x,pars,doPlot=T,hazard=T)
							#par(new=T)
							#lines(age,hz1,type="l",col="dark green",xlab="",ylab="")




					#}#3nd of

					#dev.off()


			}#end of
			### calculate for everybody: this takes a while ##

			ans = apply(smDAT,1,get.lung.ocm.hazard.small.bach, doPlot,XLIM=c(0,85),old=F)
			ans2= t(ans)
			dim(ans2);dim(smDAT)

			### shifting one age over: because: prob of risk after a year

			colnames(ans2)=as.numeric(colnames(ans2))+1
			ans3=cbind(xx=rep(0,nrow(ans2)),ans2); colnames(ans3)[1]="0"
			ans3[1:10,1:20]
			# > 			ans3[1:10,1:5]
			#       0            1            2            3            4
			#  [1,] 0 2.119636e-07 2.274059e-07 2.439732e-07 2.617476e-07
			#  [2,] 0 2.119636e-07 2.274059e-07 2.439732e-07 2.617476e-07
			#  [3,] 0 2.119636e-07 2.274059e-07 2.439732e-07 2.617476e-07
			#  [4,] 0 2.119636e-07 2.274059e-07 2.439732e-07 2.617476e-07
			#  [5,] 0 2.119636e-07 2.274059e-07 2.439732e-07 2.617476e-07


		ANS = cbind(pid = myDAT[,ID],ans3)
		ANS


}#end of my.incidence.age.dist



        ###### 12/19/2012: use Bach model #######################
        ##### 12/18/2012: use hazard instead of f(t) derived from F(t) ###



        ###### 12/19/2012: use Bach model #######################
        ##### 12/18/2012: use hazard instead of f(t) derived from F(t) ###

        get.lung.ocm.hazard.small.bach <- function(x,doPlot=F,XLIM=c(0,85),old=F,YLIM=c(0,0.2)){ # for the given smoking history, this will produce a prob for lung cancer incidence for a given age (p.d.f)
				 # x
				 # cigsmok  smokeage  age_quit  smokeday death.age
				 #         1         5         0        30       115

				 Female = x[6]

				P.lung.ocm.bach.sm <- function(ag,cpd,smk,Quit,Female){ # one-year probability of lung cancer diagnosis

						# ag=60  # age
						# cpd = 40  # cigarette per day
						# smk = ag-15  # duration of smoking (in years)
						# Quit = 0  # duration of quit (for former smokers only
						# Female=0

					    lin.com =  -7.2036 + ( 0.0154*cpd - (1*(cpd > 15))*0.000017*(cpd - 15)^3
														 + (1*(cpd > 20))*0.000021*(cpd - 20.185)^3
														 - (1*(cpd > 40))*0.0000045*(cpd - 40)^3     )       +

											( 0.0200*smk + (1*(smk > 27))*0.0000065*(smk - 27.6577)^3
														 - (1*(smk > 40))*0.0000139*(smk - 40)^3
														 + (1*(smk > 50))*0.0000074*(smk - 50.91)^3  )       +

											( -0.0233*Quit + 0.0019208*(Quit)^3   +
														  -(1*(Quit >  0))*0.00200*(Quit - 0.505)^3
														  +(1*(Quit > 12))*0.0000822*(Quit - 12.29)^3 )      +

											( 0.0991*ag   +(1*(ag >  53))*0.000006217*(ag - 53.4590 )^3
														  -(1*(ag >  61))*0.00001211*(ag - 61.9548)^3
														  +(1*(ag > 70))*0.00000589*(ag - 70.910335)^3 )  -

											0.49042*(Female)


								1-0.9917663^(exp(lin.com))
								#[1] 0.009948606
								 #this is

							 }#end of


		        #x=smDAT[i,]
			   #x=smDAT[rows[i],]


				 ######## [1] Make a smoking history matrix by age ########
				 age=c(0:death.age)  # this will calculate from 1 to death.age
				if(old==F)  out=smoking.var(x,age)
				 if(old==T) out=smoking.var.old(x,age)   # the dosage is updated to be zero if you quit smoking, but I think bach model implies keep previous levels of smoking and update is done using "quit" variable
				# x
				#   cigsmok  smokeage  age_quit  smokeday death.age
				#         0        15        61        40       115
				# > mat
				# $prof
				# $prof$breaks
				# [1]  15  61 115
				#
				# $prof$dose
				# [1]  0 40  0
				#
				#
				# $cig
				#     cpd dur Quit   (cigarett per day, duration, quit year (row.name is age)
				# 0     0   0    0
				# 1     0   0    0
				# 2     0   0    0
				#
				# 12    0   0    0
				# 13    0   0    0
				# 14    0   0    0
				# 15   40   0    0
				# 16   40   1    0
				# 17   40   2    0
				# 18   40   3    0
				# 19   40   4    0
				# 20   40   5    0
				#
				# 58   40  43    0
				# 59   40  44    0
				# 60   40  45    0
				# 61    0  46    0
				# 62    0   0    1
				# 63    0   0    2
				# 64    0   0    3
				# 65    0   0    4
				# 66    0   0    5
				#
				# 112   0   0   51
				# 113   0   0   52
				# 114   0   0   53
				# 115   0   0   54
				mat=out$cig
				prof=out$prof


				mat2=cbind(ag=as.numeric(row.names(mat)),cpd=mat[,"cpd"],smk=mat[,"dur"],Quit=mat[,"Quit"],Female=rep(Female,nrow(mat)),nrow(mat))
				# > mat2[1:5,]
				#   ag cpd smk Quit Female
				# 0  0   0   0    0      0
				# 1  1   0   0    0      0
				# 2  2   0   0    0      0
				# 3  3   0   0    0      0
				# 4  4   0   0    0      0


				#haz=P.lung.inc.bach.sm(ag=mat2[,"ag"],cpd=mat[,"cpd"],smk=mat[,"smk"],Quit=mat[,"Quit"],Female=mat[,"Female"])


				#par(mfrow=c(1,2))
				ag=mat2[,"ag"];cpd=mat2[,"cpd"];smk=mat2[,"smk"];Quit=mat2[,"Quit"];Female=mat2[,"Female"]

				hz=P.lung.ocm.bach.sm(ag,cpd,smk,Quit,Female)


				#hz1=P.lung.inc.bach.sm(ag,cpd,smk,Quit,Female)


				if(doPlot==T){


							#x=smDAT2[i,]
						#z0=my.other.cause.mortality.pdf.small(x,normalize=F,doPlot=F)


						#plot(1:length(z0),z0,type="l",col="red")
						#lines(1:length(hz),hz,type="l",col="blue")





					plot(spline(age,hz),type="l",xlab="Age",ylab="Hazard of OCM",main="Hazard of OCM using Bach model",xlim=XLIM,ylim=YLIM)
					abline(v=prof$breaks,col="red",lty="dotted")
					title(sub=paste("dose:",paste(prof$dose,collapse="-"),sep=""))

					lines(age,hz1,type="l",col="blue")
					legend(x="topleft",legend=c("Lung incidence","OCM"),fill=c("red","blue"),bg="white",cex=1.5)


				}#end of doPlot

				#pd = get.lung.incidence.pdf.small2(x,pars,doPlot=T,hazard=T)

				hz
				# > hz[1:10]
				#            0            1            2            3            4            5            6            7            8            9
				# 2.119636e-07 2.274059e-07 2.439732e-07 2.617476e-07 2.808168e-07 3.012753e-07 3.232243e-07 3.467723e-07 3.720359e-07 3.991401e-07


          }#3nd of get.lung.incidence.pdf.small.bach





my.other.cause.mortality.pdf.small <- function(x,normalize,doPlot){
			# calculate hazard for other cause of death for each year since randomization
			# and corresponding p.d.f. and c.d.f

			# > x
			# age_rnd  gender    pkyr cigsmok  age.end
			#    73.0     1.0    64.5     0.0      100 --> at age 73 randomized, male, 64.5 pack-years (6.4 pack per day for 10 years), quit smoking
			xx = as.vector(x)
			age = xx[1]:age.end   # starting from randomized age to end of age [1]  73  74  75  76  77  78
			agerand = xx[1]
			gender = xx[2]
			pkyr = xx[3]
			cigsmok = xx[4]

			### calculate hazard for other cause of mortality ##

			hz = hzocm(age,agerand,gender,pkyr,cigsmok) #(age,agerand,gender,pkyr,cigsmok)
			surv = exp(-cumsum(hz)) # prob you will survive at time t (since randomization
			cdf = 1-surv  # cumulative risk since randomization
			pdf = hz*surv #

			#pdfb=cdf[-1]-cdf[-length(cdf)]


			#plot(spline(age,hz),main="Hazard",typ="l",col="red")
			#lines(age,pdf,typ="l",col="blue")
			#lines(age[-1],pdfb,type="l",col="dark green")

			#plot(spline(age,pdf),main="P.D.F.")

			# > cdf
			#  [1] 0.02069846 0.04210619 0.06422050 0.08703526 0.11054060 0.13472257 0.15956282 0.18503826
			#  [9] 0.21112076 0.23777689 0.26496761 0.29264806 0.32076742 0.34926874 0.37808893 0.40715876
			# [17] 0.43640302 0.46574071 0.49508541 0.52434573 0.55342594 0.58222668 0.61064586 0.63857974
			# [25] 0.66592399 0.69257512 0.71843177 0.74339631
			# > max(cdf)
			# [1] 0.7433963  --> this means it's possible you "may not die" from other cause of risk as well?

			#--> cumulative risk of other cause of death is not 1 this is because the hazard before the randomization is not calculated
			# do i need to consider the risk then?  1-max(cdf) is the cumulative risk until the randomized age?
			# is other cause of mortality always 1? or like

			#### OK I need to make truncated distribution by deviding pdf by it's sum so the pdf becomes 1 given the age

			if(normalize==T) pdf2 = pdf/sum(pdf)
			if(normalize==F) pdf2 = pdf

		   if(doPlot==T){

				plot(spline(age,hz),main="Hazard",typ="l",xlab="Age: (Start from randomization)",ylab="Hazard")
				plot(spline(age,cdf),main="Cumulative Risk",typ="l",xlab="Age: (Start from randomization)",ylab="CDF")

				Main=paste("Probability Distributuion \n", paste(paste("( pkyr=",pkyr,sep=""),paste("& current smoking=",cigsmok==1,")",sep="")))
				plot(spline(age,pdf2),main=Main,
					  typ="l",xlab="Age: (Start from randomization)",ylab="PDF")



				#pdf0= cdf[-1]-cdf[-length(cdf)]
				#plot(spline(age[-1],pdf0),main="Probability Distributuion 2",typ="l",xlab="Age: (from randomization)",ylab="PDF2")

			}#end of


					doThis=F
					if(doThis==T){

						#tm=cbind(hz,surv,cdf,pdf)
						# > tm[1:5,]
						#              hz      surv        cdf        pdf
						# [1,] 0.02091568 0.9793015 0.02069846 0.02048275
						# [2,] 0.02210268 0.9578938 0.04210619 0.02117202
						# [3,] 0.02335705 0.9357795 0.06422050 0.02185705
						# [4,] 0.02468261 0.9129647 0.08703526 0.02253435
						# [5,] 0.02608340 0.8894594 0.11054060 0.02320012

						# > cdf[-1]-cdf[-length(cdf)]
						#  [1] 0.02140773 0.02211431 0.02281476 0.02350534 0.02418197 0.02484025 0.02547544 0.02608251
						#  [9] 0.02665613 0.02719072 0.02768045 0.02811936 0.02850132 0.02882019 0.02906983 0.02924426
						# [17] 0.02933769 0.02934470 0.02926032 0.02908021 0.02880074 0.02841919 0.02793387 0.02734426
						# [25] 0.02665112 0.02585666 0.02496454
						# > pdf
						#  [1] 0.02048275 0.02117202 0.02185705 0.02253435 0.02320012 0.02385023 0.02448023 0.02508537
						#  [9] 0.02566060 0.02620062 0.02669986 0.02715258 0.02755289 0.02789480 0.02817234 0.02837959
						# [17] 0.02851080 0.02856051 0.02852363 0.02839562 0.02817257 0.02785138 0.02742988 0.02690696
						# [25] 0.02628273 0.02555861 0.02473745 0.02382359
						# > plot(cdf[-1]-cdf[-length(cdf)], pdf[-length(pdf)])  # not exactly

						hz0 = hzocm(1:100,agerand,gender,pkyr,cigsmok)
						surv0 = exp(-cumsum(hz0)) # prob you will survive at time t (since randomization
						cdf0 = 1-surv0  # cumulative risk since randomization
						pdf0 = hz0*surv0 #

					}#end of


				names(pdf2)=paste(age)
				# > pdf2[1:5]
				#         73         74         75         76         77
				# 0.02824704 0.02919759 0.03014228 0.03107633 0.03199447


				##### fill zeros upto randomization point from age 1 to age 73-1 ##########
				age.til = xx[1]-1   # 73-1
				pdf3 = c(rep(0, age.til ),pdf2)
				names(pdf3)[1:age.til]=paste(1:age.til)

				# > pdf3[1:5];pdf3[72:75]
				# 1 2 3 4 5
				# 0 0 0 0 0
				#         72         73         74         75
				# 0.00000000 0.02824704 0.02919759 0.03014228

				pdf3


	 }#end of my.other.cause.mortalith.pdf.small


       my.other.cause.mortality.pdf <- function(myDAT,age.rnd,var.sex,var.pkyr,smoking.status,age.end,ID, normalize,doPlot){

            smDAT = cbind(myDAT[,c(age.rnd, var.sex, var.pkyr, smoking.status)],age.end=rep(age.end,nrow(myDAT)))
			# > smDAT[1:3,]
			#      age_rnd gender  pkyr cigsmok  age.end
			# [1,]      70      1 99.00       1      100
			# [2,]      64      1 66.00       1      100
			# [3,]      69      1 36.75       1      100


			doThis=F
			if(doThis==T){

				i=1
				x=smDAT[i,]
				tt1 = my.other.cause.mortality.pdf.small(x,normalize,doPlot=T)
				# > tt1[1:10]
				#  1  2  3  4  5  6  7  8  9 10
				#  0  0  0  0  0  0  0  0  0  0
				# > tt1[70:75]
				#         70         71         72         73         74         75
				# 0.00000000 0.00000000 0.00000000 0.02824704 0.02919759 0.03014228
				# > sum(tt1)
				# [1] 1

            }#end of doThis


            ans0 = apply(smDAT,1,my.other.cause.mortality.pdf.small,normalize=normalize, doPlot=doPlot)
            ans = t(ans0)
			# > ans[1:5,70:75]
			#              70         71         72         73         74         75
			# [1,] 0.04091230 0.04229681 0.04357873 0.04473389 0.04573689 0.04656148
			# [2,] 0.02392416 0.02497395 0.02601950 0.02705274 0.02806463 0.02904515
			# [3,] 0.02303013 0.02429113 0.02557424 0.02687191 0.02817516 0.02947360
			# [4,] 0.00000000 0.00000000 0.00000000 0.02824704 0.02919759 0.03014228
			# [5,] 0.01234405 0.01321109 0.01412716 0.01509305 0.01610917 0.01717545
			# > rowSums(ans)[1:5]
			# [1] 1 1 1 1 1

			cumRisk=apply(ans,1,sum)
			cols=rep("red",length(cumRisk)); indic = myDAT[,smoking.status]==1 # current
			cols[!indic]="blue" # quitter

			#### calculate peak age for individual ###


			peak=apply(ans,1,max)
			yy=cbind(peak,ans)
			#y=yy[1,]

			mypeak.small <- function(y) {   (names(y)[-1])[(y[-1] == y[1])]  }
			# > peaks[1:5]
			#[1] 78 84 86 90 96  peak age of death for individual

			peaks = as.numeric(apply(yy,1,mypeak.small))


			#indic1 = myDAT[,age.rnd] < 63
			#indic1 = myDAT[,smoking.status]==1


			#plot(myDAT[,cig.day],cumRisk,xlab="cig/day",ylab="Cumulative Risk",col=cols,main="Smoking intensity and cumulative Risk")
			plot(myDAT[,"pkyr"],cumRisk,xlab="Pack-years",ylab="Cumulative Risk since randomization",col=cols,main="Pack-years and cumulative risk since randomization")
			legend(x="topright",legend=c("Current smoker","Former smoker"),bg="white",fill=c("red","blue"))

			#plot(myDAT[indic1,"pkyr"],cumRisk[indic1],xlab="Pack-years",ylab="Cumulative Risk since randomization",col=cols[indic1],main="Pack-years and cumulative risk since randomization")
			#plot(myDAT[!indic1,"pkyr"],cumRisk[!indic1],xlab="Pack-years",ylab="Cumulative Risk since randomization",col=cols[!indic1],main="Pack-years and cumulative risk since randomization")

			plot(myDAT[,"pkyr"],peaks,xlab="Pack-years",ylab="Peak age for death from other cause of mortality",col=cols,main="Pack-years and Peak age for death from other cause of mortality")
			legend(x="topright",legend=c("Current smoker","Former smoker"),bg="white",fill=c("red","blue"))

			#par(mfrow=c(1,2))
		    #hist(peaks[indic],nclass=10,xlim=c(70,110),col="red")
			#hist(peaks[!indic],nclass=10,xlim=c(70,110),col="blue")

			#plot(myDAT[,age.rnd],cumRisk,xlab="Randomized Age",ylab="Cumulative Risk since randomization",col=cols,main="Randomized Age and cumulative risk since randomization")

			#plot(myDAT[,"smokeyr"],cumRisk,xlab="Duration",ylab="Cumulative Risk",col=cols,main="Smoking duration and cumulative Risk")


            ## attach identifier ##
            ans2 = cbind(pid=myDAT[,ID],ans)
            ans2

        }#end of my.other.cause.mortalith.pdf







######################### (3) Simulation realted functions ####################################

		 mySimul.cohort <- function(x,n){   # given the index, this will sample them and sort to provide cohort index for each sampled individual

		       prob =rep( 1/length(cohort.names), length(cohort.names))   # uniform prob
				# > prob[1:5];sum(prob)
				# [1] 6.341154e-05 6.341154e-05 6.341154e-05 6.341154e-05 6.341154e-05
				# [1] 1

		       tt1=sample(cohort.names, n, prob = prob, replace=T)
		       table(tt1)
			   tt2=sort(tt1)
				# > table(tt2)[1:5]
				# tt2
				#  1  2  3  4  5
				# 10 13 10 18 13

				tt2

		 }#end of mySimul.cohort


		#### 12/18/2012: simulating age from hazard prob #####

		mySimul_age.hazard <- function(hazmat, index){   ## given probability matrix, it samples one observation with index number (row number)


		        #### redefine a "big.matrix":  matching matrix between index and prob matrix

				# > dim(probmat)
				# [1] 15770   100
				# > length(index)
				# [1] 157700
				# > index[1:15]
				#  [1] 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2

 				hazmat.big = hazmat[index,]   # this is the matrix for each: duplicated
				# > dim(probmat.big)
				# [1] 157700    100

		        xx = hazmat.big
		        x=xx[1,]
				# > x[1:10]
				# index     1     2     3     4     5     6     7     8     9
				#     1     0     0     0     0     0     0     0     0     0
		       #mySimul.age.dist.small(x)
		       #[1]  87

			   mySimul.age.hazard.small <- function(x){    # it sample the entry number from its given probabiliy x

					# > x[1:80]
					#          1          2          3          4          5          6          7          8          9         10         11
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
					#         12         13         14         15         16         17         18         19         20         21         22
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
					#         23         24         25         26         27         28         29         30         31         32         33
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
					#         34         35         36         37         38         39         40         41         42         43         44
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
					#         45         46         47         48         49         50         51         52         53         54         55
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
					#         56         57         58         59         60         61         62         63         64         65         66
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.01923262
					#         67         68         69         70         71         72         73         74         75         76         77
					# 0.02032470 0.02144273 0.02258124 0.02373368 0.02489227 0.02604791 0.02719016 0.02830715 0.02938559 0.03041078 0.03136669
					#         78         79         80
					# 0.03223612 0.03300087 0.03364201

				   unif = runif(length(x),0,1)
				   #cbind(unif, x)[50:60,]
					#          unif           x
					# X49 0.9689245 0.001022143
					# X50 0.9947817 0.001181100
					# X51 0.1040130 0.001363749
					# X52 0.2727477 0.001573288
					# X53 0.6638858 0.001813237
					# X54 0.4763706 0.002087437
					# X55 0.8161113 0.002400024
					# X56 0.8504529 0.002755398
					# X57 0.6252054 0.003158155
					# X58 0.3866804 0.003612989
					# X59 0.1916993 0.004124563

				    indic = unif <= x
				    if(sum(indic)>0)   ans = (1:length(x))[indic][1]
				    if(sum(indic)==0) ans=999

				    ans


				   #sample(1:length(x), size = 1, prob= x, replace=T)

			   }#end of


		       #### simulate column number from the given probability distributuion

		       age.ocm = apply(xx,1,mySimul.age.hazard.small)
		       #age.ocm[1:10]
		       # [1] 69 92 78 87 86 79 70 71 89 61      --> age from the age distribution

			   age.ocm


		 }#end of mySimul_age.ocm



		###### 2/22/2013: sample from names(x), not 1:length(x)
		mySimul_age.hazard2 <- function(hazmat, index){   ## given probability matrix, it samples one observation with index number (row number)


		        #### redefine a "big.matrix":  matching matrix between index and prob matrix

				# > dim(probmat)
				# [1] 15770   100
				# > length(index)
				# [1] 157700
				# > index[1:15]
				#  [1] 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2

 				hazmat.big = hazmat[index,]   # this is the matrix for each: duplicated
				# > dim(probmat.big)
				# [1] 157700    100

		        xx = hazmat.big
		        x=xx[1,]
				# > x[1:10]
				# index     1     2     3     4     5     6     7     8     9
				#     1     0     0     0     0     0     0     0     0     0
		       #mySimul.age.dist.small(x)
		       #[1]  87


			   mySimul.age.hazard.small <- function(x){    # it sample the entry number from its given probabiliy x

					# > x[1:80]
					#          1          2          3          4          5          6          7          8          9         10         11
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
					#         12         13         14         15         16         17         18         19         20         21         22
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
					#         23         24         25         26         27         28         29         30         31         32         33
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
					#         34         35         36         37         38         39         40         41         42         43         44
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
					#         45         46         47         48         49         50         51         52         53         54         55
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
					#         56         57         58         59         60         61         62         63         64         65         66
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.01923262
					#         67         68         69         70         71         72         73         74         75         76         77
					# 0.02032470 0.02144273 0.02258124 0.02373368 0.02489227 0.02604791 0.02719016 0.02830715 0.02938559 0.03041078 0.03136669
					#         78         79         80
					# 0.03223612 0.03300087 0.03364201

				   unif = runif(length(x),0,1)
				   #cbind(unif, x)[50:60,]
					#          unif           x
					# X49 0.9689245 0.001022143
					# X50 0.9947817 0.001181100
					# X51 0.1040130 0.001363749
					# X52 0.2727477 0.001573288
					# X53 0.6638858 0.001813237
					# X54 0.4763706 0.002087437
					# X55 0.8161113 0.002400024
					# X56 0.8504529 0.002755398
					# X57 0.6252054 0.003158155
					# X58 0.3866804 0.003612989
					# X59 0.1916993 0.004124563

				    indic = unif <= x
				    if(sum(indic)>0)   ans = (as.numeric(names(x)))[indic][1]
				    #if(sum(indic)>0)   ans = (1:length(x))[indic][1]
				    if(sum(indic)==0) ans=999

				    ans


				   #sample(1:length(x), size = 1, prob= x, replace=T)

			   }#end of


		       #### simulate column number from the given probability distributuion

		       age.ocm = apply(xx,1,mySimul.age.hazard.small)
		       #age.ocm[1:10]
		       # [1] 69 92 78 87 86 79 70 71 89 61      --> age from the age distribution

			   age.ocm


		 }#end of mySimul_age.ocm

  		### 1/20/2013: sample from names(x), not 1:length(x)
  		mySimul_age.pdf2 <- function(probmat, index){   ## given probability matrix, it samples one observation with index number (row number)


		        #### redefine a "big.matrix":  matching matrix between index and prob matrix

				# > dim(probmat)
				# [1] 15770   100
				# > length(index)
				# [1] 157700
				# > index[1:15]
				#  [1] 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2

 				probmat.big = probmat[index,]   # this is the matrix for each: duplicated
				# > dim(probmat.big)
				# [1] 157700    100

		        xx = probmat.big
		        x=xx[1,]
				# > x[1:10]
				# index     1     2     3     4     5     6     7     8     9
				#     1     0     0     0     0     0     0     0     0     0
		       #mySimul.age.dist.small(x)
		       #[1]  87

			   mySimul.age.dist.small <- function(x){    # it sample the entry number from its given probabiliy x

					# > x[1:80]
					#          1          2          3          4          5          6          7          8          9         10         11
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
					#         12         13         14         15         16         17         18         19         20         21         22
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
					#         23         24         25         26         27         28         29         30         31         32         33
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
					#         34         35         36         37         38         39         40         41         42         43         44
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
					#         45         46         47         48         49         50         51         52         53         54         55
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
					#         56         57         58         59         60         61         62         63         64         65         66
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.01923262
					#         67         68         69         70         71         72         73         74         75         76         77
					# 0.02032470 0.02144273 0.02258124 0.02373368 0.02489227 0.02604791 0.02719016 0.02830715 0.02938559 0.03041078 0.03136669
					#         78         79         80
					# 0.03223612 0.03300087 0.03364201

				   sample(as.numeric(names(x)), size = 1, prob= x, replace=T)

			   }#end of


		       #### simulate column number from the given probability distributuion

		       age.ocm = apply(xx,1,mySimul.age.dist.small)
		       #age.ocm[1:10]
		       # [1] 69 92 78 87 86 79 70 71 89 61      --> age from the age distribution

			   age.ocm


		 }#end of mySimul_age.ocm




		mySimul_age.pdf <- function(probmat, index){   ## given probability matrix, it samples one observation with index number (row number)


		        #### redefine a "big.matrix":  matching matrix between index and prob matrix

				# > dim(probmat)
				# [1] 15770   100
				# > length(index)
				# [1] 157700
				# > index[1:15]
				#  [1] 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2

 				probmat.big = probmat[index,]   # this is the matrix for each: duplicated
				# > dim(probmat.big)
				# [1] 157700    100

		        xx = probmat.big
		        x=xx[1,]
				# > x[1:10]
				# index     1     2     3     4     5     6     7     8     9
				#     1     0     0     0     0     0     0     0     0     0
		       #mySimul.age.dist.small(x)
		       #[1]  87

			   mySimul.age.dist.small <- function(x){    # it sample the entry number from its given probabiliy x

					# > x[1:80]
					#          1          2          3          4          5          6          7          8          9         10         11
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
					#         12         13         14         15         16         17         18         19         20         21         22
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
					#         23         24         25         26         27         28         29         30         31         32         33
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
					#         34         35         36         37         38         39         40         41         42         43         44
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
					#         45         46         47         48         49         50         51         52         53         54         55
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
					#         56         57         58         59         60         61         62         63         64         65         66
					# 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.01923262
					#         67         68         69         70         71         72         73         74         75         76         77
					# 0.02032470 0.02144273 0.02258124 0.02373368 0.02489227 0.02604791 0.02719016 0.02830715 0.02938559 0.03041078 0.03136669
					#         78         79         80
					# 0.03223612 0.03300087 0.03364201

				   sample(1:length(x), size = 1, prob= x, replace=T)

			   }#end of


		       #### simulate column number from the given probability distributuion

		       age.ocm = apply(xx,1,mySimul.age.dist.small)
		       #age.ocm[1:10]
		       # [1] 69 92 78 87 86 79 70 71 89 61      --> age from the age distribution

			   age.ocm


		 }#end of mySimul_age.ocm



		########### 12/18/2012: remove hazard before entry ###

		myrmv.prob <- function(prob,age){

			# > prob[1:5,1:5]
			#                X1           X2          X3           X4           X5
			# [1,] 3.592616e-08 1.125429e-07 1.96841e-07 2.895905e-07 3.916386e-07
			# [2,] 3.592616e-08 1.125429e-07 1.96841e-07 2.895905e-07 3.916386e-07
			# [3,] 3.592616e-08 1.125429e-07 1.96841e-07 2.895905e-07 3.916386e-07
			# [4,] 3.592616e-08 1.125429e-07 1.96841e-07 2.895905e-07 3.916386e-07
			# [5,] 3.592616e-08 1.125429e-07 1.96841e-07 2.895905e-07 3.916386e-07

			# > length(age)
			# [1] 15770
			# > dim(prob)
			# [1] 15770   115	  # pdf for age 1 - age 115




			#### prob of no cancer in the life time ##
			#noCancer = 1-rowSums(prob)
			# > noCancer[1:5]
			# [1] 0.2864284 0.5739915 0.4557052 0.2480494 0.4936268
			# > length(noCancer)
			# [1] 15770
			# > rowSums(prob)[1:5]
			# [1] 0.7135716 0.4260085 0.5442948 0.7519506 0.5063732	 <-- first person started smoking age 14

			#myMAT = cbind(prob,noCancer)
			#rowSums(myMAT)[1:5] #[1] 1 1 1 1 1

			#age[1:5]
			# [1] 66.34889 66.34889 66.34889 66.34889 66.34889	 ---> these are from the same cohort

			# > floor(age)[1:5]
			# [1] 66 60 64 55 68

			MAT = cbind(age=age,prob)
			MAT[1:5,1:10]
			# > 			MAT[1:5,1:10]
			#      age            1          2            3            4            5            6            7           8            9
			# [1,]  66 7.301485e-08 1.5335e-07 2.417393e-07 3.389902e-07 4.459911e-07 5.637193e-07 6.932503e-07 8.35767e-07 9.925714e-07
			# [2,]  60 7.301485e-08 1.5335e-07 2.417393e-07 3.389902e-07 4.459911e-07 5.637193e-07 6.932503e-07 8.35767e-07 9.925714e-07
			# [3,]  64 7.301485e-08 1.5335e-07 2.417393e-07 3.389902e-07 4.459911e-07 5.637193e-07 6.932503e-07 8.35767e-07 9.925714e-07
			# [4,]  55 7.301485e-08 1.5335e-07 2.417393e-07 3.389902e-07 4.459911e-07 5.637193e-07 6.932503e-07 8.35767e-07 9.925714e-07
			# [5,]  68 7.301485e-08 1.5335e-07 2.417393e-07 3.389902e-07 4.459911e-07 5.637193e-07 6.932503e-07 8.35767e-07 9.925714e-07


			x=MAT[1,]

					my.trunc.small <- function(x){
						# > x[1:5]
						#          age           X1           X2           X3           X4
						#           66 3.592616e-08 1.125429e-07 1.968410e-07 2.895905e-07
						# > x[115:117]
						#        X114        X115    noCancer
						# 0.007930250 0.007720696 0.286428383

						ag = x[1]
						x2 = x[-1] #sum(x2) #[1]

						## put zero prob from 1-66
						x2[1:(ag-1)]=0
						#x2[1:(ag-1)]=0
						# > sum(x2)
						# [1] 0.9358777

						## normalize the prob after 66

						#myprob = x2/sum(x2)   # sum(myprob) [1] 1

						# > length(myprob)
						# [1] 116
						# > myprob[1:5]
						# X1 X2 X3 X4 X5
						#  0  0  0  0  0

						x2

					}#



 			#my.trunc.small(x)


 			prob.tr = t(apply(MAT,1,my.trunc.small))
			# > dim(prob.tr)
			# [1] 15770   116
			# > cbind(prob.tr,age=age)[1:5,112:117]
			#             X112        X113        X114        X115  noCancer      age
			# [1,] 0.008940722 0.008703866 0.008473597 0.008249685 0.3060532 66.34889
			# [2,] 0.011152846 0.010968215 0.010774720 0.010574513 0.5814729 60.53021
			# [3,] 0.008195595 0.008058198 0.007924108 0.007793295 0.5072218 64.43520
			# [4,] 0.007390574 0.007191835 0.006999143 0.006812200 0.2523759 55.68645
			# [5,] 0.008632369 0.008499337 0.008368821 0.008240896 0.5395020 68.61477

			prob.tr


		}# mycond.prob


		####### 3/6/2013: Put zero to hazard probability given a certain age
		myTruncate.zero <- function(prob,age){

			# > prob[1:5,1:5]
			#      3            4          5            6            7
			# [1,] 0 7.301485e-08 1.5335e-07 2.417393e-07 3.389902e-07
			# [2,] 0 7.301485e-08 1.5335e-07 2.417393e-07 3.389902e-07
			# [3,] 0 7.301485e-08 1.5335e-07 2.417393e-07 3.389902e-07
			# [4,] 0 7.301485e-08 1.5335e-07 2.417393e-07 3.389902e-07
			# [5,] 0 7.301485e-08 1.5335e-07 2.417393e-07 3.389902e-07


			# > prob[1:5,1:5]
			#                X1           X2          X3           X4           X5
			# [1,] 3.592616e-08 1.125429e-07 1.96841e-07 2.895905e-07 3.916386e-07
			# [2,] 3.592616e-08 1.125429e-07 1.96841e-07 2.895905e-07 3.916386e-07
			# [3,] 3.592616e-08 1.125429e-07 1.96841e-07 2.895905e-07 3.916386e-07
			# [4,] 3.592616e-08 1.125429e-07 1.96841e-07 2.895905e-07 3.916386e-07
			# [5,] 3.592616e-08 1.125429e-07 1.96841e-07 2.895905e-07 3.916386e-07

			# > length(age)
			# [1] 15770
			# > dim(prob)
			# [1] 15770   115	  # pdf for age 1 - age 115

			#### prob of no cancer in the life time ##
			#noCancer = 1-rowSums(prob)
			# > noCancer[1:5]
			# [1] 0.2864284 0.5739915 0.4557052 0.2480494 0.4936268
			# > length(noCancer)
			# [1] 15770
			# > rowSums(prob)[1:5]
			# [1] 0.7135716 0.4260085 0.5442948 0.7519506 0.5063732	 <-- first person started smoking age 14

			#myMAT = cbind(prob,noCancer)
			#rowSums(myMAT)[1:5] #[1] 1 1 1 1 1

			#age[1:5]
			# [1] 66.34889 66.34889 66.34889 66.34889 66.34889	 ---> these are from the same cohort

			# > floor(age)[1:5]
			# [1] 66 60 64 55 68

			myMAT=prob

			#MAT = cbind(age=floor(age),myMAT)

			MAT = cbind(age,myMAT)
			x=MAT[1,]

					my.trunc.small <- function(x){
						#
						# > x[1:5]
						#          age            3            4            5            6
						# 5.700000e+01 0.000000e+00 7.301485e-08 1.533500e-07 2.417393e-07
						# > 5.700000e+01
						# [1] 57

						# > x[1:5]
						#          age           X1           X2           X3           X4
						#           66 3.592616e-08 1.125429e-07 1.968410e-07 2.895905e-07
						# > x[115:117]
						#        X114        X115    noCancer
						# 0.007930250 0.007720696 0.286428383

						ag = x[1]
						x2 = x[-1] #sum(x2) #[1]

						## put zero prob from 1-65
						myindic = c(as.numeric(names(x2[-length(x2)])) < ag, FALSE) # no zero for "noCancer" at the end
						#> myindic
						# [1]  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE
						#[20]  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE
						#[39]  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
						#[58] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
						#[77] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
						#[96] FALSE

						x2[myindic]=0

						#x2[1:(ag-1)]=0
						# > sum(x2)
						# [1] 0.9358777

						## normalize the prob after 66

				#myprob = x2/sum(x2)   # sum(myprob) [1] 1

						# > length(myprob)
						# [1] 116
						# > myprob[1:5]
						# X1 X2 X3 X4 X5
						#  0  0  0  0  0

						#myprob

						x2

					}#



 			#my.trunc.small(x)


 			prob.tr = t(apply(MAT,1,my.trunc.small))
			# > dim(prob.tr)
			# [1] 15770   116
			# > prob.tr[1:5,50:70]
			#      52 53 54          55          56          57          58          59          60          61          62
			# [1,]  0  0  0 0.000000000 0.000000000 0.003957362 0.004802783 0.002120376 0.002313361 0.002521958 0.002747063
			# [2,]  0  0  0 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.003163864 0.003672139
			# [3,]  0  0  0 0.003425709 0.004022723 0.004709967 0.005496021 0.006388449 0.007393050 0.008512964 0.009747697
			# [4,]  0  0  0 0.000000000 0.002766471 0.003208397 0.003712284 0.004283929 0.004928709 0.005651218 0.006454821
			# [5,]  0  0  0 0.000000000 0.000000000 0.000000000 0.000000000 0.000000000 0.001544860 0.001688683 0.001844756
			#               63          64          65          66          67          68          69          70          71
			# [1,] 0.002989561 0.003250303 0.003530091 0.003829660 0.004149657 0.004490615 0.004852929 0.005236831 0.005642365
			# [2,] 0.004252724 0.004912770 0.005659100 0.006497813 0.007433798 0.008470173 0.009607671 0.010844026 0.012173410
			# [3,] 0.011092144 0.012535746 0.014061931 0.015648012 0.017265670 0.018882117 0.020461891 0.021969160 0.023370261
			# [4,] 0.007341149 0.008309575 0.009356694 0.010475892 0.011657078 0.012886635 0.014147693 0.015420720 0.016684459
			# [5,] 0.002013903 0.002196963 0.002394778 0.002608185 0.002838002 0.003085015 0.003349957 0.003633493 0.003936195
			#               72
			# [1,] 0.006069358
			# [2,] 0.013586001
			# [3,] 0.024636183
			# [4,] 0.017917115
			# [5,] 0.004258524
			# > age[1:10]
			#  [1] 57 61 55 56 60 64 55 56 62 62


			prob.tr


		}# myTruncate.zero


		####### 1/20/2013: age is not necessariyt starting from 1 ###
		mycond.prob2 <- function(prob,age){

			# > prob[1:5,1:5]
			#                X1           X2          X3           X4           X5
			# [1,] 3.592616e-08 1.125429e-07 1.96841e-07 2.895905e-07 3.916386e-07
			# [2,] 3.592616e-08 1.125429e-07 1.96841e-07 2.895905e-07 3.916386e-07
			# [3,] 3.592616e-08 1.125429e-07 1.96841e-07 2.895905e-07 3.916386e-07
			# [4,] 3.592616e-08 1.125429e-07 1.96841e-07 2.895905e-07 3.916386e-07
			# [5,] 3.592616e-08 1.125429e-07 1.96841e-07 2.895905e-07 3.916386e-07

			# > length(age)
			# [1] 15770
			# > dim(prob)
			# [1] 15770   115	  # pdf for age 1 - age 115

			#### prob of no cancer in the life time ##
			noCancer = 1-rowSums(prob)
			# > noCancer[1:5]
			# [1] 0.2864284 0.5739915 0.4557052 0.2480494 0.4936268
			# > length(noCancer)
			# [1] 15770
			# > rowSums(prob)[1:5]
			# [1] 0.7135716 0.4260085 0.5442948 0.7519506 0.5063732	 <-- first person started smoking age 14

			myMAT = cbind(prob,noCancer)
			rowSums(myMAT)[1:5] #[1] 1 1 1 1 1

			#age[1:5]
			# [1] 66.34889 66.34889 66.34889 66.34889 66.34889	 ---> these are from the same cohort

			# > floor(age)[1:5]
			# [1] 66 60 64 55 68

			MAT = cbind(age=floor(age),myMAT)
			x=MAT[1,]

					my.trunc.small <- function(x){
						# > x[1:5]
						#          age           X1           X2           X3           X4
						#           66 3.592616e-08 1.125429e-07 1.968410e-07 2.895905e-07
						# > x[115:117]
						#        X114        X115    noCancer
						# 0.007930250 0.007720696 0.286428383

						ag = x[1]
						x2 = x[-1] #sum(x2) #[1]

						## put zero prob from 1-65
						myindic = c(as.numeric(names(x2[-length(x2)])) < ag, FALSE) # no zero for "noCancer" at the end
						#> myindic
						# [1]  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE
						#[20]  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE
						#[39]  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
						#[58] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
						#[77] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
						#[96] FALSE

						x2[myindic]=0

						#x2[1:(ag-1)]=0
						# > sum(x2)
						# [1] 0.9358777

						## normalize the prob after 66

						myprob = x2/sum(x2)   # sum(myprob) [1] 1

						# > length(myprob)
						# [1] 116
						# > myprob[1:5]
						# X1 X2 X3 X4 X5
						#  0  0  0  0  0

						myprob

					}#



 			#my.trunc.small(x)


 			prob.tr = t(apply(MAT,1,my.trunc.small))
			# > dim(prob.tr)
			# [1] 15770   116
			# > cbind(prob.tr,age=age)[1:5,112:117]
			#             X112        X113        X114        X115  noCancer      age
			# [1,] 0.008940722 0.008703866 0.008473597 0.008249685 0.3060532 66.34889
			# [2,] 0.011152846 0.010968215 0.010774720 0.010574513 0.5814729 60.53021
			# [3,] 0.008195595 0.008058198 0.007924108 0.007793295 0.5072218 64.43520
			# [4,] 0.007390574 0.007191835 0.006999143 0.006812200 0.2523759 55.68645
			# [5,] 0.008632369 0.008499337 0.008368821 0.008240896 0.5395020 68.61477

			prob.tr


		}# mycond.prob

		mycond.prob <- function(prob,age){

			# > prob[1:5,1:5]
			#                X1           X2          X3           X4           X5
			# [1,] 3.592616e-08 1.125429e-07 1.96841e-07 2.895905e-07 3.916386e-07
			# [2,] 3.592616e-08 1.125429e-07 1.96841e-07 2.895905e-07 3.916386e-07
			# [3,] 3.592616e-08 1.125429e-07 1.96841e-07 2.895905e-07 3.916386e-07
			# [4,] 3.592616e-08 1.125429e-07 1.96841e-07 2.895905e-07 3.916386e-07
			# [5,] 3.592616e-08 1.125429e-07 1.96841e-07 2.895905e-07 3.916386e-07

			# > length(age)
			# [1] 15770
			# > dim(prob)
			# [1] 15770   115	  # pdf for age 1 - age 115

			#### prob of no cancer in the life time ##
			noCancer = 1-rowSums(prob)
			# > noCancer[1:5]
			# [1] 0.2864284 0.5739915 0.4557052 0.2480494 0.4936268
			# > length(noCancer)
			# [1] 15770
			# > rowSums(prob)[1:5]
			# [1] 0.7135716 0.4260085 0.5442948 0.7519506 0.5063732	 <-- first person started smoking age 14

			myMAT = cbind(prob,noCancer)
			rowSums(myMAT)[1:5] #[1] 1 1 1 1 1

			#age[1:5]
			# [1] 66.34889 66.34889 66.34889 66.34889 66.34889	 ---> these are from the same cohort

			# > floor(age)[1:5]
			# [1] 66 60 64 55 68

			MAT = cbind(age=floor(age),myMAT)
			x=MAT[1,]

					my.trunc.small <- function(x){
						# > x[1:5]
						#          age           X1           X2           X3           X4
						#           66 3.592616e-08 1.125429e-07 1.968410e-07 2.895905e-07
						# > x[115:117]
						#        X114        X115    noCancer
						# 0.007930250 0.007720696 0.286428383

						ag = x[1]
						x2 = x[-1] #sum(x2) #[1]

						## put zero prob from 1-65
						x2[1:(ag-1)]=0
						# > sum(x2)
						# [1] 0.9358777

						## normalize the prob after 66

						myprob = x2/sum(x2)   # sum(myprob) [1] 1

						# > length(myprob)
						# [1] 116
						# > myprob[1:5]
						# X1 X2 X3 X4 X5
						#  0  0  0  0  0

						myprob

					}#



 			#my.trunc.small(x)


 			prob.tr = t(apply(MAT,1,my.trunc.small))
			# > dim(prob.tr)
			# [1] 15770   116
			# > cbind(prob.tr,age=age)[1:5,112:117]
			#             X112        X113        X114        X115  noCancer      age
			# [1,] 0.008940722 0.008703866 0.008473597 0.008249685 0.3060532 66.34889
			# [2,] 0.011152846 0.010968215 0.010774720 0.010574513 0.5814729 60.53021
			# [3,] 0.008195595 0.008058198 0.007924108 0.007793295 0.5072218 64.43520
			# [4,] 0.007390574 0.007191835 0.006999143 0.006812200 0.2523759 55.68645
			# [5,] 0.008632369 0.008499337 0.008368821 0.008240896 0.5395020 68.61477

			prob.tr


		}# mycond.prob



#### 11/15/2012: this is the same version as nhm2_vf_clean2c.reparam.fix3

#### 11/15/2012: this is the same version as nhm2_vf_clean2c.reparam.fix3

nhm2  <- function(n,x, setSeed, SEED=1234){

				# if(setSeed==T) set.seed(SEED)

				########### (0) parameters ##########

				grate.mu=x[1]  # < --- this inverse growth rate: r=1/grate.mu  --> V(t)=V0*exp(t/r): DVT = log(2)*r
				dcdet.mu=x[2]  # exp(dcdet.mu) is tumor diameter in cm

				a1=x[3]
				a2=x[4]
				a3=x[5]

				# L= a1  0   t(L)= a1  a3    Sigma= L*t(L) = a1^2   a1a3
				#    a3  a2         0  a2                    a1a3   a2^2+a3^2
				## cholesky decomposition ##
				Sigma = matrix(c( a1^2,      a1*a3,
								  a1*a3, a2^2 + a3^2), byrow=T,ncol=2)

				K1 = x[6] # shape param for sz.fatal  ## cure threshold volume  # in cm
				K2 = exp(x[7]) # scale param for sz.fatal

				L1 = x[8] # shape param for sz.death      # maximum bruden
				L2 = exp(x[9]) # scale param for sz.death

				frac.obs.mets = x[10]
				frac.cdet.mets = x[11]

				###################(1) simulation ######################################
		        # sphere volume calculator: V = (4/3)  pi  radius^3
				#library(MASS)

				##### bivariate lognormal: simulating from bivariate normal: growth rate and symptom detection threshold ####

				Mu=c(grate.mu, dcdet.mu)
				mv=mvrnorm(n, Mu, Sigma)
				grate=exp(mv[,1]) # if grate refers to volume: because log-normal distribution

				## r is inverse growth rate: that is, V(t)= V0*exp(t/r) is the correct model
				r=1/grate  # this r is different from the Lin and Plevritis 2012: V(t) = V0*exp(r0*t), but here V(t)=V0*exp(t/r)



				######## [1] detection due to primary tumor (not metastatic burden)

				diam.cdet.prime=exp(mv[,2])  # this is in centimeter
				#sz.cdet.prime=(diam.cdet.prime*10)^3  ## convert to milimeter and convert to diameter to volume

				volume2diam <- function(v)  {  # from volume to diameter

				     #  V = (4/3)  pi  radius^3
				     #  a=(4/3)*pi   # 4.18
				     #  radius =  (V/a)^(1/3)
				     #  diam = 2*((V/a)^(1/3))

				     a=(4/3)*pi   # 4.18
					 2*(v/a)^(1/3)


				}#end of


				diam2volume=function(diam)   (4/3)*pi*(diam/2)^3   # from diameter to volume

				##### size due to primary tumor (mm^3)

				sz.cdet.prime = diam2volume(diam.cdet.prime*10)   # after chaning to mm
				#sz.cdet.prime = (4/3)*pi*(diam.cdet.prime*10/2)^3    #  V = (4/3)  pi  radius^3
			    # size is in mm^3

				### time from c0 to cdetection (in years) ##

				time.cdet.prime = r * log(sz.cdet.prime/c0) # time till the primary detection
				#time.cdet.prime[1:5]
				# [1]  7.478700  5.764580  7.426803 11.683713  7.895128   --> 7.47 years to detect


				####### [2] cure detection threshold:  #####################################

				sz.fatal = c0 + rweibull(n, K1, K2) # volume size which is fatal point if not before this point

				## time from c0 to cure thresold   (in years)
				time.fatal = r * log(sz.fatal/c0)


				###### [3] death volume   ##########

				L = rweibull(n, L1, L2)
				sz.death = sz.fatal + L       # volume at which you die

				## time from cure threshold to death (in years)
				surv.fatal = r * log(sz.death/sz.fatal)


				#########[4] size of tumor for observable metastasis is proportion of death burden (observed )

				## size at observable metastasis (mm^3)
				sz.mets = sz.fatal + frac.obs.mets*L  # some given fraction of death burden lead detection due to metastatic burden

				### time from c0 to observable metastasis ##
				time.mets = r * log(sz.mets/c0)


				######## [5] Detection due to metastatic burden (symptomatic detected)  ###############

				sz.cdet.mets = sz.fatal + frac.cdet.mets*L

				## time from c0 to cdtection due to burden
				time.cdet.mets = r * log(sz.cdet.mets/c0)


		        ######## [6] Time for clinical detection from c0 ######################################

				######## detection time: earlier event among primary detection or metastatic burden detection
				## time for detecting tumor
				time.cdet = ifelse(time.cdet.prime < time.cdet.mets, time.cdet.prime, time.cdet.mets) ## whichever ealier

				## size at detection
				sz.cdet = ifelse(sz.cdet.prime < sz.cdet.mets, sz.cdet.prime, sz.cdet.mets)


				###### [7] survival time from c0 to death

				## time from c0 to death (if uncurable), if curable infinite
				#time.death = ifelse(sz.fatal > sz.cdet, 1000000, r * log(sz.death/c0)) # in years

				time.death.nocure =r * log(sz.death/c0)     # time to death without early detection & cure (time until natural death)
	            time.death = ifelse(sz.fatal > sz.cdet, 1000000, time.death.nocure) # time to death: you don't die of lung cancer if early detected before cure threshold

				###### [8] survival time: from clinical detection to death ####
				## survival time from clinical detection : this is really survival time

				surv.cdet0 = time.death - time.cdet
				surv.cdet = ifelse(surv.cdet0 < 0, 0, surv.cdet0) #there might be some obs with surv.cdet<0 due to floating point errors, set them back to 0

				surv.cdet.nocure = time.death.nocure - time.cdet  # time from clinical detection to death without cure

				#### [9] clinical stage: if tumor size at detection is larger than the tumor size at advanced stage threshold, then it's advanced stage
				           ### advanced if clinical detection comes later than observable metastatis time ####

				stage.cdet = 1*(sz.mets <= sz.cdet)


		        list(r=r, sz.cdet=sz.cdet, surv.cdet=surv.cdet, surv.cdet.nocure=surv.cdet.nocure, sz.fatal=sz.fatal, sz.mets=sz.mets , sz.cdet.mets=sz.cdet.mets,sz.cdet.prime=sz.cdet.prime, time.cdet.mets=time.cdet.mets,time.cdet.prime=time.cdet.prime, time.cdet=time.cdet )



} #end of function nhm

diam2volume=function(diam)   (4/3)*pi*(diam/2)^3   # from diameter to volume


################# These are related to assigning screening schedules: From Ayca's R functions #######

runif.vec <- function(n, lower, upper, vec.len){

	vec = rep(NA, vec.len)
	if (n>=1){

		vec[1:n] = runif(n, lower, upper)
#		vec[1:n] = sort(runif(n, lower, upper))
	}
	vec
}


ScreenTime.Markov <- function(times, prob1, prob2, n){
	# > prob1
	# [1] 0.972 0.973
	# > prob2
	# [1] 0.071
	# > n
	# [1] 157620
	# > times
	# [1] 0 1 2
	scr.times = rep(times[1], n) #everyone goes to the first screen

	unin = runif(n)

	## first screen
	next.scr = ifelse(unin < prob1[1], times[2], NA) # with 1-prob=1-0.972, give NA
	scr.times = cbind(scr.times, next.scr)

	for (j in 3:length(times)){ #length(times) is 3

		current.scr = next.scr
		unin = runif(n)
		tmp1 = ifelse(unin < prob1[j-1], times[j], NA) # 0.973  : give NA with prob=1-0.963
		tmp2 = ifelse(unin < prob2[j-2], times[j], NA) # 0.071  : give NA with prob=1-0.071!! no way
		next.scr = ifelse(!is.na(current.scr), tmp1, tmp2) # give one or the other depending on the current situation
		scr.times = cbind(scr.times, next.scr)
	}

	dimnames(scr.times)[[2]]=seq(length(times))
	scr.times
}


	volume2diam <- function(v)  {  # from volume to diameter

				     #  V = (4/3)  pi  radius^3
				     #  a=(4/3)*pi   # 4.18
				     #  radius =  (V/a)^(1/3)
				     #  diam = 2*((V/a)^(1/3))

				     a=(4/3)*pi   # 4.18
					 2*(v/a)^(1/3)


				}#end of
           myConvert.params.ray2new=function(xx){


                parnames1=c("grate.mu","dcdet.mu","grate.sig","dcdet.sig","cor.gd","K1","K2","L1","L2","frac.obs","frac.cdet")
                names(xx)=parnames1


				######### (1) reparametrize sigma #################

				sigPar = xx[3:5]
				# > sigpar
				# grate.sig dcdet.sig    cor.gd
				# 1.3812654 0.8842637 0.2971111

				#   grate.mu   dcdet.mu  grate.sig  dcdet.sig     cor.gd         K1         K2
				#  0.3430000  2.0630000  1.3812654  0.8842637  0.2971111  0.2623699  7.6160000
				#         L1         L2   frac.obs  frac.cdet
				#  0.6669768 12.9060000  0.2433893  0.4442378

				# L= a1  0   t(L)= a1  a3    L*t(L) = a1^2   a1a3
				#    a3  a2         0  a2             a1a3   a2^2+a3^2
		       #Sigma=matrix(c(grate.sig^2, grate.sig*dcdet.sig*cor.gd, grate.sig*dcdet.sig*cor.gd, dcdet.sig^2), 2, 2)

				#Sigma = matrix(c( grate.sig^2,      grate.sig*dcdet.sigcor.gd,             s1^2    s1s2r
				#                  grate.sig*dcdet.sigcor.gd, dcdet.sig^2), byrow=T,ncol=2) s1s2r   s2^2

				## equation:  solve in terms of s1, s2, and r
				##   a1 = s1
				##   a1a3 = s1s2r = a1s2r  -->   a3 = s2r
				##   a2^2 + a3^2 = s2^2  -->  a2^2 = s2^2 - a3^2 = s2^2 -s2^2*r^2 = s2^2(1-r^2)

				## a1= s1;   a2 = sqrt(s2^2(1-r^2));   a3=s2*r

				# (a1, a2, a3) # is new set


				sigPar.new = c(sigPar[1],  sqrt( (sigPar[2]^2)*(1-sigPar[3]^2)),  sigPar[2]*sigPar[3])
				sigPar.new
				# > sigPar.new
				# grate.sig dcdet.sig dcdet.sig
				# 1.3812654 0.8443329 0.2627246

				doThis=F
				if(doThis==T){

						sigNew=matrix( c(sigPar.new[1]^2,  sigPar.new[1]*sigPar.new[3],
										 sigPar.new[1]*sigPar.new[3],  sigPar.new[2]^2 + sigPar.new[3]^2), byrow=T,ncol=2)

						sig=matrix( c(sigPar[1]^2,  sigPar[1]*sigPar[2]*sigPar[3],
									  sigPar[1]*sigPar[2]*sigPar[3],  sigPar[2]^2 ), byrow=T,ncol=2)

				}#end of
				# > sigNew
				#           [,1]      [,2]
				# [1,] 1.9078940 0.3628923
				# [2,] 0.3628923 0.7819222
				# > sig
				#           [,1]      [,2]
				# [1,] 1.9078940 0.3628923
				# [2,] 0.3628923 0.7819222


				########### (2) conversion of fractio parameters ######
				#   grate.mu   dcdet.mu  grate.sig  dcdet.sig     cor.gd         K1         K2
				#  0.3430000  2.0630000  1.3812654  0.8842637  0.2971111  0.2623699  7.6160000
				#         L1         L2   frac.obs  frac.cdet
				#  0.6669768 12.9060000  0.2433893  0.4442378


				# beta(a,b): mean(X) = a/(a+b)
				   # frac = a/(a+b)  -->    (a+b)*frac = a --> b*frac = a-a*frac = a(1-frac)
				   # --> b=a*(1-frac)/frac

				   #a = 10

				   #frac2beta <- function(frac,a) {   b = a*(1-frac)/frac }

				   #frac1  = xx[10]
				   #frac2  = xx[11]

				   #xx.fracs = c(a, frac2beta(frac1,a), a, frac2beta(frac2,a))
				   #names(xx.fracs) = c("frac.obs.a1","frac.obs.a1","frac.obs.b1","frac.obs.b2")
				   #xx.fracs
					# frac.obs.a1 frac.obs.a1 frac.obs.b1 frac.obs.b2
					#    10.00000    31.08644    10.00000    12.51047


				   doThis=F
				   if(doThis==T){

					   frac=0.24
					   a=10
					   #a=30
					   b = a * (1-frac)/frac
					   xxx=seq(0.01,0.95,length.out=100)
					   plot(xxx,dbeta(xxx,a,b),typ="l")

				   }#endof


                  ############ (3) define new parameters #################################
                  xx.new = xx

				  #xx.new = rep(0,length(xx)+2)
				  #xx.new[1:11]=xx[1:11]

				  xx.new[3:5] = sigPar.new
				  #xx.new[10:13] = xx.fracs

				  #parnames2=c("grate.mu","dcdet.mu","a1","a2","a3","K1","K2","L1","L2","frac.obs.a1","frac.obs.a2","frac.cdet.a1","frac.cdet.a2")
                  #names(xx.new)=parnames2
					# > xx.new
					#     grate.mu     dcdet.mu           a1           a2           a3           K1
					#    0.3430000    2.0630000    1.3812654    0.8443329    0.2627246    0.2623699
					#           K2           L1           L2  frac.obs.a1  frac.obs.a2 frac.cdet.a1
					#    7.6160000    0.6669768   12.9060000   10.0000000   31.0864383   10.0000000
					# frac.cdet.a2
					#   12.5104654

					xx.new


           }#end of


						###### update it. although you quit, according to Bach model, smoking per cigertte and duration should stay there

			smoking.var <- function(x,age){  ## creat a matrix with cig/day, duration and quit for age 0:115

					# x
					#   cigsmok  smokeage  age_quit  smokeday death.age
					#         0        22        45        40       115
					######### (1) Make a profile for the argument ###########
				######### Make profile = list( breaks, dose) for each individual which is an argment for p2.plot() ######
				# current smoker: profile <- list(breaks=c(20,100),dose=c(0,20)):    until age 20, dose was 0 and from then on to 100, dose was 20 (current smoker)
				# former smoker: profile <- list(breaks=c(20,45,100),dose=c(0,40,0)): until age 20, dose=0, until age 45, dose 40, then quit

				# > prof
				# $breaks
				# [1]  20 115
				#
				# $dose
				# [1]  0 30
				#
				# > x
				#   cigsmok  smokeage  age_quit  smokeday death.age
				#         0        15        61        40       115


					 prof=NULL

					 if(x[1] == 1){   # if current smoker
														# start.age, death.time       0, cig/day
						  prof = list(breaks=as.vector(c(x[2],x[5])),dose=as.vector(c(0,x[4])))
							# > prof
							# $breaks
							# [1]   5 115    # until age 5, dose=0, until death, dose= 30
							#
							# $dose
							# [1]  0 30

					 } else{  # if former smoker
											   # start.age, quit.age, death.time
							prof = list(breaks=as.vector(c(x[2],x[3],x[5])), dose =as.vector(c(0,x[4],0)))
							# $breaks
							# [1]  17  60 115
							#
							# $dose
							# [1]  0 30  0    # until age 17, dose=0, until age 60, dose=30, until death zero dose

							#   cigsmok  smokeage  age_quit  smokeday death.age
							#         0        17        60        30       115

					 }# end of else

					 prof

					# > prof
					# $breaks
					# [1]  22  45 115
					#
					# $dose
					# [1]  0 40  0

					#age=0:115

                    ### [1] make cigarette per day: cpd ##

                    br=prof$breaks   #[1]  14 115
                    ds=prof$dose
                    cpd0=rep(NA,length(age))
                    names(cpd0)=age
					# > prof$breaks
					# [1]  14 115
					smk0 = rep(NA,length(age))
					names(smk0)=age

					Quit0=rep(NA,length(age));names(Quit0)=age

					for(u in 1:length(br)){

					       st = br[1]
					       br0=br[u];br0  # [1] 22  for u==1  [1] 45 u==2
					       ds0=ds[u];ds0  #[1] 0 for u==1   [1] 40 for u==2

					       ### period ###

					       if(u==1) { period = age[1]:(br0-1) }#[1]  [1]  0  1  2  3  4  5  6  7  8  9 10 11 12 13
					       if(u>1) period = br[u-1]:(br0-1)
					       if(u>1 & u==length(br)) period = br[u-1]:(br0)
					       period
					       #if(u==2) period2= c(period,period[length(period)]+1)    # for duration, one year delay
					       #if(u==3) period2= c(period,period[length(period)]+1)    # for duration, one year advance

					       ### [1] cig/day ###

					       if(u==1 | u==2) cpd0[age %in% period] = ds0
							#cpd0[1:20]
							#  0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19
							#  0  0  0  0  0  0  0  0  0  0  0  0  0  0 20 20 20 20 20 20

							if(u==3 & ds0==0) cpd0[age %in% period] = cpd0[(period[1]-1)]   # keep the "previous" dosage  since although you quit, it should know the previous dosage and smoking years


					       ### [2] duration ###

					       if(u==1) smk0[age %in% period] = 0  # during 0~first age, assign 0             ## birth to first age
					       if(u==2 & ds0 >0) smk0[age %in%  c(period,period[length(period)]+1) ] = age[age %in% c(period,period[length(period)]+1)]-(br[u-1])   # from  first age to quit or first age to different dosage time
					                                       # a year delay compared to CPD
					       ### there are several situations: keep smoking with different dosage and stop smoking

					       if(u==3 & ds0 ==0) smk0[age %in% c(period[-1],period[length(period)])] = max(smk0[is.na(smk0)==F]) # previous dosage   # from quit  to different dosage time
					       #
					       if(u==3 & ds0 > 0) smk0[age %in% c(period[-1],period[length(period)])] = smk0[period[1]-1] + (1:length(period))   # from one dosage to different dosage time
					                                                   ## adding one year by year from  the previous year's duration
								# > period
								#  [1]  45  46  47  48  49  50  51  52  53  54  55  56  57  58  59  60  61  62  63  64  65  66  67  68
								# [25]  69  70  71  72  73  74  75  76  77  78  79  80  81  82  83  84  85  86  87  88  89  90  91  92
								# [49]  93  94  95  96  97  98  99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115

	                       ####[3] Quit years #####

	                       if(u==1 ) Quit0[age %in% period] = 0  # [1]from birth to the first smoking [2] from first smoking to second dosage or quit
	                       if(u==2 ) Quit0[age %in% period] = 0  # [1]from birth to the first smoking [2] from first smoking to second dosage or quit

	                       if(u==3 & ds0==0) Quit0[age %in% period] = age[age %in% period]-(br[u-1])       # from first smoking to the quit or to the second dosage


					       cbind(cpd0,smk0,Quit0)

					}#end of
					# > cpd0[1:30]
					#  0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29
					# 0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0 40 40 40 40 40 40 40 40
					ans=list(prof=prof,cig=cbind(cpd=cpd0,dur=smk0,Quit=Quit0))
					ans
					#     cpd dur Quit
					# 0     0   0    0
					# 1     0   0    0
					#
					# 16    0   0    0
					# 17    0   0    0
					# 18    0   0    0
					# 19    0   0    0
					# 20    0   0    0
					# 21    0   0    0
					# 22   40   0    0
					# 23   40   1    0
					# 24   40   2    0
					# 25   40   3    0
					# 26   40   4    0
					#
					# 41   40  19    0
					# 42   40  20    0
					# 43   40  21    0
					# 44   40  22    0
					# 45   40  23    0    <-- at age=45 quit smoking, and after, dosage and duration stays constant but quit variables comes in
					# 46   40  23    1
					# 47   40  23    2
					# 48   40  23    3
					# 49   40  23    4
					# 50   40  23    5
					# 51   40  23    6
					# 52   40  23    7
					# 53   40  23    8
					#
					# 112  40  23   67
					# 113  40  23   68
					# 114  40  23   69
					# 115  40  23   70

		   }#end of smoking.var


   ######### 7/8/2013: ayca fixed problem: if(time.fol >= time.det0 + maxFUP.years)
		    myFollowup3 <- function(x,dx.sz.ranges,delays.dx,maxFUP=F,maxFUP.years = 3,fuzzy.prob=0.2){   # given time of detection and size, this will give:

		            # (i) number of followup for diagnosis,
		            # (ii) diagnosis time
		            # (iii) mdet
					#x
					#        mdet     time.det      sz.det sz.det.bins   r
					#      1.0000      0.0000    108.3668      1.0000   0.3103965
					# > x
					#        mdet    time.det      sz.det sz.det.bins           r   time.cdet
					#    1.000000    1.000000   19.384147    0.000000    1.205679    5.081064


					####### (i) Define variable #######

					time.det0 = as.vector(x["time.det"])
					sz.det0=as.vector(x["sz.det"])
					sz.bin0 = findInterval(sz.det0, diam2volume(dx.sz.ranges))
					mdet0 = as.vector(x["mdet"])
					r0=as.vector(x["r"])
					time.cdet0= as.vector(x["time.cdet"])
					mySEED=as.vector(x["mySEED"]) #[1] 9077417


					time.det0
					#[1] 0
					sz.det0
					#[1] 108.3668
					sz.bin0
					#[1] 1   # this can take 0 1 2 3


					##### (ii) #####


					j=1

					mdet.out = time.dx.out = n.followup = sz.dx.out= sz.bin.out= NA

					while(TRUE){

							####[0] Fuzziness about being diagnosed after reaching 10mm ####
							### if indic.drop==T, you won't be diagnosed, but will keep getting another followup ##
							### this reflects the fact that 10mm reading is never accurate and there is some fuzziness

							# #set.seed(mySEED+3*j)

						# try(set.seed(mySEED + 2*j),silent = T)
							indic.drop = runif(1,min=0,max=1) < fuzzy.prob  # is it smaller than 0.2, then drop it and go back to followup without diagnosing them
							indic.drop

							#### (1) Assign folloup time ###

							time.fol = time.det0 + delays.dx[sz.bin0+1] # assign 1 if 0, 2 if 1
							time.fol
							#[1] 0.75

							#### (2) check the size at the followup ####

							sz.fol = sz.det0 * exp((time.fol-time.det0)/r0)
							sz.fol
							#[1] 1214.134

							sz.diam.fol = volume2diam(sz.fol)
							sz.diam.fol
							#[1] 13.23598  (in mm)

							#sz.dx = sz.cdet * exp((time.dx - time.cdet)/r)
							sz.bin.fol = findInterval(sz.fol, diam2volume(dx.sz.ranges))
							sz.bin.fol
							#[1] 4

							### (3) check if cdet happens before the followpu
							if(maxFUP==F){  # in case there is no max number of follows up

									if(time.fol >= time.cdet0){  # if cdet happens before the followp, then

										mdet.out = 0
										time.dx.out = time.cdet0
										n.followup = 0

										break()


									}#end of if(time.fol >= time.cdet0)


									### (4) if cdet is after the followup time it's fine

									if(time.fol < time.cdet0){

										#### stop if the size at followpu is above the threshold

										if(sz.diam.fol > thr.flp & indic.drop==F) { break }  # if no drop then finish
										#if(sz.diam.fol > thr.flp) { break }

										j = j+1

										sz.bin0 = sz.bin.fol
										time.det0 = time.fol
										sz.det0 = sz.fol


									}# end of if(time.fol < time.cdet0){

							}#end ofmaxFUP==F

							if(maxFUP==T){  # in case there is no max number of follows up

									if(time.fol >= time.cdet0){  # if cdet happens before the followp, then

										mdet.out = 0
										time.dx.out = time.cdet0
										n.followup = 0

										break()


									}#end of if(time.fol >= time.cdet0)



									### (4) if cdet is after the followup time it's fine

									if(time.fol < time.cdet0){

										#### stop if the size at followpu is above the threshold

										if(time.fol >= time.det0 + maxFUP.years){
										#if(time.fol >= maxFUP.years){  # if time to followup exceed 3 years then stop and make it clinical detection

										      mdet.out=0
										      time.dx.out = time.cdet0

										      break()

										}#if(sz.diam.fol >= n.maxFUP){


										#if(sz.diam.fol > thr.flp) { break }
										if(sz.diam.fol > thr.flp & indic.drop==F) { break }  # if no drop then finish


										### if not break ###

										j = j+1

										sz.bin0 = sz.bin.fol
										time.det0 = time.fol
										sz.det0 = sz.fol


									}# end of if(time.fol < time.cdet0){

							}#end ofmaxFUP==F


		         }#end of while(TRUE){


				n.followup = ifelse(is.na(n.followup)==T,  j,  n.followup)
				time.dx.out= ifelse(is.na(time.dx.out)==T, time.fol ,  time.dx.out)
	            mdet.out= ifelse(is.na(mdet.out)==T, mdet0 ,  mdet.out)  # stays as screen detect
	            sz.dx.out= ifelse(is.na(sz.dx.out)==T, sz.diam.fol ,  NA)
	            sz.bin.out = ifelse(is.na(sz.bin.out)==T, sz.bin.fol ,  NA)


				#out=c(n.followup=n.followup, time.dx.out=time.dx.out, mdet.out=mdet.out, sz.dx.out = sz.dx.out,sz.bin.out=sz.bin.out)
				# > 	            out
				#  n.followup time.dx.out    mdet.out   sz.dx.out  sz.bin.out
				#    3.000000    1.875000    1.000000    8.348113    3.000000


	            ### if sz.dx.out < 10mm, then add more dalay, 0.25 ###
	            time.dx.out.final = time.dx.out
				# delays.dx
				# > delays.dx
				# [1] 1.000 0.750 0.375 0.250 0.000	    (0,4),(4,6),(6,8),(8,10),(10~)

	            if(is.na(sz.dx.out)==F){

	                  if(sz.bin.out < 4) { # i.e. less than 10mm

	                         time.dx.out.final = time.dx.out + delays.dx[sz.bin.out+1]

	                  }#

	            }#end of

	            out=c(n.followup=n.followup, time.dx.out.final=time.dx.out.final, time.dx.out.pre=time.dx.out, mdet.out=mdet.out, sz.dx.out.pre = sz.dx.out,sz.bin.out=sz.bin.out)
	            out
				#   n.followup time.dx.out.final   time.dx.out.pre          mdet.out         sz.dx.out        sz.bin.out
				#   3.000000          2.125000          1.875000          1.000000          8.348113          3.000000



		}#end of my followup2


		    ##### 1/17/2012: introduce maxFUP ## for stable tumor, assign maximum followps
#n.maxFUP=3
		    myFollowup2 <- function(x,dx.sz.ranges,delays.dx,maxFUP=F,maxFUP.years = 3,fuzzy.prob=0.2){   # given time of detection and size, this will give:

		            # (i) number of followup for diagnosis,
		            # (ii) diagnosis time
		            # (iii) mdet
					#x
					#        mdet     time.det      sz.det sz.det.bins   r
					#      1.0000      0.0000    108.3668      1.0000   0.3103965
					# > x
					#        mdet    time.det      sz.det sz.det.bins           r   time.cdet
					#    1.000000    1.000000   19.384147    0.000000    1.205679    5.081064


					####### (i) Define variable #######

					time.det0 = as.vector(x["time.det"])
					sz.det0=as.vector(x["sz.det"])
					sz.bin0 = findInterval(sz.det0, diam2volume(dx.sz.ranges))
					mdet0 = as.vector(x["mdet"])
					r0=as.vector(x["r"])
					time.cdet0= as.vector(x["time.cdet"])
					mySEED=as.vector(x["mySEED"]) #[1] 9077417


					time.det0
					#[1] 0
					sz.det0
					#[1] 108.3668
					sz.bin0
					#[1] 1   # this can take 0 1 2 3


					##### (ii) #####


					j=1

					mdet.out = time.dx.out = n.followup = sz.dx.out= sz.bin.out= NA

					while(TRUE){

							####[0] Fuzziness about being diagnosed after reaching 10mm ####
							### if indic.drop==T, you won't be diagnosed, but will keep getting another followup ##
							### this reflects the fact that 10mm reading is never accurate and there is some fuzziness

							# #set.seed(mySEED+3*j)

						# try(set.seed(mySEED + 2*j),silent = T)
							indic.drop = runif(1,min=0,max=1) < fuzzy.prob  # is it smaller than 0.2, then drop it and go back to followup without diagnosing them
							indic.drop

							#### (1) Assign folloup time ###

							time.fol = time.det0 + delays.dx[sz.bin0+1] # assign 1 if 0, 2 if 1
							#[1] 0.75

							#### (2) check the size at the followup ####

							sz.fol = sz.det0 * exp((time.fol-time.det0)/r0)
							sz.fol
							#[1] 1214.134

							sz.diam.fol = volume2diam(sz.fol)
							sz.diam.fol
							#[1] 13.23598  (in mm)

							#sz.dx = sz.cdet * exp((time.dx - time.cdet)/r)
							sz.bin.fol = findInterval(sz.fol, diam2volume(dx.sz.ranges))
							sz.bin.fol
							#[1] 4

							### (3) check if cdet happens before the followpu
							if(maxFUP==F){  # in case there is no max number of follows up

									if(time.fol >= time.cdet0){  # if cdet happens before the followp, then

										mdet.out = 0
										time.dx.out = time.cdet0
										n.followup = 0

										break()


									}#end of if(time.fol >= time.cdet0)


									### (4) if cdet is after the followup time it's fine

									if(time.fol < time.cdet0){

										#### stop if the size at followpu is above the threshold

										if(sz.diam.fol > thr.flp & indic.drop==F) { break }  # if no drop then finish
										#if(sz.diam.fol > thr.flp) { break }

										j = j+1

										sz.bin0 = sz.bin.fol
										time.det0 = time.fol
										sz.det0 = sz.fol


									}# end of if(time.fol < time.cdet0){

							}#end ofmaxFUP==F

							if(maxFUP==T){  # in case there is no max number of follows up

									if(time.fol >= time.cdet0){  # if cdet happens before the followp, then

										mdet.out = 0
										time.dx.out = time.cdet0
										n.followup = 0

										break()


									}#end of if(time.fol >= time.cdet0)



									### (4) if cdet is after the followup time it's fine

									if(time.fol < time.cdet0){

										#### stop if the size at followpu is above the threshold

										if(time.fol >= maxFUP.years){  # if time to followup exceed 3 years then stop and make it clinical detection

										      mdet.out=0
										      time.dx.out = time.cdet0

										      break()

										}#if(sz.diam.fol >= n.maxFUP){


										#if(sz.diam.fol > thr.flp) { break }
										if(sz.diam.fol > thr.flp & indic.drop==F) { break }  # if no drop then finish


										### if not break ###

										j = j+1

										sz.bin0 = sz.bin.fol
										time.det0 = time.fol
										sz.det0 = sz.fol


									}# end of if(time.fol < time.cdet0){

							}#end ofmaxFUP==F


		         }#end of while(TRUE){


				n.followup = ifelse(is.na(n.followup)==T,  j,  n.followup)
				time.dx.out= ifelse(is.na(time.dx.out)==T, time.fol ,  time.dx.out)
	            mdet.out= ifelse(is.na(mdet.out)==T, mdet0 ,  mdet.out)  # stays as screen detect
	            sz.dx.out= ifelse(is.na(sz.dx.out)==T, sz.diam.fol ,  NA)
	            sz.bin.out = ifelse(is.na(sz.bin.out)==T, sz.bin.fol ,  NA)


				#out=c(n.followup=n.followup, time.dx.out=time.dx.out, mdet.out=mdet.out, sz.dx.out = sz.dx.out,sz.bin.out=sz.bin.out)
				# > 	            out
				#  n.followup time.dx.out    mdet.out   sz.dx.out  sz.bin.out
				#    3.000000    1.875000    1.000000    8.348113    3.000000


	            ### if sz.dx.out < 10mm, then add more dalay, 0.25 ###
	            time.dx.out.final = time.dx.out
				# delays.dx
				# > delays.dx
				# [1] 1.000 0.750 0.375 0.250 0.000	    (0,4),(4,6),(6,8),(8,10),(10~)

	            if(is.na(sz.dx.out)==F){

	                  if(sz.bin.out < 4) { # i.e. less than 10mm

	                         time.dx.out.final = time.dx.out + delays.dx[sz.bin.out+1]

	                  }#

	            }#end of

	            out=c(n.followup=n.followup, time.dx.out.final=time.dx.out.final, time.dx.out.pre=time.dx.out, mdet.out=mdet.out, sz.dx.out.pre = sz.dx.out,sz.bin.out=sz.bin.out)
	            out
				#   n.followup time.dx.out.final   time.dx.out.pre          mdet.out         sz.dx.out        sz.bin.out
				#   3.000000          2.125000          1.875000          1.000000          8.348113          3.000000



		}#end of my followup2

		    myFollowup <- function(x,dx.sz.ranges,delays.dx){   # given time of detection and size, this will give:

		            # (i) number of followup for diagnosis,
		            # (ii) diagnosis time
		            # (iii) mdet
					#x
					#        mdet     time.det      sz.det sz.det.bins   r
					#      1.0000      0.0000    108.3668      1.0000   0.3103965

					####### (i) Define variable #######

					time.det0 = as.vector(x["time.det"])
					sz.det0=as.vector(x["sz.det"])
					sz.bin0 = findInterval(sz.det0, diam2volume(dx.sz.ranges))
					mdet0 = as.vector(x["mdet"])
					r0=as.vector(x["r"])
					time.cdet0= as.vector(x["time.cdet"])


					time.det0
					#[1] 0
					sz.det0
					#[1] 108.3668
					sz.bin0
					#[1] 1   # this can take 0 1 2 3

					j=1

					mdet.out = time.dx.out = n.followup = sz.dx.out= sz.bin.out= NA

					while(TRUE){

							#### (1) Assign folloup time ###

							time.fol = time.det0 + delays.dx[sz.bin0+1] # assign 1 if 0, 2 if 1
							#[1] 0.75

							#### (2) check the size at the followup ####

							sz.fol = sz.det0 * exp((time.fol-time.det0)/r0)
							sz.fol
							#[1] 1214.134

							sz.diam.fol = volume2diam(sz.fol)
							sz.diam.fol
							#[1] 13.23598  (in mm)

							#sz.dx = sz.cdet * exp((time.dx - time.cdet)/r)
							sz.bin.fol = findInterval(sz.fol, diam2volume(dx.sz.ranges))
							sz.bin.fol
							#[1] 4

							### (3) check if cdet happens before the followpu

							if(time.fol >= time.cdet0){  # if cdet happens before the followp, then

								mdet.out = 0
								time.dx.out = time.cdet0
								n.followup = 0

								break()


							}#end of if(time.fol >= time.cdet0)


							### (4) if cdet is after the followup time it's fine

							if(time.fol < time.cdet0){

								#### stop if the size at followpu is above the threshold

								if(sz.diam.fol > thr.flp) { break }

								j = j+1

								sz.bin0 = sz.bin.fol
								time.det0 = time.fol
								sz.det0 = sz.fol


							}# end of if(time.fol < time.cdet0){

		         }#end of while(TRUE){


				n.followup = ifelse(is.na(n.followup)==T,  j,  n.followup)
				time.dx.out= ifelse(is.na(time.dx.out)==T, time.fol ,  time.dx.out)
	            mdet.out= ifelse(is.na(mdet.out)==T, mdet0 ,  mdet.out)  # stays as screen detect
	            sz.dx.out= ifelse(is.na(sz.dx.out)==T, sz.diam.fol ,  NA)
	            sz.bin.out = ifelse(is.na(sz.bin.out)==T, sz.bin.fol ,  NA)


				#out=c(n.followup=n.followup, time.dx.out=time.dx.out, mdet.out=mdet.out, sz.dx.out = sz.dx.out,sz.bin.out=sz.bin.out)
				# > 	            out
				#  n.followup time.dx.out    mdet.out   sz.dx.out  sz.bin.out
				#    3.000000    1.875000    1.000000    8.348113    3.000000


	            ### if sz.dx.out < 10mm, then add more dalay, 0.25 ###
	            time.dx.out.final = time.dx.out

	            if(is.na(sz.dx.out)==F){

	                  if(sz.bin.out < 4) { # i.e. less than 10mm

	                         time.dx.out.final = time.dx.out + delays.dx[sz.bin.out+1]

	                  }#

	            }#end of

	            out=c(n.followup=n.followup, time.dx.out.final=time.dx.out.final, time.dx.out.pre=time.dx.out, mdet.out=mdet.out, sz.dx.out.pre = sz.dx.out,sz.bin.out=sz.bin.out)
	            out
				#   n.followup time.dx.out.final   time.dx.out.pre          mdet.out         sz.dx.out        sz.bin.out
				#   3.000000          2.125000          1.875000          1.000000          8.348113          3.000000



		}#end of my followup


			myPlot.NLST.combine <- function(Main, inc.scr,  inc.cd,  mo.scr,  mo.cd){

								#                 1        2        3        4       5         6
								# O.inc.sc 266.0000 163.0000 178.0000 33.00000 8.00000 1.0000000
								# E.inc.sc 397.0021 112.3626 107.2903 18.61269 4.75531 0.9560716


						myPlot.NLST.tab.small <- function(tab,YLAB,Main,YLIM.inc,XLIM,lg.pos){

								##### (1) incident screen #######
								#                 1        2        3        4       5         6
								# O.inc.sc 266.0000 163.0000 178.0000 33.00000 8.00000 1.0000000
								# E.inc.sc 397.0021 112.3626 107.2903 18.61269 4.75531 0.9560716

								xx=as.numeric(colnames(tab))
								yy1=tab[1,]
								yy2=tab[2,]


										myplot=function(xx,yy,Main,YLAB,XLIM,YLIM,XLAB="Year since enrollment",x.axis=NULL){

											plot(xx,yy,pch=16,col="blue",xlab=XLAB,ylab=YLAB,xlim=XLIM,cex=2,axes=FALSE,ylim=YLIM)
											if(is.null(x.axis)==TRUE) axis(1)
											if(is.null(x.axis)==FALSE) axis(1,at=1:length(x.axis), labels=x.axis)

											ln0=c(seq(0,10000,by=100))
											ln=ln0[ln0 >= YLIM[1]  & ln0 <= YLIM[2]]
											axis(2,at=ln,labels=ln)
											points(xx,yy,col="blue",type="l")
											#text(xx,yy,paste(yy),pos=1,col="red",cex=2)
											#abline(h=ln,lty="dotted",col="red",xlim=XLIM)
											Main2=paste(YLAB,Main,sep=":")
											title(Main2,cex=2)


										}#end of

										#Main="Male+Female CT"
										#YLAB = "Number of LC cases (all modes)"
										#XLIM=c(1,6)
										#YLIM.inc = c(0,500)

								myplot(xx,yy1,Main,YLAB,XLIM,YLIM=YLIM.inc, XLAB="Year since enrollment",x.axis=NULL)
								points(xx,yy2,col="red",pch=16,cex=2)
								lines(xx,yy2,col="red")

								legend(x=lg.pos,legend=lg,fill=c("blue","red"),bg="white",cex=2)

					   }#end of myPlot.NLST.tab.small

						############ (1) Incidence ########################

						lg=c("NLST","Model")
						XLIM=c(1,6)
						lg.pos="topright"

						### total sum bar plot ####

						YLAB = "Number of LC cases  (all modes)"
						Main2=paste(YLAB,Main,sep=":")
						YLIM=c(0,1200)

						tab=rowSums(inc.scr + inc.cd) ; dim(tab)=c(2,1); row.names(tab)=c("NLST","Model")
						#           [,1]
						# NLST  1014.000
						# Model 1044.038

						barplot(tab,col=c("blue","red"),main=Main2,beside=TRUE,ylab=YLAB,ylim=YLIM,xlab=c("NLST            Model"))


						### screen detect ##
						tab=inc.scr
						YLAB = "Number of LC cases (screen detect)"
						YLIM.inc = c(0,300)
						myPlot.NLST.tab.small(tab,YLAB,Main,YLIM.inc,XLIM,lg.pos)

						### clinical detect ##
						tab=inc.cd
						YLAB = "Number of LC cases (clinical detect)"
						myPlot.NLST.tab.small(tab,YLAB,Main,YLIM.inc,XLIM,lg.pos)

						############ (2) Mortality ########################

						#Main="Male+Female CT"
						lg=c("NLST","Model")
						XLIM=c(1,6)
						lg.pos="topleft"

					   ### total sum bar plot ####

						YLAB = "Number of LC deaths  (all modes)"
						Main2=paste(YLAB,Main,sep=":")
						YLIM=c(0,1200)

						tab=rowSums(mo.scr + mo.cd) ; dim(tab)=c(2,1); row.names(tab)=c("NLST","Model")
						#           [,1]
						# NLST  1014.000
						# Model 1044.038

						barplot(tab,col=c("blue","red"),main=Main2,beside=TRUE,ylab=YLAB,ylim=YLIM,xlab=c("NLST            Model"))

						### screen detect ##
						tab=mo.scr
						YLAB = "Number of LC deaths (screen detect)"
						YLIM.inc = c(0,200)
						myPlot.NLST.tab.small(tab,YLAB,Main,YLIM.inc,XLIM,lg.pos)

						### clinical detect ##
						tab=mo.cd
						YLAB = "Number of LC deaths (clinical detect)"
						myPlot.NLST.tab.small(tab,YLAB,Main,YLIM.inc,XLIM,lg.pos)


						####### score ########

						#inc.scr,  inc.cd,  mo.scr,  mo.cd
						# 			> inc.scr
						#                 1        2        3        4       5         6
						# O.inc.sc 266.0000 163.0000 178.0000 33.00000 8.00000 1.0000000
						# E.inc.sc 397.0021 112.3626 107.2903 18.61269 4.75531 0.9560716

						O.inc.sc = inc.scr[1,]
						E.inc.sc = inc.scr[2,]

						O.inc.cd = inc.cd[1,]
						E.inc.cd = inc.cd[2,]

						O.mo.sc = mo.scr[1,]
						E.mo.sc = mo.scr[2,]

						O.mo.cd = mo.cd[1,]
						E.mo.cd = mo.cd[2,]


						eo.inc.sc =  abs(E.inc.sc - O.inc.sc) #; eo.inc.sc[eo.inc.sc > 100000]=NA
						n1=length(eo.inc.sc)

						eo.inc.cd =  abs(E.inc.cd - O.inc.cd) #;eo.inc.cd[eo.inc.cd > 100000]=NA
						#  eo.inc.sc
						#           1           2           3           4           5           6
						#  0.08380875  0.12761576  0.12691624  1.56579432 13.10664890         Inf
						n2=length(eo.inc.cd)

						eo.mo.sc =  abs(E.mo.sc-O.mo.sc)# ;eo.mo.sc[eo.mo.sc > 100000]=NA
						n3=length(eo.mo.sc)

						eo.mo.cd =  abs(E.mo.cd-O.mo.cd)# ;eo.mo.cd[eo.mo.cd > 100000]=NA
						n4=length(eo.mo.cd)

						NN = n1+n2+n3+n4#+n5+2

						TT= (n1/NN)*sum(eo.inc.sc,na.rm=TRUE) + (n2/NN)*sum(eo.inc.cd,na.rm=TRUE) + (n3/NN)*sum(eo.mo.sc,na.rm=TRUE) + (n4/NN)*sum(eo.mo.cd,na.rm=TRUE) #+ (n5/NN)*sum(eo.stage) + (1/NN)*ks.sc.stat + (1/NN)*ks.cd.stat
                        TT


			}#3nd of myplot.NLST.combine

#x=c("a","B","c")
    strCombine2=function(x,sep=" ") { # produce "a B c"
     n=length(x)
     y=paste(x[1])

     if(n==1) y=paste(x)

     if(n>1) {
     for (i in 2:n) { y= paste(y,x[i],sep=sep) }

     }
      y
     }
#strCombine2(c("aa","b","d"),"_")
     #strCombine2(c("aa","b","d"))




myTab.out <- function(INDIC, rowvar, colvar, Times, ages, colname=NULL,rowname=NULL){

  			# > ages
			# [1]   55   60   65   70 1000  ## define [55, 60), [60, 65), [65, 70), [70, +)

			#### make empty tray ####
			MAT = matrix(NA, nrow=length(Times), ncol=length(ages))

			if(is.null(colname)==F) colnames(MAT)=colname
			if(is.null(rowname)==F) row.names(MAT)=rowname

			ages2 = c(ages,Inf)
			#[1]   55   60   65   70 Inf

            for(i in 1:length(Times)){   # by row: time since entry
               for(j in 1:(length(ages))){

                     myindic = (INDIC &               # background indicator all cell should satistfy
                                 rowvar >= (i-1) & rowvar < i  &  # # diagnosis time should be: 0 <= dx < 1  : if time.dx = 0.99 counted as first column (T=1)
                                 colvar >= ages2[j] & colvar < ages2[j+1])  # for each age group

                     MAT[i,j] = sum(myindic)

               }#end of nAge
            }#end of

            MAT
			# > MAT
			#    55_60 60_65 65_70 70+
			# 1      0     3     1   3
			# 2      1     3     5   0
			# 3      0     0     3   0
			# 4      4     1     0   2
			# 5      3     2     2   1
			# 6      1     1     5   2
			# 7      9    12     5   0
			# 8      6    13     4   3
			# 9      0     0     0   0
			# 10     0     0     0   0

}#end of



		    myadjust.hist  <- function(x,sm){   # fix the small cell (fourth) and adjust the rest prportionally to be come 1

				# > x
				# [1] 0.42969451 0.23425190 0.08661038 0.24944321
				# > sm
				# [1] 0.15


				x2 = x
				x2[4]=sm
				# > x2
				# [1] 0.42969451 0.23425190 0.08661038 0.15000000
				# > sum(x2)
				# [1] 0.9005568

				frcs = seq(1,2,by=0.0005)

				for(j in 1:length(frcs)){

				     tm1 = x2[1:3]*frcs[j]
				     tm2 = c(tm1, sm)
				     sum(tm2)
				     out=c(frac=frcs[j],dist=tm2,sum=sum(tm2))
				     if(j==1) OUT=out
				     if(j>1) OUT=rbind(OUT,out)

				}#

				row.names(OUT)=1:nrow(OUT)
				# > OUT[1:5,]
				#    frac     dist1     dist2      dist3 dist4       sum
				# 1 1.000 0.4296945 0.2342519 0.08661038  0.15 0.9005568
				# 2 1.005 0.4318430 0.2354232 0.08704343  0.15 0.9043096
				# 3 1.010 0.4339915 0.2365944 0.08747648  0.15 0.9080624
				# 4 1.015 0.4361399 0.2377657 0.08790954  0.15 0.9118151
				# 5 1.020 0.4382884 0.2389369 0.08834259  0.15 0.9155679

				dif=abs(OUT[,"sum"]- 1)
				mini = min(dif)
				rw=which(dif==mini)
				ans0=OUT[rw,]
				# > ans0
				#       frac      dist1      dist2      dist3      dist4        sum
				# 1.13250000 0.48662903 0.26529028 0.09808626 0.15000000 1.00000556

				histo = ans0[2:5]
				#      dist1      dist2      dist3      dist4
				# 0.48662903 0.26529028 0.09808626 0.15000000

				## fine tune: to make exact zero by adjusting the firs ##

				histo[1] = 1-sum(histo[-1])
				# > sum(histo)
				# [1] 1

				names(histo)=c("AD","SQ","LC","SM")

				ans2=list(frac= as.vector(ans0["frac"]),  histo=histo)
				ans2
				# $frac
				# [1] 1.1325
				#
				# $histo
				#         AD         SQ         LC         SM
				# 0.48662347 0.26529028 0.09808626 0.15000000


		}# end of function




myDeathVol=function(pars1,pars2,pars3,pars4){

	volume2diam <- function(v)  {  # from volume to diameter

			 #  V = (4/3)  pi  radius^3
			 #  a=(4/3)*pi   # 4.18
			 #  radius =  (V/a)^(1/3)
			 #  diam = 2*((V/a)^(1/3))

			 a=(4/3)*pi   # 4.18
			 2*(v/a)^(1/3)


	}#end of

    xx=rbind(pars1,pars2,pars3,pars4)

    for(j in 1:nrow(xx)){

			PARS=xx[j,]

			K1=PARS[6]
			K2=PARS[7]

			L1=PARS[8]
			L2=PARS[9]

			mn.burden = as.vector( exp(L2)*gamma(1+(1/L1)) )
			sd02 = as.vector( sqrt(exp(L2)^2*gamma(1+(2/L1))-mn.burden^2) )
			mn.cure = as.vector(exp(K2)*gamma(1+(1/K1)));mn.cure

			max.vol = mn.cure + mn.burden
			#[1] 571919.1

			diam.max = as.vector(volume2diam(max.vol)/10)
			diam.max

			if(j==1) out=diam.max
			if(j>1) out=c(out,diam.max)

			out2=round(out,2)

    }#end of

    out2=round(out,2)
    out2

}#


        produce.summary=function(x,cholesky=T){   # given the parameter value, this produce the list of important value
                                                  # cholesky=T is cholesky parameters, if covariance parameters F
			# > x
			#   grate.mu   dcdet.mu  grate.sig  dcdet.sig     cor.gd         K1         K2
			#  0.3430000  2.0630000  1.3812654  0.8842637  0.2971111  0.2623699  7.6160000
			#         L1         L2   frac.obs  frac.cdet
			#  0.6669768 12.9060000  0.2433893  0.4442378

			c0 = 1 #mm^3  initial tumor volume

			######## (1) tumor volume doubling time & its 2 SD interval

			grate.mu = x[1]
			grate.sig =x[3]

			##### doubling time: log(2)/growth.rate   : if growth.rate is big, then dobuling time is shortened

			r = as.vector(1/exp(grate.mu))  # grate.mu is inverse growth rate, so make growth rate out of it

			#TVD = as.vector( exp(grate.mu)*log(2) )
			#TVD = as.vector(r*log(2))

			TVD = log(2)*r  # log(2)/exp(grate.mu)  # grate.mu is growth rate

            CI = as.vector(c(exp(grate.mu - 2*grate.sig)*log(2), exp(grate.mu + 2*grate.sig)*log(2)))

            TVD; CI
			# [1] 0.9767614
			# [1]  0.0616647 15.4717810

			cat(paste("\n [1] Tumor Dubling Time:                     ", round(TVD*365,2), " days [", paste(round(365*CI,2),collapse=" - ")  ,"]",sep=""))


			#[1] Tumor Dubling Time: 0.98 years [0.06 - 15.47]



			######## (2) detection size (diameter) for primary tumor ###

			dcdet.mu = x[2]
			#dcdet.sig
			diam.cdet.prime = as.vector(exp(dcdet.mu))
			vol.cdet = diam2volume(diam.cdet.prime*10)  # mm^3

			### then CI ###

			## convert from cholesky to sigma parameters
			xx=x[3:5]

			## if cholesky then convert
			if(cholesky==T) sigs=myConvert2cov(x=xx)
			if(cholesky==F) sigs =xx
			# > sigs
			# grate.sig dcdet.sig    cor.gd
			# 1.3812654 0.9328436 0.3185005
			# > xx
			# grate.sig dcdet.sig    cor.gd
			# 1.3812654 0.8842637 0.2971111
			dcdet.sig = sigs[2]

			CI2 = as.vector(c(exp(dcdet.mu - 2*dcdet.sig), exp(dcdet.mu + 2*dcdet.sig)))

			diam.cdet.prime; CI2

			cat(paste("\n [2] Tumor size for detection (primary):     ", round(diam.cdet.prime,2), " cm [", paste(round(CI2,2),collapse=" - ")  ,"]",sep=""))


			####### (3) Cure threshold (diameter) ####

			K1=x[6]  # k
			K2=x[7]  # lamda

			#mn.cure = as.vector(exp(K2)*gamma(1+(1/K1)));mn.cure
			rnd = c0+ rweibull(5000, K1, exp(K2))
			tt=summary(rnd)
			tt
			mn.cure = as.vector(tt["Median"]);mn.cure
			#> summary(rnd)
			#    Min.  1st Qu.   Median     Mean  3rd Qu.     Max.
			# 0.02582  3.67900  6.55500  7.59200 10.43000 32.67000

			sd0 = as.vector(sqrt(exp(K2)^2*gamma(1+(2/K1))-mn.cure^2))
			# > mn
			# [1] 36827.9    ----> volume  mm^3
			# > sd0
			# [1] 270951.2

			diam.cure = as.vector(volume2diam(mn.cure)/10)    # change to diameter and make it centimeter

			CI3 = as.vector(c( volume2diam(mn.cure-2*sd0)/10,   volume2diam(mn.cure+2*sd0)/10))
			CI3[is.na(CI3)]=0

			diam.cure;CI3
			# [1] 4.127871
			# [1]       NA 10.33933

		   cat(paste("\n [3] Tumor size for cure threshold:          ", round(diam.cure,2), " cm [", paste(round(CI3,2),collapse=" - ")  ,"]",sep=""))


			#### (4) maximum tumor size for death: volume for cure threshold + death burden ###

			L1=x[8]
			L2=x[9]

			mn.burden = as.vector( exp(L2)*gamma(1+(1/L1)) )
			sd02 = as.vector( sqrt(exp(L2)^2*gamma(1+(2/L1))-mn.burden^2) )
			#mn;vr

			max.vol = mn.cure + mn.burden
			#[1] 571919.1

			diam.max = as.vector(volume2diam(max.vol)/10)
			#[1] 10.29861

			## CI

			sd03 = sqrt(sd0^2 + sd02^2)   # sqrt(var(mn.cure) + var(mn.burden))

		    CI4 = as.vector(c( volume2diam(max.vol-2*sd03)/10,   volume2diam(max.vol+2*sd03)/10))
			CI4[is.na(CI4)]=0

			diam.max
			CI4
			# diam.max
			# [1] 10.29861
			# CI4
			# [1]       NA 17.09306

			cat(paste("\n [4] Tumor size for death:                   ", round(diam.max,2), " cm [", paste(round(CI4,2),collapse=" - ")  ,"]",sep=""))


			#### (5) Observable size of burden for advanced stage #######

			frac.obs = as.vector(x[10])

			vol.obs = mn.cure + frac.obs * mn.burden
			diam.obs = volume2diam(vol.obs)/10 ; diam.obs
			#[1] 6.833254


			sd4 = sqrt( sd0^2  + frac.obs^2*sd02^2)
		    CI5 = as.vector(c( volume2diam(vol.obs-2*sd4)/10,   volume2diam(vol.obs+2*sd4)/10))
			CI5[is.na(CI5)]=0

			diam.obs; CI5
			# [1] 6.833254
			# [1] NA 11.93701

			cat(paste("\n [5] Tumor size at observable burden:        ", round(diam.obs,2), " cm [", paste(round(CI5,2),collapse=" - ")  ,"]",sep=""))


			#### (6) tumor size detected due to metastasis ###

			frac.cdet.met = as.vector(x[11])

			vol.cdet.met = mn.cure + frac.cdet.met * mn.burden ; vol.cdet.met

			diam.cdet.met = volume2diam(vol.cdet.met)/10 ; diam.cdet.met
			#[1] 8.063682

			sd6 = sqrt( sd0^2  + frac.cdet.met^2*sd02^2)
		    CI6 = as.vector(c( volume2diam(vol.cdet.met-2*sd6)/10,   volume2diam(vol.cdet.met+2*sd6)/10))
			CI6[is.na(CI6)]=0

			diam.cdet.met; CI6
			# [1] 8.063682
			# [1] NA 13.55413

			cat(paste("\n [6] Tumor size for detection due to burden: ", round(diam.cdet.met,2), " cm [", paste(round(CI6,2),collapse=" - ")  ,"]",sep=""))



        #####(7) Censor variable ###########################
	        time.drop=NA
	        if(length(x)>11){

					G1=exp(x[12])
					G2=exp(x[13])
					time.drop0 = rweibull(5000, G1,G2)  # time drop since cdetection
					time.drop = median(time.drop0)
					time.drop
					#[1] 5.481912 (in years)
					CI7 = c(time.drop - 2*sd(time.drop0),   time.drop + 2*sd(time.drop0))
					CI7
					CI7[is.na(CI7)==T | CI7 <0]=0
					CI7

					cat(paste("\n [7] Time for drop-off since clinical detection: ", round(time.drop,2), " years [", paste(round(CI7,2),collapse=" - ")  ,"]",sep=""))
					cat(paste("\n"),sep="\n\n")

			}#3nd of

			#####(7) time variables ############################

			time.cure = r * log(mn.cure/c0) ; time.cure

			time.cdet = r * log(vol.cdet/c0) ; time.cdet
			#[1] 8.834801    ---> 8 years

			time.cdet.met = r * log(vol.cdet.met/c0) ; time.cdet.met
			#[1] 8.886683

			time.obs = r * log(vol.obs/c0) ; time.obs
			#[1] 8.5342

			time.death = r * log(max.vol/c0) ; time.death
			#[1] 9.407498


		    parnames=c( "grate.mu",  "dcdet.mu",  "grate.sig", "dcdet.sig", "cor.gd",    "K1",  "K2",
		                 "L1",        "L2",        "frac.obs",  "frac.cdet","G1","G2")
		    names(x)=parnames[1:length(x)]
		    dim(x)=c(length(x),1); row.names(x)=parnames[1:length(x)]
		    round(x,2)

        }#end of produce.summary



	### survival time
	produce.summary3=function(x,cholesky=T){   # given the parameter value, this produce the list of important value
										  # cholesky=T is cholesky parameters, if covariance parameters F
			# > x
			#   grate.mu   dcdet.mu  grate.sig  dcdet.sig     cor.gd         K1         K2
			#  0.3430000  2.0630000  1.3812654  0.8842637  0.2971111  0.2623699  7.6160000
			#         L1         L2   frac.obs  frac.cdet
			#  0.6669768 12.9060000  0.2433893  0.4442378

			c0 = 1 #mm^3  initial tumor volume

			######## (1) tumor volume doubling time & its 2 SD interval

			grate.mu = x[1]
			grate.sig =x[3]

			##### doubling time: log(2)/growth.rate   : if growth.rate is big, then dobuling time is shortened

			r = as.vector(1/exp(grate.mu))  # grate.mu is inverse growth rate, so make growth rate out of it

			#TVD = as.vector( exp(grate.mu)*log(2) )
			#TVD = as.vector(r*log(2))

			TVD = log(2)*r  # log(2)/exp(grate.mu)  # grate.mu is growth rate

            CI = as.vector(c(exp(grate.mu - 2*grate.sig)*log(2), exp(grate.mu + 2*grate.sig)*log(2)))

            TVD; CI
			# [1] 0.9767614
			# [1]  0.0616647 15.4717810

			cat(paste("\n [1] Tumor Doubling Time:                      ", round(TVD*365,2), " days",sep=""))


			#[1] Tumor Dubling Time: 0.98 years [0.06 - 15.47]



			######## (2) detection size (diameter) for primary tumor ###

			dcdet.mu = x[2]
			#dcdet.sig
			diam.cdet.prime = as.vector(exp(dcdet.mu))
			vol.cdet = diam2volume(diam.cdet.prime*10)  # mm^3

			### then CI ###

			## convert from cholesky to sigma parameters
			xx=x[3:5]

			## if cholesky then convert
			if(cholesky==T) sigs=myConvert2cov(x=xx)
			if(cholesky==F) sigs =xx
			# > sigs
			# grate.sig dcdet.sig    cor.gd
			# 1.3812654 0.9328436 0.3185005
			# > xx
			# grate.sig dcdet.sig    cor.gd
			# 1.3812654 0.8842637 0.2971111
			dcdet.sig = sigs[2]

			CI2 = as.vector(c(exp(dcdet.mu - 2*dcdet.sig), exp(dcdet.mu + 2*dcdet.sig)))

			diam.cdet.prime; CI2

			cat(paste("\n [2] Tumor size for detection (primary):      ", round(diam.cdet.prime,2), " cm",sep=""))


			####### (3) Cure threshold (diameter) ####

			K1=x[6]  # k
			K2=x[7]  # lamda

			#mn.cure = as.vector(exp(K2)*gamma(1+(1/K1)));mn.cure
			rnd = c0+ rweibull(5000, K1, exp(K2))
			tt=summary(rnd)
			tt
			mn.cure = as.vector(tt["Median"]);mn.cure
			#> summary(rnd)
			#    Min.  1st Qu.   Median     Mean  3rd Qu.     Max.
			# 0.02582  3.67900  6.55500  7.59200 10.43000 32.67000

			sd0 = as.vector(sqrt(exp(K2)^2*gamma(1+(2/K1))-mn.cure^2))
			# > mn
			# [1] 36827.9    ----> volume  mm^3
			# > sd0
			# [1] 270951.2

			diam.cure = as.vector(volume2diam(mn.cure)/10)    # change to diameter and make it centimeter

			CI3 = as.vector(c( volume2diam(mn.cure-2*sd0)/10,   volume2diam(mn.cure+2*sd0)/10))
			CI3[is.na(CI3)]=0

			diam.cure;CI3
			# [1] 4.127871
			# [1]       NA 10.33933

		   cat(paste("\n [3] Tumor size for cure threshold:           ", round(diam.cure,2), " cm",sep=""))


			#### (4) maximum tumor size for death: volume for cure threshold + death burden ###

			L1=x[8]
			L2=x[9]

			mn.burden = as.vector( exp(L2)*gamma(1+(1/L1)) )
			sd02 = as.vector( sqrt(exp(L2)^2*gamma(1+(2/L1))-mn.burden^2) )
			#mn;vr

			max.vol = mn.cure + mn.burden
			#[1] 571919.1

			diam.max = as.vector(volume2diam(max.vol)/10)
			#[1] 10.29861

			## CI

			sd03 = sqrt(sd0^2 + sd02^2)   # sqrt(var(mn.cure) + var(mn.burden))

		    CI4 = as.vector(c( volume2diam(max.vol-2*sd03)/10,   volume2diam(max.vol+2*sd03)/10))
			CI4[is.na(CI4)]=0

			diam.max
			CI4
			# diam.max
			# [1] 10.29861
			# CI4
			# [1]       NA 17.09306

			cat(paste("\n [4] Tumor size for death:                    ", round(diam.max,2), " cm",sep=""))




			#### (5) Observable size of burden for advanced stage #######

			frac.obs = as.vector(x[10])

			vol.obs = mn.cure + frac.obs * mn.burden
			diam.obs = volume2diam(vol.obs)/10 ; diam.obs
			#[1] 6.833254


			sd4 = sqrt( sd0^2  + frac.obs^2*sd02^2)
		    CI5 = as.vector(c( volume2diam(vol.obs-2*sd4)/10,   volume2diam(vol.obs+2*sd4)/10))
			CI5[is.na(CI5)]=0

			diam.obs; CI5
			# [1] 6.833254
			# [1] NA 11.93701

			cat(paste("\n [5] Tumor size at observable burden:         ", round(diam.obs,2), " cm",sep=""))


			#### (6) tumor size detected due to metastasis ###

			frac.cdet.met = as.vector(x[11])

			vol.cdet.met = mn.cure + frac.cdet.met * mn.burden ; vol.cdet.met

			diam.cdet.met = volume2diam(vol.cdet.met)/10 ; diam.cdet.met
			#[1] 8.063682

			sd6 = sqrt( sd0^2  + frac.cdet.met^2*sd02^2)
		    CI6 = as.vector(c( volume2diam(vol.cdet.met-2*sd6)/10,   volume2diam(vol.cdet.met+2*sd6)/10))
			CI6[is.na(CI6)]=0

			diam.cdet.met; CI6
			# [1] 8.063682
			# [1] NA 13.55413

			cat(paste("\n [6] Tumor size for detection due to burden:  ", round(diam.cdet.met,2), " cm",sep=""))



        #####(7) Censor variable ###########################
	        time.drop=NA
	        if(length(x)>11){

					G1=exp(x[12])
					G2=exp(x[13])
					time.drop0 = rweibull(5000, G1,G2)  # time drop since cdetection
					time.drop = median(time.drop0)
					time.drop
					#[1] 5.481912 (in years)
					CI7 = c(time.drop - 2*sd(time.drop0),   time.drop + 2*sd(time.drop0))
					CI7
					CI7[is.na(CI7)==T | CI7 <0]=0
					CI7

					cat(paste("\n [7] Time for drop-off since clinical detection: ", round(time.drop,2), " years",sep=""))
					cat(paste("\n"),sep="\n\n")

			}#3nd of

			#####(7) time variables ############################

			time.cure = r * log(mn.cure/c0) ; time.cure

			vol.cdet.prime =vol.cdet
			time.cdet.prime = r * log(vol.cdet.prime/c0) ; time.cdet.prime
			#[1] 8.834801    ---> 8 years

			time.cdet.met = r * log(vol.cdet.met/c0) ; time.cdet.met
			#[1] 8.886683

			time.obs = r * log(vol.obs/c0) ; time.obs
			#[1] 8.5342

			time.death = r * log(max.vol/c0) ; time.death
			#[1] 9.407498

		   #cat(paste("\n [7] Time for onset of metastasis          : ", round(time.cure,2), " years",sep=""))

			cat(paste("\n [7] Time for onset of metastasis:            ", round(time.cure,2), " years",sep=""))
			cat(paste("\n [8] Time for observable metastasis:          ", round(time.obs,2), " years",sep=""))
			cat(paste("\n [9] Time for detection due to metastasis:    ", round(time.cdet.met,2), " years",sep=""))
			cat(paste("\n [10] Time for detection due to primary tumor:", round(time.cdet.prime,2), " years",sep=""))
			cat(paste("\n [11] Time for clinical detection:            ", round(min(time.cdet.prime,time.cdet.met),2), " years",sep=""))
			cat(paste("\n [12] Time for death:                         ", round(time.death,2), " years",sep=""))
			cat("\n")






		    parnames=c( "grate.mu",  "dcdet.mu",  "grate.sig", "dcdet.sig", "cor.gd",    "K1",  "K2",
		                 "L1",        "L2",        "frac.obs",  "frac.cdet","G1","G2")
		    names(x)=parnames[1:length(x)]
		    dim(x)=c(length(x),1); row.names(x)=parnames[1:length(x)]
		    round(x,2)

        }#end of produce.summary3

          myConvert2cov <- function(x){   # from cholesky parameter to covariance parameter

				# > names(x)=c("sig1","sig2","r")
				# > x
				# sig1 sig2    r
				# 1.38 0.88 0.29

				#Sigma = matrix( c( x[1]^2,         x[1]*x[2]*x[3],
				#                  x[1]*x[2]*x[3],  x[2]^2 ), byrow=T,ncol=2)
				#Sigma
				# > Sigma
				#          [,1]     [,2]
				# [1,] 1.904400 0.352176
				# [2,] 0.352176 0.774400


				# L= a1  0   t(L)= a1  a3    L*t(L) = a1^2   a1a3
				#    a3  a2         0  a2             a1a3   a2^2+a3^2
		       #Sigma=matrix(c(grate.sig^2, grate.sig*dcdet.sig*cor.gd, grate.sig*dcdet.sig*cor.gd, dcdet.sig^2), 2, 2)

				#Sigma = matrix(c( grate.sig^2,      grate.sig*dcdet.sigcor.gd,             s1^2    s1s2r
				#                  grate.sig*dcdet.sigcor.gd, dcdet.sig^2), byrow=T,ncol=2) s1s2r   s2^2

				## equation:  solve in terms of s1, s2, and r
				##   a1 = s1
				##   a1a3 = s1s2r = a1s2r  -->   a3 = s2r
				##   a2^2 + a3^2 = s2^2  -->  a2^2 = s2^2 - a3^2 = s2^2 -s2^2*r^2 = s2^2(1-r^2)

				## a1= s1;   a2 = sqrt(s2^2(1-r^2));   a3=s2*r

				# (a1, a2, a3) # is new set

				### convert to cholesky to cov ###
				## s1 = a1;   s2 = sqrt(a2^2 + a3^2);   r = a3/s2  = a3/sqrt(a2^2+a3^2)

				xx = c(x[1], sqrt(x[2]^2 + x[3]^2), x[3]/sqrt(x[2]^2 + x[3]^2))
				xx




				### convert to cov to cholesky ###

				#xx = c(x[1],  sqrt( (x[2]^2)*(1-x[3]^2)),  x[2]*x[3])
				#xx
				# > sigPar.new
				# grate.sig dcdet.sig dcdet.sig
				# 1.3812654 0.8443329 0.2627246

				doThis=F
				if(doThis==T){

						sigNew=matrix( c(x[1]^2,  x[1]*x[3],
										 x[1]*x[3],  x[2]^2 + x[3]^2), byrow=T,ncol=2)

						sig=matrix( c(xx[1]^2,  xx[1]*xx[2]*xx[3],
									  xx[1]*xx[2]*xx[3],  xx[2]^2 ), byrow=T,ncol=2)

						sigNew
						sig

				}#end of
				# > sigNew
				#           [,1]      [,2]
				# [1,] 1.9078940 0.3628923
				# [2,] 0.3628923 0.7819222
				# > sig
				#           [,1]      [,2]
				# [1,] 1.9078940 0.3628923
				# [2,] 0.3628923 0.7819222

				#names(xx)=c("sig1","sig2","r")
				xx


           }#end of



           myBuild.cholesky <- function(xx){  ## this build covariance from cholesky parameter

				# L= a1  0   t(L)= a1  a3    L*t(L) = a1^2   a1a3
				#    a3  a2         0  a2             a1a3   a2^2+a3^2


 						sigNew=matrix( c(xx[1]^2,  xx[1]*xx[3],
										 xx[1]*xx[3],  xx[2]^2 + xx[3]^2), byrow=T,ncol=2)
                  sigNew

           }#end this build cho



                     myBuild.var <- function(x){

            						sig=matrix( c(x[1]^2,  x[1]*x[2]*x[3],
									  x[1]*x[2]*x[3],  x[2]^2 ), byrow=T,ncol=2)

									  sig


           }#end of




	volume2diam <- function(v)  {  # from volume to diameter

		 #  V = (4/3)  pi  radius^3
		 #  a=(4/3)*pi   # 4.18
		 #  radius =  (V/a)^(1/3)
		 #  diam = 2*((V/a)^(1/3))

		 a=(4/3)*pi   # 4.18
		 2*(v/a)^(1/3)


	}#end of


	diam2volume=function(diam)   (4/3)*pi*(diam/2)^3   # from diameter to volume



	makeInput.US <- function(age.population, scenario.age.begin.lim, scenario.age.end.lim,scenario.PY.lim,scenario.YSQ.lim,scenario.freq.scr,scenario.freq.scr2,summary.names.col){

			#library(foreach)

			#First scenario is NLST: A 55-57-30-15

			scenarios.std.scr.schedule=data.frame(c())
			scenarios.std.scr.schedule=rbind(scenarios.std.scr.schedule,c(seq(10,12,1),rep(NA,41-length(c(seq(10,12,1))))))  #for all screening scenarios, starting with NLST
			scenarios.min.pack.yr=data.frame(c(30))         # data frame for all PY scenarios, starting with NLST
			scenarios.max.yr.since.quit=data.frame(c(15))   #data frame for all Year since quit scenarios, starting with NLST
			scenarios.scr.freq=c("A")
			#labels=c()


			scenarios.std.scr.schedule = scenarios.min.pack.yr = scenarios.max.yr.since.quit = scenarios.scr.freq = NULL

			for(t in 1:length(scenario.freq.scr2)){
			  for(i in 1:length(scenario.age.begin.lim)){
				for(j in 1:length(scenario.age.end.lim)) {
				  for(k in 1:length(scenario.PY.lim)) {
					for(l in 1:length(scenario.YSQ.lim)) {

					  scenarios.std.scr.schedule=rbind(scenarios.std.scr.schedule, c(seq(scenario.age.begin.lim[i],scenario.age.end.lim[j],scenario.freq.scr[t]),
					  								rep(NA,41-length(c(seq(scenario.age.begin.lim[i],scenario.age.end.lim[j],scenario.freq.scr[t]))))))
					  scenarios.min.pack.yr =rbind(scenarios.min.pack.yr,scenario.PY.lim[k])
					  scenarios.max.yr.since.quit = rbind(scenarios.max.yr.since.quit,scenario.YSQ.lim[l])
					  scenarios.scr.freq=rbind(scenarios.scr.freq, scenario.freq.scr2[t])
					  #          new_label=as.vector(paste(scr_freq,scenario.age.begin.lim[i]+age.population,"-",scenario.age.end.lim[j]+age.population,"-",scenario.PY.lim[k],"-",scenario.YSQ.lim[l]))
			#          labels=rbind(labels,new_label)
					}
				  }
				}
			  }
			}


			## Create an output dataframe with columns showing results per scenario run (rows)
			# Add new result variables by addending summary.names.col and dataframe calculations
			#  at end of "for (counter.std.scr.schedule in 1:dim(scenarios.std.scr.schedule)[1])" loop
			# 			summary.names.col = c("SCENARIO",
			# 								  "AGE.START",
			# 								  "AGE.STOP",
			# 								  "AGE.INTERVAL",
			# 								  "PY_LIMIT",
			# 								  "YSQ_LIMIT",
			# 								  "N.ENTRY.ALL",
			# 								  "N.CASE",
			# 								  "PERCENT.EVER.SCREENED",
			# 								  "N.CASE.STD.DX",
			# 								  "TOTAL.N.CT.SCR",
			# 								  "TOTAL.N.CT.SCR.FUP",
			# 								  "PERCENT.EARLY.STAGE",
			# 								  "TOTAL.LC.DEATHS",
			# 								  "TOTAL.NOSCREEN.LC.DEATHS",
			# 								  "TOTAL.NOSCREEN.LC.INCIDENCE",
			# 								  "DEATHS.AVOIDED",
			# 								  "ALL.DEATHS.CASE",
			# 								  "ALL.DEATHS.CASE.NONCASE",
			# 								  "N.CASE.STD.DX.BY.90",
			# 								  "PERCENT.EARLY.STAGE.BY.90",
			# 								  "TOTAL.LC.DEATHS.BY.90",
			# 								  "TOTAL.NOSCREEN.LC.DEATHS.BY.90",
			# 								  "TOTAL.NOSCREEN.LC.INCIDENCE.BY.90",
			# 								  "DEATHS.AVOIDED.BY.90",
			# 								  "ALL.DEATHS.CASE.BY.90",
			# 								  "ALL.DEATHS.CASE.NONCASE.BY.90"
			# 								 )


			####### making strategy names ######

			summary.names.row = NULL

			  for (j in 1:nrow(scenarios.std.scr.schedule)) {

					  std.scr.schedule0 = scenarios.std.scr.schedule[j,] #[1]  0  1  2  3  4  5  6  7  8  9 10 11 12 13 14...
					  std.scr.schedule = std.scr.schedule0[!is.na(std.scr.schedule0)] #[1] 15 18 21 24 27 30 33 36 39
					  PY_limit = scenarios.min.pack.yr[j,]   #[1] 10
					  YSQ_limit = scenarios.max.yr.since.quit[j,] #[1] 10
					  Frequency= scenarios.scr.freq[j,] #[1] "A"
					  summary.names.row = c(summary.names.row, paste( Frequency,"-",min(std.scr.schedule)+age.population, "-", max(std.scr.schedule)+age.population, "-", PY_limit,"-", YSQ_limit,sep=""))
			  		  summary.names.row
			  		 #summary.names.row = c(summary.names.row, paste( Frequency,"-",min(std.scr.schedule)+age.population, "-", max(std.scr.schedule)+age.population, "-", PY_limit,"-", YSQ_limit,sep=""))

			  			#summary.names.row = c(summary.names.row, paste( Frequency,min(std.scr.schedule)+age.population, "-", max(std.scr.schedule)+age.population, "-", PY_limit,"-", YSQ_limit))

			  }# end of j loop

			summary.names.row[1:10]
			#  [1] "A 45 - 75 - 10 - 10" "A 45 - 75 - 10 - 15" "A 45 - 75 - 10 - 20" "A 45 - 75 - 10 - 25" "A 45 - 75 - 20 - 10"
			#  [6] "A 45 - 75 - 20 - 15" "A 45 - 75 - 20 - 20" "A 45 - 75 - 20 - 25" "A 45 - 75 - 30 - 10" "A 45 - 75 - 30 - 15"

			scenarios.summary = matrix(rep(NA, dim(scenarios.std.scr.schedule)[1] * length(summary.names.col)), nrow=dim(scenarios.std.scr.schedule)[1], ncol=length(summary.names.col))
			scenarios.summary = as.data.frame(scenarios.summary)

			names(scenarios.summary) = summary.names.col
			rownames(scenarios.summary) = summary.names.row
			# > dim(scenarios.summary)
			# [1] 576  27
			# > scenarios.summary[1:5,1:5]
			#                     SCENARIO AGE.START AGE.STOP AGE.INTERVAL PY_LIMIT
			# A 45 - 75 - 10 - 10       NA        NA       NA           NA       NA
			# A 45 - 75 - 10 - 15       NA        NA       NA           NA       NA
			# A 45 - 75 - 10 - 20       NA        NA       NA           NA       NA
			# A 45 - 75 - 10 - 25       NA        NA       NA           NA       NA
			# A 45 - 75 - 20 - 10       NA        NA       NA           NA       NA

			ans=list(scenarios.summary=scenarios.summary, scenarios.std.scr.schedule=scenarios.std.scr.schedule,
			          scenarios.min.pack.yr=scenarios.min.pack.yr, scenarios.max.yr.since.quit=scenarios.max.yr.since.quit,
			             scenarios.max.yr.since.quit=scenarios.max.yr.since.quit)

	        ans


   }#end of


   count.screen<-function(a) { length(which(!is.na(a)))  }





		 mySmoking.elig.small <- function(x, PY_limit, YSQ_limit){

				# > x
				# age.init.all age.cess.all        PY.45        PY.46        PY.47        PY.48        PY.49        PY.50        PY.51        PY.52        PY.53
				#     12.00000     89.00000     24.38210     25.07626     25.75765     26.42626     27.08209     27.72514     28.35541     28.97291     29.57763
				#        PY.54        PY.55        PY.56        PY.57        PY.58        PY.59        PY.60        PY.61        PY.62        PY.63        PY.64
				#     30.16957     30.74874     31.31513     31.86874     32.40957     32.93762     33.45290     33.95540     34.44512     34.92207     35.38624
				#        PY.65        PY.66        PY.67        PY.68        PY.69        PY.70        PY.71        PY.72        PY.73        PY.74        PY.75
				#     35.83763     36.27624     36.70207     37.11513     37.51541     37.90291     38.27764     38.63959     38.98876     39.32515     39.64877
				#        PY.76        PY.77        PY.78        PY.79        PY.80        PY.81        PY.82        PY.83        PY.84        PY.85        PY.86
				#     39.97238     40.29600     40.61961     40.94323     41.26684     41.59046     41.91407     42.23769     42.56131     42.88492     43.20854
				#        PY.87        PY.88        PY.89        PY.90        PY.91        PY.92        PY.93        PY.94        PY.95        PY.96        PY.97
				#     43.53215     43.85577     44.17938     44.17938     44.17938     44.17938     44.17938     44.17938     44.17938     44.17938     44.17938
				#        PY.98        PY.99       PY.100       YSQ.45       YSQ.46       YSQ.47       YSQ.48       YSQ.49       YSQ.50       YSQ.51       YSQ.52
				#     44.17938     44.17938     44.17938           NA           NA           NA           NA           NA           NA           NA           NA
				#       YSQ.53       YSQ.54       YSQ.55       YSQ.56       YSQ.57       YSQ.58       YSQ.59       YSQ.60       YSQ.61       YSQ.62       YSQ.63
				#           NA           NA           NA           NA           NA           NA           NA           NA           NA           NA           NA
				#       YSQ.64       YSQ.65       YSQ.66       YSQ.67       YSQ.68       YSQ.69       YSQ.70       YSQ.71       YSQ.72       YSQ.73       YSQ.74
				#           NA           NA           NA           NA           NA           NA           NA           NA           NA           NA           NA
				#       YSQ.75       YSQ.76       YSQ.77       YSQ.78       YSQ.79       YSQ.80       YSQ.81       YSQ.82       YSQ.83       YSQ.84       YSQ.85
				#           NA           NA           NA           NA           NA           NA           NA           NA           NA           NA           NA
				#       YSQ.86       YSQ.87       YSQ.88       YSQ.89       YSQ.90       YSQ.91       YSQ.92       YSQ.93       YSQ.94       YSQ.95       YSQ.96
				#           NA           NA           NA           NA      1.00000      2.00000      3.00000      4.00000      5.00000      6.00000      7.00000
				#       YSQ.97       YSQ.98       YSQ.99      YSQ.100      SCRT.15      SCRT.16      SCRT.17      SCRT.18      SCRT.19      SCRT.20      SCRT.21
				#      8.00000      9.00000     10.00000     11.00000     15.00000     16.00000     17.00000     18.00000     19.00000     20.00000     21.00000
				#      SCRT.22      SCRT.23      SCRT.24      SCRT.25      SCRT.26      SCRT.27      SCRT.28      SCRT.29      SCRT.30      SCRT.31      SCRT.32
				#     22.00000     23.00000     24.00000     25.00000     26.00000     27.00000     28.00000     29.00000     30.00000     31.00000     32.00000
				#      SCRT.33      SCRT.34      SCRT.35      SCRT.36      SCRT.37      SCRT.38      SCRT.39      SCRT.40
				#     33.00000     34.00000     35.00000     36.00000     37.00000     38.00000     39.00000     40.00000
				# >
				# 		  time.std.scr[i,j]=ifelse( age.init.all[i]==-999 & age.cess.all[i]==-999, NA ,   #if never smoker--> don't screen
				# 						ifelse( age.init.all[i]!=-999 & age.cess.all[i]==-999 & PY[i,time.std.scr[i,j]+1]< PY_limit, NA,   # if current smoker, check only PY criteria, don't check years since quit
				# 						ifelse( age.init.all[i]!=-999 & age.cess.all[i]!=-999 & is.na(YSQ[i,time.std.scr[i,j]+1])& PY[i,time.std.scr[i,j]+1]< PY_limit, NA,  #if former smoker in general, but hasn't quit at the time of screen, sheck only PY
				# 						ifelse( (age.init.all[i]!=-999 & age.cess.all[i]!=-999 & !is.na( YSQ[i,time.std.scr[i,j]+1])) & (YSQ[i,time.std.scr[i,j]+1] > YSQ_limit | PY[i,time.std.scr[i,j]+1]< PY_limit), NA,time.std.scr[i,j]))))   #if former smoker, check YSQ (if quit before screen time) and PY

            ag.init.all = x[1]
            ag.cess.all = x[2]
            py = x[grep("PY",names(x))]
            ysq = x[grep("YSQ",names(x))]
            py = x[grep("PY",names(x))]
            tsc =x[grep("SCRT",names(x))]	   # time.std.scr

			# > tsc[1:5]
			# SCRT.15 SCRT.16 SCRT.17 SCRT.18 SCRT.19
			#      15      16      17      18      19
			# > py[1:5]
			#    PY.45    PY.46    PY.47    PY.48    PY.49
			# 24.38210 25.07626 25.75765 26.42626 27.08209
			# > ysq[1:5]
			# YSQ.45 YSQ.46 YSQ.47 YSQ.48 YSQ.49
			#     NA     NA     NA     NA     NA

	       ans=NULL
	       for(j in 1:length(tsc)){

			   tmp=ifelse( ag.init.all==-999 & ag.cess.all==-999, NA ,   #if never smoker--> don't screen
							ifelse( ag.init.all!=-999 & ag.cess.all==-999 & py[tsc[j]+1]< PY_limit, NA,   # if current smoker, check only PY criteria, don't check years since quit
								ifelse( ag.init.all!=-999 & ag.cess.all!=-999 & is.na(ysq[tsc[j]+1]) & py[tsc[j]+1]< PY_limit, NA,  #if former smoker in general, but hasn't quit at the time of screen, sheck only PY
								ifelse( (ag.init.all!=-999 & ag.cess.all!=-999 & !is.na( ysq[tsc[j]+1])) & ((ysq[tsc[j]+1] > YSQ_limit | py[tsc[j]+1]< PY_limit)), NA,tsc[j]))))   #if former smoker, check YSQ (if quit before screen time) and PY
								#ifelse( (ag.init.all!=-999 & ag.cess.all!=-999 & !is.na( ysq[tsc[j]+1])) & (ysq[tsc[j]+1] > YSQ_limit | py[tsc[j]+1]< PY_limit), NA,tsc[j]))))   #if former smoker, check YSQ (if quit before screen time) and PY
	           ans=c(ans,tmp)
	           #names(ans)=names(tsc)

		   }
		   names(ans)=names(tsc)
		   ans






 }#end of
	 mySmoking.elig.small2 <- function(x, PY_limit, YSQ_limit){

				# > x
				# age.init.all age.cess.all        PY.45        PY.46        PY.47        PY.48        PY.49        PY.50        PY.51        PY.52        PY.53
				#     12.00000     89.00000     24.38210     25.07626     25.75765     26.42626     27.08209     27.72514     28.35541     28.97291     29.57763
				#        PY.54        PY.55        PY.56        PY.57        PY.58        PY.59        PY.60        PY.61        PY.62        PY.63        PY.64
				#     30.16957     30.74874     31.31513     31.86874     32.40957     32.93762     33.45290     33.95540     34.44512     34.92207     35.38624
				#        PY.65        PY.66        PY.67        PY.68        PY.69        PY.70        PY.71        PY.72        PY.73        PY.74        PY.75
				#     35.83763     36.27624     36.70207     37.11513     37.51541     37.90291     38.27764     38.63959     38.98876     39.32515     39.64877
				#        PY.76        PY.77        PY.78        PY.79        PY.80        PY.81        PY.82        PY.83        PY.84        PY.85        PY.86
				#     39.97238     40.29600     40.61961     40.94323     41.26684     41.59046     41.91407     42.23769     42.56131     42.88492     43.20854
				#        PY.87        PY.88        PY.89        PY.90        PY.91        PY.92        PY.93        PY.94        PY.95        PY.96        PY.97
				#     43.53215     43.85577     44.17938     44.17938     44.17938     44.17938     44.17938     44.17938     44.17938     44.17938     44.17938
				#        PY.98        PY.99       PY.100       YSQ.45       YSQ.46       YSQ.47       YSQ.48       YSQ.49       YSQ.50       YSQ.51       YSQ.52
				#     44.17938     44.17938     44.17938           NA           NA           NA           NA           NA           NA           NA           NA
				#       YSQ.53       YSQ.54       YSQ.55       YSQ.56       YSQ.57       YSQ.58       YSQ.59       YSQ.60       YSQ.61       YSQ.62       YSQ.63
				#           NA           NA           NA           NA           NA           NA           NA           NA           NA           NA           NA
				#       YSQ.64       YSQ.65       YSQ.66       YSQ.67       YSQ.68       YSQ.69       YSQ.70       YSQ.71       YSQ.72       YSQ.73       YSQ.74
				#           NA           NA           NA           NA           NA           NA           NA           NA           NA           NA           NA
				#       YSQ.75       YSQ.76       YSQ.77       YSQ.78       YSQ.79       YSQ.80       YSQ.81       YSQ.82       YSQ.83       YSQ.84       YSQ.85
				#           NA           NA           NA           NA           NA           NA           NA           NA           NA           NA           NA
				#       YSQ.86       YSQ.87       YSQ.88       YSQ.89       YSQ.90       YSQ.91       YSQ.92       YSQ.93       YSQ.94       YSQ.95       YSQ.96
				#           NA           NA           NA           NA      1.00000      2.00000      3.00000      4.00000      5.00000      6.00000      7.00000
				#       YSQ.97       YSQ.98       YSQ.99      YSQ.100      SCRT.15      SCRT.16      SCRT.17      SCRT.18      SCRT.19      SCRT.20      SCRT.21
				#      8.00000      9.00000     10.00000     11.00000     15.00000     16.00000     17.00000     18.00000     19.00000     20.00000     21.00000
				#      SCRT.22      SCRT.23      SCRT.24      SCRT.25      SCRT.26      SCRT.27      SCRT.28      SCRT.29      SCRT.30      SCRT.31      SCRT.32
				#     22.00000     23.00000     24.00000     25.00000     26.00000     27.00000     28.00000     29.00000     30.00000     31.00000     32.00000
				#      SCRT.33      SCRT.34      SCRT.35      SCRT.36      SCRT.37      SCRT.38      SCRT.39      SCRT.40
				#     33.00000     34.00000     35.00000     36.00000     37.00000     38.00000     39.00000     40.00000
				# >
				# 		  time.std.scr[i,j]=ifelse( age.init.all[i]==-999 & age.cess.all[i]==-999, NA ,   #if never smoker--> don't screen
				# 						ifelse( age.init.all[i]!=-999 & age.cess.all[i]==-999 & PY[i,time.std.scr[i,j]+1]< PY_limit, NA,   # if current smoker, check only PY criteria, don't check years since quit
				# 						ifelse( age.init.all[i]!=-999 & age.cess.all[i]!=-999 & is.na(YSQ[i,time.std.scr[i,j]+1])& PY[i,time.std.scr[i,j]+1]< PY_limit, NA,  #if former smoker in general, but hasn't quit at the time of screen, sheck only PY
				# 						ifelse( (age.init.all[i]!=-999 & age.cess.all[i]!=-999 & !is.na( YSQ[i,time.std.scr[i,j]+1])) & (YSQ[i,time.std.scr[i,j]+1] > YSQ_limit | PY[i,time.std.scr[i,j]+1]< PY_limit), NA,time.std.scr[i,j]))))   #if former smoker, check YSQ (if quit before screen time) and PY

            ag.init.all = x[1]
            ag.cess.all = x[2]
            py = x[grep("PY",names(x))]
            ysq = x[grep("YSQ",names(x))]
            py = x[grep("PY",names(x))]
            tsc =x[grep("SCRT",names(x))]	   # time.std.scr

			# > tsc[1:5]
			# SCRT.15 SCRT.16 SCRT.17 SCRT.18 SCRT.19
			#      15      16      17      18      19
			# > py[1:5]
			#    PY.45    PY.46    PY.47    PY.48    PY.49
			# 24.38210 25.07626 25.75765 26.42626 27.08209
			# > ysq[1:5]
			# YSQ.45 YSQ.46 YSQ.47 YSQ.48 YSQ.49
			#     NA     NA     NA     NA     NA

			#x2=c(ag.init.all,ag.cess.all,py,ysq,py,tsc[j])
				mySmall=function(tsc0, ag.init.all,ag.cess.all,py,ysq,PY_limit, YSQ_limit){

					# 	> tsc0
					# [1] 15
					#


				   tmp=ifelse( ag.init.all==-999 & ag.cess.all==-999, NA ,   #if never smoker--> don't screen
							ifelse( ag.init.all!=-999 & ag.cess.all==-999 & py[tsc0 +1]< PY_limit, NA,   # if current smoker, check only PY criteria, don't check years since quit
								ifelse( ag.init.all!=-999 & ag.cess.all!=-999 & is.na(ysq[tsc0+1]) & py[tsc0+1]< PY_limit, NA,  #if former smoker in general, but hasn't quit at the time of screen, sheck only PY
								ifelse( (ag.init.all!=-999 & ag.cess.all!=-999 & !is.na( ysq[tsc0+1])) & ((ysq[tsc0+1] > YSQ_limit | py[tsc0+1]< PY_limit)), NA,tsc0))))   #if former smoker, check YSQ (if quit before screen time) and PY
								#ifelse( (ag.init.all!=-999 & ag.cess.all!=-999 & !is.na( ysq[tsc[j]+1])) & (ysq[tsc[j]+1] > YSQ_limit | py[tsc[j]+1]< PY_limit), NA,tsc[j]))))   #if former smoker, check YSQ (if quit before screen time) and PY
	            as.vector(tmp)
	           #names(ans)=names(tsc)


			}#


			dim(tsc)=c(length(tsc),1)
			# > tsc[1:5,]
			# [1] 15 16 17 18 19

			#tsc0=tsc[1,]

			ans=apply(tsc,1, mySmall, ag.init.all=ag.init.all,ag.cess.all=ag.cess.all,py=py,ysq=ysq,PY_limit=PY_limit, YSQ_limit=YSQ_limit)

			names(ans)=names(tsc)

			ans


	    }#	mySmoking.elig.small






# x=mydat[,"TOTAL.N.CT.SCR"]
# y=mydat[,"DEATHS.AVOIDED"]/max(mydat[,"DEATHS.AVOIDED"])
# labs=as.character(mydat[,"SCENARIO"])

makeFrontier<- function(x, y, labs){

		mat=cbind(CT=x,Death.avoided=y)#
		row.names(mat)=labs
		# > mat[1:5,]
		#                   CT Death.avoided
		# A-55-75-20-10 386495     0.5598592
		# A-55-75-20-15 396850     0.5727700
		# A-55-75-20-20 406124     0.5845070
		# A-55-75-20-25 413627     0.5880282
		# A-55-75-30-10 265227     0.4741784

		frontf=chull(x, y)   #finds convex hull
		frontf
		#[1] 157 189 191 187 183 184 180 132  36  20   4

		doThis=F
		if(doThis==T){

		    plot(x,y,col="pink")
		    points(x[frontf], y[frontf],pch="*",col="blue")

		}#

		# > frontf[1:10]
		#  [1] 120 104 541 542 557 558 574 381 382 378
		# > length(frontf)
		# [1] 18

		### take the subset of matrix
		sc.efront = mat[frontf,]
		sc.efront
# > sc.efront
#                   CT Death.avoided
# A-45-80-10-25 831213      3.022814
# A-45-85-10-25 861349      2.651376
# noscreen           0      0.000000
# T-50-70-40-10  47133      4.170732
# T-50-70-30-10  85046      4.702128
# T-50-70-30-20  97297      4.760000
# A-45-70-10-10 529757      4.868687
# A-45-70-10-20 656766      4.828829
# A-45-70-10-25 705260      4.570248

sc.efront=sc.efront[order(sc.efront[,"CT"]),]
sc.efront
		#                   CT Death.avoided
		# B-60-75-40-10  52164           219
		# B-60-85-40-10  62261           283
		# B-60-85-40-20  78136           330
		# B-60-85-30-20 108608           399
		# B-60-85-20-20 151359           472
		# B-60-85-20-25 170839           501
		# B-60-85-10-25 210980           553
		# B-55-85-10-25 284704           616
		# A-55-75-10-25 468670           622
		# A-55-80-10-25 519463           717
		# A-55-85-10-25 549599           789

		index0 = 1:length(frontf)
		# [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18


		#### test x value ###

		test=c(-1, diff(sc.efront[,"CT"]))
		#  [1]      -1  -81066 -833391     535    4668     640    7647   27492    1093   41683   64211   66300    9511
		# [14]  229328   10668  178045  163750  168216

		#index = 1:dim(scenarios.efrontier.90)[1]  # [1]  1  2  3  4  5  6  7  8  9 10 11

		#test = c(-1, diff(scenarios.efrontier.90[, "TOTAL.N.CT.SCR"]))
		# > test
		#  [1]     -1.00  51471.60  38440.43  33156.05  65623.90  43177.01  58247.26  76861.71 346361.67 158766.34  38948.87



		index = index0[test > 0]
		# > index
		#  [1]  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18

		### redefube subset ###

		sc.efront2 = sc.efront[c(index[1]-1,index), ]
		sc.efront2
		#             x         y
		#  [1,]   51484 0.1819249
		#  [2,]   52019 0.1854460
		#  [3,]   56687 0.2124413
		#  [4,]   57327 0.2159624
		#  [5,]   64974 0.2558685
		#  [6,]   92466 0.3521127
		#  [7,]   93559 0.3556338
		#  [8,]  135242 0.4565728
		#  [9,]  199453 0.5645540
		# [10,]  265753 0.6279343
		# [11,]  275264 0.6361502
		# [12,]  504592 0.8145540
		# [13,]  515260 0.8227700
		# [14,]  693305 0.9178404
		# [15,]  857055 0.9730047
		# [16,] 1025271 1.0000000
		# >

		###### check y value ###

		index = 1:nrow(sc.efront2)
		test = c(1, diff(sc.efront2[,"Death.avoided"]))
		#  [1] 1.000000000 0.003521127 0.026995305 0.003521127 0.039906103 0.096244131 0.003521127 0.100938967 0.107981221
		# [10] 0.063380282 0.008215962 0.178403756 0.008215962 0.095070423 0.055164319 0.026995305

		index2 = index[test>0]


		### redefube subset2 ###

		sc.efront3 = sc.efront2[index2, ]
		# > sc.efront3
		#                    CT Death.avoided
		# T-60-75-40-10   51484     0.1819249
		# T-60-75-40-15   52019     0.1854460
		# T-60-78-40-10   56687     0.2124413
		# T-60-78-40-15   57327     0.2159624
		# T-60-84-40-15   64974     0.2558685
		# B-60-84-40-10   92466     0.3521127
		# B-60-84-40-15   93559     0.3556338
		# B-60-84-30-15  135242     0.4565728
		# B-60-84-20-20  199453     0.5645540
		# B-60-84-10-20  265753     0.6279343
		# B-60-84-10-25  275264     0.6361502
		# A-55-85-20-20  504592     0.8145540
		# A-55-85-20-25  515260     0.8227700
		# A-55-85-10-25  693305     0.9178404
		# A-50-85-10-25  857055     0.9730047
		# A-45-85-10-25 1025271     1.0000000


		#### one more time ##
		index = 1:nrow(sc.efront3)
		test = c(1, diff(sc.efront3[,"Death.avoided"]))
		#  [1] 1.000000000 0.003521127 0.026995305 0.003521127 0.039906103 0.096244131 0.003521127 0.100938967 0.107981221
		# [10] 0.063380282 0.008215962 0.178403756 0.008215962 0.095070423 0.055164319 0.026995305

		index3 = index[test>0]


		### redefube subset2 ###

		sc.efront4 = sc.efront3[index3, ]
		# > sc.efront3
		#                    CT Death.avoided
		# T-60-75-40-10   51484     0.1819249
		# T-60-75-40-15   52019     0.1854460
		# T-60-78-40-10   56687     0.2124413
		# T-60-78-40-15   57327     0.2159624
		# T-60-84-40-15   64974     0.2558685
		# B-60-84-40-10   92466     0.3521127
		# B-60-84-40-15   93559     0.3556338
		# B-60-84-30-15  135242     0.4565728
		# B-60-84-20-20  199453     0.5645540
		# B-60-84-10-20  265753     0.6279343
		# B-60-84-10-25  275264     0.6361502
		# A-55-85-20-20  504592     0.8145540
		# A-55-85-20-25  515260     0.8227700
		# A-55-85-10-25  693305     0.9178404
		# A-50-85-10-25  857055     0.9730047
		# A-45-85-10-25 1025271     1.0000000

		#### test one more time: is there anything higher y than the given y in the interval? if so, exclude it since it becomes V shape curve then ###

		yy=sc.efront4[,"Death.avoided"]
		xx=sc.efront4[,"CT"]

		for(j in 1:length(yy)){

				if(j==1) ans= F
				if(j > 1){

					tm.y=yy[j]
					tm.x1=xx[j-1]
					tm.x2=xx[j]

					## are there any y in the given x interval has a higher value than the given y
					ind = (x > tm.x1) & (x < tm.x2) & (y > tm.y)
					ans0 = sum(ind)>0
					ans=c(ans,ans0)
				}
		}#

		ans


		sc.efront5=sc.efront4[!ans,]
		sc.efront5

		doThis=F
		if(doThis==T){

		    plot(x,y,col="pink")
		    points(sc.efront5[,"CT"], sc.efront5[,"Death.avoided"],pch="*",col="blue")

		}#


		#### evaluate the last step for any possible v shape ###
		yy=sc.efront5[,"Death.avoided"]
		xx=sc.efront5[,"CT"]


		##### FInd the segment that goes throgh (x1,y1) and (x2, y2)
			#  y = a + bx ;   b = (x2-x1)/(y2-y1); a = y1 - b*x1

		#b = (y2-y1)/(x2-x1)
		#a = y1 - b*x1

		#####  See if given y value is above the segment or not #######

		#above = yy >= a + b*xx	 #[1] FASE


		for(j in 1:(length(yy))){

				if(j==1) ans = ind = F

				if(j > 1 & j < length(yy)){

					## current y

					y.current = yy[j]
					x.current = xx[j]

					## identify left point
					y1=yy[j-1]
					x1=xx[j-1]

					### identify right point

					y2=yy[j+1]
					x2=xx[j+1]

					##### FInd the segment that goes throgh (x1,y1) and (x2, y2)
						#  y = a + bx ;   b = (x2-x1)/(y2-y1); a = y1 - b*x1

					b = (y2-y1)/(x2-x1)
					a = y1 - b*x1

					#####  See if given y value is BELOW the segment (then V shape!) #######

					ind = y.current < (a + b*x.current)	 #[1] FASE
					ans=c(ans,ind)

				}#if(j > 1 & j < length(yy)){

				if(j==length(yy))  {ind = F  ; ans=c(ans,ind) }




		}#for(j in 1:(length(yy))){

		ans



		sc.efront6=sc.efront5[!ans,]
		sc.efront6


		#print(sc.efront6)

		scs = row.names(sc.efront6)
		# > scs
		#  [1] "T-60-75-40-10" "T-60-75-40-15" "T-60-78-40-10" "T-60-78-40-15" "T-60-84-40-15" "B-60-84-40-10"
		#  [7] "B-60-84-40-15" "B-60-84-30-15" "B-60-84-20-20" "B-60-84-10-20" "B-60-84-10-25" "A-55-85-20-20"
		# [13] "A-55-85-20-25" "A-55-85-10-25" "A-50-85-10-25" "A-45-85-10-25"

		INDIC = row.names(mat) %in% scs
		# > INDIC[1:5]
		# [1] FALSE FALSE FALSE FALSE FALSE
		# > length(INDIC)
		# [1] 576
		sum(INDIC)

		#print(scs)

		#print(paste("Total number of frontiers = ",sum(INDIC),sep=""))

		list(indic=INDIC,SCN=scs,tb=sc.efront6)

}#


### 3/18/2014: fix prob of going down? ##

makeFrontier2<- function(x, y, labs){

		mat=cbind(CT=x,Death.avoided=y)#
		row.names(mat)=labs
		# > mat[1:5,]
		#                   CT Death.avoided
		# A-55-75-20-10 386495     0.5598592
		# A-55-75-20-15 396850     0.5727700
		# A-55-75-20-20 406124     0.5845070
		# A-55-75-20-25 413627     0.5880282
		# A-55-75-30-10 265227     0.4741784



		frontf=chull(x, y)   #finds convex hull
		frontf

		# > frontf[1:10]
		#  [1] 120 104 541 542 557 558 574 381 382 378
		# > length(frontf)
		# [1] 18

		### take the subset of matrix
		sc.efront = mat[frontf,]
		sc.efront
# > sc.efront
#                   CT Death.avoided
# A-45-80-10-25 831213      3.022814
# A-45-85-10-25 861349      2.651376
# noscreen           0      0.000000
# T-50-70-40-10  47133      4.170732
# T-50-70-30-10  85046      4.702128
# T-50-70-30-20  97297      4.760000
# A-45-70-10-10 529757      4.868687
# A-45-70-10-20 656766      4.828829
# A-45-70-10-25 705260      4.570248

sc.efront=sc.efront[order(sc.efront[,"CT"]),]



		index0 = 1:length(frontf)
		# [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18

		#### test x value ###

		test=c(-1, diff(sc.efront[,"CT"]))
		#  [1]      -1  -81066 -833391     535    4668     640    7647   27492    1093   41683   64211   66300    9511
		# [14]  229328   10668  178045  163750  168216

		#index = 1:dim(scenarios.efrontier.90)[1]  # [1]  1  2  3  4  5  6  7  8  9 10 11

		#test = c(-1, diff(scenarios.efrontier.90[, "TOTAL.N.CT.SCR"]))
		# > test
		#  [1]     -1.00  51471.60  38440.43  33156.05  65623.90  43177.01  58247.26  76861.71 346361.67 158766.34  38948.87



		index = index0[test > 0]
		# > index
		#  [1]  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18

		### redefube subset ###

		sc.efront2 = sc.efront[c(index[1]-1,index), ]
		sc.efront2
		#             x         y
		#  [1,]   51484 0.1819249
		#  [2,]   52019 0.1854460
		#  [3,]   56687 0.2124413
		#  [4,]   57327 0.2159624
		#  [5,]   64974 0.2558685
		#  [6,]   92466 0.3521127
		#  [7,]   93559 0.3556338
		#  [8,]  135242 0.4565728
		#  [9,]  199453 0.5645540
		# [10,]  265753 0.6279343
		# [11,]  275264 0.6361502
		# [12,]  504592 0.8145540
		# [13,]  515260 0.8227700
		# [14,]  693305 0.9178404
		# [15,]  857055 0.9730047
		# [16,] 1025271 1.0000000
		# >

		###### check y value ###

		index = 1:nrow(sc.efront2)
		test = c(1, diff(sc.efront2[,"Death.avoided"]))
		#  [1] 1.000000000 0.003521127 0.026995305 0.003521127 0.039906103 0.096244131 0.003521127 0.100938967 0.107981221
		# [10] 0.063380282 0.008215962 0.178403756 0.008215962 0.095070423 0.055164319 0.026995305

		index2 = index[test>0]


		### redefube subset2 ###

		sc.efront3 = sc.efront2[index2, ]
		# > sc.efront3
		#                    CT Death.avoided
		# T-60-75-40-10   51484     0.1819249
		# T-60-75-40-15   52019     0.1854460
		# T-60-78-40-10   56687     0.2124413
		# T-60-78-40-15   57327     0.2159624
		# T-60-84-40-15   64974     0.2558685
		# B-60-84-40-10   92466     0.3521127
		# B-60-84-40-15   93559     0.3556338
		# B-60-84-30-15  135242     0.4565728
		# B-60-84-20-20  199453     0.5645540
		# B-60-84-10-20  265753     0.6279343
		# B-60-84-10-25  275264     0.6361502
		# A-55-85-20-20  504592     0.8145540
		# A-55-85-20-25  515260     0.8227700
		# A-55-85-10-25  693305     0.9178404
		# A-50-85-10-25  857055     0.9730047
		# A-45-85-10-25 1025271     1.0000000

		print(sc.efront3)

		scs = row.names(sc.efront3)
		# > scs
		#  [1] "T-60-75-40-10" "T-60-75-40-15" "T-60-78-40-10" "T-60-78-40-15" "T-60-84-40-15" "B-60-84-40-10"
		#  [7] "B-60-84-40-15" "B-60-84-30-15" "B-60-84-20-20" "B-60-84-10-20" "B-60-84-10-25" "A-55-85-20-20"
		# [13] "A-55-85-20-25" "A-55-85-10-25" "A-50-85-10-25" "A-45-85-10-25"

		INDIC = row.names(mat) %in% scs
		# > INDIC[1:5]
		# [1] FALSE FALSE FALSE FALSE FALSE
		# > length(INDIC)
		# [1] 576
		sum(INDIC)

		#print(scs)

		print(paste("Total number of frontiers = ",sum(INDIC),sep=""))

		list(indic=INDIC,SCN=scs,tb=sc.efront3)

}#





            #x=letters[1:10]
            # #set.seed(123);y=sample(x,10,replace=F)

            #x=c("a","b","c")
            #y=c("d","a","e","b") ### "c" doesn't exist in y

            match.order=function(x,y){   ### wait! y doesn't need to be exact same length!  it can be length(x) <= length(y)

                ####### this match y to x ----> gives the row numbers of y so that y[ans] will be exactly the same as x
                ####### they should be unique

                ans=NULL

                #> cbind(x,y[1:length(x)])
                #      x   y
                #       x   y
                # [1,] "a" "c"
                # [2,] "b" "h"
                # [3,] "c" "d"
                # [4,] "d" "g"
                # [5,] "e" "f"
                # [6,] "f" "a"
                # [7,] "g" "j"
                # [8,] "h" "i"
                # [9,] "i" "b"
                #[10,] "j" "e"


                x2=x
                dim(x2)=c(length(x),1)

                #xx=x[1]
                mymatch=function(xx,y){

                   tm=(1:length(y))[y %in% xx]
                   if(length(tm)==0) tm=NA  # doesn't exist then NA
                   tm

                }# end of mymatch
                mymatch(x[1],y)

                #ans0=sapply(x2,mymatch,y=y)

                ans0=apply(x2,1,mymatch,y=y)

                ans=as.vector(ans0)

                ans2 = list(ans.na= ans,ans.no.na=ans[!is.na(ans)])
                ans2
                # [1]  6  9  1  3 10  5  4  2  8  7

                #> cbind(x,y[ans])
                #      x
                # [1,] "a" "a"
                # [2,] "b" "b"
                # [3,] "c" "c"
                # [4,] "d" "d"
                # [5,] "e" "e"
                # [6,] "f" "f"
                # [7,] "g" "g"
                # [8,] "h" "h"
                # [9,] "i" "i"
                #[10,] "j" "j"

                ######## example ####################
                #
                #x=c("a","b","c")
                #y=c("d","a","e","b")
                #
                #ans=match.order(x,y)  ### wait! y doesn't need to be exact same length!  it can be length(x) <= length(y)

                #> ans[[1]]
                #[1] 2 4 NA  --> "c" doens't exist in y
                #ans[[2]]
                #[1] 2 4
                #> x
                #[1] "a" "b" "c"
                #> y[ans[[2]]]
                #[1] "a" "b"
                #

            }# end of mmatch order


#x=c("a","b","c")
#y=c("d","a","e","b")
#
#ans=match.order(x,y)  ### wait! y doesn't need to be exact same length!  it can be length(x) <= length(y)

#> ans[[1]]
#[1] 2 4 NA  --> "c" doens't exist in y
#ans[[2]]
#[1] 2 4
#> x
#[1] "a" "b" "c"
#> y[ans[[2]]]
#[1] "a" "b"
#


### i[8/21/2013] it has more variables related to compliance
myCombineGender2.comp <- function(mydat1,mydat2, mycolnames,N=100000){


 		#mycolnames
		#  [1] "scenario"                    "perfect.compliance"          "vary.compliance"             "p1.adj"
		#  [5] "yr"                          "p2.adj"                      "averageComplianceProb100"    "n.total"
		#  [9] "n.entry.all"                 "n.case"                      "CTscreens90"                 "CTexams90"
		# [13] "PercentScreened100"          "LCcases.noscreen90"          "LCdeaths.noscreen90"         "LCcases90"
		# [17] "LCcases.sdet90"              "LCcasesOver90"               "LCdeaths90"                  "PctEarlyStage90"
		# [21] "Deaths.avoided90"            "LifeYearsSaved90"            "Alldeaths90"                 "Alldeaths.case.noncase90"
		# [25] "LCdeathsSurgery_overDiag90"  "LCdeathsSurgery_sdet90"      "AlldeathsSurgery90"          "AlldeathsSurgery_noscreen90"

		#mycolnames = c("scenario", "n.total","n.entry.all", "CTscreens90_abs","CTexams90_abs","LCcases90_abs","LCdeaths90_abs")

		#mydat1=read.csv(file1)
		#mydat2=read.csv(file2)

		#excludeCols=c(1,3:7, 48:51)

		# > mydat1[,1:10]
		#         X NUM      scenario age.start age.stop age.interval py ysq n.total n.entry.all
		# 1           1 A-45-75-10-10        45       75            1 10  10   1e+05       94010
		# 2 output2   2 A-45-75-10-15        45       75            1 10  15   1e+05       94010

		#### Female ######

		mydat1b=mydat1[,mycolnames]
		#mydat1b=mydat1[,-excludeCols]
		#        scenario n.total n.entry.all CTscreens90_abs CTexams90_abs LCcases90_abs LCdeaths90_abs
		# 1 A-45-75-10-10   1e+05       94010          539196        627542          6019           3871
		# 2 A-45-75-10-15   1e+05       94010          611862        700221          6029           3810

		# colnames(mydat1b)
		#  [1] "scenario"                    "n.total"                     "n.entry.all"                 "n.case"
		#  [5] "PercentScreened100"          "LCcases90"                   "LCcases.sdet90"              "LCcasesOver90"
		#  [9] "LCdeaths90"                  "Deaths.avoided90"            "LifeYearsSaved90"            "Alldeaths90"
		# [13] "Alldeaths.case.noncase90"    "LCdeathsSurgery_overDiag90"  "LCdeathsSurgery_sdet90"      "AlldeathsSurgery90"
		# [17] "AlldeathsSurgery_noscreen90"

		##### make # of people ever screened instead of Percent ###

		#### this is # of poeple in 100000 so normalized alreayd
		EverScreened100=100000*(as.numeric(mydat1b[,"PercentScreened100"])/100)
		# > EverScreened100[1:5]
		# [1] 31400 33480 34480 34630 24620

		#EverScreened100=mydat1b[,"n.entry.all"]*(mydat1b[,"PercentScreened100"]/100)
		# > EverScreened100[1:10]
		#  [1] 29519.14 31474.55 32414.65 32555.66 23145.26 23709.32 23822.13 23822.13 15991.10 16056.91
		# > mydat1b[,"n.entry.all"][1:5]
		# [1] 94010 94010 94010 94010 94010
		# > (mydat1b[,"PercentScreened100"]/100)[1:5]
		# [1] 0.3140 0.3348 0.3448 0.3463 0.2462

		### this should have been normalized ##
		#mf1.tm = (100000/mydat1b[,"n.entry.all"])[1]
		#mf1.tm
		#[1] 1.063717


		mydat1b=cbind(mydat1b, EverScreened100=EverScreened100, EverScreened90=EverScreened100)


		#  [1] "scenario"                         "n.total"                          "n.entry.all"
		#  [4] "n.case"                           "LCcases.noscreen100"              "LCdeaths.noscreen100"
		#  [7] "PercentScreened100"               "CTscreens100"                     "CTexams100"
		# [10] "PctEarlyStage100"                 "LCcases100"                       "LCcases.sdet100"
		# [13] "LCcases.sdet.eff100"              "LCdeaths100"                      "LCcasesOver100"
		# [16] "Deaths.avoided100"                "LifeYearsSaved100"                "MortReduct100"
		# [19] "AlldeathsCase100"                 "AlldeathsNoncases100"             "Ratio.case.scrdet.per.CT100"
		# [22] "Rario.deaths.avoided_case.scr100" "LCcases.noscreen90"               "LCdeaths.noscreen90"
		# [25] "CTscreens90"                      "CTexams90"                        "PctEarlyStage90"
		# [28] "LCcases90"                        "LCcases.sdet90"                   "LCcasesOver90"
		# [31] "LCdeaths90"                       "Deaths.avoided90"                 "LifeYearsSaved90"
		# [34] "MortReduct90"                     "Alldeaths90"                      "Alldeaths.case.noncase90"
		# [37] "prop.cdet.90"                     "LCdeathsSurgery_overDiag90"       "LCdeathsSurgery_sdet90"
		# [40] "AlldeathsSurgery90"               "AlldeathsSurgery_noscreen90"      "CTscreens90_abs"
		# [43] "CTexams90_abs"                    "LCcases90_abs"                    "LCdeaths90_abs"

		######## Male ########

		mydat2b=mydat2[,mycolnames]

		#mydat2b=mydat2[,-excludeCols]#[,mycolnames]
		#        scenario n.total n.entry.all CTscreens90_abs CTexams90_abs LCcases90_abs LCdeaths90_abs
		# 1 A-45-75-10-10   1e+05       89067          663656        747324          4899           3606
		# 2 A-45-75-10-15   1e+05       89067          755017        838687          4906           3581

		EverScreened100.male =100000*(as.numeric(mydat2b[,"PercentScreened100"])/100)
		# > EverScreened100[1:5]
		# [1] 31400 33480 34480 34630 24620

		#EverScreened100=mydat1b[,"n.entry.all"]*(mydat1b[,"PercentScreened100"]/100)
		# > EverScreened100[1:10]
		#  [1] 29519.14 31474.55 32414.65 32555.66 23145.26 23709.32 23822.13 23822.13 15991.10 16056.91
		# > mydat1b[,"n.entry.all"][1:5]
		# [1] 94010 94010 94010 94010 94010
		# > (mydat1b[,"PercentScreened100"]/100)[1:5]
		# [1] 0.3140 0.3348 0.3448 0.3463 0.2462

		### this should have been normalized ##
		#mf1.tm = (100000/mydat1b[,"n.entry.all"])[1]
		#mf1.tm
		#[1] 1.063717


		mydat2b=cbind(mydat2b, EverScreened100=EverScreened100.male, EverScreened90=EverScreened100.male)
		# > mydat2b[1:5,]
		#        scenario n.total n.entry.all n.case PercentScreened100 LCcases90 LCcases.sdet90 LCcasesOver90 LCdeaths90 Deaths.avoided90 LifeYearsSaved90
		# 1 A-45-75-10-10   1e+05       89067  16191              42.78      5500           2131           125       4049              429             6106
		# 2 A-45-75-10-15   1e+05       89067  16191              46.44      5508           2270           132       4021              457             6567
		# 3 A-45-75-10-20   1e+05       89067  16191              48.20      5516           2409           140       3993              485             6916
		# 4 A-45-75-10-25   1e+05       89067  16191              48.52      5522           2501           146       3978              500             7192
		# 5 A-45-75-20-10   1e+05       89067  16191              34.38      5495           2012           119       4072              405             5667
		#   Alldeaths90 Alldeaths.case.noncase90 LCdeathsSurgery_overDiag90 LCdeathsSurgery_sdet90 AlldeathsSurgery90 AlldeathsSurgery_noscreen90
		# 1       16824                    84033                          0                     15                 30                          30
		# 2       16817                    84026                          0                     16                 30                          30
		# 3       16812                    84021                          0                     18                 30                          30
		# 4       16808                    84017                          0                     18                 30                          30
		# 5       16831                    84040                          0                     13                 30                          30
		#   EverScreened100 EverScreened90
		# 1           42780          42780
		# 2           46440          46440
		# 3           48200          48200
		# 4           48520          48520
		# 5           34380          34380


		sc1=as.character(mydat1b[,"scenario"])
		sc2=as.character(mydat2b[,"scenario"])
		# > sc1
		# [1] "A-45-75-10-10" "A-45-75-10-15"
		# > sc2
		# [1] "A-45-75-10-10" "A-45-75-10-15"


		#### just average for compliance prob ###
			# 		> mydat1b[1:5,1:10]
			#                 scenario          perfect.compliance vary.compliance p1.adj        yr   p2.adj averageComplianceProb100 n.total
			# A.55.75.30.15   "A.55.75.30.15"   "FALSE"            "TRUE"          "0.426580793" "20" "0.01" "0.355179127"            "1.00E+05"
			# A.55.75.30.15.1 "A.55.75.30.15.1" "FALSE"            "TRUE"          "0.6"         "20" "0.08" "0.46297378"             "1.00E+05"
			# A.55.75.30.15.2 "A.55.75.30.15.2" "FALSE"            "TRUE"          "0.7"         "20" "0.1"  "0.520669072"            "1.00E+05"
			# A.55.75.30.15.3 "A.55.75.30.15.3" "FALSE"            "TRUE"          "0.8"         "20" "0.14" "0.609776424"            "1.00E+05"
			# A.55.75.30.15.4 "A.55.75.30.15.4" "FALSE"            "TRUE"          "0.9"         "20" "0.18" "0.718861904"            "1.00E+05"
			#                 n.entry.all n.case
			# A.55.75.30.15   "94020"     "16203"
			# A.55.75.30.15.1 "94020"     "16203"
			# A.55.75.30.15.2 "94020"     "16203"
			# A.55.75.30.15.3 "94020"     "16203"
			# A.55.75.30.15.4 "94020"     "16203"

		 myComp.cols = 1:7
		 mydat1c=mydat1b[,myComp.cols]
		 mydat2c=mydat2b[,myComp.cols]

		# > mydat1c
		#                 scenario          perfect.compliance vary.compliance p1.adj        yr   p2.adj averageComplianceProb100
		# A.55.75.30.15   "A.55.75.30.15"   "FALSE"            "TRUE"          "0.426580793" "20" "0.01" "0.355179127"
		# A.55.75.30.15.1 "A.55.75.30.15.1" "FALSE"            "TRUE"          "0.6"         "20" "0.08" "0.46297378"
		# A.55.75.30.15.2 "A.55.75.30.15.2" "FALSE"            "TRUE"          "0.7"         "20" "0.1"  "0.520669072"
		# A.55.75.30.15.3 "A.55.75.30.15.3" "FALSE"            "TRUE"          "0.8"         "20" "0.14" "0.609776424"
		# A.55.75.30.15.4 "A.55.75.30.15.4" "FALSE"            "TRUE"          "0.9"         "20" "0.18" "0.718861904"
		# A.55.75.30.15.5 "A.55.75.30.15.5" "TRUE"             "TRUE"          NA            NA   NA     "1"
		# noscreen        "noscreen"        NA                 NA              NA            NA   NA     NA
		# A.55.80.30.15   "A.55.80.30.15"   "FALSE"            "TRUE"          "0.426580793" "20" "0.01" "0.289842723"
		# A.55.80.30.15.1 "A.55.80.30.15.1" "FALSE"            "TRUE"          "0.6"         "20" "0.08" "0.391379226"
		# A.55.80.30.15.2 "A.55.80.30.15.2" "FALSE"            "TRUE"          "0.7"         "20" "0.1"  "0.453132811"
		# A.55.80.30.15.3 "A.55.80.30.15.3" "FALSE"            "TRUE"          "0.8"         "20" "0.14" "0.558485457"
		# A.55.80.30.15.4 "A.55.80.30.15.4" "FALSE"            "TRUE"          "0.9"         "20" "0.18" "0.699468508"
		# A.55.80.30.15.5 "A.55.80.30.15.5" "TRUE"             "TRUE"          NA            NA   NA     "1"
		# noscreen.1      "noscreen.1"      NA                 NA              NA            NA   NA     NA
		# > mydat2c
		#                 scenario          perfect.compliance vary.compliance p1.adj        yr   p2.adj averageComplianceProb100
		# A.55.75.30.15   "A.55.75.30.15"   "FALSE"            "TRUE"          "0.426580793" "20" "0.01" "0.367334575"
		# A.55.75.30.15.1 "A.55.75.30.15.1" "FALSE"            "TRUE"          "0.6"         "20" "0.08" "0.472511837"
		# A.55.75.30.15.2 "A.55.75.30.15.2" "FALSE"            "TRUE"          "0.7"         "20" "0.1"  "0.528843839"
		# A.55.75.30.15.3 "A.55.75.30.15.3" "FALSE"            "TRUE"          "0.8"         "20" "0.14" "0.616353779"
		# A.55.75.30.15.4 "A.55.75.30.15.4" "FALSE"            "TRUE"          "0.9"         "20" "0.18" "0.723457356"
		# A.55.75.30.15.5 "A.55.75.30.15.5" "TRUE"             "TRUE"          NA            NA   NA     "1"
		# noscreen        "noscreen"        NA                 NA              NA            NA   NA     NA
		# A.55.80.30.15   "A.55.80.30.15"   "FALSE"            "TRUE"          "0.426580793" "20" "0.01" "0.297725845"
		# A.55.80.30.15.1 "A.55.80.30.15.1" "FALSE"            "TRUE"          "0.6"         "20" "0.08" "0.396828751"
		# A.55.80.30.15.2 "A.55.80.30.15.2" "FALSE"            "TRUE"          "0.7"         "20" "0.1"  "0.457514715"
		# A.55.80.30.15.3 "A.55.80.30.15.3" "FALSE"            "TRUE"          "0.8"         "20" "0.14" "0.561424967"
		# A.55.80.30.15.4 "A.55.80.30.15.4" "FALSE"            "TRUE"          "0.9"         "20" "0.18" "0.701632644"
		# A.55.80.30.15.5 "A.55.80.30.15.5" "TRUE"             "TRUE"          NA            NA   NA     "1"
		# noscreen.1      "noscreen.1"      NA                 NA              NA            NA   NA     NA


		x1=as.numeric(mydat1c[,"averageComplianceProb100"])
		x2=as.numeric(mydat2c[,"averageComplianceProb100"])

		av=NULL
		for(j in 1:length(x1)){  av=c(av,mean(c(x1[j],x2[j]),na.rm=T)) }

		# > av
		#  [1] 0.3612569 0.4677428 0.5247565 0.6130651 0.7211596 1.0000000       NaN 0.2937843 0.3941040 0.4553238 0.5599552 0.7005506 1.0000000
		# [14]       NaN


		comp = cbind(mydat1c[,2:6],averageComplianceProb=av)
		#                 perfect.compliance vary.compliance p1.adj        yr   p2.adj averageComplianceProb
		# A.55.75.30.15   "FALSE"            "TRUE"          "0.426580793" "20" "0.01" "0.361256851"
		# A.55.75.30.15.1 "FALSE"            "TRUE"          "0.6"         "20" "0.08" "0.4677428085"
		# A.55.75.30.15.2 "FALSE"            "TRUE"          "0.7"         "20" "0.1"  "0.5247564555"
		# A.55.75.30.15.3 "FALSE"            "TRUE"          "0.8"         "20" "0.14" "0.6130651015"
		# A.55.75.30.15.4 "FALSE"            "TRUE"          "0.9"         "20" "0.18" "0.72115963"
		# A.55.75.30.15.5 "TRUE"             "TRUE"          NA            NA   NA     "1"
		# noscreen        NA                 NA              NA            NA   NA     "NaN"
		# A.55.80.30.15   "FALSE"            "TRUE"          "0.426580793" "20" "0.01" "0.293784284"
		# A.55.80.30.15.1 "FALSE"            "TRUE"          "0.6"         "20" "0.08" "0.3941039885"
		# A.55.80.30.15.2 "FALSE"            "TRUE"          "0.7"         "20" "0.1"  "0.455323763"
		# A.55.80.30.15.3 "FALSE"            "TRUE"          "0.8"         "20" "0.14" "0.559955212"
		# A.55.80.30.15.4 "FALSE"            "TRUE"          "0.9"         "20" "0.18" "0.700550576"
		# A.55.80.30.15.5 "TRUE"             "TRUE"          NA            NA   NA     "1"
		# noscreen.1      NA                 NA              NA            NA   NA     "NaN"

		##### if both have identical scenarios, combine ###

		if(all(sc1==sc2)==T){


		        #############(1) Get unnormalized number (absoute) for female ############

				# > mydat1b[1:5,]
				# > mydat1b[1:5,]
				#        scenario n.total n.entry.all n.case PercentScreened100 LCcases90 LCcases.sdet90 LCcasesOver90 LCdeaths90 Deaths.avoided90 LifeYearsSaved90
				# 1 A-45-75-10-10   1e+05       94010  15574              31.40      6403           2141            94       4118              464             8104
				# 2 A-45-75-10-15   1e+05       94010  15574              33.48      6413           2366           104       4053              529             9178
				# 3 A-45-75-10-20   1e+05       94010  15574              34.48      6424           2506           115       4021              561             9729
				# 4 A-45-75-10-25   1e+05       94010  15574              34.63      6426           2625           117       3990              591            10163
				# 5 A-45-75-20-10   1e+05       94010  15574              24.62      6397           2041            88       4145              436             7577
				#   Alldeaths90 Alldeaths.case.noncase90 LCdeathsSurgery_overDiag90 LCdeathsSurgery_sdet90 AlldeathsSurgery90 AlldeathsSurgery_noscreen90
				# 1       13967                    70033                          2                     13                 40                          38
				# 2       13947                    70014                          2                     14                 40                          38
				# 3       13936                    70002                          2                     14                 40                          38
				# 4       13927                    69994                          2                     15                 40                          38
				# 5       13973                    70039                          2                     13                 40                          38
				#   EverScreened100 EverScreened90
				# 1           31400          31400
				# 2           33480          33480
				# 3           34480          34480
				# 4           34630          34630
				# 5           24620          24620


				mf1 = (as.numeric(mydat1b[,"n.entry.all"])/as.numeric(mydat1b[,"n.total"]))[1]
				mf1 #[1] 0.9401

				## multply this number to reduce the absoulte counts (previously increased to match rate per 100,000 ###

				tmp1 = mydat1b[,-c(1:9)]
				tmp1b=matrix(NA,ncol=ncol(tmp1),nrow=nrow(tmp1));colnames(tmp1b)=colnames(tmp1)
				for(j in 1:ncol(tmp1b))  tmp1b[,j]=as.numeric(tmp1[,j])

				mydat1.abs = tmp1b*mf1
				#mydat1.abs = mydat1b[,-c(1:9)]*mf1
				#mydat1.abs = mydat1b[,-c(1:3)]*mf1
				mydat1.abs[1:10,]
				#      n.case LCcases.noscreen100 LCdeaths.noscreen100 PercentScreened100 CTscreens100 CTexams100 PctEarlyStage100 LCcases100 LCcases.sdet100
				# 1  14641.12            6828.886             5011.673           29.51914     539196.2   627542.1         51.32006   6915.376        2012.754
				# 2  14641.12            6828.886             5011.673           31.47455     611862.2   700221.3         52.92763   6924.777        2224.277
				# 3  14641.12            6828.886             5011.673           32.41465     678180.6   766549.1         53.89593   6935.118        2355.891
				# 4  14641.12            6828.886             5011.673           32.55566     733721.7   822095.8         54.82663   6936.998        2467.763
				# 5  14641.12            6828.886             5011.673           23.14526     435602.9   523948.8         50.59618   6909.735        1918.744
				# 6  14641.12            6828.886             5011.673           23.70932     485430.0   573785.3         52.01573   6920.076        2105.824
				# 7  14641.12            6828.886             5011.673           23.82213     525174.6   613539.3         52.89003   6927.597        2217.696
				# 8  14641.12            6828.886             5011.673           23.82213     554328.1   642698.4         53.55750   6930.417        2307.005
				# 9  14641.12            6828.886             5011.673           15.99110     302122.8   390452.7         48.65018   6895.633        1633.894
				# 10 14641.12            6828.886             5011.673           16.05691     331737.8   420077.1         49.75949   6905.035        1777.729
				#    LCcases.sdet.eff100 LCdeaths100 LCcasesOver100 Deaths.avoided100 LifeYearsSaved100 MortReduct100 AlldeathsCase100 AlldeathsNoncases100
				# 1             1525.999    4576.407        88.3694          436.2064          7618.862      8.178870         15367.81             88566.82
				# 2             1689.999    4515.300        97.7704          497.3129          8627.777      9.325792         15364.05             88563.06
				# 3             1792.996    4485.217       108.1115          527.3961          9146.158      9.880451         15363.11             88562.12
				# 4             1880.999    4456.074       109.9917          555.5991          9553.879     10.425709         15361.23             88560.24
				# 5             1447.998    4601.789        82.7288          409.8836          7122.837      7.690018         15369.69             88568.70
				# 6             1592.003    4549.144        93.0699          463.4693          7927.027      8.686524         15365.93             88564.94
				# 7             1679.996    4520.941       100.5907          490.7322          8375.389      9.212980         15364.05             88563.06
				# 8             1748.003    4498.378       103.4110          514.2347          8669.847      9.645426         15363.11             88562.12
				# 9             1227.996    4663.836        68.6273          347.8370          5857.114      6.524294         15370.64             88569.64
				# 10            1334.998    4629.052        78.0283          382.6207          6351.165      7.182364         15368.75             88567.76
				#    Ratio.case.scrdet.per.CT100 Rario.deaths.avoided_case.scr100 LCcases.noscreen90 LCdeaths.noscreen90 CTscreens90 CTexams90 PctEarlyStage90
				# 1                     0.347837                         20.36257           5932.971            4306.598    539196.2  627542.1        53.65151
				# 2                     0.338436                         21.01124           5932.971            4306.598    611862.2  700221.3        55.49410
				# 3                     0.329035                         21.03004           5932.971            4306.598    678180.6  766549.1        56.60342
				# 4                     0.319634                         21.18045           5932.971            4306.598    733721.7  822095.8        57.67514
				# 5                     0.413644                         20.08994           5932.971            4306.598    435602.9  523948.8        52.82422
				# 6                     0.404243                         20.66340           5932.971            4306.598    485430.0  573785.3        54.45059
				# 7                     0.394842                         20.81381           5932.971            4306.598    525174.6  613539.3        55.45650
				# 8                     0.394842                         20.94543           5932.971            4306.598    554328.1  642698.4        56.20858
				# 9                     0.507654                         20.02413           5932.971            4306.598    302122.8  390452.7        50.59618
				# 10                    0.507654                         20.24975           5932.971            4306.598    331737.8  420077.1        51.86532
				#    LCcases90 LCcases.sdet90 LCcasesOver90 LCdeaths90 Deaths.avoided90 LifeYearsSaved90 MortReduct90 Alldeaths90 Alldeaths.case.noncase90
				# 1   6019.460       2012.754       88.3694   3871.332         436.2064         7618.570     6.909735    13130.38                 65838.02
				# 2   6028.861       2224.277       97.7704   3810.225         497.3129         8628.238     7.878038    13111.57                 65820.16
				# 3   6039.202       2355.891      108.1115   3780.142         527.3961         9146.233     8.348088    13101.23                 65808.88
				# 4   6041.083       2467.763      109.9917   3750.999         555.5991         9554.236     8.808737    13092.77                 65801.36
				# 5   6013.820       1918.744       82.7288   3896.715         409.8836         7123.138     6.496091    13136.02                 65843.66
				# 6   6024.161       2105.824       93.0699   3844.069         463.4693         7926.923     7.332780    13121.92                 65829.56
				# 7   6031.682       2217.696      100.5907   3815.866         490.7322         8375.351     7.784028    13111.57                 65820.16
				# 8   6033.562       2307.005      103.4110   3793.303         514.2347         8669.602     8.141266    13106.87                 65815.46
				# 9   5999.718       1633.894       68.6273   3958.761         347.8370         5856.823     5.518387    13153.88                 65862.47
				# 10  6009.119       1777.729       78.0283   3923.977         382.6207         6351.316     6.073046    13145.42                 65853.06

				######## OK it should match ###

				round(mydat1.abs[1:5,"LCcases90"]) ==  mydat1[1:5,"LCcases90_abs"]
				# [1] TRUE TRUE TRUE TRUE TRUE

				# > mydat1c[1:5,"LCcases90"]
				# [1] 6019.460 6028.861 6039.202 6041.083 6013.820
				# > mydat1[1:5,"LCcases90_abs"]
				# [1] 6019 6029 6039 6041 6014
				# > round(mydat1c[1:5,"LCcases90"])
				# [1] 6019 6029 6039 6041 6014
				#

		        #############(2) Get unnormalized number (absoute) for male ############

				# > mydat2b[1:5,]
				#        scenario n.total n.entry.all n.case LCcases.noscreen100 LCdeaths.noscreen100 PercentScreened100 CTscreens100 CTexams100 PctEarlyStage100
				# 1 A-45-75-10-10   1e+05       89067  16191                5879                 4926              42.78       745120     839058            49.66
				# 2 A-45-75-10-15   1e+05       89067  16191                5879                 4926              46.44       847696     941636            51.20
				# 3 A-45-75-10-20   1e+05       89067  16191                5879                 4926              48.20       945170    1039113            52.76
				# 4 A-45-75-10-25   1e+05       89067  16191                5879                 4926              48.52      1028687    1122632            53.63
				# 5 A-45-75-20-10   1e+05       89067  16191                5879                 4926              34.38       623018     716954            48.19
				#   LCcases100 LCcases.sdet100 LCcases.sdet.eff100 LCdeaths100 LCcasesOver100 Deaths.avoided100 LifeYearsSaved100 MortReduct100 AlldeathsCase100
				# 1       6002            2131             1744.75        4497            125               429           6105.76          8.71            18130
				# 2       6010            2270             1855.91        4469            132               457           6566.94          9.28            18130
				# 3       6018            2409             1967.06        4440            140               485           6916.01          9.85            18129
				# 4       6024            2501             2036.67        4426            146               500           7191.65         10.14            18128
				# 5       5997            2012             1644.83        4520            119               405           5666.63          8.23            18131
				#   AlldeathsNoncases100 Ratio.case.scrdet.per.CT100 Rario.deaths.avoided_case.scr100 LCcases.noscreen90 LCdeaths.noscreen90 CTscreens90 CTexams90
				# 1                97973                        0.29                            20.13               5377                4478      745120    839058
				# 2                97973                        0.27                            20.13               5377                4478      847696    941636
				# 3                97972                        0.25                            20.13               5377                4478      945170   1039113
				# 4                97971                        0.24                            19.97               5377                4478     1028687   1122632
				# 5                97975                        0.32                            20.15               5377                4478      623018    716954
				#


				mf2 = (as.numeric(mydat2b[,"n.entry.all"])/as.numeric(mydat2b[,"n.total"]))[1]
				mf2 #[1] [1] 0.89067

				## multply this number to reduce the absoulte counts (previously increased to match rate per 100,000 ###
				tmp2 = mydat2b[,-c(1:9)]
				tmp2b=matrix(NA,ncol=ncol(tmp2),nrow=nrow(tmp2));colnames(tmp2b)=colnames(tmp2)
				for(j in 1:ncol(tmp2b))  tmp2b[,j]=as.numeric(tmp2[,j])

				mydat2.abs = tmp2b*mf2

				#mydat2.abs = mydat2b[,-c(1:9)]*mf2
				#mydat2.abs = mydat2b[,-c(1:3)]*mf2
				mydat2.abs[1:5,]
				#     n.case PercentScreened100 LCcases90 LCcases.sdet90 LCcasesOver90 LCdeaths90 Deaths.avoided90 LifeYearsSaved90 Alldeaths90
				# 1 14420.84           38.10286  4898.685       1898.018      111.3337   3606.323         382.0974         5438.431    14984.63
				# 2 14420.84           41.36271  4905.810       2021.821      117.5684   3581.384         407.0362         5849.030    14978.40
				# 3 14420.84           42.93029  4912.936       2145.624      124.6938   3556.445         431.9749         6159.874    14973.94
				# 4 14420.84           43.21531  4918.280       2227.566      130.0378   3543.085         445.3350         6405.699    14970.38
				# 5 14420.84           30.62123  4894.232       1792.028      105.9897   3626.808         360.7213         5047.427    14990.87
				#   Alldeaths.case.noncase90 LCdeathsSurgery_overDiag90 LCdeathsSurgery_sdet90 AlldeathsSurgery90 AlldeathsSurgery_noscreen90 EverScreened100
				# 1                 74845.67                          0               13.36005            26.7201                     26.7201        38102.86
				# 2                 74839.44                          0               14.25072            26.7201                     26.7201        41362.71
				# 3                 74834.98                          0               16.03206            26.7201                     26.7201        42930.29
				# 4                 74831.42                          0               16.03206            26.7201                     26.7201        43215.31
				# 5                 74851.91                          0               11.57871            26.7201                     26.7201        30621.23
				#   EverScreened90
				# 1       38102.86
				# 2       41362.71
				# 3       42930.29
				# 4       43215.31
				# 5       30621.23


				round(mydat2.abs[1:5,"LCcases90"]) ==  mydat2[1:5,"LCcases90_abs"]
				#[1] TRUE TRUE TRUE TRUE TRUE


				#### combine two absoulte numbers ############

				mydat.all.abs = mydat1.abs + mydat2.abs
				mydat.all.abs[1:5,]
				#     n.case PercentScreened100 LCcases90 LCcases.sdet90 LCcasesOver90 LCdeaths90 Deaths.avoided90 LifeYearsSaved90 Alldeaths90
				# 1 29061.96           67.62200  10918.15       3910.772      199.7031   7477.655         818.3038         13057.00    28115.01
				# 2 29061.96           72.83726  10934.67       4246.097      215.3388   7391.609         904.3491         14477.27    28089.97
				# 3 29061.96           75.34494  10952.14       4501.515      232.8053   7336.587         959.3710         15306.11    28075.18
				# 4 29061.96           75.77097  10959.36       4695.328      240.0295   7294.084        1000.9341         15959.93    28063.15
				# 5 29061.96           53.76650  10908.05       3710.772      188.7185   7523.523         770.6049         12170.56    28126.88
				#   Alldeaths.case.noncase90 LCdeathsSurgery_overDiag90 LCdeathsSurgery_sdet90 AlldeathsSurgery90 AlldeathsSurgery_noscreen90 EverScreened100
				# 1                 140683.7                     1.8802               25.58135            64.3241                     62.4439        67622.00
				# 2                 140659.6                     1.8802               27.41212            64.3241                     62.4439        72837.26
				# 3                 140643.9                     1.8802               29.19346            64.3241                     62.4439        75344.94
				# 4                 140632.8                     1.8802               30.13356            64.3241                     62.4439        75770.97
				# 5                 140695.6                     1.8802               23.80001            64.3241                     62.4439        53766.50
				#   EverScreened90
				# 1       67622.00
				# 2       72837.26
				# 3       75344.94
				# 4       75770.97
				# 5       53766.50
				#

				################## Calculate Normalizing factor:    #########################

				n.total = as.numeric(mydat1[1,"n.total"]) + as.numeric(mydat2[1,"n.total"])
				n.entry.all = as.numeric(mydat1[1,"n.entry.all"]) + as.numeric(mydat2[1,"n.entry.all"] )
				n.entry.all
				#[1] 183077

				# > mydat1[1,"n.entry.all"]
				# [1] 94010
				# > mydat2[1,"n.entry.all"]
				# [1] 89067

				MF = N/n.entry.all
				MF
				#[1] 0.5462183

				mydat.all.norm = cbind(scenario=sc1, comp,n.total=rep(n.total,nrow(mydat1)),n.entry.all=rep(n.entry.all,nrow(mydat1)),mydat.all.abs*MF)
				mydat.all.norm[1:5,]
				#        scenario   n.case PercentScreened100 LCcases.noscreen90 LCdeaths.noscreen90 LCcases90 LCcases.sdet90 LCcasesOver90
				# 1 A-45-75-10-10 15874.17           36.93637           5856.609             4530.89  5963.690       2136.135      109.0815
				# 2 A-45-75-10-15 15874.17           39.78504           5856.609             4530.89  5972.717       2319.296      117.6220
				# 3 A-45-75-10-20 15874.17           41.15478           5856.609             4530.89  5982.258       2458.809      127.1625
				# 4 A-45-75-10-25 15874.17           41.38749           5856.609             4530.89  5986.204       2564.674      131.1085
				# 5 A-45-75-20-10 15874.17           29.36824           5856.609             4530.89  5958.177       2026.891      103.0815
				#   LCdeaths90 PctEarlyStage90 Deaths.avoided90 LifeYearsSaved90 Alldeaths90 Alldeaths.case.noncase90
				# 1   4084.431        54.59858         446.9725         7131.973    15356.93                 76844.00
				# 2   4037.432        56.42236         493.9720         7907.748    15343.26                 76830.84
				# 3   4007.378        57.85047         524.0260         8360.475    15335.17                 76822.25
				# 4   3984.162        58.89317         546.7285         8717.608    15328.61                 76816.19
				# 5   4109.485        53.36830         420.9185         6647.785    15363.42                 76850.49
				#   LCdeathsSurgery_overDiag90 LCdeathsSurgery_sdet90 AlldeathsSurgery90 AlldeathsSurgery_noscreen90 EverScreened100
				# 1                      1.027                13.9730             35.135                      34.108        36936.37
				# 2                      1.027                14.9730             35.135                      34.108        39785.04
				# 3                      1.027                15.9460             35.135                      34.108        41154.78
				# 4                      1.027                16.4595             35.135                      34.108        41387.49
				# 5                      1.027                13.0000             35.135                      34.108        29368.24
				#   EverScreened90
				# 1       36936.37
				# 2       39785.04
				# 3       41154.78
				# 4       41387.49
				# 5       29368.24


				###### calculate mortality reduction

				MortReduct90 = as.numeric(mydat.all.norm[,"Deaths.avoided90"])/as.numeric(mydat.all.norm[,"LCdeaths.noscreen90"])

				mydat.final = cbind(mydat.all.norm, MortReduct90=MortReduct90*100)
				# > mydat.final[1:5,]
				#        scenario   n.case PercentScreened100 LCcases.noscreen90 LCdeaths.noscreen90 LCcases90 LCcases.sdet90 LCcasesOver90
				# 1 A-45-75-10-10 15874.17           36.93637           5856.609             4530.89  5963.690       2136.135      109.0815
				# 2 A-45-75-10-15 15874.17           39.78504           5856.609             4530.89  5972.717       2319.296      117.6220
				# 3 A-45-75-10-20 15874.17           41.15478           5856.609             4530.89  5982.258       2458.809      127.1625
				# 4 A-45-75-10-25 15874.17           41.38749           5856.609             4530.89  5986.204       2564.674      131.1085
				# 5 A-45-75-20-10 15874.17           29.36824           5856.609             4530.89  5958.177       2026.891      103.0815
				#   LCdeaths90 PctEarlyStage90 Deaths.avoided90 LifeYearsSaved90 Alldeaths90 Alldeaths.case.noncase90
				# 1   4084.431        54.59858         446.9725         7131.973    15356.93                 76844.00
				# 2   4037.432        56.42236         493.9720         7907.748    15343.26                 76830.84
				# 3   4007.378        57.85047         524.0260         8360.475    15335.17                 76822.25
				# 4   3984.162        58.89317         546.7285         8717.608    15328.61                 76816.19
				# 5   4109.485        53.36830         420.9185         6647.785    15363.42                 76850.49
				#   LCdeathsSurgery_overDiag90 LCdeathsSurgery_sdet90 AlldeathsSurgery90 AlldeathsSurgery_noscreen90 EverScreened100
				# 1                      1.027                13.9730             35.135                      34.108        36936.37
				# 2                      1.027                14.9730             35.135                      34.108        39785.04
				# 3                      1.027                15.9460             35.135                      34.108        41154.78
				# 4                      1.027                16.4595             35.135                      34.108        41387.49
				# 5                      1.027                13.0000             35.135                      34.108        29368.24
				#   EverScreened90 MortReduct90
				# 1       36936.37     9.865003
				# 2       39785.04    10.902316
				# 3       41154.78    11.565629
				# 4       41387.49    12.066689
				# 5       29368.24     9.289973




				#   n.total n.entry.all n.case LCcases.noscreen100 LCdeaths.noscreen100 PercentScreened100 CTscreens100 CTexams100 PctEarlyStage100 LCcases100
				# 1   2e+05      183077  31765               13143                10257              74.18      1318672    1506585           104.25      13358
				# 2   2e+05      183077  31765               13143                10257              79.92      1498544    1686473           107.50      13376
				# 3   2e+05      183077  31765               13143                10257              82.68      1666562    1854504           110.09      13395
				# 4   2e+05      183077  31765               13143                10257              83.15      1809159    1997109           111.95      13403
				# 5   2e+05      183077  31765               13143                10257              59.00      1086376    1274287           102.01      13347
				#   LCcases.sdet100 LCcases.sdet.eff100 LCdeaths100 LCcasesOver100 Deaths.avoided100 LifeYearsSaved100 MortReduct100 AlldeathsCase100
				# 1            4272             3367.98        9365            219               893          14210.07         17.41            34477
				# 2            4636             3653.59        9272            236               986          15744.45         19.20            34473
				# 3            4915             3874.30        9211            255              1046          16644.93         20.36            34471
				# 4            5126             4037.52        9166            263              1091          17354.27         21.23            34468
				# 5            4053             3185.09        9415            207               841          13243.31         16.41            34480
				#   AlldeathsNoncases100 Ratio.case.scrdet.per.CT100 Rario.deaths.avoided_case.scr100 LCcases.noscreen90 LCdeaths.noscreen90 CTscreens90 CTexams90
				# 1               192183                        0.66                            41.79              11688                9059     1318672   1506585
				# 2               192179                        0.63                            42.48              11688                9059     1498544   1686473
				# 3               192177                        0.60                            42.50              11688                9059     1666562   1854504
				# 4               192174                        0.58                            42.50              11688                9059     1809159   1997109
				# 5               192187                        0.76                            41.52              11688                9059     1086376   1274287
				#   PctEarlyStage90 LCcases90 LCcases.sdet90 LCcasesOver90 LCdeaths90 Deaths.avoided90 LifeYearsSaved90 MortReduct90 Alldeaths90
				# 1          109.06     11903           4272           219       8167              893            14210        15.33       30791
				# 2          112.70     11921           4636           236       8074              986            15745        16.88       30764
				# 3          115.57     11940           4915           255       8014             1046            16645        17.90       30748
				# 4          117.65     11948           5126           263       7968             1091            17355        18.66       30735
				# 5          106.58     11892           4053           207       8217              841            13244        14.45       30804
				#   Alldeaths.case.noncase90 prop.cdet.90 LCdeathsSurgery_overDiag90 LCdeathsSurgery_sdet90 AlldeathsSurgery90 AlldeathsSurgery_noscreen90
				# 1                   154066         1.27                          2                     28                 70                          68
				# 2                   154040         1.22                          2                     30                 70                          68
				# 3                   154023         1.17                          2                     32                 70                          68
				# 4                   154011         1.14                          2                     33                 70                          68
				# 5                   154079         1.31                          2                     26                 70                          68
				#



		}#end of


		mydat.final


}#end of funciton


myCombineGender2 <- function(mydat1,mydat2, mycolnames,N=100000){



# > colnames(mydat1)
# "LCcases.noscreen90"               "LCdeaths.noscreen90"              "CTscreens90"                      "CTexams90"
# "PctEarlyStage90"                  "LCcases90"                        "LCcases.sdet90"                   "LCcasesOver90"
# "LCdeaths90"                       "Deaths.avoided90"                 "LifeYearsSaved90"                 "MortReduct90"
# "Alldeaths90"                      "Alldeaths.case.noncase90"         "prop.cdet.90"                     "LCdeathsSurgery_overDiag90"
# "LCdeathsSurgery_sdet90"           "AlldeathsSurgery90"               "AlldeathsSurgery_noscreen90"      "CTscreens90_abs"
# "CTexams90_abs"                    "LCcases90_abs"                    "LCdeaths90_abs"




# 		mycolnames=c("scenario","n.total", "n.entry.all","n.case" ,"PercentScreened100",
# 					"LCcases.noscreen90", "LCdeaths.noscreen90",
# 					"LCcases90","LCcases.sdet90","LCcasesOver90", "LCdeaths90", "PctEarlyStage90",
# 					"Deaths.avoided90","LifeYearsSaved90","Alldeaths90", "Alldeaths.case.noncase90",
# 					"LCdeathsSurgery_overDiag90", "LCdeathsSurgery_sdet90","AlldeathsSurgery90","AlldeathsSurgery_noscreen90")


		#mycolnames = c("scenario", "n.total","n.entry.all", "CTscreens90_abs","CTexams90_abs","LCcases90_abs","LCdeaths90_abs")

		#mydat1=read.csv(file1)
		#mydat2=read.csv(file2)

		#excludeCols=c(1,3:7, 48:51)

		# > mydat1[,1:10]
		#         X NUM      scenario age.start age.stop age.interval py ysq n.total n.entry.all
		# 1           1 A-45-75-10-10        45       75            1 10  10   1e+05       94010
		# 2 output2   2 A-45-75-10-15        45       75            1 10  15   1e+05       94010

		#### Female ######

		mydat1b=mydat1[,mycolnames]
		#mydat1b=mydat1[,-excludeCols]
		#        scenario n.total n.entry.all CTscreens90_abs CTexams90_abs LCcases90_abs LCdeaths90_abs
		# 1 A-45-75-10-10   1e+05       94010          539196        627542          6019           3871
		# 2 A-45-75-10-15   1e+05       94010          611862        700221          6029           3810

		# colnames(mydat1b)
		#  [1] "scenario"                    "n.total"                     "n.entry.all"                 "n.case"
		#  [5] "PercentScreened100"          "LCcases90"                   "LCcases.sdet90"              "LCcasesOver90"
		#  [9] "LCdeaths90"                  "Deaths.avoided90"            "LifeYearsSaved90"            "Alldeaths90"
		# [13] "Alldeaths.case.noncase90"    "LCdeathsSurgery_overDiag90"  "LCdeathsSurgery_sdet90"      "AlldeathsSurgery90"
		# [17] "AlldeathsSurgery_noscreen90"

		##### make # of people ever screened instead of Percent ###

		#### this is # of poeple in 100000 so normalized alreayd
		EverScreened100=100000*(mydat1b[,"PercentScreened100"]/100)
		# > EverScreened100[1:5]
		# [1] 31400 33480 34480 34630 24620

		#EverScreened100=mydat1b[,"n.entry.all"]*(mydat1b[,"PercentScreened100"]/100)
		# > EverScreened100[1:10]
		#  [1] 29519.14 31474.55 32414.65 32555.66 23145.26 23709.32 23822.13 23822.13 15991.10 16056.91
		# > mydat1b[,"n.entry.all"][1:5]
		# [1] 94010 94010 94010 94010 94010
		# > (mydat1b[,"PercentScreened100"]/100)[1:5]
		# [1] 0.3140 0.3348 0.3448 0.3463 0.2462

		### this should have been normalized ##
		#mf1.tm = (100000/mydat1b[,"n.entry.all"])[1]
		#mf1.tm
		#[1] 1.063717


		mydat1b=cbind(mydat1b, EverScreened100=EverScreened100, EverScreened90=EverScreened100)


		#  [1] "scenario"                         "n.total"                          "n.entry.all"
		#  [4] "n.case"                           "LCcases.noscreen100"              "LCdeaths.noscreen100"
		#  [7] "PercentScreened100"               "CTscreens100"                     "CTexams100"
		# [10] "PctEarlyStage100"                 "LCcases100"                       "LCcases.sdet100"
		# [13] "LCcases.sdet.eff100"              "LCdeaths100"                      "LCcasesOver100"
		# [16] "Deaths.avoided100"                "LifeYearsSaved100"                "MortReduct100"
		# [19] "AlldeathsCase100"                 "AlldeathsNoncases100"             "Ratio.case.scrdet.per.CT100"
		# [22] "Rario.deaths.avoided_case.scr100" "LCcases.noscreen90"               "LCdeaths.noscreen90"
		# [25] "CTscreens90"                      "CTexams90"                        "PctEarlyStage90"
		# [28] "LCcases90"                        "LCcases.sdet90"                   "LCcasesOver90"
		# [31] "LCdeaths90"                       "Deaths.avoided90"                 "LifeYearsSaved90"
		# [34] "MortReduct90"                     "Alldeaths90"                      "Alldeaths.case.noncase90"
		# [37] "prop.cdet.90"                     "LCdeathsSurgery_overDiag90"       "LCdeathsSurgery_sdet90"
		# [40] "AlldeathsSurgery90"               "AlldeathsSurgery_noscreen90"      "CTscreens90_abs"
		# [43] "CTexams90_abs"                    "LCcases90_abs"                    "LCdeaths90_abs"

		######## Male ########

		mydat2b=mydat2[,mycolnames]

		#mydat2b=mydat2[,-excludeCols]#[,mycolnames]
		#        scenario n.total n.entry.all CTscreens90_abs CTexams90_abs LCcases90_abs LCdeaths90_abs
		# 1 A-45-75-10-10   1e+05       89067          663656        747324          4899           3606
		# 2 A-45-75-10-15   1e+05       89067          755017        838687          4906           3581

		EverScreened100.male =100000*(mydat2b[,"PercentScreened100"]/100)
		# > EverScreened100[1:5]
		# [1] 31400 33480 34480 34630 24620

		#EverScreened100=mydat1b[,"n.entry.all"]*(mydat1b[,"PercentScreened100"]/100)
		# > EverScreened100[1:10]
		#  [1] 29519.14 31474.55 32414.65 32555.66 23145.26 23709.32 23822.13 23822.13 15991.10 16056.91
		# > mydat1b[,"n.entry.all"][1:5]
		# [1] 94010 94010 94010 94010 94010
		# > (mydat1b[,"PercentScreened100"]/100)[1:5]
		# [1] 0.3140 0.3348 0.3448 0.3463 0.2462

		### this should have been normalized ##
		#mf1.tm = (100000/mydat1b[,"n.entry.all"])[1]
		#mf1.tm
		#[1] 1.063717


		mydat2b=cbind(mydat2b, EverScreened100=EverScreened100.male, EverScreened90=EverScreened100.male)
		# > mydat2b[1:5,]
		#        scenario n.total n.entry.all n.case PercentScreened100 LCcases90 LCcases.sdet90 LCcasesOver90 LCdeaths90 Deaths.avoided90 LifeYearsSaved90
		# 1 A-45-75-10-10   1e+05       89067  16191              42.78      5500           2131           125       4049              429             6106
		# 2 A-45-75-10-15   1e+05       89067  16191              46.44      5508           2270           132       4021              457             6567
		# 3 A-45-75-10-20   1e+05       89067  16191              48.20      5516           2409           140       3993              485             6916
		# 4 A-45-75-10-25   1e+05       89067  16191              48.52      5522           2501           146       3978              500             7192
		# 5 A-45-75-20-10   1e+05       89067  16191              34.38      5495           2012           119       4072              405             5667
		#   Alldeaths90 Alldeaths.case.noncase90 LCdeathsSurgery_overDiag90 LCdeathsSurgery_sdet90 AlldeathsSurgery90 AlldeathsSurgery_noscreen90
		# 1       16824                    84033                          0                     15                 30                          30
		# 2       16817                    84026                          0                     16                 30                          30
		# 3       16812                    84021                          0                     18                 30                          30
		# 4       16808                    84017                          0                     18                 30                          30
		# 5       16831                    84040                          0                     13                 30                          30
		#   EverScreened100 EverScreened90
		# 1           42780          42780
		# 2           46440          46440
		# 3           48200          48200
		# 4           48520          48520
		# 5           34380          34380


		sc1=as.character(mydat1b[,"scenario"])
		sc2=as.character(mydat2b[,"scenario"])
		# > sc1
		# [1] "A-45-75-10-10" "A-45-75-10-15"
		# > sc2
		# [1] "A-45-75-10-10" "A-45-75-10-15"


		##### if both have identical scenarios, combine ###

		if(all(sc1==sc2)==T){


		        #############(1) Get unnormalized number (absoute) for female ############

				# > mydat1b[1:5,]
				# > mydat1b[1:5,]
				#        scenario n.total n.entry.all n.case PercentScreened100 LCcases90 LCcases.sdet90 LCcasesOver90 LCdeaths90 Deaths.avoided90 LifeYearsSaved90
				# 1 A-45-75-10-10   1e+05       94010  15574              31.40      6403           2141            94       4118              464             8104
				# 2 A-45-75-10-15   1e+05       94010  15574              33.48      6413           2366           104       4053              529             9178
				# 3 A-45-75-10-20   1e+05       94010  15574              34.48      6424           2506           115       4021              561             9729
				# 4 A-45-75-10-25   1e+05       94010  15574              34.63      6426           2625           117       3990              591            10163
				# 5 A-45-75-20-10   1e+05       94010  15574              24.62      6397           2041            88       4145              436             7577
				#   Alldeaths90 Alldeaths.case.noncase90 LCdeathsSurgery_overDiag90 LCdeathsSurgery_sdet90 AlldeathsSurgery90 AlldeathsSurgery_noscreen90
				# 1       13967                    70033                          2                     13                 40                          38
				# 2       13947                    70014                          2                     14                 40                          38
				# 3       13936                    70002                          2                     14                 40                          38
				# 4       13927                    69994                          2                     15                 40                          38
				# 5       13973                    70039                          2                     13                 40                          38
				#   EverScreened100 EverScreened90
				# 1           31400          31400
				# 2           33480          33480
				# 3           34480          34480
				# 4           34630          34630
				# 5           24620          24620


				mf1 = (mydat1b[,"n.entry.all"]/mydat1b[,"n.total"])[1]
				mf1 #[1] 0.9401

				## multply this number to reduce the absoulte counts (previously increased to match rate per 100,000 ###

				mydat1.abs = mydat1b[,-c(1:3)]*mf1
				mydat1.abs[1:10,]
				#      n.case LCcases.noscreen100 LCdeaths.noscreen100 PercentScreened100 CTscreens100 CTexams100 PctEarlyStage100 LCcases100 LCcases.sdet100
				# 1  14641.12            6828.886             5011.673           29.51914     539196.2   627542.1         51.32006   6915.376        2012.754
				# 2  14641.12            6828.886             5011.673           31.47455     611862.2   700221.3         52.92763   6924.777        2224.277
				# 3  14641.12            6828.886             5011.673           32.41465     678180.6   766549.1         53.89593   6935.118        2355.891
				# 4  14641.12            6828.886             5011.673           32.55566     733721.7   822095.8         54.82663   6936.998        2467.763
				# 5  14641.12            6828.886             5011.673           23.14526     435602.9   523948.8         50.59618   6909.735        1918.744
				# 6  14641.12            6828.886             5011.673           23.70932     485430.0   573785.3         52.01573   6920.076        2105.824
				# 7  14641.12            6828.886             5011.673           23.82213     525174.6   613539.3         52.89003   6927.597        2217.696
				# 8  14641.12            6828.886             5011.673           23.82213     554328.1   642698.4         53.55750   6930.417        2307.005
				# 9  14641.12            6828.886             5011.673           15.99110     302122.8   390452.7         48.65018   6895.633        1633.894
				# 10 14641.12            6828.886             5011.673           16.05691     331737.8   420077.1         49.75949   6905.035        1777.729
				#    LCcases.sdet.eff100 LCdeaths100 LCcasesOver100 Deaths.avoided100 LifeYearsSaved100 MortReduct100 AlldeathsCase100 AlldeathsNoncases100
				# 1             1525.999    4576.407        88.3694          436.2064          7618.862      8.178870         15367.81             88566.82
				# 2             1689.999    4515.300        97.7704          497.3129          8627.777      9.325792         15364.05             88563.06
				# 3             1792.996    4485.217       108.1115          527.3961          9146.158      9.880451         15363.11             88562.12
				# 4             1880.999    4456.074       109.9917          555.5991          9553.879     10.425709         15361.23             88560.24
				# 5             1447.998    4601.789        82.7288          409.8836          7122.837      7.690018         15369.69             88568.70
				# 6             1592.003    4549.144        93.0699          463.4693          7927.027      8.686524         15365.93             88564.94
				# 7             1679.996    4520.941       100.5907          490.7322          8375.389      9.212980         15364.05             88563.06
				# 8             1748.003    4498.378       103.4110          514.2347          8669.847      9.645426         15363.11             88562.12
				# 9             1227.996    4663.836        68.6273          347.8370          5857.114      6.524294         15370.64             88569.64
				# 10            1334.998    4629.052        78.0283          382.6207          6351.165      7.182364         15368.75             88567.76
				#    Ratio.case.scrdet.per.CT100 Rario.deaths.avoided_case.scr100 LCcases.noscreen90 LCdeaths.noscreen90 CTscreens90 CTexams90 PctEarlyStage90
				# 1                     0.347837                         20.36257           5932.971            4306.598    539196.2  627542.1        53.65151
				# 2                     0.338436                         21.01124           5932.971            4306.598    611862.2  700221.3        55.49410
				# 3                     0.329035                         21.03004           5932.971            4306.598    678180.6  766549.1        56.60342
				# 4                     0.319634                         21.18045           5932.971            4306.598    733721.7  822095.8        57.67514
				# 5                     0.413644                         20.08994           5932.971            4306.598    435602.9  523948.8        52.82422
				# 6                     0.404243                         20.66340           5932.971            4306.598    485430.0  573785.3        54.45059
				# 7                     0.394842                         20.81381           5932.971            4306.598    525174.6  613539.3        55.45650
				# 8                     0.394842                         20.94543           5932.971            4306.598    554328.1  642698.4        56.20858
				# 9                     0.507654                         20.02413           5932.971            4306.598    302122.8  390452.7        50.59618
				# 10                    0.507654                         20.24975           5932.971            4306.598    331737.8  420077.1        51.86532
				#    LCcases90 LCcases.sdet90 LCcasesOver90 LCdeaths90 Deaths.avoided90 LifeYearsSaved90 MortReduct90 Alldeaths90 Alldeaths.case.noncase90
				# 1   6019.460       2012.754       88.3694   3871.332         436.2064         7618.570     6.909735    13130.38                 65838.02
				# 2   6028.861       2224.277       97.7704   3810.225         497.3129         8628.238     7.878038    13111.57                 65820.16
				# 3   6039.202       2355.891      108.1115   3780.142         527.3961         9146.233     8.348088    13101.23                 65808.88
				# 4   6041.083       2467.763      109.9917   3750.999         555.5991         9554.236     8.808737    13092.77                 65801.36
				# 5   6013.820       1918.744       82.7288   3896.715         409.8836         7123.138     6.496091    13136.02                 65843.66
				# 6   6024.161       2105.824       93.0699   3844.069         463.4693         7926.923     7.332780    13121.92                 65829.56
				# 7   6031.682       2217.696      100.5907   3815.866         490.7322         8375.351     7.784028    13111.57                 65820.16
				# 8   6033.562       2307.005      103.4110   3793.303         514.2347         8669.602     8.141266    13106.87                 65815.46
				# 9   5999.718       1633.894       68.6273   3958.761         347.8370         5856.823     5.518387    13153.88                 65862.47
				# 10  6009.119       1777.729       78.0283   3923.977         382.6207         6351.316     6.073046    13145.42                 65853.06

				######## OK it should match ###

				round(mydat1.abs[1:5,"LCcases90"]) ==  mydat1[1:5,"LCcases90_abs"]
				# [1] TRUE TRUE TRUE TRUE TRUE

				# > mydat1c[1:5,"LCcases90"]
				# [1] 6019.460 6028.861 6039.202 6041.083 6013.820
				# > mydat1[1:5,"LCcases90_abs"]
				# [1] 6019 6029 6039 6041 6014
				# > round(mydat1c[1:5,"LCcases90"])
				# [1] 6019 6029 6039 6041 6014
				#

		        #############(2) Get unnormalized number (absoute) for male ############

				# > mydat2b[1:5,]
				#        scenario n.total n.entry.all n.case LCcases.noscreen100 LCdeaths.noscreen100 PercentScreened100 CTscreens100 CTexams100 PctEarlyStage100
				# 1 A-45-75-10-10   1e+05       89067  16191                5879                 4926              42.78       745120     839058            49.66
				# 2 A-45-75-10-15   1e+05       89067  16191                5879                 4926              46.44       847696     941636            51.20
				# 3 A-45-75-10-20   1e+05       89067  16191                5879                 4926              48.20       945170    1039113            52.76
				# 4 A-45-75-10-25   1e+05       89067  16191                5879                 4926              48.52      1028687    1122632            53.63
				# 5 A-45-75-20-10   1e+05       89067  16191                5879                 4926              34.38       623018     716954            48.19
				#   LCcases100 LCcases.sdet100 LCcases.sdet.eff100 LCdeaths100 LCcasesOver100 Deaths.avoided100 LifeYearsSaved100 MortReduct100 AlldeathsCase100
				# 1       6002            2131             1744.75        4497            125               429           6105.76          8.71            18130
				# 2       6010            2270             1855.91        4469            132               457           6566.94          9.28            18130
				# 3       6018            2409             1967.06        4440            140               485           6916.01          9.85            18129
				# 4       6024            2501             2036.67        4426            146               500           7191.65         10.14            18128
				# 5       5997            2012             1644.83        4520            119               405           5666.63          8.23            18131
				#   AlldeathsNoncases100 Ratio.case.scrdet.per.CT100 Rario.deaths.avoided_case.scr100 LCcases.noscreen90 LCdeaths.noscreen90 CTscreens90 CTexams90
				# 1                97973                        0.29                            20.13               5377                4478      745120    839058
				# 2                97973                        0.27                            20.13               5377                4478      847696    941636
				# 3                97972                        0.25                            20.13               5377                4478      945170   1039113
				# 4                97971                        0.24                            19.97               5377                4478     1028687   1122632
				# 5                97975                        0.32                            20.15               5377                4478      623018    716954
				#


				mf2 = (mydat2b[,"n.entry.all"]/mydat2b[,"n.total"])[1]
				mf2 #[1] [1] 0.89067

				## multply this number to reduce the absoulte counts (previously increased to match rate per 100,000 ###

				mydat2.abs = mydat2b[,-c(1:3)]*mf2
				# > mydat2.abs[1:5,]
				#     n.case PercentScreened100 LCcases90 LCcases.sdet90 LCcasesOver90 LCdeaths90 Deaths.avoided90 LifeYearsSaved90 Alldeaths90
				# 1 14420.84           38.10286  4898.685       1898.018      111.3337   3606.323         382.0974         5438.431    14984.63
				# 2 14420.84           41.36271  4905.810       2021.821      117.5684   3581.384         407.0362         5849.030    14978.40
				# 3 14420.84           42.93029  4912.936       2145.624      124.6938   3556.445         431.9749         6159.874    14973.94
				# 4 14420.84           43.21531  4918.280       2227.566      130.0378   3543.085         445.3350         6405.699    14970.38
				# 5 14420.84           30.62123  4894.232       1792.028      105.9897   3626.808         360.7213         5047.427    14990.87
				#   Alldeaths.case.noncase90 LCdeathsSurgery_overDiag90 LCdeathsSurgery_sdet90 AlldeathsSurgery90 AlldeathsSurgery_noscreen90 EverScreened100
				# 1                 74845.67                          0               13.36005            26.7201                     26.7201        38102.86
				# 2                 74839.44                          0               14.25072            26.7201                     26.7201        41362.71
				# 3                 74834.98                          0               16.03206            26.7201                     26.7201        42930.29
				# 4                 74831.42                          0               16.03206            26.7201                     26.7201        43215.31
				# 5                 74851.91                          0               11.57871            26.7201                     26.7201        30621.23
				#   EverScreened90
				# 1       38102.86
				# 2       41362.71
				# 3       42930.29
				# 4       43215.31
				# 5       30621.23


				round(mydat2.abs[1:5,"LCcases90"]) ==  mydat2[1:5,"LCcases90_abs"]
				#[1] TRUE TRUE TRUE TRUE TRUE


				#### combine two absoulte numbers ############

				mydat.all.abs = mydat1.abs + mydat2.abs
				mydat.all.abs[1:5,]
				#     n.case PercentScreened100 LCcases90 LCcases.sdet90 LCcasesOver90 LCdeaths90 Deaths.avoided90 LifeYearsSaved90 Alldeaths90
				# 1 29061.96           67.62200  10918.15       3910.772      199.7031   7477.655         818.3038         13057.00    28115.01
				# 2 29061.96           72.83726  10934.67       4246.097      215.3388   7391.609         904.3491         14477.27    28089.97
				# 3 29061.96           75.34494  10952.14       4501.515      232.8053   7336.587         959.3710         15306.11    28075.18
				# 4 29061.96           75.77097  10959.36       4695.328      240.0295   7294.084        1000.9341         15959.93    28063.15
				# 5 29061.96           53.76650  10908.05       3710.772      188.7185   7523.523         770.6049         12170.56    28126.88
				#   Alldeaths.case.noncase90 LCdeathsSurgery_overDiag90 LCdeathsSurgery_sdet90 AlldeathsSurgery90 AlldeathsSurgery_noscreen90 EverScreened100
				# 1                 140683.7                     1.8802               25.58135            64.3241                     62.4439        67622.00
				# 2                 140659.6                     1.8802               27.41212            64.3241                     62.4439        72837.26
				# 3                 140643.9                     1.8802               29.19346            64.3241                     62.4439        75344.94
				# 4                 140632.8                     1.8802               30.13356            64.3241                     62.4439        75770.97
				# 5                 140695.6                     1.8802               23.80001            64.3241                     62.4439        53766.50
				#   EverScreened90
				# 1       67622.00
				# 2       72837.26
				# 3       75344.94
				# 4       75770.97
				# 5       53766.50
				#

				################## Calculate Normalizing factor:    #########################

				n.total = mydat1[1,"n.total"] + mydat2[1,"n.total"]
				n.entry.all = mydat1[1,"n.entry.all"] + mydat2[1,"n.entry.all"]
				n.entry.all
				#[1] 183077

				# > mydat1[1,"n.entry.all"]
				# [1] 94010
				# > mydat2[1,"n.entry.all"]
				# [1] 89067

				MF = N/n.entry.all
				MF
				#[1] 0.5462183

				mydat.all.norm = cbind(scenario=sc1, n.total=rep(n.total,nrow(mydat1)),n.entry.all=rep(n.entry.all,nrow(mydat1)),mydat.all.abs*MF)
				mydat.all.norm[1:5,]
				#        scenario   n.case PercentScreened100 LCcases.noscreen90 LCdeaths.noscreen90 LCcases90 LCcases.sdet90 LCcasesOver90
				# 1 A-45-75-10-10 15874.17           36.93637           5856.609             4530.89  5963.690       2136.135      109.0815
				# 2 A-45-75-10-15 15874.17           39.78504           5856.609             4530.89  5972.717       2319.296      117.6220
				# 3 A-45-75-10-20 15874.17           41.15478           5856.609             4530.89  5982.258       2458.809      127.1625
				# 4 A-45-75-10-25 15874.17           41.38749           5856.609             4530.89  5986.204       2564.674      131.1085
				# 5 A-45-75-20-10 15874.17           29.36824           5856.609             4530.89  5958.177       2026.891      103.0815
				#   LCdeaths90 PctEarlyStage90 Deaths.avoided90 LifeYearsSaved90 Alldeaths90 Alldeaths.case.noncase90
				# 1   4084.431        54.59858         446.9725         7131.973    15356.93                 76844.00
				# 2   4037.432        56.42236         493.9720         7907.748    15343.26                 76830.84
				# 3   4007.378        57.85047         524.0260         8360.475    15335.17                 76822.25
				# 4   3984.162        58.89317         546.7285         8717.608    15328.61                 76816.19
				# 5   4109.485        53.36830         420.9185         6647.785    15363.42                 76850.49
				#   LCdeathsSurgery_overDiag90 LCdeathsSurgery_sdet90 AlldeathsSurgery90 AlldeathsSurgery_noscreen90 EverScreened100
				# 1                      1.027                13.9730             35.135                      34.108        36936.37
				# 2                      1.027                14.9730             35.135                      34.108        39785.04
				# 3                      1.027                15.9460             35.135                      34.108        41154.78
				# 4                      1.027                16.4595             35.135                      34.108        41387.49
				# 5                      1.027                13.0000             35.135                      34.108        29368.24
				#   EverScreened90
				# 1       36936.37
				# 2       39785.04
				# 3       41154.78
				# 4       41387.49
				# 5       29368.24


				###### calculate mortality reduction

				MortReduct90 = mydat.all.norm[,"Deaths.avoided90"]/mydat.all.norm[,"LCdeaths.noscreen90"]

				mydat.final = cbind(mydat.all.norm, MortReduct90=MortReduct90*100)
				# > mydat.final[1:5,]
				#        scenario   n.case PercentScreened100 LCcases.noscreen90 LCdeaths.noscreen90 LCcases90 LCcases.sdet90 LCcasesOver90
				# 1 A-45-75-10-10 15874.17           36.93637           5856.609             4530.89  5963.690       2136.135      109.0815
				# 2 A-45-75-10-15 15874.17           39.78504           5856.609             4530.89  5972.717       2319.296      117.6220
				# 3 A-45-75-10-20 15874.17           41.15478           5856.609             4530.89  5982.258       2458.809      127.1625
				# 4 A-45-75-10-25 15874.17           41.38749           5856.609             4530.89  5986.204       2564.674      131.1085
				# 5 A-45-75-20-10 15874.17           29.36824           5856.609             4530.89  5958.177       2026.891      103.0815
				#   LCdeaths90 PctEarlyStage90 Deaths.avoided90 LifeYearsSaved90 Alldeaths90 Alldeaths.case.noncase90
				# 1   4084.431        54.59858         446.9725         7131.973    15356.93                 76844.00
				# 2   4037.432        56.42236         493.9720         7907.748    15343.26                 76830.84
				# 3   4007.378        57.85047         524.0260         8360.475    15335.17                 76822.25
				# 4   3984.162        58.89317         546.7285         8717.608    15328.61                 76816.19
				# 5   4109.485        53.36830         420.9185         6647.785    15363.42                 76850.49
				#   LCdeathsSurgery_overDiag90 LCdeathsSurgery_sdet90 AlldeathsSurgery90 AlldeathsSurgery_noscreen90 EverScreened100
				# 1                      1.027                13.9730             35.135                      34.108        36936.37
				# 2                      1.027                14.9730             35.135                      34.108        39785.04
				# 3                      1.027                15.9460             35.135                      34.108        41154.78
				# 4                      1.027                16.4595             35.135                      34.108        41387.49
				# 5                      1.027                13.0000             35.135                      34.108        29368.24
				#   EverScreened90 MortReduct90
				# 1       36936.37     9.865003
				# 2       39785.04    10.902316
				# 3       41154.78    11.565629
				# 4       41387.49    12.066689
				# 5       29368.24     9.289973




				#   n.total n.entry.all n.case LCcases.noscreen100 LCdeaths.noscreen100 PercentScreened100 CTscreens100 CTexams100 PctEarlyStage100 LCcases100
				# 1   2e+05      183077  31765               13143                10257              74.18      1318672    1506585           104.25      13358
				# 2   2e+05      183077  31765               13143                10257              79.92      1498544    1686473           107.50      13376
				# 3   2e+05      183077  31765               13143                10257              82.68      1666562    1854504           110.09      13395
				# 4   2e+05      183077  31765               13143                10257              83.15      1809159    1997109           111.95      13403
				# 5   2e+05      183077  31765               13143                10257              59.00      1086376    1274287           102.01      13347
				#   LCcases.sdet100 LCcases.sdet.eff100 LCdeaths100 LCcasesOver100 Deaths.avoided100 LifeYearsSaved100 MortReduct100 AlldeathsCase100
				# 1            4272             3367.98        9365            219               893          14210.07         17.41            34477
				# 2            4636             3653.59        9272            236               986          15744.45         19.20            34473
				# 3            4915             3874.30        9211            255              1046          16644.93         20.36            34471
				# 4            5126             4037.52        9166            263              1091          17354.27         21.23            34468
				# 5            4053             3185.09        9415            207               841          13243.31         16.41            34480
				#   AlldeathsNoncases100 Ratio.case.scrdet.per.CT100 Rario.deaths.avoided_case.scr100 LCcases.noscreen90 LCdeaths.noscreen90 CTscreens90 CTexams90
				# 1               192183                        0.66                            41.79              11688                9059     1318672   1506585
				# 2               192179                        0.63                            42.48              11688                9059     1498544   1686473
				# 3               192177                        0.60                            42.50              11688                9059     1666562   1854504
				# 4               192174                        0.58                            42.50              11688                9059     1809159   1997109
				# 5               192187                        0.76                            41.52              11688                9059     1086376   1274287
				#   PctEarlyStage90 LCcases90 LCcases.sdet90 LCcasesOver90 LCdeaths90 Deaths.avoided90 LifeYearsSaved90 MortReduct90 Alldeaths90
				# 1          109.06     11903           4272           219       8167              893            14210        15.33       30791
				# 2          112.70     11921           4636           236       8074              986            15745        16.88       30764
				# 3          115.57     11940           4915           255       8014             1046            16645        17.90       30748
				# 4          117.65     11948           5126           263       7968             1091            17355        18.66       30735
				# 5          106.58     11892           4053           207       8217              841            13244        14.45       30804
				#   Alldeaths.case.noncase90 prop.cdet.90 LCdeathsSurgery_overDiag90 LCdeathsSurgery_sdet90 AlldeathsSurgery90 AlldeathsSurgery_noscreen90
				# 1                   154066         1.27                          2                     28                 70                          68
				# 2                   154040         1.22                          2                     30                 70                          68
				# 3                   154023         1.17                          2                     32                 70                          68
				# 4                   154011         1.14                          2                     33                 70                          68
				# 5                   154079         1.31                          2                     26                 70                          68
				#



		}#end of


		mydat.final


}#end of funciton



myCombineGender <- function(file1,file2, mycolnames,N=100000){

		#mycolnames = c("scenario", "n.total","n.entry.all", "CTscreens90_abs","CTexams90_abs","LCcases90_abs","LCdeaths90_abs")

		mydat1=read.csv(file1)
		mydat2=read.csv(file2)

		# > colnames(mydat1)
		#  [1] "X"                                "NUM"                              "scenario"
		#  [4] "age.start"                        "age.stop"                         "age.interval"
		#  [7] "py"                               "ysq"                              "n.total"
		# [10] "n.entry.all"                      "n.case"                           "LCcases.noscreen100"
		# [13] "LCdeaths.noscreen100"             "PercentScreened100"               "CTscreens100"
		# [16] "CTexams100"                       "PctEarlyStage100"                 "LCcases100"
		# [19] "LCcases.sdet100"                  "LCcases.sdet.eff100"              "LCdeaths100"
		# [22] "LCcasesOver100"                   "Deaths.avoided100"                "LifeYearsSaved100"
		# [25] "MortReduct100"                    "AlldeathsCase100"                 "AlldeathsNoncases100"
		# [28] "Ratio.case.scrdet.per.CT100"      "Rario.deaths.avoided_case.scr100" "LCcases.noscreen90"
		# [31] "LCdeaths.noscreen90"              "CTscreens90"                      "CTexams90"
		# [34] "PctEarlyStage90"                  "LCcases90"                        "LCcases.sdet90"
		# [37] "LCcasesOver90"                    "LCdeaths90"                       "Deaths.avoided90"
		# [40] "LifeYearsSaved90"                 "MortReduct90"                     "Alldeaths90"
		# [43] "Alldeaths.case.noncase90"         "prop.cdet.90"                     "LCdeathsSurgery_overDiag90"
		# [46] "LCdeathsSurgery_sdet90"           "AlldeathsSurgery90"               "AlldeathsSurgery_noscreen90"
		# [49] "CTscreens90_abs"                  "CTexams90_abs"                    "LCcases90_abs"
		# [52] "LCdeaths90_abs"
		# > mydat1[,1:10]
		#         X NUM      scenario age.start age.stop age.interval py ysq n.total n.entry.all
		# 1           1 A-45-75-10-10        45       75            1 10  10   1e+05       94010
		# 2 output2   2 A-45-75-10-15        45       75            1 10  15   1e+05       94010


		mydat1b=mydat1[,mycolnames]
		#        scenario n.total n.entry.all CTscreens90_abs CTexams90_abs LCcases90_abs LCdeaths90_abs
		# 1 A-45-75-10-10   1e+05       94010          539196        627542          6019           3871
		# 2 A-45-75-10-15   1e+05       94010          611862        700221          6029           3810



		mydat2b=mydat2[,mycolnames]
		#        scenario n.total n.entry.all CTscreens90_abs CTexams90_abs LCcases90_abs LCdeaths90_abs
		# 1 A-45-75-10-10   1e+05       89067          663656        747324          4899           3606
		# 2 A-45-75-10-15   1e+05       89067          755017        838687          4906           3581


		sc1=as.character(mydat1b[,1])
		sc2=as.character(mydat2b[,1])
		# > sc1
		# [1] "A-45-75-10-10" "A-45-75-10-15"
		# > sc2
		# [1] "A-45-75-10-10" "A-45-75-10-15"


		##### if both have identical scenarios, combine ###

		if(all(sc1==sc2)==T){


				#### combine two absoulte numbers

				mydat.all0 = mydat1b[,-1] + mydat2b[,-1]
				mydat.all0
				#   n.total n.entry.all CTscreens90_abs CTexams90_abs LCcases90_abs LCdeaths90_abs
				# 1   2e+05      183077         1202852       1374866         10918           7477
				# 2   2e+05      183077         1366879       1538908         10935           7391

				#### normalizing factor ###

				mf = N/mydat.all0[1,"n.entry.all"]
				mf
				#[1]  0.5462183

				# > mydat.all0[1,"n.entry.all"]
				# [1] 183077


				mydat.all = mydat.all0[,-c(1:2)]*mf

				# > mydat.all
				#   CTscreens90_abs CTexams90_abs LCcases90_abs LCdeaths90_abs
				# 1        657019.7      750976.9      5963.611       4084.074
				# 2        746614.3      840579.6      5972.897       4037.099
				#


				###### compare to gender specific normalization per 100K #######

				#mydat1[,c("CTscreens90","CTexams90","LCcases90","LCdeaths90")]   # female
				#   CTscreens90 CTexams90 LCcases90 LCdeaths90
				# 1      573552    667527      6403       4118
				# 2      650848    744837      6413       4053
				#mydat2[,c("CTscreens90","CTexams90","LCcases90","LCdeaths90")]   ## male
				#   CTscreens90 CTexams90 LCcases90 LCdeaths90
				# 1      745120    839058      5500       4049
				# 2      847696    941636      5508       4021

				colnames(mydat.all)=gsub("_abs","",colnames(mydat.all))
				row.names(mydat.all)=sc1

				####### deaths avoided ##########
				indic.noscreen = sc1 %in% "noscreen"

				Deaths.avoided90 = mydat.all[indic.noscreen,"LCdeaths90"] - mydat.all[,"LCdeaths90"]




				mydat.all=cbind(mydat.all,Deaths.avoided90 =Deaths.avoided90 )


		}#end of


}#end of funciton


#xx=c("a","b","c")
#yy=c("a","dd","b","x","xc")

multiGrep=function(xx,yy,SORT=F){

       out=NULL
       for(u in 1:length(xx)){

              tm1=xx[u]
              tm2=grep(tm1,yy)
              if(u==1) out=tm2
              if(u>1) out=c(out,tm2)

       }# end of u loop

       out2=unique(out)
       if(SORT==T) out2=sort(out2)

       out2


}# end of multiGrep

#multiGrep(xx,yy)
#> multiGrep(xx,yy)
#[1] 1 3 5
#> xx
#[1] "a" "b" "c"
#> yy
#[1] "a"  "dd" "b"  "x"  "xc"


          ############ 4/2/2012: handle NAs #######################

          myStrataVar=function(xx){  ## from dummy variable matrix, create a single factor variable!


              #> xx[1:5,]
              #  STUDY_CPSII STUDY_EAGLE STUDY_PLCO
              #1           0           0          1
              #2           0           0          1
              #3           0           0          1
              #4           0           0          1
              #5           0           0          1

              xx2=xx
              #> xx[1:10,]
              #      cig_former cig_current
              # [1,]          0           1
              # [2,]          0           1
              # [3,]          0           1
              # [4,]          0           1
              # [5,]          0           1
              # [6,]          0           1
              # [7,]          0           1
              # [8,]          0           1
              # [9,]          0           1
              #[10,]          0           1

              ############# [1] Create reference dummy variable first in case it doesn't have one #######

              if(sum(rowSums(xx)==0,na.rm=T) >0)  { # # then referenece variable is not included in this matrix --> make it then

                    yy = rep(0,nrow(xx))
                    yy[rowSums(xx)==0] = 1
                    xx2=cbind(strata1=yy,xx)
                    xx2[1:5,]
                    #  strata1 STUDY_CPSII STUDY_EAGLE STUDY_PLCO
                    #1  0           0           0          1
                    #2  0           0           0          1
                    #3  0           0           0          1
                    #4  0           0           0          1
                    #5  0           0           0          1


                    sum(rowSums(xx2)>1)
                    #[1] 0
                    sum(rowSums(xx2)==0)
                    #[1] 0

              }# end of


              ############ a single factor variable ############################

              stVar=rep(NA,nrow(xx2))

              for(u in 1:ncol(xx2)){

                    indic=(xx2[,u]==1)
                    stVar[indic] = u

              }# end of u
              table(stVar)
              #stVar
              #   1    2    3    4
              #3003 1371 3899 3197

              ans=list(stVar=as.factor(stVar), designMat=xx2)
              ans



}# end of myStrataVar


#tt=myStrataVar(xx)
#> names(tt)
#[1] "stVar"     "designMat"
#> tt[[1]][1:5]
#[1] 4 4 4 4 4
#> table(tt[[1]])
#
#   1    2    3    4
#3003 1371 3899 3197
#> tt[[2]][1:5,]
#  strata1 STUDY_CPSII STUDY_EAGLE STUDY_PLCO
#1       0           0           0          1
#2       0           0           0          1
#3       0           0           0          1
#4       0           0           0          1
#5       0           0           0          1
#> xx[1:5,]
#  STUDY_CPSII STUDY_EAGLE STUDY_PLCO
#1           0           0          1
#2           0           0          1
#3           0           0          1
#4           0           0          1
#5           0           0          1






# 		runTSCE_NHS <- function(smkdat, TSCE.pars){
#
#
# 				######### smoking data
#
#
# 				smkdat[1:20,]
# 				# > smkdat[1:20,]
# 				#        YOB ageentry age_start age_quit2 smkstatus past.cpd 1976 1978 1980 1982 1984 1986 1988 1990 1992 1994 1996 1998 2000 2002 2004 2006 2008
# 				#  [1,] 1927     48.5        NA        NA         1       NA  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
# 				#  [2,] 1929     47.3        NA        NA         1       NA  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
# 				#  [3,] 1928     47.6        18        50         2    39.50 39.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
# 				#  [4,] 1923     52.7        NA        NA         1       NA  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
# 				#  [5,] 1942     34.4        18        48         2    26.64 29.5 39.5 19.5 19.5 19.5 29.5 29.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
# 				#  [6,] 1931     44.6        18        51         2    19.50 19.5 19.5 19.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
# 				#  [7,] 1944     32.1        18        26         2     9.50  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
# 				#  [8,] 1938     38.3        NA        NA         1       NA  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
# 				#  [9,] 1939     37.2        20        69         2    19.50 29.5 19.5 29.5 19.5 19.5 19.5 29.5 29.5  9.5 29.5 19.5 19.5  9.5  9.5  9.5  9.5  0.0
# 				# [10,] 1921     55.1        20        NA         3    26.56 39.5 29.5 39.5 19.5 29.5 19.5 19.5 19.5 29.5 29.5 19.5 19.5 29.5 19.5 29.5 29.5 29.5
# 				# [11,] 1936     40.8        22        26         2     9.50  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
# 				# [12,] 1939     37.0        19        22         2     2.50  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
# 				# [13,] 1933     43.4        NA        NA         1       NA  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
# 				# [14,] 1929     47.4        18        59         2    22.79 29.5 29.5 39.5 29.5 19.5  9.5  0.0  2.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
# 				# [15,] 1931     44.9        18        47         2     9.50  9.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
# 				# [16,] 1931     44.7        NA        NA         1       NA  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
# 				# [17,] 1933     43.3        21        25         2    19.50  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
# 				# [18,] 1923     53.4        18        55         2    19.50 19.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
# 				# [19,] 1923     52.6        NA        NA         1       NA  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
# 				# [20,] 1942     33.7        17        42         2    19.50 19.5 19.5 19.5 19.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
#
#
#
# 				# > TSCE.pars
# 				# [1] 3.0000e+00 9.5545e-02 8.3416e-08 1.6200e-01 4.8920e-01 1.1380e-01 6.2540e-01
#

				runTSCE_NHS_small=function(x, max.age, cpd.cols,doPlot,MAIN=""){

						# > x
						#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982      1984      1986      1988      1990      1992      1994
						#   1942.50     34.40     18.00     47.50      2.00     26.64     29.50     39.50     19.50     19.50     19.50     29.50     29.50      0.00      0.00      0.00
						#      1996      1998      2000      2002      2004      2006      2008
						#      0.00      0.00      0.00      0.00      0.00      0.00      0.00

						# > cpd.cols
						#  [1]  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23


						cpd=x[cpd.cols]

						cpd
						# 1976 1978 1980 1982 1984 1986 1988 1990 1992 1994 1996 1998 2000 2002 2004 2006 2008
						# 29.5 39.5 19.5 19.5 19.5 29.5 29.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0

						# 	1976 1978 1980 1982 1984 1986 1988 1990 1992 1994 1996 1998 2000 2002 2004 2006 2008
						# 39.5 29.5 39.5 19.5 29.5 19.5 19.5 19.5 29.5 29.5 19.5 19.5 29.5 19.5 29.5 29.5 29.5

						# x  j=49
						#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982
						#    1937.0      39.6      19.0      22.0       2.0      19.5       0.0       0.0       9.5       0.0
						#      1984      1986      1988      1990      1992      1994      1996      1998      2000      2002
						#       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0
						#      2004      2006      2008
						#       0.0       0.0       0.0
						# >
					# > j=5698
					# >
					# > x=smkdat[j,]
					# > x
					#       id2       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982      1984      1986      1988      1990      1992      1994      1996
					#    5698.0    1944.0      32.2      17.0      32.0       2.0      19.5       0.0       0.0      19.5      19.5      19.5      19.5       0.0       0.0       0.0       0.0       0.0
					#      1998      2000      2002      2004      2006      2008
					#       0.0       0.0       0.0      19.5       0.0      19.5

						################## [1] Make Profile #########################################################
						profile=ags=dos=ags2=dos2=NULL

									######### (1) Make a profile for the argument ###########
									######### Make profile = list( breaks, dose) for each individual which is an argment for p2.plot() ######
									# former smoker: profile <- list(breaks=c(20,45,100),dose=c(0,40,0)): until age 20, dose=0, until age 45, dose 40, then quit
									# current smoker: profile <- list(breaks=c(20,100),dose=c(0,20)):    until age 20, dose was 0 and from then on to 100, dose was 20 (current smoker)

						status = x["smkstatus"]

						if(status==1){   ## never smoked:

							  profile = list(breaks=c(max.age-1, max.age), dose=c(0, 0))   # there is no starting age, so I gave just start.age=109 and death.age=110


						}#end of


						if(status==2 ){   # smoked but quit at some point of her life

									 ######## (1)  assign age to year 1976 - 2008 ##########

									# > x["ageentry"]
									# ageentry
									#     34.4
									ages = seq((x["ageentry"]),  (x["ageentry"])+(2008-1976), by=2)
									ages
									#   [1]  34.4 36.4 38.4 40.4 42.4 44.4 46.4 48.4 50.4 52.4 54.4 56.4 58.4 60.4 62.4 64.4 66.4
									# > length(ages)
									# [1] 17
									# > length(cpd)
									# [1] 17

									cpd2=cpd
									names(cpd2)=ages
									cpd2
									# 34.4 36.4 38.4 40.4 42.4 44.4 46.4 48.4 50.4 52.4 54.4 56.4 58.4 60.4 62.4 64.4 66.4
									# 29.5 39.5 19.5 19.5 19.5 29.5 29.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0

									# 32 34 36 38 40 42 44 46 48 50 52 54 56 58 60 62 64
									#  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0
									# > x
									#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982      1984      1986      1988      1990      1992      1994
									#    1944.0      32.1      18.0      26.0       2.0       9.5       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0
									#      1996      1998      2000      2002      2004      2006      2008
									#       0.0       0.0       0.0       0.0       0.0       0.0       0.0



									#######(2) For people who quit before the entry ######################

									if(sum(cpd2,na.rm=T)==0 ){  ### all cpd2 is zero, then he quit before trial

										 profile=list(breaks=c(as.vector(x["age_start"]),as.vector(x["age_quit2"]),max.age),
												dose=c(0, as.vector(x["past.cpd"]), 0))

										# > profile
										# $breaks
										# [1]  18  26 110
										#
										# $dose
										# [1] 0.0 9.5 0.0
										# > x
										#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982      1984      1986      1988      1990      1992      1994
										#    1944.0      32.1      18.0      26.0       2.0       9.5       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0
										#      1996      1998      2000      2002      2004      2006      2008
										#       0.0       0.0       0.0       0.0       0.0       0.0       0.0


									}#end of


									##### (3) for peple who quit smoking during the entry ################

									if(sum(cpd2,na.rm=T) >0){   ## some cpd is not zero during trial

											#cpd2
											# 34.4 36.4 38.4 40.4 42.4 44.4 46.4 48.4 50.4 52.4 54.4 56.4 58.4 60.4 62.4 64.4 66.4
											# 29.5 39.5 19.5 19.5 19.5 29.5 29.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0

											###### this is tricky....
											# cpd2
											# 32.2 34.2 36.2 38.2 40.2 42.2 44.2 46.2 48.2 50.2 52.2 54.2 56.2 58.2 60.2 62.2 64.2
											#  0.0  0.0 19.5 19.5 19.5 19.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0 19.5  0.0 19.5


											myrow = min(which(cpd2==0))
											myrow
											#[1] 8  # 8th element gives zero
											quit.age = as.numeric(min(names(cpd2)[myrow]))
											quit.age
											#[1] 48.4

											### if year quit after 1976
											if(myrow > 1) {

											   ags = as.numeric(names(cpd2)[1:(myrow-1)])
											   ags
											   #[1] 34.4 36.4 38.4 40.4 42.4 44.4 46.4

											   dos = as.vector(cpd2[1:(myrow-1)])
											   dos
											   #[1] 29.5 39.5 19.5 19.5 19.5 29.5 29.5

												profile=list(breaks=c(as.vector(x["age_start"]), ags, quit.age, max.age),
																dose = c(0, as.vector(x["past.cpd"]),dos, 0))

												profile

												# 				> profile
												# $breaks
												#  [1]  18.0  34.4  36.4  38.4  40.4  42.4  44.4  46.4  48.4 110.0
												#
												# $dose
												#  [1]  0.00 26.64 29.50 39.50 19.50 19.50 19.50 29.50 29.50  0.00

												length(profile$breaks)
												#[1] 20
												length(profile$dose)
												# > x
												#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982      1984      1986      1988      1990      1992      1994
												#   1942.00     34.40     18.00     48.00      2.00     26.64     29.50     39.50     19.50     19.50     19.50     29.50     29.50      0.00      0.00      0.00
												#      1996      1998      2000      2002      2004      2006      2008
												#      0.00      0.00      0.00      0.00      0.00      0.00      0.00
												# > cpd2
												# 34.4 36.4 38.4 40.4 42.4 44.4 46.4 48.4 50.4 52.4 54.4 56.4 58.4 60.4 62.4 64.4 66.4
												# 29.5 39.5 19.5 19.5 19.5 29.5 29.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0


											 }

											# ####### cpd2 = 0 starting from 1976
											# some people reported they quit before entry, but actually smoking some more....
											 if(myrow == 1) {   ## some

											    ## first element is 0, but later no zeros are there

												# > cpd2
												# 39.6 41.6 43.6 45.6 47.6 49.6 51.6 53.6 55.6 57.6 59.6 61.6 63.6 65.6 67.6 69.6 71.6
												#  0.0  0.0  9.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0

												# > x
												#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982
												#    1937.0      39.6      19.0      22.0       2.0      19.5       0.0       0.0       9.5       0.0
												#      1984      1986      1988      1990      1992      1994      1996      1998      2000      2002
												#       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0
												#      2004      2006      2008
												#       0.0       0.0       0.0


												### identify real quit age again ###

												## last year smoked
												myrow2 = max(which(cpd2!=0))
												#[1] 3

												## identify age real quit smoking ##

												quit.age2 = min(as.numeric(names(which(which(cpd2==0) > myrow2))))
												quit.age2
												#[1] 45.6


												## take all the ages to be used in profile
												ags2 = as.numeric(names(cpd2))[as.numeric(names(cpd2)) <= quit.age2]
												ags2
												#[1] 39.6 41.6 43.6 45.6
												dos2 = cpd2[as.numeric(names(cpd2)) <= quit.age2]
												dos2
												# 39.6 41.6 43.6 45.6
												#  0.0  0.0  9.5  0.0

												profile=list(breaks=c(as.vector(x["age_start"]), as.vector(x["age_quit2"]), ags2, quit.age, max.age),
																dose = c(0, as.vector(x["past.cpd"]),as.vector(x["past.cpd"]),as.vector(dos2), 0))
																# need to do past.cpd twice (see below)

												# > profile
												# $breaks
												# [1]  19.0  22.0  39.6  41.6  43.6  45.6  39.6 110.0
												#
												# $dose
												# [1]  0.0 19.5 19.5  0.0  0.0  9.5  0.0  0.0
												#
												# > cbind(profile[[1]],profile[[2]])
												#       [,1] [,2]
												# [1,]  19.0  0.0
												# [2,]  22.0 19.5
												# [3,]  39.6 19.5  <- twice
												# [4,]  41.6  0.0
												# [5,]  43.6  0.0
												# [6,]  45.6  9.5
												# [7,]  39.6  0.0
												# [8,] 110.0  0.0

											  }



											# > cbind(profile$breaks, profile$dose)
											#        [,1]  [,2]
											#  [1,]  18.0  0.00
											#  [2,]  34.4 26.64
											#  [3,]  36.4 29.50
											#  [4,]  38.4 39.50
											#  [5,]  40.4 19.50
											#  [6,]  42.4 19.50
											#  [7,]  44.4 19.50
											#  [8,]  46.4 29.50
											#  [9,]  48.4 29.50
											# [10,] 110.0  0.00


									}#end of


							}#end of if(status==2 ){


						if(status==3 ){   # who never quit #########



									 ######## (1)  assign age to year 1976 - 2008 ##########

									# > x["ageentry"]
									# ageentry
									#     34.4
									ages = seq((x["ageentry"]),  (x["ageentry"])+(2008-1976), by=2)
									ages
									#   [1]  34.4 36.4 38.4 40.4 42.4 44.4 46.4 48.4 50.4 52.4 54.4 56.4 58.4 60.4 62.4 64.4 66.4
									# > length(ages)
									# [1] 17
									# > length(cpd)
									# [1] 17

									cpd2=cpd
									names(cpd2)=ages
									cpd2
									# 55.1 57.1 59.1 61.1 63.1 65.1 67.1 69.1 71.1 73.1 75.1 77.1 79.1 81.1 83.1 85.1 87.1
									# 39.5 29.5 39.5 19.5 29.5 19.5 19.5 19.5 29.5 29.5 19.5 19.5 29.5 19.5 29.5 29.5 29.5

							### assume the doage at the last observation continuses until death


									profile=list(breaks=c(as.vector(x["age_start"]), as.vector(ages),  max.age),
													dose = c(0, as.vector(x["past.cpd"]),as.vector(cpd2) ))

									profile
									# > profile
									# $breaks
									#  [1]  20.0  55.1  57.1  59.1  61.1  63.1  65.1  67.1  69.1  71.1  73.1  75.1  77.1  79.1  81.1  83.1  85.1  87.1 110.0
									#
									# $dose
									#  [1]  0.00 26.56 39.50 29.50 39.50 19.50 29.50 19.50 19.50 19.50 29.50 29.50 19.50 19.50 29.50 19.50 29.50 29.50 29.50

									length(profile$breaks)
									#[1] 20
									length(profile$dose)
									#[1] 20
									# > x
									#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982      1984      1986      1988      1990      1992      1994
									#   1921.00     55.10     20.00        NA      3.00     26.56     39.50     29.50     39.50     19.50     29.50     19.50     19.50     19.50     29.50     29.50
									#      1996      1998      2000      2002      2004      2006      2008
									#     19.50     19.50     29.50     19.50     29.50     29.50     29.50

									# > cpd2
									# 55.1 57.1 59.1 61.1 63.1 65.1 67.1 69.1 71.1 73.1 75.1 77.1 79.1 81.1 83.1 85.1 87.1
									# 39.5 29.5 39.5 19.5 29.5 19.5 19.5 19.5 29.5 29.5 19.5 19.5 29.5 19.5 29.5 29.5 29.5
									# > cbind(profile$breaks, profile$dose)
									#        [,1]  [,2]
									#  [1,]  20.0  0.00
									#  [2,]  55.1 26.56
									#  [3,]  57.1 39.50
									#  [4,]  59.1 29.50
									#  [5,]  61.1 39.50
									#  [6,]  63.1 19.50
									#  [7,]  65.1 29.50
									#  [8,]  67.1 19.50
									#  [9,]  69.1 19.50
									# [10,]  71.1 19.50
									# [11,]  73.1 29.50
									# [12,]  75.1 29.50
									# [13,]  77.1 19.50
									# [14,]  79.1 19.50
									# [15,]  81.1 29.50
									# [16,]  83.1 19.50
									# [17,]  85.1 29.50
									# [18,]  87.1 29.50
									# [19,] 110.0 29.50


						}#end of


						profile
						# > profile
						# $breaks
						#  [1]  20.0  55.1  57.1  59.1  61.1  63.1  65.1  67.1  69.1  71.1  73.1  75.1  77.1  79.1  81.1  83.1  85.1  87.1 110.0
						#
						# $dose
						#  [1]  0.00 26.56 39.50 29.50 39.50 19.50 29.50 19.50 19.50 19.50 29.50 29.50 19.50 19.50 29.50 19.50 29.50 29.50 29.50

						################ [2] Run TSCE model for getting hazard ###########################


						  model = model.NHSHPFS
						  pars=TSCE.pars

						  age=c(1:max.age)  # this will calculate from 1 to death.age
						  hz=h2.plot(model,pars,profile,age,plt=F)


						  names(hz)=age


							if(doPlot==T) {

							   plot(age,hz,type="l",main=paste(MAIN,"Hazard",sep=" "),ylab="Hazard",xlab="Age",col="red")
							   abline(v=profile[[1]],col=c("red","blue","black"),lty="dotted",lwd=1.5)
							   title(sub=paste("dose:",paste(profile$dose,collapse="-"),sep=""))


							   legend(x="topleft",legend=c("Hazard","pdf"),fill=c("red","blue"),bg="white")


							}# end of plot

						   #names(pmf)=paste(age[-1])

						   ans=list(hz=hz, prof=cbind(profile[[1]],profile[[2]]))

							ans


				}#end of small function runTSCE_NHS_small



	myProfile.NHSPF_female=function(x, max.age, cpd.cols){

			# > x
			#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982      1984      1986      1988      1990      1992      1994
			#   1942.50     34.40     18.00     47.50      2.00     26.64     29.50     39.50     19.50     19.50     19.50     29.50     29.50      0.00      0.00      0.00
			#      1996      1998      2000      2002      2004      2006      2008
			#      0.00      0.00      0.00      0.00      0.00      0.00      0.00

			# > cpd.cols
			#  [1]  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23


			cpd=x[cpd.cols]

			cpd
			# 1976 1978 1980 1982 1984 1986 1988 1990 1992 1994 1996 1998 2000 2002 2004 2006 2008
			# 29.5 39.5 19.5 19.5 19.5 29.5 29.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0

			# 	1976 1978 1980 1982 1984 1986 1988 1990 1992 1994 1996 1998 2000 2002 2004 2006 2008
			# 39.5 29.5 39.5 19.5 29.5 19.5 19.5 19.5 29.5 29.5 19.5 19.5 29.5 19.5 29.5 29.5 29.5

			# x  j=49
			#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982
			#    1937.0      39.6      19.0      22.0       2.0      19.5       0.0       0.0       9.5       0.0
			#      1984      1986      1988      1990      1992      1994      1996      1998      2000      2002
			#       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0
			#      2004      2006      2008
			#       0.0       0.0       0.0
			# >
		# > j=5698
		# >
		# > x=smkdat[j,]
		# > x
		#       id2       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982      1984      1986      1988      1990      1992      1994      1996
		#    5698.0    1944.0      32.2      17.0      32.0       2.0      19.5       0.0       0.0      19.5      19.5      19.5      19.5       0.0       0.0       0.0       0.0       0.0
		#      1998      2000      2002      2004      2006      2008
		#       0.0       0.0       0.0      19.5       0.0      19.5

			################## [1] Make Profile #########################################################
			profile=ags=dos=ags2=dos2=NULL

						######### (1) Make a profile for the argument ###########
						######### Make profile = list( breaks, dose) for each individual which is an argment for p2.plot() ######
						# former smoker: profile <- list(breaks=c(20,45,100),dose=c(0,40,0)): until age 20, dose=0, until age 45, dose 40, then quit
						# current smoker: profile <- list(breaks=c(20,100),dose=c(0,20)):    until age 20, dose was 0 and from then on to 100, dose was 20 (current smoker)

			status = x["smkstatus"]

			if(status==1){   ## never smoked:

				  profile = list(breaks=c(max.age-1, max.age), dose=c(0, 0))   # there is no starting age, so I gave just start.age=109 and death.age=110


			}#end of


			if(status==2 ){   # smoked but quit at some point of her life

						 ######## (1)  assign age to year 1976 - 2008 ##########

						# > x["ageentry"]
						# ageentry
						#     34.4
						ages = seq((x["ageentry"]),  (x["ageentry"])+(2008-1976), by=2)
						ages
						#   [1]  34.4 36.4 38.4 40.4 42.4 44.4 46.4 48.4 50.4 52.4 54.4 56.4 58.4 60.4 62.4 64.4 66.4
						# > length(ages)
						# [1] 17
						# > length(cpd)
						# [1] 17

						cpd2=cpd
						names(cpd2)=ages
						cpd2
						# 34.4 36.4 38.4 40.4 42.4 44.4 46.4 48.4 50.4 52.4 54.4 56.4 58.4 60.4 62.4 64.4 66.4
						# 29.5 39.5 19.5 19.5 19.5 29.5 29.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0

						# 32 34 36 38 40 42 44 46 48 50 52 54 56 58 60 62 64
						#  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0
						# > x
						#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982      1984      1986      1988      1990      1992      1994
						#    1944.0      32.1      18.0      26.0       2.0       9.5       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0
						#      1996      1998      2000      2002      2004      2006      2008
						#       0.0       0.0       0.0       0.0       0.0       0.0       0.0



						#######(2) For people who quit before the entry ######################

						if(sum(cpd2,na.rm=T)==0 ){  ### all cpd2 is zero, then he quit before trial

							 profile=list(breaks=c(as.vector(x["age_start"]),as.vector(x["age_quit2"]),max.age),
									dose=c(0, as.vector(x["past.cpd"]), 0))

							# > profile
							# $breaks
							# [1]  18  26 110
							#
							# $dose
							# [1] 0.0 9.5 0.0
							# > x
							#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982      1984      1986      1988      1990      1992      1994
							#    1944.0      32.1      18.0      26.0       2.0       9.5       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0
							#      1996      1998      2000      2002      2004      2006      2008
							#       0.0       0.0       0.0       0.0       0.0       0.0       0.0


						}#end of


						##### (3) for peple who quit smoking during the entry ################

						if(sum(cpd2,na.rm=T) >0){   ## some cpd is not zero during trial

								#cpd2
								# 34.4 36.4 38.4 40.4 42.4 44.4 46.4 48.4 50.4 52.4 54.4 56.4 58.4 60.4 62.4 64.4 66.4
								# 29.5 39.5 19.5 19.5 19.5 29.5 29.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0

								###### this is tricky....
								# cpd2
								# 32.2 34.2 36.2 38.2 40.2 42.2 44.2 46.2 48.2 50.2 52.2 54.2 56.2 58.2 60.2 62.2 64.2
								#  0.0  0.0 19.5 19.5 19.5 19.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0 19.5  0.0 19.5


								myrow = min(which(cpd2==0))
								myrow
								#[1] 8  # 8th element gives zero
								quit.age = as.numeric(min(names(cpd2)[myrow]))
								quit.age
								#[1] 48.4

								### if year quit after 1976
								if(myrow > 1) {

								   ags = as.numeric(names(cpd2)[1:(myrow-1)])
								   ags
								   #[1] 34.4 36.4 38.4 40.4 42.4 44.4 46.4

								   dos = as.vector(cpd2[1:(myrow-1)])
								   dos
								   #[1] 29.5 39.5 19.5 19.5 19.5 29.5 29.5

									profile=list(breaks=c(as.vector(x["age_start"]), ags, quit.age, max.age),
													dose = c(0, as.vector(x["past.cpd"]),dos, 0))

									profile

									# 				> profile
									# $breaks
									#  [1]  18.0  34.4  36.4  38.4  40.4  42.4  44.4  46.4  48.4 110.0
									#
									# $dose
									#  [1]  0.00 26.64 29.50 39.50 19.50 19.50 19.50 29.50 29.50  0.00

									length(profile$breaks)
									#[1] 20
									length(profile$dose)
									# > x
									#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982      1984      1986      1988      1990      1992      1994
									#   1942.00     34.40     18.00     48.00      2.00     26.64     29.50     39.50     19.50     19.50     19.50     29.50     29.50      0.00      0.00      0.00
									#      1996      1998      2000      2002      2004      2006      2008
									#      0.00      0.00      0.00      0.00      0.00      0.00      0.00
									# > cpd2
									# 34.4 36.4 38.4 40.4 42.4 44.4 46.4 48.4 50.4 52.4 54.4 56.4 58.4 60.4 62.4 64.4 66.4
									# 29.5 39.5 19.5 19.5 19.5 29.5 29.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0


								 }

								# ####### cpd2 = 0 starting from 1976
								# some people reported they quit before entry, but actually smoking some more....
								 if(myrow == 1) {   ## some

									## first element is 0, but later no zeros are there

									# > cpd2
									# 39.6 41.6 43.6 45.6 47.6 49.6 51.6 53.6 55.6 57.6 59.6 61.6 63.6 65.6 67.6 69.6 71.6
									#  0.0  0.0  9.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0

									# > x
									#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982
									#    1937.0      39.6      19.0      22.0       2.0      19.5       0.0       0.0       9.5       0.0
									#      1984      1986      1988      1990      1992      1994      1996      1998      2000      2002
									#       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0
									#      2004      2006      2008
									#       0.0       0.0       0.0


									### identify real quit age again ###

									## last year smoked
									myrow2 = max(which(cpd2!=0))
									#[1] 3

									## identify age real quit smoking ##

									quit.age2 = min(as.numeric(names(which(which(cpd2==0) > myrow2))))
									quit.age2
									#[1] 45.6


									## take all the ages to be used in profile
									ags2 = as.numeric(names(cpd2))[as.numeric(names(cpd2)) <= quit.age2]
									ags2
									#[1] 39.6 41.6 43.6 45.6
									dos2 = cpd2[as.numeric(names(cpd2)) <= quit.age2]
									dos2
									# 39.6 41.6 43.6 45.6
									#  0.0  0.0  9.5  0.0

									profile=list(breaks=c(as.vector(x["age_start"]), as.vector(x["age_quit2"]), ags2, quit.age, max.age),
													dose = c(0, as.vector(x["past.cpd"]),as.vector(x["past.cpd"]),as.vector(dos2), 0))
													# need to do past.cpd twice (see below)

									# > profile
									# $breaks
									# [1]  19.0  22.0  39.6  41.6  43.6  45.6  39.6 110.0
									#
									# $dose
									# [1]  0.0 19.5 19.5  0.0  0.0  9.5  0.0  0.0
									#
									# > cbind(profile[[1]],profile[[2]])
									#       [,1] [,2]
									# [1,]  19.0  0.0
									# [2,]  22.0 19.5
									# [3,]  39.6 19.5  <- twice
									# [4,]  41.6  0.0
									# [5,]  43.6  0.0
									# [6,]  45.6  9.5
									# [7,]  39.6  0.0
									# [8,] 110.0  0.0

								  }



								# > cbind(profile$breaks, profile$dose)
								#        [,1]  [,2]
								#  [1,]  18.0  0.00
								#  [2,]  34.4 26.64
								#  [3,]  36.4 29.50
								#  [4,]  38.4 39.50
								#  [5,]  40.4 19.50
								#  [6,]  42.4 19.50
								#  [7,]  44.4 19.50
								#  [8,]  46.4 29.50
								#  [9,]  48.4 29.50
								# [10,] 110.0  0.00


						}#end of


				}#end of if(status==2 ){


			if(status==3 ){   # who never quit #########



						 ######## (1)  assign age to year 1976 - 2008 ##########

						# > x["ageentry"]
						# ageentry
						#     34.4
						ages = seq((x["ageentry"]),  (x["ageentry"])+(2008-1976), by=2)
						ages
						#   [1]  34.4 36.4 38.4 40.4 42.4 44.4 46.4 48.4 50.4 52.4 54.4 56.4 58.4 60.4 62.4 64.4 66.4
						# > length(ages)
						# [1] 17
						# > length(cpd)
						# [1] 17

						cpd2=cpd
						names(cpd2)=ages
						cpd2
						# 55.1 57.1 59.1 61.1 63.1 65.1 67.1 69.1 71.1 73.1 75.1 77.1 79.1 81.1 83.1 85.1 87.1
						# 39.5 29.5 39.5 19.5 29.5 19.5 19.5 19.5 29.5 29.5 19.5 19.5 29.5 19.5 29.5 29.5 29.5

				### assume the doage at the last observation continuses until death


						profile=list(breaks=c(as.vector(x["age_start"]), as.vector(ages),  max.age),
										dose = c(0, as.vector(x["past.cpd"]),as.vector(cpd2) ))

						profile
						# > profile
						# $breaks
						#  [1]  20.0  55.1  57.1  59.1  61.1  63.1  65.1  67.1  69.1  71.1  73.1  75.1  77.1  79.1  81.1  83.1  85.1  87.1 110.0
						#
						# $dose
						#  [1]  0.00 26.56 39.50 29.50 39.50 19.50 29.50 19.50 19.50 19.50 29.50 29.50 19.50 19.50 29.50 19.50 29.50 29.50 29.50

						length(profile$breaks)
						#[1] 20
						length(profile$dose)
						#[1] 20
						# > x
						#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982      1984      1986      1988      1990      1992      1994
						#   1921.00     55.10     20.00        NA      3.00     26.56     39.50     29.50     39.50     19.50     29.50     19.50     19.50     19.50     29.50     29.50
						#      1996      1998      2000      2002      2004      2006      2008
						#     19.50     19.50     29.50     19.50     29.50     29.50     29.50

						# > cpd2
						# 55.1 57.1 59.1 61.1 63.1 65.1 67.1 69.1 71.1 73.1 75.1 77.1 79.1 81.1 83.1 85.1 87.1
						# 39.5 29.5 39.5 19.5 29.5 19.5 19.5 19.5 29.5 29.5 19.5 19.5 29.5 19.5 29.5 29.5 29.5
						# > cbind(profile$breaks, profile$dose)
						#        [,1]  [,2]
						#  [1,]  20.0  0.00
						#  [2,]  55.1 26.56
						#  [3,]  57.1 39.50
						#  [4,]  59.1 29.50
						#  [5,]  61.1 39.50
						#  [6,]  63.1 19.50
						#  [7,]  65.1 29.50
						#  [8,]  67.1 19.50
						#  [9,]  69.1 19.50
						# [10,]  71.1 19.50
						# [11,]  73.1 29.50
						# [12,]  75.1 29.50
						# [13,]  77.1 19.50
						# [14,]  79.1 19.50
						# [15,]  81.1 29.50
						# [16,]  83.1 19.50
						# [17,]  85.1 29.50
						# [18,]  87.1 29.50
						# [19,] 110.0 29.50


			}#end of


			profile
			# > profile
			# $breaks
			#  [1]  20.0  55.1  57.1  59.1  61.1  63.1  65.1  67.1  69.1  71.1  73.1  75.1  77.1  79.1  81.1  83.1  85.1  87.1 110.0
			#
			# $dose
			#  [1]  0.00 26.56 39.50 29.50 39.50 19.50 29.50 19.50 19.50 19.50 29.50 29.50 19.50 19.50 29.50 19.50 29.50 29.50 29.50


	}#end of small function myProfile

					runTSCE_NHS_small.MALE=function(x, max.age, cpd.past.cols,  cpd.current.cols, doPlot,MAIN=""){



					### possibly use :
					#myProfile.NHSPF_male function to get profile

						### never smoker ##
						# > x
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
						#         "1"      "1921"      "65.4"          NA        " 1"          NA          NA          NA          NA          NA          NA          NA
						#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
						#          NA         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
						#        2008
						#         "0"

						### smokers, but quit before the trial ###
						#        id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
						#        "22"      "1936"      "50.2"      "45.2"        " 3"         "0"        "45"        "45"         "0"         "0"         "0"          NA
						#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
						#      "45.5"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
						#        2008
						#         "0"
						# > x
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
						#        "16"      "1917"      "69.3"      "66.3"        " 3"          NA          NA      "19.5"      "19.5"      "19.5"          NA          NA
						#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
						#      "19.5"         "0"         "0"         "0"         "0"      "19.5"      "19.5"         "0"         "0"         "0"         "0"         "0"
						#        2008
						#         "0"

						# > x
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
						#        "11"      "1946"      "40.5"      "38.5"        " 3"          NA          NA          NA      "19.5"          NA          NA          NA
						#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
						#      "19.5"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
						#        2008
						#         "0"

						#  x=smkdat[69,]
						# > x
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15
						#        "69"      "1921"      "65.3"          NA        " 2"          NA
						#   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
						#      "39.5"      "39.5"        "45"        "45"      "39.5"      "39.5"
						#    past.cpd        1986        1988        1990        1992        1994
						#          NA      "39.5"      "39.5"      "39.5"      "39.5"      "39.5"
						#        1996        1998        2000        2002        2004        2006
						#      "39.5"      "39.5"      "39.5"      "39.5"      "39.5"      "39.5"
						#        2008
						#      "39.5"

						# > smkdat[151,]
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+    past.cpd        1986
						#       "151"      "1915"      "70.8"          NA        " 2"         "0"         "0"      "19.5"      "19.5"      "19.5"          NA          NA          NA         "0"
						#        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006        2008
						#         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
						# > x=smkdat[79,]
						# > x
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+    past.cpd        1986
						#        "79"      "1912"      "74.3"      "69.3"        " 3"         "0"         "0"      "19.5"      "29.5"      "39.5"        "45"        "45"      "45.5"         "0"
						#        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006        2008
						#         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
						# > x=smkdat[728,]
						# > x
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+    past.cpd        1986
						#       "728"      "1932"      "54.6"          NA          NA          NA          NA          NA          NA          NA          NA          NA          NA         "0"
						#        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006        2008
						#      "19.5"      "19.5"      "19.5"      "19.5"         "0"         "0"         "0"         "0"         "0"         "0"         "0"

						cpd.past = x[cpd.past.cols]
						cpd.current = x[cpd.current.cols]

						cpd.past
						cpd.current
						# > 						cpd.past
						# CPD_10_15 CPD_16_19 CPD_20_29 CPD_30_39 CPD_40_49 CPD_50_59  CPD_60_+
						#        NA        NA        NA        NA        NA        NA        NA
						# > 						cpd.current
						# 1986 1988 1990 1992 1994 1996 1998 2000 2002 2004 2006 2008
						#  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"


						# x  j=49
						#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982
						#    1937.0      39.6      19.0      22.0       2.0      19.5       0.0       0.0       9.5       0.0
						#      1984      1986      1988      1990      1992      1994      1996      1998      2000      2002
						#       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0
						#      2004      2006      2008
						#       0.0       0.0       0.0
						# >

						################## [1] Make Profile #########################################################
						profile=ags=dos=ags2=dos2=NULL

									######### (1) Make a profile for the argument ###########
									######### Make profile = list( breaks, dose) for each individual which is an argment for p2.plot() ######
									# former smoker: profile <- list(breaks=c(20,45,100),dose=c(0,40,0)): until age 20, dose=0, until age 45, dose 40, then quit
									# current smoker: profile <- list(breaks=c(20,100),dose=c(0,20)):    until age 20, dose was 0 and from then on to 100, dose was 20 (current smoker)

						### status at 1986 at entry ##
						status = as.numeric(x["smkstatus86"])
						status
						#smk86	 smoking 1=no  2=yes, current  3=yes, past


						###### some people have smoking status NA
						if(is.na(status)==T){
								# > x
								#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15
								#         "4"      "1922"      "63.4"          NA          NA          NA
								#   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
								#          NA          NA          NA          NA          NA          NA
								#    past.cpd        1986        1988        1990        1992        1994
								#          NA         "0"         "0"         "0"         "0"         "0"
								#        1996        1998        2000        2002        2004        2006
								#         "0"         "0"         "0"         "0"         "0"         "0"
								#        2008
								#         "0"

								# > smkdat[360,]
								#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15
								#       "360"      "1938"      "47.6"      "45.6"          NA         "0"
								#   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
								#       "2.5"      "19.5"       "9.5"       "2.5"          NA          NA
								#    past.cpd        1986        1988        1990        1992        1994
								#          NA         "0"         "0"         "0"         "0"         "0"
								#        1996        1998        2000        2002        2004        2006
								#         "0"         "0"         "0"         "0"         "0"         "0"
								#        2008
								#         "0"


								####### assign smoking status ########

								indic.nocurrent = (sum(as.numeric(cpd.current))==0)   # if all cpd is zero
								indic.nopast = sum(cpd.past!=0 & is.na(cpd.past)==F)==0    # there is no element which is no zoer or non NA
								indic.nocurrent
								indic.nopast

								if(indic.nopast==T & indic.nocurrent==T ){  # then this is no smoker

								     status = 1

								}


								if(indic.nopast==F & indic.nocurrent==T){  # then this is no smoker

								     status = 3   # previous smoker 3

								}

								if(indic.nopast==F & indic.nocurrent==F){  # then this is no smoker

								     status = 2   # current smoker 3

								}

								if(indic.nopast==F & indic.nocurrent==T){  # then this is no smoker

								     status = 3   # previous smoker 3

								}

								if(indic.nopast==T & indic.nocurrent==F){  # there is no past info, but started smoking during the trial

								     status = 2   # current smoker 3

								}




						}#3nd of


						if(status==1){   ## never smoked:

							profile = list(breaks=c(max.age-1, max.age), dose=c(0, 0))   # there is no starting age, so I gave just start.age=109 and death.age=110
							profile
							# $breaks
							# [1] 109 110 --> starting age 109 death age 110, but dosage below is zero anyway
							#
							# $dose
							# [1] 0 0


						}#end of


						####### smokers who (1) quit either before trial, (2) during tiral or (3) never quit
						if(status!=1){


								age_start=age_quit=ags2=dos2=ags3=ags4=dos3=dos4=NA

								######## (1) DEFINE some age variables for past cpd information ##################
								# > cpd.past
								# CPD_10_15 CPD_16_19 CPD_20_29 CPD_30_39 CPD_40_49 CPD_50_59  CPD_60_+
								#       "0"      "45"      "45"       "0"       "0"       "0"        NA

								startAges = c(10, 16, 20, 30, 40, 50, 60)
								quitAges = c( 15, 19, 29, 39, 49, 59, NA)

								## need this to assign dosage to the mid age)
								medAges=c(mean(c(10,15)), mean(c(16,19)), mean(c(20,29)), mean(c(30,39)), mean(c(40, 49)), mean(c(50,59)), 60)
								medAges
								#[1] 12.5 17.5 24.5 34.5 44.5 54.5 60.0

								cpd.past2 = cpd.past
								names(cpd.past2)=startAges
								cpd.past2
								#   10   16   20   30   40   50   60
								#  "0" "45" "45"  "0"  "0"  "0"   NA

								###########  (2) Define age to cpd.current columns ######################

								ages = seq((as.numeric(x["ageentry"])),  (as.numeric(x["ageentry"]))+(2008-1986), by=2)
								ages
								#[1] 50.2 52.2 54.2 56.2 58.2 60.2 62.2 64.2 66.2 68.2 70.2 72.2

								# > length(ages)
								# [1] 12
								# > length(cpd.current)
								# [1] 12

								cpd.current2=cpd.current
								names(cpd.current2)=ages
								cpd.current2
								# 50.2 52.2 54.2 56.2 58.2 60.2 62.2 64.2 66.2 68.2 70.2 72.2
								#  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"



								### identify first age group where cpd is not zero

								where=which(cpd.past2!=0)
								where
								# 16 20
								#  2  3

								# > where
								# 20 30 40 50
								#  3  4  5  6

								# > cpd.past2
								#     10     16     20     30     40     50     60
								#    "0"    "0"  "9.5"  "9.5" "19.5" "19.5"     NA
								# > cpd.current2
								#   55.5   57.5   59.5   61.5   63.5   65.5   67.5   69.5   71.5   73.5   75.5   77.5
								# "19.5" "19.5" "19.5" "29.5"    "0"    "0"    "0"    "0"    "0"    "0"    "0"    "0"

								##### identify if this person ever smoked during the trial ###

								where2 = which(cpd.current2!=0)
								where2
								# 55.5 57.5 59.5 61.5
								#    1    2    3    4


								############### correct some misspecification ###
								if(status==2){


									### some modification of status in case it's wrong ###
									# > x
									#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+    past.cpd        1986
									#       "151"      "1915"      "70.8"          NA        " 2"         "0"         "0"      "19.5"      "19.5"      "19.5"          NA          NA          NA         "0"
									#        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006        2008
									#         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
								    if(length(where2)==0){  status=3 }

								    # although this person said he didn't quit smoking cpd during trials are all zero, so actally quit smoking


								}



								if(status==3 ){   # smoked but quit at some point of her life

													#        id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
													#        "22"      "1936"      "50.2"      "45.2"        " 3"         "0"        "45"        "45"         "0"         "0"         "0"          NA
													#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
													#      "45.5"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
													#        2008
													#         "0"

													#age_quit = as.numeric(x["age_quit"])
													#[1] 45.2

													## quit age should be redefined based on the dosage ##

										###### if there is at some point where cpd is not zero: i.e. at some point of past, smoked ####

										if(length(where)!=0){   ## if there is past smoking evidence ###

												########## identify first smoking age ###

												age_start = as.numeric(startAges[(where[1])])  #[1] 16
												age_start

												######### identify quit smoking age ######

												age_quit = as.numeric(quitAges[where[length(where)]])
												age_quit
												#[1] 29

												if(is.na(age_quit)==T){  age_quit=as.numeric(x["age_quit"]) }
												if(is.na(age_quit)==T) {  age_quit = 60   }

												### median age for the dosage group ##
												ags2 = medAges[where]
												ags2
												#[1] 17.5 24.5

												### dosage ###
												dos2= as.numeric(cpd.past2[where])
												dos2
												#[1] 45 45

												profile = list(breaks=c(age_start, ags2, age_quit, max.age),
																dose = c(0,  dos2, dos2[length(dos2)],0))

												profile
												# $breaks
												# [1]  16.0  17.5  24.5  29.0 110.0
												#
												# $dose
												# [1]  0 45 45 45  0
												#
												# >
												cbind(profile[[1]],profile[[2]])
												#       [,1] [,2]
												# [1,]  16.0    0
												# [2,]  17.5   45
												# [3,]  24.5   45
												# [4,]  29.0   45
												# [5,] 110.0    0
												# >
												# > x
												#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
												#        "22"      "1936"      "50.2"      "45.2"        " 3"         "0"        "45"        "45"         "0"         "0"         "0"          NA
												#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
												#      "45.5"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
												#        2008
												#         "0"


												####### although they said they quit smoking as of 1986, some can somke during the trial then profile should be modified ##

												if(sum(cpd.current2 > 0, na.rm=T) > 0){

														# > cpd.current2
														#   69.3   71.3   73.3   75.3   77.3   79.3   81.3   83.3   85.3   87.3   89.3   91.3
														#    "0"    "0"    "0"    "0" "19.5" "19.5"    "0"    "0"    "0"    "0"    "0"    "0"

														ags3=as.numeric(names(cpd.current2))[where2]
														ags3
														#[1] 77.3 79.3
														dos3=as.numeric(cpd.current2)[where2]
														dos3
														#[1] 19.5 19.5

														### right before 77.3, he didn't smoke so put the soage
														dos4=c(0, dos3)
														ags4=c(ags3[1]-1,  ags3)

														### otherwise it becomes like this:
														#cbind(profile[[1]],profile[[2]])
														# [,1] [,2]
														# [1,]  20.0  0.0
														# [2,]  24.5 19.5
														# [3,]  34.5 19.5
														# [4,]  44.5 19.5
														# [5,]  49.0 19.5
														# [6,]  77.3 19.5
														# [7,]  79.3 19.5
														# [8,] 110.0  0.0


														#       [,1] [,2]
														# [1,]  20.0  0.0
														# [2,]  24.5 19.5
														# [3,]  34.5 19.5
														# [4,]  44.5 19.5
														# [5,]  49.0 19.5
														# [6,] 110.0  0.0
														# >
														# > x
														#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
														#        "16"      "1917"      "69.3"      "66.3"        " 3"          NA          NA      "19.5"      "19.5"      "19.5"          NA          NA
														#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
														#      "19.5"         "0"         "0"         "0"         "0"      "19.5"      "19.5"         "0"         "0"         "0"         "0"         "0"
														#        2008
														#         "0"



														profile = list(breaks=c(age_start, ags2, age_quit, ags4, max.age),
																		dose = c(0,  dos2, dos2[length(dos2)], dos4, 0))

														cbind(profile[[1]],profile[[2]])
														#        [,1] [,2]
														#  [1,]  20.0  0.0
														#  [2,]  24.5 19.5
														#  [3,]  34.5 19.5
														#  [4,]  44.5 19.5
														#  [5,]  49.0 19.5
														#  [6,]  76.3  0.0
														#  [7,]  77.3 19.5
														#  [8,]  79.3 19.5
														#  [9,] 110.0  0.0


												}# if(sum(cpd.current2 > 0)){

										} # if(length(where)!=0)

																				###### no past c/day information although it said so

										if(length(where)==0){

											print("No past smoking information (cig/day) provided for whom specified herself/himself as smokers")
											profile=NA
											## then possibly just have to use current smoking information ##

											if(sum(cpd.current2 > 0, na.rm=T) == 0){ # if there is not even current moking inffo, then never smokers

													profile = list(breaks=c(max.age-1, max.age), dose=c(0, 0))   # there is no starting age, so I gave just start.age=109 and death.age=110
													profile
													# $breaks
													# [1] 109 110 --> starting age 109 death age 110, but dosage below is zero anyway
													#
													# $dose
													# [1] 0 0

											}#
											if(sum(cpd.current2 > 0) > 0){  # if there is current smoker information

														# > cpd.current2
														#   55.5   57.5   59.5   61.5   63.5   65.5   67.5   69.5   71.5   73.5   75.5   77.5
														#    "0"    "0"    "0"    "0" "19.5" "19.5"    "0"    "0"    "0"    "0"    "0"    "0"

														where2 = as.numeric(which(cpd.current2!=0))
														where2
														#[1] 5 6
														age_start2 = as.numeric(names(cpd.current2))[where2[1]]
														#[1] 63.5



														ags3b=as.numeric(names(cpd.current2))[where2]
														ags3b
														#[1][1] 63.5 65.5
														dos3b=as.numeric(cpd.current2)[where2]
														dos3b
														#[1] 19.5 19.5



														profile = list(breaks=c(age_start2, ags3b, max.age),
																		dose = c(0,   dos3b, 0))

														cbind(profile[[1]],profile[[2]])
														# 			cbind(profile[[1]],profile[[2]])
														#       [,1] [,2]
														# [1,]  63.5  0.0
														# [2,]  63.5 19.5
														# [3,]  65.5 19.5
														# [4,] 110.0  0.0


											}#3nd of  if(sum(cpd.current2 > 0) > 0)


										}# end of if(length(where)==0){

								}#end of status===3


								if(status==2){   # smokers but didn't quit before the trial

										# > x
										#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
										#         "6"      "1931"      "55.5"          NA        " 2"         "0"         "0"       "9.5"       "9.5"      "19.5"      "19.5"          NA
										#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
										#          NA      "19.5"      "19.5"      "19.5"      "29.5"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
										#        2008
										#         "0"


										# > cpd.past
										# CPD_10_15 CPD_16_19 CPD_20_29 CPD_30_39 CPD_40_49 CPD_50_59  CPD_60_+
										#       "0"       "0"     "9.5"     "9.5"    "19.5"    "19.5"        NA
										# > cpd.current
										#   1986   1988   1990   1992   1994   1996   1998   2000   2002   2004   2006   2008
										# "19.5" "19.5" "19.5" "29.5"    "0"    "0"    "0"    "0"    "0"    "0"    "0"    "0"

										###### if there is at some point where cpd is not zero: i.e. at some point of past, smoked ####

										if(length(where)!=0){   ## if there is past smoking evidence ###


												# > cpd.past2
												#     10     16     20     30     40     50     60
												#    "0"    "0"  "9.5"  "9.5" "19.5" "19.5"     NA
												# > cpd.current2
												#   55.5   57.5   59.5   61.5   63.5   65.5   67.5   69.5   71.5   73.5   75.5   77.5
												# "19.5" "19.5" "19.5" "29.5"    "0"    "0"    "0"    "0"    "0"    "0"    "0"    "0"

												########## identify first smoking age ###

												age_start = as.numeric(startAges[(where[1])])  #[1] 16
												age_start
												#[1] 20

												### median age for the dosage group ##
												ags2 = medAges[where]
												ags2
												#[1] 17.5 24.5
												#[1] 24.5 34.5 44.5 54.5

												### dosage ###
												dos2= as.numeric(cpd.past2[where])
												dos2
												#[1] 45 45
												#[1]  9.5  9.5 19.5 19.5


												### smoking history after the entyr

												if(length(where2)>0){

														# > cpd.current2
														#   55.5   57.5   59.5   61.5   63.5   65.5   67.5   69.5   71.5   73.5   75.5   77.5
														# "19.5" "19.5" "19.5" "29.5"    "0"    "0"    "0"    "0"    "0"    "0"    "0"    "0"

														####### identify quit age ########

														where3=which(cpd.current2==0)
														where3
														# > where3
														# 63.5 65.5 67.5 69.5 71.5 73.5 75.5 77.5
														#    5    6    7    8    9   10   11   12

														#### if the person never quit smoking during tirla
														if(length(where3)==0){

																# > cpd.past2
																#     10     16     20     30     40     50     60
																#    "0"    "0" "29.5" "39.5" "39.5" "29.5"     NA
																# > cpd.current2
																#   58.8   60.8   62.8   64.8   66.8   68.8   70.8   72.8   74.8   76.8   78.8   80.8
																# "29.5" "29.5" "29.5" "29.5" "29.5" "29.5" "29.5" "29.5" "29.5" "29.5" "29.5" "29.5"

																ags3=as.numeric(names(cpd.current2))
																dos3=as.numeric(cpd.current2)

																ags3
																#[1] 58.8 60.8 62.8 64.8 66.8 68.8 70.8 72.8 74.8 76.8 78.8 80.8
																dos3
																#[1] 29.5 29.5 29.5 29.5 29.5 29.5 29.5 29.5 29.5 29.5 29.5 29.5

																## assume the dosage until death is the mean of this trial
																m.dos3 =mean(dos3)


																profile=list(breaks=c(age_start, ags2, ags3, max.age),
																			 dose=c(0, dos2, dos3,m.dos3))
																cbind(profile[[1]],profile[[2]])
																# 	[,1] [,2]
																#  [1,]  20.0  0.0
																#  [2,]  24.5 29.5
																#  [3,]  34.5 39.5
																#  [4,]  44.5 39.5
																#  [5,]  54.5 29.5
																#  [6,]  58.8 29.5
																#  [7,]  60.8 29.5
																#  [8,]  62.8 29.5
																#  [9,]  64.8 29.5
																# [10,]  66.8 29.5
																# [11,]  68.8 29.5
																# [12,]  70.8 29.5
																# [13,]  72.8 29.5
																# [14,]  74.8 29.5
																# [15,]  76.8 29.5
																# [16,]  78.8 29.5
																# [17,]  80.8 29.5
																# [18,] 110.0 29.5



														}#end of if(length(where3)==0){


														### if the person quit smoking during the trial
														if(length(where3)>0){

																age_quit = as.numeric(names(cpd.current2))[where3[1]]
																age_quit
																#[1] 63.5

																ags3=as.numeric(names(cpd.current2))[cpd.current2!=0]
																dos3=as.numeric(cpd.current2)[cpd.current2!=0]

																ags3
																#[1] 55.5 57.5 59.5 61.5
																dos3
																#[1] 19.5 19.5 19.5 29.5


																profile=list(breaks=c(age_start, ags2, ags3,age_quit, max.age),
																			 dose=c(0, dos2, dos2[length(dos2)],dos3,0))
																cbind(profile[[1]],profile[[2]])
																#        [,1] [,2]
																#  [1,]  20.0  0.0
																#  [2,]  24.5  9.5
																#  [3,]  34.5  9.5
																#  [4,]  44.5 19.5
																#  [5,]  54.5 19.5
																#  [6,]  55.5 19.5
																#  [7,]  57.5 19.5
																#  [8,]  59.5 19.5
																#  [9,]  61.5 19.5
																# [10,]  63.5 29.5
																# [11,] 110.0  0.0
																# >
																# > cpd.past2
																#     10     16     20     30     40     50     60
																#    "0"    "0"  "9.5"  "9.5" "19.5" "19.5"     NA
																# > cpd.current2
																#   55.5   57.5   59.5   61.5   63.5   65.5   67.5   69.5   71.5   73.5   75.5   77.5
																# "19.5" "19.5" "19.5" "29.5"    "0"    "0"    "0"    "0"    "0"    "0"    "0"    "0"

														}#end of if(length(where3)>3){

												}#end of end of if(length(where2)>0){

												#### some people
												if(length(where2)==0){

														print("Note: this person specified that he hasn't quit smoking but all the cpd value during trial is zero")
											    }








											}#end of if(length(where)!=0){


											if(length(where)==0){   ## if there is NO past smoking evidence ###


															### then possibly started smoking during the trial ###
														print("No past smoking information (cig/day) provided for whom specified herself/himself as smokers")
														profile=NA
														## then possibly just have to use current smoking information ##

														if(sum(cpd.current2 > 0, na.rm=T) == 0){ # if there is not even current moking inffo, then never smokers

																profile = list(breaks=c(max.age-1, max.age), dose=c(0, 0))   # there is no starting age, so I gave just start.age=109 and death.age=110
																profile
																# $breaks
																# [1] 109 110 --> starting age 109 death age 110, but dosage below is zero anyway
																#
																# $dose
																# [1] 0 0

														}#
														if(sum(cpd.current2 > 0) > 0){  # if there is current smoker information

																	# > cpd.current2
																	#   55.5   57.5   59.5   61.5   63.5   65.5   67.5   69.5   71.5   73.5   75.5   77.5
																	#    "0"    "0"    "0"    "0" "19.5" "19.5"    "0"    "0"    "0"    "0"    "0"    "0"

																	where2 = as.numeric(which(cpd.current2!=0))
																	where2
																	#[1] 5 6
																	age_start2 = as.numeric(names(cpd.current2))[where2[1]]
																	#[1] 63.5



																	ags3b=as.numeric(names(cpd.current2))[where2]
																	ags3b
																	#[1][1] 63.5 65.5
																	dos3b=as.numeric(cpd.current2)[where2]
																	dos3b
																	#[1] 19.5 19.5



																	profile = list(breaks=c(age_start2, ags3b, max.age),
																					dose = c(0,   dos3b, 0))

																	cbind(profile[[1]],profile[[2]])
																	# 			cbind(profile[[1]],profile[[2]])
																	#       [,1] [,2]
																	# [1,]  63.5  0.0
																	# [2,]  63.5 19.5
																	# [3,]  65.5 19.5
																	# [4,] 110.0  0.0


														}#3nd of  if(sum(cpd.current2 > 0) > 0)



											}#end of if(length(where)==0)



							 } # status==2

						}#3nd of if(status!=1){



						profile
						# > profile
						# $breaks
						#  [1]  20.0  55.1  57.1  59.1  61.1  63.1  65.1  67.1  69.1  71.1  73.1  75.1  77.1  79.1  81.1  83.1  85.1  87.1 110.0
						#
						# $dose
						#  [1]  0.00 26.56 39.50 29.50 39.50 19.50 29.50 19.50 19.50 19.50 29.50 29.50 19.50 19.50 29.50 19.50 29.50 29.50 29.50



						################ [2] Run TSCE model for getting hazard ###########################


						  model = model.NHSHPFS
						  pars=TSCE.pars

						  age=c(1:max.age)  # this will calculate from 1 to death.age
						  hz=h2.plot(model,pars,profile,age,plt=F)


						  names(hz)=age


							if(doPlot==T) {

							   plot(age,hz,type="l",main=paste(MAIN,"Hazard",sep=" "),ylab="Hazard",xlab="Age",col="red")
							   abline(v=profile[[1]],col=c("red","blue","black"),lty="dotted",lwd=1.5)
							   title(sub=paste("dose:",paste(profile$dose,collapse="-"),sep=""))


							   legend(x="topleft",legend=c("Hazard","pdf"),fill=c("red","blue"),bg="white")


							}# end of plot

						   #names(pmf)=paste(age[-1])

						   ans=list(hz=hz, prof=cbind(profile[[1]],profile[[2]]))

						   ans


}#end of small function runTSCE_NHS_small







	### this is for female NHS data ###
		#x=smkdat[3,] # never smoker
	myPKY <- function(x,cpd.cols){


			####### make profile #####
						cpd=x[cpd.cols]

						cpd
						# 1976 1978 1980 1982 1984 1986 1988 1990 1992 1994 1996 1998 2000 2002 2004 2006 2008
						# 29.5 39.5 19.5 19.5 19.5 29.5 29.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0

						# 	1976 1978 1980 1982 1984 1986 1988 1990 1992 1994 1996 1998 2000 2002 2004 2006 2008
						# 39.5 29.5 39.5 19.5 29.5 19.5 19.5 19.5 29.5 29.5 19.5 19.5 29.5 19.5 29.5 29.5 29.5

						# x  j=49
						#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982
						#    1937.0      39.6      19.0      22.0       2.0      19.5       0.0       0.0       9.5       0.0
						#      1984      1986      1988      1990      1992      1994      1996      1998      2000      2002
						#       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0
						#      2004      2006      2008
						#       0.0       0.0       0.0
						# >
					# > j=5698
					# >
					# > x=smkdat[j,]
					# > x
					#       id2       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982      1984      1986      1988      1990      1992      1994      1996
					#    5698.0    1944.0      32.2      17.0      32.0       2.0      19.5       0.0       0.0      19.5      19.5      19.5      19.5       0.0       0.0       0.0       0.0       0.0
					#      1998      2000      2002      2004      2006      2008
					#       0.0       0.0       0.0      19.5       0.0      19.5

						################## [1] Make Profile #########################################################
						profile=ags=dos=ags2=dos2=NULL

									######### (1) Make a profile for the argument ###########
									######### Make profile = list( breaks, dose) for each individual which is an argment for p2.plot() ######
									# former smoker: profile <- list(breaks=c(20,45,100),dose=c(0,40,0)): until age 20, dose=0, until age 45, dose 40, then quit
									# current smoker: profile <- list(breaks=c(20,100),dose=c(0,20)):    until age 20, dose was 0 and from then on to 100, dose was 20 (current smoker)

						status = x["smkstatus"]

						if(status==1){   ## never smoked:

							  profile = list(breaks=c(max.age-1, max.age), dose=c(0, 0))   # there is no starting age, so I gave just start.age=109 and death.age=110


						}#end of


						if(status==2 ){   # smoked but quit at some point of her life

									 ######## (1)  assign age to year 1976 - 2008 ##########

									# > x["ageentry"]
									# ageentry
									#     34.4
									ages = seq((x["ageentry"]),  (x["ageentry"])+(2008-1976), by=2)
									ages
									#   [1]  34.4 36.4 38.4 40.4 42.4 44.4 46.4 48.4 50.4 52.4 54.4 56.4 58.4 60.4 62.4 64.4 66.4
									# > length(ages)
									# [1] 17
									# > length(cpd)
									# [1] 17

									cpd2=cpd
									names(cpd2)=ages
									cpd2
									# 34.4 36.4 38.4 40.4 42.4 44.4 46.4 48.4 50.4 52.4 54.4 56.4 58.4 60.4 62.4 64.4 66.4
									# 29.5 39.5 19.5 19.5 19.5 29.5 29.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0

									# 32 34 36 38 40 42 44 46 48 50 52 54 56 58 60 62 64
									#  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0
									# > x
									#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982      1984      1986      1988      1990      1992      1994
									#    1944.0      32.1      18.0      26.0       2.0       9.5       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0
									#      1996      1998      2000      2002      2004      2006      2008
									#       0.0       0.0       0.0       0.0       0.0       0.0       0.0



									#######(2) For people who quit before the entry ######################

									if(sum(cpd2,na.rm=T)==0 ){  ### all cpd2 is zero, then he quit before trial

										 profile=list(breaks=c(as.vector(x["age_start"]),as.vector(x["age_quit2"]),max.age),
												dose=c(0, as.vector(x["past.cpd"]), 0))

										# > profile
										# $breaks
										# [1]  18  26 110
										#
										# $dose
										# [1] 0.0 9.5 0.0
										# > x
										#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982      1984      1986      1988      1990      1992      1994
										#    1944.0      32.1      18.0      26.0       2.0       9.5       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0
										#      1996      1998      2000      2002      2004      2006      2008
										#       0.0       0.0       0.0       0.0       0.0       0.0       0.0


									}#end of


									##### (3) for peple who quit smoking during the entry ################

									if(sum(cpd2,na.rm=T) >0){   ## some cpd is not zero during trial

											#cpd2
											# 34.4 36.4 38.4 40.4 42.4 44.4 46.4 48.4 50.4 52.4 54.4 56.4 58.4 60.4 62.4 64.4 66.4
											# 29.5 39.5 19.5 19.5 19.5 29.5 29.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0

											myrow = min(which(cpd2==0))
											myrow
											#[1] 8  # 8th element gives zero
											quit.age = as.numeric(min(names(cpd2)[myrow]))
											quit.age
											#[1] 48.4

											### if year quit after 1976
											if(myrow > 1) {

											   ags = as.numeric(names(cpd2)[1:(myrow-1)])
											   ags
											   #[1] 34.4 36.4 38.4 40.4 42.4 44.4 46.4

											   dos = as.vector(cpd2[1:(myrow-1)])
											   dos
											   #[1] 29.5 39.5 19.5 19.5 19.5 29.5 29.5

												profile=list(breaks=c(as.vector(x["age_start"]), ags, quit.age, max.age),
																dose = c(0, as.vector(x["past.cpd"]),dos, 0))

												profile

												# 				> profile
												# $breaks
												#  [1]  18.0  34.4  36.4  38.4  40.4  42.4  44.4  46.4  48.4 110.0
												#
												# $dose
												#  [1]  0.00 26.64 29.50 39.50 19.50 19.50 19.50 29.50 29.50  0.00

												length(profile$breaks)
												#[1] 20
												length(profile$dose)
												# > x
												#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982      1984      1986      1988      1990      1992      1994
												#   1942.00     34.40     18.00     48.00      2.00     26.64     29.50     39.50     19.50     19.50     19.50     29.50     29.50      0.00      0.00      0.00
												#      1996      1998      2000      2002      2004      2006      2008
												#      0.00      0.00      0.00      0.00      0.00      0.00      0.00
												# > cpd2
												# 34.4 36.4 38.4 40.4 42.4 44.4 46.4 48.4 50.4 52.4 54.4 56.4 58.4 60.4 62.4 64.4 66.4
												# 29.5 39.5 19.5 19.5 19.5 29.5 29.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0


											 }

											# ####### cpd2 = 0 starting from 1976
											# some people reported they quit before entry, but actually smoking some more....
											 if(myrow == 1) {   ## some

											    ## first element is 0, but later no zeros are there

												# > cpd2
												# 39.6 41.6 43.6 45.6 47.6 49.6 51.6 53.6 55.6 57.6 59.6 61.6 63.6 65.6 67.6 69.6 71.6
												#  0.0  0.0  9.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0

												# > x
												#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982
												#    1937.0      39.6      19.0      22.0       2.0      19.5       0.0       0.0       9.5       0.0
												#      1984      1986      1988      1990      1992      1994      1996      1998      2000      2002
												#       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0
												#      2004      2006      2008
												#       0.0       0.0       0.0


												### identify real quit age again ###

												## last year smoked
												myrow2 = max(which(cpd2!=0))
												#[1] 3

												## identify age real quit smoking ##

												quit.age2 = min(as.numeric(names(which(which(cpd2==0) > myrow2))))
												quit.age2
												#[1] 45.6


												## take all the ages to be used in profile
												ags2 = as.numeric(names(cpd2))[as.numeric(names(cpd2)) <= quit.age2]
												ags2
												#[1] 39.6 41.6 43.6 45.6
												dos2 = cpd2[as.numeric(names(cpd2)) <= quit.age2]
												dos2
												# 39.6 41.6 43.6 45.6
												#  0.0  0.0  9.5  0.0

												profile=list(breaks=c(as.vector(x["age_start"]), as.vector(x["age_quit2"]), ags2, quit.age, max.age),
																dose = c(0, as.vector(x["past.cpd"]),as.vector(x["past.cpd"]),as.vector(dos2), 0))
																# need to do past.cpd twice (see below)

												# > profile
												# $breaks
												# [1]  19.0  22.0  39.6  41.6  43.6  45.6  39.6 110.0
												#
												# $dose
												# [1]  0.0 19.5 19.5  0.0  0.0  9.5  0.0  0.0
												#
												# > cbind(profile[[1]],profile[[2]])
												#       [,1] [,2]
												# [1,]  19.0  0.0
												# [2,]  22.0 19.5
												# [3,]  39.6 19.5  <- twice
												# [4,]  41.6  0.0
												# [5,]  43.6  0.0
												# [6,]  45.6  9.5
												# [7,]  39.6  0.0
												# [8,] 110.0  0.0

											  }



											# > cbind(profile$breaks, profile$dose)
											#        [,1]  [,2]
											#  [1,]  18.0  0.00
											#  [2,]  34.4 26.64
											#  [3,]  36.4 29.50
											#  [4,]  38.4 39.50
											#  [5,]  40.4 19.50
											#  [6,]  42.4 19.50
											#  [7,]  44.4 19.50
											#  [8,]  46.4 29.50
											#  [9,]  48.4 29.50
											# [10,] 110.0  0.00


									}#end of


							}#end of if(status==2 ){


						if(status==3 ){   # who never quit #########



									 ######## (1)  assign age to year 1976 - 2008 ##########

									# > x["ageentry"]
									# ageentry
									#     34.4
									ages = seq((x["ageentry"]),  (x["ageentry"])+(2008-1976), by=2)
									ages
									#   [1]  34.4 36.4 38.4 40.4 42.4 44.4 46.4 48.4 50.4 52.4 54.4 56.4 58.4 60.4 62.4 64.4 66.4
									# > length(ages)
									# [1] 17
									# > length(cpd)
									# [1] 17

									cpd2=cpd
									names(cpd2)=ages
									cpd2
									# 55.1 57.1 59.1 61.1 63.1 65.1 67.1 69.1 71.1 73.1 75.1 77.1 79.1 81.1 83.1 85.1 87.1
									# 39.5 29.5 39.5 19.5 29.5 19.5 19.5 19.5 29.5 29.5 19.5 19.5 29.5 19.5 29.5 29.5 29.5

							### assume the doage at the last observation continuses until death


									profile=list(breaks=c(as.vector(x["age_start"]), as.vector(ages),  max.age),
													dose = c(0, as.vector(x["past.cpd"]),as.vector(cpd2) ))

									profile
									# > profile
									# $breaks
									#  [1]  20.0  55.1  57.1  59.1  61.1  63.1  65.1  67.1  69.1  71.1  73.1  75.1  77.1  79.1  81.1  83.1  85.1  87.1 110.0
									#
									# $dose
									#  [1]  0.00 26.56 39.50 29.50 39.50 19.50 29.50 19.50 19.50 19.50 29.50 29.50 19.50 19.50 29.50 19.50 29.50 29.50 29.50

									length(profile$breaks)
									#[1] 20
									length(profile$dose)
									#[1] 20
									# > x
									#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982      1984      1986      1988      1990      1992      1994
									#   1921.00     55.10     20.00        NA      3.00     26.56     39.50     29.50     39.50     19.50     29.50     19.50     19.50     19.50     29.50     29.50
									#      1996      1998      2000      2002      2004      2006      2008
									#     19.50     19.50     29.50     19.50     29.50     29.50     29.50

									# > cpd2
									# 55.1 57.1 59.1 61.1 63.1 65.1 67.1 69.1 71.1 73.1 75.1 77.1 79.1 81.1 83.1 85.1 87.1
									# 39.5 29.5 39.5 19.5 29.5 19.5 19.5 19.5 29.5 29.5 19.5 19.5 29.5 19.5 29.5 29.5 29.5
									# > cbind(profile$breaks, profile$dose)
									#        [,1]  [,2]
									#  [1,]  20.0  0.00
									#  [2,]  55.1 26.56
									#  [3,]  57.1 39.50
									#  [4,]  59.1 29.50
									#  [5,]  61.1 39.50
									#  [6,]  63.1 19.50
									#  [7,]  65.1 29.50
									#  [8,]  67.1 19.50
									#  [9,]  69.1 19.50
									# [10,]  71.1 19.50
									# [11,]  73.1 29.50
									# [12,]  75.1 29.50
									# [13,]  77.1 19.50
									# [14,]  79.1 19.50
									# [15,]  81.1 29.50
									# [16,]  83.1 19.50
									# [17,]  85.1 29.50
									# [18,]  87.1 29.50
									# [19,] 110.0 29.50


						}#end of


						profile
						# > profile
						# $breaks
						#  [1]  20.0  55.1  57.1  59.1  61.1  63.1  65.1  67.1  69.1  71.1  73.1  75.1  77.1  79.1  81.1  83.1  85.1  87.1 110.0
						#
						# $dose
						#  [1]  0.00 26.56 39.50 29.50 39.50 19.50 29.50 19.50 19.50 19.50 29.50 29.50 19.50 19.50 29.50 19.50 29.50 29.50 29.50




				####### make pack-years ######
				# $breaks
				# [1]  18.0  47.6  49.6 101.0
				#
				# $dose
				# [1]  0.0 39.5 39.5  0.0


				br=profile$breaks
				# > br=profile$breaks
				# > br
				# [1]  18.0  47.6  49.6 101.0
				do=profile$dose
				# > do
				# [1]  0.0 39.5 39.5  0.0


				#if(sum(indic)>0) {  br=br[indic] ; do=do[indic] }

				br
				do
				for(j in 1:length(br)){


					   dur = NA
					   if(j==1)  dur= br[1]-1
					   if(j >1) dur=br[j]-br[j-1]   # [1] 29.6 = 47.6 - 18

					   pkyr0 = dur * do[j]/20  # 29.6*39.5
					   pkyr0
					   #[1] 58.46  # total 1169 cig/day

					   if(j==1)  { pkyr = pkyr0}
					   if(j>1) pkyr = c(pkyr,pkyr0)

					   pkyr
					   #[1]  0.00 58.46  3.95  0.00
				}#

				sum(pkyr)




	}#end of








		#x=smkdat[3,]

	myPKY.entry.FEMALE <- function(x,cpd.cols){
		# > x
		#       id2       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978
		#       3.0    1928.0      47.6      18.0      50.0       2.0      39.5      39.5       0.0
		#      1980      1982      1984      1986      1988      1990      1992      1994      1996
		#       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0
		#      1998      2000      2002      2004      2006      2008
		#       0.0       0.0       0.0       0.0       0.0       0.0



		status= x["smkstatus"]
		cpd = x[cpd.cols]
		# 1976 1978 1980 1982 1984 1986 1988 1990 1992 1994 1996 1998 2000 2002 2004 2006 2008
		# 39.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
		ag_start = x["age_start"]
		ag_quit = x["age_quit2"]
		cp.past =x["past.cpd"]
		ag_entry=x["ageentry"]

		if(status==1){   ans= 0 }

		if(status==2){ # previous smoker

		      dur=(ag_quit - ag_start)

		      ans = as.numeric(dur*cp.past/20)
		      ans


		}

		if(status==3){

		      dur=(ag_entry - ag_start)

		      ans = as.numeric(dur*cp.past/20)
		      ans

		 }

		 ans

		}#myPKY.entry




      myCompareHist<- function(y, x, indic.y, indic.x, MAIN,YLIM=0.06,XLAB=c("Age of Incidence")){


			par(mfrow=c(1,2))
			y2 = y[indic.y]
			me=round(median(y2,na.rm=T),2)
			tt=hist(y2,prob=T,col="blue",main=paste("[Data]", MAIN,"\n","(median=",me,")",sep=""),ylim=c(0,YLIM),xlab=MAIN)

			x2 =x[indic.x]
			me=round(median(x2,na.rm=T),2)
			tt2=hist(x2,prob=T,col="red",main=paste("[Model]", MAIN,"\n","(median=",me,")",sep=""),ylim=c(0,YLIM),xlab=MAIN)#breaks=tt$breaks,
			tm=ks.test(y2,x2)
			tm
			#
			# 	Two-sample Kolmogorov-Smirnov test
			#
			# data:  y and x
			# D = 0.0288, p-value = 0.2133
			# alternative hypothesis: two-sided
			#
			# Warning cat:
			# In ks.test(y, x) : p-values will be approximate in the presence of ties

			par(mfrow=c(1,1))
			qqplot(y2,x2, xlab="Data",ylab="Model",main=paste("Q-Q plot \n", "( KS test P=",sprintf("%.7f",tm$p.value),2,")",sep=""))

			abline(0,1)

      }#end of


      myCompareHist.NLST<- function(y, x, indic.y, indic.x, MAIN,YLIM=0.06,XLAB=c("Age of Incidence")){

			par(mfrow=c(1,2))
			y2 = y[indic.y]
			me=round(median(y2,na.rm=T),2)
			tt=hist(y2,prob=T,col="blue",main=paste("[NLST]", MAIN,"\n","(median=",me,")",sep=""),ylim=c(0,YLIM),xlab=MAIN)

			x2 =x[indic.x]
			me=round(median(x2,na.rm=T),2)
			tt2=hist(x2,prob=T,col="red",main=paste("[NHSHP]", MAIN,"\n","(median=",me,")",sep=""),ylim=c(0,YLIM),xlab=MAIN)#breaks=tt$breaks,
			tm=ks.test(y2,x2)
			tm
			#
			# 	Two-sample Kolmogorov-Smirnov test
			#
			# data:  y and x
			# D = 0.0288, p-value = 0.2133
			# alternative hypothesis: two-sided
			#
			# Warning cat:
			# In ks.test(y, x) : p-values will be approximate in the presence of ties

			par(mfrow=c(1,1))
			qqplot(y2,x2, xlab="Data",ylab="Model",main=paste("Q-Q plot \n", "( KS test P=",sprintf("%.7f",tm$p.value),2,")",sep=""))

			abline(0,1)

      }#end of


		myTimePlotCompare <- function(x,y,MAIN){

			tb.model = table(ceiling(x))
			tb.model
			#   0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18
			#   3  12  22  23  27  28  27  37  36  36  44  67  68  72  76  77  86 102 101
			#  19  20  21  22  23  24  25  26  27  28  29  30
			# 138 108 130 144 142 146 160 185 169 187 187 189

			tb.dat = table(ceiling(y))
			#
			#   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22
			#   9  21  17  23  25  34  31  25  39  43  55  62  63  70  78  76  96 112  98 128 125 131
			#  23  24  25  26  27  28  29  30
			# 138 139 159 167 145 167 132 167

			YLIM=max(c(tb.model, tb.dat))

			xx=as.numeric(names(tb.model))
			plot(xx,as.numeric(tb.model), col="red",pch=16,xlab="Time since entry", ylab="LC incidence", main=MAIN,ylim=c(0,YLIM))


			xx=as.numeric(names(tb.dat))
			points(xx,as.numeric(tb.dat), col="blue",pch=17,xlab="Time since entry", ylab="LC incidence")
			legend(x="topleft",fill=c("blue","red"),legend=c("Data","Model"))


		}



		myProfile.NHSPF_male <- function(x, max.age, cpd.past.cols,  cpd.current.cols){


			####### make profile #####
					### never smoker ##
						# > x
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
						#         "1"      "1921"      "65.4"          NA        " 1"          NA          NA          NA          NA          NA          NA          NA
						#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
						#          NA         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
						#        2008
						#         "0"

						### smokers, but quit before the trial ###
						#        id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
						#        "22"      "1936"      "50.2"      "45.2"        " 3"         "0"        "45"        "45"         "0"         "0"         "0"          NA
						#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
						#      "45.5"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
						#        2008
						#         "0"
						# > x
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
						#        "16"      "1917"      "69.3"      "66.3"        " 3"          NA          NA      "19.5"      "19.5"      "19.5"          NA          NA
						#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
						#      "19.5"         "0"         "0"         "0"         "0"      "19.5"      "19.5"         "0"         "0"         "0"         "0"         "0"
						#        2008
						#         "0"

						# > x
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
						#        "11"      "1946"      "40.5"      "38.5"        " 3"          NA          NA          NA      "19.5"          NA          NA          NA
						#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
						#      "19.5"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
						#        2008
						#         "0"

						#  x=smkdat[69,]
						# > x
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15
						#        "69"      "1921"      "65.3"          NA        " 2"          NA
						#   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
						#      "39.5"      "39.5"        "45"        "45"      "39.5"      "39.5"
						#    past.cpd        1986        1988        1990        1992        1994
						#          NA      "39.5"      "39.5"      "39.5"      "39.5"      "39.5"
						#        1996        1998        2000        2002        2004        2006
						#      "39.5"      "39.5"      "39.5"      "39.5"      "39.5"      "39.5"
						#        2008
						#      "39.5"

						# > smkdat[151,]
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+    past.cpd        1986
						#       "151"      "1915"      "70.8"          NA        " 2"         "0"         "0"      "19.5"      "19.5"      "19.5"          NA          NA          NA         "0"
						#        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006        2008
						#         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
						# > x=smkdat[79,]
						# > x
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+    past.cpd        1986
						#        "79"      "1912"      "74.3"      "69.3"        " 3"         "0"         "0"      "19.5"      "29.5"      "39.5"        "45"        "45"      "45.5"         "0"
						#        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006        2008
						#         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
						# > x=smkdat[728,]
						# > x
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+    past.cpd        1986
						#       "728"      "1932"      "54.6"          NA          NA          NA          NA          NA          NA          NA          NA          NA          NA         "0"
						#        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006        2008
						#      "19.5"      "19.5"      "19.5"      "19.5"         "0"         "0"         "0"         "0"         "0"         "0"         "0"

						cpd.past = x[cpd.past.cols]
						cpd.current = x[cpd.current.cols]

						cpd.past
						cpd.current
						# > 						cpd.past
						# CPD_10_15 CPD_16_19 CPD_20_29 CPD_30_39 CPD_40_49 CPD_50_59  CPD_60_+
						#        NA        NA        NA        NA        NA        NA        NA
						# > 						cpd.current
						# 1986 1988 1990 1992 1994 1996 1998 2000 2002 2004 2006 2008
						#  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"


						# x  j=49
						#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982
						#    1937.0      39.6      19.0      22.0       2.0      19.5       0.0       0.0       9.5       0.0
						#      1984      1986      1988      1990      1992      1994      1996      1998      2000      2002
						#       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0
						#      2004      2006      2008
						#       0.0       0.0       0.0
						# >

						################## [1] Make Profile #########################################################
						profile=ags=dos=ags2=dos2=NULL

									######### (1) Make a profile for the argument ###########
									######### Make profile = list( breaks, dose) for each individual which is an argment for p2.plot() ######
									# former smoker: profile <- list(breaks=c(20,45,100),dose=c(0,40,0)): until age 20, dose=0, until age 45, dose 40, then quit
									# current smoker: profile <- list(breaks=c(20,100),dose=c(0,20)):    until age 20, dose was 0 and from then on to 100, dose was 20 (current smoker)

						### status at 1986 at entry ##
						status = as.numeric(x["smkstatus86"])
						status
						#smk86	 smoking 1=no  2=yes, current  3=yes, past


						###### some people have smoking status NA
						if(is.na(status)==T){
								# > x
								#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15
								#         "4"      "1922"      "63.4"          NA          NA          NA
								#   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
								#          NA          NA          NA          NA          NA          NA
								#    past.cpd        1986        1988        1990        1992        1994
								#          NA         "0"         "0"         "0"         "0"         "0"
								#        1996        1998        2000        2002        2004        2006
								#         "0"         "0"         "0"         "0"         "0"         "0"
								#        2008
								#         "0"

								# > smkdat[360,]
								#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15
								#       "360"      "1938"      "47.6"      "45.6"          NA         "0"
								#   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
								#       "2.5"      "19.5"       "9.5"       "2.5"          NA          NA
								#    past.cpd        1986        1988        1990        1992        1994
								#          NA         "0"         "0"         "0"         "0"         "0"
								#        1996        1998        2000        2002        2004        2006
								#         "0"         "0"         "0"         "0"         "0"         "0"
								#        2008
								#         "0"


								####### assign smoking status ########

								indic.nocurrent = (sum(as.numeric(cpd.current))==0)   # if all cpd is zero
								indic.nopast = sum(cpd.past!=0 & is.na(cpd.past)==F)==0    # there is no element which is no zoer or non NA
								indic.nocurrent
								indic.nopast

								if(indic.nopast==T & indic.nocurrent==T ){  # then this is no smoker

								     status = 1

								}


								if(indic.nopast==F & indic.nocurrent==T){  # then this is no smoker

								     status = 3   # previous smoker 3

								}

								if(indic.nopast==F & indic.nocurrent==F){  # then this is no smoker

								     status = 2   # current smoker 3

								}

								if(indic.nopast==F & indic.nocurrent==T){  # then this is no smoker

								     status = 3   # previous smoker 3

								}

								if(indic.nopast==T & indic.nocurrent==F){  # there is no past info, but started smoking during the trial

								     status = 2   # current smoker 3

								}




						}#3nd of


						if(status==1){   ## never smoked:

							profile = list(breaks=c(max.age-1, max.age), dose=c(0, 0))   # there is no starting age, so I gave just start.age=109 and death.age=110
							profile
							# $breaks
							# [1] 109 110 --> starting age 109 death age 110, but dosage below is zero anyway
							#
							# $dose
							# [1] 0 0


						}#end of


						####### smokers who (1) quit either before trial, (2) during tiral or (3) never quit
						if(status!=1){


								age_start=age_quit=ags2=dos2=ags3=ags4=dos3=dos4=NA

								######## (1) DEFINE some age variables for past cpd information ##################
								# > cpd.past
								# CPD_10_15 CPD_16_19 CPD_20_29 CPD_30_39 CPD_40_49 CPD_50_59  CPD_60_+
								#       "0"      "45"      "45"       "0"       "0"       "0"        NA

								startAges = c(10, 16, 20, 30, 40, 50, 60)
								quitAges = c( 15, 19, 29, 39, 49, 59, NA)

								## need this to assign dosage to the mid age)
								medAges=c(mean(c(10,15)), mean(c(16,19)), mean(c(20,29)), mean(c(30,39)), mean(c(40, 49)), mean(c(50,59)), 60)
								medAges
								#[1] 12.5 17.5 24.5 34.5 44.5 54.5 60.0

								cpd.past2 = cpd.past
								names(cpd.past2)=startAges
								cpd.past2
								#   10   16   20   30   40   50   60
								#  "0" "45" "45"  "0"  "0"  "0"   NA

								###########  (2) Define age to cpd.current columns ######################

								ages = seq((as.numeric(x["ageentry"])),  (as.numeric(x["ageentry"]))+(2008-1986), by=2)
								ages
								#[1] 50.2 52.2 54.2 56.2 58.2 60.2 62.2 64.2 66.2 68.2 70.2 72.2

								# > length(ages)
								# [1] 12
								# > length(cpd.current)
								# [1] 12

								cpd.current2=cpd.current
								names(cpd.current2)=ages
								cpd.current2
								# 50.2 52.2 54.2 56.2 58.2 60.2 62.2 64.2 66.2 68.2 70.2 72.2
								#  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"



								### identify first age group where cpd is not zero

								where=which(cpd.past2!=0)
								where
								# 16 20
								#  2  3

								# > where
								# 20 30 40 50
								#  3  4  5  6

								# > cpd.past2
								#     10     16     20     30     40     50     60
								#    "0"    "0"  "9.5"  "9.5" "19.5" "19.5"     NA
								# > cpd.current2
								#   55.5   57.5   59.5   61.5   63.5   65.5   67.5   69.5   71.5   73.5   75.5   77.5
								# "19.5" "19.5" "19.5" "29.5"    "0"    "0"    "0"    "0"    "0"    "0"    "0"    "0"

								##### identify if this person ever smoked during the trial ###

								where2 = which(cpd.current2!=0)
								where2
								# 55.5 57.5 59.5 61.5
								#    1    2    3    4


								############### correct some misspecification ###
								if(status==2){


									### some modification of status in case it's wrong ###
									# > x
									#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+    past.cpd        1986
									#       "151"      "1915"      "70.8"          NA        " 2"         "0"         "0"      "19.5"      "19.5"      "19.5"          NA          NA          NA         "0"
									#        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006        2008
									#         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
								    if(length(where2)==0){  status=3 }

								    # although this person said he didn't quit smoking cpd during trials are all zero, so actally quit smoking


								}



								if(status==3 ){   # smoked but quit at some point of her life

													#        id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
													#        "22"      "1936"      "50.2"      "45.2"        " 3"         "0"        "45"        "45"         "0"         "0"         "0"          NA
													#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
													#      "45.5"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
													#        2008
													#         "0"

													#age_quit = as.numeric(x["age_quit"])
													#[1] 45.2

													## quit age should be redefined based on the dosage ##

										###### if there is at some point where cpd is not zero: i.e. at some point of past, smoked ####

										if(length(where)!=0){   ## if there is past smoking evidence ###

												########## identify first smoking age ###

												age_start = as.numeric(startAges[(where[1])])  #[1] 16
												age_start

												######### identify quit smoking age ######

												age_quit = as.numeric(quitAges[where[length(where)]])
												age_quit
												#[1] 29

												if(is.na(age_quit)==T){  age_quit=as.numeric(x["age_quit"]) }
												if(is.na(age_quit)==T) {  age_quit = 60   }

												### median age for the dosage group ##
												ags2 = medAges[where]
												ags2
												#[1] 17.5 24.5

												### dosage ###
												dos2= as.numeric(cpd.past2[where])
												dos2
												#[1] 45 45

												profile = list(breaks=c(age_start, ags2, age_quit, max.age),
																dose = c(0,  dos2, dos2[length(dos2)],0))

												profile
												# $breaks
												# [1]  16.0  17.5  24.5  29.0 110.0
												#
												# $dose
												# [1]  0 45 45 45  0
												#
												# >
												cbind(profile[[1]],profile[[2]])
												#       [,1] [,2]
												# [1,]  16.0    0
												# [2,]  17.5   45
												# [3,]  24.5   45
												# [4,]  29.0   45
												# [5,] 110.0    0
												# >
												# > x
												#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
												#        "22"      "1936"      "50.2"      "45.2"        " 3"         "0"        "45"        "45"         "0"         "0"         "0"          NA
												#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
												#      "45.5"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
												#        2008
												#         "0"


												####### although they said they quit smoking as of 1986, some can somke during the trial then profile should be modified ##

												if(sum(cpd.current2 > 0, na.rm=T) > 0){

														# > cpd.current2
														#   69.3   71.3   73.3   75.3   77.3   79.3   81.3   83.3   85.3   87.3   89.3   91.3
														#    "0"    "0"    "0"    "0" "19.5" "19.5"    "0"    "0"    "0"    "0"    "0"    "0"

														ags3=as.numeric(names(cpd.current2))[where2]
														ags3
														#[1] 77.3 79.3
														dos3=as.numeric(cpd.current2)[where2]
														dos3
														#[1] 19.5 19.5

														### right before 77.3, he didn't smoke so put the soage
														dos4=c(0, dos3)
														ags4=c(ags3[1]-1,  ags3)

														### otherwise it becomes like this:
														#cbind(profile[[1]],profile[[2]])
														# [,1] [,2]
														# [1,]  20.0  0.0
														# [2,]  24.5 19.5
														# [3,]  34.5 19.5
														# [4,]  44.5 19.5
														# [5,]  49.0 19.5
														# [6,]  77.3 19.5
														# [7,]  79.3 19.5
														# [8,] 110.0  0.0


														#       [,1] [,2]
														# [1,]  20.0  0.0
														# [2,]  24.5 19.5
														# [3,]  34.5 19.5
														# [4,]  44.5 19.5
														# [5,]  49.0 19.5
														# [6,] 110.0  0.0
														# >
														# > x
														#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
														#        "16"      "1917"      "69.3"      "66.3"        " 3"          NA          NA      "19.5"      "19.5"      "19.5"          NA          NA
														#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
														#      "19.5"         "0"         "0"         "0"         "0"      "19.5"      "19.5"         "0"         "0"         "0"         "0"         "0"
														#        2008
														#         "0"



														profile = list(breaks=c(age_start, ags2, age_quit, ags4, max.age),
																		dose = c(0,  dos2, dos2[length(dos2)], dos4, 0))

														cbind(profile[[1]],profile[[2]])
														#        [,1] [,2]
														#  [1,]  20.0  0.0
														#  [2,]  24.5 19.5
														#  [3,]  34.5 19.5
														#  [4,]  44.5 19.5
														#  [5,]  49.0 19.5
														#  [6,]  76.3  0.0
														#  [7,]  77.3 19.5
														#  [8,]  79.3 19.5
														#  [9,] 110.0  0.0


												}# if(sum(cpd.current2 > 0)){

										} # if(length(where)!=0)

																				###### no past c/day information although it said so

										if(length(where)==0){

											#print("No past smoking information (cig/day) provided for whom specified herself/himself as smokers")
											profile=NA
											## then possibly just have to use current smoking information ##

											if(sum(cpd.current2 > 0, na.rm=T) == 0){ # if there is not even current moking inffo, then never smokers

													profile = list(breaks=c(max.age-1, max.age), dose=c(0, 0))   # there is no starting age, so I gave just start.age=109 and death.age=110
													profile
													# $breaks
													# [1] 109 110 --> starting age 109 death age 110, but dosage below is zero anyway
													#
													# $dose
													# [1] 0 0

											}#
											if(sum(cpd.current2 > 0) > 0){  # if there is current smoker information

														# > cpd.current2
														#   55.5   57.5   59.5   61.5   63.5   65.5   67.5   69.5   71.5   73.5   75.5   77.5
														#    "0"    "0"    "0"    "0" "19.5" "19.5"    "0"    "0"    "0"    "0"    "0"    "0"

														where2 = as.numeric(which(cpd.current2!=0))
														where2
														#[1] 5 6
														age_start2 = as.numeric(names(cpd.current2))[where2[1]]
														#[1] 63.5



														ags3b=as.numeric(names(cpd.current2))[where2]
														ags3b
														#[1][1] 63.5 65.5
														dos3b=as.numeric(cpd.current2)[where2]
														dos3b
														#[1] 19.5 19.5



														profile = list(breaks=c(age_start2, ags3b, max.age),
																		dose = c(0,   dos3b, 0))

														cbind(profile[[1]],profile[[2]])
														# 			cbind(profile[[1]],profile[[2]])
														#       [,1] [,2]
														# [1,]  63.5  0.0
														# [2,]  63.5 19.5
														# [3,]  65.5 19.5
														# [4,] 110.0  0.0


											}#3nd of  if(sum(cpd.current2 > 0) > 0)


										}# end of if(length(where)==0){

								}#end of status===3


								if(status==2){   # smokers but didn't quit before the trial

										# > x
										#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
										#         "6"      "1931"      "55.5"          NA        " 2"         "0"         "0"       "9.5"       "9.5"      "19.5"      "19.5"          NA
										#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
										#          NA      "19.5"      "19.5"      "19.5"      "29.5"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
										#        2008
										#         "0"


										# > cpd.past
										# CPD_10_15 CPD_16_19 CPD_20_29 CPD_30_39 CPD_40_49 CPD_50_59  CPD_60_+
										#       "0"       "0"     "9.5"     "9.5"    "19.5"    "19.5"        NA
										# > cpd.current
										#   1986   1988   1990   1992   1994   1996   1998   2000   2002   2004   2006   2008
										# "19.5" "19.5" "19.5" "29.5"    "0"    "0"    "0"    "0"    "0"    "0"    "0"    "0"

										###### if there is at some point where cpd is not zero: i.e. at some point of past, smoked ####

										if(length(where)!=0){   ## if there is past smoking evidence ###


												# > cpd.past2
												#     10     16     20     30     40     50     60
												#    "0"    "0"  "9.5"  "9.5" "19.5" "19.5"     NA
												# > cpd.current2
												#   55.5   57.5   59.5   61.5   63.5   65.5   67.5   69.5   71.5   73.5   75.5   77.5
												# "19.5" "19.5" "19.5" "29.5"    "0"    "0"    "0"    "0"    "0"    "0"    "0"    "0"

												########## identify first smoking age ###

												age_start = as.numeric(startAges[(where[1])])  #[1] 16
												age_start
												#[1] 20

												### median age for the dosage group ##
												ags2 = medAges[where]
												ags2
												#[1] 17.5 24.5
												#[1] 24.5 34.5 44.5 54.5

												### dosage ###
												dos2= as.numeric(cpd.past2[where])
												dos2
												#[1] 45 45
												#[1]  9.5  9.5 19.5 19.5


												### smoking history after the entyr

												if(length(where2)>0){

														# > cpd.current2
														#   55.5   57.5   59.5   61.5   63.5   65.5   67.5   69.5   71.5   73.5   75.5   77.5
														# "19.5" "19.5" "19.5" "29.5"    "0"    "0"    "0"    "0"    "0"    "0"    "0"    "0"

														####### identify quit age ########

														where3=which(cpd.current2==0)
														where3
														# > where3
														# 63.5 65.5 67.5 69.5 71.5 73.5 75.5 77.5
														#    5    6    7    8    9   10   11   12

														#### if the person never quit smoking during tirla
														if(length(where3)==0){

																# > cpd.past2
																#     10     16     20     30     40     50     60
																#    "0"    "0" "29.5" "39.5" "39.5" "29.5"     NA
																# > cpd.current2
																#   58.8   60.8   62.8   64.8   66.8   68.8   70.8   72.8   74.8   76.8   78.8   80.8
																# "29.5" "29.5" "29.5" "29.5" "29.5" "29.5" "29.5" "29.5" "29.5" "29.5" "29.5" "29.5"

																ags3=as.numeric(names(cpd.current2))
																dos3=as.numeric(cpd.current2)

																ags3
																#[1] 58.8 60.8 62.8 64.8 66.8 68.8 70.8 72.8 74.8 76.8 78.8 80.8
																dos3
																#[1] 29.5 29.5 29.5 29.5 29.5 29.5 29.5 29.5 29.5 29.5 29.5 29.5

																## assume the dosage until death is the mean of this trial
																m.dos3 =mean(dos3)


																profile=list(breaks=c(age_start, ags2, ags3, max.age),
																			 dose=c(0, dos2, dos3,m.dos3))
																cbind(profile[[1]],profile[[2]])
																# 	[,1] [,2]
																#  [1,]  20.0  0.0
																#  [2,]  24.5 29.5
																#  [3,]  34.5 39.5
																#  [4,]  44.5 39.5
																#  [5,]  54.5 29.5
																#  [6,]  58.8 29.5
																#  [7,]  60.8 29.5
																#  [8,]  62.8 29.5
																#  [9,]  64.8 29.5
																# [10,]  66.8 29.5
																# [11,]  68.8 29.5
																# [12,]  70.8 29.5
																# [13,]  72.8 29.5
																# [14,]  74.8 29.5
																# [15,]  76.8 29.5
																# [16,]  78.8 29.5
																# [17,]  80.8 29.5
																# [18,] 110.0 29.5



														}#end of if(length(where3)==0){


														### if the person quit smoking during the trial
														if(length(where3)>0){

																age_quit = as.numeric(names(cpd.current2))[where3[1]]
																age_quit
																#[1] 63.5

																ags3=as.numeric(names(cpd.current2))[cpd.current2!=0]
																dos3=as.numeric(cpd.current2)[cpd.current2!=0]

																ags3
																#[1] 55.5 57.5 59.5 61.5
																dos3
																#[1] 19.5 19.5 19.5 29.5


																profile=list(breaks=c(age_start, ags2, ags3,age_quit, max.age),
																			 dose=c(0, dos2, dos2[length(dos2)],dos3,0))
																cbind(profile[[1]],profile[[2]])
																#        [,1] [,2]
																#  [1,]  20.0  0.0
																#  [2,]  24.5  9.5
																#  [3,]  34.5  9.5
																#  [4,]  44.5 19.5
																#  [5,]  54.5 19.5
																#  [6,]  55.5 19.5
																#  [7,]  57.5 19.5
																#  [8,]  59.5 19.5
																#  [9,]  61.5 19.5
																# [10,]  63.5 29.5
																# [11,] 110.0  0.0
																# >
																# > cpd.past2
																#     10     16     20     30     40     50     60
																#    "0"    "0"  "9.5"  "9.5" "19.5" "19.5"     NA
																# > cpd.current2
																#   55.5   57.5   59.5   61.5   63.5   65.5   67.5   69.5   71.5   73.5   75.5   77.5
																# "19.5" "19.5" "19.5" "29.5"    "0"    "0"    "0"    "0"    "0"    "0"    "0"    "0"

														}#end of if(length(where3)>3){

												}#end of end of if(length(where2)>0){

												#### some people
												if(length(where2)==0){

														#print("Note: this person specified that he hasn't quit smoking but all the cpd value during trial is zero")
											    }








											}#end of if(length(where)!=0){


											if(length(where)==0){   ## if there is NO past smoking evidence ###


															### then possibly started smoking during the trial ###
														#print("No past smoking information (cig/day) provided for whom specified herself/himself as smokers")
														profile=NA
														## then possibly just have to use current smoking information ##

														if(sum(cpd.current2 > 0, na.rm=T) == 0){ # if there is not even current moking inffo, then never smokers

																profile = list(breaks=c(max.age-1, max.age), dose=c(0, 0))   # there is no starting age, so I gave just start.age=109 and death.age=110
																profile
																# $breaks
																# [1] 109 110 --> starting age 109 death age 110, but dosage below is zero anyway
																#
																# $dose
																# [1] 0 0

														}#
														if(sum(cpd.current2 > 0) > 0){  # if there is current smoker information

																	# > cpd.current2
																	#   55.5   57.5   59.5   61.5   63.5   65.5   67.5   69.5   71.5   73.5   75.5   77.5
																	#    "0"    "0"    "0"    "0" "19.5" "19.5"    "0"    "0"    "0"    "0"    "0"    "0"

																	where2 = as.numeric(which(cpd.current2!=0))
																	where2
																	#[1] 5 6
																	age_start2 = as.numeric(names(cpd.current2))[where2[1]]
																	#[1] 63.5



																	ags3b=as.numeric(names(cpd.current2))[where2]
																	ags3b
																	#[1][1] 63.5 65.5
																	dos3b=as.numeric(cpd.current2)[where2]
																	dos3b
																	#[1] 19.5 19.5



																	profile = list(breaks=c(age_start2, ags3b, max.age),
																					dose = c(0,   dos3b, 0))

																	cbind(profile[[1]],profile[[2]])
																	# 			cbind(profile[[1]],profile[[2]])
																	#       [,1] [,2]
																	# [1,]  63.5  0.0
																	# [2,]  63.5 19.5
																	# [3,]  65.5 19.5
																	# [4,] 110.0  0.0


														}#3nd of  if(sum(cpd.current2 > 0) > 0)



											}#end of if(length(where)==0)



							 } # status==2

						}#3nd of if(status!=1){



						profile
						# > profile
						# $breaks
						#  [1]  20.0  55.1  57.1  59.1  61.1  63.1  65.1  67.1  69.1  71.1  73.1  75.1  77.1  79.1  81.1  83.1  85.1  87.1 110.0
						#
						# $dose
						#  [1]  0.00 26.56 39.50 29.50 39.50 19.50 29.50 19.50 19.50 19.50 29.50 29.50 19.50 19.50 29.50 19.50 29.50 29.50 29.50



						profile
						# > profile
						# $breaks
						#  [1]  20.0  55.1  57.1  59.1  61.1  63.1  65.1  67.1  69.1  71.1  73.1  75.1  77.1  79.1  81.1  83.1  85.1  87.1 110.0
						#
						# $dose
						#  [1]  0.00 26.56 39.50 29.50 39.50 19.50 29.50 19.50 19.50 19.50 29.50 29.50 19.50 19.50 29.50 19.50 29.50 29.50 29.50



	}#end of



	######## this calculate max age of agelc ###

	myProfile.NHSPF_male.LC.case <- function(x, cpd.past.cols,  cpd.current.cols){

				 #        id2       agelc        type     subtype         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39
				#         6.0          NA          NA          NA      1931.0        55.5          NA         2.0         0.0         0.0         9.5         9.5
				#   CPD_40_49   CPD_50_59    CPD_60_+    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000
				#        19.5        19.5          NA          NA        19.5        19.5        19.5        29.5         0.0         0.0         0.0         0.0
				#        2002        2004        2006        2008
				#         0.0         0.0         0.0         0.0
		profile=NULL
		max.age = x["agelc"]

		if(is.na(max.age)==F){ # NA if no lung cancer case

			####### make profile #####
					### never smoker ##
						# > x
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
						#         "1"      "1921"      "65.4"          NA        " 1"          NA          NA          NA          NA          NA          NA          NA
						#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
						#          NA         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
						#        2008
						#         "0"

						### smokers, but quit before the trial ###
						#        id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
						#        "22"      "1936"      "50.2"      "45.2"        " 3"         "0"        "45"        "45"         "0"         "0"         "0"          NA
						#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
						#      "45.5"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
						#        2008
						#         "0"
						# > x
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
						#        "16"      "1917"      "69.3"      "66.3"        " 3"          NA          NA      "19.5"      "19.5"      "19.5"          NA          NA
						#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
						#      "19.5"         "0"         "0"         "0"         "0"      "19.5"      "19.5"         "0"         "0"         "0"         "0"         "0"
						#        2008
						#         "0"

						# > x
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
						#        "11"      "1946"      "40.5"      "38.5"        " 3"          NA          NA          NA      "19.5"          NA          NA          NA
						#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
						#      "19.5"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
						#        2008
						#         "0"

						#  x=smkdat[69,]
						# > x
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15
						#        "69"      "1921"      "65.3"          NA        " 2"          NA
						#   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
						#      "39.5"      "39.5"        "45"        "45"      "39.5"      "39.5"
						#    past.cpd        1986        1988        1990        1992        1994
						#          NA      "39.5"      "39.5"      "39.5"      "39.5"      "39.5"
						#        1996        1998        2000        2002        2004        2006
						#      "39.5"      "39.5"      "39.5"      "39.5"      "39.5"      "39.5"
						#        2008
						#      "39.5"

						# > smkdat[151,]
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+    past.cpd        1986
						#       "151"      "1915"      "70.8"          NA        " 2"         "0"         "0"      "19.5"      "19.5"      "19.5"          NA          NA          NA         "0"
						#        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006        2008
						#         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
						# > x=smkdat[79,]
						# > x
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+    past.cpd        1986
						#        "79"      "1912"      "74.3"      "69.3"        " 3"         "0"         "0"      "19.5"      "29.5"      "39.5"        "45"        "45"      "45.5"         "0"
						#        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006        2008
						#         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
						# > x=smkdat[728,]
						# > x
						#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+    past.cpd        1986
						#       "728"      "1932"      "54.6"          NA          NA          NA          NA          NA          NA          NA          NA          NA          NA         "0"
						#        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006        2008
						#      "19.5"      "19.5"      "19.5"      "19.5"         "0"         "0"         "0"         "0"         "0"         "0"         "0"

						cpd.past = x[cpd.past.cols]
						cpd.current = x[cpd.current.cols]

						cpd.past
						cpd.current
						# > 						cpd.past
						# CPD_10_15 CPD_16_19 CPD_20_29 CPD_30_39 CPD_40_49 CPD_50_59  CPD_60_+
						#        NA        NA        NA        NA        NA        NA        NA
						# > 						cpd.current
						# 1986 1988 1990 1992 1994 1996 1998 2000 2002 2004 2006 2008
						#  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"


						# x  j=49
						#       YOB  ageentry age_start age_quit2 smkstatus  past.cpd      1976      1978      1980      1982
						#    1937.0      39.6      19.0      22.0       2.0      19.5       0.0       0.0       9.5       0.0
						#      1984      1986      1988      1990      1992      1994      1996      1998      2000      2002
						#       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0       0.0
						#      2004      2006      2008
						#       0.0       0.0       0.0
						# >

						################## [1] Make Profile #########################################################
						profile=ags=dos=ags2=dos2=NULL

									######### (1) Make a profile for the argument ###########
									######### Make profile = list( breaks, dose) for each individual which is an argment for p2.plot() ######
									# former smoker: profile <- list(breaks=c(20,45,100),dose=c(0,40,0)): until age 20, dose=0, until age 45, dose 40, then quit
									# current smoker: profile <- list(breaks=c(20,100),dose=c(0,20)):    until age 20, dose was 0 and from then on to 100, dose was 20 (current smoker)

						### status at 1986 at entry ##
						status = as.numeric(x["smkstatus86"])
						status
						#smk86	 smoking 1=no  2=yes, current  3=yes, past


						###### some people have smoking status NA
						if(is.na(status)==T){
								# > x
								#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15
								#         "4"      "1922"      "63.4"          NA          NA          NA
								#   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
								#          NA          NA          NA          NA          NA          NA
								#    past.cpd        1986        1988        1990        1992        1994
								#          NA         "0"         "0"         "0"         "0"         "0"
								#        1996        1998        2000        2002        2004        2006
								#         "0"         "0"         "0"         "0"         "0"         "0"
								#        2008
								#         "0"

								# > smkdat[360,]
								#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15
								#       "360"      "1938"      "47.6"      "45.6"          NA         "0"
								#   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
								#       "2.5"      "19.5"       "9.5"       "2.5"          NA          NA
								#    past.cpd        1986        1988        1990        1992        1994
								#          NA         "0"         "0"         "0"         "0"         "0"
								#        1996        1998        2000        2002        2004        2006
								#         "0"         "0"         "0"         "0"         "0"         "0"
								#        2008
								#         "0"


								####### assign smoking status ########

								indic.nocurrent = (sum(as.numeric(cpd.current))==0)   # if all cpd is zero
								indic.nopast = sum(cpd.past!=0 & is.na(cpd.past)==F)==0    # there is no element which is no zoer or non NA
								indic.nocurrent
								indic.nopast

								if(indic.nopast==T & indic.nocurrent==T ){  # then this is no smoker

								     status = 1

								}


								if(indic.nopast==F & indic.nocurrent==T){  # then this is no smoker

								     status = 3   # previous smoker 3

								}

								if(indic.nopast==F & indic.nocurrent==F){  # then this is no smoker

								     status = 2   # current smoker 3

								}

								if(indic.nopast==F & indic.nocurrent==T){  # then this is no smoker

								     status = 3   # previous smoker 3

								}

								if(indic.nopast==T & indic.nocurrent==F){  # there is no past info, but started smoking during the trial

								     status = 2   # current smoker 3

								}




						}#3nd of


						if(status==1){   ## never smoked:

							profile = list(breaks=c(max.age-1, max.age), dose=c(0, 0))   # there is no starting age, so I gave just start.age=109 and death.age=110
							profile
							# $breaks
							# [1] 109 110 --> starting age 109 death age 110, but dosage below is zero anyway
							#
							# $dose
							# [1] 0 0


						}#end of


						####### smokers who (1) quit either before trial, (2) during tiral or (3) never quit
						if(status!=1){


								age_start=age_quit=ags2=dos2=ags3=ags4=dos3=dos4=NA

								######## (1) DEFINE some age variables for past cpd information ##################
								# > cpd.past
								# CPD_10_15 CPD_16_19 CPD_20_29 CPD_30_39 CPD_40_49 CPD_50_59  CPD_60_+
								#       "0"      "45"      "45"       "0"       "0"       "0"        NA

								startAges = c(10, 16, 20, 30, 40, 50, 60)
								quitAges = c( 15, 19, 29, 39, 49, 59, NA)

								## need this to assign dosage to the mid age)
								medAges=c(mean(c(10,15)), mean(c(16,19)), mean(c(20,29)), mean(c(30,39)), mean(c(40, 49)), mean(c(50,59)), 60)
								medAges
								#[1] 12.5 17.5 24.5 34.5 44.5 54.5 60.0

								cpd.past2 = cpd.past
								names(cpd.past2)=startAges
								cpd.past2
								#   10   16   20   30   40   50   60
								#  "0" "45" "45"  "0"  "0"  "0"   NA

								###########  (2) Define age to cpd.current columns ######################

								ages = seq((as.numeric(x["ageentry"])),  (as.numeric(x["ageentry"]))+(2008-1986), by=2)
								ages
								#[1] 50.2 52.2 54.2 56.2 58.2 60.2 62.2 64.2 66.2 68.2 70.2 72.2

								# > length(ages)
								# [1] 12
								# > length(cpd.current)
								# [1] 12

								cpd.current2=cpd.current
								names(cpd.current2)=ages
								cpd.current2
								# 50.2 52.2 54.2 56.2 58.2 60.2 62.2 64.2 66.2 68.2 70.2 72.2
								#  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"  "0"



								### identify first age group where cpd is not zero

								where=which(cpd.past2!=0)
								where
								# 16 20
								#  2  3

								# > where
								# 20 30 40 50
								#  3  4  5  6

								# > cpd.past2
								#     10     16     20     30     40     50     60
								#    "0"    "0"  "9.5"  "9.5" "19.5" "19.5"     NA
								# > cpd.current2
								#   55.5   57.5   59.5   61.5   63.5   65.5   67.5   69.5   71.5   73.5   75.5   77.5
								# "19.5" "19.5" "19.5" "29.5"    "0"    "0"    "0"    "0"    "0"    "0"    "0"    "0"

								##### identify if this person ever smoked during the trial ###

								where2 = which(cpd.current2!=0)
								where2
								# 55.5 57.5 59.5 61.5
								#    1    2    3    4


								############### correct some misspecification ###
								if(status==2){


									### some modification of status in case it's wrong ###
									# > x
									#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+    past.cpd        1986
									#       "151"      "1915"      "70.8"          NA        " 2"         "0"         "0"      "19.5"      "19.5"      "19.5"          NA          NA          NA         "0"
									#        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006        2008
									#         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
								    if(length(where2)==0){  status=3 }

								    # although this person said he didn't quit smoking cpd during trials are all zero, so actally quit smoking


								}



								if(status==3 ){   # smoked but quit at some point of her life

													#        id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
													#        "22"      "1936"      "50.2"      "45.2"        " 3"         "0"        "45"        "45"         "0"         "0"         "0"          NA
													#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
													#      "45.5"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
													#        2008
													#         "0"

													#age_quit = as.numeric(x["age_quit"])
													#[1] 45.2

													## quit age should be redefined based on the dosage ##

										###### if there is at some point where cpd is not zero: i.e. at some point of past, smoked ####

										if(length(where)!=0){   ## if there is past smoking evidence ###

												########## identify first smoking age ###

												age_start = as.numeric(startAges[(where[1])])  #[1] 16
												age_start

												######### identify quit smoking age ######

												age_quit = as.numeric(quitAges[where[length(where)]])
												age_quit
												#[1] 29

												if(is.na(age_quit)==T){  age_quit=as.numeric(x["age_quit"]) }
												if(is.na(age_quit)==T) {  age_quit = 60   }

												### median age for the dosage group ##
												ags2 = medAges[where]
												ags2
												#[1] 17.5 24.5

												### dosage ###
												dos2= as.numeric(cpd.past2[where])
												dos2
												#[1] 45 45

												profile = list(breaks=c(age_start, ags2, age_quit, max.age),
																dose = c(0,  dos2, dos2[length(dos2)],0))

												profile
												# $breaks
												# [1]  16.0  17.5  24.5  29.0 110.0
												#
												# $dose
												# [1]  0 45 45 45  0
												#
												# >
												cbind(profile[[1]],profile[[2]])
												#       [,1] [,2]
												# [1,]  16.0    0
												# [2,]  17.5   45
												# [3,]  24.5   45
												# [4,]  29.0   45
												# [5,] 110.0    0
												# >
												# > x
												#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
												#        "22"      "1936"      "50.2"      "45.2"        " 3"         "0"        "45"        "45"         "0"         "0"         "0"          NA
												#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
												#      "45.5"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
												#        2008
												#         "0"


												####### although they said they quit smoking as of 1986, some can somke during the trial then profile should be modified ##

												if(sum(cpd.current2 > 0, na.rm=T) > 0){

														# > cpd.current2
														#   69.3   71.3   73.3   75.3   77.3   79.3   81.3   83.3   85.3   87.3   89.3   91.3
														#    "0"    "0"    "0"    "0" "19.5" "19.5"    "0"    "0"    "0"    "0"    "0"    "0"

														ags3=as.numeric(names(cpd.current2))[where2]
														ags3
														#[1] 77.3 79.3
														dos3=as.numeric(cpd.current2)[where2]
														dos3
														#[1] 19.5 19.5

														### right before 77.3, he didn't smoke so put the soage
														dos4=c(0, dos3)
														ags4=c(ags3[1]-1,  ags3)

														### otherwise it becomes like this:
														#cbind(profile[[1]],profile[[2]])
														# [,1] [,2]
														# [1,]  20.0  0.0
														# [2,]  24.5 19.5
														# [3,]  34.5 19.5
														# [4,]  44.5 19.5
														# [5,]  49.0 19.5
														# [6,]  77.3 19.5
														# [7,]  79.3 19.5
														# [8,] 110.0  0.0


														#       [,1] [,2]
														# [1,]  20.0  0.0
														# [2,]  24.5 19.5
														# [3,]  34.5 19.5
														# [4,]  44.5 19.5
														# [5,]  49.0 19.5
														# [6,] 110.0  0.0
														# >
														# > x
														#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
														#        "16"      "1917"      "69.3"      "66.3"        " 3"          NA          NA      "19.5"      "19.5"      "19.5"          NA          NA
														#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
														#      "19.5"         "0"         "0"         "0"         "0"      "19.5"      "19.5"         "0"         "0"         "0"         "0"         "0"
														#        2008
														#         "0"



														profile = list(breaks=c(age_start, ags2, age_quit, ags4, max.age),
																		dose = c(0,  dos2, dos2[length(dos2)], dos4, 0))

														cbind(profile[[1]],profile[[2]])
														#        [,1] [,2]
														#  [1,]  20.0  0.0
														#  [2,]  24.5 19.5
														#  [3,]  34.5 19.5
														#  [4,]  44.5 19.5
														#  [5,]  49.0 19.5
														#  [6,]  76.3  0.0
														#  [7,]  77.3 19.5
														#  [8,]  79.3 19.5
														#  [9,] 110.0  0.0


												}# if(sum(cpd.current2 > 0)){

										} # if(length(where)!=0)

																				###### no past c/day information although it said so

										if(length(where)==0){

											#print("No past smoking information (cig/day) provided for whom specified herself/himself as smokers")
											profile=NA
											## then possibly just have to use current smoking information ##

											if(sum(cpd.current2 > 0, na.rm=T) == 0){ # if there is not even current moking inffo, then never smokers

													profile = list(breaks=c(max.age-1, max.age), dose=c(0, 0))   # there is no starting age, so I gave just start.age=109 and death.age=110
													profile
													# $breaks
													# [1] 109 110 --> starting age 109 death age 110, but dosage below is zero anyway
													#
													# $dose
													# [1] 0 0

											}#
											if(sum(cpd.current2 > 0) > 0){  # if there is current smoker information

														# > cpd.current2
														#   55.5   57.5   59.5   61.5   63.5   65.5   67.5   69.5   71.5   73.5   75.5   77.5
														#    "0"    "0"    "0"    "0" "19.5" "19.5"    "0"    "0"    "0"    "0"    "0"    "0"

														where2 = as.numeric(which(cpd.current2!=0))
														where2
														#[1] 5 6
														age_start2 = as.numeric(names(cpd.current2))[where2[1]]
														#[1] 63.5



														ags3b=as.numeric(names(cpd.current2))[where2]
														ags3b
														#[1][1] 63.5 65.5
														dos3b=as.numeric(cpd.current2)[where2]
														dos3b
														#[1] 19.5 19.5



														profile = list(breaks=c(age_start2, ags3b, max.age),
																		dose = c(0,   dos3b, 0))

														cbind(profile[[1]],profile[[2]])
														# 			cbind(profile[[1]],profile[[2]])
														#       [,1] [,2]
														# [1,]  63.5  0.0
														# [2,]  63.5 19.5
														# [3,]  65.5 19.5
														# [4,] 110.0  0.0


											}#3nd of  if(sum(cpd.current2 > 0) > 0)


										}# end of if(length(where)==0){

								}#end of status===3


								if(status==2){   # smokers but didn't quit before the trial

										# > x
										#         id2         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39   CPD_40_49   CPD_50_59    CPD_60_+
										#         "6"      "1931"      "55.5"          NA        " 2"         "0"         "0"       "9.5"       "9.5"      "19.5"      "19.5"          NA
										#    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000        2002        2004        2006
										#          NA      "19.5"      "19.5"      "19.5"      "29.5"         "0"         "0"         "0"         "0"         "0"         "0"         "0"
										#        2008
										#         "0"


										# > cpd.past
										# CPD_10_15 CPD_16_19 CPD_20_29 CPD_30_39 CPD_40_49 CPD_50_59  CPD_60_+
										#       "0"       "0"     "9.5"     "9.5"    "19.5"    "19.5"        NA
										# > cpd.current
										#   1986   1988   1990   1992   1994   1996   1998   2000   2002   2004   2006   2008
										# "19.5" "19.5" "19.5" "29.5"    "0"    "0"    "0"    "0"    "0"    "0"    "0"    "0"

										###### if there is at some point where cpd is not zero: i.e. at some point of past, smoked ####

										if(length(where)!=0){   ## if there is past smoking evidence ###


												# > cpd.past2
												#     10     16     20     30     40     50     60
												#    "0"    "0"  "9.5"  "9.5" "19.5" "19.5"     NA
												# > cpd.current2
												#   55.5   57.5   59.5   61.5   63.5   65.5   67.5   69.5   71.5   73.5   75.5   77.5
												# "19.5" "19.5" "19.5" "29.5"    "0"    "0"    "0"    "0"    "0"    "0"    "0"    "0"

												########## identify first smoking age ###

												age_start = as.numeric(startAges[(where[1])])  #[1] 16
												age_start
												#[1] 20

												### median age for the dosage group ##
												ags2 = medAges[where]
												ags2
												#[1] 17.5 24.5
												#[1] 24.5 34.5 44.5 54.5

												### dosage ###
												dos2= as.numeric(cpd.past2[where])
												dos2
												#[1] 45 45
												#[1]  9.5  9.5 19.5 19.5


												### smoking history after the entyr

												if(length(where2)>0){

														# > cpd.current2
														#   55.5   57.5   59.5   61.5   63.5   65.5   67.5   69.5   71.5   73.5   75.5   77.5
														# "19.5" "19.5" "19.5" "29.5"    "0"    "0"    "0"    "0"    "0"    "0"    "0"    "0"

														####### identify quit age ########

														where3=which(cpd.current2==0)
														where3
														# > where3
														# 63.5 65.5 67.5 69.5 71.5 73.5 75.5 77.5
														#    5    6    7    8    9   10   11   12

														#### if the person never quit smoking during tirla
														if(length(where3)==0){

																# > cpd.past2
																#     10     16     20     30     40     50     60
																#    "0"    "0" "29.5" "39.5" "39.5" "29.5"     NA
																# > cpd.current2
																#   58.8   60.8   62.8   64.8   66.8   68.8   70.8   72.8   74.8   76.8   78.8   80.8
																# "29.5" "29.5" "29.5" "29.5" "29.5" "29.5" "29.5" "29.5" "29.5" "29.5" "29.5" "29.5"

																ags3=as.numeric(names(cpd.current2))
																dos3=as.numeric(cpd.current2)

																ags3
																#[1] 58.8 60.8 62.8 64.8 66.8 68.8 70.8 72.8 74.8 76.8 78.8 80.8
																dos3
																#[1] 29.5 29.5 29.5 29.5 29.5 29.5 29.5 29.5 29.5 29.5 29.5 29.5

																## assume the dosage until death is the mean of this trial
																m.dos3 =mean(dos3)


																profile=list(breaks=c(age_start, ags2, ags3, max.age),
																			 dose=c(0, dos2, dos3,m.dos3))
																cbind(profile[[1]],profile[[2]])
																# 	[,1] [,2]
																#  [1,]  20.0  0.0
																#  [2,]  24.5 29.5
																#  [3,]  34.5 39.5
																#  [4,]  44.5 39.5
																#  [5,]  54.5 29.5
																#  [6,]  58.8 29.5
																#  [7,]  60.8 29.5
																#  [8,]  62.8 29.5
																#  [9,]  64.8 29.5
																# [10,]  66.8 29.5
																# [11,]  68.8 29.5
																# [12,]  70.8 29.5
																# [13,]  72.8 29.5
																# [14,]  74.8 29.5
																# [15,]  76.8 29.5
																# [16,]  78.8 29.5
																# [17,]  80.8 29.5
																# [18,] 110.0 29.5



														}#end of if(length(where3)==0){


														### if the person quit smoking during the trial
														if(length(where3)>0){

																age_quit = as.numeric(names(cpd.current2))[where3[1]]
																age_quit
																#[1] 63.5

																ags3=as.numeric(names(cpd.current2))[cpd.current2!=0]
																dos3=as.numeric(cpd.current2)[cpd.current2!=0]

																ags3
																#[1] 55.5 57.5 59.5 61.5
																dos3
																#[1] 19.5 19.5 19.5 29.5


																profile=list(breaks=c(age_start, ags2, ags3,age_quit, max.age),
																			 dose=c(0, dos2, dos2[length(dos2)],dos3,0))
																cbind(profile[[1]],profile[[2]])
																#        [,1] [,2]
																#  [1,]  20.0  0.0
																#  [2,]  24.5  9.5
																#  [3,]  34.5  9.5
																#  [4,]  44.5 19.5
																#  [5,]  54.5 19.5
																#  [6,]  55.5 19.5
																#  [7,]  57.5 19.5
																#  [8,]  59.5 19.5
																#  [9,]  61.5 19.5
																# [10,]  63.5 29.5
																# [11,] 110.0  0.0
																# >
																# > cpd.past2
																#     10     16     20     30     40     50     60
																#    "0"    "0"  "9.5"  "9.5" "19.5" "19.5"     NA
																# > cpd.current2
																#   55.5   57.5   59.5   61.5   63.5   65.5   67.5   69.5   71.5   73.5   75.5   77.5
																# "19.5" "19.5" "19.5" "29.5"    "0"    "0"    "0"    "0"    "0"    "0"    "0"    "0"

														}#end of if(length(where3)>3){

												}#end of end of if(length(where2)>0){

												#### some people
												if(length(where2)==0){

														#print("Note: this person specified that he hasn't quit smoking but all the cpd value during trial is zero")
											    }








											}#end of if(length(where)!=0){


											if(length(where)==0){   ## if there is NO past smoking evidence ###


															### then possibly started smoking during the trial ###
														#print("No past smoking information (cig/day) provided for whom specified herself/himself as smokers")
														profile=NA
														## then possibly just have to use current smoking information ##

														if(sum(cpd.current2 > 0, na.rm=T) == 0){ # if there is not even current moking inffo, then never smokers

																profile = list(breaks=c(max.age-1, max.age), dose=c(0, 0))   # there is no starting age, so I gave just start.age=109 and death.age=110
																profile
																# $breaks
																# [1] 109 110 --> starting age 109 death age 110, but dosage below is zero anyway
																#
																# $dose
																# [1] 0 0

														}#
														if(sum(cpd.current2 > 0) > 0){  # if there is current smoker information

																	# > cpd.current2
																	#   55.5   57.5   59.5   61.5   63.5   65.5   67.5   69.5   71.5   73.5   75.5   77.5
																	#    "0"    "0"    "0"    "0" "19.5" "19.5"    "0"    "0"    "0"    "0"    "0"    "0"

																	where2 = as.numeric(which(cpd.current2!=0))
																	where2
																	#[1] 5 6
																	age_start2 = as.numeric(names(cpd.current2))[where2[1]]
																	#[1] 63.5



																	ags3b=as.numeric(names(cpd.current2))[where2]
																	ags3b
																	#[1][1] 63.5 65.5
																	dos3b=as.numeric(cpd.current2)[where2]
																	dos3b
																	#[1] 19.5 19.5



																	profile = list(breaks=c(age_start2, ags3b, max.age),
																					dose = c(0,   dos3b, 0))

																	cbind(profile[[1]],profile[[2]])
																	# 			cbind(profile[[1]],profile[[2]])
																	#       [,1] [,2]
																	# [1,]  63.5  0.0
																	# [2,]  63.5 19.5
																	# [3,]  65.5 19.5
																	# [4,] 110.0  0.0


														}#3nd of  if(sum(cpd.current2 > 0) > 0)



											}#end of if(length(where)==0)



							 } # status==2

						}#3nd of if(status!=1){



						profile
						# > profile
						# $breaks
						#  [1]  20.0  55.1  57.1  59.1  61.1  63.1  65.1  67.1  69.1  71.1  73.1  75.1  77.1  79.1  81.1  83.1  85.1  87.1 110.0
						#
						# $dose
						#  [1]  0.00 26.56 39.50 29.50 39.50 19.50 29.50 19.50 19.50 19.50 29.50 29.50 19.50 19.50 29.50 19.50 29.50 29.50 29.50

        }# end of

						profile
						# > profile
						# $breaks
						#  [1]  20.0  55.1  57.1  59.1  61.1  63.1  65.1  67.1  69.1  71.1  73.1  75.1  77.1  79.1  81.1  83.1  85.1  87.1 110.0
						#
						# $dose
						#  [1]  0.00 26.56 39.50 29.50 39.50 19.50 29.50 19.50 19.50 19.50 29.50 29.50 19.50 19.50 29.50 19.50 29.50 29.50 29.50



	}#end of


			##### 3/23/2015: this calculate pack-years not until age 100, but until the age of LC diagnosis

			myPKY.male.LC.case <- function(x, cpd.past.cols,  cpd.current.cols){

				#         id2       agelc        type     subtype         YOB    ageentry    age_quit smkstatus86   CPD_10_15   CPD_16_19   CPD_20_29   CPD_30_39
				#         6.0          NA          NA          NA      1931.0        55.5          NA         2.0         0.0         0.0         9.5         9.5
				#   CPD_40_49   CPD_50_59    CPD_60_+    past.cpd        1986        1988        1990        1992        1994        1996        1998        2000
				#        19.5        19.5          NA          NA        19.5        19.5        19.5        29.5         0.0         0.0         0.0         0.0
				#        2002        2004        2006        2008
				#         0.0         0.0         0.0         0.0
	            ans=NA
	            profile=NULL




	            profile = myProfile.NHSPF_male.LC.case(x, cpd.past.cols,  cpd.current.cols)

				profile
				# $breaks
				# [1] 109 110
				#
				# $dose
				# [1] 0 0

				####### make pack-years ######
				# $breaks
				# [1]  18.0  47.6  49.6 101.0
				#
				# $dose
				# [1]  0.0 39.5 39.5  0.0


				if(is.null(profile)==F){  # profile=NULL for non-LC cases

						br=profile$breaks
						# > br=profile$breaks
						# > br
						# [1]  18.0  47.6  49.6 101.0
						do=profile$dose
						# > do
						# [1]  0.0 39.5 39.5  0.0


						#if(sum(indic)>0) {  br=br[indic] ; do=do[indic] }

						br
						do
						for(j in 1:length(br)){


							   dur = NA
							   if(j==1)  dur= br[1]-1
							   if(j >1) dur=br[j]-br[j-1]   # [1] 29.6 = 47.6 - 18

							   pkyr0 = dur * do[j]/20  # 29.6*39.5
							   pkyr0
							   #[1] 58.46  # total 1169 cig/day

							   if(j==1)  { pkyr = pkyr0}
							   if(j>1) pkyr = c(pkyr,pkyr0)

							   pkyr
							   #[1]  0.00 58.46  3.95  0.00
						}#

						ans=sum(pkyr)

				}#3nd of

				ans




	}#end of

			myPKY.male <- function(x, max.age, cpd.past.cols,  cpd.current.cols){


	            profile=NA

	            profile = myProfile.NHSPF_male(x, max.age, cpd.past.cols,  cpd.current.cols)

				profile
				# $breaks
				# [1] 109 110
				#
				# $dose
				# [1] 0 0

				####### make pack-years ######
				# $breaks
				# [1]  18.0  47.6  49.6 101.0
				#
				# $dose
				# [1]  0.0 39.5 39.5  0.0


				br=profile$breaks
				# > br=profile$breaks
				# > br
				# [1]  18.0  47.6  49.6 101.0
				do=profile$dose
				# > do
				# [1]  0.0 39.5 39.5  0.0


				#if(sum(indic)>0) {  br=br[indic] ; do=do[indic] }

				br
				do
				for(j in 1:length(br)){


					   dur = NA
					   if(j==1)  dur= br[1]-1
					   if(j >1) dur=br[j]-br[j-1]   # [1] 29.6 = 47.6 - 18

					   pkyr0 = dur * do[j]/20  # 29.6*39.5
					   pkyr0
					   #[1] 58.46  # total 1169 cig/day

					   if(j==1)  { pkyr = pkyr0}
					   if(j>1) pkyr = c(pkyr,pkyr0)

					   pkyr
					   #[1]  0.00 58.46  3.95  0.00
				}#

				sum(pkyr)




	}#end of


	identifyPch <- function(x, y = NULL, n = length(x), pch = 19, ...)
{
    xy <- xy.coords(x, y); x <- xy$x; y <- xy$y
    sel <- rep(FALSE, length(x)); res <- integer(0)
    while(sum(sel) < n) {
        ans <- identify(x[!sel], y[!sel], n = 1, plot = FALSE, ...)
        if(!length(ans)) break
        ans <- which(!sel)[ans]
        points(x[ans], y[ans], pch = pch)
        sel[ans] <- TRUE
        res <- c(res, ans)
    }
    res
}






	myZeros.small <- function(x,cumHaz.years){
					#x
					#            6            7            8            9           10           11           12           13           14           15           16
					# 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00
					#           17           18           19           20           21           22           23           24           25           26           27
					# 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00
					#           28           29           30           31           32           33           34           35           36           37           38
					# 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00
					#           39           40           41           42           43           44           45           46           47           48           49
					# 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 4.795277e-05
					#           50           51           52           53           54           55           56           57           58           59           60
					# 5.282389e-05 5.818134e-05 6.407346e-05 7.055331e-05 7.767920e-05 8.551513e-05 9.413137e-05 1.036050e-04 1.140207e-04 1.254713e-04 1.380585e-04
					#           61           62           63           64           65           66           67           68           69           70           71
					# 1.518939e-04 1.670997e-04 1.838099e-04 2.021712e-04 2.223439e-04 2.445036e-04 2.688421e-04 2.955689e-04 3.249127e-04 3.571230e-04 3.924717e-04
					#           72           73           74           75           76           77           78           79           80           81           82
					# 4.312545e-04 4.737932e-04 5.204374e-04 5.715660e-04 6.275896e-04 6.889520e-04 7.561322e-04 8.296463e-04 9.100490e-04 9.979347e-04 1.093939e-03
					#           83           84           85           86           87           88           89           90           91           92           93
					# 1.198740e-03 1.313056e-03 1.437650e-03 1.573324e-03 1.720918e-03 1.881309e-03 2.055406e-03 2.244143e-03 2.448474e-03 2.669361e-03 2.907768e-03
					#           94           95           96           97           98           99          100
					# 3.164642e-03 3.440902e-03 3.737422e-03 4.055009e-03 4.394383e-03 4.756155e-03 5.140800e-03


					### [1] Find first age when it's not zero ###
					#> min(as.numeric(names(x))[x!=0])
					#[1] 49

					# > cumHaz.years = 20
					# >
					age.end = min(as.numeric(names(x))[x!=0]) + cumHaz.years
					age.end
					# [1] 69

					### put zero after the end age
					x2=x
					x2[as.numeric(names(x)) > age.end]=0
					x2
					#           6            7            8            9           10           11           12           13           14           15           16
					# 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00
					#           17           18           19           20           21           22           23           24           25           26           27
					# 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00
					#           28           29           30           31           32           33           34           35           36           37           38
					# 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00
					#           39           40           41           42           43           44           45           46           47           48           49
					# 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 4.795277e-05
					#           50           51           52           53           54           55           56           57           58           59           60
					# 5.282389e-05 5.818134e-05 6.407346e-05 7.055331e-05 7.767920e-05 8.551513e-05 9.413137e-05 1.036050e-04 1.140207e-04 1.254713e-04 1.380585e-04
					#           61           62           63           64           65           66           67           68           69           70           71
					# 1.518939e-04 1.670997e-04 1.838099e-04 2.021712e-04 2.223439e-04 2.445036e-04 2.688421e-04 2.955689e-04 3.249127e-04 0.000000e+00 0.000000e+00
					#           72           73           74           75           76           77           78           79           80           81           82
					# 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00
					#           83           84           85           86           87           88           89           90           91           92           93
					# 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00
					#           94           95           96           97           98           99          100
					# 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00


		 }#end of





			myHazPlot=function(hzs, y, x, hzsum,indic.sub.y,indic.sub.x, type,Main){

					if(type==1) main2="(Only sub-population > hazard threshold considered)"
					if(type==2) main2="(Only sub-population at a given hazard interval considered)"

					for(i in 1:length(hzs)){

						tt2=NA
						hz=hzs[i]

						  #y=time.cdet.data
								#indic.y = indic.std.dat==T & hzsum >= hz  #; sum(indic.y,na.rm=T)

						  #x=time.cdet
								#indic.x = indic.std.model==T & hzsum >= hz #; sum(indic.x,na.rm=T)

					      if(type==1){
					        indic.y= indic.sub.y == T & hzsum >= hz
					        indic.x= indic.sub.x == T & hzsum >= hz
					      }

					      if(type==2){

								if(i==length(hzs)) break

								hz2=hzs[i+1]
								hz #[1] 0
								hz2 #[1] 0.1

								indic.y = indic.sub.y == T & hzsum >= hz & hzsum < hz2 #; sum(indic.y,na.rm=T)
								indic.x = indic.sub.x == T & hzsum >= hz & hzsum < hz2 # ; sum(indic.x,na.rm=T)

					      }#

						  #m1=median(y[indic.y],na.rm=T)
						  #m2=median(x[indic.x],na.rm=T)
						  m1=mean(y[indic.y],na.rm=T)
						  m2=mean(x[indic.x],na.rm=T)

						   tm1=na.omit(y[indic.y])
						   tm2=na.omit(x[indic.x])
						   #tt2<t.test(tm1,tm2)
						  try(tt2<t.test(y[indic.y],x[indic.x]),silent=T)

						  if(is.na(tt2)==T) p = NA
						  if(is.na(tt2)==F) p=tt2$p.value
						  tm1=c(hazard=hz, median.data=m1,median.model=m2, dif = m2-m1, p=p,N1=sum(indic.y,na.rm=T), N2=sum(indic.x, na.rm=T ))
						  tm1
						  if(i==1) out=tm1
						  if(i>1) out=rbind(out,tm1)


					}#end of

					row.names(out)=1:nrow(out)
					out
					#    hazard median.data median.model   dif            p   N1   N2
					# 1     0.1       21.50         21.5  0.00 9.660960e-01 2288 2477
					# 2     0.2       21.40         21.4  0.00 7.905917e-01 2082 2193
					# 3     0.3       21.40         21.2 -0.20 5.155085e-01 1712 1815
					# 4     0.4       21.20         21.2  0.00 7.976144e-01 1276 1346
					# 5     0.5       21.00         21.3  0.30 1.712471e-01  867  899
					# 6     0.6       20.30         21.7  1.40 1.432582e-05  607  560
					# 7     0.7       19.65         22.1  2.45 1.954627e-08  472  379
					# 8     0.8       17.85         21.4  3.55 2.458826e-07  378  268
					# 9     0.9       17.30         20.5  3.20 2.405491e-03  195  123
					# 10    1.0       14.10         20.8  6.70 3.229402e-03   73   47


					rg = range(out[,2:3],na.rm=T)
					plot(out[,"hazard"],out[,"median.data"],col="red", pch=16,xlab="Cumulative Hazard threshold",
										ylab="Time to LC incidence", ylim=rg,cex=2,
										main=paste(Main, " Time to LC incidence by cumulative hazard level \n", main2,sep=""))


					points(out[,"hazard"], out[,"median.model"], col="blue",pch=17,cex=2)

					legend(x="bottomleft",fill=c("blue","red"),legend=c("Data","Model"),cex=1.5)
					plot(out[,"hazard"],out[,"dif"],col="dark green", pch=16,xlab="Cumulative Hazard threshold",
										ylab="Time to LC incidence", cex=2,
										main=paste(Main, " Difference in incidence time \n between data and model by hazard",sep=""))
					abline(h=0,col="red",lty="dotted",cex=1.5)
					out

			}#end of

myCI=function(n,N) {

	# > n
	# [1]  0 18 10 19 13  6

  p=n/N
  #[1] 0.00000000 0.27272727 0.15151515 0.28787879 0.19696970 0.09090909

  tm1=1.96*sqrt(p*(1-p)/N)
  #[1] 0.00000000 0.10744768 0.08650360 0.10923603 0.09595106 0.06935718

  cbind(n=n, CI1=(p-tm1)*N, CI2=(p+tm1)*N)  # multiply N since we like to get CI for counts, not proportion
#       n       CI1      CI2
# [1,]  0  0.000000  0.00000
# [2,] 18 10.908453 25.09155
# [3,] 10  4.290762 15.70924
# [4,] 19 11.790422 26.20958
# [5,] 13  6.667230 19.33277
# [6,]  6  1.422426 10.57757

}
#myCI(n,N)
#       n       CI1      CI2
# [1,]  0  0.000000  0.00000
# [2,] 18 10.908453 25.09155
# [3,] 10  4.290762 15.70924
# [4,] 19 11.790422 26.20958
# [5,] 13  6.667230 19.33277
# [6,]  6  1.422426 10.57757

myCI.cum=function(n){  # confidence interval of cmuliative counts ##

	### this is:    (p1+p2)+1.96*sqrt((p1(1-p1)+p2(1-p2))/N )
	### so  95% CI: n1+n2 + N*1.96*sqrt((p1(1-p1)+p2(1-p2))/N )

   #n=c(0, 18, 10, 19, 13, 6)
   ### phat ##########
   N=sum(n)
   p = n/N
   p
	#[1] 0.00000000 0.27272727 0.15151515 0.28787879 0.19696970 0.09090909

   p.prod = p*(1-p)
	# > p.prod
	# [1] 0.00000000 0.19834711 0.12855831 0.20500459 0.15817264 0.08264463
	# > cumsum(p.prod)
	# [1] 0.0000000 0.1983471 0.3269054 0.5319100 0.6900826 0.7727273

	# 	> cumsum(p)
	# [1] 0.0000000 0.2727273 0.4242424 0.7121212 0.9090909 1.0000000

   se = rep(NA,length(p))
	ans=cbind(n=cumsum(p)*N, CI1=N*(cumsum(p)-1.96*sqrt(cumsum(p.prod)/N)), CI2=N*(cumsum(p)+1.96*sqrt(cumsum(p.prod)/N)))

	### this is:    (p1+p2)+1.96*sqrt((p1(1-p1)+p2(1-p2))/N )
	### so  95% CI: n1+n2 + N*1.96*sqrt((p1(1-p1)+p2(1-p2))/N )

	## where p1= n1/N, p2=n2/N
	ans
	#       n      CI1      CI2
	# [1,]  0  0.00000  0.00000
	# [2,] 18 10.90845 25.09155
	# [3,] 28 18.89586 37.10414
	# [4,] 47 35.38693 58.61307
	# [5,] 60 46.77247 73.22753
	# [6,] 66 52.00280 79.99720


}

#myCI.cum(n)
# > myCI.cum(n,N)
#       n      CI1      CI2
# [1,]  0  0.00000  0.00000
# [2,] 18 10.90845 25.09155
# [3,] 28 18.89586 37.10414
# [4,] 47 35.38693 58.61307
# [5,] 60 46.77247 73.22753
# [6,] 66 52.00280 79.99720


#years=1:13
#x=time.dx.std[age.dx.std <= age.OCM & mdet.dx.std==1]

	myTab.years <- function(x, years){   # give a count by year
		# > years
		#  [1]  1  2  3  4  5  6  7  8  9 10 11 12 13

		tb = rep(0, length(years)); names(tb)=years
		# > tb
		#  1  2  3  4  5  6  7  8  9 10 11 12 13
		#  0  0  0  0  0  0  0  0  0  0  0  0  0

		for(i in years){

			 tb[i]=sum(x >= i-1 & x < i)

		}

		tb

	}#
# > myTab.years(x,years)
#    1    2    3    4    5    6    7    8    9   10   11   12   13
# 1452  499  551   22    4    1    0    0    0    0    0    0    0

# source("source.NLST.functions.R")




myEO.test=function(E,O){

    #Costantino_1999_E.O.ratio_goodness.of.fit.test.pdf
    #Rockhill_2001 paper
    # 95% CI for T=log(E/O): [log(E/O) - 1.96*sqrt(1/E), log(E/O) + 1.96*sqrt(1/E)]
    # 95% CI for E/O is: exp[log(E/O) - 1.96*sqrt(1/E), log(E/O) + 1.96*sqrt(1/E)]


    E2=E[O!=0]
    O2=O[O!=0]

    E.O.ratio =E2/O2
    CI.U = exp(log(E2/O2)+1.96*sqrt(1/E2))
    CI.L=exp(log(E2/O2)-1.96*sqrt(1/E2))
    over=(sign((1-CI.U))==sign(1-CI.L))*1
    out=cbind(round(cbind(O=O2, E=round(E2), EOratio=round(E2)/O2, CI.L=CI.L, CI.U=CI.U),2),over=over)
    out
		#      EOratio      CI.L      CI.U
		# 1  0.6934683 0.4149242 1.1590026
		# 2  0.9627280 0.6554594 1.4140390
		# 3  0.9557054 0.6586209 1.3867962
		# 4  0.8079166 0.5588454 1.1679960
		# 5  0.9650482 0.7093262 1.3129616
		# 6  1.0036752 0.7544977 1.3351451
		# 7  0.7171991 0.5470143 0.9403312
		# 8  1.0826754 0.8454350 1.3864887
		# 9  1.1911930 0.9329291 1.5209524
		# 10 1.0597968 0.8288504 1.3550929
		# 11 1.0544795 0.8207170 1.3548239
		# 12 1.2232872 0.9392913 1.5931496
		# 13 1.3387330 1.0094374 1.7754505
		colnames(out)[3]="E/O.ratio"

		tst=chisq.test(E2,p=O2/sum(O2))

		#
		# 	Chi-squared test for given probabilities
		#
		# data:  E
		# X-squared = 18.0955, df = 12, p-value = 0.1128
		#
		# > sum(((E-O)^2)/E)
		# [1] 20.04498

		### cumulative E/O ratio ##
		E3=round(sum(E2)) #[1] 185
		O3=sum(O2) #[1] 202
		cumEO.ratio = E3/O3
		CI.U2 = exp(log(E3/O3)+1.96*sqrt(1/E3))
		CI.L2=exp(log(E3/O3)-1.96*sqrt(1/E3))

		#cum=c(sumE=round(sum(E2)), sumO=sum(O2), cumEO.ratio=cumEO.ratio, CI.L=CI.L2, CI.U=CI.U2)


		cum=c(O=sum(O2),  E=round(sum(E2)), EO.ratio=round(cumEO.ratio,2), CI.L=round(CI.L2,2), CI.U=round(CI.U2,2), over=NA)

		out2=rbind(out,cum)

		ans=list(EO=out2,test=tst, cum=cum )
		ans


}#end of


myEO.test2=function(E,O,cum=F){

    #Costantino_1999_E.O.ratio_goodness.of.fit.test.pdf
    #Rockhill_2001 paper
    # 95% CI for T=log(E/O): [log(E/O) - 1.96*sqrt(1/E), log(E/O) + 1.96*sqrt(1/E)]
    # 95% CI for E/O is: exp[log(E/O) - 1.96*sqrt(1/E), log(E/O) + 1.96*sqrt(1/E)]


    E2=E[O!=0]
    O2=O[O!=0]

    E.O.ratio =E2/O2
    CI.U = exp(log(E2/O2)+1.96*sqrt(1/E2))
    CI.L=exp(log(E2/O2)-1.96*sqrt(1/E2))
    over=(sign((1-CI.U))==sign(1-CI.L))*1
    out=cbind(round(cbind(O=O2, E=round(E2), EOratio=round(E2)/O2, CI.L=CI.L, CI.U=CI.U),2),over=over)
    out
		#      EOratio      CI.L      CI.U
		# 1  0.6934683 0.4149242 1.1590026
		# 2  0.9627280 0.6554594 1.4140390
		# 3  0.9557054 0.6586209 1.3867962
		# 4  0.8079166 0.5588454 1.1679960
		# 5  0.9650482 0.7093262 1.3129616
		# 6  1.0036752 0.7544977 1.3351451
		# 7  0.7171991 0.5470143 0.9403312
		# 8  1.0826754 0.8454350 1.3864887
		# 9  1.1911930 0.9329291 1.5209524
		# 10 1.0597968 0.8288504 1.3550929
		# 11 1.0544795 0.8207170 1.3548239
		# 12 1.2232872 0.9392913 1.5931496
		# 13 1.3387330 1.0094374 1.7754505
		colnames(out)[3]="E/O.ratio"

		tst=chisq.test(E2,p=O2/sum(O2))

		#
		# 	Chi-squared test for given probabilities
		#
		# data:  E
		# X-squared = 18.0955, df = 12, p-value = 0.1128
		#
		# > sum(((E-O)^2)/E)
		# [1] 20.04498

		### cumulative E/O ratio ##
		if(cum==F){

			E3=round(sum(E2)) #[1] 185
			O3=sum(O2) #[1] 202
			cumEO.ratio = E3/O3
			CI.U2 = exp(log(E3/O3)+1.96*sqrt(1/E3))
			CI.L2=exp(log(E3/O3)-1.96*sqrt(1/E3))

			cum=c(O=sum(O2),  E=round(sum(E2)), EO.ratio=round(cumEO.ratio,2), CI.L=round(CI.L2,2), CI.U= round(CI.U2, 2),over=NA)

		}

		if(cum==T){

			E3=round((E2[length(E2)])) #[1] 185
			O3=O2[length(O2)] #[1] 202
			cumEO.ratio = E3/O3
			CI.U2 = exp(log(E3/O3)+1.96*sqrt(1/E3))
			CI.L2=exp(log(E3/O3)-1.96*sqrt(1/E3))

			cum=c(O=O3, E=E3, EO.ratio=round(cumEO.ratio,2), CI.L=round(CI.L2,2), CI.U=round(CI.U2,2), over=NA)

		}

		out2=rbind(out,cum)

		ans=list(EO=out2,test=tst, cum=cum )
		ans


}#end of


		  # years=1:10
		  # YLAB="Number of Lung Cancer Cases (Interval Detected)"
		  # MAIN="PLCO"

		   myOEplot=function(O,E,years,YLAB,MAIN){

		   		tt=cbind(O,E)
				#      O         E
				# 1   32  36.25561
				# 2   43  41.67707
				# 3   49  41.59451
				# 4   54  45.73694
				# 5   64  65.70339
				# 6   71  74.98495
				# 7  110  91.51384
				# 8   92  97.27666
				# 9   88 102.65923
				# 10  90 102.21122

				tt1=myCI(O,sum(O))
				# > tt1
				#      n      CI1       CI2
				# 1   32 21.17158  42.82842
				# 2   43 30.55255  55.44745
				# 3   49 35.77394  62.22606
				# 4   54 40.16954  67.83046
				# 5   64 49.06158  78.93842
				# 6   71 55.35362  86.64638
				# 7  110 91.14528 128.85472
				# 8   92 74.49264 109.50736
				# 9   88 70.82058 105.17942
				# 10  90 72.65520 107.34480

				par(mar=c(5,5,4,2))
				YLIM=c(0,max(cbind(tt1,E)))
		   		xx=1:length(O)
		        plot(xx, O, ylim=YLIM, xlim=c(1,max(years)),col="blue",pch=16,cex=2,cex.axis=1.5, cex.lab=1.5,
		        				xlab="Year Since Enrollment", ylab=YLAB, main=MAIN, cex.main=1.5)
		        lines(xx,O,col="blue")
		        lines(xx, tt1[,2],lty="dotted")
		        lines(xx, tt1[,3],lty="dotted")

		        points(xx,E,col="red",pch=16,cex=2)
		        lines(xx,E,col="red")

		   }#



		myPLCO.plot.combine <- function(out.f, out.m, Main,years=10){

				# > names(out.f)
				#  [1] "TT"          "TT.inc"      "TT.mo"       "TT2"         "TT.inc2"     "TT.mo2"      "E.mo"        "E.inc"
				#  [9] "O.mo"        "O.inc"       "O.ocm"       "E.ocm"       "inc.scr.cum" "inc.cd.cum"  "mo.sc.cum"   "mo.cd.cum"
				# [17] "inc.scr"     "inc.cd"      "mo.sc"       "mo.cd"       "eo.inc.sc"   "eo.inc.cd"   "eo.mo.sc"    "eo.mo.cd"
				# [25] "fit.inc"     "fit.inc.sum" "fit.mo"      "fit.mo.sum"  "p.inc"       "p.inc.sum"   "p.mo"        "p.mo.sum"
				# [33] "chi.inc"     "chi.inc.sum" "chi.mo"      "chi.mo.sum"
				# > names(out.m)
				#  [1] "TT"          "TT.inc"      "TT.mo"       "TT2"         "TT.inc2"     "TT.mo2"      "E.mo"        "E.inc"
				#  [9] "O.mo"        "O.inc"       "O.ocm"       "E.ocm"       "inc.scr.cum" "inc.cd.cum"  "mo.sc.cum"   "mo.cd.cum"
				# [17] "inc.scr"     "inc.cd"      "mo.sc"       "mo.cd"       "eo.inc.sc"   "eo.inc.cd"   "eo.mo.sc"    "eo.mo.cd"
				# [25] "fit.inc"     "fit.inc.sum" "fit.mo"      "fit.mo.sum"  "p.inc"       "p.inc.sum"   "p.mo"        "p.mo.sum"
				# [33] "chi.inc"     "chi.inc.sum" "chi.mo"      "chi.mo.sum"

				   #### incidence screen detect #####

				   O=(out.f$inc.scr + out.m$inc.scr)[1,]
				   E=(out.f$inc.scr + out.m$inc.scr)[2,]

				   fit1=NULL
				   if(all(O==0)==F){ # usual care has all O, E =0
							cbind(E,O)
							fit1=myEO.test(E,O)
							fit1
							print(fit1$test)
							print(fit1$cum)

						   #years=1:10
						   YLAB="Number of Lung Cancer Cases "
						   MAIN=paste(Main," \n LC cases: Screen Detected",sep="")

						   myOEplot(O,E,years,YLAB,MAIN)

                   }
				   ##### incidence clinical detection ###

				   O=(out.f$inc.cd + out.m$inc.cd)[1,]
				   E=(out.f$inc.cd + out.m$inc.cd)[2,]

							cbind(E,O)
							fit2=myEO.test(E,O)
							fit2
							print(fit2$test)
							print(fit2$cum)

						   #years=1:10
						   YLAB="Number of Lung Cancer Cases "
						   MAIN=paste(Main," \n LC cases: Interval Detected",sep="")

						   myOEplot(O,E,years,YLAB,MAIN)
						# $EO
						#      O   E E/O.ratio CI.L CI.U over
						# 1   32  36      1.12 0.82 1.57    0
						# 2   43  42      0.98 0.72 1.31    0
						# 3   49  42      0.86 0.63 1.15    0
						# 4   54  46      0.85 0.63 1.13    0
						# 5   64  66      1.03 0.81 1.31    0
						# 6   71  75      1.06 0.84 1.32    0
						# 7  110  92      0.84 0.68 1.02    0
						# 8   92  97      1.05 0.87 1.29    0
						# 9   88 103      1.17 0.96 1.42    0
						# 10  90 102      1.13 0.94 1.38    0
						#
						# $test
						#
						# 	Chi-squared test for given probabilities
						#
						# data:  E2
						# X-squared = 10.6031, df = 9, p-value = 0.3039
						#
						#
						# $sumE
						# [1] 699.6134
						#
						# $sumO
						# [1] 693


				   ###### mortality screen detect #########

				   O=(out.f$mo.sc + out.m$mo.sc)[1,]
				   E=(out.f$mo.sc + out.m$mo.sc)[2,]

				  fit3=NULL
				  if(all(O==0)==F){ # usual care has all O, E =0
						cbind(E,O)
						fit3=myEO.test(E,O)
						fit3
						print(fit3$test)
						print(fit3$cum)

						#years=1:10
						YLAB="Number of Lung Cancer Deaths "
						MAIN=paste(Main, " \n LC Deaths: Screen Detected",sep="")

						myOEplot(O,E,years,YLAB,MAIN)

				  }#3nd of all

				   ###### mortality interval detect ######

				   O=(out.f$mo.cd + out.m$mo.cd)[1,]
				   E=(out.f$mo.cd + out.m$mo.cd)[2,]

						cbind(E,O)
						fit4=myEO.test(E,O)
						fit4
						print(fit4$test)
						print(fit4$cum)

						#years=1:10
						YLAB="Number of Lung Cancer Deaths "
						MAIN=paste(Main, " \n LC Deaths: Interval Detected",sep="")

						myOEplot(O,E,years,YLAB,MAIN)

				ans=list(inc.sc = fit1, inc.cd=fit2, mo.sc=fit3, mo.cd=fit4)
				ans

	 }#3nd of


		myPLCO.plot.combine2 <- function(out.f, out.m, Main,cum=F,years=10){

				# > names(out.f)
				#  [1] "TT"          "TT.inc"      "TT.mo"       "TT2"         "TT.inc2"     "TT.mo2"      "E.mo"        "E.inc"
				#  [9] "O.mo"        "O.inc"       "O.ocm"       "E.ocm"       "inc.scr.cum" "inc.cd.cum"  "mo.sc.cum"   "mo.cd.cum"
				# [17] "inc.scr"     "inc.cd"      "mo.sc"       "mo.cd"       "eo.inc.sc"   "eo.inc.cd"   "eo.mo.sc"    "eo.mo.cd"
				# [25] "fit.inc"     "fit.inc.sum" "fit.mo"      "fit.mo.sum"  "p.inc"       "p.inc.sum"   "p.mo"        "p.mo.sum"
				# [33] "chi.inc"     "chi.inc.sum" "chi.mo"      "chi.mo.sum"
				# > names(out.m)
				#  [1] "TT"          "TT.inc"      "TT.mo"       "TT2"         "TT.inc2"     "TT.mo2"      "E.mo"        "E.inc"
				#  [9] "O.mo"        "O.inc"       "O.ocm"       "E.ocm"       "inc.scr.cum" "inc.cd.cum"  "mo.sc.cum"   "mo.cd.cum"
				# [17] "inc.scr"     "inc.cd"      "mo.sc"       "mo.cd"       "eo.inc.sc"   "eo.inc.cd"   "eo.mo.sc"    "eo.mo.cd"
				# [25] "fit.inc"     "fit.inc.sum" "fit.mo"      "fit.mo.sum"  "p.inc"       "p.inc.sum"   "p.mo"        "p.mo.sum"
				# [33] "chi.inc"     "chi.inc.sum" "chi.mo"      "chi.mo.sum"

				   #### incidence screen detect #####
		        if(cum==T){

				   O=cumsum((out.f$inc.scr + out.m$inc.scr)[1,])
				   E=cumsum((out.f$inc.scr + out.m$inc.scr)[2,])
				 }

		        if(cum==F){

				   O=((out.f$inc.scr + out.m$inc.scr)[1,])
				   E=((out.f$inc.scr + out.m$inc.scr)[2,])
				 }



				   fit1=NULL
				   if(all(O==0)==F){ # usual care has all O, E =0
							cbind(E,O)
							fit1=myEO.test2(E,O,cum)
							fit1
							print(fit1$test)
							print(fit1$cum)

						   #years=1:10
						   YLAB="Number of Lung Cancer Cases"
						   MAIN=paste(Main," \n LC cases: Screen Detected",sep="")

						   myOEplot(O,E,years,YLAB,MAIN)

                   }
				   ##### incidence clinical detection ###

				if(cum==F){

				   O=(out.f$inc.cd + out.m$inc.cd)[1,]
				   E=(out.f$inc.cd + out.m$inc.cd)[2,]

				  }


				if(cum==T){

				   O=cumsum((out.f$inc.cd + out.m$inc.cd)[1,])
				   E=cumsum((out.f$inc.cd + out.m$inc.cd)[2,])

				  }

							cbind(E,O)
							fit2=myEO.test2(E,O,cum)
							fit2
							print(fit2$test)
							print(fit2$cum)

						   #years=1:10
						   YLAB="Number of Lung Cancer Cases"
						   MAIN=paste(Main," \n LC cases: Interval Detected",sep="")

						   myOEplot(O,E,years,YLAB,MAIN)
						# $EO
						#      O   E E/O.ratio CI.L CI.U over
						# 1   32  36      1.12 0.82 1.57    0
						# 2   43  42      0.98 0.72 1.31    0
						# 3   49  42      0.86 0.63 1.15    0
						# 4   54  46      0.85 0.63 1.13    0
						# 5   64  66      1.03 0.81 1.31    0
						# 6   71  75      1.06 0.84 1.32    0
						# 7  110  92      0.84 0.68 1.02    0
						# 8   92  97      1.05 0.87 1.29    0
						# 9   88 103      1.17 0.96 1.42    0
						# 10  90 102      1.13 0.94 1.38    0
						#
						# $test
						#
						# 	Chi-squared test for given probabilities
						#
						# data:  E2
						# X-squared = 10.6031, df = 9, p-value = 0.3039
						#
						#
						# $sumE
						# [1] 699.6134
						#
						# $sumO
						# [1] 693


				   ###### mortality screen detect #########
		     if(cum==F){
				   O=(out.f$mo.sc + out.m$mo.sc)[1,]
				   E=(out.f$mo.sc + out.m$mo.sc)[2,]

			 }


		     if(cum==T){
				   O=cumsum((out.f$mo.sc + out.m$mo.sc)[1,])
				   E=cumsum((out.f$mo.sc + out.m$mo.sc)[2,])

			 }

				  fit3=NULL
				  if(all(O==0)==F){ # usual care has all O, E =0
						cbind(E,O)
						fit3=myEO.test2(E,O,cum)
						fit3
						print(fit3$test)
						print(fit3$cum)

						#years=1:10
						YLAB="Number of Lung Cancer Deaths"
						MAIN=paste(Main, " \n LC Deaths: Screen Detected",sep="")

						myOEplot(O,E,years,YLAB,MAIN)

				  }#3nd of all

				   ###### mortality interval detect ######
		    if(cum==F){
				   O=(out.f$mo.cd + out.m$mo.cd)[1,]
				   E=(out.f$mo.cd + out.m$mo.cd)[2,]
			 }

		    if(cum==T){
				   O=cumsum((out.f$mo.cd + out.m$mo.cd)[1,])
				   E=cumsum((out.f$mo.cd + out.m$mo.cd)[2,])
			 }

						cbind(E,O)
						fit4=myEO.test2(E,O,cum)
						fit4
						print(fit4$test)
						print(fit4$cum)

						#years=1:10
						YLAB="Number of Lung Cancer Deaths"
						MAIN=paste(Main, " \n LC Deaths: Interval Detected",sep="")

						myOEplot(O,E,years,YLAB,MAIN)

				ans=list(inc.sc = fit1, inc.cd=fit2, mo.sc=fit3, mo.cd=fit4)
				ans

	 }#3nd o


			  myWrite.EO.csv<- function(out,Main){

					# > names(out)
					# [1] "inc.sc" "inc.cd" "mo.sc"  "mo.cd"
					# > names(out[[2]])
					# [1] "EO"   "test" "cum"
					# > out[[2]]
					# $EO
					#      O   E E/O.ratio CI.L CI.U over
					# 1   65  65      1.00 0.78 1.27    0
					# 2   83  80      0.96 0.78 1.20    0
					# 3   85  80      0.94 0.76 1.18    0
					# 4   91  85      0.93 0.76 1.16    0
					# 5   97  89      0.92 0.74 1.13    0
					# 6   97  91      0.94 0.76 1.15    0
					# 7   84  94      1.12 0.91 1.36    0
					# 8  102  99      0.97 0.79 1.18    0
					# 9   98 103      1.05 0.87 1.28    0
					# 10  84 103      1.23 1.01 1.49    1
					#
					# $test
					#
					# 	Chi-squared test for given probabilities
					#
					# data:  E2
					# X-squared = 7.6401, df = 9, p-value = 0.5708
					#
					#
					# $cum
					#        sumE        sumO cumEO.ratio        CI.L        CI.U
					# 889.0000000 886.0000000   1.0033860   0.9395483   1.0715611

					Main2=gsub(" ",".",gsub("\\[","",gsub("\\]","",Main)))
					tabfile=paste("EO",Main2,Head,"csv",sep=".")
					write.table("", file=tabfile,row.names=F,col.names=F)


					for(j in 1:length(out))  {

						write.table(names(out)[j],file=tabfile, append=T,sep=",", quote=F,row.names=F,col.names=F)
						if(is.null(out[[j]][[1]])==F) {

								   tm1=out[[j]][[1]]
								   CI2=paste("(",tm1[,4],"-",tm1[,5],")",sep="")
								   tm2=cbind(tm1,CI=CI2)
								   write.table(tm2, file=tabfile, append=T,sep=",", quote=F,row.names=F)

						 }

						write.table("cumulative.sum",file=tabfile, append=T,sep=",", quote=F,row.names=F,col.names=F)
						if(is.null(names(out[[j]]))==F) write.table(t(out[[j]][[3]]),file=tabfile, append=T,sep=",", quote=F,row.names=F)

					 }
			  }#end of


########## 8/14/2013: this creates NAs for "missing screens" given screen.time data provided

ScreenTime.Markov3 <- function(screen.time, prob1, prob2, seed){

	# > screen.time[1:5,]
	#      SCRT.10 SCRT.11 SCRT.12 SCRT.13 SCRT.14 SCRT.15 SCRT.16 SCRT.17 SCRT.18 SCRT.19 SCRT.20 SCRT.21
	# [1,]      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA
	# [2,]      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA
	# [3,]      10      11      12      13      14      15      16      17      18      19      20      21
	# [4,]      10      11      12      13      14      15      16      17      18      19      20      NA
	# [5,]      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA
	#      SCRT.22 SCRT.23 SCRT.24 SCRT.25 SCRT.26 SCRT.27 SCRT.28 SCRT.29 SCRT.30
	# [1,]      NA      NA      NA      NA      NA      NA      NA      NA      NA
	# [2,]      NA      NA      NA      NA      NA      NA      NA      NA      NA
	# [3,]      22      23      24      25      26      27      28      29      30
	# [4,]      NA      NA      NA      NA      NA      NA      NA      NA      NA
	# [5,]      NA      NA      NA      NA      NA      NA      NA      NA      NA

    ### above NA means non-eligible people by smoking and age requirement ########

	#> prob1
	#[1] 0.972 0.973 0.967 0.833   # given attending the previous year screen this is the prob to attend
	#> prob2
	#[1] 0.071 0.165 0.035  # given NOT attending the previous screen this is the prob to attend

	nn=nrow(screen.time)

	### (1) decide adherence in T=1 ####


	scr.times = screen.time[,1]
	indic.elig = (is.na(scr.times)==F)


	# set.seed(seed)
	unin = runif(nn)

	## among who are eligible, if it's less than prob > 0.937, assign "no attend", 9999
	scr.times[indic.elig==T  &  unin > prob1[1]] = 9999

	# > sum(scr.times==9999,na.rm=T)/length(scr.times[indic.elig])
	# [1] 0.06082027
	# > 1-prob1[1]
	# [1] 0.06239805


	### (2) decide adherence in T=2 ####
	## see if it's less than prob < 0.972, then attend T=2 screening otherwise, no attend NA
	#next.scr = ifelse(unin < prob1[1], times[2], NA)

	### make a stack
	#scr.times = cbind(scr.times, next.scr)

	### decide T=2 to T=end ###

	current.scr = scr.times  # current screen is the screening results at t=1

	for (j in 2:ncol(screen.time)){

		### screen time for t=2 that needs to be updated ##
		next.scr = screen.time[,j]
		# > next.scr[1:10]
		#  [1] NA NA 11 11 NA 11 NA NA 11 NA

		### screen time for t=1 ##

		# > current.scr[1:110]
		#   [1]   NA   NA   10   10   NA   10   NA   NA   10   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA
		#  [20]   NA   NA   10   NA   NA   NA   NA   10   NA   NA   NA   NA   10   NA   10   NA   NA   10   NA
		#  [39]   NA   10   10   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   10   10   NA   NA   NA
		#  [58]   NA   NA   NA   10   NA   10   NA   NA   NA   NA   NA   10   NA   NA   NA   NA   NA   10   NA
		#  [77]   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   10
		#  [96]   NA   NA   NA   NA   10   NA   NA   NA 9999   NA   NA   NA   NA   NA   NA

		unin1 = runif(nn)
		unin2 = runif(nn)

		########## (1) Assign "missing screen" for people who attended at t=1 ####################################

		### indicator who attended at t=1  (& who were eligible) ###

		indic.att = current.scr!=999 & is.na(current.scr)==F


		### if prob > 0.97, assign "no attend" i.e. 9999 for the above people & also the person should be eligible for t=2 (i.e. is.na(next.scr)==F)  ####

		next.scr[(unin1 > prob1[j])  &  indic.att==T  & is.na(next.scr)==F] = 9999


		########### (2) Assign "missing screen" for people who NOT attended at t=1 ##############

		### indicator who are eligible & NOT attended at t=1 (& who were eligible) ###

		indic.not.att = current.scr==9999 & is.na(current.scr)==F

		### if prob > 0.97, assign "no attend" i.e. 9999 for the above people & also the person should be eligible for t=2 (i.e. is.na(next.scr)==F) ####

		next.scr[(unin2 > prob2[j]) & indic.not.att==T & is.na(next.scr)==F] = 9999


		### accumulate ##
		scr.times = cbind(scr.times, next.scr)

		### then current screen result is from t=2 ##
		current.scr = next.scr

	}

	#dimnames(scr.times)[[2]]=seq(length(times))
	# > scr.times[1:10,]
	#        1  2  3  4  5  6    7    8    9   10   11   12   13   14   15   16   17   18   19   20   21
	#  [1,] NA NA NA NA NA NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA
	#  [2,] NA NA NA NA NA NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA
	#  [3,] 10 11 12 13 14 15   16   17   18 9999 9999 9999 9999 9999 9999 9999 9999 9999 9999 9999 9999
	#  [4,] 10 11 12 13 14 15   16 9999 9999 9999 9999   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA
	#  [5,] NA NA NA NA NA NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA
	#  [6,] 10 11 12 13 14 15 9999 9999 9999 9999 9999 9999 9999 9999 9999 9999 9999 9999 9999 9999 9999
	#  [7,] NA NA NA NA NA NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA
	#  [8,] NA NA NA NA NA NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA
	#  [9,] 10 11 12 13 14 15   16   17   18 9999 9999 9999 9999 9999   NA   NA   NA   NA   NA   NA   NA
	# [10,] NA NA NA NA NA NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA
	colnames(scr.times)=colnames(screen.time)

	##### NA's are not eligible (due to smoking and age), 9999 are missing screens ###

	tt1= scr.times!=9999 & is.na(scr.times)==F

	### compliance level among all US popoulation
	colSums(tt1)/nrow(tt1)
		#            1            2            3            4            5            6            7            8            9           10
		# 0.1497872793 0.1461816635 0.1405977452 0.1290363752 0.1163475856 0.1022442034 0.0865135078 0.0708147203 0.0560944480 0.0434907466
		#           11           12           13           14           15           16           17           18           19           20
		# 0.0321846416 0.0227611147 0.0153903425 0.0099234205 0.0059668156 0.0032333546 0.0016592214 0.0009040630 0.0004573495 0.0003616252
		#           21
		# 0.0003190810

	### compliance prob among who were ever-eligible ##

	colSums(tt1)/sum(indic.elig)
	# > 	colSums(tt1)/sum(indic.elig)
	#           1           2           3           4           5           6           7           8           9          10          11
	# 0.939179727 0.916572191 0.881560520 0.809069690 0.729509837 0.641080360 0.542447482 0.444014672 0.351717239 0.272690897 0.201800600
	#          12          13          14          15          16          17          18          19          20          21
	# 0.142714238 0.096498833 0.062220740 0.037412471 0.020273424 0.010403468 0.005668556 0.002867623 0.002267422 0.002000667



	scr.times

}

######### 12/16/2013 fix this so it can use initial prob seperately
# init.prob= 0.949
# prob1=c(0.902, 0.918, 0.912)
# prob2=c(0.670, 0.376, 0.272)
# 0.949 0.902 0.918 0.912
# 0.949 0.670 0.376 0.272
### just fi

ScreenTime.Markov2b <- function(times, init.prob, prob1, prob2, nn,seed){

	# > times
	# [1] 0 1 2

	# > prob1
	# [1] 0.902 0.918 0.912
	# > prob2
	# [1] 0.670 0.376 0.272
	# > init.prob
	# [1] 0.949

	# > nn
	# [1] 157620

	#> times
	#[1] 10 13 16 19 22 25 28 31 34
	#> prob1
	#[1] 0.972 0.973 0.967 0.833   # given attending the previous year screen this is the prob to attend
	#> prob2
	#[1] 0.071 0.165 0.035  # given NOT attending the previous screen this is the prob to attend
	#> nn
	#[1] 1585

	### (1) decide adherence in T=1 ####

	# set.seed(seed)
	unin = runif(nn)

	## see if it's less than prob < 0.947, then attend T=1 screening otherwise, no attend NA
	scr.times = scr1= ifelse(unin < init.prob, times[1], NA)
	# > next.scr[1:10]
	#  [1] 10 10 10 10 10 10 10 10 10 10


	### (2) decide adherence in T=2 ####
	## see if it's less than prob < 0.972, then attend T=2 screening otherwise, no attend NA
	#next.scr = ifelse(unin < prob1[1], times[2], NA)

	### make a stack
	#scr.times = cbind(scr.times, next.scr)

	### decide T=2 to T=end ###

	current.scr = scr1  # current screen is the screening results at t=1

	for (j in 2:length(times)){


		unin1 = runif(nn)
		unin2 = runif(nn)

		## probability to attend the T=2 given attending T=1:  see if chance less  < 0.973
		tmp1 = ifelse(unin1 < prob1[j-1], times[j], NA)

		### Probability to attend the T=2 given NOT attending T=1:
		tmp2 = ifelse(unin2 < prob2[j-1], times[j], NA)
		# > tmp1[1:10]
		#  [1] NA 11 11 11 11 11 11 NA 11 11
		# > tmp2[1:10]
		#  [1] NA 11 11 11 11 NA 11 11 NA 11

		### for people who didn't attend T=1 (i.e. current.scr=NA), put tmp2, otherwise tmp1
		indic.prev.attend = !is.na(current.scr)
		next.scr = ifelse(indic.prev.attend, tmp1, tmp2) # if the previous screen is NOT NA (i.e. attend at t=1), then tmp1, otherwise tmp2

		### accumulate ##
		scr.times = cbind(scr.times, next.scr)

		### then current screen result is from t=2 ##
		current.scr = next.scr

	}

	dimnames(scr.times)[[2]]=seq(length(times))

			tt1=is.na(scr.times)==F
			colSums(tt1)/nrow(tt1)
			#            1            2            3            4            5            6            7            8            9
			# 0.9375456332 0.9178545352 0.8791126088 0.8186127492 0.7388149396 0.6478292614 0.5550126369 0.4631844987 0.3751305813
			#           10           11           12           13           14           15           16           17           18
			# 0.2950968829 0.2227576523 0.1614827296 0.1119123842 0.0739567537 0.0463465319 0.0264532435 0.0138949733 0.0070317327
			#           19           20           21
			# 0.0034035383 0.0013928672 0.0005391744

	scr.times

}



ScreenTime.Markov2 <- function(times, prob1, prob2, nn,seed){

	#> times
	#[1] 10 13 16 19 22 25 28 31 34
	#> prob1
	#[1] 0.972 0.973 0.967 0.833   # given attending the previous year screen this is the prob to attend
	#> prob2
	#[1] 0.071 0.165 0.035  # given NOT attending the previous screen this is the prob to attend
	#> nn
	#[1] 1585

	### (1) decide adherence in T=1 ####

	# set.seed(seed)
	unin = runif(nn)

	## see if it's less than prob < 0.937, then attend T=1 screening otherwise, no attend NA
	scr.times = scr1= ifelse(unin < prob1[1], times[1], NA)
	# > next.scr[1:10]
	#  [1] 10 10 10 10 10 10 10 10 10 10


	### (2) decide adherence in T=2 ####
	## see if it's less than prob < 0.972, then attend T=2 screening otherwise, no attend NA
	#next.scr = ifelse(unin < prob1[1], times[2], NA)

	### make a stack
	#scr.times = cbind(scr.times, next.scr)

	### decide T=2 to T=end ###

	current.scr = scr1  # current screen is the screening results at t=1

	for (j in 2:length(times)){


		unin1 = runif(nn)
		unin2 = runif(nn)

		## probability to attend the T=2 given attending T=1:  see if chance less  < 0.973
		tmp1 = ifelse(unin1 < prob1[j], times[j], NA)

		### Probability to attend the T=2 given NOT attending T=1:
		tmp2 = ifelse(unin2 < prob2[j], times[j], NA)
		# > tmp1[1:10]
		#  [1] NA 11 11 11 11 11 11 NA 11 11
		# > tmp2[1:10]
		#  [1] NA 11 11 11 11 NA 11 11 NA 11

		### for people who didn't attend T=1 (i.e. current.scr=NA), put tmp2, otherwise tmp1
		indic.prev.attend = !is.na(current.scr)
		next.scr = ifelse(indic.prev.attend, tmp1, tmp2) # if the previous screen is NOT NA (i.e. attend at t=1), then tmp1, otherwise tmp2

		### accumulate ##
		scr.times = cbind(scr.times, next.scr)

		### then current screen result is from t=2 ##
		current.scr = next.scr

	}

	dimnames(scr.times)[[2]]=seq(length(times))

			tt1=is.na(scr.times)==F
			colSums(tt1)/nrow(tt1)
			#            1            2            3            4            5            6            7            8            9
			# 0.9375456332 0.9178545352 0.8791126088 0.8186127492 0.7388149396 0.6478292614 0.5550126369 0.4631844987 0.3751305813
			#           10           11           12           13           14           15           16           17           18
			# 0.2950968829 0.2227576523 0.1614827296 0.1119123842 0.0739567537 0.0463465319 0.0264532435 0.0138949733 0.0070317327
			#           19           20           21
			# 0.0034035383 0.0013928672 0.0005391744

	scr.times

}


######### 8/15/2013: adjust so it can include time not only 1:4 but for specified time e.g. yr=20
myPred.compliance2=function(prob, times,new.x,PLOT=T){


		 logit=function(x) log(x/(1-x))
		 inv.logit <- function(x) exp(x)/(1+exp(x))

	    #prob
	    #[1] 0.9489455 0.9023605 0.9176740 0.9115479
	    #times=1:length(prob)

		########### prob 1: given attending the previous one, prob of attending the current one ##

		#plot(times,prob,pch=16,col="blue")

		### define x and y ###
		 x=times
		 y=logit(prob)

	    ### plotting ###

		#plot(x,y,pch=16,col="blue",cex=2)
		#plot(x,inv.logit(y),pch=16,col="blue",cex=2)

	    ### fitting model ##

		lm1=lm(y~x)

        #lm1=lm(y~x+x2)
		summary(lm1)
		betas=lm1$coef; betas
		# (Intercept) poly(x, 2)1 poly(x, 2)2
		#    1.452632    7.505862    2.469238

		#new.x = c(1:30)

		myPredict.lm <- function(betas, new.x){

			new.p=new.x
			new.p
			#               1          2
			# [1,] 0.25 0.0625
			# [2,] 0.85 0.7225
			# [3,] 1.20 1.4400

			if(length(betas)==2){
			    xx=cbind(int=rep(1,length(new.p)), new.p)
			 }

			if(length(betas)==3){
			    xx=cbind(int=rep(1,length(new.p)), new.p, new.p^2)
			 }


			ans=as.vector(xx%*%betas)
			ans
			#[1] -0.3064839  3.4661477  8.4864573
			#points(new.x,ans,pch="*",col="blue",cex=2)
		}#

		#### prediction ##
		ans=myPredict.lm(betas, new.x);inv.logit(ans)


 		if(PLOT==T){

 		plot(new.x,inv.logit(ans),pch=16,col="blue",cex=2,xlim=c(0,max(new.x)),ylim=c(0,1),xlab=c("Screen Time"),
 						ylab="Adherence Probability")
 		points(x,inv.logit(y),pch=16,col="red",cex=3)

 		}

		out=cbind(new.x,inv.logit(ans))
		# > out[1:10,]
		#       new.x
		#  [1,]     1 0.9376019
		#  [2,]     2 0.9276810
		#  [3,]     3 0.9163235
		#  [4,]     4 0.9033682
		#  [5,]     5 0.8886507
		#  [6,]     6 0.8720093
		#  [7,]     7 0.8532914
		#  [8,]     8 0.8323623
		#  [9,]     9 0.8091155
		# [10,]    10 0.7834835

		out


}#end of


myPred.compliance=function(prob, new.x){


		 logit=function(x) log(x/(1-x))
		 inv.logit <- function(x) exp(x)/(1+exp(x))

	    #prob
	    #[1] 0.9489455 0.9023605 0.9176740 0.9115479
	    times=1:length(prob)

		########### prob 1: given attending the previous one, prob of attending the current one ##

		#plot(times,prob,pch=16,col="blue")

		### define x and y ###
		 x=times
		 y=logit(prob)

	    ### plotting ###

		#plot(x,y,pch=16,col="blue",cex=2)
		#plot(x,inv.logit(y),pch=16,col="blue",cex=2)

	    ### fitting model ##

		lm1=lm(y~x)
		summary(lm1)
		betas=lm1$coef; betas
		# (Intercept) poly(x, 2)1 poly(x, 2)2
		#    1.452632    7.505862    2.469238

		#new.x = c(1:30)

		myPredict.lm <- function(betas, new.x){

			new.p=new.x
			new.p
			#               1          2
			# [1,] 0.25 0.0625
			# [2,] 0.85 0.7225
			# [3,] 1.20 1.4400
			xx=cbind(int=rep(1,length(new.p)), new.p)
			ans=as.vector(xx%*%betas)
			ans
			#[1] -0.3064839  3.4661477  8.4864573
			#points(new.x,ans,pch="*",col="blue",cex=2)
		}#

		#### prediction ##
		ans=myPredict.lm(betas, new.x);inv.logit(ans)
 		plot(new.x,inv.logit(ans),pch=16,col="blue",cex=2,xlim=c(0,max(new.x)))
 		points(x,inv.logit(y),pch=16,col="red",cex=3)

		out=cbind(new.x,inv.logit(ans))
		# > out[1:10,]
		#       new.x
		#  [1,]     1 0.9376019
		#  [2,]     2 0.9276810
		#  [3,]     3 0.9163235
		#  [4,]     4 0.9033682
		#  [5,]     5 0.8886507
		#  [6,]     6 0.8720093
		#  [7,]     7 0.8532914
		#  [8,]     8 0.8323623
		#  [9,]     9 0.8091155
		# [10,]    10 0.7834835

		out


}#end of


estComplianceProb=function(datscr){

     #### if attend, some numeric number, if unattend, NAs

	 # > dat.scr[1:3,]
	#      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14] [,15] [,16] [,17] [,18] [,19] [,20] [,21]
	# [1,]   10   11   NA   13   14   15   16   17   18    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
	# [2,]   10   11   12   13   14   15   16   17   NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
	# [3,]   10   11   12   13   14   15   16   17   18    19    20    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA

		# > datscr[1:10,]
		#       has_xry0 has_xry1 has_xry2 has_xry3
		#  [1,] NA       NA       NA       NA
		#  [2,] " 0"     " 1"     " 0"     " 0"
		#  [3,] " 1"     " 1"     " 1"     " 0"
		#  [4,] " 1"     " 1"     " 1"     " 1"
		#  [5,] " 1"     " 1"     " 1"     " 1"
		#  [6,] " 1"     " 1"     " 1"     " 0"
		#  [7,] " 1"     " 1"     " 1"     " 0"
		#  [8,] " 1"     " 1"     " 1"     " 0"
		#  [9,] " 1"     " 1"     " 1"     " 1"
		# [10,] " 1"     " 1"     " 1"     " 1"

		### first screen ###
		sc0=as.numeric(datscr[,1])
			#### there are many NAs####
			# > datscr[is.na(sc)==T,][1:10,]
			#       has_xry0 has_xry1 has_xry2 has_xry3
			#  [1,] NA       NA       NA       NA
			#  [2,] NA       NA       NA       NA
			#  [3,] NA       NA       NA       NA
			#  [4,] NA       NA       NA       NA
			#  [5,] NA       NA       NA       NA
			#  [6,] NA       NA       NA       NA
			#  [7,] NA       NA       NA       NA
			#  [8,] NA       NA       NA       NA
			#  [9,] NA       NA       NA       NA
			# [10,] NA       NA       NA       NA
			# > sum(is.na(datscr[,1]))/nrow(datscr)
			# [1] 0.05478301

		#init.prob = sum(is.na(sc0)==F & sc0==1)/sum(is.na(sc0)==F) #0.9640665

	 	init.prob= sum(!is.na(sc0))/length(sc0)


		datscr2=datscr[,-1]
		probs.attend.given.attend.prev=NULL
		probs.attend.given.not.attend.prev=NULL


		for(j in 2:ncol(datscr)){

		     ## (1) previous screen
		     sc.prv = as.numeric(datscr[,j-1])
				# > sc.prv[1:10]
				#  [1] 10 10 10 10 10 10 10 10 10 10

		     ### indicator who attend the previous one #
		     indic.attend = is.na(sc.prv)==F
		     #indic.attend = is.na(sc.prv)==F & sc.prv==1

		     ## (2) current screen ##
		     sc.cur=as.numeric(datscr[,j])

		     ### (3) Given attending the previous, prob to attend the current
		     #tb=table(sc.cur[indic.attend])
					#     0     1
					#  2195 31422
		     prob.attend.given.attend.prev0= sum(is.na(sc.cur[indic.attend])==F)/length(sc.cur[indic.attend])


		     ### (4) Given NOT attending the previous, prob to attend the current

		     prob.attend.given.not.attend.prev0=sum(is.na(sc.cur[!indic.attend])==F)/length(sc.cur[!indic.attend])


		     #tb2=table(sc.cur[!indic.attend])
					#   0   1
					# 393 860
		     #prob.attend.given.not.attend.prev0= tb2[2]/sum(tb2)  #0.6863528

		     ### collect ###
		     probs.attend.given.attend.prev=c(probs.attend.given.attend.prev,prob.attend.given.attend.prev0)
		     probs.attend.given.not.attend.prev=c(probs.attend.given.not.attend.prev,prob.attend.given.not.attend.prev0)


       }#for(j in 2:ncol(datscr)){

		#init.prob
		# [1] 0.9640665
		#probs.attend.given.attend.prev
		#         1         1         1
		# 0.9347057 0.9435909 0.7413422
		#probs.attend.given.not.attend.prev
		#         1         1         1
		# 0.6863528 0.4362442 0.2652439


		prob11=probs.attend.given.attend.prev
		prob22=probs.attend.given.not.attend.prev

		out=cbind(prob11=c(init.prob,probs.attend.given.attend.prev), prob22=c(init.prob, probs.attend.given.not.attend.prev))
		out



}#end of


###### 8/14/2013: incorporate 9999 & NA's #############

estComplianceProb2=function(datscr){

     #### NA: not eligible(smoking and age), 9999: do not comply,  number: attended year ##

		# > datscr[1:10,]
		#       SCRT.10 SCRT.11 SCRT.12 SCRT.13 SCRT.14 SCRT.15 SCRT.16 SCRT.17 SCRT.18 SCRT.19 SCRT.20 SCRT.21 SCRT.22 SCRT.23 SCRT.24 SCRT.25
		#  [1,]      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA
		#  [2,]      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA
		#  [3,]      10      11      12      13      14      15      16      17      18    9999    9999    9999    9999    9999    9999    9999
		#  [4,]      10      11      12      13      14      15      16    9999    9999    9999    9999      NA      NA      NA      NA      NA
		#  [5,]      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA
		#  [6,]      10      11      12      13      14      15    9999    9999    9999    9999    9999    9999    9999    9999    9999    9999
		#  [7,]      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA
		#  [8,]      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA
		#  [9,]      10      11      12      13      14      15      16      17      18    9999    9999    9999    9999    9999      NA      NA
		# [10,]      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA
		#       SCRT.26 SCRT.27 SCRT.28 SCRT.29 SCRT.30
		#  [1,]      NA      NA      NA      NA      NA
		#  [2,]      NA      NA      NA      NA      NA
		#  [3,]    9999    9999    9999    9999    9999
		#  [4,]      NA      NA      NA      NA      NA
		#  [5,]      NA      NA      NA      NA      NA
		#  [6,]    9999    9999    9999    9999    9999
		#  [7,]      NA      NA      NA      NA      NA
		#  [8,]      NA      NA      NA      NA      NA
		#  [9,]      NA      NA      NA      NA      NA
		# [10,]      NA      NA      NA      NA      NA

		### first screen ###
		sc0=as.numeric(datscr[,1])
			#### there are many NAs####
			# > datscr[is.na(sc)==T,][1:10,]
			#       has_xry0 has_xry1 has_xry2 has_xry3
			#  [1,] NA       NA       NA       NA
			#  [2,] NA       NA       NA       NA
			#  [3,] NA       NA       NA       NA
			#  [4,] NA       NA       NA       NA
			#  [5,] NA       NA       NA       NA
			#  [6,] NA       NA       NA       NA
			#  [7,] NA       NA       NA       NA
			#  [8,] NA       NA       NA       NA
			#  [9,] NA       NA       NA       NA
			# [10,] NA       NA       NA       NA
			# > sum(is.na(datscr[,1]))/nrow(datscr)
			# [1] 0.05478301

		#init.prob = sum(is.na(sc0)==F & sc0==1)/sum(is.na(sc0)==F) #0.9640665

	 	init.prob= sum(!is.na(sc0) & sc0!=9999)/sum(!is.na(sc0))
	 	#[1] 0.9391797


		datscr2=datscr[,-1]
		probs.attend.given.attend.prev=NULL
		probs.attend.given.not.attend.prev=NULL


		for(j in 2:ncol(datscr)){

		     ## (1) previous screen
		     sc.prv = as.numeric(datscr[,j-1])
				# > sc.prv[1:10]
				#  [1] 10 10 10 10 10 10 10 10 10 10

		     ### indicator who attend the previous one & and eligible
		     indic.attend = sc.prv!=9999 & is.na(sc.prv)==F
		     #indic.attend = is.na(sc.prv)==F & sc.prv==1

		     ## (2) current screen ##
		     sc.cur=as.numeric(datscr[,j])

		     ### (3) Given attending the previous, prob to attend the current (among people who attended at t=1, how may were attened at t=2
		     #tb=table(sc.cur[indic.attend])
					#     0     1
					#  2195 31422
		     prob.attend.given.attend.prev0= sum(sc.cur!=9999 & is.na(sc.cur)==F & indic.attend==T)/sum(indic.attend)

		     #prob.attend.given.attend.prev0= sum(is.na(sc.cur[indic.attend])==F)/length(sc.cur[indic.attend])


		     ### (4) Given NOT attending the previous, prob to attend the current (among who didn't attend last time, who many attended this time)

		     indic.not.attend = sc.prv==9999 & is.na(sc.prv)==F
		     prob.attend.given.not.attend.prev0= sum(sc.cur!=9999 & is.na(sc.cur)==F & indic.not.attend==T)/sum(indic.not.attend==T)

		     #prob.attend.given.not.attend.prev0=sum(is.na(sc.cur[!indic.attend])==F)/length(sc.cur[!indic.attend])


		     #tb2=table(sc.cur[!indic.attend])
					#   0   1
					# 393 860
		     #prob.attend.given.not.attend.prev0= tb2[2]/sum(tb2)  #0.6863528

		     ### collect ###
		     probs.attend.given.attend.prev=c(probs.attend.given.attend.prev,prob.attend.given.attend.prev0)
		     probs.attend.given.not.attend.prev=c(probs.attend.given.not.attend.prev,prob.attend.given.not.attend.prev0)


       }#for(j in 2:ncol(datscr)){

		#init.prob
		# [1] 0.9640665
		#probs.attend.given.attend.prev
		#         1         1         1
		# 0.9347057 0.9435909 0.7413422
		#probs.attend.given.not.attend.prev
		#         1         1         1
		# 0.6863528 0.4362442 0.2652439


		prob11=probs.attend.given.attend.prev
		prob22=probs.attend.given.not.attend.prev

		out=cbind(prob11=c(init.prob,probs.attend.given.attend.prev), prob22=c(init.prob, probs.attend.given.not.attend.prev))
		out



}#end of


#MYDAT=mydat2
#### efficient scenario ##



myUS.plots.big=function(MYDAT,Head){

				y=MYDAT[,"Deaths.avoided90"]/max(MYDAT[,"Deaths.avoided90"])
				mydatb=cbind(MYDAT, death.avoided.percent.90=y)


				################# (3) draw frontier plot ###############

				DAT=mydatb

				xname="CTscreens90"
				yname="death.avoided.percent.90"
				scname="scenario"
				MAIN=Head

				TT1=myUS.plot(xname, yname, scname, DAT,MAIN,IDENTIFY=F)
				myindic=TT1$indic.front

				dat.sel = DAT[myindic,]

				#dat.sel[order(dat.sel[,"CTscreens90"]),]

				############## (4) add the given scenarios on the plots!



				####### big consensus scenarios ###

				scns.con = c("T-60-80-40-10","T-60-85-40-15","B-60-80-40-10","T-60-85-40-25","B-60-85-40-10",
								"B-60-80-40-15","B-60-80-40-25","A-60-85-40-25","A-60-85-10-25","A-55-80-20-25",
								"A-55-85-10-20","A-50-85-20-20","A-55-80-10-25","A-50-80-20-25","A-55-85-10-25",
								"A-50-85-20-25","A-50-85-10-20","A-50-80-10-25","A-45-85-20-25","A-50-85-10-25",
								 "A-55-85-40-20","A-60-85-30-25","A-50-85-40-25")



				scns = scns.con

				tt=myUS.plot.select(xname, yname, scname, DAT,MAIN,IDENTIFY=F,addNo=F,scns)
				tt=myUS.plot.select(xname, yname, scname, DAT,MAIN,IDENTIFY=F,addNo=T,scns)


				###### smaller consensus scenarios ###

				scns.con.sm = c("T-60-80-40-10","B-60-80-40-10","B-60-85-40-10",
								"B-60-80-40-25","A-60-85-40-25","A-55-85-40-20","A-50-85-40-25","A-55-80-20-25",
								"A-55-80-10-25","A-50-85-20-25", "A-55-75-30-15")



				scns = scns.con.sm

				tt=myUS.plot.select(xname, yname, scname, DAT,MAIN,IDENTIFY=F,addNo=F,scns)
				tt=myUS.plot.select(xname, yname, scname, DAT,MAIN,IDENTIFY=F,addNo=T,scns)



		 dat.s= DAT[as.character(DAT[,"scenario"]) %in% scns,]
		 dat.s2=dat.s[order(dat.s[,"CTscreens90"]),]

		 ans=list(out=TT1, dat.s=dat.s, dat.s2=dat.s2)
		 ans



}


### 11/20/2013: generalize for different Y for efficient scenarios #####

# y=MYDAT[,"Deaths.avoided90"]/max(MYDAT[,"Deaths.avoided90"])
# MYDAT=cbind(MYDAT, death.avoided.percent.90=y)
# xname="CTscreens90"
# yname="death.avoided.percent.90"
# scname="scenario"

myUS.plots.big.general=function(MYDAT,HEAD,xname,yname,sname,WRITE=F){

				#y=MYDAT[,"Deaths.avoided90"]/max(MYDAT[,"Deaths.avoided90"])
				#mydatb=cbind(MYDAT, death.avoided.percent.90=y)


				################# (3) draw frontier plot ###############

				DAT=MYDAT

				MAIN=HEAD

				TT1=myUS.plot(xname, yname, scname, DAT,MAIN,IDENTIFY=F)
				myindic=TT1$indic.front

				dat.sel = DAT[myindic,]

				x=TT1$x
				y=TT1$y
				labs=TT1$labs

				#dat.sel[order(dat.sel[,"CTscreens90"]),]

				############## (4) add the given scenarios on the plots!



				####### big consensus scenarios ###

				scns.con = c("T-60-80-40-10","T-60-85-40-15","B-60-80-40-10","T-60-85-40-25","B-60-85-40-10",
								"B-60-80-40-15","B-60-80-40-25","A-60-85-40-25","A-60-85-10-25","A-55-80-20-25",
								"A-55-85-10-20","A-50-85-20-20","A-55-80-10-25","A-50-80-20-25","A-55-85-10-25",
								"A-50-85-20-25","A-50-85-10-20","A-50-80-10-25","A-45-85-20-25","A-50-85-10-25",
								 "A-55-85-40-20","A-60-85-30-25","A-50-85-40-25")


				scns = scns.con

				tt=myUS.plot.select(xname, yname, scname, DAT,MAIN,IDENTIFY=F,addNo=F,scns)
				tt=myUS.plot.select(xname, yname, scname, DAT,MAIN,IDENTIFY=F,addNo=T,scns)


				###### smaller consensus scenarios ###

				scns.con.sm = c("T-60-80-40-10","B-60-80-40-10","B-60-85-40-10",
								"B-60-80-40-25","A-60-85-40-25","A-55-85-40-20","A-50-85-40-25","A-55-80-20-25",
								"A-55-80-10-25","A-50-85-20-25", "A-55-75-30-15")



				scns = scns.con.sm

				tt=myUS.plot.select(xname, yname, scname, DAT,MAIN,IDENTIFY=F,addNo=F,scns)
				tt=myUS.plot.select(xname, yname, scname, DAT,MAIN,IDENTIFY=F,addNo=T,scns)



		 dat.s= DAT[as.character(DAT[,"scenario"]) %in% scns,]
		 dat.s2=dat.s[order(dat.s[,"CTscreens90"]),]

		 ans=list(out=TT1$tab, dat.s=dat.s, dat.s2=dat.s2,x=x,y=y,labs=labs)

		 if(WRITE==T){ write.csv(TT1$tab, paste(MAIN,".shortList.csv",sep=""))  }

		 ans



}# end of









myInvestigate.variable <- function(x1name,x2names,DATA,varfeatures){

	# x2names=c("EDUCAT","race7","bmi_curc",
	# 			"copd_f","lung_fh",
	# 			"cig_stat","cig_per_day","cig_stop_rnd","cig_years_rnd","age")
	#
	# varfeatures=c("cat","cat","cat","b","b","cat","con","con","con","b","con")


	x1=DATA[,x1name]
	feat.x1 = varfeatures[x2names==x1name] #[1]"b"  # binary
	x1.vals = unique(x1[is.na(x1)==F]) #[1] 0 1


	### exclude x1 ###
	x2names.b = x2names[x2names!=x1name]
	x2s=DATA[,x2names.b]
	varfeatures.b = varfeatures[x2names!=x1name]

	#n1=length(unique(x1[is.na(x1)==F]))



	for(j in 1:length(x2names.b)){

		x2=x2s[,j]
		x2name=x2names.b[j]
		#n2=length(unique(x2[is.na(x2)==F]))
		feat.x2 = varfeatures.b[x2names.b==x2name] #[1]"b"  # binary
		Main=paste("[",x1name, " & ", x2name,"]",sep="")

		if(feat.x1=="cat" )   {


			if(feat.x2=="b" | feat.x2=="cat" ){

					mosaicplot(x2~x1,col=c("green","red","blue"),xlab=x2name,ylab=x1name,cex.axis=1.5,main="")
					tb=table(x1,x2)
					tst=chisq.test(tb)
					pval=tst$p.value
					title(paste(Main,"P=", sprintf("%.2e",pval)))

					if(x1name=="cig_stat"){
								### current smoker prevalence ##
								prop <- function(x1) sum(x1==1,na.rm=T)/sum(is.na(x1)==F)
								tt=cbind(x1,x2)
								ag=aggregate(x1~x2,data=tt,prop)
								ag
								xs0=as.numeric(names(table(x2)))
								#xs=seq(0,1,by=1/length(xs0))[-length(xs0)]
								xs=(ag[,1]-1)*(1/length(xs0))
								text(xs,0.8,round(ag[,2],2),cex=1,col="blue")
								title(sub=paste(round(ag[,2],2),collapse="-"))

					}#
			}#end of if(feat.x2=="b" | feat.x2=="cat" ){

			if(feat.x2=="con" ){

					boxplot(x2~x1,col="red",xlab=x1name,ylab=x2name,cex.lab=1.5,cex.axis=1.5)
					tt=cbind(x1,x2)
					mn=aggregate(x2~x1,data=tt,mean,na.rm=T)
					text(1:2,mn[,2],round(mn[,2],2),col="blue",cex=2)

					t1=x2[x1==x1.vals[1]]
					pval=NA

					if(sum(t1,na.rm=T)>0) {
						tst=t.test(x2[x1==x1.vals[1]],x2[x1==x1.vals[2]])
						pval=tst$p.value
					}

					title(paste(Main,"P=", sprintf("%.2e",pval)))

				}#end of if(feat.x2=="b" | feat.x2=="cat" ){


		}#	end of if(feat.x1=="cat" )


		if(feat.x1=="b" )   {

				########### (1) plotting #################

				if(feat.x2=="cat" | feat.x2=="con.small"){

						tt=cbind(x1,x2)
						ag=aggregate(x1~x2,data=tt,mean,na.rm=T)
						ag
						# > ag
						#   x2         x1
						# 1  1 0.12247839
						# 2  2 0.10704164
						# 3  3 0.07297442
						# 4  4 0.07143629
						# 5  5 0.07259953
						# 6  6 0.04432450
						# 7  7 0.04554080
						k=nrow(ag)
						xs=(0:(k-1))+0.5
						barplot(ag[,2],rep(1,nrow(ag)),col="red",xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=1.5,space=0.01)
						axis(1,at=xs, ag[,1],cex.axis=1.5)
						text(xs,ag[,2]*0.9,round(ag[,2],3),cex=1.5,col="blue")
						#title(Main)

				}#end of

				if(feat.x2=="con"){


					boxplot(x2~x1,col="red",xlab=x1name,ylab=x2name,cex.lab=1.5,cex.axis=1.5)
					tt=cbind(x1,x2)
					mn=aggregate(x2~x1,data=tt,mean,na.rm=T)
					text(1:2,mn[,2],round(mn[,2],2),col="blue",cex=2)

					tst=t.test(x2[x1==x1.vals[1]],x2[x1==x1.vals[2]])
					pval=tst$p.value

					title(paste(Main,"P=", sprintf("%.2e",pval)))


				}#end of

				if(feat.x2=="b"){

						#mosaicplot(x1~x2,col=c("red","blue"),xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=1.5)

						tt=cbind(x1,x2)
						ag=aggregate(x1~x2,data=tt,mean,na.rm=T)
						ag
						# > ag
						#   x2         x1
						# 1  1 0.12247839
						# 2  2 0.10704164
						# 3  3 0.07297442
						# 4  4 0.07143629
						# 5  5 0.07259953
						# 6  6 0.04432450
						# 7  7 0.04554080
						barplot(ag[,2],rep(1,nrow(ag)),col="red",xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=1.5)
						axis(1,cex.axis=1.5)#ag[,1],cex.axis=1.5)
						text(ag[,1]+1,ag[,2]*0.9,round(ag[,2],3),cex=1.5,col="blue")
						title(Main)

				}#


			    ######### (2) testing ####################

				if(feat.x2=="con.small") {

					lm1=glm(x1~x2,family=binomial)
					lm1s=summary(lm1)
					pval=lm1s$coef["x2",4] #[1] "6e-64"
					title(paste(Main,"P=", sprintf("%.2e",pval)),cex.main=1.5)

				}#end of con
				if(feat.x2=="cat" | feat.x2=="b") {

					lm1=glm(x1~factor(x2),family=binomial)
					lm1s=summary(lm1)
					pvals=lm1s$coef[-1,4] #[1] "6e-64"
					# > pvals
					#  factor(x2)2  factor(x2)3  factor(x2)4  factor(x2)5  factor(x2)6  factor(x2)7
					# 9.818564e-07 7.181392e-01 3.018821e-11 3.512503e-01 1.364911e-02 5.319828e-01
					or=round(exp(lm1s$coef[-1,1]),2)

					#xs=rep(0.9,nrow(ag))
					pvals2=paste("(P=",sprintf("%.2e",pvals),")",sep="")
					or2=paste("(OR=",sprintf("%.2f",or),")",sep="")
					pvals2[pvals>0.01]=""
					or2[pvals>0.01]=""

					if(feat.x2=="cat") {

						text(xs[-1],ag[-1,2]*0.7, pvals2,col="blue",cex=0.8)
						text(xs[-1],ag[-1,2]*0.6, or2,col="blue",cex=0.8)
						title(Main)

					}

					if(feat.x2=="b") {
						text(2,ag[-1,2]*0.7, pvals2,col="blue")
						text(2,ag[-1,2]*0.6, or2,col="blue")
					}


				}#	if(n1==2 & n2>2)

		}#if(feat.x1=="b" & (feat.x2=="con" | feat.x2=="cat"))

	}#end of loop

}#end of function

### /19/2015: simply put boxplot without median numbers (for publication) ##
### 2/12/2014 just add model heading ##
myInvestigate.variable3b <- function(x1name,x2names,DATA,varfeatures,YLIM=NULL,MAIN,CEX.AXIS=1.5 ){

	# x2names=c("EDUCAT","race7","bmi_curc",
	# 			"copd_f","lung_fh",
	# 			"cig_stat","cig_per_day","cig_stop_rnd","cig_years_rnd","age")
	#
	# varfeatures=c("cat","cat","cat","b","b","cat","con","con","con","b","con")


	x1=DATA[,x1name]
	feat.x1 = varfeatures[x2names==x1name] #[1]"b"  # binary
	x1.vals = unique(x1[is.na(x1)==F]) #[1] 0 1


	### exclude x1 ###
	x2names.b = x2names[x2names!=x1name]
	x2s=DATA[,x2names.b]
	varfeatures.b = varfeatures[x2names!=x1name]

	#n1=length(unique(x1[is.na(x1)==F]))



	for(j in 1:length(x2names.b)){

		print(j)
		x2=x2s[,j]
		x2name=x2names.b[j]
		#n2=length(unique(x2[is.na(x2)==F]))
		feat.x2 = varfeatures.b[x2names.b==x2name] #[1]"b"  # binary
	Main=paste("[", x2name,"]",sep="")
	#Main=paste("[",x1name, " & ", x2name,"]",sep="")

		if(feat.x1=="con"){

				if(feat.x2=="con"){

				     plot(x1~x2,xlab=x2name,ylab=x1name,cex.axis=1.5,main=MAIN,pch=16,col="blue",cex.lab=1.5)
				     #plot(x,y, main=paste(Main0,colName,sep=""),pch=16,xlab=colName,ylab="Overdiagnosis Rate (%)",col="blue",cex.axis=2,cex.lab=1.5,cex=1.5,cex.main=1.5)

				}#

				if(feat.x2=="cat"){

					if(is.null(YLIM)==T) boxplot(x1~x2,col="red",xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=1.5)
					if(is.null(YLIM)==F) boxplot(x1~x2,col="red",xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=1.5,ylim=YLIM)


					tt=cbind(x1,x2)
					mn=aggregate(x1~x2,data=tt,mean,na.rm=T)
					text(1:nrow(mn),mn[,2],round(mn[,2],2),col="blue",cex=2)

					t1=x2[x1==x1.vals[1]]
					pval=tt1=NA

					if(length(t1[!is.na(t1)])>0) {
						#tst=t.test(x2[x1==x1.vals[1]],x2[x1==x1.vals[2]])
						#pval=tst$p.value

						#lm1=lm(x1~as.factor(x2))
						#lm2=anova(lm1)
						#pval=lm2[[5]][1]


						tt=kruskal.test(x1, x2)
						pval=tt$p.value

					}

					if(is.na(pval)==F){
					if(pval < 0.0001) tt1=sprintf("%.2e",pval)
					if(pval >= 0.0001) tt1=sprintf("%.3f",pval)
					}

					title(paste(MAIN, "\n", Main,"P=",tt1 ))


					if(is.null(YLIM)==T) boxplot(x1~x2,col="red",xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=1.5)
					if(is.null(YLIM)==F) boxplot(x1~x2,col="red",xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=1.5,ylim=YLIM)

				}#

		}#if(feat.x1=="con"){


		if(feat.x1=="cat" )   {


			if(feat.x2=="b" | feat.x2=="cat" ){

					mosaicplot(x2~x1,col=c("green","red","blue"),xlab=x2name,ylab=x1name,cex.axis=1.5,main=MAIN)
					tb=table(x1,x2)
					tst=chisq.test(tb)
					pval=tst$p.value
					title(paste(MAIN, "\n", Main,"P=", sprintf("%.2e",pval)))

					if(x1name=="cig_stat"){
								### current smoker prevalence ##
								prop <- function(x1) sum(x1==1,na.rm=T)/sum(is.na(x1)==F)
								tt=cbind(x1,x2)
								ag=aggregate(x1~x2,data=tt,prop)
								ag
								xs0=as.numeric(names(table(x2)))
								#xs=seq(0,1,by=1/length(xs0))[-length(xs0)]
								xs=(ag[,1]-1)*(1/length(xs0))
								text(xs,0.8,round(ag[,2],2),cex=1,col="blue")
								title(sub=paste(round(ag[,2],2),collapse="-"))

					}#
			}#end of if(feat.x2=="b" | feat.x2=="cat" ){

			if(feat.x2=="con" ){

					boxplot(x2~x1,col="red",xlab=x1name,ylab=x2name,cex.lab=1.5,cex.axis=1.5)
					tt=cbind(x1,x2)
					mn=aggregate(x2~x1,data=tt,mean,na.rm=T)
					text(1:2,mn[,2],round(mn[,2],2),col="blue",cex=2)

					t1=x2[x1==x1.vals[1]]
					pval=NA

					if(sum(t1,na.rm=T)>0) {
						tst=t.test(x2[x1==x1.vals[1]],x2[x1==x1.vals[2]])
						pval=tst$p.value
					}

					title(paste(MAIN, "\n", Main,"P=", sprintf("%.2e",pval)))

					boxplot(x2~x1,col="red",xlab=x1name,ylab=x2name,cex.lab=1.5,cex.axis=1.5)

				}#end of if(feat.x2=="b" | feat.x2=="cat" ){


		}#	end of if(feat.x1=="cat" )


		if(feat.x1=="b" )   {

				########### (1) plotting #################

				if(feat.x2=="cat" | feat.x2=="con.small"){

						tt=cbind(x1,x2)
						ag=aggregate(x1~x2,data=tt,mean,na.rm=T)
						ag
						# > ag
						#   x2         x1
						# 1  1 0.12247839
						# 2  2 0.10704164
						# 3  3 0.07297442
						# 4  4 0.07143629
						# 5  5 0.07259953
						# 6  6 0.04432450
						# 7  7 0.04554080
						k=nrow(ag)
						xs=(0:(k-1))+0.5
						barplot(ag[,2],rep(1,nrow(ag)),col="red",xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=1.5,space=0.01)
						axis(1,at=xs, ag[,1],cex.axis=1.5)
						text(xs,ag[,2]*0.9,round(ag[,2],3),cex=1.5,col="blue")
						#title(Main)

				}#end of

				if(feat.x2=="con"){


					boxplot(x2~x1,col="red",xlab=x1name,ylab=x2name,cex.lab=1.5,cex.axis=1.5)
					tt=cbind(x1,x2)
					mn=aggregate(x2~x1,data=tt,mean,na.rm=T)
					text(1:2,mn[,2],round(mn[,2],2),col="blue",cex=2)

					tst=t.test(x2[x1==x1.vals[1]],x2[x1==x1.vals[2]])
					pval=tst$p.value

					title(paste(MAIN, "\n", Main,"P=", sprintf("%.2e",pval)))


				}#end of

				if(feat.x2=="b"){

						#mosaicplot(x1~x2,col=c("red","blue"),xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=1.5)

						tt=cbind(x1,x2)
						ag=aggregate(x1~x2,data=tt,mean,na.rm=T)
						ag
						# > ag
						#   x2         x1
						# 1  1 0.12247839
						# 2  2 0.10704164
						# 3  3 0.07297442
						# 4  4 0.07143629
						# 5  5 0.07259953
						# 6  6 0.04432450
						# 7  7 0.04554080
						barplot(ag[,2],rep(1,nrow(ag)),col="red",xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=CEX.AXIS)
						axis(1,cex.axis=1.5)#ag[,1],cex.axis=1.5)
						text(ag[,1]+1,ag[,2]*0.9,round(ag[,2],3),cex=1.5,col="blue")
						title(paste(MAIN, "\n", Main))

				}#


			    ######### (2) testing ####################

				if(feat.x2=="con.small") {

					lm1=glm(x1~x2,family=binomial)
					lm1s=summary(lm1)
					pval=lm1s$coef["x2",4] #[1] "6e-64"
					title(paste(Main,"P=", sprintf("%.2e",pval)),cex.main=1.5)

				}#end of con
				if(feat.x2=="cat" | feat.x2=="b") {

					lm1=glm(x1~factor(x2),family=binomial)
					lm1s=summary(lm1)
					pvals=lm1s$coef[-1,4] #[1] "6e-64"
					# > pvals
					#  factor(x2)2  factor(x2)3  factor(x2)4  factor(x2)5  factor(x2)6  factor(x2)7
					# 9.818564e-07 7.181392e-01 3.018821e-11 3.512503e-01 1.364911e-02 5.319828e-01
					or=round(exp(lm1s$coef[-1,1]),2)

					#xs=rep(0.9,nrow(ag))
					pvals2=paste("(P=",sprintf("%.2e",pvals),")",sep="")
					or2=paste("(OR=",sprintf("%.2f",or),")",sep="")
					pvals2[pvals>0.01]=""
					or2[pvals>0.01]=""

					if(feat.x2=="cat") {

						text(xs[-1],ag[-1,2]*0.7, pvals2,col="blue",cex=0.8)
						text(xs[-1],ag[-1,2]*0.6, or2,col="blue",cex=0.8)
						title(paste(MAIN, "\n", Main))

					}

					if(feat.x2=="b") {
						text(2,ag[-1,2]*0.7, pvals2,col="blue")
						text(2,ag[-1,2]*0.6, or2,col="blue")
					}


				}#	if(n1==2 & n2>2)

		}#if(feat.x1=="b" & (feat.x2=="con" | feat.x2=="cat"))

	}#end of loop

}#end of function

### 2/12/2014 just add model heading ##

myInvestigate.variable3 <- function(x1name,x2names,DATA,varfeatures,YLIM=NULL,MAIN,CEX.AXIS=1.5 ){

	# x2names=c("EDUCAT","race7","bmi_curc",
	# 			"copd_f","lung_fh",
	# 			"cig_stat","cig_per_day","cig_stop_rnd","cig_years_rnd","age")
	#
	# varfeatures=c("cat","cat","cat","b","b","cat","con","con","con","b","con")


	x1=DATA[,x1name]
	feat.x1 = varfeatures[x2names==x1name] #[1]"b"  # binary
	x1.vals = unique(x1[is.na(x1)==F]) #[1] 0 1


	### exclude x1 ###
	x2names.b = x2names[x2names!=x1name]
	x2s=DATA[,x2names.b]
	varfeatures.b = varfeatures[x2names!=x1name]

	#n1=length(unique(x1[is.na(x1)==F]))



	for(j in 1:length(x2names.b)){

		print(j)
		x2=x2s[,j]
		x2name=x2names.b[j]
		#n2=length(unique(x2[is.na(x2)==F]))
		feat.x2 = varfeatures.b[x2names.b==x2name] #[1]"b"  # binary
	Main=paste("[", x2name,"]",sep="")
	#Main=paste("[",x1name, " & ", x2name,"]",sep="")

		if(feat.x1=="con"){

				if(feat.x2=="con"){

				     plot(x1~x2,xlab=x2name,ylab=x1name,cex.axis=1.5,main=MAIN,pch=16,col="blue",cex.lab=1.5)
				     #plot(x,y, main=paste(Main0,colName,sep=""),pch=16,xlab=colName,ylab="Overdiagnosis Rate (%)",col="blue",cex.axis=2,cex.lab=1.5,cex=1.5,cex.main=1.5)

				}#

				if(feat.x2=="cat"){

					if(is.null(YLIM)==T) boxplot(x1~x2,col="red",xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=1.5)
					if(is.null(YLIM)==F) boxplot(x1~x2,col="red",xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=1.5,ylim=YLIM)


					tt=cbind(x1,x2)
					mn=aggregate(x1~x2,data=tt,mean,na.rm=T)
					text(1:nrow(mn),mn[,2],round(mn[,2],2),col="blue",cex=2)

					t1=x2[x1==x1.vals[1]]
					pval=tt1=NA

					if(length(t1[!is.na(t1)])>0) {
						#tst=t.test(x2[x1==x1.vals[1]],x2[x1==x1.vals[2]])
						#pval=tst$p.value

						#lm1=lm(x1~as.factor(x2))
						#lm2=anova(lm1)
						#pval=lm2[[5]][1]


						tt=kruskal.test(x1, x2)
						pval=tt$p.value

					}

					if(is.na(pval)==F){
					if(pval < 0.0001) tt1=sprintf("%.2e",pval)
					if(pval >= 0.0001) tt1=sprintf("%.3f",pval)
					}

					title(paste(MAIN, "\n", Main,"P=",tt1 ))

				}#

		}#if(feat.x1=="con"){


		if(feat.x1=="cat" )   {


			if(feat.x2=="b" | feat.x2=="cat" ){

					mosaicplot(x2~x1,col=c("green","red","blue"),xlab=x2name,ylab=x1name,cex.axis=1.5,main=MAIN)
					tb=table(x1,x2)
					tst=chisq.test(tb)
					pval=tst$p.value
					title(paste(MAIN, "\n", Main,"P=", sprintf("%.2e",pval)))

					if(x1name=="cig_stat"){
								### current smoker prevalence ##
								prop <- function(x1) sum(x1==1,na.rm=T)/sum(is.na(x1)==F)
								tt=cbind(x1,x2)
								ag=aggregate(x1~x2,data=tt,prop)
								ag
								xs0=as.numeric(names(table(x2)))
								#xs=seq(0,1,by=1/length(xs0))[-length(xs0)]
								xs=(ag[,1]-1)*(1/length(xs0))
								text(xs,0.8,round(ag[,2],2),cex=1,col="blue")
								title(sub=paste(round(ag[,2],2),collapse="-"))

					}#
			}#end of if(feat.x2=="b" | feat.x2=="cat" ){

			if(feat.x2=="con" ){

					boxplot(x2~x1,col="red",xlab=x1name,ylab=x2name,cex.lab=1.5,cex.axis=1.5)
					tt=cbind(x1,x2)
					mn=aggregate(x2~x1,data=tt,mean,na.rm=T)
					text(1:2,mn[,2],round(mn[,2],2),col="blue",cex=2)

					t1=x2[x1==x1.vals[1]]
					pval=NA

					if(sum(t1,na.rm=T)>0) {
						tst=t.test(x2[x1==x1.vals[1]],x2[x1==x1.vals[2]])
						pval=tst$p.value
					}

					title(paste(MAIN, "\n", Main,"P=", sprintf("%.2e",pval)))

				}#end of if(feat.x2=="b" | feat.x2=="cat" ){


		}#	end of if(feat.x1=="cat" )


		if(feat.x1=="b" )   {

				########### (1) plotting #################

				if(feat.x2=="cat" | feat.x2=="con.small"){

						tt=cbind(x1,x2)
						ag=aggregate(x1~x2,data=tt,mean,na.rm=T)
						ag
						# > ag
						#   x2         x1
						# 1  1 0.12247839
						# 2  2 0.10704164
						# 3  3 0.07297442
						# 4  4 0.07143629
						# 5  5 0.07259953
						# 6  6 0.04432450
						# 7  7 0.04554080
						k=nrow(ag)
						xs=(0:(k-1))+0.5
						barplot(ag[,2],rep(1,nrow(ag)),col="red",xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=1.5,space=0.01)
						axis(1,at=xs, ag[,1],cex.axis=1.5)
						text(xs,ag[,2]*0.9,round(ag[,2],3),cex=1.5,col="blue")
						#title(Main)

				}#end of

				if(feat.x2=="con"){


					boxplot(x2~x1,col="red",xlab=x1name,ylab=x2name,cex.lab=1.5,cex.axis=1.5)
					tt=cbind(x1,x2)
					mn=aggregate(x2~x1,data=tt,mean,na.rm=T)
					text(1:2,mn[,2],round(mn[,2],2),col="blue",cex=2)

					tst=t.test(x2[x1==x1.vals[1]],x2[x1==x1.vals[2]])
					pval=tst$p.value

					title(paste(MAIN, "\n", Main,"P=", sprintf("%.2e",pval)))


				}#end of

				if(feat.x2=="b"){

						#mosaicplot(x1~x2,col=c("red","blue"),xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=1.5)

						tt=cbind(x1,x2)
						ag=aggregate(x1~x2,data=tt,mean,na.rm=T)
						ag
						# > ag
						#   x2         x1
						# 1  1 0.12247839
						# 2  2 0.10704164
						# 3  3 0.07297442
						# 4  4 0.07143629
						# 5  5 0.07259953
						# 6  6 0.04432450
						# 7  7 0.04554080
						barplot(ag[,2],rep(1,nrow(ag)),col="red",xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=CEX.AXIS)
						axis(1,cex.axis=1.5)#ag[,1],cex.axis=1.5)
						text(ag[,1]+1,ag[,2]*0.9,round(ag[,2],3),cex=1.5,col="blue")
						title(paste(MAIN, "\n", Main))

				}#


			    ######### (2) testing ####################

				if(feat.x2=="con.small") {

					lm1=glm(x1~x2,family=binomial)
					lm1s=summary(lm1)
					pval=lm1s$coef["x2",4] #[1] "6e-64"
					title(paste(Main,"P=", sprintf("%.2e",pval)),cex.main=1.5)

				}#end of con
				if(feat.x2=="cat" | feat.x2=="b") {

					lm1=glm(x1~factor(x2),family=binomial)
					lm1s=summary(lm1)
					pvals=lm1s$coef[-1,4] #[1] "6e-64"
					# > pvals
					#  factor(x2)2  factor(x2)3  factor(x2)4  factor(x2)5  factor(x2)6  factor(x2)7
					# 9.818564e-07 7.181392e-01 3.018821e-11 3.512503e-01 1.364911e-02 5.319828e-01
					or=round(exp(lm1s$coef[-1,1]),2)

					#xs=rep(0.9,nrow(ag))
					pvals2=paste("(P=",sprintf("%.2e",pvals),")",sep="")
					or2=paste("(OR=",sprintf("%.2f",or),")",sep="")
					pvals2[pvals>0.01]=""
					or2[pvals>0.01]=""

					if(feat.x2=="cat") {

						text(xs[-1],ag[-1,2]*0.7, pvals2,col="blue",cex=0.8)
						text(xs[-1],ag[-1,2]*0.6, or2,col="blue",cex=0.8)
						title(paste(MAIN, "\n", Main))

					}

					if(feat.x2=="b") {
						text(2,ag[-1,2]*0.7, pvals2,col="blue")
						text(2,ag[-1,2]*0.6, or2,col="blue")
					}


				}#	if(n1==2 & n2>2)

		}#if(feat.x1=="b" & (feat.x2=="con" | feat.x2=="cat"))

	}#end of loop

}#end of function

myInvestigate.variable2 <- function(x1name,x2names,DATA,varfeatures,YLIM=NULL,CEX.AXIS=1.5){

	# x2names=c("EDUCAT","race7","bmi_curc",
	# 			"copd_f","lung_fh",
	# 			"cig_stat","cig_per_day","cig_stop_rnd","cig_years_rnd","age")
	#
	# varfeatures=c("cat","cat","cat","b","b","cat","con","con","con","b","con")


	x1=DATA[,x1name]
	feat.x1 = varfeatures[x2names==x1name] #[1]"b"  # binary
	x1.vals = unique(x1[is.na(x1)==F]) #[1] 0 1


	### exclude x1 ###
	x2names.b = x2names[x2names!=x1name]
	x2s=DATA[,x2names.b]
	varfeatures.b = varfeatures[x2names!=x1name]

	#n1=length(unique(x1[is.na(x1)==F]))



	for(j in 1:length(x2names.b)){

		print(j)
		x2=x2s[,j]
		x2name=x2names.b[j]
		#n2=length(unique(x2[is.na(x2)==F]))
		feat.x2 = varfeatures.b[x2names.b==x2name] #[1]"b"  # binary
		Main=paste("[",x1name, " & ", x2name,"]",sep="")

		if(feat.x1=="con"){

				if(feat.x2=="con"){

				     plot(x1~x2,xlab=x2name,ylab=x1name,cex.axis=1.5,main="",pch=16,col="blue",cex.lab=1.5)
				     #plot(x,y, main=paste(Main0,colName,sep=""),pch=16,xlab=colName,ylab="Overdiagnosis Rate (%)",col="blue",cex.axis=2,cex.lab=1.5,cex=1.5,cex.main=1.5)

				}#

				if(feat.x2=="cat"){

					if(is.null(YLIM)==T) boxplot(x1~x2,col="red",xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=1.5)
					if(is.null(YLIM)==F) boxplot(x1~x2,col="red",xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=1.5,ylim=YLIM)


					tt=cbind(x1,x2)
					mn=aggregate(x1~x2,data=tt,mean,na.rm=T)
					text(1:nrow(mn),mn[,2],round(mn[,2],2),col="blue",cex=2)

					t1=x2[x1==x1.vals[1]]
					pval=NA

					if(length(t1[!is.na(t1)])>0) {
						#tst=t.test(x2[x1==x1.vals[1]],x2[x1==x1.vals[2]])
						#pval=tst$p.value

						#lm1=lm(x1~as.factor(x2))
						#lm2=anova(lm1)
						#pval=lm2[[5]][1]


						tt=kruskal.test(x1, x2)
						pval=tt$p.value

					}

					if(pval < 0.0001) tt1=sprintf("%.2e",pval)
					if(pval >= 0.0001) tt1=sprintf("%.3f",pval)
					title(paste(Main,"P=",tt1 ))

				}#

		}#if(feat.x1=="con"){


		if(feat.x1=="cat" )   {


			if(feat.x2=="b" | feat.x2=="cat" ){

					mosaicplot(x2~x1,col=c("green","red","blue"),xlab=x2name,ylab=x1name,cex.axis=1.5,main="")
					tb=table(x1,x2)
					tst=chisq.test(tb)
					pval=tst$p.value
					title(paste(Main,"P=", sprintf("%.2e",pval)))

					if(x1name=="cig_stat"){
								### current smoker prevalence ##
								prop <- function(x1) sum(x1==1,na.rm=T)/sum(is.na(x1)==F)
								tt=cbind(x1,x2)
								ag=aggregate(x1~x2,data=tt,prop)
								ag
								xs0=as.numeric(names(table(x2)))
								#xs=seq(0,1,by=1/length(xs0))[-length(xs0)]
								xs=(ag[,1]-1)*(1/length(xs0))
								text(xs,0.8,round(ag[,2],2),cex=1,col="blue")
								title(sub=paste(round(ag[,2],2),collapse="-"))

					}#
			}#end of if(feat.x2=="b" | feat.x2=="cat" ){

			if(feat.x2=="con" ){

					boxplot(x2~x1,col="red",xlab=x1name,ylab=x2name,cex.lab=1.5,cex.axis=1.5)
					tt=cbind(x1,x2)
					mn=aggregate(x2~x1,data=tt,mean,na.rm=T)
					text(1:2,mn[,2],round(mn[,2],2),col="blue",cex=2)

					t1=x2[x1==x1.vals[1]]
					pval=NA

					if(sum(t1,na.rm=T)>0) {
						tst=t.test(x2[x1==x1.vals[1]],x2[x1==x1.vals[2]])
						pval=tst$p.value
					}

					title(paste(Main,"P=", sprintf("%.2e",pval)))

				}#end of if(feat.x2=="b" | feat.x2=="cat" ){


		}#	end of if(feat.x1=="cat" )


		if(feat.x1=="b" )   {

				########### (1) plotting #################

				if(feat.x2=="cat" | feat.x2=="con.small"){

						tt=cbind(x1,x2)
						ag=aggregate(x1~x2,data=tt,mean,na.rm=T)
						ag
						# > ag
						#   x2         x1
						# 1  1 0.12247839
						# 2  2 0.10704164
						# 3  3 0.07297442
						# 4  4 0.07143629
						# 5  5 0.07259953
						# 6  6 0.04432450
						# 7  7 0.04554080
						k=nrow(ag)
						xs=(0:(k-1))+0.5
						barplot(ag[,2],rep(1,nrow(ag)),col="red",xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=1.5,space=0.01)
						axis(1,at=xs, ag[,1],cex.axis=1.5)
						text(xs,ag[,2]*0.9,round(ag[,2],3),cex=1.5,col="blue")
						#title(Main)

				}#end of

				if(feat.x2=="con"){


					boxplot(x2~x1,col="red",xlab=x1name,ylab=x2name,cex.lab=1.5,cex.axis=1.5)
					tt=cbind(x1,x2)
					mn=aggregate(x2~x1,data=tt,mean,na.rm=T)
					text(1:2,mn[,2],round(mn[,2],2),col="blue",cex=2)

					tst=t.test(x2[x1==x1.vals[1]],x2[x1==x1.vals[2]])
					pval=tst$p.value

					title(paste(Main,"P=", sprintf("%.2e",pval)))


				}#end of

				if(feat.x2=="b"){

						#mosaicplot(x1~x2,col=c("red","blue"),xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=1.5)

						tt=cbind(x1,x2)
						ag=aggregate(x1~x2,data=tt,mean,na.rm=T)
						ag
						# > ag
						#   x2         x1
						# 1  1 0.12247839
						# 2  2 0.10704164
						# 3  3 0.07297442
						# 4  4 0.07143629
						# 5  5 0.07259953
						# 6  6 0.04432450
						# 7  7 0.04554080
						barplot(ag[,2],rep(1,nrow(ag)),col="red",xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=CEX.AXIS)
						axis(1,cex.axis=1.5)#ag[,1],cex.axis=1.5)
						text(ag[,1]+1,ag[,2]*0.9,round(ag[,2],3),cex=1.5,col="blue")
						title(Main)

				}#


			    ######### (2) testing ####################

				if(feat.x2=="con.small") {

					lm1=glm(x1~x2,family=binomial)
					lm1s=summary(lm1)
					pval=lm1s$coef["x2",4] #[1] "6e-64"
					title(paste(Main,"P=", sprintf("%.2e",pval)),cex.main=1.5)

				}#end of con
				if(feat.x2=="cat" | feat.x2=="b") {

					lm1=glm(x1~factor(x2),family=binomial)
					lm1s=summary(lm1)
					pvals=lm1s$coef[-1,4] #[1] "6e-64"
					# > pvals
					#  factor(x2)2  factor(x2)3  factor(x2)4  factor(x2)5  factor(x2)6  factor(x2)7
					# 9.818564e-07 7.181392e-01 3.018821e-11 3.512503e-01 1.364911e-02 5.319828e-01
					or=round(exp(lm1s$coef[-1,1]),2)

					#xs=rep(0.9,nrow(ag))
					pvals2=paste("(P=",sprintf("%.2e",pvals),")",sep="")
					or2=paste("(OR=",sprintf("%.2f",or),")",sep="")
					pvals2[pvals>0.01]=""
					or2[pvals>0.01]=""

					if(feat.x2=="cat") {

						text(xs[-1],ag[-1,2]*0.7, pvals2,col="blue",cex=0.8)
						text(xs[-1],ag[-1,2]*0.6, or2,col="blue",cex=0.8)
						title(Main)

					}

					if(feat.x2=="b") {
						text(2,ag[-1,2]*0.7, pvals2,col="blue")
						text(2,ag[-1,2]*0.6, or2,col="blue")
					}


				}#	if(n1==2 & n2>2)

		}#if(feat.x1=="b" & (feat.x2=="con" | feat.x2=="cat"))

	}#end of loop

}#end of function




myInvestigate.variable3.small <- function(x1name,x2names,DATA,varfeatures,YLIM=NULL,MAIN,CEX.AXIS=1.5 ){
### only binary x1

	# x2names=c("EDUCAT","race7","bmi_curc",
	# 			"copd_f","lung_fh",
	# 			"cig_stat","cig_per_day","cig_stop_rnd","cig_years_rnd","age")
	#
	# varfeatures=c("cat","cat","cat","b","b","cat","con","con","con","b","con")


	x1=as.numeric(as.character(DATA[,x1name]))
	feat.x1 = varfeatures[x2names==x1name] #[1]"b"  # binary
	x1.vals = unique(x1[is.na(x1)==F]) #[1] 0 1


	### exclude x1 ###
	x2names.b = x2names[x2names!=x1name]
	x2s=DATA[,x2names.b]
	varfeatures.b = varfeatures[x2names!=x1name]

	#n1=length(unique(x1[is.na(x1)==F]))



	for(j in 1:length(x2names.b)){

		print(j)
		x2=x2s[,j]
		x2name=x2names.b[j]
		#n2=length(unique(x2[is.na(x2)==F]))
		feat.x2 = varfeatures.b[x2names.b==x2name] #[1]"b"  # binary
		Main=paste("[",x1name, " & ", x2name,"]",sep="")



		if(feat.x1=="b" )   {



				########### (1) plotting #################

				if(feat.x2=="cat" | feat.x2=="con.small"){

						x2=as.factor(as.character(x2))

						tt=data.frame(x1,x2)
						ag=aggregate(x1~x2,data=tt,mean,na.rm=T)
						ag
						# > ag
						#   x2         x1
						# 1  1 0.12247839
						# 2  2 0.10704164
						# 3  3 0.07297442
						# 4  4 0.07143629
						# 5  5 0.07259953
						# 6  6 0.04432450
						# 7  7 0.04554080
						k=nrow(ag)
						xs=(0:(k-1))+0.5
						barplot(ag[,2],rep(1,nrow(ag)),col="red",xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=1.5,space=0.01)
						axis(1,at=xs, ag[,1],cex.axis=1.5)
						text(xs,ag[,2]*0.9,round(ag[,2],4),cex=1.5,col="blue")
						#title(Main)

				}#end of

				if(feat.x2=="con"){


					x2=as.numeric(as.character(x2))

					boxplot(x2~x1,col="red",xlab=x1name,ylab=x2name,cex.lab=1.5,cex.axis=1.5)
					tt=cbind(x1,x2)
					mn=aggregate(x2~x1,data=tt,mean,na.rm=T)
					text(1:2,mn[,2],round(mn[,2],2),col="blue",cex=2)

					tst=t.test(x2[x1==x1.vals[1]],x2[x1==x1.vals[2]])
					pval=tst$p.value

					title(paste(MAIN, "\n", Main,"P=", sprintf("%.2e",pval)))


				}#end of

				if(feat.x2=="b"){

						x2=as.numeric(as.character(x2))

						#mosaicplot(x1~x2,col=c("red","blue"),xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=1.5)

						tt=cbind(x1,x2)
						ag=aggregate(x1~x2,data=tt,mean,na.rm=T)
						ag
						# > ag
						#   x2         x1
						# 1  1 0.12247839
						# 2  2 0.10704164
						# 3  3 0.07297442
						# 4  4 0.07143629
						# 5  5 0.07259953
						# 6  6 0.04432450
						# 7  7 0.04554080
						barplot(ag[,2],rep(1,nrow(ag)),col="red",xlab=x2name,ylab=x1name,cex.lab=1.5,cex.axis=CEX.AXIS)
						axis(1,cex.axis=1.5)#ag[,1],cex.axis=1.5)
						text(ag[,1]+1,ag[,2]*0.9,round(ag[,2],4),cex=1.5,col="blue")
						title(paste(MAIN, "\n", Main))

				}#


			    ######### (2) testing ####################

				if(feat.x2=="con.small") {

					lm1=glm(x1~x2,family=binomial)
					lm1s=summary(lm1)
					pval=lm1s$coef["x2",4] #[1] "6e-64"
					title(paste(Main,"P=", sprintf("%.2e",pval)),cex.main=1.5)

				}#end of con
				if(feat.x2=="cat" | feat.x2=="b") {

					lm1=glm(x1~factor(x2),family=binomial)
					lm1s=summary(lm1)
					pvals=lm1s$coef[-1,4] #[1] "6e-64"
					# > pvals
					#  factor(x2)2  factor(x2)3  factor(x2)4  factor(x2)5  factor(x2)6  factor(x2)7
					# 9.818564e-07 7.181392e-01 3.018821e-11 3.512503e-01 1.364911e-02 5.319828e-01
					or=round(exp(lm1s$coef[-1,1]),2)

					#xs=rep(0.9,nrow(ag))
					pvals2=paste("(P=",sprintf("%.2e",pvals),")",sep="")
					or2=paste("(OR=",sprintf("%.2f",or),")",sep="")
					pvals2[pvals>0.1]=""
					or2[pvals>0.1]=""

					if(feat.x2=="cat") {

						text(xs[-1],ag[-1,2]*0.7, pvals2,col="blue",cex=0.8)
						text(xs[-1],ag[-1,2]*0.6, or2,col="blue",cex=0.8)
						title(paste(MAIN, "\n", Main))

					}

					if(feat.x2=="b") {
						text(2,ag[-1,2]*0.7, pvals2,col="blue")
						text(2,ag[-1,2]*0.6, or2,col="blue")
					}


				}#	if(n1==2 & n2>2)

		}#if(feat.x1=="b" & (feat.x2=="con" | feat.x2=="cat"))

	}#end of loop


}#end of function

myDummyVar3=function(mat,refer=F,SORT=T){  ### this will create dummy variables with given level
                       ######## the most common one is reference and will be omitted

        ans2=NULL

        ####### in case it's not matrix make it ######

        if(is.null(dim(mat))==T) {

           dim(mat)=c(length(mat),1)
           colnames(mat)="x"

        }# end of



        for(u in 1:ncol(mat)){

              x=mat[,u]
              cname=colnames(mat)[u]
              cname


              #if(is.null(level)==T) {   # if no level is specified do it
                if(SORT==T){

                    tb=sort(table(x),decreasing=T)
                    tb
                    # 61 62 31 11 64 41 63
                    #80 77 51 49 48 46 13

                }# sort


                if(SORT==F){

                    tb=table(x)
                    tb
                    # 61 62 31 11 64 41 63
                    #80 77 51 49 48 46 13


                }#sort

                level= names(tb)
                level
                #[1]  "61" "62" "31" "11" "64" "41" "63"

              #}# end of is.null

                #> level

              #[1] 0 1 2
              #mat
              #      [,1] [,2]
              # [1,]    0    0
              # [2,]    0    1
              # [3,]    0    2
              # [4,]    1    0
              # [5,]    1    1
              # [6,]    1    2
              # [7,]    2    0
              # [8,]    2    1
              # [9,]    2    2
              level2=level[-1] #[1] 1 2  --> skip dummy variable for first level
              if(refer==T) level2=level

              ans=matrix(NA,nrow=nrow(mat),ncol=(length(level2)))
              colnames(ans)=paste(cname,level2,sep=".")

              #> ans
              #      [,1] [,2] [,3] [,4]
              # [1,]   NA   NA   NA   NA
              # [2,]   NA   NA   NA   NA
              # [3,]   NA   NA   NA   NA

              #Start=seq(1,ncol(ans),by=length(level2)) #[1] 1 3


              #where=Start[u]:(Start[u]+length(level2)-1) #[1] 1 2

              for(m in 1:length(level2)){  # skip first level, wich is zero level "0"

                   #ans[,where[m]] = (x==level2[m])*1

                   ans[,m] = (x==level2[m])*1


              }# end of m loop

              #> cbind(x,ans)[40:52,]
              #       x x.62 x.31 x.11 x.64 x.41 x.63
              # [1,] 11    0    0    1    0    0    0
              # [2,] 11    0    0    1    0    0    0
              # [3,] 11    0    0    1    0    0    0
              # [4,] 11    0    0    1    0    0    0
              # [5,] 11    0    0    1    0    0    0
              # [6,] 11    0    0    1    0    0    0
              # [7,] 11    0    0    1    0    0    0
              # [8,] 11    0    0    1    0    0    0
              # [9,] 11    0    0    1    0    0    0
              #[10,] 11    0    0    1    0    0    0
              #[11,] 31    0    1    0    0    0    0
              #[12,] 31    0    1    0    0    0    0
              #[13,] 31    0    1    0    0    0    0


      if (u==1) ans2=ans
      if (u!=1) ans2=cbind(ans2,ans)


     }# end of u loop

      ans2

}# end of myDummyVar


###########3/15/2016: update calculating probability from multinomila results#####

getProb.race.edu2  <- function(coefTab,ref.smk,MAIN=""){
				## given polytomous regression estimation results, this provide probabilties of education-race  (p1,p2,...p12) for given smoking status
				# > coefTab
				#                               Estimate Std. Error     t-value     Pr(>|t|)
				# A-<=high:(intercept)       -3.96767749 0.04424362 -68.9830411 0.000000e+00
				# A-college:(intercept)      -3.48788758 0.05457575 -63.9091078 0.000000e+00
				# A-postcol:(intercept)      -3.35291214 0.05112330 -65.5848151 0.000000e+00
				# B-<=high:(intercept)       -2.57996486 0.04051092 -70.7618578 0.000000e+00
				# B-college:(intercept)      -4.47451395 0.08854534 -50.5335905 0.000000e+00
				# B-postcol:(intercept)      -4.14694055 0.07533214 -55.0487550 0.000000e+00
				# H-<=high:(intercept)       -2.82335311 0.05568112 -63.3821880 0.000000e+00
				# H-college:(intercept)      -4.93987720 0.11150793 -44.3006810 0.000000e+00
				# H-postcol:(intercept)      -4.69959736 0.09898019 -47.4801835 0.000000e+00
				# W-college:(intercept)      -1.67604182 0.01686925 -47.3118367 0.000000e+00
				# W-postcol:(intercept)      -2.77892204 0.01496008 -28.5778278 0.000000e+00
				# A-<=high:cigstat1.Former   -0.23050611 0.05732333  -4.0211571 5.791296e-05
				# A-college:cigstat1.Former  -0.57193090 0.07623703  -7.5020096 6.283862e-14
				# A-postcol:cigstat1.Former  -0.94832165 0.07878926 -12.0361795 0.000000e+00
				# B-<=high:cigstat1.Former    0.01272992 0.05023165   0.2534242 7.999404e-01
				# B-college:cigstat1.Former  -0.53415298 0.12281115  -4.3493852 1.365197e-05
				# B-postcol:cigstat1.Former  -0.57045364 0.10535337  -5.4146694 6.140205e-08
				# H-<=high:cigstat1.Former   -0.03552330 0.06961492  -0.5102829 6.098533e-01
				# H-college:cigstat1.Former  -0.13572922 0.14203655  -0.9555936 3.392776e-01
				# H-postcol:cigstat1.Former  -0.63837331 0.14087276  -4.5315598 5.854976e-06
				# W-college:cigstat1.Former  -0.42260857 0.02226029 -18.9848605 0.000000e+00
				# W-postcol:cigstat1.Former  -0.79238312 0.02084755 -38.0084497 0.000000e+00
				# A-<=high:cigstat2.Current  -0.46851721 0.09320298  -5.0268483 4.986066e-07
				# A-college:cigstat2.Current -0.98558972 0.14184856  -6.9481828 3.700151e-12
				# A-postcol:cigstat2.Current -1.73236670 0.18454523  -9.3872203 0.000000e+00
				# B-<=high:cigstat2.Current   0.83770568 0.05748975  14.5713922 0.000000e+00
				# B-college:cigstat2.Current  0.14300691 0.15079625   0.9483453 3.429537e-01
				# B-postcol:cigstat2.Current -0.71519474 0.17569371  -4.0706906 4.687397e-05
				# H-<=high:cigstat2.Current   0.27649401 0.09106995   3.0360619 2.396902e-03
				# H-college:cigstat2.Current -1.12623089 0.30977524  -3.6356388 2.772926e-04
				# H-postcol:cigstat2.Current -0.96104562 0.25601949  -3.7537986 1.741748e-04
				# W-college:cigstat2.Current -0.74168560 0.03714342 -19.9681560 0.000000e+00
				# W-postcol:cigstat2.Current -1.29261404 0.03869194 -33.4078367 0.000000e+00
				# >
				###### [1] get a prob vector for former an current ####

				cigs = c("Never","Former","Current")

				vnames=row.names(coefTab)
				levs0=grep("intercept",vnames,value=T)
				# 		levs0
				#  [1] "A-<=high:(intercept)"  "A-college:(intercept)" "A-postcol:(intercept)" "B-<=high:(intercept)"  "B-college:(intercept)"
				#  [6] "B-postcol:(intercept)" "H-<=high:(intercept)"  "H-college:(intercept)" "H-postcol:(intercept)" "W-college:(intercept)"
				# [11] "W-postcol:(intercept)"
				levs0 = gsub(":","",levs0)
				levs = gsub("\\(intercept)","",levs0) #[1] "A-<=high"  "A-college" "A-postcol" "B-<=high"  "B-college" "B-postcol" "H-<=high"  "H-college" "H-postcol" "W-college" "W-postcol"

				## calculate exp(b0+b1*x)

				for(i in 1:length(cigs)){

					cig=cigs[i] #"Former

					for(j in 1:length(levs)){

						lev = levs[j] #[1] "A-<=high"
						coefTab[grep(lev,vnames),]
						subcoef=coefTab[grep(lev,vnames),]
						# > subcoef
						#                             Estimate Std. Error    t-value     Pr(>|t|)
						# A-<=high:(intercept)      -3.0520596 0.04424362 -68.983041 0.000000e+00
						# A-<=high:cigstat1.Former  -0.2305061 0.05732333  -4.021157 5.791296e-05
						# A-<=high:cigstat2.Current -0.4685172 0.09320298  -5.026848 4.986066e-07

						coefs=subcoef[,1]
						#     A-<=high:(intercept)  A-<=high:cigstat1.Former A-<=high:cigstat2.Current
						#                -3.0520596                -0.2305061                -0.4685172

						### find coefficient for "Former" other than intercept ##
						coefs2= c(coefs[1], coefs[-1][grep(cig, names(coefs[-1]))])
						coefs2
						#     A-<=high:(intercept) A-<=high:cigstat1.Former
						#               -3.0520596               -0.2305061

						## just intercept for never smokers
						# A-<=high:(intercept)
						#             -3.05206

						## xb = -3.052 - 0.2305*1

						pr = exp(sum(coefs2))
						#pr=inv.logit(sum(coefs2)) #[1] 0.03617415
						# > inv.logit
						# function(x) exp(x)/(1+exp(x))

						names(pr)=lev

						if(j==1) probs = pr
						if(j>1) probs=c(probs,pr)

					 }#end of for(j in 1:length(levs)){

					 if(i==1) PROBS = probs
					 if(i>1) PROBS=cbind(PROBS,probs)

				}#end of for(i in 1:length(cigs)){

				colnames(PROBS)=cigs

				# > PROBS
				#                 Never      Former     Current
				# A-<=high  0.045128638 0.036174155 0.028732394
				# A-college 0.029658838 0.016959562 0.011278914
				# A-postcol 0.033799932 0.013370632 0.006149116
				# B-<=high  0.053828151 0.054480189 0.116199590
				# B-college 0.011267360 0.006635478 0.012977099
				# B-postcol 0.015566571 0.008859252 0.007674597
				# H-<=high  0.028492963 0.027525937 0.037230082
				# H-college 0.007104640 0.006208510 0.002314815
				# H-postcol 0.009016896 0.004782629 0.003468208
				# W-college 0.310428850 0.227809114 0.176564241
				# W-postcol 0.394717143 0.227952362 0.151853067

				### calculate reference ###
				#p0 = 1/1+exp()+exp()...
			p0.never=1/(1+sum(PROBS[,1])); p0.never
			p0.former=1/(1+sum(PROBS[,2])); p0.former
			p0.current=1/(1+sum(PROBS[,3])); p0.current

			probs2= cbind(p0.never*PROBS[,1], p0.former*PROBS[,2], p0.current*PROBS[,3])

				PROBS2=rbind(probs2,W.high=c(p0.never, p0.former, p0.current))
				row.names(PROBS2)[nrow(PROBS2)]="W-<=high"
				colnames(PROBS2)=colnames(PROBS)
				# > PROBS2
				#                 Never      Former     Current
				# A-<=high  0.045128638 0.036174155 0.028732394
				# A-college 0.029658838 0.016959562 0.011278914
				# A-postcol 0.033799932 0.013370632 0.006149116
				# B-<=high  0.053828151 0.054480189 0.116199590
				# B-college 0.011267360 0.006635478 0.012977099
				# B-postcol 0.015566571 0.008859252 0.007674597
				# H-<=high  0.028492963 0.027525937 0.037230082
				# H-college 0.007104640 0.006208510 0.002314815
				# H-postcol 0.009016896 0.004782629 0.003468208
				# W-college 0.310428850 0.227809114 0.176564241
				# W-postcol 0.394717143 0.227952362 0.151853067
				# W-<=high  0.060990020 0.369242180 0.445557876

				# > sum(PROBS2)
				# [1] 3


				################# Weight on never, former, current smokers to get no-marginal probabilities ####

				## calculate asian proportion ##
				# > tb.smk
				# smkstatus
				#   Never  Former Current
				# 0.36609 0.40116 0.23275

			    #ref.smk = c(0.37, 0.40, 0.23); names(ref.smk)=c("Never","Former","Current")
				#   Never  Former Current
				#    0.37    0.40    0.23
				#### making total matrix sum = 1 (currently the sum is 3)

	##### reference smoking distribution is used for 1950 birth cohort ###################

	PROBS3= PROBS2
	PROBS3[,1] = PROBS2[,1]*ref.smk[1] # 0.37
	PROBS3[,2] = PROBS2[,2]*ref.smk[2] # 0.40
	PROBS3[,3] = PROBS2[,3]*ref.smk[3] # 0.23
				# > PROBS3 (each column sums up to 1)
				#                 Never      Former      Current
				# A-<=high  0.016697596 0.014469662 0.0066084507
				# A-college 0.010973770 0.006783825 0.0025941503
				# A-postcol 0.012505975 0.005348253 0.0014142967
				# B-<=high  0.019916416 0.021792076 0.0267259057
				# B-college 0.004168923 0.002654191 0.0029847328
				# B-postcol 0.005759631 0.003543701 0.0017651573
				# H-<=high  0.010542396 0.011010375 0.0085629188
				# H-college 0.002628717 0.002483404 0.0005324074
				# H-postcol 0.003336251 0.001913052 0.0007976879
				# W-college 0.114858674 0.091123646 0.0406097755
				# W-postcol 0.146045343 0.091180945 0.0349262053
				# W-<=high  0.022566308 0.147696872 0.1024783116
				# > sum(PROBS3)
				# [1] 1

				## race dist ##
				racenames=c("W","B","H","A")
				tt=rowSums(PROBS3)
				#    A-<=high   A-college   A-postcol    B-<=high   B-college   B-postcol    H-<=high   H-college   H-postcol   W-college
				# 0.037775709 0.020351745 0.019268524 0.068434397 0.009807847 0.011068489 0.030115690 0.005644528 0.006046991 0.246592096
				#   W-postcol    W-<=high
				# 0.272152493 0.272741491
				for(j in 1:length(racenames)){
					rc=racenames[j]
					pb=sum(tt[grep(rc,names(tt))])
					names(pb)=rc
					if(j==1) out=pb
					if(j>1) out=c(out,pb)
			    }#end of j loop

			    dist.race= out
				#          W          B          H          A
				# 0.79148608 0.08931073 0.04180721 0.07739598

				## from reference:
				#  W    B     H    A
				# 0.76 0.10 0.08 0.05


				### education dist ####
				edunames=c("high","college","postcol")
				tt=rowSums(PROBS3)
				#    A-<=high   A-college   A-postcol    B-<=high   B-college   B-postcol    H-<=high   H-college   H-postcol   W-college
				# 0.037775709 0.020351745 0.019268524 0.068434397 0.009807847 0.011068489 0.030115690 0.005644528 0.006046991 0.246592096
				#   W-postcol    W-<=high
				# 0.272152493 0.272741491

				for(j in 1:length(edunames)){
					ed=edunames[j]
					pb=sum(tt[grep(ed,names(tt))])
					names(pb)=ed
					if(j==1) out=pb
					if(j>1) out=c(out,pb)
			    }#end of j loop

			    dist.edu= out
				#      high   college   postcol
				# 0.4090673 0.2823962 0.3085365

				### from reference ##
				#      high   college   postcol
				#      0.78     0.15    0.07


				####### plots #####

				tab=dist.edu

				barplot(tab,col=(heat.colors(3)),ylim=c(0,0.9),main=paste(MAIN,"Education"),cex.axis=1.5,cex.lab=2,cex.main=2)
				text(1:length(tab),tab+0.1,round(tab,2),cex=2,col="blue")

				tab=dist.race
				barplot(tab,col=(heat.colors(length(tab))),ylim=c(0,1.1),main=paste(MAIN,"Race"),cex.axis=1.5,cex.lab=2,cex.main=2)
				text(1:length(tab),tab+0.1,round(tab,2),cex=2,col="blue")

				tab=ref.smk
				barplot(tab,col=rev(heat.colors(length(tab))),ylim=c(0,1),main=paste(MAIN, "Smoking Status"),cex.axis=1.5,cex.lab=2,cex.main=2)
				text(1:length(tab),tab+0.1,round(tab,2),cex=2,col="blue")


				ans=list(dist.race=dist.race, dist.edu=dist.edu, PROBS=PROBS2, PROBS.norm=PROBS3)
				ans



}#end of myPred.race.edu



###### (decided not to use this) 3/15/2016: predict() function to calculate probability from polytomous regression ##
		# my previous calculation seems wrong ##

getProb.race.edu2.temp  <- function(object, ref.smk,MAIN=""){   ## object is multinom() results
				## given polytomous regression estimation results, this provide probabilties of education-race  (p1,p2,...p12) for given smoking status
				# > coefTab
				#                               Estimate Std. Error     t-value     Pr(>|t|)
				# A-<=high:(intercept)       -3.96767749 0.04424362 -68.9830411 0.000000e+00
				# A-college:(intercept)      -3.48788758 0.05457575 -63.9091078 0.000000e+00
				# A-postcol:(intercept)      -3.35291214 0.05112330 -65.5848151 0.000000e+00
				# B-<=high:(intercept)       -2.57996486 0.04051092 -70.7618578 0.000000e+00
				# B-college:(intercept)      -4.47451395 0.08854534 -50.5335905 0.000000e+00
				# B-postcol:(intercept)      -4.14694055 0.07533214 -55.0487550 0.000000e+00
				# H-<=high:(intercept)       -2.82335311 0.05568112 -63.3821880 0.000000e+00
				# H-college:(intercept)      -4.93987720 0.11150793 -44.3006810 0.000000e+00
				# H-postcol:(intercept)      -4.69959736 0.09898019 -47.4801835 0.000000e+00
				# W-college:(intercept)      -1.67604182 0.01686925 -47.3118367 0.000000e+00
				# W-postcol:(intercept)      -2.77892204 0.01496008 -28.5778278 0.000000e+00
				# A-<=high:cigstat1.Former   -0.23050611 0.05732333  -4.0211571 5.791296e-05
				# A-college:cigstat1.Former  -0.57193090 0.07623703  -7.5020096 6.283862e-14
				# A-postcol:cigstat1.Former  -0.94832165 0.07878926 -12.0361795 0.000000e+00
				# B-<=high:cigstat1.Former    0.01272992 0.05023165   0.2534242 7.999404e-01
				# B-college:cigstat1.Former  -0.53415298 0.12281115  -4.3493852 1.365197e-05
				# B-postcol:cigstat1.Former  -0.57045364 0.10535337  -5.4146694 6.140205e-08
				# H-<=high:cigstat1.Former   -0.03552330 0.06961492  -0.5102829 6.098533e-01
				# H-college:cigstat1.Former  -0.13572922 0.14203655  -0.9555936 3.392776e-01
				# H-postcol:cigstat1.Former  -0.63837331 0.14087276  -4.5315598 5.854976e-06
				# W-college:cigstat1.Former  -0.42260857 0.02226029 -18.9848605 0.000000e+00
				# W-postcol:cigstat1.Former  -0.79238312 0.02084755 -38.0084497 0.000000e+00
				# A-<=high:cigstat2.Current  -0.46851721 0.09320298  -5.0268483 4.986066e-07
				# A-college:cigstat2.Current -0.98558972 0.14184856  -6.9481828 3.700151e-12
				# A-postcol:cigstat2.Current -1.73236670 0.18454523  -9.3872203 0.000000e+00
				# B-<=high:cigstat2.Current   0.83770568 0.05748975  14.5713922 0.000000e+00
				# B-college:cigstat2.Current  0.14300691 0.15079625   0.9483453 3.429537e-01
				# B-postcol:cigstat2.Current -0.71519474 0.17569371  -4.0706906 4.687397e-05
				# H-<=high:cigstat2.Current   0.27649401 0.09106995   3.0360619 2.396902e-03
				# H-college:cigstat2.Current -1.12623089 0.30977524  -3.6356388 2.772926e-04
				# H-postcol:cigstat2.Current -0.96104562 0.25601949  -3.7537986 1.741748e-04
				# W-college:cigstat2.Current -0.74168560 0.03714342 -19.9681560 0.000000e+00
				# W-postcol:cigstat2.Current -1.29261404 0.03869194 -33.4078367 0.000000e+00
				# >
				###### [1] get a prob vector for former an current ####


				newdata=data.frame(cigstat=c("0.Never","1.Former","2.Current"))
				# > predict(fit1,newdata=newdata)
				# [1] W-<=high W-<=high W-<=high
				# Levels: W-<=high A-<=high A-college A-postcol B-<=high B-college B-postcol H-<=high H-college H-postcol W-college W-postcol
				pd=predict(object,newdata=newdata,type="probs")
				row.names(pd)=c("Never","Former","Current")
				pd
				#            W-<=high   A-<=high   A-college   A-postcol   B-<=high   B-college   B-postcol   H-<=high   H-college   H-postcol W-college W-postcol
				# 0.Never   0.4265426 0.02044031 0.013161780 0.014413605 0.02390151 0.004118474 0.006546206 0.01243265 0.002721532 0.004118366 0.1914316 0.2801714
				# 1.Former  0.5619019 0.02147925 0.009668873 0.007842713 0.03407478 0.003973074 0.005591965 0.01651677 0.003868135 0.002665196 0.1653229 0.1670945
				# 2.Current 0.6064949 0.01923241 0.006721774 0.003477843 0.07924779 0.008109270 0.006036929 0.02224598 0.001624033 0.001853303 0.1256171 0.1193386

				# > rowSums(pd)
				#   0.Never  1.Former 2.Current
				#         1         1         1

				PROBS=t(pd)
				PROBS
				#                 Never      Former     Current
				# W-<=high  0.426542595 0.561901889 0.606494928 <----- reference
				# A-<=high  0.020440315 0.021479253 0.019232409
				# A-college 0.013161780 0.009668873 0.006721774
				# A-postcol 0.014413605 0.007842713 0.003477843
				# B-<=high  0.023901510 0.034074776 0.079247789
				# B-college 0.004118474 0.003973074 0.008109270
				# B-postcol 0.006546206 0.005591965 0.006036929
				# H-<=high  0.012432653 0.016516774 0.022245980
				# H-college 0.002721532 0.003868135 0.001624033
				# H-postcol 0.004118366 0.002665196 0.001853303
				# W-college 0.191431604 0.165322891 0.125617098
				# W-postcol 0.280171361 0.167094459 0.119338644
				colSums(PROBS)
				#   Never  Former Current
				#       1       1       1

							#### my old probablity-- reference "W-<=high" is totally wrong
							# > PROBS2
							#                 Never      Former     Current
							# A-<=high  0.045128638 0.036174155 0.028732394
							# A-college 0.029658838 0.016959562 0.011278914
							# A-postcol 0.033799932 0.013370632 0.006149116
							# B-<=high  0.053828151 0.054480189 0.116199590
							# B-college 0.011267360 0.006635478 0.012977099
							# B-postcol 0.015566571 0.008859252 0.007674597
							# H-<=high  0.028492963 0.027525937 0.037230082
							# H-college 0.007104640 0.006208510 0.002314815
							# H-postcol 0.009016896 0.004782629 0.003468208
							# W-college 0.310428850 0.227809114 0.176564241
							# W-postcol 0.394717143 0.227952362 0.151853067
							# W-<=high  0.060990020 0.369242180 0.445557876 <-----



				################# Weight on never, former, current smokers to get no-marginal probabilities ####

				## calculate asian proportion ##
				# > tb.smk
				# smkstatus
				#   Never  Former Current
				# 0.36609 0.40116 0.23275

			    #ref.smk = c(0.37, 0.40, 0.23); names(ref.smk)=c("Never","Former","Current")
				#   Never  Former Current
				#    0.37    0.40    0.23
				#### making total matrix sum = 1 (currently the sum is 3)

	##### reference smoking distribution is used for 1950 birth cohort ###################

	PROBS3= PROBS
	PROBS3[,1] = PROBS[,1]*ref.smk[1] # 0.37
	PROBS3[,2] = PROBS[,2]*ref.smk[2] # 0.40
	PROBS3[,3] = PROBS[,3]*ref.smk[3] # 0.23
				# > PROBS3 (each column sums up to 1)
				#                 Never      Former      Current
				# W-<=high  0.157820760 0.224760756 0.1394938334
				# A-<=high  0.007562917 0.008591701 0.0044234541
				# A-college 0.004869858 0.003867549 0.0015460079
				# A-postcol 0.005333034 0.003137085 0.0007999040
				# B-<=high  0.008843559 0.013629910 0.0182269915
				# B-college 0.001523835 0.001589229 0.0018651320
				# B-postcol 0.002422096 0.002236786 0.0013884937
				# H-<=high  0.004600081 0.006606710 0.0051165754
				# H-college 0.001006967 0.001547254 0.0003735276
				# H-postcol 0.001523795 0.001066078 0.0004262597
				# W-college 0.070829693 0.066129157 0.0288919325
				# W-postcol 0.103663403 0.066837784 0.0274478881

				# > sum(PROBS3)
				# [1] 1

				## race dist ##
				racenames=c("W","B","H","A")
				tt=rowSums(PROBS3)
				#    A-<=high   A-college   A-postcol    B-<=high   B-college   B-postcol    H-<=high   H-college   H-postcol   W-college
				# 0.037775709 0.020351745 0.019268524 0.068434397 0.009807847 0.011068489 0.030115690 0.005644528 0.006046991 0.246592096
				#   W-postcol    W-<=high
				# 0.272152493 0.272741491
				for(j in 1:length(racenames)){
					rc=racenames[j]
					pb=sum(tt[grep(rc,names(tt))])
					names(pb)=rc
					if(j==1) out=pb
					if(j>1) out=c(out,pb)
			    }#end of j loop

			    dist.race= out
				#          W          B          H          A  <--- new
				# 0.88587521 0.05172603 0.02226725 0.04013151
				## from reference:
				#  W    B     H    A
				# 0.76 0.10 0.08 0.05


				#          W          B          H          A  <--- old
				# 0.79148608 0.08931073 0.04180721 0.07739598



				### education dist ####
				edunames=c("high","college","postcol")
				tt=rowSums(PROBS3)
				#    A-<=high   A-college   A-postcol    B-<=high   B-college   B-postcol    H-<=high   H-college   H-postcol   W-college
				# 0.037775709 0.020351745 0.019268524 0.068434397 0.009807847 0.011068489 0.030115690 0.005644528 0.006046991 0.246592096
				#   W-postcol    W-<=high
				# 0.272152493 0.272741491

				for(j in 1:length(edunames)){
					ed=edunames[j]
					pb=sum(tt[grep(ed,names(tt))])
					names(pb)=ed
					if(j==1) out=pb
					if(j>1) out=c(out,pb)
			    }#end of j loop

			    dist.edu= out
				#      high   college   postcol
				# 0.5996772 0.1840401 0.2162826  (new)

				### from reference ##
				#      high   college   postcol
				#      0.78     0.15    0.07


				#      high   college   postcol
				# 0.4090673 0.2823962 0.3085365  (old predic wrong)



				####### plots #####

				tab=dist.edu

				barplot(tab,col=(heat.colors(3)),ylim=c(0,0.9),main=paste(MAIN,"Education"),cex.axis=1.5,cex.lab=2,cex.main=2)
				text(1:length(tab),tab+0.1,round(tab,2),cex=2,col="blue")

				tab=dist.race
				barplot(tab,col=(heat.colors(length(tab))),ylim=c(0,1.1),main=paste(MAIN,"Race"),cex.axis=1.5,cex.lab=2,cex.main=2)
				text(1:length(tab),tab+0.1,round(tab,2),cex=2,col="blue")

				tab=ref.smk
				barplot(tab,col=rev(heat.colors(length(tab))),ylim=c(0,1),main=paste(MAIN, "Smoking Status"),cex.axis=1.5,cex.lab=2,cex.main=2)
				text(1:length(tab),tab+0.1,round(tab,2),cex=2,col="blue")


				ans=list(dist.race=dist.race, dist.edu=dist.edu, PROBS=PROBS2, PROBS.norm=PROBS3)
				ans



}#end of myPred.race.edu

getProb.race.edu  <- function(coefTab,ref.smk,MAIN=""){
				## given polytomous regression estimation results, this provide probabilties of education-race  (p1,p2,...p12) for given smoking status
				# > coefTab
				#                               Estimate Std. Error     t-value     Pr(>|t|)
				# A-<=high:(intercept)       -3.96767749 0.04424362 -68.9830411 0.000000e+00
				# A-college:(intercept)      -3.48788758 0.05457575 -63.9091078 0.000000e+00
				# A-postcol:(intercept)      -3.35291214 0.05112330 -65.5848151 0.000000e+00
				# B-<=high:(intercept)       -2.57996486 0.04051092 -70.7618578 0.000000e+00
				# B-college:(intercept)      -4.47451395 0.08854534 -50.5335905 0.000000e+00
				# B-postcol:(intercept)      -4.14694055 0.07533214 -55.0487550 0.000000e+00
				# H-<=high:(intercept)       -2.82335311 0.05568112 -63.3821880 0.000000e+00
				# H-college:(intercept)      -4.93987720 0.11150793 -44.3006810 0.000000e+00
				# H-postcol:(intercept)      -4.69959736 0.09898019 -47.4801835 0.000000e+00
				# W-college:(intercept)      -1.67604182 0.01686925 -47.3118367 0.000000e+00
				# W-postcol:(intercept)      -2.77892204 0.01496008 -28.5778278 0.000000e+00
				# A-<=high:cigstat1.Former   -0.23050611 0.05732333  -4.0211571 5.791296e-05
				# A-college:cigstat1.Former  -0.57193090 0.07623703  -7.5020096 6.283862e-14
				# A-postcol:cigstat1.Former  -0.94832165 0.07878926 -12.0361795 0.000000e+00
				# B-<=high:cigstat1.Former    0.01272992 0.05023165   0.2534242 7.999404e-01
				# B-college:cigstat1.Former  -0.53415298 0.12281115  -4.3493852 1.365197e-05
				# B-postcol:cigstat1.Former  -0.57045364 0.10535337  -5.4146694 6.140205e-08
				# H-<=high:cigstat1.Former   -0.03552330 0.06961492  -0.5102829 6.098533e-01
				# H-college:cigstat1.Former  -0.13572922 0.14203655  -0.9555936 3.392776e-01
				# H-postcol:cigstat1.Former  -0.63837331 0.14087276  -4.5315598 5.854976e-06
				# W-college:cigstat1.Former  -0.42260857 0.02226029 -18.9848605 0.000000e+00
				# W-postcol:cigstat1.Former  -0.79238312 0.02084755 -38.0084497 0.000000e+00
				# A-<=high:cigstat2.Current  -0.46851721 0.09320298  -5.0268483 4.986066e-07
				# A-college:cigstat2.Current -0.98558972 0.14184856  -6.9481828 3.700151e-12
				# A-postcol:cigstat2.Current -1.73236670 0.18454523  -9.3872203 0.000000e+00
				# B-<=high:cigstat2.Current   0.83770568 0.05748975  14.5713922 0.000000e+00
				# B-college:cigstat2.Current  0.14300691 0.15079625   0.9483453 3.429537e-01
				# B-postcol:cigstat2.Current -0.71519474 0.17569371  -4.0706906 4.687397e-05
				# H-<=high:cigstat2.Current   0.27649401 0.09106995   3.0360619 2.396902e-03
				# H-college:cigstat2.Current -1.12623089 0.30977524  -3.6356388 2.772926e-04
				# H-postcol:cigstat2.Current -0.96104562 0.25601949  -3.7537986 1.741748e-04
				# W-college:cigstat2.Current -0.74168560 0.03714342 -19.9681560 0.000000e+00
				# W-postcol:cigstat2.Current -1.29261404 0.03869194 -33.4078367 0.000000e+00
				# >
				###### [1] get a prob vector for former an current ####

				cigs = c("Never","Former","Current")

				vnames=row.names(coefTab)
				levs0=grep("intercept",vnames,value=T)
				# 		levs0
				#  [1] "A-<=high:(intercept)"  "A-college:(intercept)" "A-postcol:(intercept)" "B-<=high:(intercept)"  "B-college:(intercept)"
				#  [6] "B-postcol:(intercept)" "H-<=high:(intercept)"  "H-college:(intercept)" "H-postcol:(intercept)" "W-college:(intercept)"
				# [11] "W-postcol:(intercept)"
				levs0 = gsub(":","",levs0)
				levs = gsub("\\(intercept)","",levs0) #[1] "A-<=high"  "A-college" "A-postcol" "B-<=high"  "B-college" "B-postcol" "H-<=high"  "H-college" "H-postcol" "W-college" "W-postcol"

				## calculate exp(b0+b1*x)

				for(i in 1:length(cigs)){

					cig=cigs[i] #"Former

					for(j in 1:length(levs)){

						lev = levs[j] #[1] "A-<=high"
						coefTab[grep(lev,vnames),]
						subcoef=coefTab[grep(lev,vnames),]
						# > subcoef
						#                             Estimate Std. Error    t-value     Pr(>|t|)
						# A-<=high:(intercept)      -3.0520596 0.04424362 -68.983041 0.000000e+00
						# A-<=high:cigstat1.Former  -0.2305061 0.05732333  -4.021157 5.791296e-05
						# A-<=high:cigstat2.Current -0.4685172 0.09320298  -5.026848 4.986066e-07

						coefs=subcoef[,1]
						#     A-<=high:(intercept)  A-<=high:cigstat1.Former A-<=high:cigstat2.Current
						#                -3.0520596                -0.2305061                -0.4685172

						### find coefficient for "Former" other than intercept ##
						coefs2= c(coefs[1], coefs[-1][grep(cig, names(coefs[-1]))])
						coefs2
						#     A-<=high:(intercept) A-<=high:cigstat1.Former
						#               -3.0520596               -0.2305061

						## just intercept for never smokers
						# A-<=high:(intercept)
						#             -3.05206

						## xb = -3.052 - 0.2305*1

						pr=inv.logit(sum(coefs2)) #[1] 0.03617415
						# > inv.logit
						# function(x) exp(x)/(1+exp(x))

						names(pr)=lev

						if(j==1) probs = pr
						if(j>1) probs=c(probs,pr)

					 }#end of for(j in 1:length(levs)){

					 if(i==1) PROBS = probs
					 if(i>1) PROBS=cbind(PROBS,probs)

				}#end of for(i in 1:length(cigs)){

				colnames(PROBS)=cigs

				# > PROBS
				#                 Never      Former     Current
				# A-<=high  0.045128638 0.036174155 0.028732394
				# A-college 0.029658838 0.016959562 0.011278914
				# A-postcol 0.033799932 0.013370632 0.006149116
				# B-<=high  0.053828151 0.054480189 0.116199590
				# B-college 0.011267360 0.006635478 0.012977099
				# B-postcol 0.015566571 0.008859252 0.007674597
				# H-<=high  0.028492963 0.027525937 0.037230082
				# H-college 0.007104640 0.006208510 0.002314815
				# H-postcol 0.009016896 0.004782629 0.003468208
				# W-college 0.310428850 0.227809114 0.176564241
				# W-postcol 0.394717143 0.227952362 0.151853067

	####### THIS IS WRONG
	print("Reference probability calculation formula is WRONG")
	PROBS2=rbind(PROBS,W.high=1-colSums(PROBS))
				row.names(PROBS2)[nrow(PROBS2)]="W-<=high"
				# > PROBS2
				#                 Never      Former     Current
				# A-<=high  0.045128638 0.036174155 0.028732394
				# A-college 0.029658838 0.016959562 0.011278914
				# A-postcol 0.033799932 0.013370632 0.006149116
				# B-<=high  0.053828151 0.054480189 0.116199590
				# B-college 0.011267360 0.006635478 0.012977099
				# B-postcol 0.015566571 0.008859252 0.007674597
				# H-<=high  0.028492963 0.027525937 0.037230082
				# H-college 0.007104640 0.006208510 0.002314815
				# H-postcol 0.009016896 0.004782629 0.003468208
				# W-college 0.310428850 0.227809114 0.176564241
				# W-postcol 0.394717143 0.227952362 0.151853067
				# W-<=high  0.060990020 0.369242180 0.445557876

				# > sum(PROBS2)
				# [1] 3


				################# Weight on never, former, current smokers to get no-marginal probabilities ####

				## calculate asian proportion ##
				# > tb.smk
				# smkstatus
				#   Never  Former Current
				# 0.36609 0.40116 0.23275

			    #ref.smk = c(0.37, 0.40, 0.23); names(ref.smk)=c("Never","Former","Current")
				#   Never  Former Current
				#    0.37    0.40    0.23
				#### making total matrix sum = 1 (currently the sum is 3)

	##### reference smoking distribution is used for 1950 birth cohort ###################

	PROBS3= PROBS2
	PROBS3[,1] = PROBS2[,1]*ref.smk[1] # 0.37
	PROBS3[,2] = PROBS2[,2]*ref.smk[2] # 0.40
	PROBS3[,3] = PROBS2[,3]*ref.smk[3] # 0.23
				# > PROBS3 (each column sums up to 1)
				#                 Never      Former      Current
				# A-<=high  0.016697596 0.014469662 0.0066084507
				# A-college 0.010973770 0.006783825 0.0025941503
				# A-postcol 0.012505975 0.005348253 0.0014142967
				# B-<=high  0.019916416 0.021792076 0.0267259057
				# B-college 0.004168923 0.002654191 0.0029847328
				# B-postcol 0.005759631 0.003543701 0.0017651573
				# H-<=high  0.010542396 0.011010375 0.0085629188
				# H-college 0.002628717 0.002483404 0.0005324074
				# H-postcol 0.003336251 0.001913052 0.0007976879
				# W-college 0.114858674 0.091123646 0.0406097755
				# W-postcol 0.146045343 0.091180945 0.0349262053
				# W-<=high  0.022566308 0.147696872 0.1024783116
				# > sum(PROBS3)
				# [1] 1

				## race dist ##
				racenames=c("W","B","H","A")
				tt=rowSums(PROBS3)
				#    A-<=high   A-college   A-postcol    B-<=high   B-college   B-postcol    H-<=high   H-college   H-postcol   W-college
				# 0.037775709 0.020351745 0.019268524 0.068434397 0.009807847 0.011068489 0.030115690 0.005644528 0.006046991 0.246592096
				#   W-postcol    W-<=high
				# 0.272152493 0.272741491
				for(j in 1:length(racenames)){
					rc=racenames[j]
					pb=sum(tt[grep(rc,names(tt))])
					names(pb)=rc
					if(j==1) out=pb
					if(j>1) out=c(out,pb)
			    }#end of j loop

			    dist.race= out
				#          W          B          H          A
				# 0.79148608 0.08931073 0.04180721 0.07739598

				## from reference:
				#  W    B     H    A
				# 0.76 0.10 0.08 0.05


				### education dist ####
				edunames=c("high","college","postcol")
				tt=rowSums(PROBS3)
				#    A-<=high   A-college   A-postcol    B-<=high   B-college   B-postcol    H-<=high   H-college   H-postcol   W-college
				# 0.037775709 0.020351745 0.019268524 0.068434397 0.009807847 0.011068489 0.030115690 0.005644528 0.006046991 0.246592096
				#   W-postcol    W-<=high
				# 0.272152493 0.272741491

				for(j in 1:length(edunames)){
					ed=edunames[j]
					pb=sum(tt[grep(ed,names(tt))])
					names(pb)=ed
					if(j==1) out=pb
					if(j>1) out=c(out,pb)
			    }#end of j loop

			    dist.edu= out
				#      high   college   postcol
				# 0.4090673 0.2823962 0.3085365

				### from reference ##
				#      high   college   postcol
				#      0.78     0.15    0.07


				####### plots #####

				tab=dist.edu

				barplot(tab,col=(heat.colors(3)),ylim=c(0,0.9),main=paste(MAIN,"Education"),cex.axis=1.5,cex.lab=2,cex.main=2)
				text(1:length(tab),tab+0.1,round(tab,2),cex=2,col="blue")

				tab=dist.race
				barplot(tab,col=(heat.colors(length(tab))),ylim=c(0,1.1),main=paste(MAIN,"Race"),cex.axis=1.5,cex.lab=2,cex.main=2)
				text(1:length(tab),tab+0.1,round(tab,2),cex=2,col="blue")

				tab=ref.smk
				barplot(tab,col=rev(heat.colors(length(tab))),ylim=c(0,1),main=paste(MAIN, "Smoking Status"),cex.axis=1.5,cex.lab=2,cex.main=2)
				text(1:length(tab),tab+0.1,round(tab,2),cex=2,col="blue")


				ans=list(dist.race=dist.race, dist.edu=dist.edu, PROBS=PROBS2, PROBS.norm=PROBS3)
				ans



}#end of myPred.race.edu



identifyPch <- function(x, y = NULL, n = length(x), pch = "*", col="red",cex=2,...)
{
     xy <- xy.coords(x, y); x <- xy$x; y <- xy$y
     sel <- rep(FALSE, length(x)); res <- integer(0)
     while(sum(sel) < n) {
         ans <- identify(x[!sel], y[!sel], n = 1, plot = FALSE, ...)
         if(!length(ans)) break
         ans <- which(!sel)[ans]
         points(x[ans], y[ans], pch = pch,col=col,cex=cex)
         sel[ans] <- TRUE
         res <- c(res, ans)
     }
     res
 }


inv.logit <- function(x) exp(x)/(1+exp(x))



############ 3/3/2016: personal history of cancer and validation, calibration, validation, etc ##########################

myEdu.Race.givneSmoking2=function(mydat, ref.smk, ref.race,  ref.edu, Gender, doSelectionValidate=F){   ## produce conditional distribution of education-race given smoking status

		## this is needed to calculate the marginal distribution below ##
		#ref.smk = c(0.37, 0.40, 0.23); names(ref.smk)=c("Never","Former","Current")
		#   Never  Former Current
		#    0.37    0.40    0.23

		## these will be used as reference for calibration
		## these are from literature ##

		# > ref.race
		#    W    B    H    A
		# 0.76 0.10 0.08 0.05
		# > ref.edu
		#    high college postcol
		#    0.78    0.15    0.07

		#####################[0] Define variables ################################################

		##### (1) define smoking status ###########
				# prevalence data: http://en.wikipedia.org/wiki/Prevalence_of_tobacco_consumption
				cigstat=mydat[,"cig_stat"]
				# > table(cigstat)
				# cig_stat

				#     0     1     2     A     F     M     #A is ambiguous -- will put in former then
				# 26917  8659 38256     1  2826    23

				# .A="Ambiguous"
				# .F="No Form"
				# .M="Not Answered"
				# 0="Never Smoked Cigarettes"
				# 1="Current Cigarette Smoker"
				# 2="Former Cigarette Smoker"

				tb.cig=table(cigstat)
				round(tb.cig/sum(tb.cig),2)
				# cigstat
				#    0    1    2
				# 0.37 0.12 0.51

				cigstat2=cigstat
				cigstat2[cigstat=="0"]="Never"
				cigstat2[cigstat=="1"]="Current"
				cigstat2[cigstat=="2"]="Former"
				cigstat2[cigstat=="A"]= NA
				cigstat2[cigstat=="F"]= NA
				cigstat2[cigstat=="M"]= NA
						# > table(cigstat2)
						# cigstat2
						# Current  Former   Never
						#    8659   38256   26917

				# for polytomous ##
				cigstat3=cigstat2
				cigstat3[cigstat==0]="0.Never"
				cigstat3[cigstat==1]="2.Current"
				cigstat3[cigstat==2]="1.Former"

					# > table(cigstat3)
					# cigstat3
					#   0.Never  1.Former 2.Current
					#     26917     38256      8659


		ix.na.smk = is.na(cigstat2)==T
		# > sum(ix.na.smk)
		# [1] 2850   ---> need to exclude them


		#### (2) education ########################
		#educat #Education
				# Question 3
				# .F="No Form" .M="Missing"
				# 1="Less than 8 years" 2="8-11 years"
				# 3="12 years or completed high school" 4="Post high school training other than college"
				# 5="Some college"
				# 6="College graduate" 7="Postgraduate"

				edu0=mydat[,"educat"]
				table(edu0)
				# edu0
				#     1     2     3     4     5     6     7     F     M
				#   923  5172 13484  9048 15067 13912 16037  2826   213

				# not finished highschool - highschool graduate -college graduate - postgraduate
				#   (1,2)                        (3,4,5)                 6                7

				edu=edu0
				#edu[edu0==1 | edu0==2]=1
				edu[edu0 <=5 ]=1
				edu[edu0==6]=2
				edu[edu0==7]=3
				edu[edu0=="M" | edu0=="F"]=NA

						tb.edu=table(edu)/sum(table(edu))
						tb.edu
						# edu
						#         1         2         3
						# 0.7016927 0.1504578 0.1478495
						# > table(edu)
						# edu
						#     1     2     3
						# 43694 13912 16037

	            ## factor variable ##
				edu2=edu
				edu2[edu==1]="<=high"
				edu2[edu==2]="college"
				edu2[edu==3]="postcol"
				tb.edu2=table(edu2)/sum(table(edu2))
				tb.edu2
				# edu2
				#    <=high   college   postcol
				# 0.7016927 0.1504578 0.1478495

						doThis=F
						if(doThis==T){
							edu=edu0
							edu[edu0==1 | edu0==2]=1
							edu[edu0==3 | edu0==4 | edu0==5]=2
							edu[edu0==6]=3
							edu[edu0==7]=4
							edu[edu0=="M"]=NA

							tb.edu=table(edu)
							# edu
							#     1     2     3     4
							#  5914 37002 13757 15862
							# > round(tb.edu/sum(tb.edu),3)
							# edu
							#     1     2     3     4
							# 0.082 0.510 0.190 0.219

							edu2=edu
							edu2[edu==1]="<high"
							edu2[edu==2]="high"
							edu2[edu==3]="college"
							edu2[edu==4]="postcol"

						}#



		####### (3) race #############
				# 1="White, Non-Hispanic" 2="Black, Non-Hispanic" 3="Hispanic"
				# 4="Asian"
				# 5="Pacific Islander" 6="American Indian" 7="Missing"

				# 1="White, Non-Hispanic"
				# 2="Black, Non-Hispanic"
				# 3="Hispanic"
				# 4="Asian"
				# 5="Pacific Islander"
				# 6="American Indian"
				# 7="Missing"
				race0=mydat[,"race7"]
					table(race0)
					# race0
					#     1     2     3     4     5     6     7
					# 64222  3273  1569  2957   452   185    38
					#
					#     1     2     3     4     5     6     7
					# 65178  3370  1603  3009   464   187  2871
					#
				## merge 4-7
				# "white" - "black" - "hispanic" - "asian"
				race=race0
				race[race0>4]=NA
						tb.race=table(race)
						tb.race
						# race
						#     1     2     3     4
						# 64222  3273  1569  3632
						round(tb.race/sum(tb.race),2)
						# race
						# race
						#    1    2    3    4
						# 0.89 0.05 0.02 0.04
				race2=race
				race2[race==1]="W"
				race2[race==2]="B"
				race2[race==3]="H"
				race2[race==4]="A"
					#table(race2)
					#     A     B     H     W
					#  3009  3370  1603 65178
	   #### (4) define "Edu-race" variable #############


				race.edu=paste(race2,edu2,sep="-") #[1] "W-<=high"   "NA-college" "W-<=high"   "W-college"  "W-college"
				race.edu[is.na(race2) | is.na(edu2)] = NA
				race.edu=as.factor(as.character(race.edu))


		#### (5) plot distributions of cigstat, education and race (joint, marginal and conditional etc) ###

			#setwd(outdir)
			#plotfile1=paste("Plot_smoking.race.edu",Gender,"pdf",sep=".")
			#pdf(plotfile1)

					TAB=table(cigstat2)/sum(table(cigstat2))
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,0.9),main="(PLCO) Smoking Status",cex.axis=1.5,cex.lab=2)
					text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")

					TAB=table(race2)/sum(table(race2))
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,1.1),main="(PLCO) Race",cex.axis=1.5,cex.lab=2)
					text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")

					TAB=table(edu2)/sum(table(edu2))
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,0.9),main="(PLCO) Education",cex.axis=1.5,cex.lab=2)
					text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")


		      	   ######## Plot joint distribution of education (y-axis) and race (x-axis) given smoking status #######

					name.edu=c("<=high","college","postcol")
					name.race=c("W","B","H","A")
					#library(lattice)
					plot.new()

					u.cig= unique(cigstat2)[is.na(unique(cigstat2))==F]
					 #[1] "Never"   "Former"  "Current"

					dist1 = rep(list(list()),3)
					names(dist1)=u.cig

					for(j in 1:length(u.cig)){

						   ci=u.cig[j] #"Never"
						   tb=table(race2[cigstat2==ci],edu2[cigstat2==ci])
						   print(ci)
						   tb2=round(tb/sum(tb),3)
						   tb2=tb2[name.race,name.edu]
						   tb2
							#               W     B     H     A
							#   <=high  0.426 0.024 0.013 0.020
							#   college 0.192 0.005 0.003 0.013
							#   postcol 0.278 0.007 0.004 0.015

							color <- function(x)rev(heat.colors(x))
							print(levelplot(tb2,col.regions=color(256),main=ci,xlab="Race",ylab="Education"))
							#points(1:10,1:10)

						   ### write down probabiity number in each cell in the plot: a bit tricky ###
							xx2=tb2
							#putNum=function(xx){

							#     <high  high college postcol
							#   W 0.042 0.384   0.192   0.278
							#   B 0.005 0.019   0.005   0.007
							#   H 0.004 0.009   0.003   0.004
							#   A 0.002 0.018   0.013   0.015

							# > xx2
							#
							#               W     B     H     A
							#   <high   0.042 0.005 0.004 0.002
							#   high    0.384 0.019 0.009 0.018
							#   college 0.192 0.005 0.003 0.013
							#   postcol 0.278 0.007 0.004 0.015

							#xxx = seq(2,ncol(xx2)*2,by=2)
							#yyy = seq(2,nrow(xx2)*2,by=2)
							nCol=nrow(xx2)
							nRow=ncol(xx2)

							xxx0=seq(0,1,length.out=nCol+1.1)
							xxx=xxx0[-c(1,length(xxx0))]

							yyy0=seq(0,1,length.out=nRow+1.1)
							yyy=yyy0[-c(1,length(yyy0))]


							for(m in 1:nrow(xx2)){    text(rep(xxx[m],nRow), yyy,xx2[m,])  }
							#}# putNum=function(xx){
							#putNum(xx=tb2)

							dist1[[j]]=tb2

					}# for(j in 1:length(u.cig)){



					### plotting marginal distribution by education and race for each smoking status ####


					for(j in 1:length(u.cig)){

					   ci=u.cig[j] #"Never"
					   tb=table(race2[cigstat2==ci],edu2[cigstat2==ci])
					   print(ci)
					   tb2=round(tb/sum(tb),3)
					   tb2=tb2[name.race,name.edu]
					   tb2

						barplot(rowSums(tb2),ylim=c(0,1.1),col=heat.colors(4),xlab="Race",ylab="Probability",main=ci,cex.axis=1.5,cex.lab=1.5)
						text(1:length(rowSums(tb2)),rowSums(tb2)+0.1,rowSums(tb2),cex=1.5,col="blue")
						barplot(colSums(tb2),ylim=c(0,1.1),col=heat.colors(3),xlab="Education",ylab="Probability",main=ci,cex.axis=1.5,cex.lab=1.5)
						text(1:length(colSums(tb2)),colSums(tb2)+0.1,colSums(tb2),cex=1.5,col="blue")

					}#end of for(j in 1:length(u.cig)){


	   ###### [0] Split into two arms (CXR: training set,  UCR:  validation set) ###################

	   			race.edu = relevel(race.edu,ref="W-<=high")

	   			mydatall = data.frame(race.edu=race.edu,cigstat=cigstat3)
				# > mydatall[1:3,]
				#    race.edu  cigstat
				# 1  B-<=high  0.Never
				# 2 W-postcol 1.Former
				# 3  W-<=high 1.Former



	   			#mydat2 = cbind(mydat, race.edu = as.factor(as.character(race.edu)), cigstat=cigstat3)
      			ix.na.smk = is.na(cigstat3)==T
					sum(ix.na.smk)
					#[1] 2850
				ix.cxr = mydat[,"arm"]==1  # chest xray ram
					table(mydat[,"arm"])
					#
					#     1     2
					# 38340 38342
					# > sum(ix.cxr)
					# [1] 38340
					length(ix.cxr)==length(ix.na.smk)
					# [1] TRUE


	   			### training data ##########

	   			mydat.tr = mydatall[ix.na.smk==F & ix.cxr==T,]
					dim(mydat.tr)
					# [1] 37436   434

				### validation data #########

				mydat.val = mydatall[ix.na.smk==F & ix.cxr==F,]

					dim(mydat.val)
					# [1] 36396   434

				#mydata=data.frame(race.edu = as.factor(race.edu), cigstat=cigstat3)
				# > dim(mydata)
				# [1] 73832     2
				# > mydata[1:3,]
				#    race.edu  cigstat
				# 1  B-<=high  0.Never
				# 2 W-postcol 1.Former
				# 3  W-<=high 1.Former



	   ################ [1] Full model fitting #####################################################

				MYDATA = mydat.tr

				#library(nnet)

				fit1=multinom(race.edu ~ cigstat, data=MYDATA)
				# Call:
				# multinom(formula = race.edu ~ cigstat, data = MYDATA)
				#
				# Coefficients:
				#           (Intercept) cigstat1.Former cigstat2.Current
				# A-<=high   -3.0382031    -0.226036721       -0.4128965
				# A-college  -3.4783951    -0.584020391       -1.0239492
				# A-postcol  -3.3875397    -0.884202718       -1.7737443
				# B-<=high   -2.8817706     0.079000752        0.8466538
				# B-college  -4.6402295    -0.311557777        0.3255409
				# B-postcol  -4.1768265    -0.433169959       -0.4329744
				# H-<=high   -3.5353860     0.008435181        0.2298509
				# H-college  -5.0545174     0.075962647       -0.8682664
				# H-postcol  -4.6402558    -0.710793813       -1.1504710
				# W-college  -0.8011817    -0.422245131       -0.7732763
				# W-postcol  -0.4203108    -0.792457171       -1.2054204
				#
				# Residual Deviance: 103387.9
				# AIC: 103453.9

				### This is for R2 or other goodness-of-fit statistic: I actually did not use this for later: this is for confirmation
				### different package, but the same results, I confirmed ###
				#library(mlogit)

				#mydata=data.frame(race.edu = as.factor(race.edu), cigstat=cigstat3)

				#mydata$brand<-as.factor(mydata$brand)
				mldata<-mlogit.data(MYDATA, varying=NULL, choice="race.edu", shape="wide")
				mldata[1:10,]
				# > mldata[1:10,]
				#             race.edu cigstat chid       alt
				# 1.A-<=high     FALSE   Never    1  A-<=high
				# 1.A-college    FALSE   Never    1 A-college
				# 1.A-postcol    FALSE   Never    1 A-postcol
				# 1.B-<=high     FALSE   Never    1  B-<=high
				# 1.B-college    FALSE   Never    1 B-college
				# 1.B-postcol    FALSE   Never    1 B-postcol
				# 1.H-<=high     FALSE   Never    1  H-<=high
				# 1.H-college    FALSE   Never    1 H-college


				print("Fitting a polytomous regression")

				lm00 <- mlogit(race.edu~1|cigstat, data = mldata, reflevel="W-<=high") # "W-<=high" is reference
				summary(lm00)
					# Call:
					# mlogit(formula = race.edu ~ 1 | cigstat, data = mldata, reflevel = "W-<=high",
					#     method = "nr", print.level = 0)
					#
					# Frequencies of alternatives:
					#  W-<=high  A-<=high A-college A-postcol  B-<=high B-college B-postcol  H-<=high H-college H-postcol W-college W-postcol
					# 0.5174108 0.0208390 0.0106084 0.0097446 0.0356044 0.0045079 0.0059925 0.0156832 0.0031852 0.0031042 0.1702748 0.2030449
					#
					# nr method
					# 14 iterations, 0h:1m:2s
					# g'(-H)^-1g = 7.42E-08
					# gradient close to zero
					#
					# Coefficients :
					#                              Estimate Std. Error  t-value  Pr(>|t|)
					# A-<=high:(intercept)       -3.0379921  0.0613965 -49.4815 < 2.2e-16 ***
					# A-college:(intercept)      -3.4782274  0.0758881 -45.8336 < 2.2e-16 ***
					# A-postcol:(intercept)      -3.3874985  0.0726254 -46.6434 < 2.2e-16 ***
					# B-<=high:(intercept)       -2.8817880  0.0570030 -50.5551 < 2.2e-16 ***
					# B-college:(intercept)      -4.6402615  0.1342742 -34.5581 < 2.2e-16 ***
					# B-postcol:(intercept)      -4.1769768  0.1068100 -39.1066 < 2.2e-16 ***
					# H-<=high:(intercept)       -3.5357145  0.0780357 -45.3089 < 2.2e-16 ***
					# H-college:(intercept)      -5.0546953  0.1649225 -30.6489 < 2.2e-16 ***
					# H-postcol:(intercept)      -4.6402615  0.1342742 -34.5581 < 2.2e-16 ***
					# W-college:(intercept)      -0.8011933  0.0235921 -33.9603 < 2.2e-16 ***
					# W-postcol:(intercept)      -0.4202287  0.0208538 -20.1512 < 2.2e-16 ***
					# A-<=high:cigstat1.Former   -0.2261688  0.0793451  -2.8504 0.0043658 **
					# A-college:cigstat1.Former  -0.5841708  0.1061010  -5.5058 3.675e-08 ***
					# A-postcol:cigstat1.Former  -0.8846202  0.1097002  -8.0640 6.661e-16 ***
					# B-<=high:cigstat1.Former    0.0790785  0.0698290   1.1325 0.2574415
					# B-college:cigstat1.Former  -0.3117592  0.1768628  -1.7627 0.0779482 .
					# B-postcol:cigstat1.Former  -0.4329484  0.1443855  -2.9986 0.0027126 **
					# H-<=high:cigstat1.Former    0.0087026  0.0966806   0.0900 0.9282758
					# H-college:cigstat1.Former   0.0760063  0.2020049   0.3763 0.7067237
					# H-postcol:cigstat1.Former  -0.7106669  0.1942432  -3.6586 0.0002536 ***
					# W-college:cigstat1.Former  -0.4222845  0.0310766 -13.5885 < 2.2e-16 ***
					# W-postcol:cigstat1.Former  -0.7925572  0.0289946 -27.3346 < 2.2e-16 ***
					# A-<=high:cigstat2.Current  -0.4129512  0.1272786  -3.2445 0.0011767 **
					# A-college:cigstat2.Current -1.0242607  0.2015537  -5.0818 3.738e-07 ***
					# A-postcol:cigstat2.Current -1.7742352  0.2689298  -6.5974 4.185e-11 ***
					# B-<=high:cigstat2.Current   0.8468148  0.0809656  10.4589 < 2.2e-16 ***
					# B-college:cigstat2.Current  0.3258257  0.2167559   1.5032 0.1327895
					# B-postcol:cigstat2.Current -0.4347105  0.2241696  -1.9392 0.0524766 .
					# H-<=high:cigstat2.Current   0.2302788  0.1299552   1.7720 0.0763969 .
					# H-college:cigstat2.Current -0.8691785  0.4128422  -2.1054 0.0352606 *
					# H-postcol:cigstat2.Current -1.1500809  0.3786973  -3.0369 0.0023899 **
					# W-college:cigstat2.Current -0.7733246  0.0527610 -14.6571 < 2.2e-16 ***
					# W-postcol:cigstat2.Current -1.2053883  0.0525238 -22.9494 < 2.2e-16 ***
					# ---
					# Signif. codes:  0 *** 0.001 ** 0.01 * 0.05 . 0.1   1
					#
					# Log-Likelihood: -51694
					# McFadden R^2:  0.014055
					# Likelihood ratio test : chisq = 1473.9 (p.value = < 2.22e-16)
				coef.race.edu=summary(lm00)$CoefTable
					# > coef.race.edu
					#                               Estimate Std. Error     t-value     Pr(>|t|)
					# A-<=high:(intercept)       -3.05205960 0.04424362 -68.9830411 0.000000e+00
					# A-college:(intercept)      -3.48788758 0.05457575 -63.9091078 0.000000e+00
					# A-postcol:(intercept)      -3.35291214 0.05112330 -65.5848151 0.000000e+00
					# B-<=high:(intercept)       -2.86662763 0.04051092 -70.7618578 0.000000e+00
					# B-college:(intercept)      -4.47451395 0.08854534 -50.5335905 0.000000e+00
					# B-postcol:(intercept)      -4.14694055 0.07533214 -55.0487550 0.000000e+00
					# H-<=high:(intercept)       -3.52919138 0.05568112 -63.3821880 0.000000e+00
				or.race.edu=myOR.CI4(coef.race.edu,bName="Estimate",sName="Std. Error",pName="Pr(>|t|)",zName="t-value",pval=T)
				row.names(or.race.edu)=row.names(coef.race.edu)
					#or.race.edu
					# > or.race.edu
					#                              OR  CI1  CI2   beta    sd        pval2      Z
					# A-<=high:(intercept)       0.05 0.04 0.05 -3.052 0.044 0.000000e+00 -68.98
					# A-college:(intercept)      0.03 0.03 0.03 -3.488 0.055 0.000000e+00 -63.91
					# A-postcol:(intercept)      0.03 0.03 0.04 -3.353 0.051 0.000000e+00 -65.58
					# B-<=high:(intercept)       0.06 0.05 0.06 -2.867 0.041 0.000000e+00 -70.76
					# B-college:(intercept)      0.01 0.01 0.01 -4.475 0.089 0.000000e+00 -50.53
					# B-postcol:(intercept)      0.02 0.01 0.02 -4.147 0.075 0.000000e+00 -55.05
					# H-<=high:(intercept)       0.03 0.03 0.03 -3.529 0.056 0.000000e+00 -63.38
					# H-college:(intercept)      0.01 0.01 0.01 -4.940 0.112 0.000000e+00 -44.30


	doSelectionValidate=F

	if(doSelectionValidate==T){

	   ################ [2] Variable selection: just race.edu ~ smoking: I am doing this to see if smk is still chosen  #####################################################

				stp= step(fit1)
				print("stepwise selection")
				print(stp)
				# Start:  AIC=103453.9
				# race.edu ~ cigstat
				#
				# trying - cigstat
				# # weights:  24 (11 variable)
				# initial  value 92055.851748
				# iter  10 value 59575.214182
				# iter  20 value 52431.248705
				# final  value 52430.854553
				# converged
				#           Df      AIC
				# <none>    33 103453.9 <if nothing is excluded from this full model, AIC the best>
				# - cigstat 11 104883.7 <if cigstat is excluded AIC becomes too high nope!>
				# >
				# > summary(stp)
				# Call:
				# multinom(formula = race.edu ~ cigstat, data = MYDATA)
				#
				# Coefficients:
				#           (Intercept) cigstat1.Former cigstat2.Current
				# A-<=high   -3.0382031    -0.226036721       -0.4128965
				# A-college  -3.4783951    -0.584020391       -1.0239492
				# A-postcol  -3.3875397    -0.884202718       -1.7737443
				# B-<=high   -2.8817706     0.079000752        0.8466538
				# B-college  -4.6402295    -0.311557777        0.3255409
				# B-postcol  -4.1768265    -0.433169959       -0.4329744
				# H-<=high   -3.5353860     0.008435181        0.2298509
				# H-college  -5.0545174     0.075962647       -0.8682664
				# H-postcol  -4.6402558    -0.710793813       -1.1504710
				# W-college  -0.8011817    -0.422245131       -0.7732763
				# W-postcol  -0.4203108    -0.792457171       -1.2054204
				#
				# Std. Errors:
				#           (Intercept) cigstat1.Former cigstat2.Current
				# A-<=high   0.06140206      0.07935074       0.12728819
				# A-college  0.07589346      0.10610560       0.20154254
				# A-postcol  0.07262609      0.10968958       0.26887302
				# B-<=high   0.05700186      0.06982895       0.08096724
				# B-college  0.13427059      0.17685189       0.21676964
				# B-postcol  0.10680090      0.14438152       0.22400273
				# H-<=high   0.07802242      0.09666910       0.12995080
				# H-college  0.16490616      0.20198743       0.41264546
				# H-postcol  0.13427235      0.19424865       0.37875853
				# W-college  0.02359172      0.03107617       0.05275957
				# W-postcol  0.02085409      0.02899483       0.05252577
				#
				# Residual Deviance: 103387.9
				# AIC: 103453.9

				### run step on mlogit output

				extractAIC.mlogit <- function (fit, scale = 0, k = 2, ...) {
					n <- length(fit$residuals)
					edf <- length(fit$coefficients)
					aic <- (-2 * fit$logLik) + k + edf
					c(edf, aic + (k - 2) * edf)
				}

				extractAIC.or=extractAIC
				extractAIC = extractAIC.mlogit


				#step(lm00)


	   ################ [3] Variable selection 2: Bayesian Model Averaging #####################################################

				################ variable selection using bayesian model averaging method (BMA) ############
				############# try to see the posterior probability of race using mBMA package ##############

	   			#library(mlogitBMA)

	   			MYDATA2=na.omit(MYDATA)

	   			## changed the level to numeric ##
	   			levels(MYDATA2$race.edu) = 1:length(levels(MYDATA2$race.edu))
				# > table(MYDATA2[,"race.edu"])
				#
				#     1     2     3     4     5     6     7     8     9    10    11    12
				# 19168   772   393   361  1319   167   222   581   118   115  6308  7522

	   			print("BMA selection")
	   			fitb = bic.mlogit( race.edu ~ cigstat, data=MYDATA2)#
	   			summary(fitb)
	   			print(summary(fitb))
				# Call:
				# bic.mlogit(f = race.edu ~ cigstat, data = MYDATA2)
				#
				#
				#   1  models were selected
				#  Best  1  models (cumulative posterior probability =  1 ):
				#
				#               p!=0   EV       SD       model 1
				# Intercept     100    2.15791  0.03612   2.158e+00
				# Intercept.1   100    3.25223  0.04220   3.252e+00
				# Intercept.7   100   -1.28782  0.07950  -1.288e+00
				# Intercept.4   100   -0.82984  0.06764  -8.298e-01
				# Intercept.6   100   -1.56143  0.08838  -1.561e+00
				# Intercept.11  100    2.03795  0.04331   2.038e+00
				# Intercept.3   100   -0.72993  0.06593  -7.299e-01
				# Intercept.8   100   -0.29278  0.05932  -2.928e-01
				# Intercept.2   100   -0.03272  0.05550  -3.272e-02
				# Intercept.9   100   -1.91938  0.10147  -1.919e+00
				# Intercept.10  100   -1.95311  0.10256  -1.953e+00
				# cigstat       100
				#        .            -0.48879  0.03174  -4.888e-01
				#
				# nVar                                      11
				# BIC                                     3.040e+05
				# post prob                               1
				#
				# MNL specification:
				# ==================
				# Response variable: race.edu
				# Base choice name: 5
				# Base choice index: 1
				# Frequency of alternatives:
				#     5    12     1     7     4     6    11     3     8     2     9    10
				#  1319  7522 19168   222   361   167  6308   393   581   772   118   115
				#
				# Equations:
				# ----------
				#    alternative intercept         1
				# 1           5:
				# 2          12:    asc.12 + cigstat
				# 3           1:     asc.1 + cigstat
				# 4           7:     asc.7 + cigstat
				# 5           4:     asc.4 + cigstat
				# 6           6:     asc.6 + cigstat
				# 7          11:    asc.11 + cigstat
				# 8           3:     asc.3 + cigstat
				# 9           8:     asc.8 + cigstat
				# 10          2:     asc.2 + cigstat
				# 11          9:     asc.9 + cigstat
				# 12         10:    asc.10 + cigstat

	   ################ [4] Apparent validation using training data: evaluating performance (various metrics, e.g. brier, calibration, c-index)  #####################################################

				### McFadden R-square and Likelihood ratio test for chis-square (goodnenes of fit)
				summary(lm00)
				#
				# Call:
				# mlogit(formula = race.edu ~ 1 | cigstat, data = mldata, reflevel = "W-<=high",
				#     method = "nr", print.level = 0)
				#
				# Frequencies of alternatives:
				#  W-<=high  A-<=high A-college A-postcol  B-<=high B-college B-postcol  H-<=high H-college H-postcol W-college W-postcol
				# 0.5174108 0.0208390 0.0106084 0.0097446 0.0356044 0.0045079 0.0059925 0.0156832 0.0031852 0.0031042 0.1702748 0.2030449
				#
				# nr method
				# 14 iterations, 0h:0m:57s
				# g'(-H)^-1g = 7.42E-08
				# gradient close to zero
				#
				# Coefficients :
				#                              Estimate Std. Error  t-value  Pr(>|t|)
				# A-<=high:(intercept)       -3.0379921  0.0613965 -49.4815 < 2.2e-16 ***
				# A-college:(intercept)      -3.4782274  0.0758881 -45.8336 < 2.2e-16 ***
				# A-postcol:(intercept)      -3.3874985  0.0726254 -46.6434 < 2.2e-16 ***
				# B-<=high:(intercept)       -2.8817880  0.0570030 -50.5551 < 2.2e-16 ***
				# ---
				# Signif. codes:  0 *** 0.001 ** 0.01 * 0.05 . 0.1   1
				#
				# Log-Likelihood: -51694
				# McFadden R^2:  0.014055
				# Likelihood ratio test : chisq = 1473.9 (p.value = < 2.22e-16)

	   ################ [5] cross validation for classification error  #####################################################

				# R code from "R_package_ipred_multinom_model-selection.pdf"

				#library(ipred)
				mypredict.multinom <- function(object, newdata) as.factor(predict(object, newdata, type="class"))

						### well.. it assign the category with the largest probability...
						## I had this issue before for case-control simulation when prevalence is too low
						## If you follow this, you will end up having only one category
						## I am going to use sample() function to predict given distribution and use it
						## as predict() (my customized predict function)

						tt=predict(fit1, newdata=MYDATA, type="class")
						# tt
						#  W-<=high  A-<=high A-college A-postcol  B-<=high B-college B-postcol  H-<=high H-college H-postcol W-college W-postcol
						#     37436         0         0         0         0         0         0         0         0         0         0         0

						tt1=predict(fit1, newdata=MYDATA, type="probs")
						# > tt1b=cbind(MYDATA,tt1)[1:10,]
						#     race.edu   cigstat  W-<=high   A-<=high   A-college   A-postcol   B-<=high   B-college   B-postcol   H-<=high   H-college   H-postcol W-college W-postcol
						# 1   B-<=high   0.Never 0.4265426 0.02044031 0.013161780 0.014413605 0.02390151 0.004118474 0.006546206 0.01243265 0.002721532 0.004118366 0.1914316 0.2801714
						# 2  W-postcol  1.Former 0.5619019 0.02147925 0.009668873 0.007842713 0.03407478 0.003973074 0.005591965 0.01651677 0.003868135 0.002665196 0.1653229 0.1670945
						# 4   W-<=high  1.Former 0.5619019 0.02147925 0.009668873 0.007842713 0.03407478 0.003973074 0.005591965 0.01651677 0.003868135 0.002665196 0.1653229 0.1670945
						# 5  W-postcol   0.Never 0.4265426 0.02044031 0.013161780 0.014413605 0.02390151 0.004118474 0.006546206 0.01243265 0.002721532 0.004118366 0.1914316 0.2801714
						# 6   W-<=high 2.Current 0.6064949 0.01923241 0.006721774 0.003477843 0.07924779 0.008109270 0.006036929 0.02224598 0.001624033 0.001853303 0.1256171 0.1193386
						# 7  B-postcol  1.Former 0.5619019 0.02147925 0.009668873 0.007842713 0.03407478 0.003973074 0.005591965 0.01651677 0.003868135 0.002665196 0.1653229 0.1670945
						# 10  W-<=high   0.Never 0.4265426 0.02044031 0.013161780 0.014413605 0.02390151 0.004118474 0.006546206 0.01243265 0.002721532 0.004118366 0.1914316 0.2801714
						# 11 A-postcol   0.Never 0.4265426 0.02044031 0.013161780 0.014413605 0.02390151 0.004118474 0.006546206 0.01243265 0.002721532 0.004118366 0.1914316 0.2801714
						# 12 W-postcol  1.Former 0.5619019 0.02147925 0.009668873 0.007842713 0.03407478 0.003973074 0.005591965 0.01651677 0.003868135 0.002665196 0.1653229 0.1670945
						# 13 B-college   0.Never 0.4265426 0.02044031 0.013161780 0.014413605 0.02390151 0.004118474 0.006546206 0.01243265 0.002721532 0.004118366 0.1914316 0.2801714

						#x=tt1[1,]
						myPredict.sm <- function(x) sample(names(x), 1,prob=x,replace=F)
						#tt2=apply(tt1,1, myPredict.sm)
						# > tt2[1:3]
						#           1           2           4
						#  "W-<=high" "W-postcol"  "B-<=high"

				myPredict.multinom.sample <- function(object, newdata){

						ans1 = predict(object, newdata, type="probs")
						myPredict.sm <- function(x) sample(names(x), 1,prob=x,replace=F)
						ans2=apply(ans1,1, myPredict.sm)
						# > ans2[1:3]
						#           1           2           4
						#  "W-<=high" "W-postcol"  "B-<=high"
						as.factor(ans2)

				}# end of myPredict.multinom.sample


				#heating2$depvar = as.factor(heating2$depvar)

	   			print("10 fold CV")
				### cross validation for error rate
				cvs = errorest(race.edu ~ cigstat, data = MYDATA,
							model = multinom, predict=mypredict.multinom, trace=F)   ##, estimator="cv") #
				cvs$error
				#[1] 0.4825892

				# set.seed(1)
				ans = replicate(20, errorest(race.edu ~ cigstat, data = MYDATA,
							model = multinom, predict=mypredict.multinom, trace=F)$error )
				ans
				#[1] 0.4825892



				# > tb.con = table(y,tt)
				# > tb.con
				#            tt
				# y           W-<=high A-<=high A-college A-postcol B-<=high B-college B-postcol H-<=high H-college H-postcol W-college W-postcol
				#   W-<=high     19168        0         0         0        0         0         0        0         0         0         0         0
				#   A-<=high       772        0         0         0        0         0         0        0         0         0         0         0
				#   A-college      393        0         0         0        0         0         0        0         0         0         0         0
				#   A-postcol      361        0         0         0        0         0         0        0         0         0         0         0
				#   B-<=high      1319        0         0         0        0         0         0        0         0         0         0         0
				#   B-college      167        0         0         0        0         0         0        0         0         0         0         0
				#   B-postcol      222        0         0         0        0         0         0        0         0         0         0         0
				#   H-<=high       581        0         0         0        0         0         0        0         0         0         0         0
				#   H-college      118        0         0         0        0         0         0        0         0         0         0         0
				#   H-postcol      115        0         0         0        0         0         0        0         0         0         0         0
				#   W-college     6308        0         0         0        0         0         0        0         0         0         0         0
				#   W-postcol     7522        0         0         0        0         0         0        0         0         0         0         0
				# > sum(tb.con)
				# [1] 37046
				# > sum(tb.con[-1,1])/sum(tb.con)
				# [1] 0.4825892


	   ################ [6] bootstrap for classification error  #####################################################

			    booterror = errorest(race.edu ~ cigstat, data = MYDATA,
							model = multinom, predict=mypredict.multinom, trace=F, estimator="boot") #

	   ################ [7] External validation  #####################################################
				MYDATA.val  = mydat.val

				prd=mypredict.multinom(fit1, newdata=MYDATA.val)
				# prd
				#  W-<=high  A-<=high A-college A-postcol  B-<=high B-college B-postcol  H-<=high H-college H-postcol W-college W-postcol
				#     36396         0         0         0         0         0         0         0         0         0         0         0

				##### classification error ######
				tb.con = table(MYDATA.val[,"race.edu"], prd)
				# 				tb.con
				#   W-<=high     18759        0         0         0        0         0         0        0         0         0         0         0
				#   A-<=high       726        0         0         0        0         0         0        0         0         0         0         0
				#   A-college      377        0         0         0        0         0         0        0         0         0         0         0
				#   A-postcol      361        0         0         0        0         0         0        0         0         0         0         0
				#   B-<=high      1287        0         0         0        0         0         0        0         0         0         0         0
				#   B-college      171        0         0         0        0         0         0        0         0         0         0         0
				#   B-postcol      190        0         0         0        0         0         0        0         0         0         0         0
				#   H-<=high       564        0         0         0        0         0         0        0         0         0         0         0
				#   H-college      112        0         0         0        0         0         0        0         0         0         0         0
				#   H-postcol      108        0         0         0        0         0         0        0         0         0         0         0
				#   W-college     6175        0         0         0        0         0         0        0         0         0         0         0
				#   W-postcol     7084        0         0         0        0         0         0        0         0         0         0         0
				# > sum(tb.con[-1,1])/sum(tb.con)
				# [1] 0.4776689

	  }#end of doSelectValidate


	   ####################### [3] Calibration to census data ###############################################


					###### [2] Adjustment to literature and obtain probability or p1,p2,p3,...p12 for each education-race conditioning on smoking status: using Pr(edu, race | smoking status) ###################

					#### this is smoking status distributuion in the 1950 population (smoking history generator) ###
					## this is needed to calculate the marginal distribution below ##
					#ref.smk = c(0.37, 0.40, 0.23); names(ref.smk)=c("Never","Former","Current")
					#   Never  Former Current
					#    0.37    0.40    0.23
					## from reference (1950 cohort)
					#  W    B     H    A
					# 0.76 0.10 0.08 0.05
					### from reference (1950 cohort)
					#      high   college   postcol
					#      0.78     0.15    0.07




			        ### [2.1] Not-adjust to the literature prevalence of race and education

					MAIN="[Unadjusted] "
					coefTab = coef.race.edu

					prob.race.edu=getProb.race.edu2(coefTab,ref.smk,MAIN)
					prob.race.edu
					# $dist.race
					#          W          B          H          A
					# 0.88587494 0.05172628 0.02226523 0.04013355
					#
					# $dist.edu
					#      high   college   postcol
					# 0.5996797 0.1840330 0.2162873
					#
					# $PROBS
					#                  [,1]        [,2]        [,3]
					# A-<=high  0.020444183 0.021481210 0.019235226
					# A-college 0.013163701 0.009669158 0.006720742
					# A-postcol 0.014413884 0.007839858 0.003476246
					# B-<=high  0.023900574 0.034077249 0.079258401
					# B-college 0.004118253 0.003972195 0.008111240
					# B-postcol 0.006545080 0.005592432 0.006025492
					# H-<=high  0.012428298 0.016515967 0.022247972
					# H-college 0.002720988 0.003867663 0.001622248
					# H-postcol 0.004118253 0.002665552 0.001853998
					# W-college 0.191425210 0.165316469 0.125608343
					# W-postcol 0.280188263 0.167093503 0.119351101
					# W-<=high  0.426533314 0.561908744 0.606488992
					#
					# $PROBS.norm
					#                  [,1]        [,2]         [,3]
					# A-<=high  0.007564348 0.008592484 0.0044241020
					# A-college 0.004870569 0.003867663 0.0015457706
					# A-postcol 0.005333137 0.003135943 0.0007995365
					# B-<=high  0.008843212 0.013630899 0.0182294322
					# B-college 0.001523753 0.001588878 0.0018655852
					# B-postcol 0.002421680 0.002236973 0.0013858633
					# H-<=high  0.004598470 0.006606387 0.0051170336
					# H-college 0.001006766 0.001547065 0.0003731170
					# H-postcol 0.001523753 0.001066221 0.0004264195
					# W-college 0.070827328 0.066126588 0.0288899189
					# W-postcol 0.103669657 0.066837401 0.0274507532
					# W-<=high  0.157817326 0.224763498 0.1394924681



					prob.race.edu.before = prob.race.edu


					#####[2.2] Adjusted to the literature prevalnce of race and education  #############


					## coef.race.edu
					#                               Estimate Std. Error     t-value     Pr(>|t|)
					# A-<=high:(intercept)       -3.05205960 0.04424362 -68.9830411 0.000000e+00
					# A-college:(intercept)      -3.48788758 0.05457575 -63.9091078 0.000000e+00
					# A-postcol:(intercept)      -3.35291214 0.05112330 -65.5848151 0.000000e+00

					# B-<=high:(intercept)       -2.86662763 0.04051092 -70.7618578 0.000000e+00
					# B-college:(intercept)      -4.47451395 0.08854534 -50.5335905 0.000000e+00
					# B-postcol:(intercept)      -4.14694055 0.07533214 -55.0487550 0.000000e+00

					# H-<=high:(intercept)       -3.52919138 0.05568112 -63.3821880 0.000000e+00
					# H-college:(intercept)      -4.93987720 0.11150793 -44.3006810 0.000000e+00
					# H-postcol:(intercept)      -4.69959736 0.09898019 -47.4801835 0.000000e+00

					# W-college:(intercept)      -0.79811515 0.01686925 -47.3118367 0.000000e+00
					# W-postcol:(intercept)      -0.42752647 0.01496008 -28.5778278 0.000000e+00

					# A-<=high:cigstat1.Former   -0.23050611 0.05732333  -4.0211571 5.791296e-05
					# A-college:cigstat1.Former  -0.57193090 0.07623703  -7.5020096 6.283862e-14
					# A-postcol:cigstat1.Former  -0.94832165 0.07878926 -12.0361795 0.000000e+00
					# B-<=high:cigstat1.Former    0.01272992 0.05023165   0.2534242 7.999404e-01
					# B-college:cigstat1.Former  -0.53415298 0.12281115  -4.3493852 1.365197e-05
					# B-postcol:cigstat1.Former  -0.57045364 0.10535337  -5.4146694 6.140205e-08
					# H-<=high:cigstat1.Former   -0.03552330 0.06961492  -0.5102829 6.098533e-01
					# H-college:cigstat1.Former  -0.13572922 0.14203655  -0.9555936 3.392776e-01
					# H-postcol:cigstat1.Former  -0.63837331 0.14087276  -4.5315598 5.854976e-06
					# W-college:cigstat1.Former  -0.42260857 0.02226029 -18.9848605 0.000000e+00
					# W-postcol:cigstat1.Former  -0.79238312 0.02084755 -38.0084497 0.000000e+00
					# A-<=high:cigstat2.Current  -0.46851721 0.09320298  -5.0268483 4.986066e-07
					# A-college:cigstat2.Current -0.98558972 0.14184856  -6.9481828 3.700151e-12
					# A-postcol:cigstat2.Current -1.73236670 0.18454523  -9.3872203 0.000000e+00
					# B-<=high:cigstat2.Current   0.83770568 0.05748975  14.5713922 0.000000e+00
					# B-college:cigstat2.Current  0.14300691 0.15079625   0.9483453 3.429537e-01
					# B-postcol:cigstat2.Current -0.71519474 0.17569371  -4.0706906 4.687397e-05
					# H-<=high:cigstat2.Current   0.27649401 0.09106995   3.0360619 2.396902e-03
					# H-college:cigstat2.Current -1.12623089 0.30977524  -3.6356388 2.772926e-04
					# H-postcol:cigstat2.Current -0.96104562 0.25601949  -3.7537986 1.741748e-04
					# W-college:cigstat2.Current -0.74168560 0.03714342 -19.9681560 0.000000e+00
					# W-postcol:cigstat2.Current -1.29261404 0.03869194 -33.4078367 0.000000e+00

					## matrix for smoking ##

		if(Gender=="M"){

				#### manually done ###
				#cigmat=cbind(Former=indic.former, Current=indic.current)

				### these change education distributions a lot ##
				coefTab2=coef.race.edu
				coefTab2["W-postcol:(intercept)",1]= coefTab2["W-postcol:(intercept)",1]*4.8 # make it lower
				coefTab2["W-college:(intercept)",1]= coefTab2["W-college:(intercept)",1]*1.505 # make it lower

				### these affect race distribution ##
				coefTab2["H-<=high:(intercept)",1]= coefTab2["H-<=high:(intercept)",1]*0.61 # make it higher
				coefTab2["B-<=high:(intercept)",1]= coefTab2["B-<=high:(intercept)",1]*0.76 # make it higher
				coefTab2["A-<=high:(intercept)",1]= coefTab2["A-<=high:(intercept)",1]*0.96 # make it lower


					### checking ##
					tt=getProb.race.edu2(coefTab2,ref.smk,MAIN)
							tt$dist.race ;
							#          W          B          H          A
							# 0.76849823 0.10166100 0.07981484 0.05002594
							ref.race
							#    W    B    H    A
							# 0.76 0.10 0.08 0.05

							tt$dist.edu
							#       high    college    postcol
							# 0.78046128 0.15019607 0.06934265

							ref.edu
							#    high college postcol
							#    0.78    0.15    0.07

		}#end of


		if(Gender=="F"){

				#### manually done ###
				#cigmat=cbind(Former=indic.former, Current=indic.current)

				### these change education distributions a lot ##
				coefTab2=coef.race.edu
				coefTab2["W-postcol:(intercept)",1]= coefTab2["W-postcol:(intercept)",1]*1.9 # make it lower
				coefTab2["W-college:(intercept)",1]= coefTab2["W-college:(intercept)",1]*0.93#1.505 # make it lower

				coefTab2["A-<=high:(intercept)",1]= coefTab2["A-<=high:(intercept)",1]*0.96 # make it lower
				coefTab2["A-college:(intercept)",1]= coefTab2["A-college:(intercept)",1]*2.8#1.505 # make it lower
				coefTab2["A-postcol:(intercept)",1]= coefTab2["A-postcol:(intercept)",1]*0.63 # make it lower


				### these affect race distribution ##
				coefTab2["H-<=high:(intercept)",1]= coefTab2["H-<=high:(intercept)",1]*0.5 # make it higher
				coefTab2["H-college:(intercept)",1]= coefTab2["H-college:(intercept)",1]*1#1.505 # make it lower
				coefTab2["H-postcol:(intercept)",1]= coefTab2["H-postcol:(intercept)",1]*1 # make it lower

				coefTab2["B-<=high:(intercept)",1]= coefTab2["B-<=high:(intercept)",1]*0.7 # make it higher
				coefTab2["B-college:(intercept)",1]= coefTab2["B-college:(intercept)",1]*1 # make it higher
				coefTab2["B-postcol:(intercept)",1]= coefTab2["B-postcol:(intercept)",1]*1 # make it lower


					### checking ##
					tt=getProb.race.edu2(coefTab2,ref.smk,MAIN)
							tt$dist.race ;
							#          W          B          H          A
							# 0.76849823 0.10166100 0.07981484 0.05002594
							ref.race
							#    W    B    H    A
							# 0.76 0.10 0.08 0.05

							tt$dist.edu
							#       high    college    postcol
							# 0.78046128 0.15019607 0.06934265

							ref.edu
							#    high college postcol
							#    0.78    0.15    0.07

		}#end of


					prob.race.edu=getProb.race.edu2(coefTab2,ref.smk,MAIN="[Adjusted]")
					prob.race.edu[[1]];ref.race
					prob.race.edu[[2]];ref.edu
					#prob.race.edu.before[[1]]
					#prob.race.edu.before[[2]]
					# $dist.race
					#          W          B          H          A
					# 0.76433714 0.10972566 0.07083575 0.05510146
					#
					# $dist.edu
					#       high    college    postcol
					# 0.77054866 0.15663595 0.07281539
					#
					# $PROBS  --------------------------------------------> main output! each column sums up to 1
					#                 Never      Former     Current
					# A-<=high  0.018566097 0.014800494 0.011702345
					# A-college 0.029658838 0.016959562 0.011278914
					# A-postcol 0.033799932 0.013370632 0.006149116
					# B-<=high  0.070439032 0.071277125 0.149026204
					# B-college 0.011267360 0.006635478 0.012977099
					# B-postcol 0.015566571 0.008859252 0.007674597
					# H-<=high  0.056075187 0.054224294 0.072637778
					# H-college 0.007104640 0.006208510 0.002314815
					# H-postcol 0.009016896 0.004782629 0.003468208
					# W-college 0.157620308 0.109228065 0.081830842
					# W-postcol 0.058473874 0.027350069 0.016765308
					# W-<=high  0.532411267 0.666303888 0.624174774

					## from reference (1950 cohort)
					#  W    B     H    A
					# 0.76 0.10 0.08 0.05


					### from reference (1950 cohort)
					#      high   college   postcol
					#      0.78     0.15    0.07

		   ####### [2.3] plot reference distribution for race, education and smoking #####

					TAB=ref.smk
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,0.9),main="(Reference) Smoking Status",cex.axis=1.5,cex.lab=2,cex.main=2)
					text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")

					TAB=ref.race
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,1.1),main="(Reference) Race",cex.axis=1.5,cex.lab=2,cex.main=2)
					text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")

					TAB=ref.edu
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,0.9),main="(Reference) Education",cex.axis=1.5,cex.lab=2,cex.main=2)
					text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")



				  ########### Collecting the results ############################

				  ans=list(prob.race.edu.adjust=prob.race.edu, prob.race.edu.nonadjust=prob.race.edu.before,
					         polyout.or=or.race.edu, polyout=coef.race.edu)

				  ans


   }#end of myEduRace etc..

myEdu.Race.givneSmoking=function(mydat,ref.smk, ref.race,  ref.edu,Gender){   ## produce conditional distribution of education-race given smoking status

		## this is needed to calculate the marginal distribution below ##
		#ref.smk = c(0.37, 0.40, 0.23); names(ref.smk)=c("Never","Former","Current")
		#   Never  Former Current
		#    0.37    0.40    0.23

		## these will be used as reference for calibration
		## these are from literature ##

		# > ref.race
		#    W    B    H    A
		# 0.76 0.10 0.08 0.05
		# > ref.edu
		#    high college postcol
		#    0.78    0.15    0.07

		#####################[0] Define variables ################################################

		##### (1) define smoking status ###########
				# prevalence data: http://en.wikipedia.org/wiki/Prevalence_of_tobacco_consumption
				cigstat=mydat[,"cig_stat"]
				# > table(cig_stat)
				# cig_stat
				#     0     1     2     never, current, former
				# 26855  8581 37260

						tb.cig=table(cigstat)
						round(tb.cig/sum(tb.cig),2)
						# cigstat
						#    0    1    2
						# 0.37 0.12 0.51

				cigstat2=cigstat
				cigstat2[cigstat==0]="Never"
				cigstat2[cigstat==1]="Current"
				cigstat2[cigstat==2]="Former"

				# for polytomous ##
				cigstat3=cigstat
				cigstat3[cigstat==0]="0.Never"
				cigstat3[cigstat==1]="2.Current"
				cigstat3[cigstat==2]="1.Former"



		#### (2) education ########################
		#educat #Education
				# Question 3
				# .F="No Form" .M="Missing"
				# 1="Less than 8 years" 2="8-11 years"
				# 3="12 years or completed high school" 4="Post high school training other than college"
				# 5="Some college"
				# 6="College graduate" 7="Postgraduate"

				edu0=mydat[,"EDUCAT"]
				# edu
				#     1     2     3     4     5     6     7     M
				#   879  5035 13260  8905 14837 13757 15862   161
				# not finished highschool - highschool graduate -college graduate - postgraduate
				#   (1,2)                        (3,4,5)                 6                7

				edu=edu0
				#edu[edu0==1 | edu0==2]=1
				edu[edu0 <=5 ]=1
				edu[edu0==6]=2
				edu[edu0==7]=3
				edu[edu0=="M"]=NA

						tb.edu=table(edu)/sum(table(edu))
						tb.edu
						# edu
						#         1         2         3
						# 0.7016927 0.1504578 0.1478495

	            ## factor variable ##
				edu2=edu
				edu2[edu==1]="<=high"
				edu2[edu==2]="college"
				edu2[edu==3]="postcol"
				tb.edu2=table(edu2)/sum(table(edu2))
				tb.edu2
				# edu2
				#    <=high   college   postcol
				# 0.7016927 0.1504578 0.1478495

						doThis=F
						if(doThis==T){
							edu=edu0
							edu[edu0==1 | edu0==2]=1
							edu[edu0==3 | edu0==4 | edu0==5]=2
							edu[edu0==6]=3
							edu[edu0==7]=4
							edu[edu0=="M"]=NA

							tb.edu=table(edu)
							# edu
							#     1     2     3     4
							#  5914 37002 13757 15862
							# > round(tb.edu/sum(tb.edu),3)
							# edu
							#     1     2     3     4
							# 0.082 0.510 0.190 0.219

							edu2=edu
							edu2[edu==1]="<high"
							edu2[edu==2]="high"
							edu2[edu==3]="college"
							edu2[edu==4]="postcol"

						}#



		####### (3) race #############
				# 1="White, Non-Hispanic" 2="Black, Non-Hispanic" 3="Hispanic"
				# 4="Asian"
				# 5="Pacific Islander" 6="American Indian" 7="Missing"

				race0=mydat[,"race7"]
				# race0
				#     1     2     3     4     5     6     7
				# 64222  3273  1569  2957   452   185    38

				## merge 4-7
				# "white" - "black" - "hispanic" - "asian"
				race=race0
				race[race0>4]=NA
						tb.race=table(race)
						tb.race
						# race
						#     1     2     3     4
						# 64222  3273  1569  3632
						round(tb.race/sum(tb.race),2)
						# race
						# race
						#    1    2    3    4
						# 0.89 0.05 0.02 0.04
				race2=race
				race2[race==1]="W"
				race2[race==2]="B"
				race2[race==3]="H"
				race2[race==4]="A"

	   #### (4) define "Edu-race" variable #############


				race.edu=paste(race2,edu2,sep="-") #[1] "W-<=high"   "NA-college" "W-<=high"   "W-college"  "W-college"
				race.edu[is.na(race2) | is.na(edu2)] = NA
				race.edu=as.factor(as.character(race.edu))


		#### (5) plot distributions of cigstat, education and race (joint, marginal and conditional etc) ###

			#setwd(outdir)
			#plotfile1=paste("Plot_smoking.race.edu",Gender,"pdf",sep=".")
			#pdf(plotfile1)

					TAB=table(cigstat2)/sum(table(cigstat2))
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,0.9),main="(PLCO) Smoking Status",cex.axis=1.5,cex.lab=2)
					text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")

					TAB=table(race2)/sum(table(race2))
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,1.1),main="(PLCO) Race",cex.axis=1.5,cex.lab=2)
					text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")

					TAB=table(edu2)/sum(table(edu2))
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,0.9),main="(PLCO) Education",cex.axis=1.5,cex.lab=2)
					text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")


		      	   ######## Plot joint distribution of education (y-axis) and race (x-axis) given smoking status #######

					name.edu=c("<=high","college","postcol")
					name.race=c("W","B","H","A")
					#library(lattice)
					plot.new()

					u.cig=unique(cigstat2) #[1] "Never"   "Former"  "Current"

					dist1 = rep(list(list()),3)
					names(dist1)=u.cig

					for(j in 1:length(u.cig)){

						   ci=u.cig[j] #"Never"
						   tb=table(race2[cigstat2==ci],edu2[cigstat2==ci])
						   print(ci)
						   tb2=round(tb/sum(tb),3)
						   tb2=tb2[name.race,name.edu]
						   tb2
							#               W     B     H     A
							#   <=high  0.426 0.024 0.013 0.020
							#   college 0.192 0.005 0.003 0.013
							#   postcol 0.278 0.007 0.004 0.015

							color <- function(x)rev(heat.colors(x))
							print(levelplot(tb2,col.regions=color(256),main=ci,xlab="Race",ylab="Education"))
							#points(1:10,1:10)

						   ### write down probabiity number in each cell in the plot: a bit tricky ###
							xx2=tb2
							#putNum=function(xx){

							#     <high  high college postcol
							#   W 0.042 0.384   0.192   0.278
							#   B 0.005 0.019   0.005   0.007
							#   H 0.004 0.009   0.003   0.004
							#   A 0.002 0.018   0.013   0.015

							# > xx2
							#
							#               W     B     H     A
							#   <high   0.042 0.005 0.004 0.002
							#   high    0.384 0.019 0.009 0.018
							#   college 0.192 0.005 0.003 0.013
							#   postcol 0.278 0.007 0.004 0.015

							#xxx = seq(2,ncol(xx2)*2,by=2)
							#yyy = seq(2,nrow(xx2)*2,by=2)
							nCol=nrow(xx2)
							nRow=ncol(xx2)

							xxx0=seq(0,1,length.out=nCol+1.1)
							xxx=xxx0[-c(1,length(xxx0))]

							yyy0=seq(0,1,length.out=nRow+1.1)
							yyy=yyy0[-c(1,length(yyy0))]


							for(m in 1:nrow(xx2)){    text(rep(xxx[m],nRow), yyy,xx2[m,])  }
							#}# putNum=function(xx){
							#putNum(xx=tb2)

							dist1[[j]]=tb2

					}# for(j in 1:length(u.cig)){



					### plotting marginal distribution by education and race for each smoking status ####


					for(j in 1:length(u.cig)){

					   ci=u.cig[j] #"Never"
					   tb=table(race2[cigstat2==ci],edu2[cigstat2==ci])
					   print(ci)
					   tb2=round(tb/sum(tb),3)
					   tb2=tb2[name.race,name.edu]
					   tb2

						barplot(rowSums(tb2),ylim=c(0,1.1),col=heat.colors(4),xlab="Race",ylab="Probability",main=ci,cex.axis=1.5,cex.lab=1.5)
						text(1:length(rowSums(tb2)),rowSums(tb2)+0.1,rowSums(tb2),cex=1.5,col="blue")
						barplot(colSums(tb2),ylim=c(0,1.1),col=heat.colors(3),xlab="Education",ylab="Probability",main=ci,cex.axis=1.5,cex.lab=1.5)
						text(1:length(colSums(tb2)),colSums(tb2)+0.1,colSums(tb2),cex=1.5,col="blue")

					}#end of for(j in 1:length(u.cig)){




	   ##### [1] Fit polytomous regression to predict race-edu given smoking ######################

				#library(mlogit)

				mydata=data.frame(race.edu = as.factor(race.edu), cigstat=cigstat3)

				#mydata$brand<-as.factor(mydata$brand)
				mldata<-mlogit.data(mydata, varying=NULL, choice="race.edu", shape="wide")
				mldata[1:10,]
				# > mldata[1:10,]
				#             race.edu cigstat chid       alt
				# 1.A-<=high     FALSE   Never    1  A-<=high
				# 1.A-college    FALSE   Never    1 A-college
				# 1.A-postcol    FALSE   Never    1 A-postcol
				# 1.B-<=high     FALSE   Never    1  B-<=high
				# 1.B-college    FALSE   Never    1 B-college
				# 1.B-postcol    FALSE   Never    1 B-postcol
				# 1.H-<=high     FALSE   Never    1  H-<=high
				# 1.H-college    FALSE   Never    1 H-college


     			print("Fitting a polytomous regression")

				lm00 <- mlogit(race.edu~1|cigstat, data = mldata, reflevel="W-<=high") # "W-<=high" is reference
				summary(lm00)
				#                             Estimate Std. Error  t-value  Pr(>|t|)
				# A-<=high:(intercept)       -3.052060   0.044244 -68.9830 < 2.2e-16 ***
				# A-college:(intercept)      -3.487888   0.054576 -63.9091 < 2.2e-16 ***
				# A-postcol:(intercept)      -3.352912   0.051123 -65.5848 < 2.2e-16 ***
				# B-<=high:(intercept)       -2.866628   0.040511 -70.7619 < 2.2e-16 ***
				# B-college:(intercept)      -4.474514   0.088545 -50.5336 < 2.2e-16 ***
				# B-postcol:(intercept)      -4.146941   0.075332 -55.0488 < 2.2e-16 ***
				# H-<=high:(intercept)       -3.529191   0.055681 -63.3822 < 2.2e-16 ***
				# H-college:(intercept)      -4.939877   0.111508 -44.3007 < 2.2e-16 ***
				# H-postcol:(intercept)      -4.699597   0.098980 -47.4802 < 2.2e-16 ***
				# W-college:(intercept)      -0.798115   0.016869 -47.3118 < 2.2e-16 ***
				# W-postcol:(intercept)      -0.427526   0.014960 -28.5778 < 2.2e-16 ***
				# A-<=high:cigstat1.Former   -0.230506   0.057323  -4.0212 5.791e-05 ***
				# A-college:cigstat1.Former  -0.571931   0.076237  -7.5020 6.284e-14 ***
				# A-postcol:cigstat1.Former  -0.948322   0.078789 -12.0362 < 2.2e-16 ***
				# B-<=high:cigstat1.Former    0.012730   0.050232   0.2534 0.7999404
				# B-college:cigstat1.Former  -0.534153   0.122811  -4.3494 1.365e-05 ***
				# B-postcol:cigstat1.Former  -0.570454   0.105353  -5.4147 6.140e-08 ***
				# H-<=high:cigstat1.Former   -0.035523   0.069615  -0.5103 0.6098533
				# H-college:cigstat1.Former  -0.135729   0.142037  -0.9556 0.3392776
				# H-postcol:cigstat1.Former  -0.638373   0.140873  -4.5316 5.855e-06 ***
				# W-college:cigstat1.Former  -0.422609   0.022260 -18.9849 < 2.2e-16 ***
				# W-postcol:cigstat1.Former  -0.792383   0.020848 -38.0084 < 2.2e-16 ***

				# A-<=high:cigstat2.Current  -0.468517   0.093203  -5.0268 4.986e-07 ***
				# A-college:cigstat2.Current -0.985590   0.141849  -6.9482 3.700e-12 ***
				# A-postcol:cigstat2.Current -1.732367   0.184545  -9.3872 < 2.2e-16 ***
				# B-<=high:cigstat2.Current   0.837706   0.057490  14.5714 < 2.2e-16 ***
				# B-college:cigstat2.Current  0.143007   0.150796   0.9483 0.3429537
				# B-postcol:cigstat2.Current -0.715195   0.175694  -4.0707 4.687e-05 ***
				# H-<=high:cigstat2.Current   0.276494   0.091070   3.0361 0.0023969 **
				# H-college:cigstat2.Current -1.126231   0.309775  -3.6356 0.0002773 ***
				# H-postcol:cigstat2.Current -0.961046   0.256019  -3.7538 0.0001742 ***
				# W-college:cigstat2.Current -0.741686   0.037143 -19.9682 < 2.2e-16 ***
				# W-postcol:cigstat2.Current -1.292614   0.038692 -33.4078 < 2.2e-16 ***

				coef.race.edu=summary(lm00)$CoefTable
					# > coef.race.edu
					#                               Estimate Std. Error     t-value     Pr(>|t|)
					# A-<=high:(intercept)       -3.05205960 0.04424362 -68.9830411 0.000000e+00
					# A-college:(intercept)      -3.48788758 0.05457575 -63.9091078 0.000000e+00
					# A-postcol:(intercept)      -3.35291214 0.05112330 -65.5848151 0.000000e+00
					# B-<=high:(intercept)       -2.86662763 0.04051092 -70.7618578 0.000000e+00
					# B-college:(intercept)      -4.47451395 0.08854534 -50.5335905 0.000000e+00
					# B-postcol:(intercept)      -4.14694055 0.07533214 -55.0487550 0.000000e+00
					# H-<=high:(intercept)       -3.52919138 0.05568112 -63.3821880 0.000000e+00
				or.race.edu=myOR.CI4(coef.race.edu,bName="Estimate",sName="Std. Error",pName="Pr(>|t|)",zName="t-value",pval=T)
				row.names(or.race.edu)=row.names(coef.race.edu)
				    #or.race.edu
					# > or.race.edu
					#                              OR  CI1  CI2   beta    sd        pval2      Z
					# A-<=high:(intercept)       0.05 0.04 0.05 -3.052 0.044 0.000000e+00 -68.98
					# A-college:(intercept)      0.03 0.03 0.03 -3.488 0.055 0.000000e+00 -63.91
					# A-postcol:(intercept)      0.03 0.03 0.04 -3.353 0.051 0.000000e+00 -65.58
					# B-<=high:(intercept)       0.06 0.05 0.06 -2.867 0.041 0.000000e+00 -70.76
					# B-college:(intercept)      0.01 0.01 0.01 -4.475 0.089 0.000000e+00 -50.53
					# B-postcol:(intercept)      0.02 0.01 0.02 -4.147 0.075 0.000000e+00 -55.05
					# H-<=high:(intercept)       0.03 0.03 0.03 -3.529 0.056 0.000000e+00 -63.38
					# H-college:(intercept)      0.01 0.01 0.01 -4.940 0.112 0.000000e+00 -44.30



					###### [2] Adjustment to literature and obtain probability or p1,p2,p3,...p12 for each education-race conditioning on smoking status: using Pr(edu, race | smoking status) ###################

					#### this is smoking status distributuion in the 1950 population (smoking history generator) ###
					## this is needed to calculate the marginal distribution below ##
					#ref.smk = c(0.37, 0.40, 0.23); names(ref.smk)=c("Never","Former","Current")
					#   Never  Former Current
					#    0.37    0.40    0.23
					## from reference (1950 cohort)
					#  W    B     H    A
					# 0.76 0.10 0.08 0.05
					### from reference (1950 cohort)
					#      high   college   postcol
					#      0.78     0.15    0.07


					coefTab=coef.race.edu

			        ### [2.1] Not-adjust to the literature prevalence of race and education

					MAIN="[Unadjusted] "
					prob.race.edu=getProb.race.edu(coefTab,ref.smk,MAIN)
					prob.race.edu
					# $dist.race
					#          W          B          H          A
					# 0.79148608 0.08931073 0.04180721 0.07739598  --> black too low in PLCO
					#
					# $dist.edu
					#      high   college   postcol
					# 0.4090673 0.2823962 0.3085365   --> post college is too high in PLCO
					#
					# $PROBS
					#                 Never      Former     Current
					# A-<=high  0.045128638 0.036174155 0.028732394
					# A-college 0.029658838 0.016959562 0.011278914
					# A-postcol 0.033799932 0.013370632 0.006149116
					# B-<=high  0.053828151 0.054480189 0.116199590
					# B-college 0.011267360 0.006635478 0.012977099
					# B-postcol 0.015566571 0.008859252 0.007674597
					# H-<=high  0.028492963 0.027525937 0.037230082
					# H-college 0.007104640 0.006208510 0.002314815
					# H-postcol 0.009016896 0.004782629 0.003468208
					# W-college 0.310428850 0.227809114 0.176564241
					# W-postcol 0.394717143 0.227952362 0.151853067
					# W-<=high  0.060990020 0.369242180 0.445557876

					prob.race.edu.before = prob.race.edu


					#####[2.2] Adjusted to the literature prevalnce of race and education  #############


					## coef.race.edu
					#                               Estimate Std. Error     t-value     Pr(>|t|)
					# A-<=high:(intercept)       -3.05205960 0.04424362 -68.9830411 0.000000e+00
					# A-college:(intercept)      -3.48788758 0.05457575 -63.9091078 0.000000e+00
					# A-postcol:(intercept)      -3.35291214 0.05112330 -65.5848151 0.000000e+00

					# B-<=high:(intercept)       -2.86662763 0.04051092 -70.7618578 0.000000e+00
					# B-college:(intercept)      -4.47451395 0.08854534 -50.5335905 0.000000e+00
					# B-postcol:(intercept)      -4.14694055 0.07533214 -55.0487550 0.000000e+00

					# H-<=high:(intercept)       -3.52919138 0.05568112 -63.3821880 0.000000e+00
					# H-college:(intercept)      -4.93987720 0.11150793 -44.3006810 0.000000e+00
					# H-postcol:(intercept)      -4.69959736 0.09898019 -47.4801835 0.000000e+00

					# W-college:(intercept)      -0.79811515 0.01686925 -47.3118367 0.000000e+00
					# W-postcol:(intercept)      -0.42752647 0.01496008 -28.5778278 0.000000e+00

					# A-<=high:cigstat1.Former   -0.23050611 0.05732333  -4.0211571 5.791296e-05
					# A-college:cigstat1.Former  -0.57193090 0.07623703  -7.5020096 6.283862e-14
					# A-postcol:cigstat1.Former  -0.94832165 0.07878926 -12.0361795 0.000000e+00
					# B-<=high:cigstat1.Former    0.01272992 0.05023165   0.2534242 7.999404e-01
					# B-college:cigstat1.Former  -0.53415298 0.12281115  -4.3493852 1.365197e-05
					# B-postcol:cigstat1.Former  -0.57045364 0.10535337  -5.4146694 6.140205e-08
					# H-<=high:cigstat1.Former   -0.03552330 0.06961492  -0.5102829 6.098533e-01
					# H-college:cigstat1.Former  -0.13572922 0.14203655  -0.9555936 3.392776e-01
					# H-postcol:cigstat1.Former  -0.63837331 0.14087276  -4.5315598 5.854976e-06
					# W-college:cigstat1.Former  -0.42260857 0.02226029 -18.9848605 0.000000e+00
					# W-postcol:cigstat1.Former  -0.79238312 0.02084755 -38.0084497 0.000000e+00
					# A-<=high:cigstat2.Current  -0.46851721 0.09320298  -5.0268483 4.986066e-07
					# A-college:cigstat2.Current -0.98558972 0.14184856  -6.9481828 3.700151e-12
					# A-postcol:cigstat2.Current -1.73236670 0.18454523  -9.3872203 0.000000e+00
					# B-<=high:cigstat2.Current   0.83770568 0.05748975  14.5713922 0.000000e+00
					# B-college:cigstat2.Current  0.14300691 0.15079625   0.9483453 3.429537e-01
					# B-postcol:cigstat2.Current -0.71519474 0.17569371  -4.0706906 4.687397e-05
					# H-<=high:cigstat2.Current   0.27649401 0.09106995   3.0360619 2.396902e-03
					# H-college:cigstat2.Current -1.12623089 0.30977524  -3.6356388 2.772926e-04
					# H-postcol:cigstat2.Current -0.96104562 0.25601949  -3.7537986 1.741748e-04
					# W-college:cigstat2.Current -0.74168560 0.03714342 -19.9681560 0.000000e+00
					# W-postcol:cigstat2.Current -1.29261404 0.03869194 -33.4078367 0.000000e+00

					## matrix for smoking ##

		if(Gender=="M"){

				#### manually done ###
				#cigmat=cbind(Former=indic.former, Current=indic.current)


				coefTab2=coef.race.edu
				coefTab2["W-postcol:(intercept)",1]= coefTab2["W-postcol:(intercept)",1]*6.5 # make it lower
				coefTab2["W-college:(intercept)",1]= coefTab2["W-college:(intercept)",1]*2.1 # make it lower
				coefTab2["H-<=high:(intercept)",1]= coefTab2["H-<=high:(intercept)",1]*0.8 # make it higher
				coefTab2["B-<=high:(intercept)",1]= coefTab2["B-<=high:(intercept)",1]*0.9 # make it higher
				coefTab2["A-<=high:(intercept)",1]= coefTab2["A-<=high:(intercept)",1]*1.3 # make it lower

		}#end of

		if(Gender=="F") {

				coefTab2=coef.race.edu
				coefTab2["W-postcol:(intercept)",1]= coefTab2["W-postcol:(intercept)",1]*1.98 # make it lower
				coefTab2["W-college:(intercept)",1]= coefTab2["W-college:(intercept)",1]*1.24 # make it lower
				coefTab2["H-<=high:(intercept)",1]= coefTab2["H-<=high:(intercept)",1]*0.65 # make it higher
				coefTab2["B-<=high:(intercept)",1]= coefTab2["B-<=high:(intercept)",1]*0.9 # make it higher
				#coefTab2["A-<=high:(intercept)",1]= coefTab2["A-<=high:(intercept)",1]*1.3 # make it lower


		}#end of

					prob.race.edu=getProb.race.edu(coefTab2,ref.smk,MAIN="[Adjusted]")
						prob.race.edu[[1]];ref.race
						prob.race.edu[[2]];ref.edu
					#prob.race.edu.before[[1]]
					#prob.race.edu.before[[2]]
					# $dist.race
					#          W          B          H          A
					# 0.76433714 0.10972566 0.07083575 0.05510146
					#
					# $dist.edu
					#       high    college    postcol
					# 0.77054866 0.15663595 0.07281539
					#
					# $PROBS  --------------------------------------------> main output! each column sums up to 1
					#                 Never      Former     Current
					# A-<=high  0.018566097 0.014800494 0.011702345
					# A-college 0.029658838 0.016959562 0.011278914
					# A-postcol 0.033799932 0.013370632 0.006149116
					# B-<=high  0.070439032 0.071277125 0.149026204
					# B-college 0.011267360 0.006635478 0.012977099
					# B-postcol 0.015566571 0.008859252 0.007674597
					# H-<=high  0.056075187 0.054224294 0.072637778
					# H-college 0.007104640 0.006208510 0.002314815
					# H-postcol 0.009016896 0.004782629 0.003468208
					# W-college 0.157620308 0.109228065 0.081830842
					# W-postcol 0.058473874 0.027350069 0.016765308
					# W-<=high  0.532411267 0.666303888 0.624174774

					## from reference (1950 cohort)
					#  W    B     H    A
					# 0.76 0.10 0.08 0.05


					### from reference (1950 cohort)
					#      high   college   postcol
					#      0.78     0.15    0.07

		   ####### [2.3] plot reference distribution for race, education and smoking #####

					TAB=ref.smk
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,0.9),main="(Reference) Smoking Status",cex.axis=1.5,cex.lab=2,cex.main=2)
					text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")

					TAB=ref.race
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,1.1),main="(Reference) Race",cex.axis=1.5,cex.lab=2,cex.main=2)
					text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")

					TAB=ref.edu
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,0.9),main="(Reference) Education",cex.axis=1.5,cex.lab=2,cex.main=2)
					text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")



				  ########### Collecting the results ############################

				  ans=list(prob.race.edu.adjust=prob.race.edu, prob.race.edu.nonadjust=prob.race.edu.before,
					         polyout.or=or.race.edu, polyout=coef.race.edu)

				  ans


   }#end of myEduRace etc..





#ref.bmi = c(28.7, 27.7, 28.9); names(ref.bmi)=c("W","B","H") # their average BMI at age = 50 "--Ogden et al. 2004"
#age.ref = 50 # calculate BMI at age=50
#ref.bmi.sd = c(0.3, 0.4, 0.3) #--Ogden et al. 2004"

########## 3/16/2016: incorporate external and cross validation and other metrics	###




myBMI.cond2 <- function(PROB.edu.race, age.ref, ref.bmi, ref.bmi.sd, Gender, CPD.50.mean, cigyears50.mean){

			 # fit Pr(BMI | education, race, age and smoking status, stopage, smokingyears..) ###########################################
			#Estimate the distribution from PLCO: time varying BMI by smoking history & prevalence data for BMI for 1950 birth cohort
			#http://www.cdc.gov/nchs/data/ad/ad347.pdf

			######### BMI variables description #####
			# bmi_curr Current BMI
					# Derived from questions 22,23. People who are under 48 inches tall are set to .R. Females who are taller than 78 inches and males who are taller than 84 are also set to .R. Participants who report a weight less than 60 pounds are set to .R. BMI values
					# Numeric
					# .F="No Form" .M="Missing" .R="Out of Range"
			#bmi_curc
					#.F="No Form" .M="Missing" .R="Out of Range" 1="0 - <18.5" 2="18.5 - <25" 3="25 - <30" 4=">=30"


if (1==0) {
		#####################[0] Define variables ################################################

		##### (1) define smoking status ###########
				# prevalence data: http://en.wikipedia.org/wiki/Prevalence_of_tobacco_consumption
				cigstat=mydat[,"cig_stat"]
				# > table(cigstat)
				# cig_stat

				#     0     1     2     A     F     M     #A is ambiguous -- will put in former then
				# 26917  8659 38256     1  2826    23

				# .A="Ambiguous"
				# .F="No Form"
				# .M="Not Answered"
				# 0="Never Smoked Cigarettes"
				# 1="Current Cigarette Smoker"
				# 2="Former Cigarette Smoker"

				tb.cig=table(cigstat)
				round(tb.cig/sum(tb.cig),2)
				# cigstat
				#    0    1    2
				# 0.37 0.12 0.51

				cigstat2=cigstat
				cigstat2[cigstat=="0"]="Never"
				cigstat2[cigstat=="1"]="Current"
				cigstat2[cigstat=="2"]="Former"
				cigstat2[cigstat=="A"]= NA
				cigstat2[cigstat=="F"]= NA
				cigstat2[cigstat=="M"]= NA
						# > table(cigstat2)
						# cigstat2
						# Current  Former   Never
						#    8659   38256   26917

				# for polytomous ##
				cigstat3=cigstat2
				cigstat3[cigstat==0]="0.Never"
				cigstat3[cigstat==1]="2.Current"
				cigstat3[cigstat==2]="1.Former"

					# > table(cigstat3)
					# cigstat3
					#   0.Never  1.Former 2.Current
					#     26917     38256      8659


		ix.na.smk = is.na(cigstat2)==T
		# > sum(ix.na.smk)
		# [1] 2850   ---> need to exclude them


		#### (2) education ########################
		#educat #Education
				# Question 3
				# .F="No Form" .M="Missing"
				# 1="Less than 8 years" 2="8-11 years"
				# 3="12 years or completed high school" 4="Post high school training other than college"
				# 5="Some college"
				# 6="College graduate" 7="Postgraduate"

				edu0=mydat[,"educat"]
				table(edu0)
				# edu0
				#     1     2     3     4     5     6     7     F     M
				#   923  5172 13484  9048 15067 13912 16037  2826   213

				# not finished highschool - highschool graduate -college graduate - postgraduate
				#   (1,2)                        (3,4,5)                 6                7

				edu=edu0
				#edu[edu0==1 | edu0==2]=1
				edu[edu0 <=5 ]=1
				edu[edu0==6]=2
				edu[edu0==7]=3
				edu[edu0=="M" | edu0=="F"]=NA

						tb.edu=table(edu)/sum(table(edu))
						tb.edu
						# edu
						#         1         2         3
						# 0.7016927 0.1504578 0.1478495
						# > table(edu)
						# edu
						#     1     2     3
						# 43694 13912 16037

	            ## factor variable ##
				edu2=edu
				edu2[edu==1]="<=high"
				edu2[edu==2]="college"
				edu2[edu==3]="postcol"
				tb.edu2=table(edu2)/sum(table(edu2))
				tb.edu2
				# edu2
				#    <=high   college   postcol
				# 0.7016927 0.1504578 0.1478495

						doThis=F
						if(doThis==T){
							edu=edu0
							edu[edu0==1 | edu0==2]=1
							edu[edu0==3 | edu0==4 | edu0==5]=2
							edu[edu0==6]=3
							edu[edu0==7]=4
							edu[edu0=="M"]=NA

							tb.edu=table(edu)
							# edu
							#     1     2     3     4
							#  5914 37002 13757 15862
							# > round(tb.edu/sum(tb.edu),3)
							# edu
							#     1     2     3     4
							# 0.082 0.510 0.190 0.219

							edu2=edu
							edu2[edu==1]="<high"
							edu2[edu==2]="high"
							edu2[edu==3]="college"
							edu2[edu==4]="postcol"

						}#



		####### (3) race #############
				# 1="White, Non-Hispanic" 2="Black, Non-Hispanic" 3="Hispanic"
				# 4="Asian"
				# 5="Pacific Islander" 6="American Indian" 7="Missing"

				# 1="White, Non-Hispanic"
				# 2="Black, Non-Hispanic"
				# 3="Hispanic"
				# 4="Asian"
				# 5="Pacific Islander"
				# 6="American Indian"
				# 7="Missing"
				race0=mydat[,"race7"]
					table(race0)
					# race0
					#     1     2     3     4     5     6     7
					# 64222  3273  1569  2957   452   185    38
					#
					#     1     2     3     4     5     6     7
					# 65178  3370  1603  3009   464   187  2871
					#
				## merge 4-7
				# "white" - "black" - "hispanic" - "asian"
				race=race0
				race[race0>4]=NA
						tb.race=table(race)
						tb.race
						# race
						#     1     2     3     4
						# 64222  3273  1569  3632
						round(tb.race/sum(tb.race),2)
						# race
						# race
						#    1    2    3    4
						# 0.89 0.05 0.02 0.04
				race2=race
				race2[race==1]="W"
				race2[race==2]="B"
				race2[race==3]="H"
				race2[race==4]="A"
					#table(race2)
					#     A     B     H     W
					#  3009  3370  1603 65178
	   #### (4) define "Edu-race" variable #############


				race.edu=paste(race2,edu2,sep="-") #[1] "W-<=high"   "NA-college" "W-<=high"   "W-college"  "W-college"
				race.edu[is.na(race2) | is.na(edu2)] = NA
				race.edu=as.factor(as.character(race.edu))

	  #####  (5) BMI ########

            # clean chars ---------------------
            temp <- mydat[,"bmi_curr"]
            temp[temp %in% c("F","M","R")] <- NA
            temp_ <- mydat[,"bmi_curc"]
            temp_[temp_ %in% c("F","M","R")] <- NA

			# bmi=as.numeric(mydat[,"bmi_curr"]) #[1] 38.07647 31.81634 22.69663 27.25385 28.03809 24.19162 30.57929 25.16239 22.28669 23.10435
            bmi=as.numeric(temp)
            # bmicat=as.numeric(mydat[,"bmi_curc"]) #[1] 38.07647 31.81634 22.69663 27.25385 28.03809 24.19162 30.57929 25.16239 22.28669 23.10435
            bmicat=as.numeric(temp_)

			### some NA's for F, M, R... missing values
# Q: should I do missing value imputation?
			#            2            1            1            1            1            1            1            1            1
			# 66.317197494            F            M            R
			#            1         2826         1071          147

	  ####  (6) define age variable

			age=as.numeric(mydat[,"age"])
					range(age)
					# [1] 49 78
			#library(Hmisc)
			age.cat = cut2(age, cuts=c(55, 60, 65, 70, 75))
			# > table(age.cat)
			# age.cat
			# [49,55) [55,60) [60,65) [65,70) [70,75) [75,78]
			#       9   24750   24023   17763   10133       4

				# > levels(age.cat)
				# [1] "[49,55)" "[55,60)" "[60,65)" "[65,70)" "[70,75)" "[75,78]"
			levels(age.cat)= c("lt55","55_60","60_65","65_70","70_75","85+")

			#age.cat = cut2(age,

	 ####### (7) define Smoking related variables ##
			#cig_per_day  of Cigarettes Smoked Per Day
					#The maximum number of cigarettes smoked per day, based on the range specified. The category 81+ is set to 100.

			# cig_years_rnd # of Years Smoked Cigarettes
					# Derived from questions 10-13. This differs from cig_years because it uses randomization age instead of BQ age.
					# Numeric .F="No Form" .M="Missing"
			#cig_stop_rnd # of Years Since Stopped Smoking Cigarettes
					# Derived from questions 12 and 13. This differs from cig_stop because it uses randomization age instead of BQ age.
					# Numeric
					# .F="No Form" .M="Missing" .N="Not Applicable"


			### pack-years ##
			pky0=mydat[,"pack_years"]
			#pky0=mydat[,"pack_years_rnd"]
			pky2=pky0
			pky2[pky0=="M" | pky0=="F"]=NA
			pky2=as.numeric(pky2)
			#[1]   0 260
			#   9.5    90    92    93    94  94.5    95    96    98    99     F     M
			#   138   268   150   104   100     1     5   231    72    87  2826  1123

			### make category (0-10), (10-30), (30-60), (60-100), 100+
			pky=pky2
			pky[pky2 <=10] = "lst10"
			pky[pky2 > 10 & pky2<=30] ="10_30"
			pky[pky2 > 30 & pky2 <=60] = "30_60"
			pky[pky2 > 60 & pky2 <=100] = "60_100"
			pky[pky2>100]="gt100"
			table(pky)
			# pky
			#  10_30  30_60 60_100  gt100  lst10
			#  14808  14932   7212   2261  33430

			#### cigday ##
			# F="No Form"
			# .M="Missing"
			# 0="0"
			# 1="1-10"
			# 2="11-20"
			# 3="21-30"
			# 4="31-40"
			# 5="41-60"
			# 6="61-80"
			# 7="81+"

			cigday0=mydat[,"cigpd_f"]
				table(cigday0)
				# cigday0
				#     0     1     2     3     4     5     6     7     F     M
				# 26917  7853 17302 10783  6409  3591   685   184  2826   132

			### put maximum value not category
			cigday00 = cigday0
			cigday00[cigday0=="1"] = 10
			cigday00[cigday0=="2"] = 20
			cigday00[cigday0=="3"] = 30
			cigday00[cigday0=="4"] = 40
			cigday00[cigday0=="5"] = 60
			cigday00[cigday0=="6"] = 80
			cigday00[cigday0=="7"] = 100
			cigday00[cigday0=="F" | cigday0=="M"] = NA

				table(cigday00)
				# cigday00
				#     0    10   100    20    30    40    60    80
				# 26917  7853   184 17302 10783  6409  3591   685

							# old PCA data (more accurate i guess,but new data don't have this 3/16/2016)
							#cigday0=mydat[,"cig_per_day"]
								# > table(mydat[,"cig_per_day"])
								#
								#    10   100    20    30    40    60    80     M     N
								#  7637   177 16972 10579  6290  3511   668     7 26855   <--- never smoker

			#### group: N, (0-20], (20-40], (40-60], (60,100]

			cigday=cigday00
			cigday[cigday00=="0"]	= "never"
			cigday[cigday00==10 | cigday00==20 ]	= "0_20"
			cigday[cigday00==30 | cigday00==40 ]	= "20_40"
			cigday[cigday00==50 | cigday00==60 ]	= "40_60"
			cigday[cigday00==70 | cigday00==80 | cigday00==90 | cigday00==100]	= "60_100"
			cigday[cigday00=="M"]	= NA

			table(cigday)
			# cigday
			#   0_20  20_40  40_60 60_100  never
			#  25155  17192   3591    869  26917

							# cigday
							#  20_40  40_60 60_100  lst20  never
							#  16869   3511    845  24609  26855


			## define cigday2 ###

			cigday2=cigday00
			cigday2[cigday00=="N"]=0
			cigday2[cigday00=="M"]=NA
			cigday2=as.numeric(cigday2)


			### define cigstop ###
			# Numeric
			# .F="No Form"
			# .M="Not Answered"
			# .N="Not Applicable"
			# 0.5="Six Months"

			cigstop0=mydat[,"cig_stop"]
			#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24
			#  8659   702   843  1206   984   989   982   971  1070   979   863   858   894   755  1235   899   889   910   871
			#    25    26    27    28    29     3    30    31    32    33    34    35    36    37    38    39     4    40    41
			#  1076  1050  1020  1024  1062   734  1191  1057   973   905   825   763   641   540   465   420   675   344   341
			#    42    43    44    45    46    47    48    49     5    50    51    52    53    54    55    56    57    58    59
			#   296   222   215   178   148   113   112    86   808    48    44    30    16    15     4     3     3     3     1
			#     6    60    62     7     8     9     F     M     N
			#   798     1     1   801   823   774  2826   731 26917
			# >
			#cigstop0=mydat[,"cig_stop_rnd"]
			# #range(as.numeric(cigstop0),na.rm=T)

            # [1]  0 62
			# Warning cat:
			# NAs introduced by coercion

			# cigstop0
			#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24    25    26    27    28    29     3
			#  8581   697   825  1191   975   983   975   969  1059   962   858   845   915   750  1217   884   884   911   874  1062  1048  1026   992  1055   728
			#    30    31    32    33    34    35    36    37    38    39     4    40    41    42    43    44    45    46    47    48    49     5    50    51    52
			#  1187  1056   975   904   812   772   623   523   466   414   665   338   342   284   228   209   181   137   117   110    80   810    49    44    24
			#    53    54    55    56    57    58    59     6    62     7     8     9     N
			#    15    15     3     2     3     3     2   785     1   808   805   771 26867
					# > table(cigstop0,cigstat2)
					#         cigstat2
					# cigstop0 Current Former Never
					#      0      8581      0     0  --> current smoker has cigstop=0, yes makes sens
					#      0.5       0    697     0
					# ..
					#      8         0    805     0
					#      9         0    771     0
					#      N         0     12 26855    ---> never smoker nas cigstop="N"

            # F, M, N ------------------------
            temp <- cigstop0
            temp[temp %in% c("F","M","N")] <- NA

			### define: N, 0-20, 20-40, 40+ ##
			# tt=as.numeric(cigstop0)
            tt=as.numeric(temp)


			# > range(tt,na.rm=T)
			# [1]  0 62
			cigstop=cigstop0
			cigstop[cigstop0=="N"]="never"
			cigstop[tt==0] = "0"
			cigstop[tt>0 & tt <=20] = "0_20"
			cigstop[tt >20 & tt<=40] = "20_40"
			cigstop[tt >40 ] = "gt40"

			cigstop[cigstop=="F" | cigstop=="M" ] = NA

			table(cigstop)
			# cigstop
			#     0  0_20 20_40  gt40 never
			#  8659 18744 16925  1880 26917

					#              0           0_20          20_40 gt40.neversmok          never
					#           8581          18593          16806           1849          26867
					#boxplot(tt~cigstop)
			### numeric variables ##
			cigstop2=tt


			### define cigyears ###
			# Numeric
			# .F="No Form"
			# .M="Not Answered"
			# 0.5="Six Months"
			cigyears0=mydat[,"cig_years"]
			#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24
			# 26917    91   222  1107   753   971   748  1012  1012   816   970   954   931   454  1313   872  1093   947  1057
			#    25    26    27    28    29     3    30    31    32    33    34    35    36    37    38    39     4    40    41
			#  1030   851   909   938   931   421  1033   876  1014   946  1023  1061   984  1138  1130  1255   512  1340  1189
			#    42    43    44    45    46    47    48    49     5    50    51    52    53    54    55    56    57    58    59
			#  1101  1046   963   845   824   657   608   546   603   501   426   346   262   206   159    98    85    44    25
			#     6    60    61    62    63    64     7     8     9     F     M
			#   600    24    11     4     6     3   662   630   709  2826  1041

					#cigyears0=mydat[,"cig_years_rnd"]
					# > table(cigyears0)
					# cigyears0
					#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24    25    26    27    28    29     3
					# 26855    92   225  1106   752   965   748  1011  1009   815   964   950   930   453  1312   873  1088   946  1058  1028   851   908   935   930   419
					#    30    31    32    33    34    35    36    37    38    39     4    40    41    42    43    44    45    46    47    48    49     5    50    51    52
					#  1034   873  1012   940  1024  1067   977  1137  1124  1255   511  1340  1180  1114  1039   959   838   817   654   607   551   599   490   424   349
					#    53    54    55    56    57    58    59     6    60    61    62    63    64     7     8     9     M
					#   256   205   155    99    83    44    25   599    24    12     4     5     3   662   628   708    46

            # fix F, M -----------------------
            temp <- mydat[,"cig_years"]
            temp[temp %in% c("F","M")] <- NA
            #tt=as.numeric(mydat[,"cig_years"])
            tt=as.numeric(temp)

			# range(tt,na.rm=T)
			# [1]  0 64

			## group:  0-20, 20-40, 40-60
			cigyears=cigyears0
			cigyears[cigyears0=="M" | cigyears0=="F"]=NA
			cigyears[tt==0] = "0"
			cigyears[tt >0 & tt <=20] = "0_20"
			cigyears[tt >20 & tt<=40] = "20_40"
			cigyears[tt >40] = "gt40"

			table(cigyears)
			# cigyears
			#     0  0_20 20_40  gt40
			# 26917 15491 20428  9979


						# cigyears
						#     0  0_20 20_40  gt40
						# 26855 15458 20400  9937
						#boxplot(tt~cigyears)

			## cigyears.numeric ##

			cigyears2=cigyears0
			cigyears2[cigyears0=="M" |cigyears0=="F" ]=NA
			cigyears2=as.numeric(cigyears2)






	############# [1] Variable preparation (reference leve change etc) ################################
	#covnames=c("cigstat2","edu2","race2")#,cigday)
	#covnames=c("edu2","race2","cigyears2", "cigstop2", "pky2", "cigday2")

	race3=relevel(as.factor(race2),ref="W")
	cigstopf=as.factor(cigstop)
	cigstopf2=relevel(cigstopf, ref="never")
	cigstat2 = relevel(as.factor(cigstat2), ref="Never")

	mydatall=MYDAT0=data.frame(bmi=bmi, edu=edu2,race=race3,cigstat=cigstat2,cigyears=cigyears2, cigstop=cigstopf2, pky=pky2, cigday=cigday2,age=age, age.cat=age.cat)
			MYDAT0[1:3,]
			#        bmi     edu race cigstat cigyears cigstop pky cigday age
			# 1 25.78094  <=high    B   Never        0   never   0      0  67
			# 2 25.71645 postcol    W  Former        8   20_40  24     60  62
			# 3 34.66130  <=high    W  Former       35    0_20  35     20  62

			# > table(MYDAT0[,"cigstat"])
			#
			# Current  Former   Never
			#    8659   38256   26917

		# > sum(is.na(MYDAT0[,"cigstop"])) <----- non-smokers have NA and this needs to be taken care of
		# [1] 3557
		# > sum(is.na(MYDAT0[,"pky"]))
		# [1] 3949
		# > sum(is.na(MYDAT0[,"cigday"]))
		# [1] 2958
		# > sum(is.na(MYDAT0[,"race"]))
		# [1] 3522
		# > sum(is.na(MYDAT0[,"cigyears"]))
		# [1] 3867

				dim(MYDAT0)
				#[1] 76682     9

	########[2] Splitting into training vs. validation data #####################################
				# > dim(mydat)
				# [1] 76682   432
				# > dim(MYDAT0)
				# [1] 76682     9

 				ix.cxr = mydat[,"arm"]==1  # chest xray ram
					table(mydat[,"arm"])
					#
					#     1     2
					# 38340 38342
					# > sum(ix.cxr)
					# [1] 38340
					#length(ix.cxr)==length(ix.na.smk)
					# [1] TRUE

	   			### training data ##########
	   			mydat.tr = mydatall[ix.cxr==T,]
	   			#mydat.tr = mydatall[ix.na.smk==F & ix.cxr==T,]
					dim(mydat.tr)
					#[1] 38340     9
					# [1] 37436   434

				### validation data #########

				mydat.val = mydatall[ix.cxr==F,]
					dim(mydat.val)
					#[1] 38340     9
					# [1] 36396   434


	############# [3] Full model fitting ##############################################################

				MYDATA = na.omit(mydat.tr)

				dim(mydat.tr)
				#[1] 38340     9
				dim(MYDATA)
				#[1] 36108     9

				# > MYDATA[1:5,]
				#        bmi     edu race cigstat cigyears cigstop  pky cigday age
				# 1 25.78094  <=high    B   Never        0   never  0.0      0  67
				# 2 25.71645 postcol    W  Former        8   20_40 24.0     60  62
				# 4 23.54244  <=high    W  Former       11   20_40 33.0     60  57
				# 5 32.06407 postcol    W   Never        0   never  0.0      0  56
				# 6 31.07642  <=high    W Current       41       0 61.5     30  56


				#### (choose df) Preliminary analysis for individual variable splines investigation for inclusion ####


				#library(rms) # rms is needed for cross-validation and others
				#library(splines)

				lmfull=lm(bmi ~ race + edu + ns(age,df=3) + cigstat*race +cigstat*edu + pky+ cigstop + ns(cigyears,df=1) + ns(cigday,df=1),
									data=MYDATA)
				summary(lmfull)


				################# Exploration find spline d.f. for each variables ####################
				doThis=F
				if(doThis==T){



						tt=lm(bmi~ns(age,df=3),data=MYDATA)
						summary(tt)
						AIC(tt)


						tt=lm(bmi~ns(pky,df=2),data=MYDATA)
						summary(tt)
						AIC(tt)


						tt=lm(bmi~ns(cigyears,df=1),data=MYDATA)
						summary(tt)
						AIC(tt)

						tt=lm(bmi~ns(cigday,df=1),data=MYDATA)
						summary(tt)
						AIC(tt)

						ddist <- datadist(MYDATA$bmi,MYDATA$age); options(datadist='ddist')

						mydf=4

						lm1=ols(bmi ~ns(age,mydf), data=MYDATA,x=T,y=T)
						lm1
						Function(lm1)


						AIC(lm1)
						agegrid = unique(sort(MYDATA$age))
						pred=Predict(lm1, age=agegrid)
						plot(MYDATA$age,MYDATA$bmi)
					   lines(agegrid, pred[,"yhat"],col="red")
					   title(paste("natural splines df=",mydf,sep=""))



						mydf=2

						lm1=ols(bmi ~ns(cigyears,mydf), data=MYDATA,x=T,y=T)
						lm1
						AIC(lm1)
						xx = unique(sort(MYDATA$cigyears))
						pred=Predict(lm1, cigyears=xx)
						plot(MYDATA$cigyears,MYDATA$bmi)
						lines(xx, pred[,"yhat"],col="red")
						title(paste("natural splines df=",mydf,sep=""))



						mydf=2

						lm1=ols(bmi ~ns(pky,mydf), data=MYDATA,x=T,y=T)
						lm1
						AIC(lm1)
						xx = unique(sort(MYDATA$pky))
						pred=Predict(lm1, pky=xx)
						plot(MYDATA$pky,MYDATA$bmi)
						lines(xx, pred[,"yhat"],col="red")
						title(paste("natural splines df=",mydf,sep=""))



						mydf=2

						lm1=ols(bmi ~ns(cigday,mydf), data=MYDATA,x=T,y=T)
						#lm1=ols(bmi ~cigday, data=MYDATA,x=T,y=T)
						lm1
						AIC(lm1)
						xx = unique(sort(MYDATA$cigday))
						pred=Predict(lm1, cigday=xx)
						plot(MYDATA$cigday,MYDATA$bmi)
						lines(xx, pred[,"yhat"],col="red")
						title(paste("natural splines df=",mydf,sep=""))


						######## full model fitting using lm() to use step function for variable selection ####
						#        bmi     edu race cigstat cigyears cigstop  pky cigday age
						# 1 25.78094  <=high    B   Never        0   never  0.0      0  67
						# 2 25.71645 postcol    W  Former        8   20_40 24.0     60  62
						# 4 23.54244  <=high    W  Former       11   20_40 33.0     60  57
						# 5 32.06407 postcol    W   Never        0   never  0.0      0  56
						# 6 31.07642  <=high    W Current       41       0 61.5     30  56


				}#3nd of




				#tt=lm(bmi ~ race*edu + edu + ns(age,df=4) + cigstat*race +cigstat*edu + ns(pky,2)*edu+ cigstop +ns(cigyears,2) + ns(cigday,2),
									#data=MYDATA)

				#summary(tt)

		############# [4] Stepwise backward selection ##############################################################

	    #stp=step(lmfull)

		#lmfull2=lm(bmi ~ race + edu + ns(age,df=4) + cigstat*race +cigstat*edu + ns(pky,2)+ ns(cigyears,2) + ns(cigday,2),
		#							data=MYDATA)
} # end 1==0



		####### selected model here ######
		if(Gender=="M"){


            # ## ERIC ADDED ##
            # if ("lmfull2b.rds" %in% list.files()) {
            #   lmfull2b = myfit = readRDS("lmfull2b.rds")
            #   warning("\n Loaded model from lmfull2b.rds!\n")
            # } else {
            #   lmfull2b = myfit = lm(bmi ~ race + edu + ns(age,df=3) + cigstat*race + cigstat*edu + ns(cigyears,df=2) + ns(cigday,df=2),
      # 										data=MYDATA)
            #               gc()
            #   saveRDS(lmfull2b, "lmfull2b.rds", compress=TRUE)
            # }

            # FROM RDS ---------------
            lmfull2b <- lmfull2b.M.BMI

            if (1==0){
			             lmfull2b= myfit = lm(bmi ~ race + edu + ns(age,df=3) + cigstat*race + cigstat*edu + ns(cigyears,df=2) + ns(cigday,df=2),
										data=MYDATA)
            }

	    }#end of


		if(Gender=="F"){

            # FROM RDS ---------------
            lmfull2b <- lmfull2b.F.BMI

            if (1==0) {
			             lmfull2b= myfit = lm(bmi ~ race + edu + ns(age,df=3) + cigstat*edu + ns(cigyears,df=1) + ns(cigday,df=1),
										data=MYDATA)
            }

	    }#end of


		summary(lmfull2b)

				#lmfull2c=lm(bmi ~ race + edu + ns(age,df=4) + cigstat*race +cigstat*edu +  pky + cigyears,
				#					data=MYDATA)

				#summary(lmfull2c)


				#lmfull2c=lm(bmi ~ race + edu + ns(age,df=4) + cigstat*edu +  ns(cigyears,2) + ns(cigday,2),
									#data=MYDATA)
				#summary(lmfull2c)

				#dd<- datadist(lmfull2c, data=MYDATA)
				#options(datadist="dd")

				#
				# Call:
				# lm(formula = bmi ~ race + edu + ns(age, df = 4) + cigstat * race +
				#     cigstat * edu + ns(pky, 2) + ns(cigyears, 2) + ns(cigday,
				#     2), data = MYDATA)
				#
				# Residuals:
				#     Min      1Q  Median      3Q     Max
				# -13.203  -2.694  -0.526   2.107  39.842
				#
				# Coefficients:
				#                          Estimate Std. Error t value Pr(>|t|)
				# (Intercept)              26.34309    0.53712  49.045  < 2e-16 ***
				# raceA                    -1.13667    0.37307  -3.047  0.00231 **
				# raceB                     0.07212    0.22028   0.327  0.74338
				# raceH                     0.08582    0.39957   0.215  0.82993
				# educollege               -0.39880    0.18157  -2.196  0.02807 *
				# edupostcol               -0.31984    0.18850  -1.697  0.08974 .
				# ns(age, df = 4)1         -0.92342    0.43832  -2.107  0.03515 *
				# ns(age, df = 4)2         -1.48918    0.32573  -4.572 4.85e-06 ***
				# ns(age, df = 4)3         -2.23484    1.01950  -2.192  0.02838 *
				# ns(age, df = 4)4         -1.98585    0.18772 -10.579  < 2e-16 ***
				# cigstatFormer             1.86183    0.10567  17.620  < 2e-16 ***
				# cigstatNever              2.60007    0.24705  10.524  < 2e-16 ***
				# ns(pky, 2)1               0.65128    0.94815   0.687  0.49216
				# ns(pky, 2)2              -1.85237    0.73716  -2.513  0.01198 *
				# ns(cigyears, 2)1          0.97746    0.49628   1.970  0.04889 *
				# ns(cigyears, 2)2         -0.47612    0.38456  -1.238  0.21569
				# ns(cigday, 2)1            1.79630    0.69842   2.572  0.01012 *
				# ns(cigday, 2)2            2.62517    0.46777   5.612 2.01e-08 ***
				# raceA:cigstatFormer      -1.04978    0.40350  -2.602  0.00928 **
				# raceB:cigstatFormer       0.23945    0.26580   0.901  0.36766
				# raceH:cigstatFormer      -0.16015    0.44624  -0.359  0.71969
				# raceA:cigstatNever       -1.18496    0.40762  -2.907  0.00365 **
				# raceB:cigstatNever        0.92668    0.29380   3.154  0.00161 **
				# raceH:cigstatNever       -0.30807    0.47511  -0.648  0.51672
				# educollege:cigstatFormer -0.41715    0.19808  -2.106  0.03521 *
				# edupostcol:cigstatFormer -0.65293    0.20451  -3.193  0.00141 **
				# educollege:cigstatNever  -0.41655    0.20336  -2.048  0.04053 *
				# edupostcol:cigstatNever  -0.89230    0.20531  -4.346 1.39e-05 ***
				# ---
				# Signif. codes:  0 *** 0.001 ** 0.01 * 0.05 . 0.1   1
				#
				# Residual standard error: 4.058 on 36080 degrees of freedom
				# Multiple R-squared:  0.06269,	Adjusted R-squared:  0.06199
				# F-statistic: 89.38 on 27 and 36080 DF,  p-value: < 2.2e-16


				## category, not sig ##
				#lmfull3=lm(bmi ~ race + edu + age.cat + cigstat*race +cigstat*edu + ns(pky,2)+ ns(cigyears,2) + ns(cigday,2),
									#data=MYDATA)

				#summary(lmfull3)

	#################### (5) Diagnostics and variable importance #######################

	myfit = lmfull2b

				############# [4b] different selection method using bayesian averaging ##############################################################
	doRelaImpo=F

	if(doRelaImpo==T){
				#library(BMA)

				bma1=bic.glm(formula(myfit) ,data=MYDATA, glm.family=gaussian)
				plot(bma1)
				imageplot.bma(bma1)

				############# [4c] Relative Importance for variables ##############################################################

				#library(relaimpo)
				imp2=calc.relimp(myfit,type=c("lmg"))#,rela=T)#,"last"))#,"first","pratt"),
				tt=plot(imp2)


				# Bootstrap Measures of Relative Importance (1000 samples)
				mybt = boot.relimp(myfit, b = 50, type = "lmg",rank=T,diff=T,rela=T)
				booteval.relimp(mybt) # print result
				#                         lmg
				# race            0.190660635
				# edu             0.174891464
				# ns(age, df = 4) 0.224994098
				# cigstat         0.192538132
				# ns(pky, 2)      0.046350109
				# ns(cigyears, 2) 0.070612331
				# ns(cigday, 2)   0.080951414
				# race:cigstat    0.009608925
				# edu:cigstat     0.009392892

				plot(booteval.relimp(mybt,sort=TRUE)) # plot result
				#                                          Lower  Upper
				#                     percentage 0.95      0.95   0.95
				# race.lmg            0.1907     ABCD_____ 0.1645 0.2167
				# edu.lmg             0.1749     ABCD_____ 0.1456 0.2211
				# ns(age, df = 4).lmg 0.2250     ABC______ 0.1895 0.2646
				# cigstat.lmg         0.1925     ABCD_____ 0.1592 0.2290
				# ns(pky, 2).lmg      0.0464     ______G__ 0.0377 0.0561
				# ns(cigyears, 2).lmg 0.0706     ____EF___ 0.0531 0.0908
				# ns(cigday, 2).lmg   0.0810     ____EF___ 0.0662 0.1013
				# race:cigstat.lmg    0.0096     _______HI 0.0051 0.0248
				# edu:cigstat.lmg     0.0094     _______HI 0.0046 0.0183


				# Relative importance
				#                         lmg
				# race            0.191859970
				# edu             0.178610620
				# ns(age, df = 4) 0.226084240
				# cigstat         0.193327526
				# ns(cigyears, 2) 0.073330278
				# ns(cigday, 2)   0.117725477
				# race:cigstat    0.009902836
				# edu:cigstat     0.009159054

				par(mar=c(5,5,5,3))
				xs=c(0.19,0.17, 0.22, 0.19, 0.07, 0.11, 0.009,0.009)
				names(xs)=c("race","edu","age","cigstat","cig.dur","cig.day","race:cigstat", "edu:cigstat")
				xs2=xs[order(xs,decreasing=T)]
				barplot(xs2, col=heat.colors(length(xs2)), ylab="% of R2", main="Relative Importance of Variables for predicting BMI",
						cex.lab=1.5, cex.axis=1.5, cex.main=1.5)

				#x=c(0.19, 0.17, 0.22, 0.19, 0.04, 0.07, 0.08, 0.009, 0.009)
				#names(x) = c("Race", "Edu", "Age","SmokingStat", "PackYear", "")

	 }#doRelaimpo

				############# [4d] Diagnostic and final model fitting #################################
	doDiagnostic=F
	if(doDiagnostic==T){

				######### investigate residuals ###########
				plot(myfit) ## outlier
				####### I am not happy with

				### detecting outlier
				if(Gender=="M") ix = c(9350, 73267,26370)


				### after outliers
				ix.rmv = row.names(MYDATA) %in% ix

				MYDATA2=MYDATA[!ix.rmv,]
				lmfull3=lm(formula(lmfull2b), data=MYDATA2)



				#### other diagnostic tests #####
				#library(car)

				ncvTest(myfit)
				# Non-constant Variance Score Test
				# Variance formula: ~ fitted.values
				# Chisquare = 502    Df = 1     p = 3.83e-111

				spreadLevelPlot(myfit)
				#
				# Suggested power transformation:  -1.25

				### multicolinearity test ####
				vif(myfit)
				#                  GVIF Df GVIF^(1/(2*Df))
				# race            404.0  3            2.72
				# edu             136.0  2            3.41
				# ns(age, df = 4)   1.1  4            1.01
				# cigstat          62.6  2            2.81
				# ns(pky, 2)      125.0  2            3.34
				# ns(cigyears, 2) 103.6  2            3.19
				# ns(cigday, 2)   116.3  2            3.28
				# race:cigstat    457.3  6            1.67
				# edu:cigstat     271.2  4            2.01

				sqrt(vif(myfit)) > 2  # don't seem problem
				#                  GVIF    Df GVIF^(1/(2*Df))
				# race             TRUE FALSE           FALSE
				# edu              TRUE FALSE           FALSE
				# ns(age, df = 4) FALSE FALSE           FALSE
				# cigstat          TRUE FALSE           FALSE
				# ns(cigyears, 2)  TRUE FALSE           FALSE
				# ns(cigday, 2)    TRUE FALSE           FALSE
				# race:cigstat     TRUE  TRUE           FALSE
				# edu:cigstat      TRUE FALSE           FALSE

				#crPlots(lmfull3)
				# Error in crPlots(lmfull2) :
				#   C+R plots not available for models with interactions.
				#ceresPlots(lmfull2)


				### auto-correlation test##
				#durbinWatsonTest(lmfull2)

				##library(gvlma)
				#gg=gvlma(lmfull2)
				#summary(gg)
	}#doDiagstnoic

	############# [6] Apparent validation (using training data) ##############################################################

	doValidation=F
	if(doValidation==T){

			form = formula(myfit);form
			# bmi ~ race + edu + ns(age, df = 4) + cigstat * race + cigstat *
			#     edu + ns(cigyears, 2) + ns(cigday, 2)


			myfit2 = ols(form, x=T, y=T, data=MYDATA)
			#Function(myfit)

			# Linear Regression Model
			#
			# ols(formula = form, data = MYDATA2, x = T, y = T)
			#                 Model Likelihood     Discrimination
			#                    Ratio Test           Indexes
			# Obs    36105    LR chi2   2340.48    R2       0.063     <------ R-square
			# sigma 4.0458    d.f.           25    R2 adj   0.062
			# d.f.   36079    Pr(> chi2) 0.0000    g        1.169    <-------g-index
			#
			# Residuals


			##### more apparent validation statistics using validate() next (first column)

	############# [7] Cross-validation and bootstrap validation (using training data) ##############################################################


			####### 10-fold cross validation ##############
			B=ceiling(0.1*nrow(MYDATA));B
			csv=validate(myfit2, method="crossvalidation",B=B )

			#           index.orig training    test optimism index.corrected    n
			# R-square      0.0627   0.0627 -0.1005   0.1632         -0.1005 3611 <--- just take the first column
			# MSE          16.4583  16.4583 16.4834  -0.0251         16.4834 3611
			# g             1.1700   1.1700  1.5659  -0.3959          1.5659 3611
			# Intercept     0.0000   0.0000  1.0089  -1.0089          1.0089 3611
			# Slope         1.0000   1.0000  0.9629   0.0371          0.9629 3611

			# > csv
			#           index.orig training   test optimism index.corrected    n ---> female
			# R-square      0.0638   0.0638 -0.122   0.1854          -0.122 3706
			# MSE          28.7316  28.7316 28.754  -0.0224          28.754 3706
			# g             1.4797   1.4797  2.026  -0.5460           2.026 3706
			# Intercept     0.0000   0.0000 -0.568   0.5678          -0.568 3706
			# Slope         1.0000   1.0000  1.021  -0.0211           1.021 3706


			####### 10-fold cross validation using cv.lm for MSE (same results)
			#library(DAAG)

			cv2=cv.lm(data= MYDATA, myfit, m=10) # lm() object, not ols()
			# Sum of squares = 56363    Mean square = 15.6    n = 3610
			#
			# Overall (Sum over all 3610 folds)
			#   ms
			# 16.5

			###### bootstrap
			valboot=validate(myfit2, method="boot",B=30 )
			#           index.orig training    test optimism index.corrected  n
			# R-square      0.0627   0.0631  0.0619   0.0013          0.0614 30 <------
			# MSE          16.4583  16.5034 16.4724   0.0310         16.4273 30 <--- RMSE ~ 4 (bmi +/ 4)
			# g             1.1700   1.1743  1.1612   0.0131          1.1569 30
			# Intercept     0.0000   0.0000  0.3065  -0.3065          0.3065 30
			# Slope         1.0000   1.0000  0.9888   0.0112          0.9888 30

			# > valboot
			#           index.orig training    test optimism index.corrected  n
			# R-square      0.0638   0.0637  0.0634   0.0003          0.0636 30
			# MSE          28.7316  28.7290 28.7441  -0.0151         28.7467 30
			# g             1.4797   1.4787  1.4763   0.0023          1.4774 30
			# Intercept     0.0000   0.0000  0.0364  -0.0364          0.0364 30
			# Slope         1.0000   1.0000  0.9984   0.0016          0.9984 30


	############# [8] External validation (using training data) ##############################################################

			### na.omit for validation data

			mydat.val2 = na.omit(mydat.val)
			# > mydat.val2[1:10,]
			#     bmi     edu race cigstat cigyears cigstop   pky cigday age
			# 3  34.7  <=high    W  Former       35    0_20  35.0     20  62
			# 8  26.6  <=high    H  Former       23   20_40  23.0     20  60
			# 9  24.4 college    W   Never        0   never   0.0      0  67
			# 14 29.9  <=high    W Current       52       0 104.0     40  65
			# 15 24.4  <=high    W   Never        0   never   0.0      0  72


		#lmall=lm(form, data=data.frame(mydatall))


			### predict BMI
			pd = predict(myfit, newdata=mydat.val2)
			# > nrow(mydat.val)
			# [1] 38342
			# > length(pd)
			# [1] 38342

			# > pd[1:10]
			#    3    8    9   14   15   16   18   24   25   26
			# 28.5 28.6 26.7 26.4 27.2 26.5 27.8 28.7 27.5 27.5


			bmi.real = y  = mydat.val2[,"bmi"]
			predicted = yhat = pd

			#plot(bmi.real, predicted,xlim=c(15,65), ylim=c(15,65))
			plot(predicted, bmi.real)
			abline(0,1,col="red")

			plot(bmi.real, predicted)
			abline(0,1,col="red")


			# > mean((bmi.real - predicted)^2)
			# [1] NA
			mse = mean((bmi.real - predicted)^2)
			# [1] 16

			rmse = sqrt(mse); rmse
			#[1] 4


			SSE = sum((y-yhat)^2)
			SST = sum((y-mean(y))^2)

			R2= 1 - SSE/SST
			R2
			#[1] 0.0625


			######### external validation using categories ####
			# A BMI below 18.5 (shown in white) is considered underweight.
			# A BMI of 18.5 to 24.9 (green) is considered healthy.
			# A BMI of 25 to 29.9 (yellow) is considered overweight.
			# A BMI of 30 or higher (red) is considered obese.

			thr=c(25, 30)
			bmi.cat = cut2(bmi.real, thr)
			table(bmi.cat)
			# bmi.cat
			# [15.1,25.0) [25.0,30.0) [30.0,62.6]
			#        9155       17575        7971

			# > levels(bmi.cat)
			# [1] "[15.1,25.0)" "[25.0,30.0)" "[30.0,62.6]"
			levels(bmi.cat)=c("healthy","overweight","obese")

			yhat.cat = cut2(predicted, thr)
			# > table(yhat.cat)
			# [23.3,25.0) [25.0,30.0) [30.0,31.4]
			#         496       33887         318
			levels(yhat.cat)=c("healthy","overweight","obese")

			tb=table(bmi.cat, yhat.cat)
			#             yhat.cat
			# bmi.cat      healthy overweight obese
			#   healthy        286       8838    31
			#   overweight     190      17246   139
			#   obese           20       7803   148


			(sum(tb)-sum(diag(tb)))/sum(tb)
			# > 	(sum(tb)-sum(diag(tb)))/sum(tb)
			# [1] 0.4907063

			# > (sum(tb)-sum(diag(tb)))/sum(tb)
			# [1] 0.631

	}#end of validation





	############# [9] Calibration to NIHS data for 1950 birth cohort ##############################################################

			####### define the model before calibration ###########
			lm.bmi= myfit

			#lm.bmi = lmfull2c
			# lm(formula = bmi ~ race + edu + ns(age, df = 4) + cigstat * race +
			#     cigstat * edu + ns(pky, 2) + ns(cigyears, 2) + ns(cigday,
			#     2), data = MYDATA)
			#
			# Residuals:
			#    Min     1Q Median     3Q    Max
			# -13.20  -2.69  -0.53   2.11  39.84
			#
			# Coefficients:
			#                          Estimate Std. Error t value Pr(>|t|)
			# (Intercept)               26.3431     0.5371   49.05  < 2e-16 ***
			# raceA                     -1.1367     0.3731   -3.05   0.0023 **
			# raceB                      0.0721     0.2203    0.33   0.7434
			# raceH                      0.0858     0.3996    0.21   0.8299
			# educollege                -0.3988     0.1816   -2.20   0.0281 *
			# edupostcol                -0.3198     0.1885   -1.70   0.0897 .
			# ns(age, df = 4)1          -0.9234     0.4383   -2.11   0.0351 *
			# ns(age, df = 4)2          -1.4892     0.3257   -4.57  4.9e-06 ***
			# ns(age, df = 4)3          -2.2348     1.0195   -2.19   0.0284 *
			# ns(age, df = 4)4          -1.9859     0.1877  -10.58  < 2e-16 ***
			# cigstatFormer              1.8618     0.1057   17.62  < 2e-16 ***
			# cigstatNever               2.6001     0.2471   10.52  < 2e-16 ***
			# ns(pky, 2)1                0.6513     0.9481    0.69   0.4922
			# ns(pky, 2)2               -1.8524     0.7372   -2.51   0.0120 *
			# ns(cigyears, 2)1           0.9775     0.4963    1.97   0.0489 *
			# ns(cigyears, 2)2          -0.4761     0.3846   -1.24   0.2157
			# ns(cigday, 2)1             1.7963     0.6984    2.57   0.0101 *
			# ns(cigday, 2)2             2.6252     0.4678    5.61  2.0e-08 ***
			# raceA:cigstatFormer       -1.0498     0.4035   -2.60   0.0093 **
			# raceB:cigstatFormer        0.2395     0.2658    0.90   0.3677
			# raceH:cigstatFormer       -0.1601     0.4462   -0.36   0.7197
			# raceA:cigstatNever        -1.1850     0.4076   -2.91   0.0037 **
			# raceB:cigstatNever         0.9267     0.2938    3.15   0.0016 **
			# raceH:cigstatNever        -0.3081     0.4751   -0.65   0.5167
			# educollege:cigstatFormer  -0.4172     0.1981   -2.11   0.0352 *
			# edupostcol:cigstatFormer  -0.6529     0.2045   -3.19   0.0014 **
			# educollege:cigstatNever   -0.4166     0.2034   -2.05   0.0405 *
			# edupostcol:cigstatNever   -0.8923     0.2053   -4.35  1.4e-05 ***


			##############[2.2] Adjustment to literature #############

			#ref.bmi = c(28.7, 27.7, 28.9); names(ref.bmi)=c("W","B","H") # their average BMI at age = 50 "--Ogden et al. 2004"

					#                   Estimate Std. Error t value Pr(>|t|)
					# (Intercept)      34.039694   0.184366 184.631  < 2e-16 ***
					# edu2.college     -0.773335   0.040464 -19.112  < 2e-16 ***
					# edu2.postcol     -1.073794   0.038824 -27.658  < 2e-16 ***
					# race2.A          -2.212999   0.077216 -28.660  < 2e-16 ***
					# race2.B           0.401026   0.074070   5.414 6.18e-08 ***
					# cigstat2.Current -1.186953   0.052017 -22.819  < 2e-16 ***
					# cigstat2.Former   0.501741   0.033286  15.074  < 2e-16 ***
					# age              -0.098321   0.002882 -34.119  < 2e-16 ***

			###### calculate average BMI at age=50 for W, B and H  (for smoking and education, need to use average within race group ) ###

			mycoef= lm.bmi$coef
			#              (Intercept)                     raceA                     raceB                     raceH                educollege
			#               28.93672095               -2.31458530                1.00499687               -0.21642658               -0.82377975
			#                edupostcol          ns(age, df = 4)1          ns(age, df = 4)2          ns(age, df = 4)3          ns(age, df = 4)4
			#               -1.20668184               -0.92561049               -1.49892646               -2.22674219               -1.98275680
			#            cigstatCurrent             cigstatFormer          ns(cigyears, 2)1          ns(cigyears, 2)2            ns(cigday, 2)1
			#               -2.87579661               -1.02453731                1.67742464               -0.21445874                2.50800835
			#            ns(cigday, 2)2      raceA:cigstatCurrent      raceB:cigstatCurrent      raceH:cigstatCurrent       raceA:cigstatFormer
			#                2.38200835                1.19213242               -0.92341518                0.30620802                0.13587868
			#       raceB:cigstatFormer       raceH:cigstatFormer educollege:cigstatCurrent edupostcol:cigstatCurrent  educollege:cigstatFormer
			#               -0.69128966                0.14281709                0.42260270                0.88265940                0.01160008
			#  edupostcol:cigstatFormer
			#                0.23711154

			#               (Intercept)                     raceA                     raceB                     raceH                educollege
			#                 28.100835                 -3.083767                  3.683110                  0.837670                 -1.341445
			#                edupostcol          ns(age, df = 3)1          ns(age, df = 3)2          ns(age, df = 3)3            cigstatCurrent
			#                 -1.536731                 -0.879970                 -1.470328                 -1.800092                 -2.954600
			#             cigstatFormer                  cigyears                    cigday educollege:cigstatCurrent edupostcol:cigstatCurrent
			#                 -0.946526                  0.000478                  0.048264                  0.387644                  1.041331
			#  educollege:cigstatFormer  edupostcol:cigstatFormer
			#                 -0.044594                  0.096161


			###### to calculate average BMI at age 50 for each race group, something like:
			##### I am using this table as a calibration target ##########################

			# > bmis
			#        W        B        H        A
			# 28.90285 29.08376 28.85288 26.26955


			races = c("W","B","H","A") # no asian data ##

			# 			if(Gender=="M"){
			#
			# 				CPD.50.mean = 6.257271  # from SHG
			#   				cigyears50.mean=15.644
			#
			# 			}#dnd Geder
			#
			# 			if(Gender=="F"){
			#
			# 				CPD.50.mean = 4.192261
			# 				cigyears50.mean = 11.6615
			#
			# 			}#


			####### to calculate the mean BMI for each race group, we need to use the
			## "mean" value of smoking, education to plug in to the prediction model
			## ideally this can be calculated using SHG output ###
					#base0= mycoef[1] + mycoef["age"]*age.ref

            # print("checkpoint: right before getMeanBMI.eachRace!!")

			meanBMI.before = getMeanBMI.eachRace(mycoef, races, PROB.edu.race, MYDATA, Gender,CPD.50.mean, cigyears50.mean)
			meanBMI.before
			#        W        B        H        A  male
			# 28.57139 28.64290 28.46805 26.48046

			#    W    B    H    A   female
			# 27.2 30.8 28.3 23.9

			# > ref.bmi   female
			#    W    B    H
			# 28.3 32.1 30.4

			ref.bmi # male
			#    W    B    H
			# 28.7 27.7 28.9
			#ref.bmi.sd = c(0.3, 0.4, 0.3)
			ci1=ref.bmi - 1.96*ref.bmi.sd
			ci2=ref.bmi + 1.96*ref.bmi.sd

			cbind(meanBMI.before[-4],ref.bmi, ci1, ci2)
			#            ref.bmi    ci1    ci2
			# W 28.57139    28.7 28.112 29.288
			# B 28.64290    27.7 26.916 28.484
			# H 28.46805    28.9 28.312 29.488

			#### female ###

			# > 			cbind(meanBMI.before[-4],ref.bmi, ci1, ci2)
			#        ref.bmi  ci1  ci2
			# W 27.2    28.3 27.5 29.1
			# B 30.8    32.1 31.1 33.1
			# H 28.3    30.4 29.4 31.4


			############# after calibration  #############
			################# calibration ###############
			# > mycoef
			#               (Intercept)                     raceA                     raceB                     raceH                educollege
			#                   28.1008                   -3.0838                    3.6831                    0.8377                   -1.3414
			#                edupostcol          ns(age, df = 3)1          ns(age, df = 3)2          ns(age, df = 3)3            cigstatCurrent
			#                   -1.5367                   -0.8800                   -1.4703                   -1.8001                   -2.9546
			#             cigstatFormer      ns(cigyears, df = 1)        ns(cigday, df = 1) educollege:cigstatCurrent edupostcol:cigstatCurrent
			#                   -0.9465                    0.0369                    6.0196                    0.3876                    1.0413
			#  educollege:cigstatFormer  edupostcol:cigstatFormer
			#                   -0.0446                    0.0962
			# >
			doThis=F
			if(doThis==T){

					## do adjustment of intercept ##
					MYCOEF = mycoef
					#MYCOEF[1]=mycoef[1]*1.025
					MYCOEF[1] = MYCOEF[1]+1.7

					### reduce blace effect ##

					#MYCOEF["raceB"] = mycoef["raceB"]*0.7

					# > mycoef[1]
					# (Intercept)
					#    28.93672

					meanBMI.tmp = getMeanBMI.eachRace(MYCOEF, races, PROB.edu.race, MYDATA, Gender,CPD.50.mean, cigyears50.mean )
					meanBMI.tmp
					ref.bmi

					cbind(ref.bmi, ci1, ci2)

					cbind(meanBMI.tmp[-4],ref.bmi, ci1, ci2)


			}#if(doThis==T){



			mycoef.after = mycoef
			#mycoef.after[1]=mycoef[1]*1.025   # 2% increase in the intercept ##

			if(Gender=="F") mycoef.after[1] = mycoef[1]+1.7  # only correction is
			if(Gender=="M") mycoef.after["raceB"] = mycoef["raceB"]*0.7  # only correction is

			meanBMI.aft = getMeanBMI.eachRace(mycoef.after, races,PROB.edu.race, MYDATA, Gender,CPD.50.mean, cigyears50.mean )
					meanBMI.aft
					ref.bmi

			cbind(model=meanBMI.aft[-4],ref.bmi, ci1, ci2)
			#   model ref.bmi  ci1  ci2
			# W  28.9    28.3 27.5 29.1
			# B  32.5    32.1 31.1 33.1
			# H  30.0    30.4 29.4 31.4




			############# before adjustment ##########
		   if(Gender=="M") YLIM=c(0,35)
		   if(Gender=="F") YLIM=c(0,38)

		  par(mar=c(5,5,5,3))

		   mat=cbind(ref.bmi, meanBMI.before[-4])
		   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="BMI",
		   main="[Before Adjustment] \nAverage BMI (age 50) by race", cex.main=1.5, ylim=YLIM)

		   ##### confidence interval ###
		   xs = c(1.5,4.5,7.5)

		   for(u in 1:length(xs)){


		   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

		   }#end of

		  legend(x="topleft", legend=c("Reference", "Model-based"), fill=c("red","yellow"), ncol=2,cex=1)



			########## after adjutment #########

		   mat=cbind(ref.bmi, meanBMI.aft[-4])
		   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="BMI",
		   main="[After Adjustment] \nAverage BMI (age 50) by race", cex.main=1.5, ylim=YLIM)

		   ##### confidence interval ###
		   xs = c(1.5,4.5,7.5)

		   for(u in 1:length(xs)){

		   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

		   }#end of

		  legend(x="topleft", legend=c("Reference", "Model-based"), fill=c("red","yellow"), ncol=2,cex=1)


					#educ=model.matrix(~ -1+edu,MYDATA )
					# > educ[1:4,]
					#   edu<=high educollege edupostcol
					# 1         1          0          0
					# 2         0          0          1
					# 4         1          0          0
					# 5         0          0          1
					#educ2=educ[,-1] # exclude reference level


			ANS=list(BMI=meanBMI.aft, BMI.ref= ref.bmi, BMI.comp.aft=cbind(model=meanBMI.aft[-4],ref.bmi, ci1, ci2),BMI.comp.before=cbind(model=meanBMI.before[-4],ref.bmi, ci1, ci2), lm.bmi.original = lm.bmi, lm.bmi.coef.adj = mycoef.after )
			ANS

}#3nd of myBMI









#ref.bmi = c(28.7, 27.7, 28.9); names(ref.bmi)=c("W","B","H") # their average BMI at age = 50 "--Ogden et al. 2004"
#age.ref = 50 # calculate BMI at age=50

	myBMI.cond <- function(mydat,  age.ref, ref.bmi, Gender){

			 # fit Pr(BMI | education, race, age and smoking status, stopage, smokingyears..) ###########################################
			#Estimate the distribution from PLCO: time varying BMI by smoking history & prevalence data for BMI for 1950 birth cohort
			#http://www.cdc.gov/nchs/data/ad/ad347.pdf

			######### BMI variables description #####
			# bmi_curr Current BMI
					# Derived from questions 22,23. People who are under 48 inches tall are set to .R. Females who are taller than 78 inches and males who are taller than 84 are also set to .R. Participants who report a weight less than 60 pounds are set to .R. BMI values
					# Numeric
					# .F="No Form" .M="Missing" .R="Out of Range"
			#bmi_curc
					#.F="No Form" .M="Missing" .R="Out of Range" 1="0 - <18.5" 2="18.5 - <25" 3="25 - <30" 4=">=30"



		#####################[0] Define variables ################################################

		##### (1) define smoking status ###########
				# prevalence data: http://en.wikipedia.org/wiki/Prevalence_of_tobacco_consumption
				cigstat=mydat[,"cig_stat"]
				# > table(cig_stat)
				# cig_stat
				#     0     1     2     never, current, former
				# 26855  8581 37260

						tb.cig=table(cigstat)
						round(tb.cig/sum(tb.cig),2)
						# cigstat
						#    0    1    2
						# 0.37 0.12 0.51

				cigstat2=cigstat
				cigstat2[cigstat==0]="Never"
				cigstat2[cigstat==1]="Current"
				cigstat2[cigstat==2]="Former"

				# for polytomous ##
				cigstat3=cigstat
				cigstat3[cigstat==0]="0.Never"
				cigstat3[cigstat==1]="2.Current"
				cigstat3[cigstat==2]="1.Former"



		#### (2) education ########################
		#educat #Education
				# Question 3
				# .F="No Form" .M="Missing"
				# 1="Less than 8 years" 2="8-11 years"
				# 3="12 years or completed high school" 4="Post high school training other than college"
				# 5="Some college"
				# 6="College graduate" 7="Postgraduate"

				edu0=mydat[,"EDUCAT"]
				# edu
				#     1     2     3     4     5     6     7     M
				#   879  5035 13260  8905 14837 13757 15862   161
				# not finished highschool - highschool graduate -college graduate - postgraduate
				#   (1,2)                        (3,4,5)                 6                7

				edu=edu0
				#edu[edu0==1 | edu0==2]=1
				edu[edu0 <=5 ]=1
				edu[edu0==6]=2
				edu[edu0==7]=3
				edu[edu0=="M"]=NA

						tb.edu=table(edu)/sum(table(edu))
						tb.edu
						# edu
						#         1         2         3
						# 0.7016927 0.1504578 0.1478495

	            ## factor variable ##
				edu2=edu
				edu2[edu==1]="<=high"
				edu2[edu==2]="college"
				edu2[edu==3]="postcol"
				tb.edu2=table(edu2)/sum(table(edu2))
				tb.edu2
				# edu2
				#    <=high   college   postcol
				# 0.7016927 0.1504578 0.1478495

						doThis=F
						if(doThis==T){
							edu=edu0
							edu[edu0==1 | edu0==2]=1
							edu[edu0==3 | edu0==4 | edu0==5]=2
							edu[edu0==6]=3
							edu[edu0==7]=4
							edu[edu0=="M"]=NA

							tb.edu=table(edu)
							# edu
							#     1     2     3     4
							#  5914 37002 13757 15862
							# > round(tb.edu/sum(tb.edu),3)
							# edu
							#     1     2     3     4
							# 0.082 0.510 0.190 0.219

							edu2=edu
							edu2[edu==1]="<high"
							edu2[edu==2]="high"
							edu2[edu==3]="college"
							edu2[edu==4]="postcol"

						}#



		####### (3) race #############
				# 1="White, Non-Hispanic" 2="Black, Non-Hispanic" 3="Hispanic"
				# 4="Asian"
				# 5="Pacific Islander" 6="American Indian" 7="Missing"

				race0=mydat[,"race7"]
				# race0
				#     1     2     3     4     5     6     7
				# 64222  3273  1569  2957   452   185    38

				## merge 4-7
				# "white" - "black" - "hispanic" - "asian"
				race=race0
				race[race0>4]=NA
						tb.race=table(race)
						tb.race
						# race
						#     1     2     3     4
						# 64222  3273  1569  3632
						round(tb.race/sum(tb.race),2)
						# race
						# race
						#    1    2    3    4
						# 0.89 0.05 0.02 0.04
				race2=race
				race2[race==1]="W"
				race2[race==2]="B"
				race2[race==3]="H"
				race2[race==4]="A"

	   #### (4) define "Edu-race" variable #############


				race.edu=paste(race2,edu2,sep="-") #[1] "W-<=high"   "NA-college" "W-<=high"   "W-college"  "W-college"
				race.edu[is.na(race2) | is.na(edu2)] = NA
				race.edu=as.factor(as.character(race.edu))

	  #####  (5) BMI ########

      # clean chars ---------------------
      temp <- mydat[,"bmi_curr"]
      temp[temp %in% c("F","M","R")] <- NA
      temp_ <- mydat[,"bmi_curc"]
      temp_[temp_ %in% c("F","M","R")] <- NA

      # bmi=as.numeric(mydat[,"bmi_curr"]) #[1] 38.07647 31.81634 22.69663 27.25385 28.03809 24.19162 30.57929 25.16239 22.28669 23.10435
      bmi=as.numeric(temp)
      # bmicat=as.numeric(mydat[,"bmi_curc"]) #[1] 38.07647 31.81634 22.69663 27.25385 28.03809 24.19162 30.57929 25.16239 22.28669 23.10435
      bmicat=as.numeric(temp_)


	  ####  (6) define age variable

			age=as.numeric(mydat[,"age"])
			# > range(age)
			# [1] 49 78

	 ####### (7) define Smoking related variables ##
			#cig_per_day  of Cigarettes Smoked Per Day
					#The maximum number of cigarettes smoked per day, based on the range specified. The category 81+ is set to 100.

			# cig_years_rnd # of Years Smoked Cigarettes
					# Derived from questions 10-13. This differs from cig_years because it uses randomization age instead of BQ age.
					# Numeric .F="No Form" .M="Missing"
			#cig_stop_rnd # of Years Since Stopped Smoking Cigarettes
					# Derived from questions 12 and 13. This differs from cig_stop because it uses randomization age instead of BQ age.
					# Numeric
					# .F="No Form" .M="Missing" .N="Not Applicable"


			### pack-years ##
			pky0=mydat[,"pack_years_rnd"]
			pky2=pky0
			pky2[pky0=="M"]=NA
			pky2=as.numeric(pky2)
			#[1]   0 260

			### make category (0-10), (10-30), (30-60), (60-100), 100+
			pky=pky2
			pky[pky2 <=10] = "lst10"
			pky[pky2 > 10 & pky2<=30] ="10_30"
			pky[pky2 > 30 & pky2 <=60] = "30_60"
			pky[pky2 > 60 & pky2 <=100] = "60_100"
			pky[pky2>100]="gt100"
			table(pky)
			# pky
			#  10_30  30_60 60_100  gt100  lst10
			#  14808  14932   7212   2261  33430

			#### cigday ##
			cigday0=mydat[,"cig_per_day"]
				# > table(mydat[,"cig_per_day"])
				#
				#    10   100    20    30    40    60    80     M     N
				#  7637   177 16972 10579  6290  3511   668     7 26855   <--- never smoker

				#### group: N, (0-20], (20-40], (40-60], (60,100]

			cigday=cigday0
			cigday[cigday0=="N"]	= "never"
			cigday[cigday0==10 | cigday0==20 ]	= "0_20"
			cigday[cigday0==30 | cigday0==40 ]	= "20_40"
			cigday[cigday0==50 | cigday0==60 ]	= "40_60"
			cigday[cigday0==70 | cigday0==80 | cigday0==90 | cigday0==100]	= "60_100"
			cigday[cigday0=="M"]	= NA

			table(cigday)
			# cigday
			#  20_40  40_60 60_100  lst20  never
			#  16869   3511    845  24609  26855


			## define cigday2 ###

			cigday2=cigday0
			cigday2[cigday0=="N"]=0
			cigday2[cigday0=="M"]=NA
			cigday2=as.numeric(cigday2)


			### define cigstop ###
			cigstop0=mydat[,"cig_stop_rnd"]
			# > #range(as.numeric(cigstop0),na.rm=T)
			# [1]  0 62

			# cigstop0
			#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24    25    26    27    28    29     3
			#  8581   697   825  1191   975   983   975   969  1059   962   858   845   915   750  1217   884   884   911   874  1062  1048  1026   992  1055   728
			#    30    31    32    33    34    35    36    37    38    39     4    40    41    42    43    44    45    46    47    48    49     5    50    51    52
			#  1187  1056   975   904   812   772   623   523   466   414   665   338   342   284   228   209   181   137   117   110    80   810    49    44    24
			#    53    54    55    56    57    58    59     6    62     7     8     9     N
			#    15    15     3     2     3     3     2   785     1   808   805   771 26867
			# > table(cigstop0,cigstat2)
			#         cigstat2
			# cigstop0 Current Former Never
			#      0      8581      0     0  --> current smoker has cigstop=0, yes makes sens
			#      0.5       0    697     0
			# ..
			#      8         0    805     0
			#      9         0    771     0
			#      N         0     12 26855    ---> never smoker nas cigstop="N"

            # F, M, N ------------------------
            temp <- cigstop0
            temp[temp %in% c("F","M","N")] <- NA

			### define: N, 0-20, 20-40, 40+ ##
			# tt=as.numeric(cigstop0)
            tt=as.numeric(temp)

			# > range(tt,na.rm=T)
			# [1]  0 62
			cigstop=cigstop0
			cigstop[cigstop0=="N"]="never"
			cigstop[tt==0] = "0"
			cigstop[tt>0 & tt <=20] = "0_20"
			cigstop[tt >20 & tt<=40] = "20_40"
			cigstop[tt >40 ] = "gt40"

			table(cigstop)
			#              0           0_20          20_40 gt40.neversmok          never
			#           8581          18593          16806           1849          26867
			#boxplot(tt~cigstop)
			cigstop2=tt


			### define cigyears ###

			cigyears0=mydat[,"cig_years_rnd"]
			# > table(cigyears0)
			# cigyears0
			#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24    25    26    27    28    29     3
			# 26855    92   225  1106   752   965   748  1011  1009   815   964   950   930   453  1312   873  1088   946  1058  1028   851   908   935   930   419
			#    30    31    32    33    34    35    36    37    38    39     4    40    41    42    43    44    45    46    47    48    49     5    50    51    52
			#  1034   873  1012   940  1024  1067   977  1137  1124  1255   511  1340  1180  1114  1039   959   838   817   654   607   551   599   490   424   349
			#    53    54    55    56    57    58    59     6    60    61    62    63    64     7     8     9     M
			#   256   205   155    99    83    44    25   599    24    12     4     5     3   662   628   708    46
			tt=as.numeric(mydat[,"cig_years_rnd"])
			# range(tt,na.rm=T)
			# [1]  0 64

			## group:  0-20, 20-40, 40-60
			cigyears=cigyears0
			cigyears[cigyears0=="M"]=NA
			cigyears[tt==0] = "0"
			cigyears[tt >0 & tt <=20] = "0_20"
			cigyears[tt >20 & tt<=40] = "20_40"
			cigyears[tt >40] = "gt40"

			table(cigyears)
			# cigyears
			#     0  0_20 20_40  gt40
			# 26855 15458 20400  9937
			#boxplot(tt~cigyears)

			## cigyears.numeric ##

			cigyears2=cigyears0
			cigyears2[cigyears0=="M"]=NA
			cigyears2=as.numeric(cigyears2)


	############### [1] define matrices & model selection (manually) ######################################

			#mat.cig = cbind(pky=pky, cigstat2)
			#mat.cig=cbind(cigday=cigday, cigstop=cigstop)#, cigyears=cigyears)
			#mat.cig=cbind(cigday=cigday, cigstop=cigstop, cigyears=cigyears)
			# > mat.cig[1:5,]
			#       cigday  cigstop cigyears
			#  [1,] "never" "never" "0"
			#  [2,] "20_40" "0_20"  "0_20"
			#  [3,] "never" "never" "0"
			#  [4,] "never" "never" "0"
			#  [5,] "0_20"  "20_40" "0_20"
			#  [6,] "0_20"  "0"     "gt40"
			#  [7,] "20_40" "20_40" "20_40"
			#  [8,] "never" "never" "0"
			#  [9,] "never" "never" "0"
			# [10,] "0_20"  "0_20"  "20_40"
#COVS=cbind(edu2,race2,cigstat, cigstop, pky)

			mat=cbind(cigstat2,edu2,race2)#,cigday)
			#mat=cbind(edu2,race2,cigday)
			#mat=cbind(edu2,race2)
			# > mat[1:10,]
			#       cigstat2  edu2      race2
			#  [1,] "Never"   "high"    "W"
			#  [2,] "Former"  "college" NA
			#  [3,] "Never"   "high"    "W"
			#  [4,] "Never"   "college" "W"
			#  [5,] "Former"  "college" "W"
			#  [6,] "Current" "<high"   "B"
			#  [7,] "Former"  "high"    "W"
			#  [8,] "Never"   "high"    "W"
			#  [9,] "Never"   "postcol" "W"
			# [10,] "Former"  "high"    "W"

			#matbig=cbind(mat,mat.cig)
			matbig=mat

            #### dummy variables for variables ###

			covs=myDummyVar3(matbig,refer=T,SORT=F)
			# > covs[1:5,]
			#      cigstat2.Current cigstat2.Former cigstat2.Never edu2.<=high edu2.college edu2.postcol race2.A race2.B race2.H race2.W cigday.0_20 cigday.20_40
			# [1,]                0               0              1           1            0            0       0       0       0       1           0            0
			# [2,]                0               1              0           0            1            0      NA      NA      NA      NA           0            1
			# [3,]                0               0              1           1            0            0       0       0       0       1           0            0
			# [4,]                0               0              1           0            1            0       0       0       0       1           0            0
			# [5,]                0               1              0           0            1            0       0       0       0       1           1            0
			#      cigday.40_60 cigday.60_100 cigday.never cigstop.0 cigstop.0_20 cigstop.20_40 cigstop.gt40 cigstop.never cigyears.0 cigyears.0_20 cigyears.20_40
			# [1,]            0             0            1         0            0             0            0             1          1             0              0
			# [2,]            0             0            0         0            1             0            0             0          0             1              0
			# [3,]            0             0            1         0            0             0            0             1          1             0              0
			# [4,]            0             0            1         0            0             0            0             1          1             0              0
			# [5,]            0             0            0         0            0             1            0             0          0             1              0
			#      cigyears.gt40
			# [1,]             0
			# [2,]             0
			# [3,]             0
			# [4,]             0
			# [5,]             0
			colnames(covs)
			# > colnames(covs)
##### do this manually ###
			#refcol=c(1,7,12)
			#refcol=c(3,4,10)
			#refcol=c(3,4,10,15, 16)
			#refcol=c(1,7,12,13)
			#refcol=c(3, 4,10, 15, 16)
			#refcol=c(3, 4,10, 15, 16, 21)

			#exc=c(5,8,9)
			#mycov=mycov[,-exc]

		if(Gender=="M"){

				###### do this manually ###
				cnames=c("edu2","race2","cigstat2")
				covnames=colnames(covs)[multiGrep(cnames,colnames(covs))]
						covnames
						#  [1] "edu2.<=high"  "edu2.college" "edu2.postcol" "race2.A"      "race2.B"      "race2.H"      "race2.W"      "pky.10_30"    "pky.30_60"
						# [10] "pky.60_100"   "pky.gt100"    "pky.lst10"    "bmi"          "age"

						#  [1] "edu2.<=high"  "edu2.college" "edu2.postcol" "race2.A"      "race2.B"      "race2.H"      "race2.W"      "pky.10_30"    "pky.30_60"
						# [10] "pky.60_100"   "pky.gt100"    "pky.lst10"    "bmi"          "age"

						#  [1] "edu2.<=high"      "edu2.college"     "edu2.postcol"     "race2.A"          "race2.B"          "race2.H"          "race2.W"
						#  [8] "cigstat2.Current" "cigstat2.Former"  "cigstat2.Never"   "pky.10_30"        "pky.30_60"        "pky.60_100"       "pky.gt100"
						# [15] "pky.lst10"        "bmi"              "age"
				covs0=covs[,covnames]
				refs=c("edu2.<=high","race2.W","cigstat2.Never")
				refcol=multiGrep(refs,covnames);refcol;refs
				covs2=as.data.frame(cbind(covs0[,-refcol], age=age, bmi=bmi))#, cigyears2=cigyears2))#, mat.cig2))
				# > covs2[1:5,]
				#   cigstat2.Current cigstat2.Former edu2.college edu2.postcol race2.A race2.B race2.H cigday.0_20 cigday.20_40 cigday.40_60 cigday.60_100 cigstop.0
				# 1                0               0            0            0       0       0       0           0            0            0             0         0
				# 2                0               1            1            0      NA      NA      NA           0            1            0             0         0
				# 3                0               0            0            0       0       0       0           0            0            0             0         0
				# 4                0               0            1            0       0       0       0           0            0            0             0         0
				# 5                0               1            1            0       0       0       0           1            0            0             0         0
				#   cigstop.0_20 cigstop.20_40 cigstop.gt40 cigyears.0_20 cigyears.20_40 cigyears.gt40 age      bmi
				# 1            0             0            0             0              0             0  58 38.07647
				# 2            1             0            0             1              0             0  56 31.81634
				# 3            0             0            0             0              0             0  69 22.69663
				# 4            0             0            0             0              0             0  58 27.25385
				# 5            0             1            0             1              0             0  60 28.03809
				# > colnames(covs2)
				# [1] "edu2.college"     "edu2.postcol"     "race2.A"          "race2.B"          "race2.H"          "cigstat2.Current"
				# [7] "cigstat2.Former"  "age"              "bmi"

				## some exclusion
				exc=c(5)
				covs2=covs2[,-exc]

		}#end of Gender==M

		if(Gender=="F"){

					cnames=c("edu2","race2","cigstat2")
					covnames=colnames(covs)[multiGrep(cnames,colnames(covs))]
							covnames
							#  [1] "edu2.<=high"  "edu2.college" "edu2.postcol" "race2.A"      "race2.B"      "race2.H"      "race2.W"      "pky.10_30"    "pky.30_60"
							# [10] "pky.60_100"   "pky.gt100"    "pky.lst10"    "bmi"          "age"

							#  [1] "edu2.<=high"  "edu2.college" "edu2.postcol" "race2.A"      "race2.B"      "race2.H"      "race2.W"      "pky.10_30"    "pky.30_60"
							# [10] "pky.60_100"   "pky.gt100"    "pky.lst10"    "bmi"          "age"

							#  [1] "edu2.<=high"      "edu2.college"     "edu2.postcol"     "race2.A"          "race2.B"          "race2.H"          "race2.W"
							#  [8] "cigstat2.Current" "cigstat2.Former"  "cigstat2.Never"   "pky.10_30"        "pky.30_60"        "pky.60_100"       "pky.gt100"
							# [15] "pky.lst10"        "bmi"              "age"
					covs0=covs[,covnames]
					refs=c("edu2.<=high","race2.W","cigstat2.Never")
					refcol=multiGrep(refs,covnames);refcol;refs

						covs2=as.data.frame(cbind(covs0[,-refcol], age=age, bmi=bmi))#, cigyears2=cigyears2))#, mat.cig2))
						# > covs2[1:5,]
						#   cigstat2.Current cigstat2.Former edu2.college edu2.postcol race2.A race2.B race2.H cigday.0_20 cigday.20_40 cigday.40_60 cigday.60_100 cigstop.0
						# 1                0               0            0            0       0       0       0           0            0            0             0         0
						# 2                0               1            1            0      NA      NA      NA           0            1            0             0         0
						# 3                0               0            0            0       0       0       0           0            0            0             0         0
						# 4                0               0            1            0       0       0       0           0            0            0             0         0
						# 5                0               1            1            0       0       0       0           1            0            0             0         0
						#   cigstop.0_20 cigstop.20_40 cigstop.gt40 cigyears.0_20 cigyears.20_40 cigyears.gt40 age      bmi
						# 1            0             0            0             0              0             0  58 38.07647
						# 2            1             0            0             1              0             0  56 31.81634
						# 3            0             0            0             0              0             0  69 22.69663
						# 4            0             0            0             0              0             0  58 27.25385
						# 5            0             1            0             1              0             0  60 28.03809


					# > colnames(covs2)
					# [1] "edu2.college"     "edu2.postcol"     "race2.A"          "race2.B"          "race2.H"          "cigstat2.Current"
					# [7] "cigstat2.Former"  "age"              "bmi"

			## some exclusion
				exc=c(7)
				covs2=covs2[,-exc]

		}#end of if(Gender=="F"){



			############### [2] Logistic regression fitting #####################################

			#colnames(covs2)=gsub("<=","",colnames(covs2))
			#covs2=na.omit(covs2)

			################ [2.1] Without adjustment ###################################
						doThis=F
						if(doThis==T){
								###### stepwise method for model selection ###
								st0=step(lm0, method="backward")
								picknames=names(st0$coef)[-1]

								covs3=covs2[,c(picknames,"bmi")]
								lm1=lm(bmi~.,data=covs3)
								summary(lm1)

						}#end of doThis

			lm0=lm(bmi~.,data=covs2)
			summary(lm0)
			# Call:
			# lm(formula = bmi ~ ., data = covs2)
			#
			# Residuals:
			#     Min      1Q  Median      3Q     Max
			# -13.384  -2.715  -0.540   2.119  39.833
			#
			# Coefficients:
			#                   Estimate Std. Error t value Pr(>|t|)
			# (Intercept)      34.053063   0.184563 184.506  < 2e-16 ***
			# cigstat2.Current -1.186207   0.052018 -22.804  < 2e-16 ***
			# cigstat2.Former   0.501937   0.033286  15.080  < 2e-16 ***
			# edu2.college     -0.775034   0.040479 -19.147  < 2e-16 ***
			# edu2.postcol     -1.075904   0.038847 -27.696  < 2e-16 ***
			# race2.A          -2.216590   0.077250 -28.694  < 2e-16 ***
			# race2.B           0.396681   0.074121   5.352 8.74e-08 ***
			# race2.H          -0.163636   0.104866  -1.560    0.119
			# age              -0.098463   0.002883 -34.151  < 2e-16 ***
			# ---
			# Signif. codes:  0 *** 0.001 ** 0.01 * 0.05 . 0.1   1
			#
			# Residual standard error: 4.053 on 70765 degrees of freedom
			#   (1922 observations deleted due to missingness)
			# Multiple R-squared:  0.05225,	Adjusted R-squared:  0.05214
			# F-statistic: 487.7 on 8 and 70765 DF,  p-value: < 2.2e-16


			#### cannot use stepwise method here since once one category of a variable is significant,
			  # ALL other levels should be included, otherwise, the rest of the levels are automatically merged as ONE GROUP!!!

			## here criteria is: include a variable if at least one level is p < 0.05 ###
			### do this mannually: due to correlation among smoking related variables, it's hard to manage it automatically ####

			# > colnames(covs2)
			#  [1] "cigstat2.Current" "cigstat2.Former"  "edu2.college"     "edu2.postcol"     "race2.A"          "race2.B"          "race2.H"
			#  [8] "cigday.0_20"      "cigday.20_40"     "cigday.40_60"     "cigday.60_100"    "cigstop.0_20"     "cigstop.20_40"    "cigstop.gt40"
			# [15] "cigstop.never"    "cigyears.0_20"    "cigyears.20_40"   "cigyears.gt40"    "age"              "bmi"

			#setwd(outdir)

			#lm1=lm0
			#dist2=rep(list(list()),2)
			#names(dist2)=c("all","select")
			#dist2[[1]]=summary(lm0)
			#dist2[[2]]=summary(lm1)
			lm.bmi= lm0


			##############[2.2] Adjustment to literature #############

			#ref.bmi = c(28.7, 27.7, 28.9); names(ref.bmi)=c("W","B","H") # their average BMI at age = 50 "--Ogden et al. 2004"
			#                   Estimate Std. Error t value Pr(>|t|)
			# (Intercept)      34.039694   0.184366 184.631  < 2e-16 ***
			# edu2.college     -0.773335   0.040464 -19.112  < 2e-16 ***
			# edu2.postcol     -1.073794   0.038824 -27.658  < 2e-16 ***
			# race2.A          -2.212999   0.077216 -28.660  < 2e-16 ***
			# race2.B           0.401026   0.074070   5.414 6.18e-08 ***
			# cigstat2.Current -1.186953   0.052017 -22.819  < 2e-16 ***
			# cigstat2.Former   0.501741   0.033286  15.074  < 2e-16 ***
			# age              -0.098321   0.002882 -34.119  < 2e-16 ***

			###### calculate average BMI at age=50 for W, B and H  (for smoking and education, need to use average within race group ) ###

			mycoef= lm.bmi$coef
			#      (Intercept)     edu2.college     edu2.postcol          race2.A          race2.B
			#      34.03969380      -0.77333523      -1.07379415      -2.21299870       0.40102572
			# cigstat2.Current  cigstat2.Former              age
			#      -1.18695318       0.50174093      -0.09832138

			# > mycoef  # female
			#      (Intercept)     edu2.college     edu2.postcol          race2.A          race2.B          race2.H
			#      33.06073481      -1.37277155      -1.46025225      -3.08817240       3.48978740       0.77774940
			# cigstat2.Current              age
			#      -1.78638665      -0.08707948


			races = c("W","B","H","A") # no asian data ##

			for(i in 1:length(races)){

					rc=races[i] # [1] "W"

					rc.cof=NULL
					if(Gender=="M") if((rc=="B" | rc=="A") & Gender=="M" ) rc.cof = paste("race2.", rc,sep="") # [1] "race2.B # W and H are reference group
					if(Gender=="F") if((rc=="B" | rc=="A" | rc=="H") & Gender=="F" ) rc.cof = paste("race2.", rc,sep="") # [1] "race2.B # W and H are reference group

					######## White and age 50 ####

					### calculate their smoking weight from the population prob data ##
					# > PROB.edu.race
					#            X       Never      Former      Current
					# 1   A-<=high 0.006869456 0.005920198 0.0026915393
					# 2  A-college 0.010973770 0.006783825 0.0025941503
					# 3  A-postcol 0.012505975 0.005348253 0.0014142967
					# 4   B-<=high 0.026062442 0.028510850 0.0342760269
					# 5  B-college 0.004168923 0.002654191 0.0029847328
					# 6  B-postcol 0.005759631 0.003543701 0.0017651573
					# 7   H-<=high 0.020747819 0.021689718 0.0167066889
					# 8  H-college 0.002628717 0.002483404 0.0005324074
					# 9  H-postcol 0.003336251 0.001913052 0.0007976879
					# 10 W-college 0.058319514 0.043691226 0.0188210937
					# 11 W-postcol 0.021635333 0.010940028 0.0038560209
					# 12  W-<=high 0.196992169 0.266521555 0.1435601979

					### take subset for the given race
					TB.w0 = PROB.edu.race[grep(rc,as.character(PROB.edu.race[,"X"])),]; TB.w0
					#            X      Never     Former    Current
					# 10 W-college 0.15762031 0.10922807 0.08183084
					# 11 W-postcol 0.05847387 0.02735007 0.01676531
					# 12  W-<=high 0.53241127 0.66630389 0.62417477

					## exclude first column
					TB.w = TB.w0[,-1]
					row.names(TB.w)=as.character(TB.w0[,1])
					TB.w
					#                Never     Former    Current
					# W-college 0.15762031 0.10922807 0.08183084
					# W-postcol 0.05847387 0.02735007 0.01676531
					# W-<=high  0.53241127 0.66630389 0.62417477

					## make education distributuion and smoking distribution withn this race (NORMALIZED to be 1)
					tb.edu=rowSums(TB.w)/sum(TB.w); tb.edu
					tb.smk=colSums(TB.w)/sum(TB.w); tb.smk
					# > tb.edu
					#  W-college  W-postcol   W-<=high   ----> edu dist within white
					# 0.15808709 0.04766402 0.79424889
					# > tb.smk
					#     Never    Former   Current   ---> smoking dist within white
					# 0.3623362 0.4201717 0.2174921

					############ calculate average BMI at age=50 for W, B and H  ############

			 		### base effect with just age=50 ##
					base0= mycoef[1] + mycoef["age"]*age.ref


					######### adding education effect with white population value ###
					### average education value: inner product of  coefficient and weight ##
					edu.ave = sum( mycoef[c("edu2.college", "edu2.postcol")]  * (tb.edu[c(grep("college",names(tb.edu)), c(grep("postcol",names(tb.edu))))]) ); edu.ave
					# > edu.ave
					# [1] -0.1734357
					# > tb.edu[c(grep("college",names(tb.edu)), c(grep("postcol",names(tb.edu))))]
					#  W-college  W-postcol
					# 0.15808709 0.04766402
					# > mycoef[c("edu2.college", "edu2.postcol")]
					# edu2.college edu2.postcol
					#   -0.7733352   -1.0737942

					######## adding smoking effect with white population average value ##
					### average smoking value ##
					# > tb.smk
					# 	Never    Former   Current
					# 0.3623362 0.4201717 0.2174921
					# > mycoef[c("cigstat2.Former", "cigstat2.Current")]
					#  cigstat2.Former cigstat2.Current
					#        0.5017409       -1.1869532
					# inner product
					if(Gender=="M") smk.ave = sum(   mycoef[c("cigstat2.Former", "cigstat2.Current")]  * tb.smk[c("Former","Current")]   )
					if(Gender=="F") smk.ave = sum(   mycoef[c("cigstat2.Current")]  * tb.smk[c("Current")]   )
					smk.ave
					#smk.ave
					#[1] -0.04733565


					#####  adding race effect ###########

					race.eff = 0

					if( (rc=="B" | rc=="A") & Gender=="M")  race.eff = mycoef[rc.cof]
					if( (rc=="B" | rc=="A" | rc=="H") & Gender=="F")  race.eff = mycoef[rc.cof]

					race.eff
					# > mycoef[rc.cof]
					#   race2.B
					# 0.4010257


					aver = base0 + edu.ave + smk.ave + race.eff
					aver
					# (Intercept)
					#    28.90285

					if(i==1) bmis = (aver)
					if(i>1) bmis = c(bmis,aver)


			}#end of for(i in 1:length(races)){

			names(bmis)=races; bmis
			# > bmis
			#        W        B        H        A
			# 28.90285 29.08376 28.85288 26.26955


			TAB=bmis
			barplot(TAB,col=(heat.colors(4)),ylim=c(0,37),main="(Unadjusted) Average Body Mass Index",cex.axis=1.5,cex.lab=2,cex.main=1.5)
			text(1:length(TAB),TAB+3,round(TAB,1),cex=2,col="blue")


			#### reference BMI from litature ####

			TAB=ref.bmi
			barplot(TAB,col=(heat.colors(4)),ylim=c(0,37),main="(Ref) Average Body Mass Index",cex.axis=1.5,cex.lab=2,cex.main=1.5)
			text(1:length(TAB),TAB+3,round(TAB,2),cex=2,col="blue")


			########### plot excluding asian (since reference doens't have asian) ####

					TAB=bmis[-4]
					barplot(TAB,col=(heat.colors(4)),ylim=c(0,37),main="(Unadjusted) Average Body Mass Index",cex.axis=1.5,cex.lab=2,cex.main=1.5)
					text(1:length(TAB),TAB+3,round(TAB,1),cex=2,col="blue")


					#### reference BMI from litature ####

					TAB=ref.bmi
					barplot(TAB,col=(heat.colors(4)),ylim=c(0,37),main="(Ref) Average Body Mass Index",cex.axis=1.5,cex.lab=2,cex.main=1.5)
					text(1:length(TAB),TAB+3,round(TAB,2),cex=2,col="blue")



			ANS=list(BMI=bmis, BMI.ref= ref.bmi, lm.bmi = lm.bmi, lm.bmi.coef = summary(lm.bmi))
			ANS


}#end of myBMI.given <- function(){



########## 5/1/2017: incorporating female models ###
########## 6/22/2016: First time incorporating personal history incorporate external and cross validation and other metrics (and updated data)	###
####### PLCO directory in: "dictionary_plco-146.riskfactorsimulator.jul15.d090115.rtf" at:

myPH.cond<- function(    ref.ph, ref.ph.ci, ref.pky.mean.55, ref.bmi.mean.55, ref.edu, ref.race, ref.smk, Gender){  # fit family history

		############ Fit Pr(Family history of lung cancer| gender, race, age, education, smoking) ##########################
					#logistic regression using PLCO data and offsets using prevalence data for FH

		# lung_fh Family History of Lung Cancer?
				# Derived from question 21
				# .F="No Form"
				# .M="Missing"
				# 0="No"
				# 1="Yes, immediate family member" 9="Possibly - relative or cancer type not clear"

if (1==0) {
		#####################[0] Define variables ################################################

		##### (1) define smoking status ###########
				# prevalence data: http://en.wikipedia.org/wiki/Prevalence_of_tobacco_consumption
				cigstat=mydat[,"cig_stat"]
				# > table(cigstat)
				# cig_stat

				#     0     1     2     A     F     M     #A is ambiguous -- will put in former then
				# 26917  8659 38256     1  2826    23

				# .A="Ambiguous"
				# .F="No Form"
				# .M="Not Answered"
				# 0="Never Smoked Cigarettes"
				# 1="Current Cigarette Smoker"
				# 2="Former Cigarette Smoker"

				tb.cig=table(cigstat)
				round(tb.cig/sum(tb.cig),2)
				# cigstat
				#    0    1    2
				# 0.37 0.12 0.51

				cigstat2=cigstat
				cigstat2[cigstat=="0"]="Never"
				cigstat2[cigstat=="1"]="Current"
				cigstat2[cigstat=="2"]="Former"
				cigstat2[cigstat=="A"]= NA
				cigstat2[cigstat=="F"]= NA
				cigstat2[cigstat=="M"]= NA
						# > table(cigstat2)
						# cigstat2
						# Current  Former   Never
						#    8659   38256   26917

				# for polytomous ##
				cigstat3=cigstat2
				cigstat3[cigstat==0]="0.Never"
				cigstat3[cigstat==1]="2.Current"
				cigstat3[cigstat==2]="1.Former"

					# > table(cigstat3)
					# cigstat3
					#   0.Never  1.Former 2.Current
					#     26917     38256      8659


		ix.na.smk = is.na(cigstat2)==T
		# > sum(ix.na.smk)
		# [1] 2850   ---> need to exclude them


		#### (2) education ########################
		#educat #Education
				# Question 3
				# .F="No Form" .M="Missing"
				# 1="Less than 8 years" 2="8-11 years"
				# 3="12 years or completed high school" 4="Post high school training other than college"
				# 5="Some college"
				# 6="College graduate" 7="Postgraduate"

				edu0=mydat[,"educat"]
				table(edu0)
				# edu0
				#     1     2     3     4     5     6     7     F     M
				#   923  5172 13484  9048 15067 13912 16037  2826   213

				# not finished highschool - highschool graduate -college graduate - postgraduate
				#   (1,2)                        (3,4,5)                 6                7

				edu=edu0
				#edu[edu0==1 | edu0==2]=1
				edu[edu0 <=5 ]=1
				edu[edu0==6]=2
				edu[edu0==7]=3
				edu[edu0=="M" | edu0=="F"]=NA

						tb.edu=table(edu)/sum(table(edu))
						tb.edu
						# edu
						#         1         2         3
						# 0.7016927 0.1504578 0.1478495
						# > table(edu)
						# edu
						#     1     2     3
						# 43694 13912 16037

	            ## factor variable ##
				edu2=edu
				edu2[edu==1]="<=high"
				edu2[edu==2]="college"
				edu2[edu==3]="postcol"
				tb.edu2=table(edu2)/sum(table(edu2))
				tb.edu2
				# edu2
				#    <=high   college   postcol
				# 0.7016927 0.1504578 0.1478495

						doThis=F
						if(doThis==T){
							edu=edu0
							edu[edu0==1 | edu0==2]=1
							edu[edu0==3 | edu0==4 | edu0==5]=2
							edu[edu0==6]=3
							edu[edu0==7]=4
							edu[edu0=="M"]=NA

							tb.edu=table(edu)
							# edu
							#     1     2     3     4
							#  5914 37002 13757 15862
							# > round(tb.edu/sum(tb.edu),3)
							# edu
							#     1     2     3     4
							# 0.082 0.510 0.190 0.219

							edu2=edu
							edu2[edu==1]="<high"
							edu2[edu==2]="high"
							edu2[edu==3]="college"
							edu2[edu==4]="postcol"

						}#



		####### (3) race #############
				# 1="White, Non-Hispanic" 2="Black, Non-Hispanic" 3="Hispanic"
				# 4="Asian"
				# 5="Pacific Islander" 6="American Indian" 7="Missing"

				# 1="White, Non-Hispanic"
				# 2="Black, Non-Hispanic"
				# 3="Hispanic"
				# 4="Asian"
				# 5="Pacific Islander"
				# 6="American Indian"
				# 7="Missing"
				race0=mydat[,"race7"]
					table(race0)
					# race0
					#     1     2     3     4     5     6     7
					# 64222  3273  1569  2957   452   185    38
					#
					#     1     2     3     4     5     6     7
					# 65178  3370  1603  3009   464   187  2871
					#
				## merge 4-7
				# "white" - "black" - "hispanic" - "asian"
				race=race0
				race[race0>4]=NA
						tb.race=table(race)
						tb.race
						# race
						#     1     2     3     4
						# 64222  3273  1569  3632
						round(tb.race/sum(tb.race),2)
						# race
						# race
						#    1    2    3    4
						# 0.89 0.05 0.02 0.04
				race2=race
				race2[race==1]="W"
				race2[race==2]="B"
				race2[race==3]="H"
				race2[race==4]="A"
					#table(race2)
					#     A     B     H     W
					#  3009  3370  1603 65178
	   #### (4) define "Edu-race" variable #############


				race.edu=paste(race2,edu2,sep="-") #[1] "W-<=high"   "NA-college" "W-<=high"   "W-college"  "W-college"
				race.edu[is.na(race2) | is.na(edu2)] = NA
				race.edu=as.factor(as.character(race.edu))

	  #####  (5) BMI ########

          # clean chars ---------------------
          temp <- mydat[,"bmi_curr"]
          temp[temp %in% c("F","M","R")] <- NA
          temp_ <- mydat[,"bmi_curc"]
          temp_[temp_ %in% c("F","M","R")] <- NA

          # bmi=as.numeric(mydat[,"bmi_curr"]) #[1] 38.07647 31.81634 22.69663 27.25385 28.03809 24.19162 30.57929 25.16239 22.28669 23.10435
          bmi=as.numeric(temp)
          # bmicat=as.numeric(mydat[,"bmi_curc"]) #[1] 38.07647 31.81634 22.69663 27.25385 28.03809 24.19162 30.57929 25.16239 22.28669 23.10435
          bmicat=as.numeric(temp_)
			### some NA's for F, M, R... missing values
# Q: should I do missing value imputation?
			#            2            1            1            1            1            1            1            1            1
			# 66.317197494            F            M            R
			#            1         2826         1071          147

	  ####  (6) define age variable

			age=as.numeric(mydat[,"age"])
					range(age)
					# [1] 49 78
			#library(Hmisc)
			age.cat = cut2(age, cuts=c(55, 60, 65, 70, 75))
			# > table(age.cat)
			# age.cat
			# [49,55) [55,60) [60,65) [65,70) [70,75) [75,78]
			#       9   24750   24023   17763   10133       4

				# > levels(age.cat)
				# [1] "[49,55)" "[55,60)" "[60,65)" "[65,70)" "[70,75)" "[75,78]"
			levels(age.cat)= c("lt55","55_60","60_65","65_70","70_75","85+")

			#age.cat = cut2(age,

	 ####### (7) define Smoking related variables ##
			#cig_per_day  of Cigarettes Smoked Per Day
					#The maximum number of cigarettes smoked per day, based on the range specified. The category 81+ is set to 100.

			# cig_years_rnd # of Years Smoked Cigarettes
					# Derived from questions 10-13. This differs from cig_years because it uses randomization age instead of BQ age.
					# Numeric .F="No Form" .M="Missing"
			#cig_stop_rnd # of Years Since Stopped Smoking Cigarettes
					# Derived from questions 12 and 13. This differs from cig_stop because it uses randomization age instead of BQ age.
					# Numeric
					# .F="No Form" .M="Missing" .N="Not Applicable"


			### pack-years ##
			pky0=mydat[,"pack_years"]
			#pky0=mydat[,"pack_years_rnd"]
			pky2=pky0
			pky2[pky0=="M" | pky0=="F"]=NA
			pky2=as.numeric(pky2)
			#[1]   0 260
			#   9.5    90    92    93    94  94.5    95    96    98    99     F     M
			#   138   268   150   104   100     1     5   231    72    87  2826  1123

			### make category (0-10), (10-30), (30-60), (60-100), 100+
			pky=pky2
			pky[pky2 <=10] = "lst10"
			pky[pky2 > 10 & pky2<=30] ="10_30"
			pky[pky2 > 30 & pky2 <=60] = "30_60"
			pky[pky2 > 60 & pky2 <=100] = "60_100"
			pky[pky2>100]="gt100"
			table(pky)
			# pky
			#  10_30  30_60 60_100  gt100  lst10
			#  14808  14932   7212   2261  33430

			#### cigday ##
			# F="No Form"
			# .M="Missing"
			# 0="0"
			# 1="1-10"
			# 2="11-20"
			# 3="21-30"
			# 4="31-40"
			# 5="41-60"
			# 6="61-80"
			# 7="81+"

			cigday0=mydat[,"cigpd_f"]
				table(cigday0)
				# cigday0
				#     0     1     2     3     4     5     6     7     F     M
				# 26917  7853 17302 10783  6409  3591   685   184  2826   132

			### put maximum value not category
			cigday00 = cigday0
			cigday00[cigday0=="1"] = 10
			cigday00[cigday0=="2"] = 20
			cigday00[cigday0=="3"] = 30
			cigday00[cigday0=="4"] = 40
			cigday00[cigday0=="5"] = 60
			cigday00[cigday0=="6"] = 80
			cigday00[cigday0=="7"] = 100
			cigday00[cigday0=="F" | cigday0=="M"] = NA

				table(cigday00)
				# cigday00
				#     0    10   100    20    30    40    60    80
				# 26917  7853   184 17302 10783  6409  3591   685

							# old PCA data (more accurate i guess,but new data don't have this 3/16/2016)
							#cigday0=mydat[,"cig_per_day"]
								# > table(mydat[,"cig_per_day"])
								#
								#    10   100    20    30    40    60    80     M     N
								#  7637   177 16972 10579  6290  3511   668     7 26855   <--- never smoker

			#### group: N, (0-20], (20-40], (40-60], (60,100]

			cigday=cigday00
			cigday[cigday00=="0"]	= "never"
			cigday[cigday00==10 | cigday00==20 ]	= "0_20"
			cigday[cigday00==30 | cigday00==40 ]	= "20_40"
			cigday[cigday00==50 | cigday00==60 ]	= "40_60"
			cigday[cigday00==70 | cigday00==80 | cigday00==90 | cigday00==100]	= "60_100"
			cigday[cigday00=="M"]	= NA

			table(cigday)
			# cigday
			#   0_20  20_40  40_60 60_100  never
			#  25155  17192   3591    869  26917

							# cigday
							#  20_40  40_60 60_100  lst20  never
							#  16869   3511    845  24609  26855


			## define cigday2 ###

			cigday2=cigday00
			cigday2[cigday00=="N"]=0
			cigday2[cigday00=="M"]=NA
			cigday2=as.numeric(cigday2)


			### define cigstop ###
			# Numeric
			# .F="No Form"
			# .M="Not Answered"
			# .N="Not Applicable"
			# 0.5="Six Months"

			cigstop0=mydat[,"cig_stop"]
			#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24
			#  8659   702   843  1206   984   989   982   971  1070   979   863   858   894   755  1235   899   889   910   871
			#    25    26    27    28    29     3    30    31    32    33    34    35    36    37    38    39     4    40    41
			#  1076  1050  1020  1024  1062   734  1191  1057   973   905   825   763   641   540   465   420   675   344   341
			#    42    43    44    45    46    47    48    49     5    50    51    52    53    54    55    56    57    58    59
			#   296   222   215   178   148   113   112    86   808    48    44    30    16    15     4     3     3     3     1
			#     6    60    62     7     8     9     F     M     N
			#   798     1     1   801   823   774  2826   731 26917
			# >
			#cigstop0=mydat[,"cig_stop_rnd"]
			#range(as.numeric(cigstop0),na.rm=T)
			# [1]  0 62
			# Warning cat:
			# NAs introduced by coercion

			# cigstop0
			#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24    25    26    27    28    29     3
			#  8581   697   825  1191   975   983   975   969  1059   962   858   845   915   750  1217   884   884   911   874  1062  1048  1026   992  1055   728
			#    30    31    32    33    34    35    36    37    38    39     4    40    41    42    43    44    45    46    47    48    49     5    50    51    52
			#  1187  1056   975   904   812   772   623   523   466   414   665   338   342   284   228   209   181   137   117   110    80   810    49    44    24
			#    53    54    55    56    57    58    59     6    62     7     8     9     N
			#    15    15     3     2     3     3     2   785     1   808   805   771 26867
					# > table(cigstop0,cigstat2)
					#         cigstat2
					# cigstop0 Current Former Never
					#      0      8581      0     0  --> current smoker has cigstop=0, yes makes sens
					#      0.5       0    697     0
					# ..
					#      8         0    805     0
					#      9         0    771     0
					#      N         0     12 26855    ---> never smoker nas cigstop="N"

            # F, M, N ------------------------
            temp <- cigstop0
            temp[temp %in% c("F","M","N")] <- NA

			### define: N, 0-20, 20-40, 40+ ##
			# tt=as.numeric(cigstop0)
            tt=as.numeric(temp)
			# > range(tt,na.rm=T)
			# [1]  0 62
			cigstop=cigstop0
			cigstop[cigstop0=="N"]="never"
			cigstop[tt==0] = "0"
			cigstop[tt>0 & tt <=20] = "0_20"
			cigstop[tt >20 & tt<=40] = "20_40"
			cigstop[tt >40 ] = "gt40"

			cigstop[cigstop=="F" | cigstop=="M" ] = NA

			table(cigstop)
			# cigstop
			#     0  0_20 20_40  gt40 never
			#  8659 18744 16925  1880 26917

					#              0           0_20          20_40 gt40.neversmok          never
					#           8581          18593          16806           1849          26867
					#boxplot(tt~cigstop)
			### numeric variables ##
			cigstop2=tt


			### define cigyears ###
			# Numeric
			# .F="No Form"
			# .M="Not Answered"
			# 0.5="Six Months"
			cigyears0=mydat[,"cig_years"]
			#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24
			# 26917    91   222  1107   753   971   748  1012  1012   816   970   954   931   454  1313   872  1093   947  1057
			#    25    26    27    28    29     3    30    31    32    33    34    35    36    37    38    39     4    40    41
			#  1030   851   909   938   931   421  1033   876  1014   946  1023  1061   984  1138  1130  1255   512  1340  1189
			#    42    43    44    45    46    47    48    49     5    50    51    52    53    54    55    56    57    58    59
			#  1101  1046   963   845   824   657   608   546   603   501   426   346   262   206   159    98    85    44    25
			#     6    60    61    62    63    64     7     8     9     F     M
			#   600    24    11     4     6     3   662   630   709  2826  1041

					#cigyears0=mydat[,"cig_years_rnd"]
					# > table(cigyears0)
					# cigyears0
					#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24    25    26    27    28    29     3
					# 26855    92   225  1106   752   965   748  1011  1009   815   964   950   930   453  1312   873  1088   946  1058  1028   851   908   935   930   419
					#    30    31    32    33    34    35    36    37    38    39     4    40    41    42    43    44    45    46    47    48    49     5    50    51    52
					#  1034   873  1012   940  1024  1067   977  1137  1124  1255   511  1340  1180  1114  1039   959   838   817   654   607   551   599   490   424   349
					#    53    54    55    56    57    58    59     6    60    61    62    63    64     7     8     9     M
					#   256   205   155    99    83    44    25   599    24    12     4     5     3   662   628   708    46
			#tt=as.numeric(mydat[,"cig_years"])
			# range(tt,na.rm=T)
			# [1]  0 64

			## group:  0-20, 20-40, 40-60
			cigyears=cigyears0
			cigyears[cigyears0=="M" | cigyears0=="F"]=NA
			cigyears[tt==0] = "0"
			cigyears[tt >0 & tt <=20] = "0_20"
			cigyears[tt >20 & tt<=40] = "20_40"
			cigyears[tt >40] = "gt40"

			table(cigyears)
			# cigyears
			#     0  0_20 20_40  gt40
			# 26917 15491 20428  9979


						# cigyears
						#     0  0_20 20_40  gt40
						# 26855 15458 20400  9937
						#boxplot(tt~cigyears)

			## cigyears.numeric ##

			cigyears2=cigyears0
			cigyears2[cigyears0=="M" |cigyears0=="F" ]=NA
			cigyears2=as.numeric(cigyears2)



	####### (8) family history of lung cancer ############################################

		# Lung cancer family history in first-degree relatives. Includes parents, full-siblings, and children.
		# .F="No Form"
		#.M="Missing"
		#0="No"1="Yes, Immediate Family Member
		#"9="Possibly - Relative Or Cancer Type Not Clear"

		fh0=mydat[,"lung_fh"]
		# fh0
		#     0     1     9     F     M
		# 63729  6964  2506  2826   657

		# fh0
		#     0     1     9     M
		# 62796  6851  2453   596

		fh=fh0
		fh[fh0=="9" | fh0=="M" | fh0=="F"]=NA
		fh=as.numeric(fh)
		tb.fh=table(fh)/sum(table(fh))
		tb.fh
		# fh
		#          0          1
		# 0.90163252 0.09836748
		#          0          1
		# 0.90148954 0.09851046

		# > sum(is.na(fh))/length(fh)
		# [1] 0.07810177


	####### (8) Personal history of lung cancer ############################################

		# trial_ph_any
		# Personal History of Any Cancer Prior to Trial Entry
		# Was the participant diagnosed with any cancer prior to trial entry (randomization)?
		# 0="No"1="Yes"9="Unknown - BQ History Unknown and No Cancer History From Another Source"


		# ph_first_cancer
		# First type of personal history cancer reported on BQ, ATF, or MDF
					# .M="Missing"
					# .N="N/A - No Cancer or Fewer Than This Many Cancers"
					# 1="Abdomen"
					# 2="Adrenal Glands"
					# 3="Bladder"
					# 4="Bone"
					# 5="Brain"
					# 6="Breast"
					# 7="Cervical"

		# ph_first_cancer_age
		# Age of first type of personal history cancer reported on BQ, ATF, or MDF
		# Age of first personal history cancer reported by participant.
		# Numeric.M="Missing".N="No Cancer"


		ph0=mydat[,"trial_ph_any"]
		# > table(ph0)
		# ph0
		#     0     1     9
		# 72152  1693  2837

		ph=ph0
		ph[ph0=="9"]=NA
		ph=as.numeric(ph)
		tb.ph=table(ph)/sum(table(ph))
		tb.ph

		# ph
		#         0         1
		# 0.9770736 0.0229264


		####### age of ph ##################

		###### how should I incorporate this first age of ph?
		# ph_first_cancer_age
		# Age of first type of personal history cancer reported on BQ, ATF, or MDF
		# Age of first personal history cancer reported by participant.
		# Numeric.M="Missing".N="No Cancer"

		phage0 = mydat[,"ph_first_cancer_age"]
		# > table(phage)
		# phage
		#     1    10    15    17    18    19    20    21    22    23    24    25    26    27    28    29    30    31    32    33
		#     4     1     2     2     3     2     2     4     2     2     3     2     7     6     9     8    12     6    10    14
		#    34    35    36    37    38    39     4    40    41    42    43    44    45    46    47    48    49     5    50    51
		#    12    14    10     7    17    16     2    34    10    19    16    20    34    12    29    40    37     2    84    43
		#    52    53    54    55    56    57    58    59    60    61    62    63    64    65    66    67    68    69     7    70
		#    61    44    60    80    64    70    67    75    70    51    63    51    53    63    42    34    24    29     1    28
		#    71    72    73    74    75   999     M     N
		#    14    21     5     8     1     7   109 74928
		# > phage[1:5]
		# [1] "N" "N" "N" "N" "N"

		### dealing with missing ###

		phage=phage0
		phage[phage0=="M" | phage0=="999"]=NA

		#### define who did not have ph event #####

		### Time to event analysis "N" is who did not have PH cancer --> so put the current trial age ##
		ix.noph = phage0=="N"
		sum(ix.noph)
		#[1] 74928

		### compare no-ph using two variabels
		# > table(ph)
		# ph
		#     0     1
		# 72152  1693   ---> slight less than 74928


		# > table(ph, exclude=NULL)
		# ph
		#     0     1  <NA>
		# 72152  1693  2837   ----> somehow this NAs (some said I don't know) was actually "no cancer"

		##### OK, looks like who said NA (i don't know) in ph actually reported no cancer,so update this
		### update ph variable to be consistent #####
		ph[ix.noph]=0
		table(ph, exclude=NULL)
		# ph
		#     0     1  <NA>
		# 74966  1693    23


		#ix.na.ph = is.na(ph)==T
		#sum(ix.na.ph)
		#[1] 2837

		#phage[ix.na.ph==T] = NA

		# > table(phage)
		# phage
		#     1    10    15    17    18    19    20    21    22    23    24    25    26    27    28    29    30    31    32    33
		#     4     1     2     2     3     2     2     4     2     2     3     2     7     6     9     8    12     6    10    14
		#    34    35    36    37    38    39     4    40    41    42    43    44    45    46    47    48    49     5    50    51
		#    12    14    10     7    17    16     2    34    10    19    16    20    34    12    29    40    37     2    84    43
		#    52    53    54    55    56    57    58    59    60    61    62    63    64    65    66    67    68    69     7    70
		#    61    44    60    80    64    70    67    75    70    51    63    51    53    63    42    34    24    29     1    28
		#    71    72    73    74    75     N
		#    14    21     5     8     1 74928


		########## Treat censored invidiual: fill "N" (no-ph) with entry age (censored age) ########

		phage[ix.noph] = age[ix.noph]
			# > phage[phage0=="N"][1:10]
 			#[1] "N" "N" "N" "N" "N" "N" "N" "N" "N" "N"
			# > age[1:10]
			#  [1] 67 62 62 57 56 56 59 60 67 71
			# > age[phage0=="N"][1:10]
			#  [1] 67 62 62 57 56 56 59 60 67 71
		phage = as.numeric(phage)

		# > range(phage,na.rm=T)
		# [1]  1 78
		# > mean(phage,na.rm=T)
		# [1] 62.45576

		pc=sum(ph,na.rm=T)/length(is.na(ph)==F)
		#[1] 0.02207819

		hist(phage,col="red", main="First age of personal history of cancer")
		title(sub=paste("N=",sum(ph,na.rm=T)," (",round(pc*100,2),"%)",sep=""))


		#### Event variable define ####
		event.ph = ph
		# > table(event.ph,exclude=NULL)
		# event.ph
		#     0     1  <NA>
		# 74966  1693    23


		### time variable ###

		time.ph = phage

		#phage=as.numeric(ph)

		sum(is.na(event.ph))
		# [1] 23
		sum(is.na(time.ph))
		# [1] 116

	#### (9) plot distributions of cigstat, education and race (joint, marginal and conditional etc) ###

			#setwd(outdir)
			#plotfile1=paste("Plot_smoking.race.edu",Gender,"pdf",sep=".")
			#pdf(plotfile1)

					TAB=tb.ph
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,1.3),main="(PLCO) Personal History of Lung Cancer",cex.axis=1.5,cex.lab=2)
					text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")



	############# [1] Variable preparation (reference leve change etc) ################################
	#covnames=c("cigstat2","edu2","race2")#,cigday)
	#covnames=c("edu2","race2","cigyears2", "cigstop2", "pky2", "cigday2")

	race3=relevel(as.factor(race2),ref="W")
	cigstopf=as.factor(cigstop)
	cigstopf2=relevel(cigstopf, ref="never")
	cigstat2 = relevel(as.factor(cigstat2), ref="Never")

	mydatall=MYDAT0=data.frame(ph=ph, fh=fh, bmi=bmi, edu=edu2,race=race3,cigstat=cigstat2,cigyears=cigyears2, cigstop=cigstopf2, pky=pky2, cigday=cigday2,age=age, age.cat=age.cat)
			MYDAT0[1:3,]
		#   fh      bmi     edu race cigstat cigyears cigstop pky cigday age age.cat
		# 1 NA 25.78094  <=high    B   Never        0   never   0      0  67   65_70
		# 2  0 25.71645 postcol    W  Former        8   20_40  24     60  62   60_65
		# 3  0 34.66130  <=high    W  Former       35    0_20  35     20  62   60_65

   sum(is.na(mydatall))
   #[1] 33775
   colSums(is.na(mydatall))
		# >    colSums(is.na(mydatall))
		#       ph       fh      bmi      edu     race  cigstat cigyears  cigstop      pky   cigday      age  age.cat
		#       23     5989     4044     3039     3522     2850     3867     3557     3949     2958        0        0

		# > round(colSums(is.na(mydatall))/nrow(mydatall),2)
		#       ph       fh      bmi      edu     race  cigstat cigyears  cigstop      pky   cigday      age  age.cat
		#     0.00     0.08     0.05     0.04     0.05     0.04     0.05     0.05     0.05     0.04     0.00     0.00

	######### [1]' Imputation ###################################################################

	doImp = F

	if(doImp==T){
			Sys.time()
			#[1] "2016-04-19 08:35:21 PDT"

			#library(mice)
			#http://www.ats.ucla.edu/stat/r/faq/R_pmm_mi.htm
			imp = mice(mydatall)
			#  iter imp variable
			#   1   1  race  node2.IPL  extent2.IPL  radiation2.IPL  stage123_4.IPL
			#   1   2  race  node2.IPL  extent2.IPL  radiation2.IPL  stage123_4.IPL
			#   1   3  race  node2.IPL  extent2.IPL  radiation2.IPL  stage123_4.IPL
			#   1   4  race  node2.IPL  extent2.IPL  radiation2.IPL  stage123_4.IPL
			#   1   5  race  node2.IPL  extent2.IPL  radiation2.IPL  stage123_4.IPL
			#   2   1  race  node2.IPL  extent2.IPL  radiation2.IPL  stage123_4.IPL
			names(imp)
			#  [1] "call"            "data"            "m"               "nmis"            "imp"             "method"          "predictorMatrix" "visitSequence"
			#  [9] "form"            "post"            "seed"            "iteration"       "lastSeedValue"   "chainMean"       "chainVar"        "loggedEvents"
			# [17] "pad"

			mydatall.imp = complete(imp)#, 'long', inc=TRUE)
			dim(mydatall.imp)
			colSums(is.na(mydatall.imp))
			#      fh      bmi      edu     race  cigstat cigyears  cigstop      pky   cigday      age  age.cat
			#        0        0        0        0        0        0        0        0        0        0        0
			# >

			Sys.time()
			#[1] "2016-04-19 09:18:13 PDT"


			#setwd(outdir)
			#impfile=paste(Head,"_imputation.file.csv",sep="")
			##write.csv(mydatall.imp, impfile)

				# > dim(mydatall.imp)
				# [1] 76682    11
	}#end of

    ####### import #####


    ################ I coudln't skip this because stepwise method would not allow missing data ###

    if(Gender=="M"){

			#impfile # =paste(Head,"_imputation.file.csv",sep="")

			#setwd(outdir)
			#mydatall.imp = read.csv(impfile)[,-1]

			### this is one time thing ###
			doThis=F
			if(doThis==T){

				# > mydatall.imp[1:3,]
				#   fh      bmi     edu race cigstat cigyears cigstop pky cigday age age.cat
				# 1  0 25.78094  <=high    B   Never        0   never   0      0  67   65_70
				# 2  0 25.71645 postcol    W  Former        8   20_40  24     60  62   60_65
				# 3  0 34.66130  <=high    W  Former       35    0_20  35     20  62   60_65

				# > mydatall[1:10,]
				#    ph fh      bmi     edu race cigstat cigyears cigstop  pky cigday age age.cat
				# 1   0 NA 25.78094  <=high    B   Never        0   never  0.0      0  67   65_70
				# 2   0  0 25.71645 postcol    W  Former        8   20_40 24.0     60  62   60_65
				# 3   0  0 34.66130  <=high    W  Former       35    0_20 35.0     20  62   60_65
				# 4   0  0 23.54244  <=high    W  Former       11   20_40 33.0     60  57   55_60
				# 5   0  1 32.06407 postcol    W   Never        0   never  0.0      0  56   55_60
				# 6   0  0 31.07642  <=high    W Current       41       0 61.5     30  56   55_60
				# 7   0  0 32.12702 postcol    B  Former       18   20_40 18.0     20  59   55_60
				# 8   0  0 26.60024  <=high    H  Former       23   20_40 23.0     20  60   60_65
				# 9   0  0 24.44346 college    W   Never        0   never  0.0      0  67   65_70
				# 10  0  0 22.28891  <=high    W   Never        0   never  0.0      0  71   70_75
				# > mydatall.imp[1:10,]
				#    fh      bmi     edu race cigstat cigyears cigstop  pky cigday age age.cat
				# 1   0 25.78094  <=high    B   Never        0   never  0.0      0  67   65_70
				# 2   0 25.71645 postcol    W  Former        8   20_40 24.0     60  62   60_65
				# 3   0 34.66130  <=high    W  Former       35    0_20 35.0     20  62   60_65
				# 4   0 23.54244  <=high    W  Former       11   20_40 33.0     60  57   55_60
				# 5   1 32.06407 postcol    W   Never        0   never  0.0      0  56   55_60
				# 6   0 31.07642  <=high    W Current       41       0 61.5     30  56   55_60
				# 7   0 32.12702 postcol    B  Former       18   20_40 18.0     20  59   55_60
				# 8   0 26.60024  <=high    H  Former       23   20_40 23.0     20  60   60_65
				# 9   0 24.44346 college    W   Never        0   never  0.0      0  67   65_70
				# 10  0 22.28891  <=high    W   Never        0   never  0.0      0  71   70_75

				## adding ph to this file
				mydatall.imp =data.frame(ph=ph, mydatall.imp)

				# > mydatall.imp[1:10,]
				#    ph fh      bmi     edu race cigstat cigyears cigstop  pky cigday age age.cat
				# 1   0  0 25.78094  <=high    B   Never        0   never  0.0      0  67   65_70
				# 2   0  0 25.71645 postcol    W  Former        8   20_40 24.0     60  62   60_65
				# 3   0  0 34.66130  <=high    W  Former       35    0_20 35.0     20  62   60_65
				# 4   0  0 23.54244  <=high    W  Former       11   20_40 33.0     60  57   55_60
				# 5   0  1 32.06407 postcol    W   Never        0   never  0.0      0  56   55_60
				# 6   0  0 31.07642  <=high    W Current       41       0 61.5     30  56   55_60
				# 7   0  0 32.12702 postcol    B  Former       18   20_40 18.0     20  59   55_60
				# 8   0  0 26.60024  <=high    H  Former       23   20_40 23.0     20  60   60_65
				# 9   0  0 24.44346 college    W   Never        0   never  0.0      0  67   65_70
				# 10  0  0 22.28891  <=high    W   Never        0   never  0.0      0  71   70_75
				#setwd(outdir)
				##write.csv(mydatall.imp, impfile)

			}#

			# >
	}# end of

	if(Gender=="F"){

		### doing this for later traning vs. validation set
		#ix.cxr = mydat[,"arm"]==1

		ix.cxr = (mydat[,"arm"]==1)*1
		# > length(ix.cxr)
		# [1] 78215
		# > nrow(mydatall)
		# [1] 78215

		mydatall2=data.frame(ix.cxr=ix.cxr, mydatall)
		# > mydatall2[1:4,]
		#   ix.cxr fh      bmi     edu race cigstat cigyears cigstop pky cigday age age.cat
		# 1      0  0 22.36111  <=high    W   Never        0   never   0      0  74   70_75
		# 2      0  0 27.52136 college    W  Former       20   20_40  10     10  63   60_65
		# 3      0  0 26.68144 postcol    W   Never        0   never   0      0  59   55_60
		# 4      1  0 31.24166  <=high    A   Never        0   never   0      0  57   55_60

		mydatall.imp = na.omit(mydatall2 )
		# > dim(mydatall.imp)
		# [1] 71826    12
		# >
		###### identify rows that were removed by

		#setwd(outdir)
		#write.csv(mydatall.imp, "NAomit.data.female_0427_2017.csv")


		###### reading back due to NA problems ###

		#setwd(outdir)
#		mydatall.imp = read.csv(nafile) # "NAomit.data.female_0427_2017.csv")

	}


	mydatall.imp[,"race"] = relevel(as.factor(mydatall.imp[,"race"]),ref="W")
	mydatall.imp[,"cigstop"] = relevel(as.factor(mydatall.imp[,"cigstop"]),ref="never")
	mydatall.imp[,"cigstat"] = relevel(as.factor(mydatall.imp[,"cigstat"]),ref="Never")



	########[2] Splitting into training vs. validation data #####################################
				# > dim(mydat)
				# [1] 76682   432
				# > dim(MYDAT0)
				# [1] 76682     9

      	mydat.tr = mydat.val=NULL

    	if(Gender=="M") useImp = T
    	if(Gender=="F") useImp = T

    	if(useImp==T){
 				ix.cxr=NULL
		 		if(nrow(mydat)==nrow(mydatall.imp)){

 					ix.cxr = mydat[,"arm"]==1  # chest xray ram
					table(mydat[,"arm"])
					#
					#     1     2
					# 38340 38342
					# > sum(ix.cxr)
					# [1] 38340
					#length(ix.cxr)==length(ix.na.smk)
					# [1] TRUE
				 }#end of

		 		if(nrow(mydat)!=nrow(mydatall.imp)){	 ## for female data

 					ix.cxr = mydatall.imp[,"ix.cxr"]  # chest xray ram
					#table(mydat[,"arm"])
					# > mydatall.imp[1:5,]
					#   X ix.cxr fh      bmi     edu race cigstat cigyears cigstop pky cigday age age.cat
					# 1 1      0  0 22.36111  <=high    W   Never        0   never   0      0  74   70_75
					# 2 2      0  0 27.52136 college    W  Former       20   20_40  10     10  63   60_65
					# 3 3      0  0 26.68144 postcol    W   Never        0   never   0      0  59   55_60
					# 4 4      1  0 31.24166  <=high    A   Never        0   never   0      0  57   55_60
					# 5 6      1  0 31.41970  <=high    W   Never        0   never   0      0  63   60_65

					#
					#     1     2
					# 38340 38342
					# > sum(ix.cxr)
					# [1] 38340
					#length(ix.cxr)==length(ix.na.smk)
					# [1] TRUE
				 }#end of





	   			### training data ##########
	   			mydat.tr = mydatall.imp[ix.cxr==T,]
	   			#mydat.tr = mydatall[ix.na.smk==F & ix.cxr==T,]
					dim(mydat.tr)
					#[1] 38340     9
					# [1] 37436   434

				### validation data #########

				mydat.val = mydatall.imp[ix.cxr==F,]
					dim(mydat.val)
					#[1] 38340     9
					# [1] 36396   434

		}#en of

    	if(useImp==F){
 				ix.cxr=NULL
		 		if(nrow(mydat)==nrow(mydatall)){
 					ix.cxr = mydat[,"arm"]==1  # chest xray ram
					table(mydat[,"arm"])
					#
					#     1     2
					# 38340 38342
					# > sum(ix.cxr)
					# [1] 38340
					#length(ix.cxr)==length(ix.na.smk)
					# [1] TRUE
				 }#end of

	   			### training data ##########
	   			mydat.tr = mydatall[ix.cxr==T,]
	   			#mydat.tr = mydatall[ix.na.smk==F & ix.cxr==T,]
					dim(mydat.tr)
					#[1] 38340     9
					# [1] 37436   434

				### validation data #########

				mydat.val = mydatall[ix.cxr==F,]
					dim(mydat.val)
					#[1] 38340     9
					# [1] 36396   434

		}#en of



		############# [3] Full model fitting ##############################################################
		### nonlinear, interaction etc
		#MYDATA = na.omit(mydat.tr)

		MYDATA = mydat.tr

        #MYDATA = mydatall.imp
			dim(mydat.tr)
			#[1] 38340     9
			dim(MYDATA)
			#[1] 34580    11

		# > MYDATA[1:5,]
		#   ph fh      bmi     edu race cigstat cigyears cigstop  pky cigday age age.cat
		# 1  0 NA 25.78094  <=high    B   Never        0   never  0.0      0  67   65_70
		# 2  0  0 25.71645 postcol    W  Former        8   20_40 24.0     60  62   60_65
		# 4  0  0 23.54244  <=high    W  Former       11   20_40 33.0     60  57   55_60
		# 5  0  1 32.06407 postcol    W   Never        0   never  0.0      0  56   55_60
		# 6  0  0 31.07642  <=high    W Current       41       0 61.5     30  56   55_60

		#library(rms)
		#library(splines)

        ### the following does not mean much ###

		if(Gender=="M") fm1 = ph ~ fh + ns(age,2) + edu + race + ns(bmi,2) + cigstat + cigyears +  pky + cigday

		if(Gender=="F") fm1 = ph ~ fh + ns(age,2) + edu + race + ns(bmi,2) + cigstat + cigyears +  pky + cigday
		#fm2 = ph ~ fh + ns(age,3) + edu + race + ns(bmi,2) + cigstat +ns(cigyears,2) +  ns(pky,2) + cigday

		#fm2 = fh ~ age+ edu + race + bmi + cigstat + rcs(cigyears,3) + cigstop + ns(pky,2)
		#fm3= fh ~ age+ edu + race + bmi + cigstat + cigstop + ns(pky,2)
		#fm4= fh ~ ns(age,2)+ edu + race + bmi + cigstat + cigstop + ns(pky,2)

		#lmfull = glm(fh ~ age+ edu + race + bmi + cigstat + rcs(cigyears,3) + cigstop + ns(pky,2) + ns(cigday,2), data=MYDATA, family=binomial)
		#lmfull = glm(fh ~ age+ edu + race + bmi + cigstat + rcs(cigyears,3) + cigstop + ns(pky,2) , data=MYDATA, family=binomial)
		#lmfull = glm(fh ~ age+ edu + race + bmi + cigstat + cigstop + ns(pky,2) , data=MYDATA, family=binomial)

		lmfull = glm(fm1, data=MYDATA,family=binomial)
		summary(lmfull)

		fm.full = formula(lmfull)


		############# univaraite search ###########

		doThis=F

		if(doThis==T){


			## age ##
			summary(glm(ph~age, data=MYDATA, family=binomial))
			summary(glm(ph~ns(age,2), data=MYDATA, family=binomial))

			#summary(glm(ph~ns(age,3), data=MYDATA, family=binomial))

			### fh ##
			summary(glm(ph~fh, data=MYDATA, family=binomial))
			# Coefficients:
			#             Estimate Std. Error z value Pr(>|z|)
			# (Intercept) -3.83071    0.03865 -99.120   <2e-16 ***
			# fh           0.15711    0.11408   1.377    0.168
			# ---
			# Signif. codes:  0 *** 0.001 ** 0.01 * 0.05 . 0.1   1

			### bmi ##
			summary(glm(ph~bmi, data=MYDATA, family=binomial))
			#summary(glm(ph~ns(bmi,2), data=MYDATA, family=binomial))

			## race: yes
			summary(glm(ph~race, data=MYDATA, family=binomial))

			## edu: no
			summary(glm(ph~edu, data=MYDATA, family=binomial))

			## cigstat: yes
			summary(glm(ph~cigstat, data=MYDATA, family=binomial))

			##cigyears: yes
			summary(glm(ph~cigyears, data=MYDATA, family=binomial))
			#summary(glm(ph~ns(cigyears,2), data=MYDATA, family=binomial))


			## pkyr: no ns()
			summary(glm(ph~pky, data=MYDATA, family=binomial))

				#summary(glm(ph~ns(pky,2), data=MYDATA, family=binomial))

			##cigstop
			summary(glm(ph~cigstop, data=MYDATA, family=binomial))

			## no ns()
			summary(glm(ph~cigday, data=MYDATA, family=binomial))

			### some interactions ##

			## no interaction
			summary(glm(ph~cigstat*race, data=MYDATA, family=binomial))

			## minor yes
			summary(glm(ph~pky*race, data=MYDATA, family=binomial))


			### these are old ###


			lrm(ph~ cigstat, data=MYDATA,x=TRUE,y=TRUE)

			summary(glm(fh~age.cat, data=MYDATA, family=binomial))

			ttt=summary(glm(fh~age.cat, data=MYDATA, family=binomial))

				xx=ttt$coef
				lm2=myOR.CI4(xx,bName="Estimate",sName="Std. Error",pName="Pr(>|z|)",zName="z value",pval=T)
				row.names(lm2)=row.names(xx)
				lm2[,-7]

		     summary(glm(fh~ns(bmi,2), data=MYDATA, family=binomial))
			 summary(glm(fh~poly(bmi,2), data=MYDATA, family=binomial))

			 summary(glm(fh~bmi, data=MYDATA, family=binomial))

			 lrm(fh~age, data=MYDATA,x=TRUE,y=TRUE)
			 #lrm(fh~age.cat, data=MYDATA,x=TRUE,y=TRUE)

			 lrm(fh~bmi, data=MYDATA,x=TRUE,y=TRUE)

			 lrm(fh~ rcs(cigyears,3), data=MYDATA,x=TRUE,y=TRUE)
			tt=lrm(fh~ cigyears, data=MYDATA,x=TRUE,y=TRUE)
			tt1=with(MYDATA,lowess(cigyears, fh))

			lrm(fh~ cigstop, data=MYDATA,x=TRUE,y=TRUE)

			lrm(fh~ pky, data=MYDATA,x=TRUE,y=TRUE)
			lrm(fh~ ns(pky,2), data=MYDATA,x=TRUE,y=TRUE)

			lrm(fh~ cigday, data=MYDATA,x=TRUE,y=TRUE)
			lrm(fh~ ns(cigday,2), data=MYDATA,x=TRUE,y=TRUE)

			smdat= MYDATA[,c("fh","age")]

			ff=glm(fh~ns(age,2), data=smdat,family=binomial)
			newdata=45:90
			pr = predict(ff, newdata=data.frame(age=45:90))
			plot(newdata, 100*(exp(pr)/1+exp(pr)), pch=16, col="blue", xlab="Age", ylab="Prevalence (%) of Family History of LC", main="FH ~ ns(age,2)")


			# fh ~ age + edu + race + rcs(cigyears, 3) + cigstop + ns(cigday,
			#     2)

			#library(randomForest)
			#rffit <- randomForest(fh ~ age+ edu + race + bmi + cigstat + cigyears + cigstop + pky + cigday, data=MYDATA, importance=TRUE,
			#						proximity=TRUE)

		}#

		###### to make figures: ph vs. age plot ###########

		smdat= MYDATA[,c("ph","age")]
		#ff=glm(ph~ns(age,3), family=binomial)
		ff=glm(ph~ns(age,2), data=smdat,family=binomial)
		newdata=50:90
		pr = predict(ff, newdata=data.frame(age=50:90))
		pr2 = exp(pr)/(1+exp(pr))
		plot(newdata, 100*pr2, pch=16, col="blue", xlab="Age", ylab="Prevalence (%) of personal History of LC", main="PH ~ ns(age,2)")



		smdat= MYDATA[,c("ph","age")]
		ff=glm(ph~ns(age,3), data=smdat,family=binomial)
		newdata=55:90
		pr = predict(ff, newdata=data.frame(age=55:90))
		pr2 = exp(pr)/(1+exp(pr))
		plot(newdata, 100*pr2, pch=16, col="blue", xlab="Age", ylab="Prevalence (%) of personal History of LC", main="PH ~ ns(age,3)")



	   ########### [4] Stepwise selection ################################################################

   		doStep=F

   		if(doStep==T){

			### need to delete missing data before stepwise ##

			# > colSums(is.na(MYDATA))
			#       ph       fh      bmi      edu     race  cigstat cigyears  cigstop      pky   cigday      age  age.cat
			#        0     2524     1354      952     1236      901     1383     1230     1417      944        0        0

			## exlude family history: too many missing #
			MYDATA2 = MYDATA[,-2]
			MYDATA3 = na.omit(MYDATA2)
			# > colnames(MYDATA)
			#  [1] "ph"       "fh"       "bmi"      "edu"      "race"     "cigstat"  "cigyears" "cigstop"  "pky"      "cigday"
			# [11] "age"      "age.cat"

			### based on univaratie seaerch ##
			if(Gender=="M") fm1 = ph ~ ns(age,3) + edu + race + ns(bmi,2) + cigstat +ns(cigyears,2) +  pky + cigday
			if(Gender=="F") fm1 = ph ~ ns(age,2) + edu + race + bmi + cigstat +cigyears +  pky + cigday

			lmfull = glm(fm1, data=MYDATA3,family=binomial)


			st=step(lmfull)
			st

			#               Estimate Std. Error z value Pr(>|z|)
			# (Intercept) -3.4945462  0.5154633  -6.779 1.21e-11 ***
			# ns(age, 3)1  0.7739137  0.2369971   3.265 0.001093 **
			# ns(age, 3)2  0.4754907  1.0361745   0.459 0.646313
			# ns(age, 3)3  0.7195612  0.2462865   2.922 0.003482 **
			# raceA       -1.1327669  0.2933987  -3.861 0.000113 ***
			# raceB       -0.5154352  0.2181605  -2.363 0.018145 *
			# raceH       -0.1665861  0.2727506  -0.611 0.541356
			# ns(bmi, 2)1 -1.1109209  0.4309010  -2.578 0.009934 **
			# ns(bmi, 2)2  1.5416965  0.9412790   1.638 0.101448
			# pky          0.0054344  0.0009874   5.504 3.72e-08 ***
			# ---
			# Signif. codes:  0 *** 0.001 ** 0.01 * 0.05 . 0.1   1
			#
			# (Dispersion parameter for binomial family taken to be 1)
			#
			#     Null deviance: 7571.1  on 36102  degrees of freedom
			# Residual deviance: 7440.3  on 36093  degrees of freedom


			fm=formula(st)
			fm
			# > fm
			# ph ~ ns(age, 3) + race + ns(bmi, 2) + pky

			### get AUC and others ###

			lmfh=lrm(fm, data=MYDATA3,x=T,y=T)
			lmfh

			# Logistic Regression Model
			#
			# lrm(formula = fm, data = MYDATA3, x = T, y = T)
			#                       Model Likelihood     Discrimination    Rank Discrim.
			#                          Ratio Test            Indexes          Indexes
			# Obs         36103    LR chi2     130.76    R2       0.019    C       0.609
			#  0          35317    d.f.             9    g        0.474    Dxy     0.217
			#  1            786    Pr(> chi2) <0.0001    gr       1.607    gamma   0.233
			# max |deriv| 3e-09                          gp       0.010    tau-a   0.009
			#                                            Brier    0.021
			#
			#           Coef    S.E.   Wald Z Pr(>|Z|)
			# Intercept -3.4945 0.5155 -6.78  <0.0001
			# 1          0.7739 0.2370  3.27  0.0011
			# 2          0.4755 1.0362  0.46  0.6463
			# 3          0.7196 0.2463  2.92  0.0035
			# race=A    -1.1328 0.2934 -3.86  0.0001
			# race=B    -0.5154 0.2182 -2.36  0.0181
			# race=H    -0.1666 0.2728 -0.61  0.5414
			# 1         -1.1109 0.4309 -2.58  0.0099
			# 2          1.5417 0.9413  1.64  0.1014
			# pky        0.0054 0.0010  5.50  <0.0001

         }#end of


	   ########## [5] Final model assessment ###########################################################
## now use MYDATA instead of MYDATA3

	   #myfit.tm = lrm(ph ~ ns(age, 3) + race +  pky, data=MYDATA3, x=T, y=T)

} # end 1==0


	   if(Gender=="M"){

           myfit.glm <- myfit.glm.M.PH
           if (1==0) {
			   # myfit = lrm(ph ~ ns(age, 2) + race + ns(bmi, 2) + pky, data=MYDATA, x=T, y=T)
			   myfit.glm = glm(ph ~ ns(age, 2) + race + ns(bmi, 2) + pky, data=MYDATA, family=binomial)
			   summary(myfit.glm)
           }

	   }#end of


	   if(Gender=="F"){
           myfit.glm <- myfit.glm.F.PH
           if (1==0) {
			   # myfit = lrm(ph ~ ns(age, 2) + race + edu + cigstat + pky, data=MYDATA, x=T, y=T)
			   myfit.glm = glm(ph ~ ns(age, 2) + race + edu + cigstat + pky, data=MYDATA, family=binomial)
			   summary(myfit.glm)
           }
	   }#end of

	   #myfit = lrm(ph ~ ns(age, 2) + race + ns(bmi, 2) + pky, data=MYDATA, x=T, y=T)
	   #myfit.glm = glm(ph ~ ns(age, 2) + race + ns(bmi, 2) + pky, data=MYDATA, family=binomial)


		#               Estimate Std. Error z value Pr(>|z|)
		# (Intercept) -3.4945462  0.5154633  -6.779 1.21e-11 ***
		# ns(age, 3)1  0.7739137  0.2369971   3.265 0.001093 **
		# ns(age, 3)2  0.4754907  1.0361745   0.459 0.646313
		# ns(age, 3)3  0.7195612  0.2462865   2.922 0.003482 **
		# raceA       -1.1327669  0.2933987  -3.861 0.000113 ***
		# raceB       -0.5154352  0.2181605  -2.363 0.018145 *
		# raceH       -0.1665861  0.2727506  -0.611 0.541356
		# ns(bmi, 2)1 -1.1109209  0.4309010  -2.578 0.009934 **
		# ns(bmi, 2)2  1.5416965  0.9412790   1.638 0.101448
		# pky          0.0054344  0.0009874   5.504 3.72e-08 ***
		# ---
		# Signif. codes:  0 *** 0.001 ** 0.01 * 0.05 . 0.1   1
		#
		# (Dispersion parameter for binomial family taken to be 1)
		#
		#     Null deviance: 7571.1  on 36102  degrees of freedom
		# Residual deviance: 7440.3  on 36093  degrees of freedom
		# AIC: 7460.3

		if(Gender=="M"){
            if (1==0) {
			#### these are for output only later
			 ns.mat.age = with(MYDATA, ns(age,2))
			 ns.mat.bmi = with(MYDATA, ns(bmi,2))
         }

		 }#end of
		# > ns.mat.age[1:3,]
		#              1           2
		# [1,] 0.5561763  0.05267204
		# [2,] 0.5662628 -0.21084190
		# [3,] 0.4238313 -0.24371337
		# > ns.mat.pky[1:3,]
		#              1           2
		# [1,] 0.0000000  0.00000000
		# [2,] 0.1997805 -0.09623106
		# [3,] 0.2623123 -0.11994754
		#
		if(Gender=="F"){
            if (1==0) {
			#### these are for output only later
			 ns.mat.age = with(MYDATA, ns(age,2))
			 #ns.mat.bmi = with(MYDATA, ns(bmi,2))
            }
		 }#end of

		# Logistic Regression Model
		# Logistic Regression Model
		#
		# lrm(formula = ph ~ ns(age, 3) + race + ns(bmi, 2) + pky, data = MYDATA3,
		#     x = T, y = T)
		#                       Model Likelihood     Discrimination    Rank Discrim.
		#                          Ratio Test            Indexes          Indexes
		# Obs         36103    LR chi2     130.76    R2       0.019    C       0.609
		#  0          35317    d.f.             9    g        0.474    Dxy     0.217
		#  1            786    Pr(> chi2) <0.0001    gr       1.607    gamma   0.233
		# max |deriv| 3e-09                          gp       0.010    tau-a   0.009
		#                                            Brier    0.021
		#
		#           Coef    S.E.   Wald Z Pr(>|Z|)
		# Intercept -3.4945 0.5155 -6.78  <0.0001
		# 1          0.7739 0.2370  3.27  0.0011
		# 2          0.4755 1.0362  0.46  0.6463
		# 3          0.7196 0.2463  2.92  0.0035
		# race=A    -1.1328 0.2934 -3.86  0.0001
		# race=B    -0.5154 0.2182 -2.36  0.0181
		# race=H    -0.1666 0.2728 -0.61  0.5414
		# 1         -1.1109 0.4309 -2.58  0.0099
		# 2          1.5417 0.9413  1.64  0.1014
		# pky        0.0054 0.0010  5.50  <0.0001

		xx=summary(myfit.glm)$coef
		or=lm2=myOR.CI4(xx,bName="Estimate",sName="Std. Error",pName="Pr(>|z|)",zName="z value",pval=T)
		row.names(or)=row.names(xx)
		or[,-7]
		#               OR  CI1   CI2   beta    sd        pval2
		# (Intercept) 0.03 0.01  0.08 -3.495 0.515 1.206526e-11
		# ns(age, 3)1 2.17 1.36  3.45  0.774 0.237 1.092716e-03
		# ns(age, 3)2 1.61 0.21 12.26  0.475 1.036 6.463128e-01
		# ns(age, 3)3 2.05 1.27  3.33  0.720 0.246 3.481903e-03
		# raceA       0.32 0.18  0.57 -1.133 0.293 1.129956e-04
		# raceB       0.60 0.39  0.92 -0.515 0.218 1.814517e-02
		# raceH       0.85 0.50  1.44 -0.167 0.273 5.413561e-01
		# ns(bmi, 2)1 0.33 0.14  0.77 -1.111 0.431 9.933516e-03
		# ns(bmi, 2)2 4.67 0.74 29.57  1.542 0.941 1.014480e-01
		# pky         1.01 1.00  1.01  0.005 0.001 3.717363e-08

	   #setwd(outdir)
	   #write.csv(or,"PH.regression.ns2_female.csv")

	   ########### [a] Diagnostics  ###############################################

   		# AUC
   		# brier score
   		# classification error
   		# goodness-of-fit


	   ########### [b] Apparent validation ########################################

	   doVal=F
	   if(doVal==T){

			   mycal=calibrate(myfit)
			   plot(mycal)

			   ########### [c] Variable importance and BMA method #########################

				### BMA ########

				#library(BMA)
				glm.out.va= bic.glm(fm, glm.family=binomial, data=MYDATA3)
				summary(glm.out.va)

				par(mfrow=c(1,1))
				imageplot.bma(glm.out.va,cex=0.5)

				par(mfrow=c(1,1))
				plot(glm.out.va)


				######### relative importance #########
				# > fm
				# fh ~ age + edu + race + bmi + ns(pky, 2)

				gg=glm(fm, data=MYDATA3, family=binomial)
				an=anova(gg)
				an
				# Analysis of Deviance Table
				#
				# Model: binomial, link: logit
				#
				# Response: fh
				#
				# Terms added sequentially (first to last)
				#
				#
				#            Df Deviance Resid. Df Resid. Dev
				# NULL                       38339      24980
				# ns(age, 2)  2    5.917     38337      24974
				# edu         2   29.112     38335      24945
				# race        3   23.313     38332      24922
				# bmi         1    5.535     38331      24916
				# ns(pky, 2)  2   78.359     38329      24838

				# Analysis of Deviance Table
				#
				# Model: binomial, link: logit
				#
				# Response: ph
				#
				# Terms added sequentially (first to last)
				#
				#
				#            Df Deviance Resid. Df Resid. Dev
				# NULL                       36102     7571.1
				# ns(age, 3)  3   63.236     36099     7507.8
				# race        3   26.550     36096     7481.3
				# ns(bmi, 2)  2   13.259     36094     7468.0
				# pky         1   27.713     36093     7440.3

				# > names(an)
				# [1] "Df"         "Deviance"   "Resid. Df"  "Resid. Dev"

				tt1=an$Dev[-1] - an$Df[-1]
				if(Gender=="M")names(tt1)=c("age","race","bmi","pack-year")
				if(Gender=="F")names(tt1)=c("age","edu","race","cigstat","pky")

				#            Df Deviance Resid. Df Resid. Dev
				# NULL                       37052      18386
				# ns(age, 2)  2   56.525     37050      18330
				# edu         2    4.567     37048      18325
				# race        3   22.173     37045      18303
				# cigstat     2   40.028     37043      18263
				# pky         1    2.791     37042      18260

				tt2=tt1[order(tt1,decreasing=T)]
				barplot(tt2/sum(tt2),col=heat.colors(length(tt2)),las=2, cex.lab=1.2, cex.main=1.5, cex.axis=1.5,
							ylab="Relative Importance (%)", main="Relative Importance of Variables", ylim=c(0,0.8))


				barplot(tt2,col=heat.colors(length(tt2)),las=2, cex.lab=1.2, cex.main=1.5, cex.axis=1.5,
							ylab="Chisq-df", main="Relative Importance of Variables")#, ylim=c(0,0.8))


			   ########### [6] 10-fold or Bootstrap validation ###################################################

				#mycalboot=calibrate(myfit, method="boot", B=40)


			   val=validate(myfit,method="boot",B=40)
				### include c-index ###
				cindex2=0.5*(val["Dxy",]+1)
				cindex2["optimism"] = cindex2["training"]-cindex2["test"] # how much excess?
				cindex2["index.corrected"] = cindex2["index.orig"]-cindex2["optimism"]
				cindex2["n"]=val["Dxy","n"]
				val2=rbind(cindex=cindex2,val)
				val2
				#             index.orig     training        test     optimism index.corrected   n


				B=ceiling(0.1*nrow(MYDATA));B
				#[1] 100
				valcv=validate(myfit, method="crossvalidation", B=500)

				#           index.orig training    test optimism index.corrected   n
				# Dxy           0.2832   0.2833  0.2493   0.0340          0.2492 100
				# R2            0.0893   0.0894  0.2657  -0.1763          0.2656 100
				# Intercept     0.0000   0.0000  1.4258  -1.4258          1.4258 100
				# Slope         1.0000   1.0000 10.3894  -9.3894         10.3894 100
				# Emax          0.0000   0.0000  0.4214   0.4214          0.4214 100
				# D             0.0682   0.0683  0.1444  -0.0761          0.1443 100
				# U            -0.0020  -0.0020  0.1318  -0.1338          0.1318 100
				# Q             0.0702   0.0703  0.0126   0.0577          0.0125 100
				# B             0.2316   0.2316  0.2359  -0.0043          0.2360 100
				# g             0.6224   0.6228  8.3184  -7.6956          8.3180 100
				# gp            0.1456   0.1456  0.1973  -0.0517          0.1973 100

				### include c-index ###
				cindex2=0.5*(valcv["Dxy",]+1)
				cindex2["optimism"] = cindex2["training"]-cindex2["test"] # how much excess?
				cindex2["index.corrected"] = cindex2["index.orig"]-cindex2["optimism"]
				cindex2["n"]=valcv["Dxy","n"]
				val2cv=rbind(cindex=cindex2,valcv)
				val2cv
				#             index.orig     training        test     optimism index.corrected   n


			   ########### [7] External validation ###############################################################


				pred.logit = predict(myfit, mydat.val)
				# > pred.logit[1:4]
				#        4        5        6        7
				# 1.138703 1.251589 1.193375 1.396058
				phat = 1/(1+exp(-pred.logit))
				phat[1:10]
				#          3          8          9         14         15         16         18         24         25         26
				# 0.11712426 0.06388822 0.07808821 0.14458999 0.08740165 0.08813680 0.10004402 0.11276686 0.09241890 0.08233308

				###compare predicted prob vs. actual outcome y
				valprob = val.prob(p=phat, y=mydat.val[,"ph"],cex=0.7)#, g.group=4)#,m=5)#,g=10)#,g.group=2,cex=0.5);valprob

				valprob = val.prob(p=phat, y=mydat.val[,"ph"],cex=0.7, lim=c(0,0.15))#, g.group=4)#,m=5)#,g=10)#,g.group=2,cex=0.5);valprob
				valprob
				t(valprob)
				#           Dxy  C (ROC)         R2          D D:Chi-sq D:p      U    U:Chi-sq U:p          Q     Brier
				# [1,] 0.260818 0.630409 0.07829283 0.05848725 30.24363  NA -0.004 6.82121e-13   1 0.06248725 0.2350141
				#        Intercept     Slope      Emax       S:z       S:p       Eavg
				# [1,] -0.06782444 0.9099561 0.0327751 0.7558215 0.4497562 0.03672528

				###  validation by sex ###
				valprob2 = val.prob(p=phat, y=mydat.val[,"ph"],cex=0.5,group=mydat.val[,"race"],lim=c(0,0.15))#,g=10)#,g.group=2,cex=0.5);valprob
				plot(valprob2,lim=c(0,0.3))

				valprob3 = val.prob(p=phat, y=mydat.val[,"ph"],cex=0.5,group=mydat.val[,"cigstat"],lim=c(0,0.15))#,g=10)#,g.group=2,cex=0.5);valprob
				plot(valprob3,lim=c(0,0.3))




		}#end of doVal


   		########### [8] Calibration of parameters using US census data #######################################################################


		glm.ph = myfit.glm


		######## average risk of FH at age = 55

		mycoef = glm.ph$coef
		mycoef
		#  (Intercept)  ns(age, 2)1  ns(age, 2)2        raceA        raceB        raceH  ns(bmi, 2)1  ns(bmi, 2)2          pky
		# -4.153204741  2.000252417  0.959643122 -1.135390157 -0.519912397 -0.174655134 -1.102206748  1.535078487  0.005412564

		#  (Intercept)  ns(age, 3)1  ns(age, 3)2  ns(age, 3)3        raceA        raceB        raceH  ns(bmi, 2)1  ns(bmi, 2)2          pky
		# -3.494087943  0.775599266  0.465300813  0.727633924 -1.134807420 -0.519480798 -0.170029629 -1.098434095  1.524776802  0.005378612

		#### female ##
		#    (Intercept)    ns(age, 2)1    ns(age, 2)2          raceA          raceB          raceH     educollege     edupostcol cigstatCurrent
		#  -2.9344948162   0.6199797377   0.7852675752  -0.4129644378  -0.3181978144   0.1164215527  -0.0006229374   0.1478125267   0.2199251752
		#  cigstatFormer            pky
		#   0.1771213575   0.0022873314

		glm.ph$model[1:3,]
		#   ph ns(age, 3).1 ns(age, 3).2 ns(age, 3).3 race ns(bmi, 2).1 ns(bmi, 2).2 pky
		# 1  0    0.5520039    0.3504519   -0.0337378    B    0.3709263   -0.1877143   0
		# 2  0    0.2610429    0.5127676   -0.3033939    W    0.3691387   -0.1871011  24
		# 4  0   -0.1009771    0.5321631   -0.3192979    W    0.3045058   -0.1613362  33


		x=AGE = 55
		# > ref.ph
		# [1] 6.14   <--- at age 55

		ave.eff.prob.before = myGetPHProb2(x, mycoef, ref.race, ref.edu, ref.smk, ref.bmi.mean.55, ref.pky.mean.55, Gender, MYDATA)
		ave.eff.prob.before
		# [1]  0.01110414




		# ave.eff.prob.before = myGetPHProb2(x, mycoef, ref.race, ref.pky.mean.55, Gender, MYDATA3)
		# ave.eff.prob.before

		myages = matrix(55:90,ncol=1)

		probs.ph = apply(myages, 1, myGetPHProb2,  mycoef=mycoef,  ref.race=ref.race,  ref.edu=ref.edu, ref.smk=ref.smk, ref.bmi.mean.55= ref.bmi.mean.55,   ref.pky.mean.55=ref.pky.mean.55, Gender=Gender, MYDATA=MYDATA)
	#probs.ph = apply(myages, 1, myGetPHProb.ns2,  mycoef=mycoef,  ref.race=ref.race,  ref.bmi.mean.55= ref.bmi.mean.55,  ref.pky.mean.55=ref.pky.mean.55, Gender=Gender, MYDATA=MYDATA)

		plot(myages, probs.ph*100, pch=17,col="red", xlab="Age",ylab="Prevalence (%) of PH", main="Multivariate Model")


       ### compare it to predict(): just the curve shape ###

		  doThis=F
		  if(doThis==T){
				  ag=55:90
				  newdata=data.frame(age=55:90, race=rep("W",length(ag)), bmi=rep(27,length(ag)), pky=rep(17,length(ag)))
				  pr=predict(glm.ph, newdata)
				  pr2=exp(pr)/(1+exp(pr))
						plot(ag, 100*pr2, pch=16, col="blue", xlab="Age", ylab="Prevalence (%) of personal History of LC", main="PH ~ ns(age,3)")

		 }#3nd of


		ave.eff.prob.before
		ref.ph
		# [1] 0.01232073
		# > 		ref.ph
		# [1] 5.3


		############ figuring out why curve goes down with age
		doThis=F
			if(doThis==T){


						smdat= MYDATA[,c("ph","age")]
						#ff=glm(ph~ns(age,3), family=binomial)
						ff=glm(ph~ns(age,3), data=smdat,family=binomial)
							mycoef.ns = coef(ff)
							mycoef.ns
							# (Intercept) ns(age, 3)1 ns(age, 3)2 ns(age, 3)3
							#  -4.2011965   0.8032236   0.6598889   0.8109479
							# > ff$model[1:10,]
							#    ph ns(age, 3).1 ns(age, 3).2 ns(age, 3).3
							# 1   0  0.552003858  0.350451895 -0.033737803
							# 2   0  0.261042949  0.512767628 -0.303393910
							# 4   0 -0.100977145  0.532163142 -0.319297885
							# 5   0 -0.122418888  0.493437955 -0.296062773
							# 6   0 -0.122418888  0.493437955 -0.296062773
							# 7   0 -0.009430963  0.569906079 -0.341943647
							# 10  0  0.309789956  0.341832803  0.331966985


						newdata=55:90

						pr = predict(ff, newdata=data.frame(age=55))
						pr


						pr = predict(ff, newdata=data.frame(age=55:90))
						pr2= (exp(pr)/(1+exp(pr)))
						plot(newdata, 100*pr2, pch=16, col="blue", xlab="Age", ylab="Prevalence (%) of personal History of LC", main="PH ~ ns(age,3)")
						pr2[1:10]
						#          1          2          3          4          5          6          7          8          9
						# 0.01435893 0.01457158 0.01491928 0.01543094 0.01614298 0.01710251 0.01835124 0.01985611 0.02154567
						#         10
						# 0.02331797



						#myGetPHProb.tmp <- function(x, mycoef.ns, MYDATA)
						probs.ph = apply(myages, 1, myGetPHProb.tmp,  mycoef.ns=mycoef.ns,   MYDATA=MYDATA)

						# > probs.ph[1:10]
						#  [1] 0.01352676 0.01362712 0.01386767 0.01427630 0.01488883 0.01575262 0.01691015 0.01832669 0.01992775
						# [10] 0.02160629

						plot(myages, probs.ph*100, pch=17,col="red", xlab="Age",ylab="Prevalence (%) of PH", main="Multivariate Model")


				######## comparing whether predict() and my function are producing the same results ##
						### age 80

						pr = predict(ff, newdata=data.frame(age=80))
						pr2= (exp(pr)/(1+exp(pr)))
						pr2
						#0.03059919

						#myGetPHProb.tmp(x=80, mycoef.ns, MYDATA)
						#[1] 0.03059919


			}


	    ############################ calibration ##########################################

	    doThis=F
	    if(doThis==T){


	    	mycoef2 = mycoef
	    	mycoef2[1] = mycoef[1]*0.968# increase the intercept (negative)
	    	#mycoef2[2] = mycoef[2]*1.2
	    	myGetPHProb2(x, mycoef=mycoef2, ref.race,ref.edu,ref.smk, ref.bmi.mean.55, ref.pky.mean.55, Gender, MYDATA)#[1] 0.1087554
	    	#[1] 0.0614254
	    	ref.ph
			#[1] 6.14

			# > mycoef
			# (Intercept) ns(age, 3)1 ns(age, 3)2 ns(age, 3)3       raceA       raceB       raceH ns(bmi, 2)1 ns(bmi, 2)2
			# -3.49454619  0.77391374  0.47549066  0.71956124 -1.13276692 -0.51543523 -0.16658612 -1.11092092  1.54169648
			#         pky
			#  0.00543436
			# > mycoef2
			# (Intercept) ns(age, 3)1 ns(age, 3)2 ns(age, 3)3       raceA       raceB       raceH ns(bmi, 2)1 ns(bmi, 2)2
			# -2.02683679  0.77391374  0.47549066  0.71956124 -1.13276692 -0.51543523 -0.16658612 -1.11092092  1.54169648
			#         pky
			#  0.00543436


	    }#end of


			mycoef = glm.ph$coef
		    mycoef.adj = mycoef


		    if(Gender=="M"){

			   mycoef.adj[1] = mycoef[1]*0.555 # increase the intercept (negative)
			   mycoef.adj[2] = mycoef[2]*0.9

	   		 }#end of

		    if(Gender=="F"){

			   mycoef.adj[1] = mycoef[1]*0.968# increase the intercept (negative)


	   		 }#end of

	    	ave.eff.prob = myGetPHProb2(x, mycoef=mycoef.adj, ref.race, ref.edu=ref.edu, ref.smk=ref.smk, ref.bmi.mean.55, ref.pky.mean.55, Gender, MYDATA)
			ave.eff.prob
			ref.ph

			# [1] 0.05135048
			# > 			ref.ph
			# [1] 5.3

			myages = matrix(55:90,ncol=1)

			probs.ph2 = apply(myages, 1, myGetPHProb2,  mycoef=mycoef.adj,  ref.race=ref.race, ref.edu=ref.edu, ref.smk=ref.smk, ref.bmi.mean.55= ref.bmi.mean.55,   ref.pky.mean.55=ref.pky.mean.55, Gender=Gender, MYDATA=MYDATA)

			#apply(myages, 1, myGetFHProb,  mycoef=mycoef.adj, ref.edu=ref.edu, ref.race=ref.race,ref.pky.mean.55=ref.pky.mean.55, Gender=Gender, MYDATA=MYDATA)

			plot(myages, probs.ph2*100, pch=17,col="red", xlab="Age",ylab="Prevalence (%) of PH", main="(After calibration) Multivariate Model")

			## adding from McClure ##

			plot(myages, probs.ph2*100, pch=17,col="red", xlab="Age",ylab="Prevalence (%) of PH", main="(After calibration) Multivariate Model", ylim=c(5,26))


			xx=c(25, 35, 45,55,65,75,80)
			yy=c(1.2, 2.1, 4.4, 8.3, 14.9, 21.7, 25)
			points(xx,yy,pch=17,col="blue")


			points(xx, yy*0.76,pch=18,col="dark green")

			legend(x="bottomright", legend=c("NHIS", "Adjusted NHIS", "Model"), fill=c("blue","red","dark green"),cex=1.5)

			# > 100*(1-0.24)
			# [1] 24



			doThis=F
			if(doThis==T){

					##### further adjustment for age effect shown in Table 1 in McClure ######
					mycoef.adj.or = mycoef.adj

			 mycoef.adj[3]=mycoef.adj.or[3]*3
					probs.ph2 = apply(myages, 1, myGetPHProb,  mycoef=mycoef.adj,  ref.race=ref.race,  ref.bmi.mean.55= ref.bmi.mean.55,   ref.pky.mean.55=ref.pky.mean.55, Gender=Gender, MYDATA=MYDATA)

					#apply(myages, 1, myGetFHProb,  mycoef=mycoef.adj, ref.edu=ref.edu, ref.race=ref.race,ref.pky.mean.55=ref.pky.mean.55, Gender=Gender, MYDATA=MYDATA)

					plot(myages, probs.ph2*100, pch=17,col="red", xlab="Age",ylab="Prevalence (%) of PH", main="(After 2nd calibration) Multivariate Model")

					mycoef.adj  #<---- final one
					#  (Intercept)  ns(age, 3)1  ns(age, 3)2  ns(age, 3)3        raceA        raceB        raceH  ns(bmi, 2)1  ns(bmi, 2)2          pky
					# -1.974159688  0.775599266  1.395902438  0.727633924 -1.134807420 -0.519480798 -0.170029629 -1.098434095  1.524776802  0.005378612

					mycoef.adj.or
						#  (Intercept)  ns(age, 3)1  ns(age, 3)2  ns(age, 3)3        raceA        raceB        raceH  ns(bmi, 2)1  ns(bmi, 2)2          pky
						# -1.974159688  0.775599266  0.465300813  0.727633924 -1.134807420 -0.519480798 -0.170029629 -1.098434095  1.524776802  0.005378612

			}#end of

			########### barplot comparison #############

		  par(mar=c(5,5,5,3))
			#ref.fh.ci = c(9.74, 11.90)
			ci1=ref.ph.ci[1]
			ci2=ref.ph.ci[2]

		   mat=cbind(ref.ph, ave.eff.prob.before*100)
		   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="PHC prevalence (%)",
		   main="[Before Adjustment] \n Prevalence (%) of PHC (age 55)", cex.main=1.5, ylim=c(0,15))

		   ##### confidence interval ###
		   xs = c(1.5,2.5)#,7.5)

		   for(u in 1:length(xs)){


		   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

		   }#end of

		  legend(x="topleft", legend=c("Reference", "Model-based"), fill=c("red","yellow"), ncol=2,cex=1)



		######### after calibration



		   mat=cbind(ref.ph, ave.eff.prob*100)
		   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="PHC prevalence (%)",
		   main="[After Adjustment] \n Prevalence (%) of PHC (age 55)", cex.main=1.5, ylim=c(0,15))

		   ##### confidence interval ###
		   xs = c(1.5,2.5)#,7.5)

		   for(u in 1:length(xs)){


		   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

		   }#end of

		  legend(x="topleft", legend=c("Reference", "Model-based"), fill=c("red","yellow"), ncol=2,cex=1)



			  ANS = list(mycoef.adj=mycoef.adj,  mycoef.before = mycoef, glm.ph = glm.ph, glm.or= or,  prev.phc.adj = ave.eff.prob, prev.phc.unadj = ave.eff.prob.before, ref.ph = ref.ph/100, ref.ph.ci = ref.ph.ci, ns.mat.age=ns.mat.age)#, ns.mat.bmi=ns.mat.bmi)
			  ANS



}#end of the main myPH.given




########## 5/1/2017 female
########## 4/13/2016: incorporate external and cross validation and other metrics (and updated data)	###

myFHL.cond2<- function( ref.fh, ref.fh.ci, ref.pky.mean.55, ref.bmi.mean.55, ref.edu, ref.race, Gender){  # fit family history

		############ Fit Pr(Family history of lung cancer| gender, race, age, education, smoking) ##########################
					#logistic regression using PLCO data and offsets using prevalence data for FH

		# lung_fh Family History of Lung Cancer?
				# Derived from question 21
				# .F="No Form"
				# .M="Missing"
				# 0="No"
				# 1="Yes, immediate family member" 9="Possibly - relative or cancer type not clear"

if (1==0) {
		#####################[0] Define variables ################################################

		##### (1) define smoking status ###########
				# prevalence data: http://en.wikipedia.org/wiki/Prevalence_of_tobacco_consumption
				cigstat=mydat[,"cig_stat"]
				# > table(cigstat)
				# cig_stat

				#     0     1     2     A     F     M     #A is ambiguous -- will put in former then
				# 26917  8659 38256     1  2826    23

				# .A="Ambiguous"
				# .F="No Form"
				# .M="Not Answered"
				# 0="Never Smoked Cigarettes"
				# 1="Current Cigarette Smoker"
				# 2="Former Cigarette Smoker"

				tb.cig=table(cigstat)
				round(tb.cig/sum(tb.cig),2)
				# cigstat
				#    0    1    2
				# 0.37 0.12 0.51

				cigstat2=cigstat
				cigstat2[cigstat=="0"]="Never"
				cigstat2[cigstat=="1"]="Current"
				cigstat2[cigstat=="2"]="Former"
				cigstat2[cigstat=="A"]= NA
				cigstat2[cigstat=="F"]= NA
				cigstat2[cigstat=="M"]= NA
						# > table(cigstat2)
						# cigstat2
						# Current  Former   Never
						#    8659   38256   26917

				# for polytomous ##
				cigstat3=cigstat2
				cigstat3[cigstat==0]="0.Never"
				cigstat3[cigstat==1]="2.Current"
				cigstat3[cigstat==2]="1.Former"

					# > table(cigstat3)
					# cigstat3
					#   0.Never  1.Former 2.Current
					#     26917     38256      8659


		ix.na.smk = is.na(cigstat2)==T
		# > sum(ix.na.smk)
		# [1] 2850   ---> need to exclude them


		#### (2) education ########################
		#educat #Education
				# Question 3
				# .F="No Form" .M="Missing"
				# 1="Less than 8 years" 2="8-11 years"
				# 3="12 years or completed high school" 4="Post high school training other than college"
				# 5="Some college"
				# 6="College graduate" 7="Postgraduate"

				edu0=mydat[,"educat"]
				table(edu0)
				# edu0
				#     1     2     3     4     5     6     7     F     M
				#   923  5172 13484  9048 15067 13912 16037  2826   213

				# not finished highschool - highschool graduate -college graduate - postgraduate
				#   (1,2)                        (3,4,5)                 6                7

				edu=edu0
				#edu[edu0==1 | edu0==2]=1
				edu[edu0 <=5 ]=1
				edu[edu0==6]=2
				edu[edu0==7]=3
				edu[edu0=="M" | edu0=="F"]=NA

						tb.edu=table(edu)/sum(table(edu))
						tb.edu
						# edu
						#         1         2         3
						# 0.7016927 0.1504578 0.1478495
						# > table(edu)
						# edu
						#     1     2     3
						# 43694 13912 16037

	            ## factor variable ##
				edu2=edu
				edu2[edu==1]="<=high"
				edu2[edu==2]="college"
				edu2[edu==3]="postcol"
				tb.edu2=table(edu2)/sum(table(edu2))
				tb.edu2
				# edu2
				#    <=high   college   postcol
				# 0.7016927 0.1504578 0.1478495

						doThis=F
						if(doThis==T){
							edu=edu0
							edu[edu0==1 | edu0==2]=1
							edu[edu0==3 | edu0==4 | edu0==5]=2
							edu[edu0==6]=3
							edu[edu0==7]=4
							edu[edu0=="M"]=NA

							tb.edu=table(edu)
							# edu
							#     1     2     3     4
							#  5914 37002 13757 15862
							# > round(tb.edu/sum(tb.edu),3)
							# edu
							#     1     2     3     4
							# 0.082 0.510 0.190 0.219

							edu2=edu
							edu2[edu==1]="<high"
							edu2[edu==2]="high"
							edu2[edu==3]="college"
							edu2[edu==4]="postcol"

						}#



		####### (3) race #############
				# 1="White, Non-Hispanic" 2="Black, Non-Hispanic" 3="Hispanic"
				# 4="Asian"
				# 5="Pacific Islander" 6="American Indian" 7="Missing"

				# 1="White, Non-Hispanic"
				# 2="Black, Non-Hispanic"
				# 3="Hispanic"
				# 4="Asian"
				# 5="Pacific Islander"
				# 6="American Indian"
				# 7="Missing"
				race0=mydat[,"race7"]
					table(race0)
					# race0
					#     1     2     3     4     5     6     7
					# 64222  3273  1569  2957   452   185    38
					#
					#     1     2     3     4     5     6     7
					# 65178  3370  1603  3009   464   187  2871
					#
				## merge 4-7
				# "white" - "black" - "hispanic" - "asian"
				race=race0
				race[race0>4]=NA
						tb.race=table(race)
						tb.race
						# race
						#     1     2     3     4
						# 64222  3273  1569  3632
						round(tb.race/sum(tb.race),2)
						# race
						# race
						#    1    2    3    4
						# 0.89 0.05 0.02 0.04
				race2=race
				race2[race==1]="W"
				race2[race==2]="B"
				race2[race==3]="H"
				race2[race==4]="A"
					#table(race2)
					#     A     B     H     W
					#  3009  3370  1603 65178
	   #### (4) define "Edu-race" variable #############


				race.edu=paste(race2,edu2,sep="-") #[1] "W-<=high"   "NA-college" "W-<=high"   "W-college"  "W-college"
				race.edu[is.na(race2) | is.na(edu2)] = NA
				race.edu=as.factor(as.character(race.edu))

	  #####  (5) BMI ########

              # clean chars ---------------------
              temp <- mydat[,"bmi_curr"]
              temp[temp %in% c("F","M","R")] <- NA
              temp_ <- mydat[,"bmi_curc"]
              temp_[temp_ %in% c("F","M","R")] <- NA

              # bmi=as.numeric(mydat[,"bmi_curr"]) #[1] 38.07647 31.81634 22.69663 27.25385 28.03809 24.19162 30.57929 25.16239 22.28669 23.10435
              bmi=as.numeric(temp)
              # bmicat=as.numeric(mydat[,"bmi_curc"]) #[1] 38.07647 31.81634 22.69663 27.25385 28.03809 24.19162 30.57929 25.16239 22.28669 23.10435
              bmicat=as.numeric(temp_)

			### some NA's for F, M, R... missing values
# Q: should I do missing value imputation?
			#            2            1            1            1            1            1            1            1            1
			# 66.317197494            F            M            R
			#            1         2826         1071          147

	  ####  (6) define age variable

			age=as.numeric(mydat[,"age"])
					range(age)
					# [1] 49 78
			#library(Hmisc)
			age.cat = cut2(age, cuts=c(55, 60, 65, 70, 75))
			# > table(age.cat)
			# age.cat
			# [49,55) [55,60) [60,65) [65,70) [70,75) [75,78]
			#       9   24750   24023   17763   10133       4

				# > levels(age.cat)
				# [1] "[49,55)" "[55,60)" "[60,65)" "[65,70)" "[70,75)" "[75,78]"
			levels(age.cat)= c("lt55","55_60","60_65","65_70","70_75","85+")

			#age.cat = cut2(age,

	 ####### (7) define Smoking related variables ##
			#cig_per_day  of Cigarettes Smoked Per Day
					#The maximum number of cigarettes smoked per day, based on the range specified. The category 81+ is set to 100.

			# cig_years_rnd # of Years Smoked Cigarettes
					# Derived from questions 10-13. This differs from cig_years because it uses randomization age instead of BQ age.
					# Numeric .F="No Form" .M="Missing"
			#cig_stop_rnd # of Years Since Stopped Smoking Cigarettes
					# Derived from questions 12 and 13. This differs from cig_stop because it uses randomization age instead of BQ age.
					# Numeric
					# .F="No Form" .M="Missing" .N="Not Applicable"


			### pack-years ##
			pky0=mydat[,"pack_years"]
			#pky0=mydat[,"pack_years_rnd"]
			pky2=pky0
			pky2[pky0=="M" | pky0=="F"]=NA
			pky2=as.numeric(pky2)
			#[1]   0 260
			#   9.5    90    92    93    94  94.5    95    96    98    99     F     M
			#   138   268   150   104   100     1     5   231    72    87  2826  1123

			### make category (0-10), (10-30), (30-60), (60-100), 100+
			pky=pky2
			pky[pky2 <=10] = "lst10"
			pky[pky2 > 10 & pky2<=30] ="10_30"
			pky[pky2 > 30 & pky2 <=60] = "30_60"
			pky[pky2 > 60 & pky2 <=100] = "60_100"
			pky[pky2>100]="gt100"
			table(pky)
			# pky
			#  10_30  30_60 60_100  gt100  lst10
			#  14808  14932   7212   2261  33430

			#### cigday ##
			# F="No Form"
			# .M="Missing"
			# 0="0"
			# 1="1-10"
			# 2="11-20"
			# 3="21-30"
			# 4="31-40"
			# 5="41-60"
			# 6="61-80"
			# 7="81+"

			cigday0=mydat[,"cigpd_f"]
				table(cigday0)
				# cigday0
				#     0     1     2     3     4     5     6     7     F     M
				# 26917  7853 17302 10783  6409  3591   685   184  2826   132

			### put maximum value not category
			cigday00 = cigday0
			cigday00[cigday0=="1"] = 10
			cigday00[cigday0=="2"] = 20
			cigday00[cigday0=="3"] = 30
			cigday00[cigday0=="4"] = 40
			cigday00[cigday0=="5"] = 60
			cigday00[cigday0=="6"] = 80
			cigday00[cigday0=="7"] = 100
			cigday00[cigday0=="F" | cigday0=="M"] = NA

				table(cigday00)
				# cigday00
				#     0    10   100    20    30    40    60    80
				# 26917  7853   184 17302 10783  6409  3591   685

							# old PCA data (more accurate i guess,but new data don't have this 3/16/2016)
							#cigday0=mydat[,"cig_per_day"]
								# > table(mydat[,"cig_per_day"])
								#
								#    10   100    20    30    40    60    80     M     N
								#  7637   177 16972 10579  6290  3511   668     7 26855   <--- never smoker

			#### group: N, (0-20], (20-40], (40-60], (60,100]

			cigday=cigday00
			cigday[cigday00=="0"]	= "never"
			cigday[cigday00==10 | cigday00==20 ]	= "0_20"
			cigday[cigday00==30 | cigday00==40 ]	= "20_40"
			cigday[cigday00==50 | cigday00==60 ]	= "40_60"
			cigday[cigday00==70 | cigday00==80 | cigday00==90 | cigday00==100]	= "60_100"
			cigday[cigday00=="M"]	= NA

			table(cigday)
			# cigday
			#   0_20  20_40  40_60 60_100  never
			#  25155  17192   3591    869  26917

							# cigday
							#  20_40  40_60 60_100  lst20  never
							#  16869   3511    845  24609  26855


			## define cigday2 ###

			cigday2=cigday00
			cigday2[cigday00=="N"]=0
			cigday2[cigday00=="M"]=NA
			cigday2=as.numeric(cigday2)


			### define cigstop ###
			# Numeric
			# .F="No Form"
			# .M="Not Answered"
			# .N="Not Applicable"
			# 0.5="Six Months"

			cigstop0=mydat[,"cig_stop"]
			#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24
			#  8659   702   843  1206   984   989   982   971  1070   979   863   858   894   755  1235   899   889   910   871
			#    25    26    27    28    29     3    30    31    32    33    34    35    36    37    38    39     4    40    41
			#  1076  1050  1020  1024  1062   734  1191  1057   973   905   825   763   641   540   465   420   675   344   341
			#    42    43    44    45    46    47    48    49     5    50    51    52    53    54    55    56    57    58    59
			#   296   222   215   178   148   113   112    86   808    48    44    30    16    15     4     3     3     3     1
			#     6    60    62     7     8     9     F     M     N
			#   798     1     1   801   823   774  2826   731 26917
			# >
			#cigstop0=mydat[,"cig_stop_rnd"]
			#range(as.numeric(cigstop0),na.rm=T)
			# [1]  0 62
			# Warning cat:
			# NAs introduced by coercion

			# cigstop0
			#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24    25    26    27    28    29     3
			#  8581   697   825  1191   975   983   975   969  1059   962   858   845   915   750  1217   884   884   911   874  1062  1048  1026   992  1055   728
			#    30    31    32    33    34    35    36    37    38    39     4    40    41    42    43    44    45    46    47    48    49     5    50    51    52
			#  1187  1056   975   904   812   772   623   523   466   414   665   338   342   284   228   209   181   137   117   110    80   810    49    44    24
			#    53    54    55    56    57    58    59     6    62     7     8     9     N
			#    15    15     3     2     3     3     2   785     1   808   805   771 26867
					# > table(cigstop0,cigstat2)
					#         cigstat2
					# cigstop0 Current Former Never
					#      0      8581      0     0  --> current smoker has cigstop=0, yes makes sens
					#      0.5       0    697     0
					# ..
					#      8         0    805     0
					#      9         0    771     0
					#      N         0     12 26855    ---> never smoker nas cigstop="N"

            # F, M, N ------------------------
            temp <- cigstop0
            temp[temp %in% c("F","M","N")] <- NA

			### define: N, 0-20, 20-40, 40+ ##
			# tt=as.numeric(cigstop0)
            tt=as.numeric(temp)

			# > range(tt,na.rm=T)
			# [1]  0 62
			cigstop=cigstop0
			cigstop[cigstop0=="N"]="never"
			cigstop[tt==0] = "0"
			cigstop[tt>0 & tt <=20] = "0_20"
			cigstop[tt >20 & tt<=40] = "20_40"
			cigstop[tt >40 ] = "gt40"

			cigstop[cigstop=="F" | cigstop=="M" ] = NA

			table(cigstop)
			# cigstop
			#     0  0_20 20_40  gt40 never
			#  8659 18744 16925  1880 26917

					#              0           0_20          20_40 gt40.neversmok          never
					#           8581          18593          16806           1849          26867
					#boxplot(tt~cigstop)
			### numeric variables ##
			cigstop2=tt


			### define cigyears ###
			# Numeric
			# .F="No Form"
			# .M="Not Answered"
			# 0.5="Six Months"
			cigyears0=mydat[,"cig_years"]
			#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24
			# 26917    91   222  1107   753   971   748  1012  1012   816   970   954   931   454  1313   872  1093   947  1057
			#    25    26    27    28    29     3    30    31    32    33    34    35    36    37    38    39     4    40    41
			#  1030   851   909   938   931   421  1033   876  1014   946  1023  1061   984  1138  1130  1255   512  1340  1189
			#    42    43    44    45    46    47    48    49     5    50    51    52    53    54    55    56    57    58    59
			#  1101  1046   963   845   824   657   608   546   603   501   426   346   262   206   159    98    85    44    25
			#     6    60    61    62    63    64     7     8     9     F     M
			#   600    24    11     4     6     3   662   630   709  2826  1041

					#cigyears0=mydat[,"cig_years_rnd"]
					# > table(cigyears0)
					# cigyears0
					#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24    25    26    27    28    29     3
					# 26855    92   225  1106   752   965   748  1011  1009   815   964   950   930   453  1312   873  1088   946  1058  1028   851   908   935   930   419
					#    30    31    32    33    34    35    36    37    38    39     4    40    41    42    43    44    45    46    47    48    49     5    50    51    52
					#  1034   873  1012   940  1024  1067   977  1137  1124  1255   511  1340  1180  1114  1039   959   838   817   654   607   551   599   490   424   349
					#    53    54    55    56    57    58    59     6    60    61    62    63    64     7     8     9     M
					#   256   205   155    99    83    44    25   599    24    12     4     5     3   662   628   708    46
			#tt=as.numeric(mydat[,"cig_years"])
			# range(tt,na.rm=T)
			# [1]  0 64

			## group:  0-20, 20-40, 40-60
			cigyears=cigyears0
			cigyears[cigyears0=="M" | cigyears0=="F"]=NA
			cigyears[tt==0] = "0"
			cigyears[tt >0 & tt <=20] = "0_20"
			cigyears[tt >20 & tt<=40] = "20_40"
			cigyears[tt >40] = "gt40"

			table(cigyears)
			# cigyears
			#     0  0_20 20_40  gt40
			# 26917 15491 20428  9979


						# cigyears
						#     0  0_20 20_40  gt40
						# 26855 15458 20400  9937
						#boxplot(tt~cigyears)

			## cigyears.numeric ##

			cigyears2=cigyears0
			cigyears2[cigyears0=="M" |cigyears0=="F" ]=NA
			cigyears2=as.numeric(cigyears2)



	####### (8) family history of lung cancer ############################################

		# Lung cancer family history in first-degree relatives. Includes parents, full-siblings, and children.
		# .F="No Form"
		#.M="Missing"
		#0="No"1="Yes, Immediate Family Member
		#"9="Possibly - Relative Or Cancer Type Not Clear"

		fh0=mydat[,"lung_fh"]
		# fh0
		#     0     1     9     F     M
		# 63729  6964  2506  2826   657

		# fh0
		#     0     1     9     M
		# 62796  6851  2453   596

		fh=fh0
		fh[fh0=="9" | fh0=="M" | fh0=="F"]=NA
		fh=as.numeric(fh)
		tb.fh=table(fh)/sum(table(fh))
		tb.fh
		# fh
		#          0          1
		# 0.90163252 0.09836748
		#          0          1
		# 0.90148954 0.09851046

		# > sum(is.na(fh))/length(fh)
		# [1] 0.07810177


	#### (9) plot distributions of cigstat, education and race (joint, marginal and conditional etc) ###

			#setwd(outdir)
			#plotfile1=paste("Plot_smoking.race.edu",Gender,"pdf",sep=".")
			#pdf(plotfile1)

					TAB=tb.fh
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,1.3),main="(PLCO) Family History of Lung Cancer",cex.axis=1.5,cex.lab=2)
					text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")



	############# [1] Variable preparation (reference leve change etc) ################################
	#covnames=c("cigstat2","edu2","race2")#,cigday)
	#covnames=c("edu2","race2","cigyears2", "cigstop2", "pky2", "cigday2")

	race3=relevel(as.factor(race2),ref="W")
	cigstopf=as.factor(cigstop)
	cigstopf2=relevel(cigstopf, ref="never")
	cigstat2 = relevel(as.factor(cigstat2), ref="Never")

	mydatall=MYDAT0=data.frame(fh=fh, bmi=bmi, edu=edu2,race=race3,cigstat=cigstat2,cigyears=cigyears2, cigstop=cigstopf2, pky=pky2, cigday=cigday2,age=age, age.cat=age.cat)
			MYDAT0[1:3,]
		#   fh      bmi     edu race cigstat cigyears cigstop pky cigday age age.cat
		# 1 NA 25.78094  <=high    B   Never        0   never   0      0  67   65_70
		# 2  0 25.71645 postcol    W  Former        8   20_40  24     60  62   60_65
		# 3  0 34.66130  <=high    W  Former       35    0_20  35     20  62   60_65

   sum(is.na(mydatall))
   #[1] 33775
   colSums(is.na(mydatall))
	# > colSums(is.na(mydatall))
	#       fh      bmi      edu     race  cigstat cigyears  cigstop      pky   cigday      age  age.cat
	#     5989     4044     3039     3522     2850     3867     3557     3949     2958        0        0

	# > round(colSums(is.na(mydatall))/nrow(mydatall),2)
	#       fh      bmi      edu     race  cigstat cigyears  cigstop      pky   cigday      age  age.cat
	#     0.08     0.05     0.04     0.05     0.04     0.05     0.05     0.05     0.04     0.00     0.00

	######### [1]' Imputation ###################################################################

	doImp = F

	if(doImp==T){
			Sys.time()
			#[1] "2016-04-19 08:35:21 PDT"

			#library(mice)
			#http://www.ats.ucla.edu/stat/r/faq/R_pmm_mi.htm
			imp = mice(mydatall)
			#  iter imp variable
			#   1   1  race  node2.IPL  extent2.IPL  radiation2.IPL  stage123_4.IPL
			#   1   2  race  node2.IPL  extent2.IPL  radiation2.IPL  stage123_4.IPL
			#   1   3  race  node2.IPL  extent2.IPL  radiation2.IPL  stage123_4.IPL
			#   1   4  race  node2.IPL  extent2.IPL  radiation2.IPL  stage123_4.IPL
			#   1   5  race  node2.IPL  extent2.IPL  radiation2.IPL  stage123_4.IPL
			#   2   1  race  node2.IPL  extent2.IPL  radiation2.IPL  stage123_4.IPL
			names(imp)
			#  [1] "call"            "data"            "m"               "nmis"            "imp"             "method"          "predictorMatrix" "visitSequence"
			#  [9] "form"            "post"            "seed"            "iteration"       "lastSeedValue"   "chainMean"       "chainVar"        "loggedEvents"
			# [17] "pad"

			mydatall.imp = complete(imp)#, 'long', inc=TRUE)
			dim(mydatall.imp)
			colSums(is.na(mydatall.imp))
			#      fh      bmi      edu     race  cigstat cigyears  cigstop      pky   cigday      age  age.cat
			#        0        0        0        0        0        0        0        0        0        0        0
			# >

			Sys.time()
			#[1] "2016-04-19 09:18:13 PDT"


			#setwd(outdir)
			#impfile=paste(Head,"_imputation.file.csv",sep="")
			##write.csv(mydatall.imp, impfile)

				# > dim(mydatall.imp)
				# [1] 76682    11
	}#end of

    ####### import #####

} # end 1==0
    ################ I coudln't skip this because stepwise method would not allow missing data ###

    if(Gender=="M"){

        if (1==0) {
			#impfile # =paste(Head,"_imputation.file.csv",sep="")


			#setwd(outdir)
			#mydatall.imp = read.csv(impfile)[,-1]
			# > mydatall.imp[1:3,]
			#   fh      bmi     edu race cigstat cigyears cigstop pky cigday age age.cat
			# 1  0 25.78094  <=high    B   Never        0   never   0      0  67   65_70
			# 2  0 25.71645 postcol    W  Former        8   20_40  24     60  62   60_65
			# 3  0 34.66130  <=high    W  Former       35    0_20  35     20  62   60_65

        }
	}

	if(Gender=="F"){

		### doing this for later traning vs. validation set
		#ix.cxr = mydat[,"arm"]==1
        if (1==0) {
		ix.cxr = (mydat[,"arm"]==1)*1
		# > length(ix.cxr)
		# [1] 78215
		# > nrow(mydatall)
		# [1] 78215

		mydatall2=data.frame(ix.cxr=ix.cxr, mydatall)
		# > mydatall2[1:4,]
		#   ix.cxr fh      bmi     edu race cigstat cigyears cigstop pky cigday age age.cat
		# 1      0  0 22.36111  <=high    W   Never        0   never   0      0  74   70_75
		# 2      0  0 27.52136 college    W  Former       20   20_40  10     10  63   60_65
		# 3      0  0 26.68144 postcol    W   Never        0   never   0      0  59   55_60
		# 4      1  0 31.24166  <=high    A   Never        0   never   0      0  57   55_60

		mydatall.imp = na.omit(mydatall2 )
		# > dim(mydatall.imp)
		# [1] 71826    12
		# >
		###### identify rows that were removed by

		#setwd(outdir)
		#write.csv(mydatall.imp, "NAomit.data.female_0427_2017.csv")


		###### reading back due to NA problems ###

		#setwd(outdir)
#		mydatall.imp = read.csv(nafile) # "NAomit.data.female_0427_2017.csv")
        }
	}

    if (1==0) {
    	mydatall.imp[,"race"] = relevel(as.factor(mydatall.imp[,"race"]),ref="W")
    	mydatall.imp[,"cigstop"] = relevel(as.factor(mydatall.imp[,"cigstop"]),ref="never")
    	mydatall.imp[,"cigstat"] = relevel(as.factor(mydatall.imp[,"cigstat"]),ref="Never")
    }


    if (1==0) {
	########[2] Splitting into training vs. validation data #####################################
				# > dim(mydat)
				# [1] 76682   432
				# > dim(MYDAT0)
				# [1] 76682     9
    mydat.tr = mydat.val=NULL

    if(Gender=="M") useImp = T
    if(Gender=="F") useImp = T

    if(useImp==T){
 				ix.cxr=NULL
		 		if(nrow(mydat)==nrow(mydatall.imp)){

 					ix.cxr = mydat[,"arm"]==1  # chest xray ram
					table(mydat[,"arm"])
					#
					#     1     2
					# 38340 38342
					# > sum(ix.cxr)
					# [1] 38340
					#length(ix.cxr)==length(ix.na.smk)
					# [1] TRUE
				 }#end of

		 		if(nrow(mydat)!=nrow(mydatall.imp)){	 ## for female data

 					ix.cxr = mydatall.imp[,"ix.cxr"]  # chest xray ram
					#table(mydat[,"arm"])
					# > mydatall.imp[1:5,]
					#   X ix.cxr fh      bmi     edu race cigstat cigyears cigstop pky cigday age age.cat
					# 1 1      0  0 22.36111  <=high    W   Never        0   never   0      0  74   70_75
					# 2 2      0  0 27.52136 college    W  Former       20   20_40  10     10  63   60_65
					# 3 3      0  0 26.68144 postcol    W   Never        0   never   0      0  59   55_60
					# 4 4      1  0 31.24166  <=high    A   Never        0   never   0      0  57   55_60
					# 5 6      1  0 31.41970  <=high    W   Never        0   never   0      0  63   60_65

					#
					#     1     2
					# 38340 38342
					# > sum(ix.cxr)
					# [1] 38340
					#length(ix.cxr)==length(ix.na.smk)
					# [1] TRUE
				 }#end of





	   			### training data ##########
	   			mydat.tr = mydatall.imp[ix.cxr==T,]
	   			#mydat.tr = mydatall[ix.na.smk==F & ix.cxr==T,]
					dim(mydat.tr)
					#[1] 38340     9
					# [1] 37436   434

				### validation data #########

				mydat.val = mydatall.imp[ix.cxr==F,]
					dim(mydat.val)
					#[1] 38340     9
					# [1] 36396   434

		}#en of

    if(useImp==F){
 				ix.cxr=NULL
		 		if(nrow(mydat)==nrow(mydatall)){
 					ix.cxr = mydat[,"arm"]==1  # chest xray ram
					table(mydat[,"arm"])
					#
					#     1     2
					# 38340 38342
					# > sum(ix.cxr)
					# [1] 38340
					#length(ix.cxr)==length(ix.na.smk)
					# [1] TRUE
				 }#end of

	   			### training data ##########
	   			mydat.tr = mydatall[ix.cxr==T,]
	   			#mydat.tr = mydatall[ix.na.smk==F & ix.cxr==T,]
					dim(mydat.tr)
					#[1] 38340     9
					# [1] 37436   434

				### validation data #########

				mydat.val = mydatall[ix.cxr==F,]
					dim(mydat.val)
					#[1] 38340     9
					# [1] 36396   434

		}#en of


		############# [3] Full model fitting ##############################################################
		### nonlinear, interaction etc
		#MYDATA = na.omit(mydat.tr)

		MYDATA = mydat.tr
        #MYDATA = mydatall.imp
			dim(mydat.tr)
			#[1] 38340     9
			dim(MYDATA)
			#[1] 34580    11

			# > MYDATA[1:5,]
			#   fh      bmi     edu race cigstat cigyears cigstop  pky cigday age age.cat
			# 2  0 25.71645 postcol    W  Former        8   20_40 24.0     60  62   60_65
			# 4  0 23.54244  <=high    W  Former       11   20_40 33.0     60  57   55_60
			# 5  1 32.06407 postcol    W   Never        0   never  0.0      0  56   55_60
			# 6  0 31.07642  <=high    W Current       41       0 61.5     30  56   55_60
			# 7  0 32.12702 postcol    B  Former       18   20_40 18.0     20  59   55_60

		#library(rms)
		#library(splines)

# 		fm1 = fh ~ age+ edu + race + bmi + cigstat + rcs(cigyears,3) + cigstop + ns(pky,2) + ns(cigday,2)
# 		fm2 = fh ~ age+ edu + race + bmi + cigstat + rcs(cigyears,3) + cigstop + ns(pky,2)
# 		fm3= fh ~ age+ edu + race + bmi + cigstat + cigstop + ns(pky,2)



		if(Gender=="M") fm4= fh ~ ns(age,2)+ edu + race + bmi + cigstat + cigstop + ns(pky,2)
		if(Gender=="F") fm4= fh ~ ns(age,2) + edu + race + bmi + cigstat + cigyears + pky

		#lmfull = glm(fh ~ age+ edu + race + bmi + cigstat + rcs(cigyears,3) + cigstop + ns(pky,2) + ns(cigday,2), data=MYDATA, family=binomial)
		#lmfull = glm(fh ~ age+ edu + race + bmi + cigstat + rcs(cigyears,3) + cigstop + ns(pky,2) , data=MYDATA, family=binomial)
		#lmfull = glm(fh ~ age+ edu + race + bmi + cigstat + cigstop + ns(pky,2) , data=MYDATA, family=binomial)

		lmfull = glm(fm4, data=MYDATA,family=binomial)
		fm.full = formula(lmfull)

		##### univaraite ###
		doThis=F
		if(doThis==T){


			summary(glm(fh~age, data=MYDATA, family=binomial))


			summary(glm(fh~age.cat, data=MYDATA, family=binomial))
			ttt=summary(glm(fh~age.cat, data=MYDATA, family=binomial))

				xx=ttt$coef
				lm2=myOR.CI4(xx,bName="Estimate",sName="Std. Error",pName="Pr(>|z|)",zName="z value",pval=T)
				row.names(lm2)=row.names(xx)
				lm2[,-7]

		     summary(glm(fh~bmi, data=MYDATA, family=binomial))

		     #summary(glm(fh~ns(bmi,2), data=MYDATA, family=binomial))
			 #summary(glm(fh~poly(bmi,2), data=MYDATA, family=binomial))

			 #summary(glm(fh~bmi, data=MYDATA, family=binomial))

			 summary(glm(fh~pky, data=MYDATA, family=binomial))
			 	 #summary(glm(fh~ns(pky,2), data=MYDATA, family=binomial))


			 summary(glm(fh~cigstat, data=MYDATA, family=binomial))
			 summary(glm(fh~cigyears, data=MYDATA, family=binomial))
			#summary(glm(fh~ns(cigyears,2), data=MYDATA, family=binomial))


			 lrm(fh~age, data=MYDATA,x=TRUE,y=TRUE)
			 #lrm(fh~age.cat, data=MYDATA,x=TRUE,y=TRUE)

			 lrm(fh~bmi, data=MYDATA,x=TRUE,y=TRUE)

			 lrm(fh~edu, data=MYDATA,x=TRUE,y=TRUE)

			 lrm(fh~race, data=MYDATA,x=TRUE,y=TRUE)

			 lrm(fh~race*edu, data=MYDATA,x=TRUE,y=TRUE)

			 lrm(fh~cigstat, data=MYDATA,x=TRUE,y=TRUE)


			 lrm(fh~ rcs(cigyears,3), data=MYDATA,x=TRUE,y=TRUE)
			tt=lrm(fh~ cigyears, data=MYDATA,x=TRUE,y=TRUE)
			tt1=with(MYDATA,lowess(cigyears, fh))



			lrm(fh~ cigstop, data=MYDATA,x=TRUE,y=TRUE)

			lrm(fh~ pky, data=MYDATA,x=TRUE,y=TRUE)
			lrm(fh~ ns(pky,2), data=MYDATA,x=TRUE,y=TRUE)

			lrm(fh~ cigday, data=MYDATA,x=TRUE,y=TRUE)
			lrm(fh~ ns(cigday,2), data=MYDATA,x=TRUE,y=TRUE)

			smdat= MYDATA[,c("fh","age")]

	ff=glm(fh~ns(age,2), data=smdat,family=binomial)
	newdata=45:90
	pr = predict(ff, newdata=data.frame(age=45:90))
	plot(newdata, 100*(exp(pr)/1+exp(pr)), pch=16, col="blue", xlab="Age", ylab="Prevalence (%) of Family History of LC", main="FH ~ ns(age,2)")


			# fh ~ age + edu + race + rcs(cigyears, 3) + cigstop + ns(cigday,
			#     2)

			#library(randomForest)
			#rffit <- randomForest(fh ~ age+ edu + race + bmi + cigstat + cigyears + cigstop + pky + cigday, data=MYDATA, importance=TRUE,
			#						proximity=TRUE)

		}#

		smdat= MYDATA[,c("fh","age")]
		ff=glm(fh~ns(age,2), data=smdat,family=binomial)
		newdata=45:90
		pr = predict(ff, newdata=data.frame(age=45:90))
		plot(newdata, 100*(exp(pr)/1+exp(pr)), pch=16, col="blue", xlab="Age", ylab="Prevalence (%) of Family History of LC", main="FH ~ ns(age,2)")


	   ########### [4] Stepwise selection ################################################################

   		doStep=F

   		if(doStep==T){
			st=step(lmfull)
			summary(st)
			fm=formula(st)
			# > fm
			# fh ~ age + edu + race + bmi + ns(pky, 2)
			#  female
			# glm(formula = fh ~ edu + bmi + pky, family = binomial, data = MYDATA)
			#
			# Deviance Residuals:
			#     Min       1Q   Median       3Q      Max
			# -0.9558  -0.5072  -0.4915  -0.4419   2.2079
			#
			# Coefficients:
			#              Estimate Std. Error z value Pr(>|z|)
			# (Intercept) -2.192646   0.083898 -26.135  < 2e-16 ***
			# educollege  -0.240529   0.048935  -4.915 8.87e-07 ***
			# edupostcol  -0.252386   0.050289  -5.019 5.20e-07 ***
			# bmi          0.005575   0.002931   1.902   0.0572 .
			# pky          0.005944   0.000659   9.019  < 2e-16 ***
			# ---
			# Signif. codes:  0 *** 0.001 ** 0.01 * 0.05 . 0.1   1
			#
			# (Dispersion parameter for binomial family taken to be 1)
			#
			#     Null deviance: 26010  on 36116  degrees of freedom
			# Residual deviance: 25875  on 36112  degrees of freedom
			# AIC: 25885




			lmfh=lrm(fm, data=MYDATA,x=T,y=T)
			lmfh


			#if(Gender=="F") fm='fh ~ ns(age,2) + edu +  bmi + pky'

			lmfull2 = glm(fh ~ ns(age,2) + edu + bmi + pky , data=MYDATA, family=binomial)
			summary(lmfull2)

         }#end of

		# > names(st)
		#  [1] "coefficients"      "residuals"         "fitted.values"     "effects"           "R"
		#  [6] "rank"              "qr"                "family"            "linear.predictors" "deviance"
		# [11] "aic"               "null.deviance"     "iter"              "weights"           "prior.weights"
		# [16] "df.residual"       "df.null"           "y"                 "converged"         "boundary"
		# [21] "model"             "call"              "formula"           "terms"             "data"
		# [26] "offset"            "control"           "method"            "contrasts"         "xlevels"
		# [31] "anova"
		# > summary(st)
		#
		# Call:
		# glm(formula = fh ~ age + edu + race + bmi + rcs(cigyears, 3) +
		#     ns(cigday, 2), family = binomial, data = MYDATA)
		#
		# Deviance Residuals:
		#     Min       1Q   Median       3Q      Max
		# -0.7025  -0.4815  -0.4467  -0.4163   2.4920
		#
		# Coefficients:
		#                             Estimate Std. Error z value Pr(>|z|)
		# (Intercept)               -2.2593136  0.2609414  -8.658  < 2e-16 ***
		# age                       -0.0057959  0.0032831  -1.765 0.077498 .
		# educollege                -0.1597837  0.0470072  -3.399 0.000676 ***
		# edupostcol                -0.1164665  0.0447588  -2.602 0.009266 **
		# raceB                      0.1203376  0.1207553   0.997 0.318987
		# raceH                     -0.4191656  0.1697709  -2.469 0.013549 *
		# raceW                      0.1396306  0.0924802   1.510 0.131084
		# bmi                        0.0071412  0.0040692   1.755 0.079265 .
		# rcs(cigyears, 3)cigyears   0.0039723  0.0039514   1.005 0.314763
		# rcs(cigyears, 3)cigyears' -0.0008233  0.0037703  -0.218 0.827149
		# ns(cigday, 2)1             0.5914556  0.1496619   3.952 7.75e-05 ***
		# ns(cigday, 2)2             0.7210220  0.1519833   4.744 2.09e-06 ***
		# ---
		# Signif. codes:  0 *** 0.001 ** 0.01 * 0.05 . 0.1   1
		#
		# (Dispersion parameter for binomial family taken to be 1)
		#
		#     Null deviance: 24980  on 38339  degrees of freedom
		# Residual deviance: 24837  on 38328  degrees of freedom
		# AIC: 24861
		#
		# Number of Fisher Scoring iterations: 5
		#
		#
		# Call:
		# glm(formula = fh ~ age + edu + race + rcs(cigyears, 3) + cigstop +
		#     ns(cigday, 2), family = binomial, data = MYDATA)
		#
		# Deviance Residuals:
		#     Min       1Q   Median       3Q      Max
		# -0.7164  -0.4834  -0.4463  -0.4158   2.5906
		#
		# Coefficients:
		#                            Estimate Std. Error z value Pr(>|z|)
		# (Intercept)               -1.580551   0.246596  -6.409 1.46e-10 ***
		# age                       -0.011043   0.003893  -2.837 0.004556 **
		# educollege                -0.175343   0.049175  -3.566 0.000363 ***
		# edupostcol                -0.128341   0.046530  -2.758 0.005812 **
		# raceA                     -0.166980   0.097558  -1.712 0.086972 .
		# raceB                      0.051874   0.087288   0.594 0.552323
		# raceH                     -0.525892   0.154151  -3.412 0.000646 ***
		# rcs(cigyears, 3)cigyears   0.013823   0.006594   2.096 0.036064 *
		# rcs(cigyears, 3)cigyears' -0.003446   0.005301  -0.650 0.515671
		# cigstop0                  -0.500344   0.178165  -2.808 0.004980 **
		# cigstop0_20               -0.375080   0.162230  -2.312 0.020776 *
		# cigstop20_40              -0.225514   0.125437  -1.798 0.072204 .
		# cigstopgt40               -0.175511   0.145444  -1.207 0.227539
		# ns(cigday, 2)1             0.809985   0.200545   4.039 5.37e-05 ***
		# ns(cigday, 2)2             0.687938   0.168492   4.083 4.45e-05 ***
		# ---
		# Signif. codes:  0 *** 0.001 ** 0.01 * 0.05 . 0.1   1
		#
		# (Dispersion parameter for binomial family taken to be 1)
		#
		#     Null deviance: 22588  on 34579  degrees of freedom
		# Residual deviance: 22440  on 34565  degrees of freedom
		# AIC: 22470
		#
		# Number of Fisher Scoring iterations: 5


		# 	> fm
		# fh ~ age + edu + race + bmi + ns(pky, 2)
		# > lmfh=lrm(fm, data=MYDATA,x=T,y=T)
		# >
		# > lmfh
		#
		# Logistic Regression Model
		#
		# lrm(formula = fm, data = MYDATA, x = T, y = T)
		#                       Model Likelihood     Discrimination    Rank Discrim.
		#                          Ratio Test            Indexes          Indexes
		# Obs         38340    LR chi2     140.39    R2       0.008    C       0.557
		#  0          34494    d.f.             9    g        0.218    Dxy     0.114
		#  1           3846    Pr(> chi2) <0.0001    gr       1.244    gamma   0.118
		# max |deriv| 1e-06                          gp       0.020    tau-a   0.021
		#                                            Brier    0.090
		#
		#             Coef    S.E.   Wald Z Pr(>|Z|)
		# Intercept   -2.0659 0.2468 -8.37  <0.0001
		# age         -0.0066 0.0033 -2.03  0.0428
		# edu=college -0.1560 0.0469 -3.32  0.0009
		# edu=postcol -0.1150 0.0447 -2.57  0.0101
		# race=A      -0.1345 0.0924 -1.46  0.1455
		# race=B      -0.0168 0.0809 -0.21  0.8354
		# race=H      -0.5546 0.1445 -3.84  0.0001
		# bmi          0.0080 0.0040  1.97  0.0485
		# 1            1.0349 0.1207  8.58  <0.0001
		# 2            0.8565 0.3092  2.77  0.0056

		#lmfull = lrm(fh ~ age+ edu + race + bmi + cigstat + cigyears + cigstop + pky + cigday, data=MYDATA, x=T,y=T)

		#lmfull = lrm(fh ~ age+ edu + race + bmi + cigstat + rcs(cigyears,3) + cigstop + ns(pky,2) + ns(cigday,2), data=MYDATA)

        }

	   ########## [5] Final model assessment ###########################################################

	   if(Gender=="M"){

           # FROM RDS -----------------
           myfit.glm <- myfit.glm.M.FHL

           if (1==0) {
		             # myfit = lrm(fh ~ ns(age,2) + edu + race + bmi + ns(pky, 2), data=MYDATA, x=T,y=T)
		         myfit.glm = glm(fh ~ ns(age,2) + edu + race + bmi + ns(pky, 2), data=MYDATA, family=binomial)
            }
	   }

	   if(Gender=="F"){

           # FROM RDS -----------------
           myfit.glm <- myfit.glm.F.FHL

           if (1==0) {
	   		# myfit = lrm(fh ~ age + edu +  bmi + pky, data=MYDATA, x=T,y=T)
			myfit.glm = glm(fh ~ age + edu + bmi + pky , data=MYDATA, family=binomial)

	   		#myfit = lrm(fh ~ ns(age,2) + edu +  bmi + pky, data=MYDATA, x=T,y=T)
			#myfit.glm = glm(fh ~ ns(age,2) + edu + bmi + pky , data=MYDATA, family=binomial)
            }


	   }#end of

		summary(myfit.glm)
		# Coefficients:
		#              Estimate Std. Error z value Pr(>|z|)
		# (Intercept) -2.065920   0.246758  -8.372  < 2e-16 ***
		# age         -0.006586   0.003252  -2.025 0.042831 *
		# educollege  -0.155969   0.046923  -3.324 0.000888 ***
		# edupostcol  -0.114956   0.044677  -2.573 0.010081 *
		# raceA       -0.134506   0.092414  -1.455 0.145539
		# raceB       -0.016797   0.080850  -0.208 0.835417
		# raceH       -0.554551   0.144501  -3.838 0.000124 ***
		# bmi          0.007960   0.004035   1.973 0.048537 *
		# ns(pky, 2)1  1.034937   0.120686   8.575  < 2e-16 ***
		# ns(pky, 2)2  0.856536   0.309163   2.770 0.005597 **

		if(Gender=="M"){
            if (1==0) {
			ns.mat.age = with(MYDATA, ns(age,2))
			ns.mat.pky = with(MYDATA, ns(pky,2))
            }
		}#end of


		if(Gender=="F"){

			ns.mat.age = ns.mat.pky = NULL
			#ns.mat.pky = with(MYDATA, ns(pky,2))

		}#end of


# 		if(Gender=="F"){
#
# 			ns.mat.age = with(MYDATA, ns(age,2))
# 			#ns.mat.pky = with(MYDATA, ns(pky,2))
#
# 		}#end of

		# > ns.mat.age[1:3,]
		#              1           2
		# [1,] 0.5561763  0.05267204
		# [2,] 0.5662628 -0.21084190
		# [3,] 0.4238313 -0.24371337
		# > ns.mat.pky[1:3,]
		#              1           2
		# [1,] 0.0000000  0.00000000
		# [2,] 0.1997805 -0.09623106
		# [3,] 0.2623123 -0.11994754
		#

		# Logistic Regression Model
		#
		# lrm(formula = fh ~ age + edu + race + bmi + ns(pky, 2), data = MYDATA,
		#     x = T, y = T)
		#                       Model Likelihood     Discrimination    Rank Discrim.
		#                          Ratio Test            Indexes          Indexes
		# Obs         38340    LR chi2     140.39    R2       0.008    C       0.557    <---AUC
		#  0          34494    d.f.             9    g        0.218    Dxy     0.114
		#  1           3846    Pr(> chi2) <0.0001    gr       1.244    gamma   0.118
		# max |deriv| 1e-06                          gp       0.020    tau-a   0.021
		#                                            Brier    0.090
		#
		#             Coef    S.E.   Wald Z Pr(>|Z|)
		# Intercept   -2.0659 0.2468 -8.37  <0.0001
		# age         -0.0066 0.0033 -2.03  0.0428
		# edu=college -0.1560 0.0469 -3.32  0.0009
		# edu=postcol -0.1150 0.0447 -2.57  0.0101
		# race=A      -0.1345 0.0924 -1.46  0.1455
		# race=B      -0.0168 0.0809 -0.21  0.8354
		# race=H      -0.5546 0.1445 -3.84  0.0001
		# bmi          0.0080 0.0040  1.97  0.0485
		# 1            1.0349 0.1207  8.58  <0.0001
		# 2            0.8565 0.3092  2.77  0.0056

		xx=summary(myfit.glm)$coef
		or=lm2=myOR.CI4(xx,bName="Estimate",sName="Std. Error",pName="Pr(>|z|)",zName="z value",pval=T)
		row.names(or)=row.names(xx)
		or[,-7]
		#               OR  CI1  CI2   beta    sd        pval2
		# (Intercept) 0.13 0.08 0.21 -2.066 0.247 5.652773e-17
		# age         0.99 0.99 1.00 -0.007 0.003 4.283115e-02
		# educollege  0.86 0.78 0.94 -0.156 0.047 8.875023e-04
		# edupostcol  0.89 0.82 0.97 -0.115 0.045 1.008105e-02
		# raceA       0.87 0.73 1.05 -0.135 0.092 1.455390e-01
		# raceB       0.98 0.84 1.15 -0.017 0.081 8.354169e-01
		# raceH       0.57 0.43 0.76 -0.555 0.145 1.241903e-04
		# bmi         1.01 1.00 1.02  0.008 0.004 4.853654e-02
		# ns(pky, 2)1 2.81 2.22 3.57  1.035 0.121 9.867203e-18
		# ns(pky, 2)2 2.35 1.28 4.32  0.857 0.309 5.597113e-03

	    #setwd(outdir)
	    #write.csv(or, "FH.logitmodel.female.csv")
	    #write.csv(or, "FH.logitmodel.male.csv")

	   ########### [a] Diagnostics  ###############################################

   		# AUC
   		# brier score
   		# classification error
   		# goodness-of-fit


	   ########### [b] Apparent validation ########################################

	   doVal=F
	   if(doVal==T){

			   mycal=calibrate(myfit)
	   	   		plot(mycal)
			   ########### [c] Variable importance and BMA method #########################

				### BMA ########

				#library(BMA)
				glm.out.va= bic.glm(fm3, glm.family=binomial, data=MYDATA)
				summary(glm.out.va)

				par(mfrow=c(1,1))
				imageplot.bma(glm.out.va,cex=0.5)
				par(mfrow=c(1,1))
				plot(glm.out.va)


				######### relative importance #########
				# > fm
				# fh ~ age + edu + race + bmi + ns(pky, 2)

				#gg=glm(fm, data=MYDATA, family=binomial)
				gg=myfit.glm
				an=anova(gg)
				an
				# Analysis of Deviance Table
				#
				# Model: binomial, link: logit
				#
				# Response: fh
				#
				# Terms added sequentially (first to last)
				#
				#
				#            Df Deviance Resid. Df Resid. Dev
				# NULL                       38339      24980
				# ns(age, 2)  2    5.917     38337      24974
				# edu         2   29.112     38335      24945
				# race        3   23.313     38332      24922
				# bmi         1    5.535     38331      24916
				# ns(pky, 2)  2   78.359     38329      24838


				# > names(an)
				# [1] "Df"         "Deviance"   "Resid. Df"  "Resid. Dev"

				tt1=an$Dev[-1] - an$Df[-1]


				if(Gender=="M") names(tt1)=c("age","edu","race","bmi","pack-year")
				if(Gender=="F") names(tt1)=c("age","edu","bmi","pack-year")

				tt2=tt1[order(tt1,decreasing=T)]
				barplot(tt2/sum(tt2),col=heat.colors(length(tt2)),las=2, cex.lab=1.2, cex.main=1.5, cex.axis=1.5,
							ylab="Relative Importance (%)", main="Relative Importance of Variables", ylim=c(0,0.8))


				barplot(tt2,col=heat.colors(length(tt2)),las=2, cex.lab=1.2, cex.main=1.5, cex.axis=1.5,
							ylab="Chisq-df", main="Relative Importance of Variables")#, ylim=c(0,0.8))


			   ########### [6] 10-fold or Bootstrap validation ###################################################

				#mycalboot=calibrate(myfit, method="boot", B=40)


			   val=validate(myfit,method="boot",B=40)
				### include c-index ###
				cindex2=0.5*(val["Dxy",]+1)
				cindex2["optimism"] = cindex2["training"]-cindex2["test"] # how much excess?
				cindex2["index.corrected"] = cindex2["index.orig"]-cindex2["optimism"]
				cindex2["n"]=val["Dxy","n"]
				val2=rbind(cindex=cindex2,val)
				val2
				#             index.orig     training        test     optimism index.corrected   n


				B=ceiling(0.1*nrow(MYDATA));B
				#[1] 100
				valcv=validate(myfit, method="crossvalidation", B=500)

				#           index.orig training    test optimism index.corrected   n
				# Dxy           0.2832   0.2833  0.2493   0.0340          0.2492 100
				# R2            0.0893   0.0894  0.2657  -0.1763          0.2656 100
				# Intercept     0.0000   0.0000  1.4258  -1.4258          1.4258 100
				# Slope         1.0000   1.0000 10.3894  -9.3894         10.3894 100
				# Emax          0.0000   0.0000  0.4214   0.4214          0.4214 100
				# D             0.0682   0.0683  0.1444  -0.0761          0.1443 100
				# U            -0.0020  -0.0020  0.1318  -0.1338          0.1318 100
				# Q             0.0702   0.0703  0.0126   0.0577          0.0125 100
				# B             0.2316   0.2316  0.2359  -0.0043          0.2360 100
				# g             0.6224   0.6228  8.3184  -7.6956          8.3180 100
				# gp            0.1456   0.1456  0.1973  -0.0517          0.1973 100

				### include c-index ###
				cindex2=0.5*(valcv["Dxy",]+1)
				cindex2["optimism"] = cindex2["training"]-cindex2["test"] # how much excess?
				cindex2["index.corrected"] = cindex2["index.orig"]-cindex2["optimism"]
				cindex2["n"]=valcv["Dxy","n"]
				val2cv=rbind(cindex=cindex2,valcv)
				val2cv
				#             index.orig     training        test     optimism index.corrected   n


			   ########### [7] External validation ###############################################################


				pred.logit = predict(myfit, mydat.val)
				# > pred.logit[1:4]
				#        4        5        6        7
				# 1.138703 1.251589 1.193375 1.396058
				phat = 1/(1+exp(-pred.logit))
				phat[1:10]
				#          3          8          9         14         15         16         18         24         25         26
				# 0.11712426 0.06388822 0.07808821 0.14458999 0.08740165 0.08813680 0.10004402 0.11276686 0.09241890 0.08233308

				###compare predicted prob vs. actual outcome y
				valprob = val.prob(p=phat, y=mydat.val[,"fh"],cex=0.7)#, g.group=4)#,m=5)#,g=10)#,g.group=2,cex=0.5);valprob

				valprob = val.prob(p=phat, y=mydat.val[,"fh"],cex=0.7, lim=c(0,0.15))#, g.group=4)#,m=5)#,g=10)#,g.group=2,cex=0.5);valprob
				valprob
				t(valprob)
				#           Dxy  C (ROC)         R2          D D:Chi-sq D:p      U    U:Chi-sq U:p          Q     Brier
				# [1,] 0.260818 0.630409 0.07829283 0.05848725 30.24363  NA -0.004 6.82121e-13   1 0.06248725 0.2350141
				#        Intercept     Slope      Emax       S:z       S:p       Eavg
				# [1,] -0.06782444 0.9099561 0.0327751 0.7558215 0.4497562 0.03672528

				###  validation by sex ###
				valprob2 = val.prob(p=phat, y=mydat.val[,"fh"],cex=0.5,group=mydat.val[,"race"],lim=c(0,0.15))#,g=10)#,g.group=2,cex=0.5);valprob

				valprob3 = val.prob(p=phat, y=mydat.val[,"fh"],cex=0.5,group=mydat.val[,"cigstat"],lim=c(0,0.15))#,g=10)#,g.group=2,cex=0.5);valprob
				plot(valprob3,lim=c(0,0.3))

				valprob3 = val.prob(p=phat, y=mydat.val[,"fh"],cex=0.5,group=mydat.val[,"edu"],lim=c(0,0.15))#,g=10)#,g.group=2,cex=0.5);valprob
				plot(valprob3,lim=c(0,0.3))

				#valprob3 = val.prob(p=phat, y=mydat.val[,"fh"],cex=0.5,group=mydat.val[,"age.cat"],lim=c(0,0.15))#,g=10)#,g.group=2,cex=0.5);valprob
				#plot(valprob3,lim=c(0,0.3))

				#   fh      bmi     edu race cigstat cigyears cigstop pky cigday age age.cat
				# 3  0 34.66130  <=high    W  Former       35    0_20  35     20  62   60_65
				# 8  0 26.60024  <=high    H  Former       23   20_40  23     20  60   60_65
				# 9  0 24.44346 college    W   Never        0   never   0      0  67   65_70


		}#end of doVal

   		########### [8] Calibration of parameters using US census data #######################################################################


		glm.fh = myfit.glm


		######## average risk of FH at age = 55

		mycoef = glm.fh$coef
		mycoef
		#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi
		# -2.518529315  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042
		#  ns(pky, 2)1  ns(pky, 2)2
		#  1.030344727  0.852142491

		#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol          bmi          pky
		# -2.153809877 -0.067902109  0.114585080 -0.240008776 -0.252735814  0.005706452  0.005957014

		# > glm.fh$model[1:3,]
		#   fh age     edu race      bmi ns(pky, 2).1 ns(pky, 2).2
		# 1  0  67  <=high    B 25.78094   0.00000000   0.00000000
		# 2  0  62 postcol    W 25.71645   0.19978051  -0.09623106
		# 4  0  57  <=high    W 23.54244   0.26231225  -0.11994754




		x=AGE = 55
		# > ref.fh
		# [1] 10.9   <--- at age 55


		if(Gender=="M"){

			ave.eff.prob.before = myGetFHProb(x, mycoef, ref.edu, ref.race,ref.pky.mean.55, Gender, MYDATA)
			ave.eff.prob.before
			# [1] 0.08163258

		}#end of


		if(Gender=="F"){

			### liner age effec
			ave.eff.prob.before = myGetFHProb.F2(x, mycoef, ref.edu, ref.pky.mean.55,ref.bmi.mean.55, Gender, MYDATA)

			## non-linear age
			#ave.eff.prob.before = myGetFHProb.F(x, mycoef, ref.edu, ref.pky.mean.55,ref.bmi.mean.55, Gender, MYDATA)
			ave.eff.prob.before
			# [1][1] 0.1238629

		}#end of





		myages = matrix(45:90,ncol=1)

		if(Gender=="M") probs.fh = apply(myages, 1, myGetFHProb,  mycoef=mycoef, ref.edu=ref.edu, ref.race=ref.race,ref.pky.mean.55=ref.pky.mean.55, Gender=Gender, MYDATA=MYDATA)
		if(Gender=="F") probs.fh = apply(myages, 1, myGetFHProb.F2,  mycoef=mycoef, ref.edu=ref.edu,ref.pky.mean.55=ref.pky.mean.55, ref.bmi.mean.55=ref.bmi.mean.55, Gender=Gender, MYDATA=MYDATA)

		plot(myages, probs.fh*100, pch=17,col="red", xlab="Age",ylab="Prevalence (%) of FH", main="Multivariate Model")



		ave.eff.prob.before
		ref.fh
		# [1] 0.07899275
		# > 		ref.fh
		# [1] 10.9

		# > 		ave.eff.prob.before  ----> female
		# [1] 0.116374
		# > 		ref.fh
		# [1] 10.9

	    ############################ calibration ##########################################

	    doThis=F
	    if(doThis==T){



		    ##### female calibration ###
	    	mycoef2 = mycoef
	    	mycoef2[1] = mycoef[1]*1.031 # increase the intercept (negative)

	    	myGetFHProb.F2(x, mycoef=mycoef2, ref.edu, ref.pky.mean.55, ref.bmi.mean.55,Gender, MYDATA)
	    	#[1]  0.1093025
	    	ref.fh
			#[1] 10.9

			# > mycoef
			#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi
			# -2.518529315  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042
			#  ns(pky, 2)1  ns(pky, 2)2
			#  1.030344727  0.852142491
			# > mycoef2
			#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi
			# -2.165935211  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042
			#  ns(pky, 2)1  ns(pky, 2)2
			#  1.030344727  0.852142491

	    	##### male calibration ###
	    	mycoef2 = mycoef
	    	mycoef2[1] = mycoef[1]*0.86 # increase the intercept (negative)

	    	myGetFHProb(x, mycoef=mycoef2, ref.edu, ref.race,ref.pky.mean.55, Gender, MYDATA)
	    	#[1] 0.1087554
	    	ref.fh
			#[1] 10.9

			# > mycoef
			#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi
			# -2.518529315  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042
			#  ns(pky, 2)1  ns(pky, 2)2
			#  1.030344727  0.852142491
			# > mycoef2
			#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi
			# -2.165935211  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042
			#  ns(pky, 2)1  ns(pky, 2)2
			#  1.030344727  0.852142491


	    }#end of



		    mycoef.adj = mycoef
	    	if(Gender=="M") {

	    			mycoef.adj[1] = mycoef[1]*0.853 # increase the intercept (negative)
	    			ave.eff.prob = myGetFHProb(x, mycoef=mycoef.adj, ref.edu, ref.race,ref.pky.mean.55, Gender, MYDATA)


	        }
	    	if(Gender=="F") {

	    			mycoef.adj[1] = mycoef[1]*1.031 # increase the intercept (negative)
	    			ave.eff.prob = myGetFHProb.F2(x, mycoef=mycoef.adj, ref.edu, ref.pky.mean.55, ref.bmi.mean.55,Gender, MYDATA)

	    	}

	    	ave.eff.prob
			ref.fh

			# > ave.eff.prob
			# [1] 0.1087554
			# > ref.fh
			# [1] 10.9

			myages = matrix(45:90,ncol=1)

			if(Gender=="M") probs.fh2 = apply(myages, 1, myGetFHProb,  mycoef=mycoef.adj, ref.edu=ref.edu, ref.race=ref.race,ref.pky.mean.55=ref.pky.mean.55, Gender=Gender, MYDATA=MYDATA)
			if(Gender=="F") probs.fh2 = apply(myages, 1, myGetFHProb.F2,  mycoef=mycoef.adj, ref.edu=ref.edu, ref.pky.mean.55=ref.pky.mean.55, ref.bmi.mean.55=ref.bmi.mean.55,Gender=Gender, MYDATA=MYDATA)

			plot(myages, probs.fh2*100, pch=17,col="red", xlab="Age",ylab="Prevalence (%) of FH", main="(After calibration) Multivariate Model")



			########### barplot comparison #############

		  par(mar=c(5,5,5,3))
			#ref.fh.ci = c(9.74, 11.90)
			ci1=ref.fh.ci[1]
			ci2=ref.fh.ci[2]

		   mat=cbind(ref.fh, ave.eff.prob.before*100)
		   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="FH prevalence (%)",
		   main="[Before Adjustment] \n Prevalence (%) of FH (age 55)", cex.main=1.5, ylim=c(0,15))

		   ##### confidence interval ###
		   xs = c(1.5,2.5)#,7.5)

		   for(u in 1:length(xs)){


		   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

		   }#end of

		  legend(x="topleft", legend=c("Reference", "Model-based"), fill=c("red","yellow"), ncol=2,cex=1)



		######### after calibration



		   mat=cbind(ref.fh, ave.eff.prob*100)
		   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="FH prevalence (%)",
		   main="[After Adjustment] \n Prevalence (%) of FH (age 55)", cex.main=1.5, ylim=c(0,15))

		   ##### confidence interval ###
		   xs = c(1.5,2.5)#,7.5)

		   for(u in 1:length(xs)){


		   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

		   }#end of

		  legend(x="topleft", legend=c("Reference", "Model-based"), fill=c("red","yellow"), ncol=2,cex=1)



			  ANS = list(mycoef.adj=mycoef.adj,  mycoef.before = mycoef, glm.fh = glm.fh, glm.or= or,  prev.fh.adj = ave.eff.prob, prev.fh.unadj = ave.eff.prob.before, ref.fh = ref.fh/100, ref.fh.ci = ref.fh.ci, ns.mat.age=ns.mat.age, ns.mat.pky=ns.mat.pky)
			  ANS



}#end of the main myFHL2.given

myFHL.cond<- function(mydat, ref.fh, ref.pky,  ref.edu, ref.race, Gender){  # fit family history

		############ Fit Pr(Family history of lung cancer| gender, race, age, education, smoking) ##########################
					#logistic regression using PLCO data and offsets using prevalence data for FH

		# lung_fh Family History of Lung Cancer?
				# Derived from question 21
				# .F="No Form"
				# .M="Missing"
				# 0="No"
				# 1="Yes, immediate family member" 9="Possibly - relative or cancer type not clear"

		#####################[0] Define variables ################################################

		##### (1) define smoking status ###########
				# prevalence data: http://en.wikipedia.org/wiki/Prevalence_of_tobacco_consumption
				cigstat=mydat[,"cig_stat"]
				# > table(cig_stat)
				# cig_stat
				#     0     1     2     never, current, former
				# 26855  8581 37260

						tb.cig=table(cigstat)
						round(tb.cig/sum(tb.cig),2)
						# cigstat
						#    0    1    2
						# 0.37 0.12 0.51

				cigstat2=cigstat
				cigstat2[cigstat==0]="Never"
				cigstat2[cigstat==1]="Current"
				cigstat2[cigstat==2]="Former"

				# for polytomous ##
				cigstat3=cigstat
				cigstat3[cigstat==0]="0.Never"
				cigstat3[cigstat==1]="2.Current"
				cigstat3[cigstat==2]="1.Former"



		#### (2) education ########################
		#educat #Education
				# Question 3
				# .F="No Form" .M="Missing"
				# 1="Less than 8 years" 2="8-11 years"
				# 3="12 years or completed high school" 4="Post high school training other than college"
				# 5="Some college"
				# 6="College graduate" 7="Postgraduate"

				edu0=mydat[,"EDUCAT"]
				# edu
				#     1     2     3     4     5     6     7     M
				#   879  5035 13260  8905 14837 13757 15862   161
				# not finished highschool - highschool graduate -college graduate - postgraduate
				#   (1,2)                        (3,4,5)                 6                7

				edu=edu0
				#edu[edu0==1 | edu0==2]=1
				edu[edu0 <=5 ]=1
				edu[edu0==6]=2
				edu[edu0==7]=3
				edu[edu0=="M"]=NA

						tb.edu=table(edu)/sum(table(edu))
						tb.edu
						# edu
						#         1         2         3
						# 0.7016927 0.1504578 0.1478495

	            ## factor variable ##
				edu2=edu
				edu2[edu==1]="<=high"
				edu2[edu==2]="college"
				edu2[edu==3]="postcol"
				tb.edu2=table(edu2)/sum(table(edu2))
				tb.edu2
				# edu2
				#    <=high   college   postcol
				# 0.7016927 0.1504578 0.1478495

						doThis=F
						if(doThis==T){
							edu=edu0
							edu[edu0==1 | edu0==2]=1
							edu[edu0==3 | edu0==4 | edu0==5]=2
							edu[edu0==6]=3
							edu[edu0==7]=4
							edu[edu0=="M"]=NA

							tb.edu=table(edu)
							# edu
							#     1     2     3     4
							#  5914 37002 13757 15862
							# > round(tb.edu/sum(tb.edu),3)
							# edu
							#     1     2     3     4
							# 0.082 0.510 0.190 0.219

							edu2=edu
							edu2[edu==1]="<high"
							edu2[edu==2]="high"
							edu2[edu==3]="college"
							edu2[edu==4]="postcol"

						}#



		####### (3) race #############
				# 1="White, Non-Hispanic" 2="Black, Non-Hispanic" 3="Hispanic"
				# 4="Asian"
				# 5="Pacific Islander" 6="American Indian" 7="Missing"

				race0=mydat[,"race7"]
				# race0
				#     1     2     3     4     5     6     7
				# 64222  3273  1569  2957   452   185    38

				## merge 4-7
				# "white" - "black" - "hispanic" - "asian"
				race=race0
				race[race0>4]=NA
						tb.race=table(race)
						tb.race
						# race
						#     1     2     3     4
						# 64222  3273  1569  3632
						round(tb.race/sum(tb.race),2)
						# race
						# race
						#    1    2    3    4
						# 0.89 0.05 0.02 0.04
				race2=race
				race2[race==1]="W"
				race2[race==2]="B"
				race2[race==3]="H"
				race2[race==4]="A"

	   #### (4) define "Edu-race" variable #############


				race.edu=paste(race2,edu2,sep="-") #[1] "W-<=high"   "NA-college" "W-<=high"   "W-college"  "W-college"
				race.edu[is.na(race2) | is.na(edu2)] = NA
				race.edu=as.factor(as.character(race.edu))

	  #####  (5) BMI ########

              # clean chars ---------------------
              temp <- mydat[,"bmi_curr"]
              temp[temp %in% c("F","M","R")] <- NA
              temp_ <- mydat[,"bmi_curc"]
              temp_[temp_ %in% c("F","M","R")] <- NA

              # bmi=as.numeric(mydat[,"bmi_curr"]) #[1] 38.07647 31.81634 22.69663 27.25385 28.03809 24.19162 30.57929 25.16239 22.28669 23.10435
              bmi=as.numeric(temp)
              # bmicat=as.numeric(mydat[,"bmi_curc"]) #[1] 38.07647 31.81634 22.69663 27.25385 28.03809 24.19162 30.57929 25.16239 22.28669 23.10435
              bmicat=as.numeric(temp_)


	  ####  (6) define age variable

			age=as.numeric(mydat[,"age"])
			# > range(age)
			# [1] 49 78

	 ####### (7) define Smoking related variables ##
			#cig_per_day  of Cigarettes Smoked Per Day
					#The maximum number of cigarettes smoked per day, based on the range specified. The category 81+ is set to 100.

			# cig_years_rnd # of Years Smoked Cigarettes
					# Derived from questions 10-13. This differs from cig_years because it uses randomization age instead of BQ age.
					# Numeric .F="No Form" .M="Missing"
			#cig_stop_rnd # of Years Since Stopped Smoking Cigarettes
					# Derived from questions 12 and 13. This differs from cig_stop because it uses randomization age instead of BQ age.
					# Numeric
					# .F="No Form" .M="Missing" .N="Not Applicable"


			### pack-years ##
			pky0=mydat[,"pack_years_rnd"]
			pky2=pky0
			pky2[pky0=="M"]=NA
			pky2=as.numeric(pky2)
			#[1]   0 260

			### make category (0-10), (10-30), (30-60), (60-100), 100+
			pky=pky2
			pky[pky2 <=10] = "lst10"
			pky[pky2 > 10 & pky2<=30] ="10_30"
			pky[pky2 > 30 & pky2 <=60] = "30_60"
			pky[pky2 > 60 & pky2 <=100] = "60_100"
			pky[pky2>100]="gt100"
			table(pky)
			# pky
			#  10_30  30_60 60_100  gt100  lst10
			#  14808  14932   7212   2261  33430

			#### cigday ##
			cigday0=mydat[,"cig_per_day"]
				# > table(mydat[,"cig_per_day"])
				#
				#    10   100    20    30    40    60    80     M     N
				#  7637   177 16972 10579  6290  3511   668     7 26855   <--- never smoker

				#### group: N, (0-20], (20-40], (40-60], (60,100]

			cigday=cigday0
			cigday[cigday0=="N"]	= "never"
			cigday[cigday0==10 | cigday0==20 ]	= "0_20"
			cigday[cigday0==30 | cigday0==40 ]	= "20_40"
			cigday[cigday0==50 | cigday0==60 ]	= "40_60"
			cigday[cigday0==70 | cigday0==80 | cigday0==90 | cigday0==100]	= "60_100"
			cigday[cigday0=="M"]	= NA

			table(cigday)
			# cigday
			#  20_40  40_60 60_100  lst20  never
			#  16869   3511    845  24609  26855


			## define cigday2 ###

			cigday2=cigday0
			cigday2[cigday0=="N"]=0
			cigday2[cigday0=="M"]=NA
			cigday2=as.numeric(cigday2)


			### define cigstop ###
			cigstop0=mydat[,"cig_stop_rnd"]
			# > #range(as.numeric(cigstop0),na.rm=T)
			# [1]  0 62

			# cigstop0
			#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24    25    26    27    28    29     3
			#  8581   697   825  1191   975   983   975   969  1059   962   858   845   915   750  1217   884   884   911   874  1062  1048  1026   992  1055   728
			#    30    31    32    33    34    35    36    37    38    39     4    40    41    42    43    44    45    46    47    48    49     5    50    51    52
			#  1187  1056   975   904   812   772   623   523   466   414   665   338   342   284   228   209   181   137   117   110    80   810    49    44    24
			#    53    54    55    56    57    58    59     6    62     7     8     9     N
			#    15    15     3     2     3     3     2   785     1   808   805   771 26867
			# > table(cigstop0,cigstat2)
			#         cigstat2
			# cigstop0 Current Former Never
			#      0      8581      0     0  --> current smoker has cigstop=0, yes makes sens
			#      0.5       0    697     0
			# ..
			#      8         0    805     0
			#      9         0    771     0
			#      N         0     12 26855    ---> never smoker nas cigstop="N"

            # F, M, N ------------------------
            temp <- cigstop0
            temp[temp %in% c("F","M","N")] <- NA

			### define: N, 0-20, 20-40, 40+ ##
			# tt=as.numeric(cigstop0)
            tt=as.numeric(temp)

			# > range(tt,na.rm=T)
			# [1]  0 62
			cigstop=cigstop0
			cigstop[cigstop0=="N"]="never"
			cigstop[tt==0] = "0"
			cigstop[tt>0 & tt <=20] = "0_20"
			cigstop[tt >20 & tt<=40] = "20_40"
			cigstop[tt >40 ] = "gt40"

			table(cigstop)
			#              0           0_20          20_40 gt40.neversmok          never
			#           8581          18593          16806           1849          26867
			#boxplot(tt~cigstop)
			cigstop2=tt


			### define cigyears ###

			cigyears0=mydat[,"cig_years_rnd"]
			# > table(cigyears0)
			# cigyears0
			#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24    25    26    27    28    29     3
			# 26855    92   225  1106   752   965   748  1011  1009   815   964   950   930   453  1312   873  1088   946  1058  1028   851   908   935   930   419
			#    30    31    32    33    34    35    36    37    38    39     4    40    41    42    43    44    45    46    47    48    49     5    50    51    52
			#  1034   873  1012   940  1024  1067   977  1137  1124  1255   511  1340  1180  1114  1039   959   838   817   654   607   551   599   490   424   349
			#    53    54    55    56    57    58    59     6    60    61    62    63    64     7     8     9     M
			#   256   205   155    99    83    44    25   599    24    12     4     5     3   662   628   708    46
			tt=as.numeric(mydat[,"cig_years_rnd"])
			# range(tt,na.rm=T)
			# [1]  0 64

			## group:  0-20, 20-40, 40-60
			cigyears=cigyears0
			cigyears[cigyears0=="M"]=NA
			cigyears[tt==0] = "0"
			cigyears[tt >0 & tt <=20] = "0_20"
			cigyears[tt >20 & tt<=40] = "20_40"
			cigyears[tt >40] = "gt40"

			table(cigyears)
			# cigyears
			#     0  0_20 20_40  gt40
			# 26855 15458 20400  9937
			#boxplot(tt~cigyears)

			## cigyears.numeric ##

			cigyears2=cigyears0
			cigyears2[cigyears0=="M"]=NA
			cigyears2=as.numeric(cigyears2)

	####### (8) family history of lung cancer ############################################


		fh0=mydat[,"lung_fh"]
		# fh0
		#     0     1     9     M
		# 62796  6851  2453   596

		fh=fh0
		fh[fh0=="9" | fh0=="M"]=NA
		fh=as.numeric(fh)
		tb.fh=table(fh)/sum(table(fh))
		tb.fh
		# fh
		#          0          1
		# 0.90163252 0.09836748



	#### (9) plot distributions of cigstat, education and race (joint, marginal and conditional etc) ###

			#setwd(outdir)
			#plotfile1=paste("Plot_smoking.race.edu",Gender,"pdf",sep=".")
			#pdf(plotfile1)

					TAB=tb.fh
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,1.3),main="(PLCO) Family History of Lung Cancer",cex.axis=1.5,cex.lab=2)
					text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")


    ################## [2] [Before Adjustment] Fit Pr(FH | variables) using logistic regression #############################

		### define response variable and covariates ##

		Y=fh

	##### manually conducted variable selection ###

		if(Gender=="M"){

			mat=cbind(edu2,race2,cigstat2, cigstop, cigday, cigyears,pky)#,age)
			covs.all=cbind(myDummyVar3(mat,refer=T,SORT=F),bmi=bmi,age=age,fh=fh)
			# > colnames(covs.all)
			#  [1] "edu2.<=high"            "edu2.college"           "edu2.postcol"           "race2.A"                "race2.B"
			#  [6] "race2.H"                "race2.W"                "cigstat.0"              "cigstat.1"              "cigstat.2"
			# [11] "cigstop.0"              "cigstop.0_20"           "cigstop.20_40"          "cigstop.gt40.neversmok" "cigday.0_20"
			# [16] "cigday.20_40"           "cigday.40_60"           "cigday.60_100"          "cigday.never"           "cigyears.0"
			# [21] "cigyears.0_20"          "cigyears.20_40"         "cigyears.gt40"          "pky.10_30"              "pky.30_60"
			# [26] "pky.60_100"             "pky.gt100"              "pky.lst10"              "bmi"                    "age"

			### covariate names ##
			cnames=c("edu2","race","cigstop","pky")#,"age")#,"bmi")

			#cnames=c("edu2","cigstat2","pky","age")
			#cnames=c("edu2","race2","cigstat2","pky","age")

				#covnames=colnames(covs.all)[multiGrep(c("edu2","cigstop","pky","bmi"),colnames(covs.all))]
				#covnames=colnames(covs.all)[multiGrep(cnames,colnames(covs.all))]

				#  [1] "edu2.<=high"            "edu2.college"           "edu2.postcol"           "race2.A"                "race2.B"
				#  [6] "race2.H"                "race2.W"                "cigstop.0"              "cigstop.0_20"           "cigstop.20_40"
				# [11] "cigstop.gt40.neversmok" "cigstop.never"          "pky.10_30"              "pky.30_60"              "pky.60_100"
				# [16] "pky.gt100"              "pky.lst10"              "bmi"                    "age"
				#refcol=c(1,7,12,17)
				#covnames=colnames(covs.all)[multiGrep(c("edu2","race2","pky","bmi"),colnames(covs.all))]
				#covnames=colnames(covs.all)[multiGrep(c("edu2","race2","pky","bmi","age"),colnames(covs.all))]

			#covnames=colnames(covs.all)[multiGrep(c("edu2","cigstat2","pky","bmi"),colnames(covs.all))]
			covnames=colnames(covs.all)[multiGrep(cnames,colnames(covs.all))]
				covnames
				#  [1] "edu2.<=high"  "edu2.college" "edu2.postcol" "race2.A"      "race2.B"      "race2.H"      "race2.W"      "pky.10_30"    "pky.30_60"
				# [10] "pky.60_100"   "pky.gt100"    "pky.lst10"    "bmi"          "age"

				#  [1] "edu2.<=high"  "edu2.college" "edu2.postcol" "race2.A"      "race2.B"      "race2.H"      "race2.W"      "pky.10_30"    "pky.30_60"
				# [10] "pky.60_100"   "pky.gt100"    "pky.lst10"    "bmi"          "age"

				#  [1] "edu2.<=high"      "edu2.college"     "edu2.postcol"     "race2.A"          "race2.B"          "race2.H"          "race2.W"
				#  [8] "cigstat2.Current" "cigstat2.Former"  "cigstat2.Never"   "pky.10_30"        "pky.30_60"        "pky.60_100"       "pky.gt100"
				# [15] "pky.lst10"        "bmi"              "age"

		refs=c("edu2.<=high","race2.W","cigstat2.Never","pky.lst10","cigstop.never","cigyears.0")
		refcol=multiGrep(refs,covnames);refcol;refs

				#refcol=c(1,7,10, 15)

		mycov = covs.all[,covnames[-refcol]]
		colnames(mycov)
				#  [1] "edu2.college"  "edu2.postcol"  "race2.A"       "race2.B"       "race2.H"       "cigstop.0"     "cigstop.0_20"
				#  [8] "cigstop.20_40" "cigstop.gt40"  "pky.10_30"     "pky.30_60"     "pky.60_100"    "pky.gt100"


		exc=c(3,4,6:9)
		mycov=mycov[,-exc]
		colnames(mycov)

				#mydata=data.frame(cbind(Y=Y,mycov))
		mydata=na.omit(data.frame(cbind(Y=Y,mycov)))

	}#end of Gender=="M"

	if(Gender=="F"){


				mat=cbind(edu2,race2,cigstat2, cigstop, cigday, cigyears,pky)#,age)
				covs.all=cbind(myDummyVar3(mat,refer=T,SORT=F),bmi=bmi,age=age,fh=fh)
				# > colnames(covs.all)
				#  [1] "edu2.<=high"            "edu2.college"           "edu2.postcol"           "race2.A"                "race2.B"
				#  [6] "race2.H"                "race2.W"                "cigstat.0"              "cigstat.1"              "cigstat.2"
				# [11] "cigstop.0"              "cigstop.0_20"           "cigstop.20_40"          "cigstop.gt40.neversmok" "cigday.0_20"
				# [16] "cigday.20_40"           "cigday.40_60"           "cigday.60_100"          "cigday.never"           "cigyears.0"
				# [21] "cigyears.0_20"          "cigyears.20_40"         "cigyears.gt40"          "pky.10_30"              "pky.30_60"
				# [26] "pky.60_100"             "pky.gt100"              "pky.lst10"              "bmi"                    "age"
		cnames=c("edu2","cigstat2","pky")#,"age")
		#cnames=c("edu2","race2","cigstat2","pky","age")

				#covnames=colnames(covs.all)[multiGrep(c("edu2","cigstop","pky","bmi"),colnames(covs.all))]
				#covnames=colnames(covs.all)[multiGrep(cnames,colnames(covs.all))]

				#  [1] "edu2.<=high"            "edu2.college"           "edu2.postcol"           "race2.A"                "race2.B"
				#  [6] "race2.H"                "race2.W"                "cigstop.0"              "cigstop.0_20"           "cigstop.20_40"
				# [11] "cigstop.gt40.neversmok" "cigstop.never"          "pky.10_30"              "pky.30_60"              "pky.60_100"
				# [16] "pky.gt100"              "pky.lst10"              "bmi"                    "age"
				#refcol=c(1,7,12,17)
				#covnames=colnames(covs.all)[multiGrep(c("edu2","race2","pky","bmi"),colnames(covs.all))]
				#covnames=colnames(covs.all)[multiGrep(c("edu2","race2","pky","bmi","age"),colnames(covs.all))]

		#covnames=colnames(covs.all)[multiGrep(c("edu2","cigstat2","pky","bmi"),colnames(covs.all))]
		covnames=colnames(covs.all)[multiGrep(cnames,colnames(covs.all))]
				covnames
				#  [1] "edu2.<=high"  "edu2.college" "edu2.postcol" "race2.A"      "race2.B"      "race2.H"      "race2.W"      "pky.10_30"    "pky.30_60"
				# [10] "pky.60_100"   "pky.gt100"    "pky.lst10"    "bmi"          "age"

				#  [1] "edu2.<=high"  "edu2.college" "edu2.postcol" "race2.A"      "race2.B"      "race2.H"      "race2.W"      "pky.10_30"    "pky.30_60"
				# [10] "pky.60_100"   "pky.gt100"    "pky.lst10"    "bmi"          "age"

				#  [1] "edu2.<=high"      "edu2.college"     "edu2.postcol"     "race2.A"          "race2.B"          "race2.H"          "race2.W"
				#  [8] "cigstat2.Current" "cigstat2.Former"  "cigstat2.Never"   "pky.10_30"        "pky.30_60"        "pky.60_100"       "pky.gt100"
				# [15] "pky.lst10"        "bmi"              "age"

		refs=c("edu2.<=high","race2.W","cigstat2.Never","pky.lst10","cigstop.never","cigyears.0")
		refcol=multiGrep(refs,covnames);refcol;refs

				#refcol=c(1,7,10, 15)

				mycov = covs.all[,covnames[-refcol]]
				# > colnames(mycov)
				#  [1] "edu2.college"           "edu2.postcol"           "race2.A"                "race2.B"                "race2.H"
				#  [6] "cigstop.0"              "cigstop.0_20"           "cigstop.20_40"          "cigstop.gt40.neversmok" "pky.10_30"
				# [11] "pky.30_60"              "pky.60_100"             "pky.gt100"              "bmi"                    "age"

		### exclude something that's insignificant
		exc=c(5)
		mycov=mycov[,-exc]
		colnames(mycov)

		mydata=data.frame(cbind(Y=Y,mycov))
		#mydata=na.omit(data.frame(cbind(Y=Y,mycov)))

	}#end of



		glm0=glm(Y~.,data=mydata,family=binomial)
		summary(glm0)
		# 			 Estimate Std. Error z value Pr(>|z|)
		# (Intercept)  -2.30470    0.02405 -95.841  < 2e-16 ***
		# edu2.college -0.12183    0.03445  -3.537 0.000405 ***
		# edu2.postcol -0.15316    0.03366  -4.550 5.35e-06 ***
		# race2.H      -0.44468    0.10604  -4.193 2.75e-05 ***
		# pky.10_30     0.19594    0.03456   5.669 1.44e-08 ***
		# pky.30_60     0.23352    0.03429   6.810 9.78e-12 ***
		# pky.60_100    0.41927    0.04206   9.969  < 2e-16 ***
		# pky.gt100     0.45980    0.06763   6.799 1.05e-11 ***

		#stp0=step(glm0,method="forward")
		#stp0=glm0
		#stp0=step(glm0,method="backward")
		#glm.fh=summary(stp0)
	stp0=glm0

		xx=summary(stp0)$coef
		or=myOR.CI4(xx,bName="Estimate",sName="Std. Error",pName="Pr(>|z|)",zName="z value",pval=T)
		rownames(or)=rownames(xx)
		or

		glm.fh = glm0


		######## average risk of FH at age = 55

		mycoef = glm.fh$coef
		#  (Intercept) edu2.college edu2.postcol      race2.H    pky.10_30    pky.30_60   pky.60_100
		#   -2.3047022   -0.1218313   -0.1531633   -0.4446783    0.1959373    0.2335248    0.4192692
		#    pky.gt100
		#    0.4597977

		### female
		#      (Intercept)     edu2.college     edu2.postcol cigstat2.Current  cigstat2.Former        pky.30_60       pky.60_100
		#       -2.0509220       -0.2746726       -0.2281866        0.0934186        0.1278226        0.1793763        0.3821623
		#        pky.gt100
		#        0.2605942

        if(Gender=="M"){

				base0 = mycoef[1]


				### average over education ##
				#ref.edu
				# > ref.edu
				#    high college postcol
				#    0.78    0.15    0.07

				## inner product for education effect ##
				ave.edu = sum( ref.edu[c("college","postcol")] * mycoef[c("edu2.college", "edu2.postcol")] )
				#[1] -0.02899613

				### average over race ##
				# > ref.race
				#    W    B    H    A
				# 0.76 0.10 0.08 0.05

				## coefficient is Hispanic vs. non-hispanic

				ave.race = sum(ref.race["H"]*mycoef["race2.H"]  + (1-ref.race["H"])*0)  # just zero term for the rest
				#ave.race
				#[1] -0.03557426

				#### average over smoking ##
				# > ref.pky
				#  lst10  10_30  30_60 60_100  gt100
				#   0.51   0.21   0.21   0.07   0.00

				## inner product ##

				tt1=ref.pky[-1];  tt1
				tt2=mycoef[paste("pky.", names(ref.pky[-1]),sep="")]  ; tt2
				# > tt1
				#  10_30  30_60 60_100  gt100
				#   0.21   0.21   0.07   0.00
				# > tt2
				#  pky.10_30  pky.30_60 pky.60_100  pky.gt100
				#  0.1959373  0.2335248  0.4192692  0.4597977

				ave.smk = sum(tt1*tt2)
				#[1] 0.1195359


				#### sum it up ##

				ave.eff.before = as.numeric( base0 + ave.edu + ave.race + ave.smk) ; ave.eff.before

				ave.eff.prob.before = inv.logit(ave.eff.before); ave.eff.prob.before  # 0.09537217


				#### Adjustment needed #########################

				#ref.fh/100
				#[1] 0.109   ---> a bit higher

				incr = 0.15   ### this is for Gender="M"

				ave.eff = as.numeric((base0 + incr)  + ave.edu + ave.race + ave.smk) ; ave.eff

				ave.eff.prob = inv.logit(ave.eff); ave.eff.prob  # 0.09537217
				#[1] 0.1091224

				#### update the fitted model ###
				# > mycoef
				#  (Intercept) edu2.college edu2.postcol      race2.H    pky.10_30    pky.30_60   pky.60_100
				#   -2.3047022   -0.1218313   -0.1531633   -0.4446783    0.1959373    0.2335248    0.4192692
				#    pky.gt100
				#    0.4597977

				mycoef.adj = mycoef
				# > mycoef.adj[1]
				# (Intercept)
				#   -2.304702
				mycoef.adj[1] = mycoef.adj[1]+incr
				# > mycoef.adj
				#  (Intercept) edu2.college edu2.postcol      race2.H    pky.10_30    pky.30_60   pky.60_100
				#   -2.1547022   -0.1218313   -0.1531633   -0.4446783    0.1959373    0.2335248    0.4192692
				#    pky.gt100
				#    0.4597977


				######### plotting barplot ##########
				tb1=c(ave.eff.prob.before, ref.fh/100); names(tt)=c("Non-adjusted","Ref")
				tb2=c(ave.eff.prob, ref.fh/100); names(tt)=c("Adjusted","Ref")

					TAB=tb1
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,0.15),main="Family History of Lung Cancer",cex.axis=1.5,cex.lab=2,cex.main=2)
					text(1:length(TAB),TAB+0.02,round(TAB,3),cex=2,col="blue")
					axis(1, at=c(0.75,2), labels=c("Unadjusted", " Ref"),cex.axis=1.5)


					TAB=tb2
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,0.15),main="Family History of Lung Cancer",cex.axis=1.5,cex.lab=2,cex.main=2)
					text(1:length(TAB),TAB+0.02,round(TAB,3),cex=2,col="blue")
					axis(1, at=c(0.75,2), labels=c("Adjusted", " Ref"),cex.axis=1.5)


		 }#f(Gender=="M"){

        if(Gender=="F"){

				# > mycoef
				#      (Intercept)     edu2.college     edu2.postcol cigstat2.Current  cigstat2.Former        pky.30_60       pky.60_100
				#       -2.0509220       -0.2746726       -0.2281866        0.0934186        0.1278226        0.1793763        0.3821623
				#        pky.gt100
				#        0.2605942

				base0 = mycoef[1]

				### average over education ##
				#ref.edu
				# > ref.edu
				#    high college postcol
				#    0.78    0.15    0.07

				## inner product for education effect ##
				ave.edu = sum( ref.edu[c("college","postcol")] * mycoef[c("edu2.college", "edu2.postcol")] ); ave.edu
				#[1] -0.02899613

				#### average over smoking status ##
				# > ref.smk
				#   Never  Former Current
				# 0.52135 0.30737 0.17128

				tt1=ref.smk[-1];  tt1
				tt2=mycoef[paste("cigstat2.", names(ref.smk[-1]),sep="")]  ; tt2
				# > tt1
				#  Former Current
				# 0.30737 0.17128
				# > tt2
				#  cigstat2.Former cigstat2.Current
				#        0.1278226        0.0934186

				ave.smk = sum(tt1*tt2); ave.smk
				#[1] 0.05528958

				#### average over pky ##

				# > ref.pky
				#   lst10   10_30   30_60  60_100   gt100
				# 0.66752 0.16092 0.12864 0.04292 0.00000

				## inner product ##

				tt1=ref.pky[-c(1:2)];  tt1
				tt2=mycoef[paste("pky.", names(ref.pky[-c(1:2)]),sep="")]  ; tt2
				# > tt1
				#   30_60  60_100   gt100
				# 0.12864 0.04292 0.00000
				# > tt2
				#  pky.30_60 pky.60_100  pky.gt100
				#  0.1793763  0.3821623  0.2605942

				ave.pky = sum(tt1*tt2); ave.pky
				#[1] 0.1195359


				#### sum it up ##

				ave.eff.before = as.numeric( base0 + ave.edu + ave.smk + ave.pky) ; ave.eff.before

				ave.eff.prob.before = inv.logit(ave.eff.before); ave.eff.prob.before  # 0.09537217


				#### Adjustment needed #########################

				#ref.fh/100
				#[1] 0.109   ---> a bit higher

				incr = -0.085   ### this is for Gender="M"

				ave.eff = as.numeric((base0 + incr) + ave.edu + ave.smk + ave.pky) ; ave.eff

				ave.eff.prob = inv.logit(ave.eff); ave.eff.prob  # 0.09537217
				#[1] 0.1091224

				#### update the fitted model ###
				# > mycoef
				#  (Intercept) edu2.college edu2.postcol      race2.H    pky.10_30    pky.30_60   pky.60_100
				#   -2.3047022   -0.1218313   -0.1531633   -0.4446783    0.1959373    0.2335248    0.4192692
				#    pky.gt100
				#    0.4597977

				mycoef.adj = mycoef
				# > mycoef.adj[1]
				# (Intercept)
				#   -2.304702
				mycoef.adj[1] = mycoef.adj[1]+incr
				# > mycoef.adj
				#  (Intercept) edu2.college edu2.postcol      race2.H    pky.10_30    pky.30_60   pky.60_100
				#   -2.1547022   -0.1218313   -0.1531633   -0.4446783    0.1959373    0.2335248    0.4192692
				#    pky.gt100
				#    0.4597977


				######### plotting barplot ##########

				tb1=c(ave.eff.prob.before, ref.fh/100); names(tt)=c("Non-adjusted","Ref")
				tb2=c(ave.eff.prob, ref.fh/100); names(tt)=c("Adjusted","Ref")

					TAB=tb1
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,0.15),main="Family History of Lung Cancer",cex.axis=1.5,cex.lab=2,cex.main=2)
					text(1:length(TAB),TAB+0.02,round(TAB,3),cex=2,col="blue")
					axis(1, at=c(0.75,2), labels=c("Unadjusted", " Ref"),cex.axis=1.5)


					TAB=tb2
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,0.15),main="Family History of Lung Cancer",cex.axis=1.5,cex.lab=2,cex.main=2)
					text(1:length(TAB),TAB+0.02,round(TAB,3),cex=2,col="blue")
					axis(1, at=c(0.75,2), labels=c("Adjusted", " Ref"),cex.axis=1.5)


		 }#f(Gender=="M"){


			  ANS = list(mycoef.adj=mycoef.adj, increment= incr, mycoef.before = mycoef, glm.fh = glm.fh, glm.or= or,  prev.fh.adj = ave.eff.prob, prev.fh.unadj = ave.eff.prob.before, ref.fh = ref.fh/100)
			  ANS



}#end of the main myFHL.given


########## 5/2/2017: incorporate female ######
########## 10/7/2016 update, predictive modeling approach, nonlinear etc ##########


myCOPD.cond2 <- function(ref.copd, ref.copd.ci, ref.smk, ref.cigstop, ref.fh, ref.pky.mean.55, ref.cpd.mean.55, ref.cigyear.mean.55, ref.bmi.mean.55, ref.edu, ref.race, Gender){

		######### Pr(COPD| smoking, gender, BMI, FH and age) #######################################
					#logistic regression using PLCO & prevalence data
					#http://www.cdc.gov/copd/data.htm
		#copd_f  Chronic Obstructive Pulmonary Disease (COPD)
				# Built from bronchit_f and emphys_f. If bronchit_f or emphys_f = 1 then copd_f = 1. If either is missing, then copd_f is missing. Else if both are no, then copd_f is no.
				# (format: ynf)
				# .F="No Form" .M="Missing" 0="No" 1="Yes"

if (1==0) {

		#####################[0] Define variables ################################################

		##### (1) define smoking status ###########
				# prevalence data: http://en.wikipedia.org/wiki/Prevalence_of_tobacco_consumption
				cigstat=mydat[,"cig_stat"]
				# > table(cigstat)
				# cig_stat

				#     0     1     2     A     F     M     #A is ambiguous -- will put in former then
				# 26917  8659 38256     1  2826    23

				# .A="Ambiguous"
				# .F="No Form"
				# .M="Not Answered"
				# 0="Never Smoked Cigarettes"
				# 1="Current Cigarette Smoker"
				# 2="Former Cigarette Smoker"

				tb.cig=table(cigstat)
				round(tb.cig/sum(tb.cig),2)
				# cigstat
				#    0    1    2
				# 0.37 0.12 0.51

				cigstat2=cigstat
				cigstat2[cigstat=="0"]="Never"
				cigstat2[cigstat=="1"]="Current"
				cigstat2[cigstat=="2"]="Former"
				cigstat2[cigstat=="A"]= NA
				cigstat2[cigstat=="F"]= NA
				cigstat2[cigstat=="M"]= NA
						# > table(cigstat2)
						# cigstat2
						# Current  Former   Never
						#    8659   38256   26917

				# for polytomous ##
				cigstat3=cigstat2
				cigstat3[cigstat==0]="0.Never"
				cigstat3[cigstat==1]="2.Current"
				cigstat3[cigstat==2]="1.Former"

					# > table(cigstat3)
					# cigstat3
					#   0.Never  1.Former 2.Current
					#     26917     38256      8659


		ix.na.smk = is.na(cigstat2)==T
		# > sum(ix.na.smk)
		# [1] 2850   ---> need to exclude them


		#### (2) education ########################
		#educat #Education
				# Question 3
				# .F="No Form" .M="Missing"
				# 1="Less than 8 years" 2="8-11 years"
				# 3="12 years or completed high school" 4="Post high school training other than college"
				# 5="Some college"
				# 6="College graduate" 7="Postgraduate"

				edu0=mydat[,"educat"]
				table(edu0)
				# edu0
				#     1     2     3     4     5     6     7     F     M
				#   923  5172 13484  9048 15067 13912 16037  2826   213

				# not finished highschool - highschool graduate -college graduate - postgraduate
				#   (1,2)                        (3,4,5)                 6                7

				edu=edu0
				#edu[edu0==1 | edu0==2]=1
				edu[edu0 <=5 ]=1
				edu[edu0==6]=2
				edu[edu0==7]=3
				edu[edu0=="M" | edu0=="F"]=NA

						tb.edu=table(edu)/sum(table(edu))
						tb.edu
						# edu
						#         1         2         3
						# 0.7016927 0.1504578 0.1478495
						# > table(edu)
						# edu
						#     1     2     3
						# 43694 13912 16037

	            ## factor variable ##
				edu2=edu
				edu2[edu==1]="<=high"
				edu2[edu==2]="college"
				edu2[edu==3]="postcol"
				tb.edu2=table(edu2)/sum(table(edu2))
				tb.edu2
				# edu2
				#    <=high   college   postcol
				# 0.7016927 0.1504578 0.1478495

						doThis=F
						if(doThis==T){
							edu=edu0
							edu[edu0==1 | edu0==2]=1
							edu[edu0==3 | edu0==4 | edu0==5]=2
							edu[edu0==6]=3
							edu[edu0==7]=4
							edu[edu0=="M"]=NA

							tb.edu=table(edu)
							# edu
							#     1     2     3     4
							#  5914 37002 13757 15862
							# > round(tb.edu/sum(tb.edu),3)
							# edu
							#     1     2     3     4
							# 0.082 0.510 0.190 0.219

							edu2=edu
							edu2[edu==1]="<high"
							edu2[edu==2]="high"
							edu2[edu==3]="college"
							edu2[edu==4]="postcol"

						}#



		####### (3) race #############
				# 1="White, Non-Hispanic" 2="Black, Non-Hispanic" 3="Hispanic"
				# 4="Asian"
				# 5="Pacific Islander" 6="American Indian" 7="Missing"

				# 1="White, Non-Hispanic"
				# 2="Black, Non-Hispanic"
				# 3="Hispanic"
				# 4="Asian"
				# 5="Pacific Islander"
				# 6="American Indian"
				# 7="Missing"
				race0=mydat[,"race7"]
					table(race0)
					# race0
					#     1     2     3     4     5     6     7
					# 64222  3273  1569  2957   452   185    38
					#
					#     1     2     3     4     5     6     7
					# 65178  3370  1603  3009   464   187  2871
					#
				## merge 4-7
				# "white" - "black" - "hispanic" - "asian"
				race=race0
				race[race0>4]=NA
						tb.race=table(race)
						tb.race
						# race
						#     1     2     3     4
						# 64222  3273  1569  3632
						round(tb.race/sum(tb.race),2)
						# race
						# race
						#    1    2    3    4
						# 0.89 0.05 0.02 0.04
				race2=race
				race2[race==1]="W"
				race2[race==2]="B"
				race2[race==3]="H"
				race2[race==4]="A"
					#table(race2)
					#     A     B     H     W
					#  3009  3370  1603 65178
	   #### (4) define "Edu-race" variable #############


				race.edu=paste(race2,edu2,sep="-") #[1] "W-<=high"   "NA-college" "W-<=high"   "W-college"  "W-college"
				race.edu[is.na(race2) | is.na(edu2)] = NA
				race.edu=as.factor(as.character(race.edu))

	  #####  (5) BMI ########

              # clean chars ---------------------
              temp <- mydat[,"bmi_curr"]
              temp[temp %in% c("F","M","R")] <- NA
              temp_ <- mydat[,"bmi_curc"]
              temp_[temp_ %in% c("F","M","R")] <- NA

              # bmi=as.numeric(mydat[,"bmi_curr"]) #[1] 38.07647 31.81634 22.69663 27.25385 28.03809 24.19162 30.57929 25.16239 22.28669 23.10435
              bmi=as.numeric(temp)
              # bmicat=as.numeric(mydat[,"bmi_curc"]) #[1] 38.07647 31.81634 22.69663 27.25385 28.03809 24.19162 30.57929 25.16239 22.28669 23.10435
              bmicat=as.numeric(temp_)
			### some NA's for F, M, R... missing values
# Q: should I do missing value imputation?
			#            2            1            1            1            1            1            1            1            1
			# 66.317197494            F            M            R
			#            1         2826         1071          147

	  ####  (6) define age variable

			age=as.numeric(mydat[,"age"])
					range(age)
					# [1] 49 78
			#library(Hmisc)
			age.cat = cut2(age, cuts=c(55, 60, 65, 70, 75))
			# > table(age.cat)
			# age.cat
			# [49,55) [55,60) [60,65) [65,70) [70,75) [75,78]
			#       9   24750   24023   17763   10133       4

				# > levels(age.cat)
				# [1] "[49,55)" "[55,60)" "[60,65)" "[65,70)" "[70,75)" "[75,78]"
			levels(age.cat)= c("lt55","55_60","60_65","65_70","70_75","85+")

			#age.cat = cut2(age,

	 ####### (7) define Smoking related variables ##
			#cig_per_day  of Cigarettes Smoked Per Day
					#The maximum number of cigarettes smoked per day, based on the range specified. The category 81+ is set to 100.

			# cig_years_rnd # of Years Smoked Cigarettes
					# Derived from questions 10-13. This differs from cig_years because it uses randomization age instead of BQ age.
					# Numeric .F="No Form" .M="Missing"
			#cig_stop_rnd # of Years Since Stopped Smoking Cigarettes
					# Derived from questions 12 and 13. This differs from cig_stop because it uses randomization age instead of BQ age.
					# Numeric
					# .F="No Form" .M="Missing" .N="Not Applicable"


			### pack-years ##
			pky0=mydat[,"pack_years"]
			#pky0=mydat[,"pack_years_rnd"]
			pky2=pky0
			pky2[pky0=="M" | pky0=="F"]=NA
			pky2=as.numeric(pky2)
			#[1]   0 260
			#   9.5    90    92    93    94  94.5    95    96    98    99     F     M
			#   138   268   150   104   100     1     5   231    72    87  2826  1123

			### make category (0-10), (10-30), (30-60), (60-100), 100+
			pky=pky2
			pky[pky2 <=10] = "lst10"
			pky[pky2 > 10 & pky2<=30] ="10_30"
			pky[pky2 > 30 & pky2 <=60] = "30_60"
			pky[pky2 > 60 & pky2 <=100] = "60_100"
			pky[pky2>100]="gt100"
			table(pky)
			# pky
			#  10_30  30_60 60_100  gt100  lst10
			#  14808  14932   7212   2261  33430

			#### cigday ##
			# F="No Form"
			# .M="Missing"
			# 0="0"
			# 1="1-10"
			# 2="11-20"
			# 3="21-30"
			# 4="31-40"
			# 5="41-60"
			# 6="61-80"
			# 7="81+"

			cigday0=mydat[,"cigpd_f"]
				table(cigday0)
				# cigday0
				#     0     1     2     3     4     5     6     7     F     M
				# 26917  7853 17302 10783  6409  3591   685   184  2826   132

			### put maximum value not category
			cigday00 = cigday0
			cigday00[cigday0=="1"] = 10
			cigday00[cigday0=="2"] = 20
			cigday00[cigday0=="3"] = 30
			cigday00[cigday0=="4"] = 40
			cigday00[cigday0=="5"] = 60
			cigday00[cigday0=="6"] = 80
			cigday00[cigday0=="7"] = 100
			cigday00[cigday0=="F" | cigday0=="M"] = NA

				table(cigday00)
				# cigday00
				#     0    10   100    20    30    40    60    80
				# 26917  7853   184 17302 10783  6409  3591   685

							# old PCA data (more accurate i guess,but new data don't have this 3/16/2016)
							#cigday0=mydat[,"cig_per_day"]
								# > table(mydat[,"cig_per_day"])
								#
								#    10   100    20    30    40    60    80     M     N
								#  7637   177 16972 10579  6290  3511   668     7 26855   <--- never smoker

			#### group: N, (0-20], (20-40], (40-60], (60,100]

			cigday=cigday00
			cigday[cigday00=="0"]	= "never"
			cigday[cigday00==10 | cigday00==20 ]	= "0_20"
			cigday[cigday00==30 | cigday00==40 ]	= "20_40"
			cigday[cigday00==50 | cigday00==60 ]	= "40_60"
			cigday[cigday00==70 | cigday00==80 | cigday00==90 | cigday00==100]	= "60_100"
			cigday[cigday00=="M"]	= NA

			table(cigday)
			# cigday
			#   0_20  20_40  40_60 60_100  never
			#  25155  17192   3591    869  26917

							# cigday
							#  20_40  40_60 60_100  lst20  never
							#  16869   3511    845  24609  26855


			## define cigday2 ###

			cigday2=cigday00
			cigday2[cigday00=="N"]=0
			cigday2[cigday00=="M"]=NA
			cigday2=as.numeric(cigday2)


			### define cigstop ###
			# Numeric
			# .F="No Form"
			# .M="Not Answered"
			# .N="Not Applicable"
			# 0.5="Six Months"

			cigstop0=mydat[,"cig_stop"]
			#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24
			#  8659   702   843  1206   984   989   982   971  1070   979   863   858   894   755  1235   899   889   910   871
			#    25    26    27    28    29     3    30    31    32    33    34    35    36    37    38    39     4    40    41
			#  1076  1050  1020  1024  1062   734  1191  1057   973   905   825   763   641   540   465   420   675   344   341
			#    42    43    44    45    46    47    48    49     5    50    51    52    53    54    55    56    57    58    59
			#   296   222   215   178   148   113   112    86   808    48    44    30    16    15     4     3     3     3     1
			#     6    60    62     7     8     9     F     M     N
			#   798     1     1   801   823   774  2826   731 26917
			# >
			#cigstop0=mydat[,"cig_stop_rnd"]
			#range(as.numeric(cigstop0),na.rm=T)
			# [1]  0 62
			# Warning cat:
			# NAs introduced by coercion

			# cigstop0
			#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24    25    26    27    28    29     3
			#  8581   697   825  1191   975   983   975   969  1059   962   858   845   915   750  1217   884   884   911   874  1062  1048  1026   992  1055   728
			#    30    31    32    33    34    35    36    37    38    39     4    40    41    42    43    44    45    46    47    48    49     5    50    51    52
			#  1187  1056   975   904   812   772   623   523   466   414   665   338   342   284   228   209   181   137   117   110    80   810    49    44    24
			#    53    54    55    56    57    58    59     6    62     7     8     9     N
			#    15    15     3     2     3     3     2   785     1   808   805   771 26867
					# > table(cigstop0,cigstat2)
					#         cigstat2
					# cigstop0 Current Former Never
					#      0      8581      0     0  --> current smoker has cigstop=0, yes makes sens
					#      0.5       0    697     0
					# ..
					#      8         0    805     0
					#      9         0    771     0
					#      N         0     12 26855    ---> never smoker nas cigstop="N"

            # F, M, N ------------------------
            temp <- cigstop0
            temp[temp %in% c("F","M","N")] <- NA

			### define: N, 0-20, 20-40, 40+ ##
			# tt=as.numeric(cigstop0)
            tt=as.numeric(temp)

			# > range(tt,na.rm=T)
			# [1]  0 62
			cigstop=cigstop0
			cigstop[cigstop0=="N"]="never"
			cigstop[tt==0] = "0"
			cigstop[tt>0 & tt <=20] = "0_20"
			cigstop[tt >20 & tt<=40] = "20_40"
			cigstop[tt >40 ] = "gt40"

			cigstop[cigstop=="F" | cigstop=="M" ] = NA

			table(cigstop)
			# cigstop
			#     0  0_20 20_40  gt40 never
			#  8659 18744 16925  1880 26917

					#              0           0_20          20_40 gt40.neversmok          never
					#           8581          18593          16806           1849          26867
					#boxplot(tt~cigstop)
			### numeric variables ##
			cigstop2=tt


			### define cigyears ###
			# Numeric
			# .F="No Form"
			# .M="Not Answered"
			# 0.5="Six Months"
			cigyears0=mydat[,"cig_years"]
			#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24
			# 26917    91   222  1107   753   971   748  1012  1012   816   970   954   931   454  1313   872  1093   947  1057
			#    25    26    27    28    29     3    30    31    32    33    34    35    36    37    38    39     4    40    41
			#  1030   851   909   938   931   421  1033   876  1014   946  1023  1061   984  1138  1130  1255   512  1340  1189
			#    42    43    44    45    46    47    48    49     5    50    51    52    53    54    55    56    57    58    59
			#  1101  1046   963   845   824   657   608   546   603   501   426   346   262   206   159    98    85    44    25
			#     6    60    61    62    63    64     7     8     9     F     M
			#   600    24    11     4     6     3   662   630   709  2826  1041

					#cigyears0=mydat[,"cig_years_rnd"]
					# > table(cigyears0)
					# cigyears0
					#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24    25    26    27    28    29     3
					# 26855    92   225  1106   752   965   748  1011  1009   815   964   950   930   453  1312   873  1088   946  1058  1028   851   908   935   930   419
					#    30    31    32    33    34    35    36    37    38    39     4    40    41    42    43    44    45    46    47    48    49     5    50    51    52
					#  1034   873  1012   940  1024  1067   977  1137  1124  1255   511  1340  1180  1114  1039   959   838   817   654   607   551   599   490   424   349
					#    53    54    55    56    57    58    59     6    60    61    62    63    64     7     8     9     M
					#   256   205   155    99    83    44    25   599    24    12     4     5     3   662   628   708    46
			#tt=as.numeric(mydat[,"cig_years"])
			# range(tt,na.rm=T)
			# [1]  0 64

			## group:  0-20, 20-40, 40-60
			cigyears=cigyears0
			cigyears[cigyears0=="M" | cigyears0=="F"]=NA
			cigyears[tt==0] = "0"
			cigyears[tt >0 & tt <=20] = "0_20"
			cigyears[tt >20 & tt<=40] = "20_40"
			cigyears[tt >40] = "gt40"

			table(cigyears)
			# cigyears
			#     0  0_20 20_40  gt40
			# 26917 15491 20428  9979


						# cigyears
						#     0  0_20 20_40  gt40
						# 26855 15458 20400  9937
						#boxplot(tt~cigyears)

			## cigyears.numeric ##

			cigyears2=cigyears0
			cigyears2[cigyears0=="M" |cigyears0=="F" ] = NA
			cigyears2=as.numeric(cigyears2)



	####### (8) family history of lung cancer ############################################

		# Lung cancer family history in first-degree relatives. Includes parents, full-siblings, and children.
		# .F="No Form"
		#.M="Missing"
		#0="No"1="Yes, Immediate Family Member
		#"9="Possibly - Relative Or Cancer Type Not Clear"

		fh0=mydat[,"lung_fh"]
		# fh0
		#     0     1     9     F     M
		# 63729  6964  2506  2826   657

		# fh0
		#     0     1     9     M
		# 62796  6851  2453   596

		fh=fh0
		fh[fh0=="9" | fh0=="M" | fh0=="F"]=NA
		fh=as.numeric(fh)
		tb.fh=table(fh)/sum(table(fh))
		tb.fh
		# fh
		#          0          1
		# 0.90163252 0.09836748
		#          0          1
		# 0.90148954 0.09851046

		# > sum(is.na(fh))/length(fh)
		# [1] 0.07810177


	####### (8) Personal history of lung cancer ############################################

		# trial_ph_any
		# Personal History of Any Cancer Prior to Trial Entry
		# Was the participant diagnosed with any cancer prior to trial entry (randomization)?
		# 0="No"1="Yes"9="Unknown - BQ History Unknown and No Cancer History From Another Source"


		# ph_first_cancer
		# First type of personal history cancer reported on BQ, ATF, or MDF
					# .M="Missing"
					# .N="N/A - No Cancer or Fewer Than This Many Cancers"
					# 1="Abdomen"
					# 2="Adrenal Glands"
					# 3="Bladder"
					# 4="Bone"
					# 5="Brain"
					# 6="Breast"
					# 7="Cervical"

		# ph_first_cancer_age
		# Age of first type of personal history cancer reported on BQ, ATF, or MDF
		# Age of first personal history cancer reported by participant.
		# Numeric.M="Missing".N="No Cancer"


		ph0=mydat[,"trial_ph_any"]
		# > table(ph0)
		# ph0
		#     0     1     9
		# 72152  1693  2837

		ph=ph0
		ph[ph0=="9"]=NA
		ph=as.numeric(ph)
		tb.ph=table(ph)/sum(table(ph))
		tb.ph

		# ph
		#         0         1
		# 0.9770736 0.0229264





   ####### (9) COPD ######################################################################

		#copd_f  Chronic Obstructive Pulmonary Disease (COPD)
				# Built from bronchit_f and emphys_f. If bronchit_f or emphys_f = 1 then copd_f = 1. If either is missing, then copd_f is missing. Else if both are no, then copd_f is no.
				# (format: ynf)
				# .F="No Form" .M="Missing" 0="No" 1="Yes"

		copd0=mydat[,"copd_f"]
		# copd0
		#     0     1     M
		# 67994  4231   471

		copd=copd0
		copd[copd0=="M"]=NA
        copd[copd %in% c("F","M")] <- NA
		copd=as.numeric(copd)
		# > tb=table(copd)
		# > tb/sum(tb)
		# copd
		#          0          1
		# 0.94141918 0.05858082


	####### (10) Barplot for COPD ########################################################

		tb.copd=table(copd)/sum(table(copd))
					TAB=tb.copd
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,1.3),main="(PLCO) COPD",cex.axis=1.5,cex.lab=2)
					text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")


	################## [2] Model fitting: logistic regression ####################################

	############# [1] Variable preparation (reference leve change etc) ################################
	#covnames=c("cigstat2","edu2","race2")#,cigday)
	#covnames=c("edu2","race2","cigyears2", "cigstop2", "pky2", "cigday2")

	race3=relevel(as.factor(race2),ref="W")
	cigstopf=as.factor(cigstop)
	cigstopf2=relevel(cigstopf, ref="never")
	cigstat2 = relevel(as.factor(cigstat2), ref="Never")

	mydatall=MYDAT0=data.frame(copd=copd, ph=ph, fh=fh, bmi=bmi, edu=edu2,race=race3,cigstat=cigstat2,cigyears=cigyears2, cigstop=cigstopf2, pky=pky2, cigday=cigday2,age=age, age.cat=age.cat)
			MYDAT0[1:3,]
		#   copd ph fh      bmi     edu race cigstat cigyears cigstop pky cigday age age.cat
		# 1    0  0 NA 25.78094  <=high    B   Never        0   never   0      0  67   65_70
		# 2    1  0  0 25.71645 postcol    W  Former        8   20_40  24     60  62   60_65
		# 3    0  0  0 34.66130  <=high    W  Former       35    0_20  35     20  62   60_65




   sum(is.na(mydatall))
   #[1] 33775
   colSums(is.na(mydatall))
		# >    colSums(is.na(mydatall))
		#       ph       fh      bmi      edu     race  cigstat cigyears  cigstop      pky   cigday      age  age.cat
		#       23     5989     4044     3039     3522     2850     3867     3557     3949     2958        0        0

		# > round(colSums(is.na(mydatall))/nrow(mydatall),2)
		#       ph       fh      bmi      edu     race  cigstat cigyears  cigstop      pky   cigday      age  age.cat
		#     0.00     0.08     0.05     0.04     0.05     0.04     0.05     0.05     0.05     0.04     0.00     0.00

		# >    colSums(is.na(mydatall))
		#     copd       ph       fh      bmi      edu     race  cigstat cigyears  cigstop      pky   cigday      age  age.cat
		#     3350     2837     5989     4044     3039     3522     2850     3867     3557     3949     2958        0        0

		# > round(colSums(is.na(mydatall))/nrow(mydatall),2)
		#     copd       ph       fh      bmi      edu     race  cigstat cigyears  cigstop      pky   cigday      age  age.cat
		#     0.04     0.04     0.08     0.05     0.04     0.05     0.04     0.05     0.05     0.05     0.04     0.00     0.00

	######### [1]' Imputation ###################################################################

	doImp = F

	if(doImp==T){
			Sys.time()
			#[1] "2016-04-19 08:35:21 PDT"

			#library(mice)
			#http://www.ats.ucla.edu/stat/r/faq/R_pmm_mi.htm
			imp = mice(mydatall)
			#  iter imp variable
			#   1   1  race  node2.IPL  extent2.IPL  radiation2.IPL  stage123_4.IPL
			#   1   2  race  node2.IPL  extent2.IPL  radiation2.IPL  stage123_4.IPL
			#   1   3  race  node2.IPL  extent2.IPL  radiation2.IPL  stage123_4.IPL
			#   1   4  race  node2.IPL  extent2.IPL  radiation2.IPL  stage123_4.IPL
			#   1   5  race  node2.IPL  extent2.IPL  radiation2.IPL  stage123_4.IPL
			#   2   1  race  node2.IPL  extent2.IPL  radiation2.IPL  stage123_4.IPL
			names(imp)
			#  [1] "call"            "data"            "m"               "nmis"            "imp"             "method"          "predictorMatrix" "visitSequence"
			#  [9] "form"            "post"            "seed"            "iteration"       "lastSeedValue"   "chainMean"       "chainVar"        "loggedEvents"
			# [17] "pad"

			mydatall.imp = complete(imp)#, 'long', inc=TRUE)
			dim(mydatall.imp)
			colSums(is.na(mydatall.imp))
			#      fh      bmi      edu     race  cigstat cigyears  cigstop      pky   cigday      age  age.cat
			#        0        0        0        0        0        0        0        0        0        0        0
			# >

			Sys.time()
			#[1] "2016-04-19 09:18:13 PDT"


			#setwd(outdir)
			#impfile=paste(Head,"_imputation.file.csv",sep="")
			##write.csv(mydatall.imp, impfile)

				# > dim(mydatall.imp)
				# [1] 76682    11
	}#end of

    ####### import #####


    ################ I coudln't skip this because stepwise method would not allow missing data ###

    if(Gender=="M"){

			#impfile # = paste(Head,"_imputation.file.csv",sep="")


			#setwd(outdir)
			#mydatall.imp = read.csv(impfile)[,-1]
			# > mydatall.imp[1:3,]
			#   fh      bmi     edu race cigstat cigyears cigstop pky cigday age age.cat
			# 1  0 25.78094  <=high    B   Never        0   never   0      0  67   65_70
			# 2  0 25.71645 postcol    W  Former        8   20_40  24     60  62   60_65
			# 3  0 34.66130  <=high    W  Former       35    0_20  35     20  62   60_65
			# > mydatall.imp[1:10,]
			#    ph fh      bmi     edu race cigstat cigyears cigstop  pky cigday age age.cat
			# 1   0  0 25.78094  <=high    B   Never        0   never  0.0      0  67   65_70
			# 2   0  0 25.71645 postcol    W  Former        8   20_40 24.0     60  62   60_65
			# 3   0  0 34.66130  <=high    W  Former       35    0_20 35.0     20  62   60_65
			# 4   0  0 23.54244  <=high    W  Former       11   20_40 33.0     60  57   55_60
			# 5   0  1 32.06407 postcol    W   Never        0   never  0.0      0  56   55_60
			# 6   0  0 31.07642  <=high    W Current       41       0 61.5     30  56   55_60
			# 7   0  0 32.12702 postcol    B  Former       18   20_40 18.0     20  59   55_60
			# 8   0  0 26.60024  <=high    H  Former       23   20_40 23.0     20  60   60_65
			# 9   0  0 24.44346 college    W   Never        0   never  0.0      0  67   65_70
			# 10  0  0 22.28891  <=high    W   Never        0   never  0.0      0  71   70_75

			# > 			mydatall[1:10,]
			#    copd ph fh      bmi     edu race cigstat cigyears cigstop  pky cigday age age.cat
			# 1     0  0 NA 25.78094  <=high    B   Never        0   never  0.0      0  67   65_70
			# 2     1  0  0 25.71645 postcol    W  Former        8   20_40 24.0     60  62   60_65
			# 3     0  0  0 34.66130  <=high    W  Former       35    0_20 35.0     20  62   60_65
			# 4     0  0  0 23.54244  <=high    W  Former       11   20_40 33.0     60  57   55_60
			# 5     0  0  1 32.06407 postcol    W   Never        0   never  0.0      0  56   55_60
			# 6     1  0  0 31.07642  <=high    W Current       41       0 61.5     30  56   55_60
			# 7     0  0  0 32.12702 postcol    B  Former       18   20_40 18.0     20  59   55_60
			# 8     0  0  0 26.60024  <=high    H  Former       23   20_40 23.0     20  60   60_65
			# 9     0  0  0 24.44346 college    W   Never        0   never  0.0      0  67   65_70
			# 10    0  0  0 22.28891  <=high    W   Never        0   never  0.0      0  71   70_75


			#mydatall[1:10,]


			#mydatall.imp = data.frame(copd, mydatall.imp)
			#setwd(outdir)
			##write.csv(mydatall.imp, impfile)

	}

	if(Gender=="F"){

		### doing this for later traning vs. validation set
		#ix.cxr = mydat[,"arm"]==1

		ix.cxr = (mydat[,"arm"]==1)*1
		# > length(ix.cxr)
		# [1] 78215
		# > nrow(mydatall)
		# [1] 78215

		mydatall2=data.frame(ix.cxr=ix.cxr, mydatall)
		# > mydatall2[1:4,]
		#   ix.cxr fh      bmi     edu race cigstat cigyears cigstop pky cigday age age.cat
		# 1      0  0 22.36111  <=high    W   Never        0   never   0      0  74   70_75
		# 2      0  0 27.52136 college    W  Former       20   20_40  10     10  63   60_65
		# 3      0  0 26.68144 postcol    W   Never        0   never   0      0  59   55_60
		# 4      1  0 31.24166  <=high    A   Never        0   never   0      0  57   55_60

		mydatall.imp = na.omit(mydatall2 )
		# > dim(mydatall.imp)
		# [1] 71826    12
		# >
		###### identify rows that were removed by

		#setwd(outdir)
		#write.csv(mydatall.imp, "NAomit.data.female_0427_2017.csv")


		###### reading back due to NA problems ###

		#setwd(outdir)
#		mydatall.imp = read.csv(nafile) # "NAomit.data.female_0427_2017.csv")

	}


	mydatall.imp[,"race"] = relevel(as.factor(mydatall.imp[,"race"]),ref="W")
	mydatall.imp[,"cigstop"] = relevel(as.factor(mydatall.imp[,"cigstop"]),ref="never")
	mydatall.imp[,"cigstat"] = relevel(as.factor(mydatall.imp[,"cigstat"]),ref="Never")




	########[2] Splitting into training vs. validation data #####################################
				# > dim(mydat)
				# [1] 76682   432
				# > dim(MYDAT0)
				# [1] 76682     9



    mydat.tr = mydat.val=NULL


    if(Gender=="M") useImp = T
    if(Gender=="F") useImp = T

    if(useImp==T){
 				ix.cxr=NULL
		 		if(nrow(mydat)==nrow(mydatall.imp)){

 					ix.cxr = mydat[,"arm"]==1  # chest xray ram
					table(mydat[,"arm"])
					#
					#     1     2
					# 38340 38342
					# > sum(ix.cxr)
					# [1] 38340
					#length(ix.cxr)==length(ix.na.smk)
					# [1] TRUE
				 }#end of

		 		if(nrow(mydat)!=nrow(mydatall.imp)){	 ## for female data

 					ix.cxr = mydatall.imp[,"ix.cxr"]  # chest xray ram
					#table(mydat[,"arm"])
					# > mydatall.imp[1:5,]
					#   X ix.cxr fh      bmi     edu race cigstat cigyears cigstop pky cigday age age.cat
					# 1 1      0  0 22.36111  <=high    W   Never        0   never   0      0  74   70_75
					# 2 2      0  0 27.52136 college    W  Former       20   20_40  10     10  63   60_65
					# 3 3      0  0 26.68144 postcol    W   Never        0   never   0      0  59   55_60
					# 4 4      1  0 31.24166  <=high    A   Never        0   never   0      0  57   55_60
					# 5 6      1  0 31.41970  <=high    W   Never        0   never   0      0  63   60_65

					#
					#     1     2
					# 38340 38342
					# > sum(ix.cxr)
					# [1] 38340
					#length(ix.cxr)==length(ix.na.smk)
					# [1] TRUE
				 }#end of





	   			### training data ##########
	   			mydat.tr = mydatall.imp[ix.cxr==T,]
	   			#mydat.tr = mydatall[ix.na.smk==F & ix.cxr==T,]
					dim(mydat.tr)
					#[1] 38340     9
					# [1] 37436   434

				### validation data #########

				mydat.val = mydatall.imp[ix.cxr==F,]
					dim(mydat.val)
					#[1] 38340     9
					# [1] 36396   434

		}#en of

    if(useImp==F){
 				ix.cxr=NULL
		 		if(nrow(mydat)==nrow(mydatall)){
 					ix.cxr = mydat[,"arm"]==1  # chest xray ram
					table(mydat[,"arm"])
					#
					#     1     2
					# 38340 38342
					# > sum(ix.cxr)
					# [1] 38340
					#length(ix.cxr)==length(ix.na.smk)
					# [1] TRUE
				 }#end of

	   			### training data ##########
	   			mydat.tr = mydatall[ix.cxr==T,]
	   			#mydat.tr = mydatall[ix.na.smk==F & ix.cxr==T,]
					dim(mydat.tr)
					#[1] 38340     9
					# [1] 37436   434

				### validation data #########

				mydat.val = mydatall[ix.cxr==F,]
					dim(mydat.val)
					#[1] 38340     9
					# [1] 36396   434

		}#en of


		############# [3] Full model fitting ##############################################################
		### nonlinear, interaction etc
		#MYDATA = na.omit(mydat.tr)

		MYDATA = mydat.tr

        #MYDATA = mydatall.imp
			dim(mydat.tr)
			#[1] 38340     9
			dim(MYDATA)
			#[1] 34580    11

		# > MYDATA[1:5,]
		#   ph fh      bmi     edu race cigstat cigyears cigstop  pky cigday age age.cat
		# 1  0 NA 25.78094  <=high    B   Never        0   never  0.0      0  67   65_70
		# 2  0  0 25.71645 postcol    W  Former        8   20_40 24.0     60  62   60_65
		# 4  0  0 23.54244  <=high    W  Former       11   20_40 33.0     60  57   55_60
		# 5  0  1 32.06407 postcol    W   Never        0   never  0.0      0  56   55_60
		# 6  0  0 31.07642  <=high    W Current       41       0 61.5     30  56   55_60

		#library(rms)
		#library(splines)

		fm1 = copd ~ ph + fh + ns(age,2) + edu + race + ns(bmi,3) + cigstat +ns(cigyears,2) +  ns(pky,2) + cigday +cigstat*race
		#fm2 = ph ~ fh + ns(age,3) + edu + race + ns(bmi,2) + cigstat +ns(cigyears,2) +  ns(pky,2) + cigday

		#fm2 = fh ~ age+ edu + race + bmi + cigstat + rcs(cigyears,3) + cigstop + ns(pky,2)
		#fm3= fh ~ age+ edu + race + bmi + cigstat + cigstop + ns(pky,2)
		#fm4= fh ~ ns(age,2)+ edu + race + bmi + cigstat + cigstop + ns(pky,2)

		#lmfull = glm(fh ~ age+ edu + race + bmi + cigstat + rcs(cigyears,3) + cigstop + ns(pky,2) + ns(cigday,2), data=MYDATA, family=binomial)
		#lmfull = glm(fh ~ age+ edu + race + bmi + cigstat + rcs(cigyears,3) + cigstop + ns(pky,2) , data=MYDATA, family=binomial)
		#lmfull = glm(fh ~ age+ edu + race + bmi + cigstat + cigstop + ns(pky,2) , data=MYDATA, family=binomial)

		lmfull = glm(fm1, data=MYDATA,family=binomial)
		summary(lmfull)

		fm.full = formula(lmfull)


		############# univaraite search ###########

		doThis=F

		if(doThis==T){


			fm1 = copd ~ ph + fh + age + edu + race + ns(bmi,3) + cigstat + cigyears +  pky + cigday +cigstat*race

			## age ##
			summary(glm(copd~age, data=MYDATA, family=binomial))
			#summary(glm(copd~ns(age,2), data=MYDATA, family=binomial))

			summary(glm(copd~ns(age,3), data=MYDATA, family=binomial))

			### fh ##
			summary(glm(ph~fh, data=MYDATA, family=binomial))
			# Coefficients:
			#             Estimate Std. Error z value Pr(>|z|)
			# (Intercept) -3.83071    0.03865 -99.120   <2e-16 ***
			# fh           0.15711    0.11408   1.377    0.168
			# ---
			# Signif. codes:  0 *** 0.001 ** 0.01 * 0.05 . 0.1   1

			### bmi ##
			summary(glm(copd~bmi, data=MYDATA, family=binomial))
			summary(glm(copd~ns(bmi,2), data=MYDATA, family=binomial))
			summary(glm(copd~ns(bmi,3), data=MYDATA, family=binomial))
			#summary(glm(copd~ns(bmi,4), data=MYDATA, family=binomial))


			## race: yes
			summary(glm(copd~race, data=MYDATA, family=binomial))

			## edu: no
			summary(glm(copd~edu, data=MYDATA, family=binomial))

			## cigstat: yes
			summary(glm(copd~cigstat, data=MYDATA, family=binomial))

			##cigyears: yes
			summary(glm(copd~cigyears, data=MYDATA, family=binomial))
			#summary(glm(copd~ns(cigyears,2), data=MYDATA, family=binomial))
			#summary(glm(copd~ns(cigyears,3), data=MYDATA, family=binomial))


			## pkyr: no ns()
			summary(glm(copd~pky, data=MYDATA, family=binomial))
			#summary(glm(copd~ns(pky,2), data=MYDATA, family=binomial))
			#summary(glm(copd~ns(pky,3), data=MYDATA, family=binomial))


			##cigstop
			summary(glm(copd~cigstop, data=MYDATA, family=binomial))

			## no ns()
			summary(glm(copd~cigday, data=MYDATA, family=binomial))
			#summary(glm(copd~ns(cigday,3), data=MYDATA, family=binomial))

			### some interactions ##

			## yes interaction
			summary(glm(copd~cigstat*race, data=MYDATA, family=binomial))

			summary(glm(copd~ns(age,2)*race, data=MYDATA, family=binomial))

			summary(glm(copd~ns(bmi,2)*race, data=MYDATA, family=binomial))


			## no
			summary(glm(copd~cigstat*edu, data=MYDATA, family=binomial))

			## no
			summary(glm(copd~pky*race, data=MYDATA, family=binomial))


			### these are old ###


			lrm(ph~ cigstat, data=MYDATA,x=TRUE,y=TRUE)

			summary(glm(fh~age.cat, data=MYDATA, family=binomial))

			ttt=summary(glm(fh~age.cat, data=MYDATA, family=binomial))

				xx=ttt$coef
				lm2=myOR.CI4(xx,bName="Estimate",sName="Std. Error",pName="Pr(>|z|)",zName="z value",pval=T)
				row.names(lm2)=row.names(xx)
				lm2[,-7]

		     summary(glm(fh~ns(bmi,2), data=MYDATA, family=binomial))
			 summary(glm(fh~poly(bmi,2), data=MYDATA, family=binomial))

			 summary(glm(fh~bmi, data=MYDATA, family=binomial))

			 lrm(fh~age, data=MYDATA,x=TRUE,y=TRUE)
			 #lrm(fh~age.cat, data=MYDATA,x=TRUE,y=TRUE)

			 lrm(fh~bmi, data=MYDATA,x=TRUE,y=TRUE)

			 lrm(fh~ rcs(cigyears,3), data=MYDATA,x=TRUE,y=TRUE)
			tt=lrm(fh~ cigyears, data=MYDATA,x=TRUE,y=TRUE)
			tt1=with(MYDATA,lowess(cigyears, fh))

			lrm(fh~ cigstop, data=MYDATA,x=TRUE,y=TRUE)

			lrm(fh~ pky, data=MYDATA,x=TRUE,y=TRUE)
			lrm(fh~ ns(pky,2), data=MYDATA,x=TRUE,y=TRUE)

			lrm(fh~ cigday, data=MYDATA,x=TRUE,y=TRUE)
			lrm(fh~ ns(cigday,2), data=MYDATA,x=TRUE,y=TRUE)

			smdat= MYDATA[,c("fh","age")]

			ff=glm(fh~ns(age,2), data=smdat,family=binomial)
			newdata=45:90
			pr = predict(ff, newdata=data.frame(age=45:90))
			plot(newdata, 100*(exp(pr)/1+exp(pr)), pch=16, col="blue", xlab="Age", ylab="Prevalence (%) of Family History of LC", main="FH ~ ns(age,2)")


			# fh ~ age + edu + race + rcs(cigyears, 3) + cigstop + ns(cigday,
			#     2)

			#library(randomForest)
			#rffit <- randomForest(fh ~ age+ edu + race + bmi + cigstat + cigyears + cigstop + pky + cigday, data=MYDATA, importance=TRUE,
			#						proximity=TRUE)

		}#

		###### to make figures: ph vs. age plot ###########

		smdat= MYDATA[,c("copd","age")]
		#ff=glm(ph~ns(age,3), family=binomial)

		ff=glm(copd~ns(age,1), data=smdat,family=binomial)
		newdata=50:90
		pr = predict(ff, newdata=data.frame(age=50:90))
		pr2 = exp(pr)/(1+exp(pr))
		plot(newdata, 100*pr2, pch=16, col="blue", xlab="Age", ylab="Prevalence (%) of COPD of LC", main="COPD ~ ns(age,1)")


		ff=glm(copd~ns(age,3), data=smdat,family=binomial)
		newdata=50:90
		pr = predict(ff, newdata=data.frame(age=50:90))
		pr2 = exp(pr)/(1+exp(pr))
		plot(newdata, 100*pr2, pch=16, col="blue", xlab="Age", ylab="Prevalence (%) of COPD of LC", main="COPD ~ ns(age,2)")



		ff=glm(copd~ns(age,4), data=smdat,family=binomial)
		newdata=50:90
		pr = predict(ff, newdata=data.frame(age=50:90))
		pr2 = exp(pr)/(1+exp(pr))
		plot(newdata, 100*pr2, pch=16, col="blue", xlab="Age", ylab="Prevalence (%) of COPD of LC", main="COPD ~ ns(age,2)")


		smdat= MYDATA[,c("copd","bmi")]
		ff=glm(copd~ns(bmi,1), data=smdat,family=binomial)
		newdata=10:50
		pr = predict(ff, newdata=data.frame(bmi=10:50))
		pr2 = exp(pr)/(1+exp(pr))
		plot(newdata, 100*pr2, pch=16, col="blue", xlab="Age", ylab="Prevalence (%) of COPD of LC", main="COPD ~ ns(bmi,1)")

		ff=glm(copd~ns(bmi,2), data=MYDATA,family=binomial)
		newdata=15:40
		pr = predict(ff, newdata=data.frame(bmi=15:40))
		pr2 = exp(pr)/(1+exp(pr))
		plot(newdata, 100*pr2, pch=16, col="blue", xlab="BMI", ylab="Prevalence (%) of COPD of LC", main="COPD ~ ns(BMI,2)")

		ff=glm(copd~ns(pky,2), data=MYDATA,family=binomial)
		newdata=0:200
		pr = predict(ff, newdata=data.frame(pky=0:200))
		pr2 = exp(pr)/(1+exp(pr))
		plot(newdata, 100*pr2, pch=16, col="blue", xlab="Pack-years", ylab="Prevalence (%) of COPD of LC", main="COPD ~ ns(pack-years,2)")


	   ########### [4] Stepwise selection ################################################################

   		doStep=F

   		if(doStep==T){

			### need to delete missing data before stepwise ##
			fm1 = copd ~ ph + fh + age + edu + race + ns(bmi,3) + cigstat + cigyears +  pky + cigday +cigstat*race

			#fm1 = copd ~ ph + fh + ns(age,2) + edu + race + ns(bmi,3) + cigstat +ns(cigyears,2) +  ns(pky,2) + cigday +cigstat*race
			#fm2 = ph ~ fh + ns(age,3) + edu + race + ns(bmi,2) + cigstat +ns(cigyears,2) +  ns(pky,2) + cigday

			#fm2 = fh ~ age+ edu + race + bmi + cigstat + rcs(cigyears,3) + cigstop + ns(pky,2)
			#fm3= fh ~ age+ edu + race + bmi + cigstat + cigstop + ns(pky,2)
			#fm4= fh ~ ns(age,2)+ edu + race + bmi + cigstat + cigstop + ns(pky,2)

			#lmfull = glm(fh ~ age+ edu + race + bmi + cigstat + rcs(cigyears,3) + cigstop + ns(pky,2) + ns(cigday,2), data=MYDATA, family=binomial)
			#lmfull = glm(fh ~ age+ edu + race + bmi + cigstat + rcs(cigyears,3) + cigstop + ns(pky,2) , data=MYDATA, family=binomial)
			#lmfull = glm(fh ~ age+ edu + race + bmi + cigstat + cigstop + ns(pky,2) , data=MYDATA, family=binomial)

			lmfull = glm(fm1, data=MYDATA,family=binomial)
			summary(lmfull)
		#     copd       ph       fh      bmi      edu     race  cigstat cigyears  cigstop      pky   cigday      age  age.cat
		#      195        0     1004      461       61      300        4      299      242      329       43        0        0


			colSums(is.na(MYDATA))
			#       ph       fh      bmi      edu     race  cigstat cigyears  cigstop      pky   cigday      age  age.cat
			#        0     2524     1354      952     1236      901     1383     1230     1417      944        0        0


			if(Gender=="M"){
				## exlude family history: too many missing #
				MYDATA2 = MYDATA[,-3]
				MYDATA3 = na.omit(MYDATA2)
				colnames(MYDATA3)
				#  [1] "ph"       "fh"       "bmi"      "edu"      "race"     "cigstat"  "cigyears" "cigstop"  "pky"      "cigday"
				# [11] "age"      "age.cat"

			}#end of


			if(Gender=="F")  MYDATA3=MYDATA

			# > fm.full
			# copd ~ ph + fh + ns(age, 2) + edu + race + ns(bmi, 3) + cigstat +
			#     ns(cigyears, 2) + ns(pky, 2) + cigday + cigstat * race




			st=step(lmfull)
			st

			#               Estimate Std. Error z value Pr(>|z|)
			# (Intercept) -3.4945462  0.5154633  -6.779 1.21e-11 ***
			# ns(age, 3)1  0.7739137  0.2369971   3.265 0.001093 **
			# ns(age, 3)2  0.4754907  1.0361745   0.459 0.646313
			# ns(age, 3)3  0.7195612  0.2462865   2.922 0.003482 **
			# raceA       -1.1327669  0.2933987  -3.861 0.000113 ***
			# raceB       -0.5154352  0.2181605  -2.363 0.018145 *
			# raceH       -0.1665861  0.2727506  -0.611 0.541356
			# ns(bmi, 2)1 -1.1109209  0.4309010  -2.578 0.009934 **
			# ns(bmi, 2)2  1.5416965  0.9412790   1.638 0.101448
			# pky          0.0054344  0.0009874   5.504 3.72e-08 ***
			# ---
			# Signif. codes:  0 *** 0.001 ** 0.01 * 0.05 . 0.1   1
			#
			# (Dispersion parameter for binomial family taken to be 1)
			#
			#     Null deviance: 7571.1  on 36102  degrees of freedom
			# Residual deviance: 7440.3  on 36093  degrees of freedom


			fm=formula(st)
			fm
			# > fm
			# ph ~ ns(age, 3) + race + ns(bmi, 2) + pky

			### get AUC and others ###

			lmfh=lrm(fm, data=MYDATA,x=T,y=T)
			lmfh

			# Logistic Regression Model
			#
			# lrm(formula = fm, data = MYDATA3, x = T, y = T)
			#                       Model Likelihood     Discrimination    Rank Discrim.
			#                          Ratio Test            Indexes          Indexes
			# Obs         36103    LR chi2     130.76    R2       0.019    C       0.609
			#  0          35317    d.f.             9    g        0.474    Dxy     0.217
			#  1            786    Pr(> chi2) <0.0001    gr       1.607    gamma   0.233
			# max |deriv| 3e-09                          gp       0.010    tau-a   0.009
			#                                            Brier    0.021
			#
			#           Coef    S.E.   Wald Z Pr(>|Z|)
			# Intercept -3.4945 0.5155 -6.78  <0.0001
			# 1          0.7739 0.2370  3.27  0.0011
			# 2          0.4755 1.0362  0.46  0.6463
			# 3          0.7196 0.2463  2.92  0.0035
			# race=A    -1.1328 0.2934 -3.86  0.0001
			# race=B    -0.5154 0.2182 -2.36  0.0181
			# race=H    -0.1666 0.2728 -0.61  0.5414
			# 1         -1.1109 0.4309 -2.58  0.0099
			# 2          1.5417 0.9413  1.64  0.1014
			# pky        0.0054 0.0010  5.50  <0.0001

         }#end of


	   ########## [5] Final model assessment ###########################################################
## now use MYDATA instead of MYDATA3

	   #myfit.tm = lrm(ph ~ ns(age, 3) + race +  pky, data=MYDATA3, x=T, y=T)
		# > fm
		# copd ~ fh + ns(age, 2) + edu + race + ns(bmi, 3) + cigstat +
		#     ns(cigyears, 2) + ns(pky, 2) + cigday + race:cigstat

	   ## both are needed
} # end 1==0


	   if(Gender=="M"){
           # FROM RDS --------------------
           myfit.glm <- myfit.glm.M.COPD

           if (1==0) {
		   #myfit = lrm(copd ~ fh + ns(age, 4) + edu + race + ns(bmi, 3) + cigstat +  ns(pky,2) + cigday, data=MYDATA, x=T, y=T)
		   # myfit
		   myfit.glm = glm(copd ~ fh + ns(age, 4) + edu + race + ns(bmi, 3) + cigstat +  ns(pky,2) + cigday, data=MYDATA, family=binomial)
		   #summary(myfit.glm)
            }
	   }#

	   if(Gender=="F"){
           # FROM RDS --------------------
           myfit.glm <- myfit.glm.F.COPD

           if (1==0) {
		   #myfit = lrm(copd ~ age + edu + race + ns(bmi, 3) + cigyears + pky + cigday, data=MYDATA, x=T, y=T)
		   #myfit
		   myfit.glm = glm(copd ~ age + edu + race + ns(bmi, 3) + cigyears + pky + cigday, data=MYDATA, family=binomial)
		   #summary(myfit.glm)
       }
	   }#


	   #myfit = lrm(ph ~ ns(age, 2) + race + ns(bmi, 2) + pky, data=MYDATA, x=T, y=T)
	   #myfit.glm = glm(ph ~ ns(age, 2) + race + ns(bmi, 2) + pky, data=MYDATA, family=binomial)


	 #myfit2 = lrm(copd ~ fh + ns(age, 2) + edu + race + ns(bmi, 3) + cigstat + ns(pky,2) + cigday, data=MYDATA, x=T, y=T)
	 #myfit.glm2 = glm(copd ~ fh + ns(age, 2) + edu + race + ns(bmi, 3) + cigstat +  ns(pky,2) + cigday, data=MYDATA, family=binomial)


		#               Estimate Std. Error z value Pr(>|z|)
		# (Intercept) -3.4945462  0.5154633  -6.779 1.21e-11 ***
		# ns(age, 3)1  0.7739137  0.2369971   3.265 0.001093 **
		# ns(age, 3)2  0.4754907  1.0361745   0.459 0.646313
		# ns(age, 3)3  0.7195612  0.2462865   2.922 0.003482 **
		# raceA       -1.1327669  0.2933987  -3.861 0.000113 ***
		# raceB       -0.5154352  0.2181605  -2.363 0.018145 *
		# raceH       -0.1665861  0.2727506  -0.611 0.541356
		# ns(bmi, 2)1 -1.1109209  0.4309010  -2.578 0.009934 **
		# ns(bmi, 2)2  1.5416965  0.9412790   1.638 0.101448
		# pky          0.0054344  0.0009874   5.504 3.72e-08 ***
		# ---
		# Signif. codes:  0 *** 0.001 ** 0.01 * 0.05 . 0.1   1
		#
		# (Dispersion parameter for binomial family taken to be 1)
		#
		#     Null deviance: 7571.1  on 36102  degrees of freedom
		# Residual deviance: 7440.3  on 36093  degrees of freedom
		# AIC: 7460.3

#### these are for output only later
#  ns.mat.age = with(MYDATA, ns(age,2))
#  ns.mat.bmi = with(MYDATA, ns(bmi,3))
#   ns.mat.bmi = with(MYDATA, ns(bmi,3))
		# > ns.mat.age[1:3,]
		#              1           2
		# [1,] 0.5561763  0.05267204
		# [2,] 0.5662628 -0.21084190
		# [3,] 0.4238313 -0.24371337
		# > ns.mat.pky[1:3,]
		#              1           2
		# [1,] 0.0000000  0.00000000
		# [2,] 0.1997805 -0.09623106
		# [3,] 0.2623123 -0.11994754
		#

		# Logistic Regression Model
		# Logistic Regression Model
		#
		# lrm(formula = ph ~ ns(age, 3) + race + ns(bmi, 2) + pky, data = MYDATA3,
		#     x = T, y = T)
		#                       Model Likelihood     Discrimination    Rank Discrim.
		#                          Ratio Test            Indexes          Indexes
		# Obs         36103    LR chi2     130.76    R2       0.019    C       0.609
		#  0          35317    d.f.             9    g        0.474    Dxy     0.217
		#  1            786    Pr(> chi2) <0.0001    gr       1.607    gamma   0.233
		# max |deriv| 3e-09                          gp       0.010    tau-a   0.009
		#                                            Brier    0.021
		#
		#           Coef    S.E.   Wald Z Pr(>|Z|)
		# Intercept -3.4945 0.5155 -6.78  <0.0001
		# 1          0.7739 0.2370  3.27  0.0011
		# 2          0.4755 1.0362  0.46  0.6463
		# 3          0.7196 0.2463  2.92  0.0035
		# race=A    -1.1328 0.2934 -3.86  0.0001
		# race=B    -0.5154 0.2182 -2.36  0.0181
		# race=H    -0.1666 0.2728 -0.61  0.5414
		# 1         -1.1109 0.4309 -2.58  0.0099
		# 2          1.5417 0.9413  1.64  0.1014
		# pky        0.0054 0.0010  5.50  <0.0001

		xx=summary(myfit.glm)$coef
		or=lm2=myOR.CI4(xx,bName="Estimate",sName="Std. Error",pName="Pr(>|z|)",zName="z value",pval=T)
		row.names(or)=row.names(xx)
		or[,-7]
		#               OR  CI1   CI2   beta    sd        pval2
		# (Intercept) 0.03 0.01  0.08 -3.495 0.515 1.206526e-11
		# ns(age, 3)1 2.17 1.36  3.45  0.774 0.237 1.092716e-03
		# ns(age, 3)2 1.61 0.21 12.26  0.475 1.036 6.463128e-01
		# ns(age, 3)3 2.05 1.27  3.33  0.720 0.246 3.481903e-03
		# raceA       0.32 0.18  0.57 -1.133 0.293 1.129956e-04
		# raceB       0.60 0.39  0.92 -0.515 0.218 1.814517e-02
		# raceH       0.85 0.50  1.44 -0.167 0.273 5.413561e-01
		# ns(bmi, 2)1 0.33 0.14  0.77 -1.111 0.431 9.933516e-03
		# ns(bmi, 2)2 4.67 0.74 29.57  1.542 0.941 1.014480e-01
		# pky         1.01 1.00  1.01  0.005 0.001 3.717363e-08

	   #setwd(outdir)
	   #write.csv(or,"COPD.regression.csv")
	   #write.csv(or,"COPD.regression_FEMALE.csv")

	   ########### [a] Diagnostics  ###############################################

   		# AUC
   		# brier score
   		# classification error
   		# goodness-of-fit


	   ########### [b] Apparent validation ########################################

	   doVal=F
	   if(doVal==T){

			   mycal=calibrate(myfit)
			   plot(mycal)

			   ########### [c] Variable importance and BMA method #########################

				### BMA ########

				#library(BMA)
				glm.out.va= bic.glm(fm, glm.family=binomial, data=MYDATA)
				summary(glm.out.va)

				par(mfrow=c(1,1))
				imageplot.bma(glm.out.va,cex=0.5)

				par(mfrow=c(1,1))
				plot(glm.out.va)


				######### relative importance #########
				# > fm
				# fh ~ age + edu + race + bmi + ns(pky, 2)
				fm2= copd ~ fh + ns(age, 2) + edu + race + ns(bmi, 3) + cigstat +
    					ns(pky, 2) + cigday

				gg=glm(fm2, data=MYDATA, family=binomial)
				an=anova(gg)
				an
				# Analysis of Deviance Table

				#                 Df Deviance Resid. Df Resid. Dev
				# NULL                            34448      15367
				# fh               1    16.30     34447      15351
				# ns(age, 2)       2    93.61     34445      15257
				# edu              2   124.01     34443      15133
				# race             3    23.09     34440      15110
				# ns(bmi, 3)       3    85.97     34437      15024
				# cigstat          2   463.21     34435      14561
				# ns(cigyears, 2)  2   373.81     34433      14187
				# ns(pky, 2)       2   141.10     34431      14046
				# cigday           1    11.21     34430      14035
				# race:cigstat     6    16.78     34424      14018



				fm2= copd ~ fh + ns(age, 2) + edu + race + ns(bmi, 3) + cigstat +
    					ns(pky, 2)




				an=anova(myfit.glm)
				an
				#            Df Deviance Resid. Df Resid. Dev
				# NULL                       34448      15367
				# fh          1    16.30     34447      15351
				# ns(age, 2)  2    93.61     34445      15257
				# edu         2   124.01     34443      15133
				# race        3    23.09     34440      15110
				# ns(bmi, 3)  3    85.97     34437      15024
				# cigstat     2   463.21     34435      14561
				# ns(pky, 2)  2   446.57     34433      14114


				tt1=an$Dev[-1] - an$Df[-1]
				if(Gender=="M") names(tt1)=c("FH","age","edu","race","bmi","cig.stat","pack-year")
				if(Gender=="F") names(tt1)=c("age","edu","race","bmi","cig-years","pack-year","cig-day")


				tt2=tt1[order(tt1,decreasing=T)]
				barplot(tt2/sum(tt2),col=heat.colors(length(tt2)),las=2, cex.lab=1.2, cex.main=1.5, cex.axis=1.5,
							ylab="Relative Importance (%)", main="Relative Importance of Variables", ylim=c(0,0.8))


				barplot(tt2,col=heat.colors(length(tt2)),las=2, cex.lab=1.2, cex.main=1.5, cex.axis=1.5,
							ylab="Chisq-df", main="Relative Importance of Variables")#, ylim=c(0,0.8))


			   ########### [6] 10-fold or Bootstrap validation ###################################################

				#mycalboot=calibrate(myfit, method="boot", B=40)


			   val=validate(myfit,method="boot",B=40)
				### include c-index ###
				cindex2=0.5*(val["Dxy",]+1)
				cindex2["optimism"] = cindex2["training"]-cindex2["test"] # how much excess?
				cindex2["index.corrected"] = cindex2["index.orig"]-cindex2["optimism"]
				cindex2["n"]=val["Dxy","n"]
				val2=rbind(cindex=cindex2,val)
				val2
				#             index.orig     training        test     optimism index.corrected   n


				B=ceiling(0.1*nrow(MYDATA));B
				#[1] 100
				valcv=validate(myfit, method="crossvalidation", B=500)

				#           index.orig training    test optimism index.corrected   n
				# Dxy           0.2832   0.2833  0.2493   0.0340          0.2492 100
				# R2            0.0893   0.0894  0.2657  -0.1763          0.2656 100
				# Intercept     0.0000   0.0000  1.4258  -1.4258          1.4258 100
				# Slope         1.0000   1.0000 10.3894  -9.3894         10.3894 100
				# Emax          0.0000   0.0000  0.4214   0.4214          0.4214 100
				# D             0.0682   0.0683  0.1444  -0.0761          0.1443 100
				# U            -0.0020  -0.0020  0.1318  -0.1338          0.1318 100
				# Q             0.0702   0.0703  0.0126   0.0577          0.0125 100
				# B             0.2316   0.2316  0.2359  -0.0043          0.2360 100
				# g             0.6224   0.6228  8.3184  -7.6956          8.3180 100
				# gp            0.1456   0.1456  0.1973  -0.0517          0.1973 100

				### include c-index ###
				cindex2=0.5*(valcv["Dxy",]+1)
				cindex2["optimism"] = cindex2["training"]-cindex2["test"] # how much excess?
				cindex2["index.corrected"] = cindex2["index.orig"]-cindex2["optimism"]
				cindex2["n"]=valcv["Dxy","n"]
				val2cv=rbind(cindex=cindex2,valcv)
				val2cv
				#             index.orig     training        test     optimism index.corrected   n


			   ########### [7] External validation ###############################################################


				pred.logit = predict(myfit, mydat.val)
				# > pred.logit[1:4]
				#        4        5        6        7
				# 1.138703 1.251589 1.193375 1.396058
				phat = 1/(1+exp(-pred.logit))
				phat[1:10]
				#          3          8          9         14         15         16         18         24         25         26
				# 0.11712426 0.06388822 0.07808821 0.14458999 0.08740165 0.08813680 0.10004402 0.11276686 0.09241890 0.08233308

				###compare predicted prob vs. actual outcome y
				valprob = val.prob(p=phat, y=mydat.val[,"copd"],cex=0.7)#, g.group=4)#,m=5)#,g=10)#,g.group=2,cex=0.5);valprob

				valprob = val.prob(p=phat, y=mydat.val[,"copd"],cex=0.7, lim=c(0,0.15))#, g.group=4)#,m=5)#,g=10)#,g.group=2,cex=0.5);valprob
				valprob
				t(valprob)
				#           Dxy  C (ROC)         R2          D D:Chi-sq D:p      U    U:Chi-sq U:p          Q     Brier
				# [1,] 0.260818 0.630409 0.07829283 0.05848725 30.24363  NA -0.004 6.82121e-13   1 0.06248725 0.2350141
				#        Intercept     Slope      Emax       S:z       S:p       Eavg
				# [1,] -0.06782444 0.9099561 0.0327751 0.7558215 0.4497562 0.03672528

				###  validation by sex ###
				valprob2 = val.prob(p=phat, y=mydat.val[,"copd"],cex=0.5,group=mydat.val[,"race"],lim=c(0,0.15))#,g=10)#,g.group=2,cex=0.5);valprob
				plot(valprob2,lim=c(0,0.3))

				valprob3 = val.prob(p=phat, y=mydat.val[,"copd"],cex=0.5,group=mydat.val[,"cigstat"],lim=c(0,0.15))#,g=10)#,g.group=2,cex=0.5);valprob
				plot(valprob3,lim=c(0,0.3))




		}#end of doVal


   		########### [8] Calibration of parameters using US census data #######################################################################


		glm.copd = myfit.glm

		######## average risk of FH at age = 55

		mycoef = glm.copd$coef
		mycoef
		#  (Intercept)             fh    ns(age, 2)1    ns(age, 2)2     educollege     edupostcol          raceA          raceB          raceH    ns(bmi, 3)1
		#    -2.40033124     0.17085227     0.61983877     0.67271579    -0.26755047    -0.25386091    -0.38101029     0.18288279    -0.25648075    -0.54984713
		#    ns(bmi, 3)2    ns(bmi, 3)3 cigstatCurrent  cigstatFormer    ns(pky, 2)1    ns(pky, 2)2         cigday
		#    -1.80531353     1.05954230     0.12405182     0.20750419     6.41614289     3.15551388    -0.02525834
		# >

		glm.copd$model[1:3,]
		#   copd fh ns(age, 2).1 ns(age, 2).2     edu race ns(bmi, 3).1 ns(bmi, 3).2 ns(bmi, 3).3 cigstat ns(pky, 2).1 ns(pky, 2).2 cigday
		# 2    1  0    0.5662628   -0.2108419 postcol    W   -0.1500144    0.6588653   -0.3426047  Former   0.19989972  -0.09578357     60
		# 4    0  0    0.4238313   -0.2437134  <=high    W   -0.2149782    0.6226163   -0.3237563  Former   0.26231297  -0.11920978     60
		# 5    0  1    0.3802726   -0.2274948 postcol    W    0.2074041    0.5391710   -0.2566754   Never   0.00000000   0.00000000      0
		# >


		x=AGE = 55
		# > ref.copd
		# ref.copd  <--- at age 55

		ave.eff.prob.before = myGetCOPDProb2(x, mycoef, ref.race, ref.edu, ref.fh, ref.bmi.mean.55, ref.smk, ref.pky.mean.55, ref.cpd.mean.55, ref.cigyear.mean.55,Gender, MYDATA)
		ave.eff.prob.before
		# [[1] 0.04137078


		#tt=predict(glm.copd, type="response")
		#mean(tt)


		# ave.eff.prob.before = myGetPHProb2(x, mycoef, ref.race, ref.pky.mean.55, Gender, MYDATA3)
		# ave.eff.prob.before

		myages = matrix(55:90,ncol=1)

		probs.copd = apply(myages, 1, myGetCOPDProb2,  mycoef=mycoef,  ref.race=ref.race,  ref.edu=ref.edu, ref.fh=ref.fh, ref.bmi.mean.55= ref.bmi.mean.55, ref.smk=ref.smk,  ref.pky.mean.55=ref.pky.mean.55, ref.cpd.mean.55=ref.cpd.mean.55, ref.cigyear.mean.55=ref.cigyear.mean.55,Gender=Gender, MYDATA=MYDATA)
	#probs.ph = apply(myages, 1, myGetPHProb.ns2,  mycoef=mycoef,  ref.race=ref.race,  ref.bmi.mean.55= ref.bmi.mean.55,  ref.pky.mean.55=ref.pky.mean.55, Gender=Gender, MYDATA=MYDATA)

		plot(myages, probs.copd*100, pch=17,col="red", xlab="Age",ylab="Prevalence (%) of COPD", main="(Before calibration) Prevalence of COPD",ylim=c(0,20))


       ### compare it to predict(): just the curve shape ###

		  doThis=F
		  if(doThis==T){
				  ag=55:90
				  newdata=data.frame(age=55:90, race=rep("W",length(ag)), bmi=rep(27,length(ag)), pky=rep(17,length(ag)))
				  pr=predict(glm.ph, newdata)
				  pr2=exp(pr)/(1+exp(pr))
						plot(ag, 100*pr2, pch=16, col="blue", xlab="Age", ylab="Prevalence (%) of personal History of LC", main="PH ~ ns(age,3)")

		 }#3nd of


		ave.eff.prob.before
		ref.copd
		# [1] 0.04137078
		# > 		ref.copd
		# [1] 0.074


		############ figuring out why curve goes down with age
		doThis=F
			if(doThis==T){


						smdat= MYDATA[,c("ph","age")]
						#ff=glm(ph~ns(age,3), family=binomial)
						ff=glm(ph~ns(age,3), data=smdat,family=binomial)
							mycoef.ns = coef(ff)
							mycoef.ns
							# (Intercept) ns(age, 3)1 ns(age, 3)2 ns(age, 3)3
							#  -4.2011965   0.8032236   0.6598889   0.8109479
							# > ff$model[1:10,]
							#    ph ns(age, 3).1 ns(age, 3).2 ns(age, 3).3
							# 1   0  0.552003858  0.350451895 -0.033737803
							# 2   0  0.261042949  0.512767628 -0.303393910
							# 4   0 -0.100977145  0.532163142 -0.319297885
							# 5   0 -0.122418888  0.493437955 -0.296062773
							# 6   0 -0.122418888  0.493437955 -0.296062773
							# 7   0 -0.009430963  0.569906079 -0.341943647
							# 10  0  0.309789956  0.341832803  0.331966985


						newdata=55:90

						pr = predict(ff, newdata=data.frame(age=55))
						pr


						pr = predict(ff, newdata=data.frame(age=55:90))
						pr2= (exp(pr)/(1+exp(pr)))
						plot(newdata, 100*pr2, pch=16, col="blue", xlab="Age", ylab="Prevalence (%) of personal History of LC", main="PH ~ ns(age,3)")
						pr2[1:10]
						#          1          2          3          4          5          6          7          8          9
						# 0.01435893 0.01457158 0.01491928 0.01543094 0.01614298 0.01710251 0.01835124 0.01985611 0.02154567
						#         10
						# 0.02331797



						#myGetPHProb.tmp <- function(x, mycoef.ns, MYDATA)
						probs.ph = apply(myages, 1, myGetPHProb.tmp,  mycoef.ns=mycoef.ns,   MYDATA=MYDATA)

						# > probs.ph[1:10]
						#  [1] 0.01352676 0.01362712 0.01386767 0.01427630 0.01488883 0.01575262 0.01691015 0.01832669 0.01992775
						# [10] 0.02160629

						plot(myages, probs.ph*100, pch=17,col="red", xlab="Age",ylab="Prevalence (%) of PH", main="Multivariate Model")


				######## comparing whether predict() and my function are producing the same results ##
						### age 80

						pr = predict(ff, newdata=data.frame(age=80))
						pr2= (exp(pr)/(1+exp(pr)))
						pr2
						#0.03059919

						#myGetPHProb.tmp(x=80, mycoef.ns, MYDATA)
						#[1] 0.03059919


			}


	    ############################ calibration ##########################################

	    doThis=F
	    if(doThis==T){


	    	mycoef2 = mycoef
	    	mycoef2[1] = mycoef[1]*0.755 # increase the intercept (negative)
	    	#mycoef2[2] = mycoef[2]*1.2
	    	myGetCOPDProb(x, mycoef2, ref.race, ref.edu, ref.fh, ref.bmi.mean.55, ref.smk, ref.pky.mean.55, ref.cpd.mean.55, Gender, MYDATA)


	    	#[1] 0.0614254
	    	ref.copd
			#[1] 6.14


	    }#end of


			mycoef = glm.copd$coef
		    mycoef.adj = mycoef
	   if(Gender=="M") { mycoef.adj[1] = mycoef[1]*0.755  }# increase the intercept (negative) }
	   if(Gender=="F") {

	   		mycoef.adj[1] = mycoef[1]*0.78 # increase the intercept (negative)
	   		#mycoef.adj["age"] =  mycoef["age"]*1.2


	   	}

	    	ave.eff.prob = myGetCOPDProb2(x, mycoef.adj, ref.race, ref.edu, ref.fh, ref.bmi.mean.55, ref.smk, ref.pky.mean.55, ref.cpd.mean.55, ref.cigyear.mean.55, Gender, MYDATA)
			ave.eff.prob
			ref.copd

			# [1] 0.07227639
			# > 			ref.copd
			# [1] 7.4

			myages = matrix(55:90,ncol=1)
			probs.copd2 = apply(myages, 1, myGetCOPDProb2,  mycoef=mycoef.adj,  ref.race=ref.race,  ref.edu=ref.edu, ref.fh=ref.fh, ref.bmi.mean.55= ref.bmi.mean.55, ref.smk=ref.smk,  ref.pky.mean.55=ref.pky.mean.55, ref.cpd.mean.55=ref.cpd.mean.55, ref.cigyear.mean.55=ref.cigyear.mean.55,Gender=Gender, MYDATA=MYDATA)

			#probs.ph2 = apply(myages, 1, myGetPHProb,  mycoef=mycoef.adj,  ref.race=ref.race,  ref.bmi.mean.55= ref.bmi.mean.55,   ref.pky.mean.55=ref.pky.mean.55, Gender=Gender, MYDATA=MYDATA)

			#apply(myages, 1, myGetFHProb,  mycoef=mycoef.adj, ref.edu=ref.edu, ref.race=ref.race,ref.pky.mean.55=ref.pky.mean.55, Gender=Gender, MYDATA=MYDATA)

			plot(myages, probs.copd2*100, pch=17,col="red", xlab="Age",ylab="Prevalence (%) of COPD", main="(After calibration) Multivariate Model", ylim=c(0,20))

			## adding from CDC ##

			plot(myages, probs.copd2*100, pch=17,col="red", xlab="Age",ylab="Prevalence (%) of COPD", main="(After calibration) Multivariate Model", ylim=c(0,20))


			### adding more reference CDC data points

			xx=c(55, 75)
			yy=c(7.4, 11.9)
			points(xx,yy,pch=17,col="blue")


			legend(x="topleft", legend=c("CDC", "Model"), fill=c("red","blue"),cex=1.2)

			# > 100*(1-0.24)
			# [1] 24




			########### barplot comparison #############

		  par(mar=c(5,5,5,3))
			#ref.fh.ci = c(9.74, 11.90)
			ci1=ref.copd.ci[1]
			ci2=ref.copd.ci[2]

		   mat=cbind(ref.copd, ave.eff.prob.before*100)
		   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="COPD prevalence (%)",
		   main="[Before Adjustment] \n Prevalence (%) of COPD (age 55)", cex.main=1.5, ylim=c(0,15))

		   ##### confidence interval ###
		   xs = c(1.5,2.5)#,7.5)

		   for(u in 1:length(xs)){


		   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

		   }#end of

		  legend(x="topleft", legend=c("Reference", "Model-based"), fill=c("red","yellow"), ncol=2,cex=1)



		######### after calibration



		   mat=cbind(ref.copd, ave.eff.prob*100)
		   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="COPD prevalence (%)",
		   main="[After Adjustment] \n Prevalence (%) of COPD (age 55)", cex.main=1.5, ylim=c(0,15))

		   ##### confidence interval ###
		   xs = c(1.5,2.5)#,7.5)

		   for(u in 1:length(xs)){


		   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

		   }#end of

		  legend(x="topleft", legend=c("Reference", "Model-based"), fill=c("red","yellow"), ncol=2,cex=1)



			  ANS = list(mycoef.adj=mycoef.adj,  mycoef.before = mycoef, glm.copd = glm.copd, glm.or= or,  prev.copd.adj = ave.eff.prob, prev.copd.unadj = ave.eff.prob.before, ref.copd = ref.copd/100, ref.copd.ci = ref.copd.ci)#, ns.mat.age=ns.mat.age, ns.mat.bmi=ns.mat.bmi)
			  ANS


}#end of myCOPD.cond


myCOPD.cond <- function(mydat, ref.copd, ref.cigstop, ref.fh, ref.pky,  ref.edu, ref.race, Gender){

		######### Pr(COPD| smoking, gender, BMI, FH and age) #######################################
					#logistic regression using PLCO & prevalence data
					#http://www.cdc.gov/copd/data.htm
		#copd_f  Chronic Obstructive Pulmonary Disease (COPD)
				# Built from bronchit_f and emphys_f. If bronchit_f or emphys_f = 1 then copd_f = 1. If either is missing, then copd_f is missing. Else if both are no, then copd_f is no.
				# (format: ynf)
				# .F="No Form" .M="Missing" 0="No" 1="Yes"


		#####################[0] Define variables ################################################

		##### (1) define smoking status ###########
				# prevalence data: http://en.wikipedia.org/wiki/Prevalence_of_tobacco_consumption
				cigstat=mydat[,"cig_stat"]
				# > table(cig_stat)
				# cig_stat
				#     0     1     2     never, current, former
				# 26855  8581 37260

						tb.cig=table(cigstat)
						round(tb.cig/sum(tb.cig),2)
						# cigstat
						#    0    1    2
						# 0.37 0.12 0.51

				cigstat2=cigstat
				cigstat2[cigstat==0]="Never"
				cigstat2[cigstat==1]="Current"
				cigstat2[cigstat==2]="Former"

				# for polytomous ##
				cigstat3=cigstat
				cigstat3[cigstat==0]="0.Never"
				cigstat3[cigstat==1]="2.Current"
				cigstat3[cigstat==2]="1.Former"

		#### (2) education ########################
		#educat #Education
				# Question 3
				# .F="No Form" .M="Missing"
				# 1="Less than 8 years" 2="8-11 years"
				# 3="12 years or completed high school" 4="Post high school training other than college"
				# 5="Some college"
				# 6="College graduate" 7="Postgraduate"

				edu0=mydat[,"EDUCAT"]
				# edu
				#     1     2     3     4     5     6     7     M
				#   879  5035 13260  8905 14837 13757 15862   161
				# not finished highschool - highschool graduate -college graduate - postgraduate
				#   (1,2)                        (3,4,5)                 6                7

				edu=edu0
				#edu[edu0==1 | edu0==2]=1
				edu[edu0 <=5 ]=1
				edu[edu0==6]=2
				edu[edu0==7]=3
				edu[edu0=="M"]=NA

						tb.edu=table(edu)/sum(table(edu))
						tb.edu
						# edu
						#         1         2         3
						# 0.7016927 0.1504578 0.1478495

	            ## factor variable ##
				edu2=edu
				edu2[edu==1]="<=high"
				edu2[edu==2]="college"
				edu2[edu==3]="postcol"
				tb.edu2=table(edu2)/sum(table(edu2))
				tb.edu2
				# edu2
				#    <=high   college   postcol
				# 0.7016927 0.1504578 0.1478495

						doThis=F
						if(doThis==T){
							edu=edu0
							edu[edu0==1 | edu0==2]=1
							edu[edu0==3 | edu0==4 | edu0==5]=2
							edu[edu0==6]=3
							edu[edu0==7]=4
							edu[edu0=="M"]=NA

							tb.edu=table(edu)
							# edu
							#     1     2     3     4
							#  5914 37002 13757 15862
							# > round(tb.edu/sum(tb.edu),3)
							# edu
							#     1     2     3     4
							# 0.082 0.510 0.190 0.219

							edu2=edu
							edu2[edu==1]="<high"
							edu2[edu==2]="high"
							edu2[edu==3]="college"
							edu2[edu==4]="postcol"

						}#

		####### (3) race #############
				# 1="White, Non-Hispanic" 2="Black, Non-Hispanic" 3="Hispanic"
				# 4="Asian"
				# 5="Pacific Islander" 6="American Indian" 7="Missing"

				race0=mydat[,"race7"]
				# race0
				#     1     2     3     4     5     6     7
				# 64222  3273  1569  2957   452   185    38

				## merge 4-7
				# "white" - "black" - "hispanic" - "asian"
				race=race0
				race[race0>4]=NA
						tb.race=table(race)
						tb.race
						# race
						#     1     2     3     4
						# 64222  3273  1569  3632
						round(tb.race/sum(tb.race),2)
						# race
						# race
						#    1    2    3    4
						# 0.89 0.05 0.02 0.04
				race2=race
				race2[race==1]="W"
				race2[race==2]="B"
				race2[race==3]="H"
				race2[race==4]="A"

	   #### (4) define "Edu-race" variable #############


				race.edu=paste(race2,edu2,sep="-") #[1] "W-<=high"   "NA-college" "W-<=high"   "W-college"  "W-college"
				race.edu[is.na(race2) | is.na(edu2)] = NA
				race.edu=as.factor(as.character(race.edu))

	  #####  (5) BMI ########

              # clean chars ---------------------
              temp <- mydat[,"bmi_curr"]
              temp[temp %in% c("F","M","R")] <- NA
              temp_ <- mydat[,"bmi_curc"]
              temp_[temp_ %in% c("F","M","R")] <- NA

              # bmi=as.numeric(mydat[,"bmi_curr"]) #[1] 38.07647 31.81634 22.69663 27.25385 28.03809 24.19162 30.57929 25.16239 22.28669 23.10435
              bmi=as.numeric(temp)
              # bmicat=as.numeric(mydat[,"bmi_curc"]) #[1] 38.07647 31.81634 22.69663 27.25385 28.03809 24.19162 30.57929 25.16239 22.28669 23.10435
              bmicat=as.numeric(temp_)


	  ####  (6) define age variable

			age=as.numeric(mydat[,"age"])
			# > range(age)
			# [1] 49 78

	 ####### (7) define Smoking related variables ##
			#cig_per_day  of Cigarettes Smoked Per Day
					#The maximum number of cigarettes smoked per day, based on the range specified. The category 81+ is set to 100.

			# cig_years_rnd # of Years Smoked Cigarettes
					# Derived from questions 10-13. This differs from cig_years because it uses randomization age instead of BQ age.
					# Numeric .F="No Form" .M="Missing"
			#cig_stop_rnd # of Years Since Stopped Smoking Cigarettes
					# Derived from questions 12 and 13. This differs from cig_stop because it uses randomization age instead of BQ age.
					# Numeric
					# .F="No Form" .M="Missing" .N="Not Applicable"

			### pack-years ##
			pky0=mydat[,"pack_years_rnd"]
			pky2=pky0
			pky2[pky0=="M"]=NA
			pky2=as.numeric(pky2)
			#[1]   0 260

			### make category (0-10), (10-30), (30-60), (60-100), 100+
			pky=pky2
			pky[pky2 <=10] = "lst10"
			pky[pky2 > 10 & pky2<=30] ="10_30"
			pky[pky2 > 30 & pky2 <=60] = "30_60"
			pky[pky2 > 60 & pky2 <=100] = "60_100"
			pky[pky2>100]="gt100"
			table(pky)
			# pky
			#  10_30  30_60 60_100  gt100  lst10
			#  14808  14932   7212   2261  33430

			#### cigday ##
			cigday0=mydat[,"cig_per_day"]
				# > table(mydat[,"cig_per_day"])
				#
				#    10   100    20    30    40    60    80     M     N
				#  7637   177 16972 10579  6290  3511   668     7 26855   <--- never smoker

			#### group: N, (0-20], (20-40], (40-60], (60,100]
			cigday=cigday0
			cigday[cigday0=="N"]	= "never"
			cigday[cigday0==10 | cigday0==20 ]	= "0_20"
			cigday[cigday0==30 | cigday0==40 ]	= "20_40"
			cigday[cigday0==50 | cigday0==60 ]	= "40_60"
			cigday[cigday0==70 | cigday0==80 | cigday0==90 | cigday0==100]	= "60_100"
			cigday[cigday0=="M"]	= NA

			table(cigday)
			# cigday
			#  20_40  40_60 60_100  lst20  never
			#  16869   3511    845  24609  26855


			## define cigday2 ###

			cigday2=cigday0
			cigday2[cigday0=="N"]=0
			cigday2[cigday0=="M"]=NA
			cigday2=as.numeric(cigday2)


			### define cigstop ###
			cigstop0=mydat[,"cig_stop_rnd"]
			# > #range(as.numeric(cigstop0),na.rm=T)
			# [1]  0 62

			# cigstop0
			#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24    25    26    27    28    29     3
			#  8581   697   825  1191   975   983   975   969  1059   962   858   845   915   750  1217   884   884   911   874  1062  1048  1026   992  1055   728
			#    30    31    32    33    34    35    36    37    38    39     4    40    41    42    43    44    45    46    47    48    49     5    50    51    52
			#  1187  1056   975   904   812   772   623   523   466   414   665   338   342   284   228   209   181   137   117   110    80   810    49    44    24
			#    53    54    55    56    57    58    59     6    62     7     8     9     N
			#    15    15     3     2     3     3     2   785     1   808   805   771 26867
			# > table(cigstop0,cigstat2)
			#         cigstat2
			# cigstop0 Current Former Never
			#      0      8581      0     0  --> current smoker has cigstop=0, yes makes sens
			#      0.5       0    697     0
			# ..
			#      8         0    805     0
			#      9         0    771     0
			#      N         0     12 26855    ---> never smoker nas cigstop="N"

            # F, M, N ------------------------
            temp <- cigstop0
            temp[temp %in% c("F","M","N")] <- NA

			### define: N, 0-20, 20-40, 40+ ##
			# tt=as.numeric(cigstop0)
            tt=as.numeric(temp)

			# > range(tt,na.rm=T)
			# [1]  0 62
			cigstop=cigstop0
			cigstop[cigstop0=="N"]="never"
			cigstop[tt==0] = "0"
			cigstop[tt>0 & tt <=20] = "0_20"
			cigstop[tt >20 & tt<=40] = "20_40"
			cigstop[tt >40 ] = "gt40"

			table(cigstop)
			#              0           0_20          20_40           gt40          never
			#           8581          18593          16806           1849          26867
			#boxplot(tt~cigstop)
			cigstop2=tt


			### define cigyears ###

			cigyears0=mydat[,"cig_years_rnd"]
			# > table(cigyears0)
			# cigyears0
			#     0   0.5     1    10    11    12    13    14    15    16    17    18    19     2    20    21    22    23    24    25    26    27    28    29     3
			# 26855    92   225  1106   752   965   748  1011  1009   815   964   950   930   453  1312   873  1088   946  1058  1028   851   908   935   930   419
			#    30    31    32    33    34    35    36    37    38    39     4    40    41    42    43    44    45    46    47    48    49     5    50    51    52
			#  1034   873  1012   940  1024  1067   977  1137  1124  1255   511  1340  1180  1114  1039   959   838   817   654   607   551   599   490   424   349
			#    53    54    55    56    57    58    59     6    60    61    62    63    64     7     8     9     M
			#   256   205   155    99    83    44    25   599    24    12     4     5     3   662   628   708    46
			tt=as.numeric(mydat[,"cig_years_rnd"])
			# range(tt,na.rm=T)
			# [1]  0 64

			## group:  0-20, 20-40, 40-60
			cigyears=cigyears0
			cigyears[cigyears0=="M"]=NA
			cigyears[tt==0] = "0"
			cigyears[tt >0 & tt <=20] = "0_20"
			cigyears[tt >20 & tt<=40] = "20_40"
			cigyears[tt >40] = "gt40"

			table(cigyears)
			# cigyears
			#     0  0_20 20_40  gt40
			# 26855 15458 20400  9937
			#boxplot(tt~cigyears)

			## cigyears.numeric ##

			cigyears2=cigyears0
			cigyears2[cigyears0=="M"]=NA
			cigyears2=as.numeric(cigyears2)

	####### (8) family history of lung cancer ############################################


		fh0=mydat[,"lung_fh"]
		# fh0
		#     0     1     9     M
		# 62796  6851  2453   596

		fh=fh0
		fh[fh0=="9" | fh0=="M"]=NA
		fh=as.numeric(fh)
		tb.fh=table(fh)/sum(table(fh))
		tb.fh
		# fh
		#          0          1
		# 0.90163252 0.09836748



   ####### (9) COPD ######################################################################

		#copd_f  Chronic Obstructive Pulmonary Disease (COPD)
				# Built from bronchit_f and emphys_f. If bronchit_f or emphys_f = 1 then copd_f = 1. If either is missing, then copd_f is missing. Else if both are no, then copd_f is no.
				# (format: ynf)
				# .F="No Form" .M="Missing" 0="No" 1="Yes"

		copd0=mydat[,"copd_f"]
		# copd0
		#     0     1     M
		# 67994  4231   471

		copd=copd0
		copd[copd0=="M"]=NA
		copd=as.numeric(copd)
		# > tb=table(copd)
		# > tb/sum(tb)
		# copd
		#          0          1
		# 0.94141918 0.05858082


	####### (10) Barplot for COPD ########################################################

		tb.copd=table(copd)/sum(table(copd))
					TAB=tb.copd
					barplot(TAB,col=(heat.colors(3)),ylim=c(0,1.3),main="(PLCO) COPD",cex.axis=1.5,cex.lab=2)
					text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")


	################## [2] Model fitting: logistic regression ####################################

		Y=copd
		mat=cbind(edu2,race2,cigstat2, cigstop, cigday, cigyears,pky)#,age)
		covs.all=cbind(myDummyVar3(mat,refer=T,SORT=F),bmi=bmi,age=age,fh=fh)

		#covnames=colnames(covs.all)[multiGrep(c("edu2","race2","cigstop","pky","age","fh"),colnames(covs.all))]

  #### this was done manually ########

  if(Gender=="M"){

		mycov=NULL
		cnames=c("edu2","race2","cigstop","pky","age","fh")
		covnames=colnames(covs.all)[multiGrep(cnames,colnames(covs.all))]
				covnames
				#  [1] "edu2.<=high"  "edu2.college" "edu2.postcol" "race2.A"      "race2.B"      "race2.H"      "race2.W"      "pky.10_30"    "pky.30_60"
				# [10] "pky.60_100"   "pky.gt100"    "pky.lst10"    "bmi"          "age"

				#  [1] "edu2.<=high"  "edu2.college" "edu2.postcol" "race2.A"      "race2.B"      "race2.H"      "race2.W"      "pky.10_30"    "pky.30_60"
				# [10] "pky.60_100"   "pky.gt100"    "pky.lst10"    "bmi"          "age"

				#  [1] "edu2.<=high"      "edu2.college"     "edu2.postcol"     "race2.A"          "race2.B"          "race2.H"          "race2.W"
				#  [8] "cigstat2.Current" "cigstat2.Former"  "cigstat2.Never"   "pky.10_30"        "pky.30_60"        "pky.60_100"       "pky.gt100"
				# [15] "pky.lst10"        "bmi"              "age"

		refs=c("edu2.<=high","race2.W","cigstat2.Never","pky.lst10","cigstop.never","cigyears.0")
		refcol=multiGrep(refs,covnames);refcol;refs

		mycov = covs.all[,covnames[-refcol]]
		colnames(mycov)
		#  [1] "edu2.college"           "edu2.postcol"           "race2.A"                "race2.B"                "race2.H"
		#  [6] "cigstop.0"              "cigstop.0_20"           "cigstop.20_40"          "cigstop.gt40.neversmok" "pky.10_30"
		# [11] "pky.30_60"              "pky.60_100"             "pky.gt100"              "bmi"                    "age"

		## some exclusion
		#exc=c(5,8,9)
		#mycov=mycov[,-exc]

  }#end of "M"



  if(Gender=="F"){

		cnames=c("edu2","race2","cigstop","pky","age","fh")
		covnames=colnames(covs.all)[multiGrep(cnames,colnames(covs.all))]
				covnames
				#  [1] "edu2.<=high"  "edu2.college" "edu2.postcol" "race2.A"      "race2.B"      "race2.H"      "race2.W"      "pky.10_30"    "pky.30_60"
				# [10] "pky.60_100"   "pky.gt100"    "pky.lst10"    "bmi"          "age"

				#  [1] "edu2.<=high"  "edu2.college" "edu2.postcol" "race2.A"      "race2.B"      "race2.H"      "race2.W"      "pky.10_30"    "pky.30_60"
				# [10] "pky.60_100"   "pky.gt100"    "pky.lst10"    "bmi"          "age"

				#  [1] "edu2.<=high"      "edu2.college"     "edu2.postcol"     "race2.A"          "race2.B"          "race2.H"          "race2.W"
				#  [8] "cigstat2.Current" "cigstat2.Former"  "cigstat2.Never"   "pky.10_30"        "pky.30_60"        "pky.60_100"       "pky.gt100"
				# [15] "pky.lst10"        "bmi"              "age"

		refs=c("edu2.<=high","race2.W","cigstat2.Never","pky.lst10","cigstop.never","cigyears.0")
		refcol=multiGrep(refs,covnames);refcol;refs



		mycov = covs.all[,covnames[-refcol]]
		colnames(mycov)
		#  [1] "edu2.college"           "edu2.postcol"           "race2.A"                "race2.B"                "race2.H"
		#  [6] "cigstop.0"              "cigstop.0_20"           "cigstop.20_40"          "cigstop.gt40.neversmok" "pky.10_30"
		# [11] "pky.30_60"              "pky.60_100"             "pky.gt100"              "bmi"                    "age"

		## some exclusion (not significant)
		exc=c(5,8,9)
		mycov=mycov[,-exc]


  }#end of

			mydata=na.omit(data.frame(cbind(Y=Y,mycov)))
			glm0=glm(Y~.,data=mydata,family=binomial)
			stp0=glm0
		#stp0=step(glm0,method="forward")
		#summary(stp0)
			#stp0=glm0
			#stp02=step(glm0,method="backward")
			xx=summary(stp0)$coef
			or=myOR.CI4(xx,bName="Estimate",sName="Std. Error",pName="Pr(>|z|)",zName="z value",pval=T)
			rownames(or)=rownames(xx)
			glm.or = or

			#glm.copd=summary(stp0)
			glm.copd = glm0

			mycoef = glm.copd$coef
			# > mycoef
			#   (Intercept)  edu2.college  edu2.postcol       race2.A       race2.B       race2.H     cigstop.0
			# -6.2691028825 -0.3337032735 -0.2753624716 -0.4574188546  0.2267924407 -0.0006870761  0.9052450602
			#  cigstop.0_20 cigstop.20_40  cigstop.gt40     pky.10_30     pky.30_60    pky.60_100     pky.gt100
			#  0.6883502038  0.3428068341  0.4280578676 -0.0253225158  0.5551064463  1.1028039156  1.4087509991
			#           age            fh
			#  0.0428911792  0.2036594893

			############### compare this model estimate to literature ######################
			## literature: "COPD.prevalence.by.race.age.pdf" by American Lung Association ##
			## prevalence is 0.074 for 1950 cohort at age 55


	if(Gender=="M"){

        age.ref = 60  #

		base0 = mycoef[1] + mycoef["age"]*age.ref
		#inv.logit(base0)

		### average over education ##
		#ref.edu
		# > ref.edu
		#    high college postcol
		#    0.78    0.15    0.07

		## inner product for education effect ##
		ave.edu = sum( ref.edu[c("college","postcol")] * mycoef[c("edu2.college", "edu2.postcol")] ); ave.edu
		#[1] -0.069

		## average over race #####
		# > ref.race
		#    W    B    H    A
		# 0.76 0.10 0.08 0.05

		## coefficient is Hispanic vs. non-hispanic

		ave.race = sum(ref.race[c("A","B","H")]*mycoef[c("race2.A","race2.B","race2.H")]); ave.race  # just zero term for the rest
		#[1] -0.0002466647


		## average over cig.stop ###

		# "never" is never smoker, "cigstop.0" is not quitting
		# > ref.cigstop
		#         never     cigstop.0  cigstop.0_20 cigstop.20_40  cigstop.gt40
		#          0.37          0.33          0.20          0.10          0.00
		# > mycoef
		#   (Intercept)  edu2.college  edu2.postcol       race2.A       race2.B       race2.H     cigstop.0
		# -6.2691028825 -0.3337032735 -0.2753624716 -0.4574188546  0.2267924407 -0.0006870761  0.9052450602
		#  cigstop.0_20 cigstop.20_40  cigstop.gt40     pky.10_30     pky.30_60    pky.60_100     pky.gt100
		#  0.6883502038  0.3428068341  0.4280578676 -0.0253225158  0.5551064463  1.1028039156  1.4087509991
		#           age            fh
		#  0.0428911792  0.2036594893
		# > table(cigstop)
		# cigstop
		#     0  0_20 20_40  gt40 never  --> "never" means never smoker, "0" means didn't quit
		#  8581 18593 16806  1849 26867

		ave.cigstop = sum(ref.cigstop[-1]*mycoef[c("cigstop.0", "cigstop.0_20", "cigstop.20_40", "cigstop.gt40")]); ave.cigstop  # just zero term for the rest
		# > ref.cigstop[-1]
		#     cigstop.0  cigstop.0_20 cigstop.20_40  cigstop.gt40
		#          0.33          0.20          0.10          0.00
		# > mycoef[c("cigstop.0", "cigstop.0_20", "cigstop.20_40", "cigstop.gt40")]
		#     cigstop.0  cigstop.0_20 cigstop.20_40  cigstop.gt40
		#     0.9052451     0.6883502     0.3428068     0.4280579

		### average over pack-years #
		# > ref.pky  # from 1950 cohort
		#  lst10  10_30  30_60 60_100  gt100
		#   0.51   0.21   0.21   0.07   0.00

		tt1=ref.pky[-1];  tt1  # exclude reference
		tt2=mycoef[paste("pky.", names(ref.pky[-1]),sep="")]  ; tt2
		# > tt1
		#  10_30  30_60 60_100  gt100
		#   0.21   0.21   0.07   0.00
		# > tt2
		#   pky.10_30   pky.30_60  pky.60_100   pky.gt100
		# -0.02532252  0.55510645  1.10280392  1.40875100

		ave.pky = sum(tt1*tt2); ave.pky
		#[1] 0.1195359

		## average over family history of lung cancer ##
		# > (ref.fh/100)
		# [1] 0.109

		ave.fh = sum( (ref.fh/100)*mycoef["fh"]); ave.fh  # just zero term for the rest
		#[1] 0.02

		#### sum it up ##

		ave.eff.before = as.numeric( base0 + ave.edu + ave.race + ave.cigstop + ave.pky + ave.fh) ; ave.eff.before
		ave.eff.prob.before = inv.logit(ave.eff.before); ave.eff.prob.before  # 0.09537217
		#[1] 0.04163657

		#### (manually done) Adjustment needed #########################

		#ref.copd
		#[1] 0.074

		incr = 0.61   ### this is for Gender="M"

		ave.eff = as.numeric((base0 + incr)  + ave.edu + ave.race + ave.cigstop + ave.pky + ave.fh) ; ave.eff

		ave.eff.prob = inv.logit(ave.eff); ave.eff.prob  # 0.09537217
		#[1] 0.074

		#### update the fitted model ###
		mycoef.adj = mycoef
		# > mycoef.adj[1]
		# (Intercept)
		#   -2.304702
		mycoef.adj[1] = mycoef.adj[1]+incr  ; mycoef.adj
			# > mycoef
			#   (Intercept)  edu2.college  edu2.postcol       race2.A       race2.B       race2.H     cigstop.0
			# -6.2691028825 -0.3337032735 -0.2753624716 -0.4574188546  0.2267924407 -0.0006870761  0.9052450602
			#  cigstop.0_20 cigstop.20_40  cigstop.gt40     pky.10_30     pky.30_60    pky.60_100     pky.gt100
			#  0.6883502038  0.3428068341  0.4280578676 -0.0253225158  0.5551064463  1.1028039156  1.4087509991
			#           age            fh
			#  0.0428911792  0.2036594893
			# > mycoef.adj
			#   (Intercept)  edu2.college  edu2.postcol       race2.A       race2.B       race2.H     cigstop.0
			# -5.6491028825 -0.3337032735 -0.2753624716 -0.4574188546  0.2267924407 -0.0006870761  0.9052450602
			#  cigstop.0_20 cigstop.20_40  cigstop.gt40     pky.10_30     pky.30_60    pky.60_100     pky.gt100
			#  0.6883502038  0.3428068341  0.4280578676 -0.0253225158  0.5551064463  1.1028039156  1.4087509991
			#           age            fh
			#  0.0428911792  0.2036594893



 }#end of M

	if(Gender=="F"){

		# > mycoef
		#  (Intercept) edu2.college edu2.postcol      race2.A      race2.B    cigstop.0 cigstop.0_20    pky.10_30    pky.30_60
		#  -4.08879886  -0.36924575  -0.18383969  -0.37070085   0.33176546   0.51705093   0.31662639   0.15610779   0.80712541
		#   pky.60_100    pky.gt100          age           fh
		#   1.39733371   1.94426431   0.01775083   0.13825060

        age.ref = 60  #

		base0 = mycoef[1] + mycoef["age"]*age.ref
		inv.logit(base0)
		# 0.04636442

		### average over education ##
		#ref.edu
		# > ref.edu
		#    high college postcol
		#    0.78    0.15    0.07

		## inner product for education effect ##
		ave.edu = sum( ref.edu[c("college","postcol")] * mycoef[c("edu2.college", "edu2.postcol")] ); ave.edu
		#[1] -0.069
		#[1] -0.06825564

		## average over race #####
		# > ref.race
		#    W    B    H    A
		# 0.76 0.10 0.08 0.05

		## coefficient is Hispanic vs. non-hispanic

		ave.race = sum(ref.race[c("A","B")]*mycoef[c("race2.A","race2.B")]); ave.race  # just zero term for the rest
		#[1] -0.0002466647
		#[1] 0.0146415


		## average over cig.stop ###

		# "never" is never smoker, "cigstop.0" is not quitting
		# > ref.cigstop
		#         never     cigstop.0  cigstop.0_20 cigstop.20_40  cigstop.gt40
		#          0.37          0.33          0.20          0.10          0.00
		# > mycoef
		#   (Intercept)  edu2.college  edu2.postcol       race2.A       race2.B       race2.H     cigstop.0
		# -6.2691028825 -0.3337032735 -0.2753624716 -0.4574188546  0.2267924407 -0.0006870761  0.9052450602
		#  cigstop.0_20 cigstop.20_40  cigstop.gt40     pky.10_30     pky.30_60    pky.60_100     pky.gt100
		#  0.6883502038  0.3428068341  0.4280578676 -0.0253225158  0.5551064463  1.1028039156  1.4087509991
		#           age            fh
		#  0.0428911792  0.2036594893
		# > table(cigstop)
		# cigstop
		#     0  0_20 20_40  gt40 never  --> "never" means never smoker, "0" means didn't quit
		#  8581 18593 16806  1849 26867

		# 	> ref.cigstop
		#         never     cigstop.0  cigstop.0_20 cigstop.20_40  cigstop.gt40
		#       0.52135       0.17899       0.15378       0.13326       0.01262

		ave.cigstop = sum(ref.cigstop[-c(1,4,5)]*mycoef[c("cigstop.0", "cigstop.0_20")]); ave.cigstop  # just zero term for the rest
		# > ref.cigstop[-1]
		#     cigstop.0  cigstop.0_20 cigstop.20_40  cigstop.gt40
		#          0.33          0.20          0.10          0.00
		# > mycoef[c("cigstop.0", "cigstop.0_20", "cigstop.20_40", "cigstop.gt40")]
		#     cigstop.0  cigstop.0_20 cigstop.20_40  cigstop.gt40
		#     0.9052451     0.6883502     0.3428068     0.4280579

		### average over pack-years #
		# > ref.pky  # from 1950 cohort
		#  lst10  10_30  30_60 60_100  gt100
		#   0.51   0.21   0.21   0.07   0.00

		tt1=ref.pky[-1];  tt1  # exclude reference
		tt2=mycoef[paste("pky.", names(ref.pky[-1]),sep="")]  ; tt2
		# > tt1
		#  10_30  30_60 60_100  gt100
		#   0.21   0.21   0.07   0.00
		# > tt2
		#   pky.10_30   pky.30_60  pky.60_100   pky.gt100
		# -0.02532252  0.55510645  1.10280392  1.40875100

		ave.pky = sum(tt1*tt2); ave.pky
		#[1] 0.1195359
		#[1] 0.188923

		## average over family history of lung cancer ##
		# > (ref.fh/100)
		# [1] 0.109

		ave.fh = sum( (ref.fh/100)*mycoef["fh"]); ave.fh  # just zero term for the rest
		#[1] 0.02

		#### sum it up ##

		ave.eff.before = as.numeric( base0 + ave.edu + ave.race + ave.cigstop + ave.pky + ave.fh) ; ave.eff.before
		ave.eff.prob.before = inv.logit(ave.eff.before); ave.eff.prob.before  # 0.09537217
		#[1] 0.06110366

		#### (manually done) Adjustment needed #########################

		#ref.copd
		#[1] 0.074

		incr = 0.21   ### this is for Gender="M"

		ave.eff = as.numeric((base0 + incr)  + ave.edu + ave.race + ave.cigstop + ave.pky + ave.fh) ; ave.eff

		ave.eff.prob = inv.logit(ave.eff); ave.eff.prob  # 0.09537217
		#[1] 0.074

		#### update the fitted model ###
		mycoef.adj = mycoef
		# > mycoef.adj[1]
		# (Intercept)
		#   -2.304702
		mycoef.adj[1] = mycoef.adj[1]+incr  ; mycoef.adj
			# > mycoef
			#   (Intercept)  edu2.college  edu2.postcol       race2.A       race2.B       race2.H     cigstop.0
			# -6.2691028825 -0.3337032735 -0.2753624716 -0.4574188546  0.2267924407 -0.0006870761  0.9052450602
			#  cigstop.0_20 cigstop.20_40  cigstop.gt40     pky.10_30     pky.30_60    pky.60_100     pky.gt100
			#  0.6883502038  0.3428068341  0.4280578676 -0.0253225158  0.5551064463  1.1028039156  1.4087509991
			#           age            fh
			#  0.0428911792  0.2036594893
			# > mycoef.adj
			#   (Intercept)  edu2.college  edu2.postcol       race2.A       race2.B       race2.H     cigstop.0
			# -5.6491028825 -0.3337032735 -0.2753624716 -0.4574188546  0.2267924407 -0.0006870761  0.9052450602
			#  cigstop.0_20 cigstop.20_40  cigstop.gt40     pky.10_30     pky.30_60    pky.60_100     pky.gt100
			#  0.6883502038  0.3428068341  0.4280578676 -0.0253225158  0.5551064463  1.1028039156  1.4087509991
			#           age            fh
			#  0.0428911792  0.2036594893



 }#end of F

		######### plotting barplot ##########
		tb1=c(ave.eff.prob.before, ref.copd); names(tt)=c("Non-adjusted","Ref")
		tb2=c(ave.eff.prob, ref.copd); names(tt)=c("Adjusted","Ref")

			TAB=tb1
			barplot(TAB,col=(heat.colors(3)),ylim=c(0,0.15),main="[Unadjusted] COPD Prevalence",cex.axis=1.5,cex.lab=2,cex.main=1.5)
			text(1:length(TAB),TAB+0.02,round(TAB,3),cex=2,col="blue")
			axis(1, at=c(0.75,2), labels=c("Unadjusted", " Ref"),cex.axis=1.5)


			TAB=tb2
			barplot(TAB,col=(heat.colors(3)),ylim=c(0,0.15),main="[Adjusted] COPD Prevalence",cex.axis=1.5,cex.lab=2,cex.main=1.5)
			text(1:length(TAB),TAB+0.02,round(TAB,3),cex=2,col="blue")
			axis(1, at=c(0.75,2), labels=c("Adjusted", " Ref"),cex.axis=1.5)


	 		ANS = list(mycoef.adj=mycoef.adj, increment= incr, mycoef.before = mycoef, glm.copd = glm.copd, glm.or= glm.or,  prev.copd.adj = ave.eff.prob, prev.copd.unadj = ave.eff.prob.before, ref.copd = ref.copd)
			ANS



}#end of myCOPD.cond







		######### 7/9/2019 update for ERIC to implement in the R package
		######### 5/8/2016 1960 extension #######
	######### 4/6/2016: 2nd version: nonlinear effect for BMI, personal history included ########

riskFactorGenerator3_EC=function(DAT, CIGDAT, Gender, cohort, PROB.edu.race, OUT.bmi, OUT.fh, OUT.ph, OUT.copd,        myseed) {


			###### 7/9/2019 ERIC, please move the steps for createSmokingHistories() here reformatSHG() ############
			## use indicator if the column names of the input data includes "PY." (output variable ofcreateSmokingHistories)
				# or "cigstat." (output variable of reformatSHG()
			## if the input data somehow already includes these variables, skip this process step



			###############################################################################################
			set.seed(myseed)

			####### reading reference data ###

			if(cohort==1960){

					######## data obtained from Pianpian's search ###################################

					#> round(c(0.70, 0.12, 0.12, 0.04)/(sum(c(0.70, 0.12, 0.12, 0.04))),2)
					#[1] 0.71 0.12 0.12 0.04
					ref.race=c(0.72, 0.12, 0.12, 0.04); names(ref.race)=c("W","B","H","A") ## info at 05_note_fit.models.PLCO2.ppt
					#   W    B    H    A
					#0.72 0.12 0.12 0.04

					ref.edu = c(0.40, 0.48, 0.12); names(ref.edu)=c("high","college","postcol")
					#   high college postcol
					#   0.40    0.48    0.12

					ref.fh = 10.56  # 10.9% for age = 55 for 1960 birth cohort
					ref.fh.ci = c(7.6, 13.5)

					#ref.ph = 8.3
					#ref.ph.ci =  c(8, 8.5) # from McClure ---> age = 55

					### exclude LC and skin cancer ### LC is 13% of all cancer and skin is similar
						# > 8.3*(1-2*0.13)
						# [1] 6.142

					ref.ph = 9.20    ####### at age 55
					ref.ph.ci = c(6.62, 11.78)
					ref.copd = 6.9
					ref.copd.ci = c(4.42, 9.38)


					if(Gender=="F"){

							###### make ref.smk, CPD.50.mean, cigyears50.mean, ref.pky.mean.55, ref.cigyear.mean.55, ref.cpd.mean.55, ref.cigstop,ref.bmi.mean.55

							ref.smk = c(0.51357, 0.30558, 0.180852) ;names(ref.smk)=c("Never","Former","Current")  ## increased in 1960 vs. 1950
									#ref.smk = c(0.52135, 0.30737,0.17128 ); names(ref.smk)=c("Never","Former","Current") # 1950

							### from Pianpian ###
							ref.bmi = c(32.3, 34.6, 33.08); names(ref.bmi)=c("W","B","H") # 1960 their average BMI at age = 50 from Pianpian : Data_bc4060.pdf###
							ref.bmi.sd = c(0.4, 0.5, 0.5) ; names(ref.bmi.sd)=c("W","B","H")




					}# end of gener==F


					if(Gender=="M"){

							#### this is smoking status distributuion in the 1960 population (smoking history generator)###
							ref.smk = c(0.48575, 0.32186, 0.19239) ;names(ref.smk)=c("Never","Former","Current") # decreased
								#ref.smk = c(0.37, 0.40, 0.23); names(ref.smk)=c("Never","Former","Current") 1950 cohort male

							### from Pianpian ###
							ref.bmi = c(29.96, 32.02, 26.97); names(ref.bmi)=c("W","B","H") # 1960 their average BMI at age = 50 from Pianpian : Data_bc4060.pdf###
							ref.bmi.sd = c(0.4, 0.5, 0.5) ; names(ref.bmi.sd)=c("W","B","H")


					}# if(Gender=="M"){

			}# cohort==1960


			if(cohort==1950){


					### reference distribution of each variable obtained from literature (1950 cohort) or smoking history generator (smoking related variables)

					ref.race=c(0.76, 0.10, 0.08, 0.05); names(ref.race)=c("W","B","H","A") ## info at 05_note_fit.models.PLCO2.ppt
							## from reference (1950 cohort)
							#  W    B     H    A
							# 0.76 0.10 0.08 0.05
					ref.edu = c(0.78, 0.15, 0.07); names(ref.edu)=c("high","college","postcol")
							### from reference (1950 cohort)
							#      high   college   postcol
							#      0.78     0.15    0.07
					ref.fh = 10.9  # 10.9% for age = 55 for 1950 birth cohort
					ref.fh.ci=c(9.74, 11.90)

					ref.ph = 6.14    ####### at age 55 from McClure ---> age = 55
					ref.ph.ci = c(5.9, 6.4)

					 ref.copd = 7.4
					 ref.copd.ci = c(7.2, 7.6)


					if(Gender=="F"){


						#### this is smoking status distributuion in the 1950 population (smoking history generator) ###
						#### this is for plotting comparison plots #####
						ref.smk = c(0.52135, 0.30737,0.17128 ); names(ref.smk)=c("Never","Former","Current")
						#ref.pky = c(0.66752 ,0.16092, 0.12864, 0.04292,0);names(ref.pky)=c("lst10", "10_30","30_60","60_100","gt100" )
						ref.cigstop = c(0.52135, 0.17899, 0.15378, 0.13326, 0.01262);names(ref.cigstop)=c("never","cigstop.0", "cigstop.0_20", "cigstop.20_40",  "cigstop.gt40")
						ref.bmi = c(28.3, 32.1, 30.4); names(ref.bmi)=c("W","B","H") # their average BMI at age = 50 "--Ogden et al. 2004"
            ref.bmi.sd = c(0.4, 0.5, 0.5) ; names(ref.bmi.sd)=c("W","B","H") # Eric added 7/22/2019
            # [1] 11.42
						ref.pky.mean.55 = 11.8

						#summary(dat.f[,"PY.55"])
						#  Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
						#    0.0     0.0     0.0    11.8    19.5   135.0
						#>


					}# end of gener==F


					if(Gender=="M"){

							#### this is smoking status distributuion in the 1950 population (smoking history generator) ###
							ref.smk = c(0.37, 0.40, 0.23); names(ref.smk)=c("Never","Former","Current")
							#ref.pky = c(0.51, 0.21, 0.21, 0.07, 0); names(ref.pky)=c("lst10","10_30","30_60","60_100","gt100")# ref.pky  # from smoking history generator
							ref.cigstop = c(0.37, 0.24, 0.19, 0.18, 0.02)  ; names(ref.cigstop)=c("never","cigstop.0", "cigstop.0_20", "cigstop.20_40",  "cigstop.gt40") #### reference (age=60 to be used for COPD calibration)
							ref.bmi = c(28.7, 27.7, 28.9); names(ref.bmi)=c("W","B","H") # their average BMI at age = 50 "--Ogden et al. 2004"
              ref.bmi.sd = c(0.3, 0.4, 0.3) ; names(ref.bmi.sd)=c("W","B","H") # Eric added 7/22/2019
							ref.pky.mean.55 = 17.61

								# > summary(dat.m[,"PY.55"])
								#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
								#   0.000   0.000   9.125  17.610  29.820  84.850


					}# if(Gender=="M"){

			}# cohort==1950



			N = nrow(DAT)
			AGES.bmi = AGES.copd = 45:100
			ages=45:90

			### other cause of mortality ##
			age.OCM = DAT[,"age_death_OC"]
			# > age.OCM[1:20]
			#  [1]   77   87   67   89   82   29   36 -999   56   78   87   94   83   81   51   53   84   76   62
			# [20]   91
			# > max(age.OCM)
			# [1] 99

			############## [1] From smoking history generator: decide smoking status at age: 60 (PLCO mean age) #####

			age_init = age_cess = smkstatus = pky = cigstop = NULL

			age.th = 60  # PLCO average age is 62

			age_init = DAT[,"age_init"]
			age_cess = DAT[,"age_cess"]

			## make smoking indicator for making "smkstatus" ##

			indic.current = age_init > 0 & (age_cess > age.th  | age_cess==-999) # started smoking, but quit after 60 or never quit
			sum(indic.current)/length(indic.current)
			#[1] 0.23275  # male

			indic.former = age_init > 0 & (age_cess <= age.th &  age_cess!=999) # started smoking, but quit before 60, and quit)
			sum(indic.former)/length(indic.former)
			#[1]  0.41673

			indic.never = age_init==-999
			sum(indic.never)/length(indic.never)
			#[1] 0.36609

			### smkstatus making (not so important later ignore this) ###
			smkstatus = rep(NA,nrow(DAT))
			smkstatus[indic.never]="Never"
			smkstatus[indic.former]="Former"
			smkstatus[indic.current]="Current"

			### obtain smoking status distribution ###

			TB.smk=table(smkstatus)/sum(table(smkstatus))
			TB.smk
			# current  former   never    MALE
			# 0.23275 0.40116 0.36609

			# smkstatus
			# Current  Former   Never    FEMALE
			# 0.17128 0.30737 0.52135


			#### obtain pack-years distribution ###

			pky0= DAT[, "PY.60"]
			#  [1]  0.000000  0.000000 41.969919 41.319490 33.452900  0.000000 43.645535  0.000000  0.107161
			# [10] 49.321486
			# > sum(is.na(pky0))
			# [1] 0

			### make category as used in model fitting ###
			pky=pky0
			pky[pky0 <=10] = "lst10"
			pky[pky0 > 10 & pky0<=30] ="10_30"
			pky[pky0 > 30 & pky0 <=60] = "30_60"
			pky[pky0 > 60 & pky0 <=100] = "60_100"
			pky[pky0>100]="gt100"

			TB.pky=table(pky)/length(pky); TB.pky
			# pky
			#   10_30   30_60  60_100   lst10    MALE
			# 0.21110 0.21102 0.06682 0.51106
			# pky
			#   10_30   30_60  60_100   lst10    FEMALE
			# 0.16092 0.12864 0.04292  0.66752


			### obtain year since quit reference distribution (needed for ##

			ysq0 = DAT[, "YSQ.60"]
			# > ysq0[1:10]
			#  [1] NA NA NA NA NA NA 11 NA 33 NA  ---> NA includes never smokers & those who NEVER QUIT smoking
			# > range(ysq0,na.rm=T)
			# [1]  1 35

			cigstop=ysq0
			cigstop[is.na(ysq0)==T  & smkstatus=="Never" ]="never"   # never smoker
			cigstop[is.na(ysq0)==T  & smkstatus!="Never"] = "0"   # those who are smokers but who didn't quit!
			cigstop[ysq0>0 & ysq0 <=20] = "0_20"
			cigstop[ysq0 >20 & ysq0<=40] = "20_40"
			cigstop[ysq0 >40 ] = "gt40"

			TB.cigstop = table(cigstop)/sum(table(cigstop)); TB.cigstop
			# cigstop
			#       0    0_20   20_40   never
			# 0.33119 0.20399 0.09873 0.36609    MALE
			# smkstatus
			# Current  Former   Never
			# 0.23275 0.40116 0.36609

			# cigstop
			#       0    0_20   20_40    gt40   never
			# 0.17899 0.15378 0.13326 0.01262 0.52135   FEMALE



			####### Time-varying smoking status variable ("Never", "Former", "Current")################
			### the plan is to use PY.60 and YSQ.60 for determning smoking status at age
			### if PY=0 never smoker. if PY > 0 and YSQ = integer, former smoker, if PY>0 and YSQ = NA, current smokers

			cpdDAT= smkDAT = NULL

			# > colnames(CIGDAT)
			#   [1] "cigday.45"   "cigyears.45" "cigstat.45"  "cigday.46"   "cigyears.46" "cigstat.46"  "cigday.47"   "cigyears.47"
			#   [9] "cigstat.47"  "cigday.48"   "cigyears.48" "cigstat.48"  "cigday.49"   "cigyears.49" "cigstat.49"  "cigday.50"
			#  [17] "cigyears.50" "cigstat.50"  "cigday.51"   "cigyears.51" "cigstat.51"  "cigday.52"   "cigyears.52" "cigstat.52"
			#  [25] "cigday.53"   "cigyears.53" "cigstat.53"  "cigday.54"   "cigyears.54" "cigstat.54"  "cigday.55"   "cigyears.55"
			#  [33] "cigstat.55"  "cigday.56"   "cigyears.56" "cigstat.56"  "cigday.57"   "cigyears.57" "cigstat.57"  "cigday.58"
			#  [41] "cigyears.58" "cigstat.58"  "cigday.59"   "cigyears.59" "cigstat.59"  "cigday.60"   "cigyears.60" "cigstat.60"
			#  [49] "cigday.61"   "cigyears.61" "cigstat.61"  "cigday.62"   "cigyears.62" "cigstat.62"  "cigday.63"   "cigyears.63"
			#  [57] "cigstat.63"  "cigday.64"   "cigyears.64" "cigstat.64"  "cigday.65"   "cigyears.65" "cigstat.65"  "cigday.66"
			#  [65] "cigyears.66" "cigstat.66"  "cigday.67"   "cigyears.67" "cigstat.67"  "cigday.68"   "cigyears.68" "cigstat.68"
			#  [73] "cigday.69"   "cigyears.69" "cigstat.69"  "cigday.70"   "cigyears.70" "cigstat.70"  "cigday.71"   "cigyears.71"
			#  [81] "cigstat.71"  "cigday.72"   "cigyears.72" "cigstat.72"  "cigday.73"   "cigyears.73" "cigstat.73"  "cigday.74"
			#  [89] "cigyears.74" "cigstat.74"  "cigday.75"   "cigyears.75" "cigstat.75"  "cigday.76"   "cigyears.76" "cigstat.76"
			#  [97] "cigday.77"   "cigyears.77" "cigstat.77"  "cigday.78"   "cigyears.78" "cigstat.78"  "cigday.79"   "cigyears.79"
			# [105] "cigstat.79"  "cigday.80"   "cigyears.80" "cigstat.80"  "cigday.81"   "cigyears.81" "cigstat.81"  "cigday.82"
			# [113] "cigyears.82" "cigstat.82"  "cigday.83"   "cigyears.83" "cigstat.83"  "cigday.84"   "cigyears.84" "cigstat.84"
			# [121] "cigday.85"   "cigyears.85" "cigstat.85"  "cigday.86"   "cigyears.86" "cigstat.86"  "cigday.87"   "cigyears.87"
			# [129] "cigstat.87"  "cigday.88"   "cigyears.88" "cigstat.88"  "cigday.89"   "cigyears.89" "cigstat.89"  "cigday.90"
			# [137] "cigyears.90" "cigstat.90"

			#### cig/day ###

			cpdDAT = CIGDAT[, paste("cigday",ages,sep=".")]
			# > cpdDAT[1:5,]
			#   cigday.45 cigday.46 cigday.47 cigday.48 cigday.49 cigday.50 cigday.51 cigday.52 cigday.53 cigday.54 cigday.55 cigday.56
			# 1   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
			# 2   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
			# 3  19.44004  19.32940  19.21875  19.10811  18.99746  18.88682  18.77617  18.66553  18.55488  18.44424  18.33359  18.22295
			# 4  19.44004  19.32940  19.21875  19.10811  18.99746  18.88682  18.77617  18.66553  18.55488  18.44424  18.33359  18.22295
			# 5  14.13879  13.88324  13.62769  13.37215  13.11660  12.86105  12.60550  12.34995  12.09440  11.83885  11.58330  11.32775

			colnames(cpdDAT) = paste("CPD",ages,sep=".")
			# > cpdDAT[1:3,]
			#     CPD.45  CPD.46   CPD.47   CPD.48   CPD.49   CPD.50   CPD.51   CPD.52   CPD.53   CPD.54   CPD.55   CPD.56  CPD.57
			# 1  0.00000  0.0000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.0000
			# 2  0.00000  0.0000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.0000
			# 3 19.44004 19.3294 19.21875 19.10811 18.99746 18.88682 18.77617 18.66553 18.55488 18.44424 18.33359 18.22295 18.1123


			#####  smking status ###

			smkDAT = CIGDAT[, paste("cigstat",ages,sep=".")]
			colnames(smkDAT) = paste("STAT",ages,sep=".")


			##### duration

			durDAT = CIGDAT[, paste("cigyears",ages,sep=".")]
			colnames(durDAT) = paste("DUR",ages,sep=".")



			# > apply(cpdDAT,2,mean)
			#    CPD.45    CPD.46    CPD.47    CPD.48    CPD.49    CPD.50    CPD.51    CPD.52    CPD.53    CPD.54    CPD.55    CPD.56
			# 7.5922353 7.3062705 7.0310721 6.7718705 6.5106941 6.2572710 6.0100960 5.7665547 5.5330708 5.3115650 5.0882541 4.8562935
			#    CPD.57    CPD.58    CPD.59    CPD.60    CPD.61    CPD.62    CPD.63    CPD.64    CPD.65    CPD.66    CPD.67    CPD.68
			# 4.6522870 4.4429827 4.2278071 4.0311627 3.8400750 3.6536040 3.4815768 3.2996842 3.1215587 2.9437294 2.7838964 2.6318721
			#    CPD.69    CPD.70    CPD.71    CPD.72    CPD.73    CPD.74    CPD.75    CPD.76    CPD.77    CPD.78    CPD.79    CPD.80
			# 2.4839936 2.3390477 2.2024739 2.0713340 1.9406032 1.8129006 1.6947242 1.6115403 1.5248580 1.4385521 1.3636188 1.2854213
			#    CPD.81    CPD.82    CPD.83    CPD.84    CPD.85    CPD.86    CPD.87    CPD.88    CPD.89    CPD.90
			# 1.2138764 1.1410440 1.0840038 1.0121003 0.9596245 0.8832636 0.8185037 0.7476369 0.6909738 0.6301528
			# > dim(cpdDAT)
			# [1] 100000     46

			# > ref.cpd.mean.55
			# [1] 5.088254



			## plan is to define smoking status at each age based on CPDXX (age 80, CPD89 value and age_init
			## if NA, currently non-smokers, but if age_init is not NA, former smokers

				# > DAT[,"CPD80"][1:10]
				#  [1]      NA      NA 16.1207      NA      NA      NA      NA      NA      NA      NA
				# > DAT[,"age_init"][1:10]
				#  [1] -999 -999   15   16   12 -999   17 -999   17   19


			# > colnames(DAT)
			#   [1] "X"            "race"         "gend"         "birth_yr"     "age_init"     "age_cess"     "age_death_OC"
			#   [8] "quintile"     "age_smoke1"   "CPD1"         "age_smoke2"   "CPD2"         "age_smoke3"   "CPD3"
			#  [99] "age_smoke46"  "CPD46"        "age_smoke47"  "CPD47"        "age_smoke48"  "CPD48"        "age_smoke49"
			# [106] "CPD49"        "age_smoke50"  "CPD50"        "age_smoke51"  "CPD51"        "age_smoke52"  "CPD52"
			# [113] "age_smoke53"  "CPD53"        "age_smoke54"  "CPD54"        "age_smoke55"  "CPD55"        "age_smoke56"
			# [120] "CPD56"        "age_smoke57"  "CPD57"        "age_smoke58"  "CPD58"        "age_smoke59"  "CPD59"
			# [127] "age_smoke60"  "CPD60"        "age_smoke61"  "CPD61"        "age_smoke62"  "CPD62"        "age_smoke63"
			# [134] "CPD63"        "age_smoke64"  "CPD64"        "age_smoke65"  "CPD65"        "age_smoke66"  "CPD66"
			# [141] "age_smoke67"  "CPD67"        "age_smoke68"  "CPD68"        "age_smoke69"  "CPD69"        "age_smoke70"
			# [148] "CPD70"        "age_smoke71"  "CPD71"        "age_smoke72"  "CPD72"        "age_smoke73"  "CPD73"
			# [155] "age_smoke74"  "CPD74"        "age_smoke75"  "CPD75"        "age_smoke76"  "CPD76"        "age_smoke77"
			# [162] "CPD77"        "age_smoke78"  "CPD78"        "age_smoke79"  "CPD79"        "age_smoke80"  "CPD80"
			# [169] "age_smoke81"  "CPD81"        "age_smoke82"  "CPD82"        "age_smoke83"  "CPD83"        "age_smoke84"
			# [176] "CPD84"        "age_smoke85"  "CPD85"        "age_smoke86"  "CPD86"        "age_smoke87"  "CPD87"
			# [183] "age_smoke88"  "CPD88"        "age_smoke89"  "CPD89"        "age_smoke90"  "CPD90"        "age_smoke91"
			# [190] "CPD91"        "age_smoke92"  "CPD92"        "age_smoke93"  "CPD93"        "age_smoke94"  "CPD94"
			# [281] "PY.73"        "PY.74"        "PY.75"        "PY.76"        "PY.77"        "PY.78"        "PY.79"
			# [288] "PY.80"        "PY.81"        "PY.82"        "PY.83"        "PY.84"        "PY.85"        "PY.86"
			# [295] "PY.87"        "PY.88"        "PY.89"        "PY.90"        "PY.91"        "PY.92"        "PY.93"
			# [302] "PY.94"        "PY.95"        "PY.96"        "PY.97"        "PY.98"        "PY.99"        "PY.100"


			############## [2] Assign education and race conditioning on smoking status: using Pr(edu, race | smoking status) ###################

		cat("Simulating education and race conditioning on smoking\n", sep="")

			edu.race0 = NULL

			# > PROB.edu.race  --> each column sums up to 1  (new)
			#                 Never      Former     Current
			# A-<=high  0.029740186 0.027025603 0.021492433
			# A-college 0.016958076 0.010772834 0.006650130
			# A-postcol 0.018568620 0.008734730 0.003439723
			# B-<=high  0.061486197 0.075818739 0.156613420
			# B-college 0.005305320 0.004425597 0.008026019
			# B-postcol 0.008431669 0.006230774 0.005962186
			# H-<=high  0.063572804 0.073064503 0.087410678
			# H-college 0.003505301 0.004309134 0.001605204
			# H-postcol 0.005305320 0.002969808 0.001834519
			# W-college 0.164543619 0.122896853 0.082930591
			# W-postcol 0.073103314 0.037704173 0.023918168
			# W-<=high  0.549479573 0.626047250 0.600116929
			# > colSums(PROB.edu.race)
			#   Never  Former Current
			#       1       1       1

			# > PROB.edu.race  --> each column sums up to 1
			#                 Never      Former     Current
			# A-<=high  0.018566097 0.014800494 0.011702345
			# A-college 0.029658838 0.016959562 0.011278914
			# A-postcol 0.033799932 0.013370632 0.006149116
			# B-<=high  0.070439032 0.071277125 0.149026204
			# B-college 0.011267360 0.006635478 0.012977099
			# B-postcol 0.015566571 0.008859252 0.007674597
			# H-<=high  0.056075187 0.054224294 0.072637778
			# H-college 0.007104640 0.006208510 0.002314815
			# H-postcol 0.009016896 0.004782629 0.003468208
			# W-college 0.157620308 0.109228065 0.081830842
			# W-postcol 0.058473874 0.027350069 0.016765308
			# W-<=high  0.532411267 0.666303888 0.624174774

			smknames=colnames(PROB.edu.race) #[1] "Never"   "Former"  "Current"
			edu.race0 = rep("",length(smknames))
			myout.edu.race = rep(list(list()),3);names(myout.edu.race)=smknames


			#set.seed(123)

			### for each smoking status, simulate edu-race variables ####################
			for(j in 1:length(smknames)){

				smkname=smknames[j] #[1] "Never"
				indic = (smkstatus==smkname) # [1]  TRUE  TRUE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE


				## number of never smokers

				nn=sum(indic);nn #[1] 36609

				## pull out estimated distribution ##
				mydist= PROB.edu.race[,smkname]; names(mydist)=row.names(PROB.edu.race); mydist
				#    A-<=high   A-college   A-postcol    B-<=high   B-college   B-postcol    H-<=high   H-college
				# 0.018566097 0.029658838 0.033799932 0.070439032 0.011267360 0.015566571 0.056075187 0.007104640
				#   H-postcol   W-college   W-postcol    W-<=high
				# 0.009016896 0.157620308 0.058473874 0.532411267
				# > sum(mydist)
				# [1] 1

				### sample 36609 individuals given distribution ###

				prob=mydist
				### sample ##
				smp=sample(names(prob), size=nn, replace = T, prob = prob) #[1] "W-postcol" "W-<=high"  "W-<=high"  "W-college" "W-postcol" "A-<=high"

				### put them in a vector ##
				edu.race0[indic] = smp

				### compare it to original distribution #
				tt=table(smp)/length(smp)
				tt1=cbind(mydist, tt[names(mydist)]); colnames(tt1) = c("original","simulated")

				#print(tt1)
				#                mydist
				# A-<=high  0.018566097 0.018465405
				# A-college 0.029658838 0.029145838
				# A-postcol 0.033799932 0.034636292
				# B-<=high  0.070439032 0.070474473
				# B-college 0.011267360 0.010926275
				# B-postcol 0.015566571 0.016307465
				# H-<=high  0.056075187 0.057663416
				# H-college 0.007104640 0.007293289
				# H-postcol 0.009016896 0.008604442
				# W-college 0.157620308 0.158594881
				# W-postcol 0.058473874 0.059712093
				# W-<=high  0.532411267 0.528176132

				myout.edu.race[[j]] = tt1


			}#end of for(j in 1:length(smknames)){
			names(myout.edu.race)=smknames

			myout.edu.race
			# $Never
			#              original   simulated
			# A-<=high  0.018566097 0.018356142
			# A-college 0.029658838 0.028244421
			# A-postcol 0.033799932 0.032560299
			# B-<=high  0.070439032 0.071348575
			# B-college 0.011267360 0.010844328
			# B-postcol 0.015566571 0.015296785
			# H-<=high  0.056075187 0.056324947
			# H-college 0.007104640 0.006610396
			# H-postcol 0.009016896 0.009014177
			# W-college 0.157620308 0.156163785
			# W-postcol 0.058473874 0.057117102
			# W-<=high  0.532411267 0.538119042
			#
			# $Former
			#              original   simulated
			# A-<=high  0.014800494 0.015031409
			# A-college 0.016959562 0.017399541
			# A-postcol 0.013370632 0.012937481
			# B-<=high  0.071277125 0.071667165
			# B-college 0.006635478 0.006381494
			# B-postcol 0.008859252 0.007752518
			# H-<=high  0.054224294 0.056062419
			# H-college 0.006208510 0.006182072
			# H-postcol 0.004782629 0.004038289
			# W-college 0.109228065 0.109208296
			# W-postcol 0.027350069 0.027121348
			# W-<=high  0.666303888 0.666217968


			######### breaking into education and race ####################

			tt1=unlist(strsplit(edu.race0,split="\\-")) # [1] "W"       "<=high"  "B"       "<=high"  "W"       "<=high"  "A"       "postcol" "W"
			race=tt1[seq(1,length(tt1),by=2)]
			educ=tt1[seq(2,length(tt1),by=2)]

			TB.race = table(race)/sum(table(race))
			TB.race
			# race
			#       A       B       H       W
			# 0.04015 0.05039 0.02170 0.88776
			TB.edu = table(educ)/sum(table(educ))
			TB.edu
			# educ
			#  <=high college postcol
			# 0.60296 0.18542 0.21162
			## remove "<="
			names(TB.edu) = gsub("<=","",names(TB.edu))
		#educ = gsub("<=","", educ)


			####### plot comparing references vs. simulated ###

			TAB=TB.race[names(ref.race)]
			TB.race2=TB.race[names(ref.race)]
			barplot(TAB,col=(heat.colors(4)),ylim=c(0,1),main="[Simulated] Race Distribution",cex.axis=1.5,cex.lab=2,cex.main=1.5)
			text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")
			#axis(1, at=c(0.75,2), labels=c("Unadjusted", " Ref"),cex.axis=1.5)

			TAB=ref.race
			barplot(TAB,col=(heat.colors(4)),ylim=c(0,1),main="[Ref] Race Distribution",cex.axis=1.5,cex.lab=2,cex.main=1.5)
			text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")

			TAB=TB.edu[names(ref.edu)]
			TB.edu2=TB.edu[names(ref.edu)]
			barplot(TAB,col=(heat.colors(3)),ylim=c(0,1),main="[Simulated] Education Distribution",cex.axis=1.5,cex.lab=2,cex.main=1.5)
			text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")
			#axis(1, at=c(0.75,2), labels=c("Unadjusted", " Ref"),cex.axis=1.5)

			TAB=ref.edu
			barplot(TAB,col=(heat.colors(4)),ylim=c(0,1),main="[Ref] Education Distribution",cex.axis=1.5,cex.lab=2,cex.main=1.5)
			text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")


			########### Confidenece Interval. Estimated N = 1.8 mil for male and N=1.7 for women (ref: 1950_birthCohort_data_census_vsus_1950_1.pdf Table 6.06 ####

			############ CI for Race ###############

			ci.race= myCI_proportion(probs=TB.race2, n=10000)
			#     probs        ci1        ci2
			# W 0.76979 0.76153904 0.77804096
			# B 0.10133 0.09541540 0.10724460
			# H 0.07967 0.07436268 0.08497732
			# A 0.04921 0.04497040 0.05344960

			N.male = 1.7 * 10^6   #1.7 million
			### confidence interval for multinomial proportion ###

			ci.race2 = myCI_proportion(probs=ref.race, n=N.male)
			#   probs        ci1        ci2
			# W  0.76 0.75935799 0.76064201
			# B  0.10 0.09954902 0.10045098
			# H  0.08 0.07959218 0.08040782
			# A  0.05 0.04967237 0.05032763

			table(race)[names(ref.race)]
			#chisq.test(TB.race2,)


			####################### CI for education ################

			############ Education ###############
			cis=myCI_proportion(probs=TB.edu2, n=10000)
			#          probs       ci1       ci2
			# high    0.78115 0.7730461 0.7892539
			# college 0.14985 0.1428543 0.1568457
			# postcol 0.06900 0.0640323 0.0739677

			#### CI for actual census data is way to narrow
			cisb = myCI_proportion(probs=ref.edu, n=N.male)
			#         probs        ci1        ci2
			# high     0.78 0.77937728 0.78062272
			# college  0.15 0.14946323 0.15053677
			# postcol  0.07 0.06961645 0.07038355


			############# education comparing simulation vs. reference with CI from simulation ##########

		   par(mar=c(5,5,6,3))

		   mat=cbind(ref.edu, TB.edu2)
		   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="Relative Frequency",cex.main=1.5, ylim=c(0,1),main="[Education] Observed vs. simulated distribution")
		   #main="[Before Adjustment] \nAverage BMI (age 50) by race", )

			ci1 = cis[,2]
			ci2= cis[,3]

		   ##### confidence interval ###
		   #xs = c(1.5,4.5,7.5) + 1

		   #for(u in 1:length(xs)){

		   #lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
		   #lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
		   #lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

		   #}#end of

		  legend(x="topright", legend=c("Reference", "Simulated"), fill=c("red","yellow"), ncol=2,cex=1.5)


			ttt=prop.test(cbind(ref.edu*N.male, TB.edu*10000))
			#
			# 	3-sample test for equality of proportions without continuity correction
			#
			# data:  cbind(ref.edu * N.male, TB.edu * 10000)
			# X-squared = 0.26251, df = 2, p-value = 0.877
			# alternative hypothesis: two.sided
			# sample estimates:
			#    prop 1    prop 2    prop 3
			# 0.9941441 0.9942179 0.9940997
			title(sub=paste("X-squared=",round(ttt$statistic,2), " (p=", round(ttt$p.value,2),")",sep=""))

			############# Race comparing simulation vs. reference with CI from simulation ##########
	   	    mat=cbind(ref.race, TB.race2)
		   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5, main="[Race] Observed vs. simulated distribution",
		   ylab="Relative Frequency",cex.main=1.5, ylim=c(0,1))
		   #main="[Before Adjustment] \nAverage BMI (age 50) by race", )

			#			ci1 = ci.race[,2]
			#			ci2= ci.race[,3]
			#
			#		   ##### confidence interval ###
			#		   xs = c(1.5,4.5,7.5,10.5) + 1
			#
			#		   for(u in 1:length(xs)){
			#
			#
			#		   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
			#		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
			#		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)
			#
			#		   }#end of

		  legend(x="topright", legend=c("Reference", "Simulated"), fill=c("red","yellow"), ncol=2,cex=1.5)

			ttt=prop.test(cbind(ref.race*N.male, TB.race2*10000))
			title(sub=paste("X-squared=",round(ttt$statistic,2), " (p=", round(ttt$p.value,2),")",sep=""))



			###### [3] Simulating BMI (over time) given smoking, age, education and race ##################################

	cat("Simulating BMI over age\n", sep="")

			### unadjusted (uncalibrated) coefficient

			lm.bmi = OUT.bmi$lm.bmi.original   # it can only predict based on lm object so i need to use original

			#if(Gender=="M") lm.bmi = OUT.bmi$lm.bmi.original
			#if(Gender=="F") lm.bmi = OUT.bmi$lm.bmi.coef.adj


			coef.bmi = coef(lm.bmi)
			# male
			#               (Intercept)                     raceA                     raceB                     raceH
			#             28.9430210153             -2.3216045642              0.9987353770             -0.2223563685
			#                educollege                edupostcol          ns(age, df = 4)1          ns(age, df = 4)2
			#             -0.8153890552             -1.2122167678             -0.9229637970             -1.4930552984
			#          ns(age, df = 4)3          ns(age, df = 4)4            cigstatCurrent             cigstatFormer
			#             -2.2324605728             -1.9825806052             -2.8781227204             -1.0289679250
			#          ns(cigyears, 2)1          ns(cigyears, 2)2            ns(cigday, 2)1            ns(cigday, 2)2
			#              1.6678793783             -0.2269712463              2.5254022935              2.4036181396
			#      raceA:cigstatCurrent      raceB:cigstatCurrent      raceH:cigstatCurrent       raceA:cigstatFormer
			#              1.1998860137             -0.9159395155              0.3132705606              0.1416375325
			#       raceB:cigstatFormer       raceH:cigstatFormer educollege:cigstatCurrent edupostcol:cigstatCurrent
			#             -0.6851827071              0.1484768861              0.4139030273              0.8881625412
			#  educollege:cigstatFormer  edupostcol:cigstatFormer
			#              0.0002494663              0.2398837786


			###############  per person need to predict BMI overtime from age 45 to 90 ################
			 ##### what varies over time is age, cigstat, cigyears, cigday
			 ##### what remains the same is: race, education ##

			 ######### (1) OK make 45 design matrix from age=45 to 90 that includes everybody as rows ########
			 ## varies: age, cigday, cigyears, and cigstat ##


			data0= cbind(race=race, edu=educ)
			#   race  edu
			# 1    W high
			# 2    W high
			# 3    W high

			# > DAT[1:5,1:30]
			#   X race gend birth_yr age_init age_cess age_death_OC quintile age_smoke1     CPD1 age_smoke2     CPD2 age_smoke3      CPD3 age_smoke4      CPD4
			# 1 1    0    0     1950     -999     -999           77       NA         NA       NA         NA       NA         NA        NA         NA        NA
			# 2 2    0    0     1950     -999     -999           87       NA         NA       NA         NA       NA         NA        NA         NA        NA
			# 3 3    0    0     1950       15     -999           67        3         15 4.926697         16 9.061576         17 11.070479         18 12.651806
			# 4 4    0    0     1950       16       82           89        3         16 5.744068         17 9.856438         18 11.811208         19 13.341365
			# 5 5    0    0     1950       12       89           82        2         12 1.589957         13 5.278929         14  7.205635         15  8.745075
			#   age_smoke5     CPD5 age_smoke6     CPD6 age_smoke7     CPD7 age_smoke8     CPD8 age_smoke9     CPD9 age_smoke10    CPD10 age_smoke11    CPD11
			# 1         NA       NA         NA       NA         NA       NA         NA       NA         NA       NA          NA       NA          NA       NA
			# 2         NA       NA         NA       NA         NA       NA         NA       NA         NA       NA          NA       NA          NA       NA
			# 3         19 13.97756         20 15.11975         21 16.11867         22 17.00039         23 17.78339          24 18.48154          25 19.10569
			# 4         20 14.62065         21 15.72104         22 16.68238         23 17.53028         24 18.28275          25 18.95324          26 19.55221
			# 5         16 10.04348         17 11.16494         18 12.14670         19 13.01359         20 13.78360          21 14.47040          22 15.08480

			#ages=45:90

			#CIGDAT = myReformatSHGdat(ages,DAT)
			#ages=45:90
			#CIGDAT = myReformatSHGdat(ages,DAT)
			#setwd(work)
			#write.csv(CIGDAT, "Male_smoke100000_big_CIGDAT.csv")


			 ######### (2) Prediction of BMI for given age (per design matrix) looping #############################

			BMIdat = NULL

		#set.seed(1)

			for(j in 1:length(ages)){

				################ (a) design matrix
				#               (Intercept)                     raceA                     raceB                     raceH                educollege
				#             29.6665965407             -2.3216045642              0.3994941508             -0.2223563685             -0.8153890552
				#                edupostcol          ns(age, df = 4)1          ns(age, df = 4)2          ns(age, df = 4)3          ns(age, df = 4)4
				#             -1.2122167678             -0.9229637970             -1.4930552984             -2.2324605728             -1.9825806052
				#            cigstatCurrent             cigstatFormer          ns(cigyears, 2)1          ns(cigyears, 2)2            ns(cigday, 2)1
				#             -2.8781227204             -1.0289679250              1.6678793783             -0.2269712463              2.5254022935
				#            ns(cigday, 2)2      raceA:cigstatCurrent      raceB:cigstatCurrent      raceH:cigstatCurrent       raceA:cigstatFormer
				#              2.4036181396              1.1998860137             -0.9159395155              0.3132705606              0.1416375325
				#       raceB:cigstatFormer       raceH:cigstatFormer educollege:cigstatCurrent edupostcol:cigstatCurrent  educollege:cigstatFormer
				#             -0.6851827071              0.1484768861              0.4139030273              0.8881625412              0.0002494663
				#  edupostcol:cigstatFormer
				#              0.2398837786

				ag=ages[j]
				colname = paste(c("cigyears","cigday","cigstat"),rep(paste(".",ag,sep=""), 3),sep="")
				colname
				#[1] "cigyears.45" "cigday.45"    "cigstat.45"

				#### extract the cig data for the given age

				cigdat0 = CIGDAT[,colname]
				# > cigdat0[1:5,]
				#   cigyears.45 cigday.45 cigstat.45
				# 1           0   0.00000      Never
				# 2           0   0.00000      Never
				# 3          30  19.44004    Current
				# 4          29  19.44004    Current
				# 5          33  14.13879    Current

				## change name
				colnames(cigdat0) = c("cigyears","cigday","cigstat")
				# lm(formula = bmi ~ race + edu + ns(age, df = 4) + cigstat * race +
				#     cigstat * edu + ns(cigyears, 2) + ns(cigday, 2), data = MYDATA)


				mydat.sm = data.frame(data0, age=rep(ag,nrow(cigdat0)), cigdat0)
				# > mydat.sm[1:4,]
				#   race  edu age cigyears   cigday cigstat
				# 1    W high  45        0  0.00000   Never
				# 2    W high  45        0  0.00000   Never
				# 3    W high  45       30 19.44004 Current
				# 4    W high  45       29 19.44004 Current

				# mydat.sm[23,]
				# 	ag
				# 	pd0=predict(lm.bmi, newdata=mydat.sm[23,])
				# 	pd0
				#pd=predict(lm.bmi, newdata=mydat.sm)
				# > pd[1:10]
				#        1        2        3        4        5        6        7        8        9       10
				# 30.11995 29.12122 27.68076 27.76231 27.30130 29.12122 28.99155 28.30583 28.09225 26.67327
				# > summary(pd)
				#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
				#   24.94   27.67   28.29   28.25   29.04   30.12


				pd0=predict(lm.bmi, newdata=mydat.sm)
				#pd2=predict(lm.bmi.adj, newdata=mydat.sm)
				# > pd0[1:10]
				#        1        2        3        4        5        6        7        8        9       10
				# 29.12122 26.79961 27.77168 27.67951 27.54256 29.12122 28.99155 26.79961 28.09225 26.67327


				#newdata=mydat.sm[3:5,]


				if(Gender=="F"){

					# > cbind(coef(OUT.bmi$lm.bmi.original),OUT.bmi$lm.bmi.coef.adj)
					#                                  [,1]        [,2]
					# (Intercept)               28.10083489 29.80083489 <---- only this
					# raceA                     -3.08376736 -3.08376736
					# raceB                      3.68311042  3.68311042
					# raceH                      0.83767049  0.83767049
					# educollege                -1.34144513 -1.34144513
					# edupostcol                -1.53673131 -1.53673131
					# ns(age, df = 3)1          -0.87997021 -0.87997021
					# ns(age, df = 3)2          -1.47032766 -1.47032766
					# ns(age, df = 3)3          -1.80009239 -1.80009239
					# cigstatCurrent            -2.95459998 -2.95459998
					# cigstatFormer             -0.94652637 -0.94652637
					# ns(cigyears, df = 1)       0.03694476  0.03694476
					# ns(cigday, df = 1)         6.01963549  6.01963549
					# educollege:cigstatCurrent  0.38764392  0.38764392
					# edupostcol:cigstatCurrent  1.04133139  1.04133139
					# educollege:cigstatFormer  -0.04459367 -0.04459367
					# edupostcol:cigstatFormer   0.09616144  0.09616144

					if (cohort==1960){

						incr = 5.5; incr #5.5
						bmi.pd = pd0 + incr

					}#

					if (cohort==1950){

						incr = 1.7; incr #1.7
						bmi.pd = pd0 + incr

					}#



				}#end of
				################### additional manual calibration the results from myBMI.cond2 (4/13/2016) #####################

				if(Gender=="M"){



				  if(cohort==1960){
					# coef.bmi
					#              (Intercept)                     raceA                     raceB                     raceH                educollege
					#            28.9402242666             -2.3218111748              0.9987519405             -0.2219779839             -0.8153713048
					#               edupostcol          ns(age, df = 3)1          ns(age, df = 3)2          ns(age, df = 3)3            cigstatCurrent
					#            -1.2122386136             -1.3260506540             -2.2403951444             -1.9582010605             -2.8784777336
					#            cigstatFormer     ns(cigyears, df = 2)1     ns(cigyears, df = 2)2       ns(cigday, df = 2)1       ns(cigday, df = 2)2
					#            -1.0292421738              1.6681763396             -0.2270946527              2.5256397677              2.4033889594
					#     raceA:cigstatCurrent      raceB:cigstatCurrent      raceH:cigstatCurrent       raceA:cigstatFormer       raceB:cigstatFormer
					#             1.2005240579             -0.9160033351              0.3129849966              0.1417140056             -0.6853831133
					#      raceH:cigstatFormer educollege:cigstatCurrent edupostcol:cigstatCurrent  educollege:cigstatFormer  edupostcol:cigstatFormer
					#             0.1476843815              0.4137918003              0.8882080650              0.0001504568              0.2399267729

				  	bmi.pd=NULL
				  	incr=0
				  	bmi.pd = pd0 + 2


							### update bmi.pd:increae blace effect ##


							ix.blk = mydat.sm[,"race"]=="B"
							bmi.pd[ix.blk] = bmi.pd[ix.blk] + 1


							### decrease hispanic
							ix.hs = mydat.sm[,"race"]=="H"

							bmi.pd[ix.hs] = bmi.pd[ix.hs] -4

				  }

				  if(cohort==1950){
						   bmi.pd = NULL

						   coef.bmi
							#               (Intercept)                     raceA                     raceB                     raceH
							#             28.9430210153             -2.3216045642              0.9987353770             -0.2223563685
							#                educollege                edupostcol          ns(age, df = 4)1          ns(age, df = 4)2
							#             -0.8153890552             -1.2122167678             -0.9229637970             -1.4930552984
							#          ns(age, df = 4)3          ns(age, df = 4)4            cigstatCurrent             cigstatFormer
							#             -2.2324605728             -1.9825806052             -2.8781227204             -1.0289679250

							### reduce blace effect ##

							#MYCOEF["raceB"] = mycoef["raceB"]*0.7  # 30% reduction of coefficient

							# > coef.bmi["raceB"]
							#     raceB
							# 0.9987354

							#coef.bmi["raceB"]*0.7
							#     raceB
							# 0.6991148

							#### so whoever black has to be substracted by 0.99-0.69 = coef.bmi["raceB"]*0.3
							# > coef.bmi["raceB"]*0.3
							#     raceB
							# 0.2996206

							incr = - coef.bmi["raceB"]*0.03  # only increment, not 1.025
							incr
							#       raceB
							# -0.02996206

							ix.blk = mydat.sm[,"race"]=="B"
								# > sum(ix.blk)
								# [1] 10233
								# > sum(ix.blk)/length(ix.blk)
								# [1] 0.10233

							bmi.pd = pd0
							bmi.pd[ix.blk] = pd0[ix.blk] + incr

								# > summary(bmi.pd[ix.blk])
								#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
								#   26.48   27.72   28.27   28.56   29.30   30.09
								# > summary( pd0[ix.blk])
								#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
								#   26.51   27.75   28.30   28.59   29.33   30.12

							#ix.b = as.character(mydat.sm[,"race"])=="B"
							# > sum(ix.b)
							# [1] 10255

							#mycoef["raceB"]*0.4

							#pd[ix.b] = pd0[ix.b] +

					}#end of

				 }#end of Gender


				 if(j==1) BMIdat = bmi.pd
				 if(j>1) BMIdat= cbind(BMIdat, bmi.pd)

		  # print(ag)


				}#end of ages

			colnames(BMIdat)=paste("BMI",ages,sep=".")

			# > BMIdat[1:5,]
			#     BMI.45   BMI.46   BMI.47   BMI.48   BMI.49   BMI.50   BMI.51   BMI.52   BMI.53   BMI.54   BMI.55   BMI.56   BMI.57
			# 1 30.84353 30.79898 30.75443 30.70988 30.66533 30.62063 30.57498 30.52747 30.47714 30.42306 30.36430 30.29991 30.22896
			# 2 29.84479 29.80024 29.75569 29.71115 29.66660 29.62189 29.57625 29.52873 29.47840 29.42433 29.36556 29.30117 29.23023
			# 3 28.40434 28.35644 28.30676 28.25536 28.20229 28.14744 28.09009 28.02936 27.96436 27.89421 27.81803 27.73493 27.64403
			# 4 28.48588 28.43982 28.39192 28.34225 28.29085 28.23762 28.18184 28.12261 28.05907 27.99033 27.91549 27.83369 27.74403
			# 5 28.02488 27.96831 27.91012 27.85037 27.78912 27.72626 27.66107 27.59265 27.52014 27.44264 27.35927 27.26914 27.17138


			#plot(ages,BMIdat[1,],type="n", ylim=c(15,35))






			########## (4) Compare to observed data vs. simulated data ##########################################


			###### check to reference: mean BMI at age 50  #####
			# > ref.bmi
			#    W    B    H
			# 28.7 27.7 28.9

			BMI.50 = BMIdat[,"BMI.50"]
			#tt=data.frame(cbind(BMI.50 = bmi50, race=race))
			bmi.ave = aggregate(BMI.50, by=list(race=race), mean)
			#   race        x
			# 1    A 26.76746
			# 2    B 29.16310
			# 3    H 28.84572
			# 4    W 28.88204

			#   race        x
			# 1    A 26.26849
			# 2    B 29.08601
			# 3    H 28.85768
			# 4    W 28.90377

			row.names(bmi.ave)=as.character(bmi.ave[,1])

				## make a table to plot
			tt1=t(bmi.ave)
			tt2=as.numeric(tt1[-1,])
			# > tt2
			# [1] "26.26849" "29.08601" "28.85768" "28.90377"
			names(tt2)=tt1[1,]
			#        A        B        H        W
			# 26.26849 29.08601 28.85768 28.90377

			#        A        B        H        W   --> female
			# 25.10848 32.41363 29.65636 28.60779

			#bmi.ave = tt2

			########### plot excluding asian (since reference doens't have asian) ####
			ci1=ref.bmi - 1.96*ref.bmi.sd
			ci2=ref.bmi + 1.96*ref.bmi.sd

			cbind(bmi.ave[c("W","B","H"),2],ref.bmi, ci1, ci2)
			#           ref.bmi    ci1    ci2
			# W 27.89465    28.7 28.112 29.288
			# B 27.96616    27.7 26.916 28.484
			# H 27.79131    28.9 28.312 29.488

		   tab = c(bmi.ave[bmi.ave[,1]=="W",2], bmi.ave[bmi.ave[,1]=="B",2], bmi.ave[bmi.ave[,1]=="H",2])
		   names(tab)=c("W","B","H")


		  ############# before adjustment ##########

		  par(mar=c(5,5,5,3))

		   mat=cbind(ref.bmi, tab)
		   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="BMI",
		   main="Reference vs. Simulated \nAverage BMI (age 50) by race", cex.main=1.5, ylim=c(0,35))

		   ##### confidence interval ###
		   xs = c(1.5,4.5,7.5)

		   for(u in 1:length(xs)){


		   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

		   }#end of

		  legend(x="topleft", legend=c("Reference", "Simulated"), fill=c("red","yellow"), ncol=2,cex=1)



			###### [4] Simulating lung cancer family history given education, smo  ########################################

	cat("Simulating Lung cancer family history\n", sep="")

			# > coef.fh
			#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi  ns(pky, 2)1
			# -2.148305506  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042  1.030344727
			#  ns(pky, 2)2
			#  0.852142491

			#mydat.sm = data.frame(data0, age=rep(ag,nrow(cigdat0)), cigdat0)


			################# [4.1] Simulating Pr(FH=1 | age, smoking, BMI) for each individual over 45:90 #################

			FH.prev =NULL

			########## (1) extract information from OUT.fh ##########################
			# > names(OUT.fh)
			#  [1] "mycoef.adj"    "mycoef.before" "glm.fh"        "glm.or"        "prev.fh.adj"   "prev.fh.unadj" "ref.fh"        "ref.fh.ci"
			#  [9] "ns.mat.age"    "ns.mat.pky"

			glm.fh = OUT.fh$glm.fh

			coef.before = OUT.fh$mycoef.before
			#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi  ns(pky, 2)1
			# -2.518529315  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042  1.030344727
			#  ns(pky, 2)2
			#  0.852142491

			coef.adj = OUT.fh$mycoef.adj  # increased prevalence by calibration
			#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi  ns(pky, 2)1
			# -2.148305506  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042  1.030344727
			#  ns(pky, 2)2
			#  0.852142491

			####### (2) prepare for covariate data ###############################

			pkyDAT = DAT[,grep("PY",colnames(DAT))]
				# > pkyDAT[1:3,]
				#      PY.45    PY.46    PY.47    PY.48    PY.49    PY.50    PY.51    PY.52    PY.53    PY.54   PY.55    PY.56    PY.57    PY.58   PY.59
				# 1  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.0000  0.00000  0.00000  0.00000  0.0000
				# 2  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.0000  0.00000  0.00000  0.00000  0.0000
				# 3 28.05376 29.02023 29.98116 30.93657 31.88644 32.83078 33.76959 34.70287 35.63061 36.55282 37.4695 38.38065 39.28627 40.18635 41.0809
				#      PY.60   PY.61    PY.62    PY.63    PY.64    PY.65    PY.66    PY.67    PY.68    PY.69    PY.70    PY.71    PY.72    PY.73    PY.74
				# 1  0.00000  0.0000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000
				# 2  0.00000  0.0000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000

				# > BMIdat[1:5,]
				#     BMI.45   BMI.46   BMI.47   BMI.48   BMI.49   BMI.50   BMI.51   BMI.52   BMI.53   BMI.54   BMI.55   BMI.56   BMI.57   BMI.58
				# 1 30.08999 30.04544 30.00089 29.95634 29.91179 29.86709 29.82145 29.77393 29.72360 29.66952 29.61076 29.54637 29.47542 29.39698
				# 2 29.12122 29.07667 29.03212 28.98757 28.94302 28.89832 28.85267 28.80516 28.75483 28.70075 28.64199 28.57760 28.50665 28.42820
				# 3 27.27928 27.23138 27.18170 27.13030 27.07723 27.02238 26.96503 26.90430 26.83930 26.76915 26.69297 26.60987 26.51897 26.41938
				# 4 27.73235 27.68628 27.63839 27.58871 27.53731 27.48408 27.42830 27.36908 27.30554 27.23679 27.16195 27.08015 26.99049 26.89209
				# 5 27.54256 27.48599 27.42780 27.36806 27.30680 27.24395 27.17875 27.11034 27.03782 26.96032 26.87695 26.78683 26.68907 26.58279

			mydat.big = data.frame(cbind(data0, pkyDAT, BMIdat))
				# > mydat.big[1:10,]
				#    race     edu     PY.45     PY.46     PY.47     PY.48     PY.49     PY.50     PY.51     PY.52     PY.53     PY.54     PY.55     PY.56
				# 1     B  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 2     W  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 3     W college 28.053756 29.020226 29.981163 30.936569 31.886442 32.830783 33.769592 34.702868 35.630612 36.552824 37.469504 38.380651
				# 4     B  <=high 27.403327 28.369797 29.330735 30.286140 31.236013 32.180354 33.119163 34.052439 34.980184 35.902395 36.819075 37.730223
				# 5     W  <=high 24.382102 25.076264 25.757649 26.426256 27.082086 27.725139 28.355413 28.972911 29.577631 30.169573 30.748738 31.315125
				# 6     W  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 7     H  <=high 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535
				# 8     H  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 9     W  <=high  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161
				# 10    W  <=high 33.435355 34.653188 35.858235 37.050496 38.229970 39.396659 40.550562 41.691679 42.820009 43.935554 45.038312 46.128285

			# mycoef=coef.fh
			# ns.mat.age = OUT.fh$ns.mat.age
			# ns.mat.pky = OUT.fh$ns.mat.pky

			######### (3) Predict the probability for age = 45:90 ###############################

			for(j in 1:length(ages)){

				################ (a) design matrix #######
				# > mycoef
				#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi  ns(pky, 2)1
				# -2.148305506  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042  1.030344727
				#  ns(pky, 2)2
				#  0.852142491
				ag=ages[j];ag
				### extract covariate column name
				bminame=paste("BMI",ag,sep=".")
				pkname=paste("PY",ag,sep=".")
				# > pkname
				# [1] "PY.45"
				# > bminame
				# [1] "BMI.45"

				### covariates data ###
				mydat.sm0 = data.frame(age=rep(ag,nrow(cigdat0)),data0, bmi=mydat.big[,bminame],pky=mydat.big[,pkname] )
				# > mydat.sm0[1:5,]
				#   age race     edu      bmi      pky
				# 1  45    B  <=high 30.08999  0.00000
				# 2  45    W  <=high 29.12122  0.00000
				# 3  45    W college 27.27928 28.05376
				# 4  45    B  <=high 27.73235 27.40333
				# 5  45    W  <=high 27.54256 24.38210

				### predict using the regression output
				# > coef(glm.fh)
				#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi  ns(pky, 2)1
				# -2.518529315  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042  1.030344727
				#  ns(pky, 2)2
				#  0.852142491

				### female
				# > glm.fh$coef
				#  (Intercept)          age   educollege   edupostcol          bmi          pky
				# -2.279394585  0.001335893 -0.239239532 -0.250980876  0.005677488  0.005950754

				pr0=predict(glm.fh, newdata=mydat.sm0)
				# > pr0[1:5]
				#        1         2         3         4         5
				# -2.328082 -2.328082 -2.750840 -2.214505 -2.214871


				pr=pr0
				################### manual calibration the results from myFH.cond2 (4/19/2016) #####################



				################### manual calibration the results from myFH.cond2 (4/19/2016) #####################
				if(Gender=="F"){

					# > coef.before
					#  (Intercept)          age   educollege   edupostcol          bmi          pky
					# -2.279394585  0.001335893 -0.239239532 -0.250980876  0.005677488  0.005950754
					# > coef.adj
					#  (Intercept)          age   educollege   edupostcol          bmi          pky
					# -2.350055818  0.001335893 -0.239239532 -0.250980876  0.005677488  0.005950754

					incr = coef.adj[1] - coef.before[1]
					incr
					# (Intercept)
					# -0.07066123

					# exp(b + incr)/(1+exp(b+incr))

					#pr = pr0 + incr ## somehow this gave such high prevalnce need to adjust

					### further calibration ##
					if (cohort==1950) pr = pr0 + incr*1.2   # 0.1110671
					if (cohort==1960) pr= pr0 + 0 # no increment for 1960 cohort

							#cbind(pr0,pr)[1:5,]
							#         pr0        pr
							# 1 -2.336502 -1.966278
							# 2 -2.328082 -1.957859
				 }#end of Gender

				if(Gender=="M"){

							coef.before
							#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi  ns(pky, 2)1
							# -2.518529315  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042  1.030344727
							#  ns(pky, 2)2
							#  0.852142491
							coef.adj
							#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi  ns(pky, 2)1
							# -2.148305506  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042  1.030344727
							#  ns(pky, 2)2
							#  0.852142491

					incr = coef.adj[1] - coef.before[1]
					incr
					# (Intercept)
					#  0.3702238
					# exp(b + incr)/(1+exp(b+incr))

					#pr = pr0 + incr ## somehow this gave such high prevalnce need to adjust

					### further calibration ##
					if (cohort==1950) pr = pr0 + incr*0.3   # 0.1110671
					if (cohort==1960) #pr = pr0 + incr*0.3   # 0.1110671

							cbind(pr0,pr)[1:5,]
							#         pr0        pr
							# 1 -2.336502 -1.966278
							# 2 -2.328082 -1.957859
				 }#end of Gender






				### risk ####

				 prob = exp(pr)/(1+exp(pr))
				# > prob[1:5]
				#         1         2         3         4         5
				# 0.1227892 0.1236990 0.1208236 0.1365458 0.1365026
				# > (exp(pr0)/(1+exp(pr0)))[1:5]
				#          1          2          3          4          5
				# 0.08814469 0.08882373 0.08667888 0.09845549 0.09842296

				 if(j==1) FH.prev = prob
				 if(j>1) FH.prev= cbind(FH.prev, prob)

				#				 print(ag)

				}#end of ages


			colnames(FH.prev)=paste("FH",ages,sep=".")
			# > FH.prev[1:5,]
			#       FH.45     FH.46     FH.47     FH.48     FH.49     FH.50     FH.51     FH.52     FH.53     FH.54     FH.55     FH.56     FH.57
			# 1 0.1227892 0.1238523 0.1249233 0.1260022 0.1270891 0.1281807 0.1292600 0.1303063 0.1312983 0.1322142 0.1330319 0.1337290 0.1342829
			# 2 0.1236990 0.1247688 0.1258466 0.1269323 0.1280261 0.1291245 0.1302105 0.1312634 0.1322615 0.1331832 0.1340060 0.1347074 0.1352647
			# 3 0.1208236 0.1223782 0.1239439 0.1255207 0.1271086 0.1287042 0.1302905 0.1318462 0.1333494 0.1347772 0.1361064 0.1373131 0.1383728
			# 4 0.1365458 0.1382738 0.1400133 0.1417643 0.1435268 0.1452970 0.1470560 0.1487803 0.1504458 0.1520273 0.1534990 0.1548347 0.1560078
			# 5 0.1365026 0.1380648 0.1396319 0.1412038 0.1427804 0.1443579 0.1459175 0.1474358 0.1488888 0.1502518 0.1514997 0.1526067 0.1535470
			#       FH.58     FH.59     FH.60     FH.61     FH.62     FH.63     FH.64     FH.65     FH.66     FH.67     FH.68     FH.69     FH.70
			# 1 0.1346712 0.1348719 0.1348649 0.1346310 0.1341522 0.1334184 0.1324482 0.1312676 0.1299028 0.1283802 0.1267253 0.1249615 0.1231111
			# 2 0.1356553 0.1358573 0.1358503 0.1356150 0.1351332 0.1343948 0.1334186 0.1322307 0.1308574 0.1293252 0.1276599 0.1258850 0.1240229
			# 3 0.1392613 0.1399545 0.1404297 0.1406653 0.1406405 0.1403428 0.1397894 0.1390054 0.1380169 0.1368500 0.1355303 0.1340817 0.1325270
			# 4 0.1569913 0.1577589 0.1582857 0.1585480 0.1585228 0.1581963 0.1575874 0.1567238 0.1556339 0.1543465 0.1528897 0.1512896 0.1495714
			# 5 0.1542946 0.1548241 0.1551119 0.1551354 0.1548730 0.1543122 0.1534729 0.1523831 0.1510718 0.1495679 0.1478997 0.1460936 0.1441746

			apply(FH.prev,2,mean)
			#      FH.45      FH.46      FH.47      FH.48      FH.49      FH.50      FH.51      FH.52      FH.53      FH.54      FH.55      FH.56
			# 0.12317985 0.12445909 0.12574007 0.12702381 0.12831129 0.12959773 0.13086657 0.13209755 0.13326838 0.13435643 0.13534061 0.13619753
			#      FH.57      FH.58      FH.59      FH.60      FH.61      FH.62      FH.63      FH.64      FH.65      FH.66      FH.67      FH.68
			# 0.13690356 0.13743670 0.13777472 0.13789477 0.13777822 0.13740793 0.13677145 0.13588908 0.13478556 0.13348806 0.13202238 0.13041535
			#      FH.69      FH.70      FH.71      FH.72      FH.73      FH.74      FH.75      FH.76      FH.77      FH.78      FH.79      FH.80
			# 0.12869066 0.12687159 0.12498058 0.12303854 0.12106630 0.11908331 0.11710811 0.11515641 0.11323111 0.11133172 0.10945752 0.10760946
			#      FH.81      FH.82      FH.83      FH.84      FH.85      FH.86      FH.87      FH.88      FH.89      FH.90
			# 0.10578714 0.10398994 0.10221775 0.10047182 0.09875059 0.09705508 0.09538321 0.09373570 0.09211200 0.09051243

			mean(FH.prev[,"FH.55"])
			ref.fh
			# > 			mean(FH.prev[,"FH.55"])
			# [1] 0.1077848
			# > 			ref.fh
			# [1] 10.9

			# > mean(FH.prev[,"FH.55"])
			# [1] 0.1173455  # female


			meanfh55=mean(FH.prev[,"FH.55"])

			############ (4) barplot compare to the reference data (age = 55) #############


			  par(mar=c(5,5,5,3))
				#ref.fh.ci = c(9.74, 11.90)
				ci1=ref.fh.ci[1]
				ci2=ref.fh.ci[2]

			   mat=cbind(ref.fh, meanfh55*100)
			   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="FH prevalence (%)",
			   main="Prevalence (%) of FH (age 55)", cex.main=1.5, ylim=c(0,15))

			   ##### confidence interval ###
			   xs = c(1.5,2.5)#,7.5)

			   for(u in 1:length(xs)){


			   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

			   }#end of

			  legend(x="topleft", legend=c("Reference", "Simulated prob-based"), fill=c("red","yellow"), ncol=2,cex=1)


			####### time trajectory ########

			meanFH = apply(FH.prev,2,mean)
			# > meanFH
			#      FH.45      FH.46      FH.47      FH.48      FH.49      FH.50      FH.51      FH.52      FH.53      FH.54      FH.55      FH.56
			# 0.09780466 0.09885175 0.09990097 0.10095306 0.10200860 0.10306418 0.10410599 0.10511748 0.10607988 0.10697485 0.10778478 0.10849102
			#      FH.57      FH.58      FH.59      FH.60      FH.61      FH.62      FH.63      FH.64      FH.65      FH.66      FH.67      FH.68
			# 0.10907303 0.10951272 0.10979188 0.10989170 0.10979693 0.10949308 0.10897003 0.10824487 0.10733795 0.10627236 0.10506911 0.10375099
			par(mar=c(5,6,5,3))
			#			plot(ages,100*meanFH,pch=16, ylim=c(0,15),col="blue",
			#			main="(Simulated probability-based) \n FH prevalence (%)",
			#				xlab="Age",ylab="Mean FH prevalence (%) \nPr(FH=1 | age, smoking, BMI)",cex.lab=1.5,cex.main=1.5, cex.axis=1.5)
			#
			#			abline(v=55, lty="dotted",col="red")
			#			abline(h=ref.fh, lty="dotted",col="red")


			################# [4.2] Simulating FH = 0 or 1 using the above simulated Pr(FH=1 | age, smoking, BMI) for each individual over 45:90 #################

			FH.status= NULL

			####### OCM age of individuals #######
			# > DAT[1:3,1:10]
			#   X race gend birth_yr age_init age_cess age_death_OC quintile age_smoke1     CPD1
			# 1 1    0    0     1950     -999     -999           77       NA         NA       NA
			# 2 2    0    0     1950     -999     -999           87       NA         NA       NA
			# 3 3    0    0     1950       15     -999           67        3         15 4.926697

			ageOCM = DAT[,"age_death_OC"]
				# > ageOCM[1:5]
				# [1] 77 87 67 89 82
			# > range(ageOCM)
			# [1] -999   99    -999 means don't die until age 99 ##

			ageOCM[ageOCM == -999] = 100
			range(ageOCM)
			#[1]   0 100

			## major input: FH.prev

			#set.seed(5)

			max.age = ages[order(meanFH,decreasing=T)[1]]
			max.ph = meanFH[order(meanFH,decreasing=T)[1]]
			# > max.age
			# [1] 60
			# > max.ph
			#     FH.60
			# 0.1098917
			# >
			#[1] 0.1098917
			#seeds = runif(1,1000000, length(ages)*

			#for(u in 1:16){
			for(u in 1:length(ages)){

					fh.update= rep(NA, N)

					ag=ages[u];ag

					cname = paste("FH",ag,sep=".");cname
					mat.pr=FH.prev[,cname]
					# > pr[1:5]
					#          1          2          3          4          5
					# 0.09823288 0.09823288 0.06662215 0.10876315 0.10872762
							dim(mat.pr)=c(length(mat.pr),1)
							x=mat.pr[1,]
							samp.sm = function(x) sample(c(0,1), size=1, prob = c(1-x, x))


					######## (step 1) At age = 45, just sample 0/1 from the given predicted probability ####

					if(ag==45){  # this is same as u==1

							###### (1) sampling ############

							#set.seed(u)

							fh0=apply(mat.pr, 1, samp.sm)
							# > mean(fh0)
							# [1] 0.09801
							# > fh0[1:10]
							#  [1] 0 0 0 0 1 0 0 0 0 1


					}#end of 45

					#####(step 2) From age > 45, among only people who have fh = 0, sample more 0/1 until the mean(fh) (prevalence) reaches for the FH.prev[,46]
								######### repeat this until the maximum prevalence age ###

					if(ag > 45 ){

							### (1) take the previous year's fh status ###

							fh0 = ANS[,u-1] #
							#fh.previous = ANS[,u-1] #
							# > fh.previous[1:10]
							#  [1]  0  0  0  0  1 NA NA  0  0  0


					}#end of if(u > 45 and u <= max.age){


					##### (2) impose OCM ###########
		ix.dead = is.na(fh0)==T | ageOCM <= ag # identify who died prevous y -

		#ix.dead = is.na(fh0)==F & ageOCM <= ag # identify who did not die prevous y --> isn't it who DIED??!!
						sum(ix.dead)
						#[1] 556 additional
						# > sum(ix.dead)/length(ix.dead)
						#[1] 0.11244    ----> why 11% die before 45? hmm...

						#ageOCM[ix.dead]
						# hist(ageOCM[ix.dead])

					fh = fh0
						#sum(fh[ix.dead],na.rm=T)/ sum(fh==1,na.rm=T)
						# > 	sum(fh[ix.dead])/ sum(fh==1)
						# [1] 0.1132537   ---> OK 10% of fh=1 at 45 died already

					fh[ix.dead]=NA

					##### (3) updated case status with OCM information : total population N is the initial population size

					prev.before= sum(is.na(fh)==F & fh==1)/N
					prev.before
					#[1] 0.08691

					myref= mean(FH.prev[,cname])
					myref

					dif = myref - prev.before; dif
					# > dif
					# [1] 0.01089466

					n.require = ceiling(dif * N)
					n.require
					#[1] 1090 # recruit 1090 more
	#					print(paste("n.require=",n.require,sep=""))

					#### if there is at least one more case to recruit, do more sampling ###

					if(n.require > 0){


							##### (4) sample additional more among who don't have FH=1 ########

							case = fh
							mat.prob = mat.pr

							#set.seed(u+1000*u)

							fh.update0 = mySampleMore(case, mat.prob, n.require)
							# > names(fh.update0)
							# [1] "case.update" "prev.update"

							fh.update = fh.update0$case.update

							prev.aft= sum(is.na(fh.update)==F & fh.update==1)/N
							prev.aft
							#[1] 0.09697
							myref

		# 							print(paste("age=",ag,sep=""))
		# 							print(paste("model average prev=",round(mean(FH.prev[,cname]),3),sep=""))
	# 							print(paste("Simulated binary FH proportion (updated)=", round(prev.aft,3),sep=""))


					}#

					### if less than 1 required to sample, don't sample

					if(n.require <= 0)  {

					     fh.update = fh

					}


					#####(step 3) From age >= max.age, no more sampling of FH = 1 because FH prevalence is decreasing ###########


				 if(u==1){
				 		ANS = fh.update; dim(ANS)=c(length(fh.update),1)
				 		N.require = n.require

				 }

				 if(u>1){

					 	 ANS = cbind(ANS,fh.update)
					 	 N.require = c(N.require, n.require)


				 }# end of


		}#end of for(u in 1:length(ages)){

		colnames(ANS)=paste("FH.",ages,sep="")
		colnames(ANS)=paste("FH.",ages,sep="")

		# > ANS[1:50,]
		#          fh.update fh.update fh.update fh.update fh.update fh.update fh.update fh.update fh.update fh.update fh.update fh.update
		#  [1,]  1         1         1         1         1         1         1         1         1         1         1         1         1
		#  [2,]  0         0         0         0         0         0         0         0         0         1         1         1         1
		#  [3,]  0         1         1         1         1         1         1         1         1         1         1         1         1
		#  [4,]  1         1         1         1         1         1         1         1         1         1         1         1         1
		#  [5,]  0         0         0         0         0         0         0         1         1         1         1         1         1
		#  [6,] NA        NA        NA        NA        NA        NA        NA        NA        NA        NA        NA        NA        NA
		#  [7,] NA        NA        NA        NA        NA        NA        NA         1        NA        NA        NA        NA        NA
		#  [8,]  0         1         1         1         1         1         1         1         1         1         1         1         1
		#  [9,]  0         1         1         1         1         1         1         1         1         1         1        NA        NA
		# [10,]  0         1         1         1         1         1         1         1         1         1         1         1         1
		# [11,]  0         0         0         1         1         1         1         1         1         1         1         1         1
		# [12,]  0         0         0         0         0         0         0         0         0         0         0         0         0
		# [13,]  0         1         1         1         1         1         1         1         1         1         1         1         1

		tt=cbind(DAT[,5:7], data0,round(FH.prev[,1:5],3), ANS)[1:20,]

		#setwd(outdir)
		#write.csv(tt,"FH.output.example.wo.OCM.csv")
		#write.csv(tt,"FH.output.example.with.OCM.csv")

		x=ANS[,1]
		dim(x)=c(length(x),1)
		myprev = function(x){   sum(is.na(x)==F & (x==1))/ length(x) }

		FH.status = ANS


		prev.est = apply(FH.status, 2, myprev)
		#   FH.45   FH.46   FH.47   FH.48   FH.49   FH.50   FH.51   FH.52   FH.53   FH.54
		# 0.09781 0.09886 0.09991 0.10096 0.10201 0.10307 0.10411 0.10512 0.10608 0.10698

		meanFH = apply(FH.prev, 2, mean)

		#plot(ages, 100*prev.est, pch=18, cex=1.8, ylim=c(6,13), main="[Family History] Without OCM imposed \nSimulation vs. Model prediciton", cex.main=1.5,
		plot(ages, 100*prev.est, pch=18, cex=1.8, ylim=c(6,13), main="[Family History] With OCM imposed \nSimulation vs. Model prediciton", cex.main=1.5,

			col="red", xlab="Age", ylab="FH prevalence (%)",cex.axis=1.5, cex.lab=1.5)
		points(ages, 100*meanFH, col="blue", pch=16)
		legend(x="topleft", legend=c("Simulated","Model-prediction"), col=c("red","blue"), pch=c(18,16))


		pkdat = mydat.big[,paste("PY.",ages,sep="")]
		# > pkdat[1:10,]
		#        PY.45     PY.46     PY.47     PY.48     PY.49     PY.50     PY.51     PY.52     PY.53     PY.54     PY.55     PY.56     PY.57     PY.58     PY.59     PY.60
		# 1   0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
		# 2   0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
		# 3  28.053756 29.020226 29.981163 30.936569 31.886442 32.830783 33.769592 34.702868 35.630612 36.552824 37.469504 38.380651 39.286266 40.186349 41.080900 41.969919
		# 4  27.403327 28.369797 29.330735 30.286140 31.236013 32.180354 33.119163 34.052439 34.980184 35.902395 36.819075 37.730223 38.635838 39.535921 40.430471 41.319490

		####### visualize ######


			doPlot=F
			if(doPlot==T){
					#setwd(outdir)
					#pdf("FH.status_trajectories.500_PY_added.pdf")
					pdf("FH.status_trajectories.500_PY_added_FEMALE.pdf")

						kk=500
						par(mar=c(5,6,5,5))

						for(u in 1:kk){

							rcc=as.character(mydat.sm[u,"race"])
							ed=as.character(mydat.sm[u,"edu"])

								plot(ages, FH.status[u,], pch=16, col="red",cex.lab=1.5,cex.main=1.5, cex.axis=1.5, xlab="Age", ylab="Family History Status (0 or 1)", ylim=c(0,2),
										main=paste("Subject ID=",u,"\n(gender=",Gender,", race=",rcc," & edu=",ed,")",  sep=""),axes=F)
								axis(1,cex.axis=1.5)
								axis(2,cex.axis=1.5)

								axis(4, at=seq(0,1.5, by=0.5), labels=seq(0,1.5, by=0.5)*100, cex.axis=1.5)
								lines(ages, FH.status[u,], lty="dotted", col="red")
								mtext("Pack-Years", side=4, line=2.2, cex=1.5)

								### estimated probablity ###

								lines(ages,FH.prev[u,]*10,pch=16, col="dark grey")#, lty="dotted")

								 abline(v=ageOCM[u]-1, col="blue", lty="dotted", lwd=1.5)
								 #points(0, ageOCM[u]

								### pk years ###

								lines(ages,pkdat[u,]/100,lty="dotted", col="dark green")#, lty="dotted")
								points(ages,pkdat[u,]/100,pch=18, col="dark green")#, lty="dotted")




							#mtext("Cig/Day", side=4, line=2.2,cex=1.5)

								legend(x="topleft",legend=c("FH status","Pack-years", "OCM age"),pch=c(16,18, 16), col=c("red","dark green","blue"),cex=1.2,lty=c("solid","dotted", "dotted"))

							}

				  dev.off()

			}#end of if(doPlot==T){


			############ (4) barplot compare to the reference data (age = 55) #############

			 simfh55 = prev.est["FH.55"]
			#0.10779

			  par(mar=c(5,5,5,3))
				#ref.fh.ci = c(9.74, 11.90)
				ci1=ref.fh.ci[1]
				ci2=ref.fh.ci[2]

			   mat=cbind(ref.fh, simfh55*100)
			   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="FH prevalence (%)",
			   main="Reference vs. Simulated \n Prevalence of Family History (age 55)", cex.main=1.5, ylim=c(0,15))

			   ##### confidence interval ###
			   xs = c(1.5,2.5)#,7.5)

			   for(u in 1:length(xs)){


			   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

			   }#end of

			  legend(x="topleft", legend=c("Reference", "Simulated-based"), fill=c("red","yellow"), ncol=2,cex=1)




			###### [5] Simulating personal history of cancer given education, smo  ########################################

	cat("Simulating personal history of cancer\n", sep="")

			# > coef.ph
			#  (Intercept)  ns(age, 3)1  ns(age, 3)2  ns(age, 3)3        raceA        raceB        raceH  ns(bmi, 2)1  ns(bmi, 2)2          pky
			# -1.816925731  0.775599266  1.395902438  0.727633924 -1.134807420 -0.519480798 -0.170029629 -1.098434095  1.524776802  0.005378612

			#mydat.sm = data.frame(data0, age=rep(ag,nrow(cigdat0)), cigdat0)


			################# [4.1] Simulating Pr(FH=1 | age, smoking, BMI) for each individual over 45:90 #################

			PH.prev =NULL

			########## (1) extract information from OUT.fh ##########################
			# > names(OUT.fh)
			#  [1] "mycoef.adj"    "mycoef.before" "glm.fh"        "glm.or"        "prev.fh.adj"   "prev.fh.unadj" "ref.fh"        "ref.fh.ci"
			#  [9] "ns.mat.age"    "ns.mat.pky"

			glm.ph = OUT.ph$glm.ph
			# > names(OUT.ph)
			#  [1] "mycoef.adj"     "mycoef.before"  "glm.ph"         "glm.or"         "prev.phc.adj"   "prev.phc.unadj" "ref.ph"         "ref.ph.ci"      "ns.mat.age"
			# [10] "ns.mat.bmi"

			coef.before = OUT.ph$mycoef.before
			#  (Intercept)  ns(age, 3)1  ns(age, 3)2  ns(age, 3)3        raceA        raceB        raceH  ns(bmi, 2)1  ns(bmi, 2)2          pky
			# -3.494087943  0.775599266  0.465300813  0.727633924 -1.134807420 -0.519480798 -0.170029629 -1.098434095  1.524776802  0.005378612

			coef.adj = OUT.ph$mycoef.adj  # increased prevalence by calibration
			#  (Intercept)  ns(age, 3)1  ns(age, 3)2  ns(age, 3)3        raceA        raceB        raceH  ns(bmi, 2)1  ns(bmi, 2)2          pky
			# -1.816925731  0.775599266  1.395902438  0.727633924 -1.134807420 -0.519480798 -0.170029629 -1.098434095  1.524776802  0.005378612


			###### this is female: have cigstat  in addition to pack-years###

			# > coef.before
			#    (Intercept)    ns(age, 2)1    ns(age, 2)2          raceA          raceB          raceH     educollege     edupostcol cigstatCurrent
			#   -2.929346771    0.609394920    0.779349289   -0.404424796   -0.312855214    0.103250851   -0.006430919    0.140503564    0.211979886
			#  cigstatFormer            pky
			#    0.171671281    0.002359403
			# > coef.adj
			#    (Intercept)    ns(age, 2)1    ns(age, 2)2          raceA          raceB          raceH     educollege     edupostcol cigstatCurrent
			#   -2.835607674    0.609394920    0.779349289   -0.404424796   -0.312855214    0.103250851   -0.006430919    0.140503564    0.211979886
			#  cigstatFormer            pky
			#    0.171671281    0.002359403

			####### (2) prepare for covariate data ###############################

			pkyDAT = DAT[,grep("PY",colnames(DAT))]
				# > pkyDAT[1:3,]
				#      PY.45    PY.46    PY.47    PY.48    PY.49    PY.50    PY.51    PY.52    PY.53    PY.54   PY.55    PY.56    PY.57    PY.58   PY.59
				# 1  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.0000  0.00000  0.00000  0.00000  0.0000
				# 2  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.0000  0.00000  0.00000  0.00000  0.0000
				# 3 28.05376 29.02023 29.98116 30.93657 31.88644 32.83078 33.76959 34.70287 35.63061 36.55282 37.4695 38.38065 39.28627 40.18635 41.0809
				#      PY.60   PY.61    PY.62    PY.63    PY.64    PY.65    PY.66    PY.67    PY.68    PY.69    PY.70    PY.71    PY.72    PY.73    PY.74
				# 1  0.00000  0.0000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000
				# 2  0.00000  0.0000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000

				# > BMIdat[1:5,]
				#     BMI.45   BMI.46   BMI.47   BMI.48   BMI.49   BMI.50   BMI.51   BMI.52   BMI.53   BMI.54   BMI.55   BMI.56   BMI.57   BMI.58
				# 1 30.08999 30.04544 30.00089 29.95634 29.91179 29.86709 29.82145 29.77393 29.72360 29.66952 29.61076 29.54637 29.47542 29.39698
				# 2 29.12122 29.07667 29.03212 28.98757 28.94302 28.89832 28.85267 28.80516 28.75483 28.70075 28.64199 28.57760 28.50665 28.42820
				# 3 27.27928 27.23138 27.18170 27.13030 27.07723 27.02238 26.96503 26.90430 26.83930 26.76915 26.69297 26.60987 26.51897 26.41938
				# 4 27.73235 27.68628 27.63839 27.58871 27.53731 27.48408 27.42830 27.36908 27.30554 27.23679 27.16195 27.08015 26.99049 26.89209
				# 5 27.54256 27.48599 27.42780 27.36806 27.30680 27.24395 27.17875 27.11034 27.03782 26.96032 26.87695 26.78683 26.68907 26.58279

			cigstatDAT = CIGDAT[,grep("cigstat.", colnames(CIGDAT))]

			mydat.big = data.frame(cbind(data0, pkyDAT, BMIdat, cigstatDAT))
				# > mydat.big[1:10,]
				#    race     edu     PY.45     PY.46     PY.47     PY.48     PY.49     PY.50     PY.51     PY.52     PY.53     PY.54     PY.55     PY.56
				# 1     B  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 2     W  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 3     W college 28.053756 29.020226 29.981163 30.936569 31.886442 32.830783 33.769592 34.702868 35.630612 36.552824 37.469504 38.380651
				# 4     B  <=high 27.403327 28.369797 29.330735 30.286140 31.236013 32.180354 33.119163 34.052439 34.980184 35.902395 36.819075 37.730223
				# 5     W  <=high 24.382102 25.076264 25.757649 26.426256 27.082086 27.725139 28.355413 28.972911 29.577631 30.169573 30.748738 31.315125
				# 6     W  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 7     H  <=high 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535
				# 8     H  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 9     W  <=high  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161
				# 10    W  <=high 33.435355 34.653188 35.858235 37.050496 38.229970 39.396659 40.550562 41.691679 42.820009 43.935554 45.038312 46.128285

			# mycoef=coef.fh
			# ns.mat.age = OUT.fh$ns.mat.age
			# ns.mat.pky = OUT.fh$ns.mat.pky

			######### (3) Predict the probability for age = 45:90 ###############################

			for(j in 1:length(ages)){

				################ (a) make design matrix for each age #######
				# > mycoef
				#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi  ns(pky, 2)1
				# -2.148305506  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042  1.030344727
				#  ns(pky, 2)2
				#  0.852142491

				# > coef.before
				#  (Intercept)  ns(age, 3)1  ns(age, 3)2  ns(age, 3)3        raceA        raceB        raceH  ns(bmi, 2)1  ns(bmi, 2)2          pky
				# -3.494087943  0.775599266  0.465300813  0.727633924 -1.134807420 -0.519480798 -0.170029629 -1.098434095  1.524776802  0.005378612



				ag=ages[j];ag
				### extract covariate column name
				bminame=paste("BMI",ag,sep=".")
				pkname=paste("PY",ag,sep=".")
				# > pkname
				# [1] "PY.45"
				# > bminame
				# [1] "BMI.45"
				cigstatname = paste("cigstat",ag,sep=".")

 				### fo
				#colname = paste(c("cigyears","cigday","cigstat"),rep(paste(".",ag,sep=""), 3),sep="")
				#colname
				#[1] "cigyears.45" "cigday.45"    "cigstat.45"

				#### extract the cig data for the given age

				#cigdat0 = CIGDAT[,colname]





				### covariates data ###
				mydat.sm0 = data.frame(age=rep(ag,nrow(cigdat0)),edu=data0[,"edu"],race=data0[,"race"], bmi=mydat.big[,bminame],pky=mydat.big[,pkname],cigstat=mydat.big[,cigstatname] )
				# > mydat.sm0[1:10,]
				#    age race      bmi       pky
				# 1   45    W 29.12122  0.000000
				# 2   45    H 28.89886  0.000000
				# 3   45    W 27.68076 28.053756
				# 4   45    B 27.73235 27.403327
				# 5   45    H 27.63347 24.382102
				# 6   45    W 29.12122  0.000000
				# 7   45    W 28.99155 43.645535
				# 8   45    B 30.08999  0.000000
				# 9   45    W 28.09225  0.107161
				# 10  45    W 27.79499 33.435355

				# >  mydat.sm0[1:10,]
				#    age race      bmi        pky cigstat
				# 1   45    W 29.83626  0.0000000   Never
				# 2   45    B 33.51937  0.0000000   Never
				# 3   45    B 31.51737 28.4497690 Current
				# 4   45    B 31.51689 27.8695794 Current
				# 5   45    W 27.57983 17.1476990 Current
				# 6   45    W 29.83626  5.0227522   Never
				# 7   45    W 28.90025 47.9493950  Former
				# 8   45    H 30.67393 20.3006974   Never
				# 9   45    W 28.88973  0.1813126  Former
				# 10  45    B 31.76510 30.0423846 Current

				#################### (b) predict using the regression output ###########################
				# > coef(glm.ph)
				#  (Intercept)  ns(age, 3)1  ns(age, 3)2  ns(age, 3)3        raceA        raceB        raceH  ns(bmi, 2)1  ns(bmi, 2)2          pky
				# -3.494087943  0.775599266  0.465300813  0.727633924 -1.134807420 -0.519480798 -0.170029629 -1.098434095  1.524776802  0.005378612

				pr0=predict(glm.ph, newdata=mydat.sm0)
				pr0[1:5]
				#         1         2         3         4         5
				# -4.210063 -4.374438 -4.017309 -4.542003 -4.205500
				pr=pr0

				prob0 = exp(pr0)/(1+exp(pr0))
				mean(prob0)
				# > mean(prob0)
				# [1] 0.01484012


				#### predict using calibrated parameters -----without manual calibration #####



		glm.ph$coefficients = coef.adj

		######## secondary calibration---prevalence too high...

	   #glm.ph$coefficients[3] = coef.before[3]*1

				pr=predict(glm.ph, newdata=mydat.sm0)
				pr[1:5]
				#         1         2         3         4         5
				# -2.843581 -3.007956 -2.650827 -3.175521 -2.839019
				# > mean(pr0)
				# [1] -2.879403
				# > mean(pr)
				# [1] -2.785663


				### risk ####

				prob = exp(pr)/(1+exp(pr))
				# > prob[1:5]
				#         1         2         3         4         5
				# 0.1227892 0.1236990 0.1208236 0.1365458 0.1365026
				# > (exp(pr0)/(1+exp(pr0)))[1:5]
				#          1          2          3          4          5
				# 0.08814469 0.08882373 0.08667888 0.09845549 0.09842296

				mean(prob)
				# > mean(prob1)
				# [1] 0.05566851

				 if(j==1) PH.prev = prob
				 if(j>1) PH.prev= cbind(PH.prev, prob)

				 #print(ag)

				}#end of ages


			colnames(PH.prev)=paste("PH",ages,sep=".")
			#        PH.45      PH.46      PH.47      PH.48      PH.49      PH.50      PH.51      PH.52      PH.53      PH.54      PH.55      PH.56      PH.57      PH.58
			# 1 0.05501406 0.05795983 0.06105381 0.06430239 0.06771209 0.07128971 0.07504270 0.07897896 0.08310674 0.08743466 0.09197177 0.09672758 0.10171211 0.10693595
			# 2 0.04706775 0.04961313 0.05228918 0.05510181 0.05805712 0.06116145 0.06442186 0.06784585 0.07144130 0.07521654 0.07918032 0.08334193 0.08771119 0.09229859
			# 3 0.06593806 0.06979466 0.07386204 0.07814975 0.08266751 0.08742543 0.09243489 0.09770801 0.10325744 0.10909644 0.11523889 0.12169936 0.12849317 0.13563641
			# 4 0.04009738 0.04250828 0.04505927 0.04775774 0.05061139 0.05362834 0.05681775 0.06018946 0.06375395 0.06752236 0.07150661 0.07571943 0.08017445 0.08488634
			# 5 0.05525175 0.05845883 0.06184025 0.06540405 0.06915849 0.07311220 0.07727500 0.08165741 0.08627058 0.09112626 0.09623692 0.10161577 0.10727686 0.11323513
			#        PH.59      PH.60     PH.61     PH.62     PH.63     PH.64     PH.65     PH.66     PH.67     PH.68     PH.69     PH.70     PH.71     PH.72     PH.73
			# 1 0.11240942 0.11813939 0.1241086 0.1302009 0.1362547 0.1420817 0.1474712 0.1522361 0.1563495 0.1598403 0.1627589 0.1651697 0.1671463 0.1687692 0.1701248
			# 2 0.09711445 0.10216605 0.1074394 0.1128331 0.1182047 0.1233865 0.1281900 0.1324460 0.1361278 0.1392582 0.1418805 0.1440507 0.1458337 0.1473009 0.1485289
			# 3 0.14314451 0.15102690 0.1592623 0.1677068 0.1761590 0.1843827 0.1921122 0.1991099 0.2053353 0.2108159 0.2156097 0.2197929 0.2234534 0.2266888 0.2296045
			# 4 0.08986983 0.09513624 0.1006767 0.1063987 0.1121677 0.1178210 0.1231711 0.1280452 0.1324055 0.1362631 0.1396517 0.1426196 0.1452248 0.1475339 0.1496199
			# 5 0.11950521 0.12609673 0.1329931 0.1400718 0.1471598 0.1540521 0.1605168 0.1663442 0.1714955 0.1759917 0.1798810 0.1832285 0.1861102 0.1886108 0.1908221
			#       PH.74     PH.75     PH.76     PH.77     PH.78     PH.79     PH.80     PH.81     PH.82     PH.83     PH.84     PH.85     PH.86     PH.87     PH.88
			# 1 0.1713029 0.1723967 0.1734855 0.1745852 0.1756958 0.1768176 0.1779504 0.1790945 0.1802497 0.1814162 0.1825940 0.1837832 0.1849838 0.1861959 0.1874195
			# 2 0.1495984 0.1505925 0.1515824 0.1525826 0.1535930 0.1546137 0.1556448 0.1566863 0.1577383 0.1588009 0.1598741 0.1609579 0.1620524 0.1631578 0.1642739
			# 3 0.2323116 0.2349265 0.2375293 0.2401644 0.2428314 0.2455298 0.2482594 0.2510200 0.2538117 0.2566346 0.2594886 0.2623737 0.2652899 0.2682373 0.2712157
			# 4 0.1515613 0.1534411 0.1553170 0.1572210 0.1591530 0.1611131 0.1631010 0.1651166 0.1671602 0.1568646 0.1579456 0.1590373 0.1601398 0.1612529 0.1623769
			# 5 0.1928412 0.1947696 0.1966547 0.1985630 0.2004945 0.2024494 0.2044276 0.2064294 0.2084547 0.2105038 0.2125766 0.2146732 0.2167938 0.2189383 0.2211069

			apply(PH.prev,2,mean)
				#      PH.45      PH.46      PH.47      PH.48      PH.49      PH.50      PH.51      PH.52      PH.53      PH.54      PH.55      PH.56      PH.57      PH.58
				# 0.05566851 0.05875167 0.06199277 0.06539658 0.06896832 0.07271728 0.07665048 0.08077427 0.08509999 0.08963859 0.09439427 0.09937610 0.10460058 0.11007181
				#      PH.59      PH.60      PH.61      PH.62      PH.63      PH.64      PH.65      PH.66      PH.67      PH.68      PH.69      PH.70      PH.71      PH.72
				# 0.11579871 0.12179751 0.12804374 0.13441547 0.14075426 0.14685462 0.15250889 0.15751646 0.16185775 0.16555488 0.16866370 0.17124563 0.17337668 0.17513772
				#      PH.73      PH.74      PH.75      PH.76      PH.77      PH.78      PH.79      PH.80      PH.81      PH.82      PH.83      PH.84      PH.85      PH.86
				# 0.17661802 0.17791251 0.17911468 0.18030510 0.18149944 0.18269968 0.18391334 0.18512946 0.18635563 0.18758991 0.18883788 0.19008227 0.19134146 0.19259852
				#      PH.87      PH.88      PH.89      PH.90
				# 0.19386692 0.19514019 0.19642945 0.19772486

			mean(PH.prev[,"PH.55"])
			ref.ph
			# > 			mean(FH.prev[,"FH.55"])
			# [1] 0.07823437 --> 2
			# > 			ref.fh
			# [1] 6.14

			meanph55=mean(PH.prev[,"PH.55"])




			############ (4) barplot compare to the reference data (age = 55) #############


			  par(mar=c(5,5,5,3))
				#ref.fh.ci = c(9.74, 11.90)
				ci1=ref.ph.ci[1]
				ci2=ref.ph.ci[2]

			   mat=cbind(ref.ph, meanph55*100)
			   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="PHC prevalence (%)",
			   main="Prevalence (%) of PHC (age 55)", cex.main=1.5, ylim=c(0,15))

			   ##### confidence interval ###
			   xs = c(1.5,2.5)#,7.5)

			   for(u in 1:length(xs)){


			   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

			   }#end of

			  legend(x="topleft", legend=c("Reference", "Simulated prob-based"), fill=c("red","yellow"), ncol=2,cex=1)


			####### time trajectory ########

			meanPH = apply(PH.prev,2,mean)
			# > meanFH
			#      FH.45      FH.46      FH.47      FH.48      FH.49      FH.50      FH.51      FH.52      FH.53      FH.54      FH.55      FH.56
			# 0.09780466 0.09885175 0.09990097 0.10095306 0.10200860 0.10306418 0.10410599 0.10511748 0.10607988 0.10697485 0.10778478 0.10849102
			#      FH.57      FH.58      FH.59      FH.60      FH.61      FH.62      FH.63      FH.64      FH.65      FH.66      FH.67      FH.68
			# 0.10907303 0.10951272 0.10979188 0.10989170 0.10979693 0.10949308 0.10897003 0.10824487 0.10733795 0.10627236 0.10506911 0.10375099
				par(mar=c(5,6,5,3))
		#			plot(ages,100*meanPH,pch=16, ylim=c(0,25),col="blue",
		#			main="(Simulated probability-based) \n PHC prevalence (%)",
		#				xlab="Age",ylab="PHC prevalence (%) \nPr(PH=1 | age, race, smoking, BMI)",cex.lab=1.5,cex.main=1.5, cex.axis=1.5)
		#
		#			abline(v=55, lty="dotted",col="red")
	#			abline(h=ref.ph, lty="dotted",col="red")


			##### adding McClure points ###

			## adding from McClure ##

			#plot(myages, probs.ph2*100, pch=17,col="red", xlab="Age",ylab="Prevalence (%) of PH", main="(After calibration) Multivariate Model", ylim=c(5,26))

		#
		#			xx=c(25, 35, 45,55,65,75,80)
		#			yy=c(1.2, 2.1, 4.4, 8.3, 14.9, 21.7, 25)
		#			points(xx,yy,pch=17,col="dark green")
		#
		#
		#			points(xx, yy*0.76,pch=18,col="red",cex=2)
		#
	#			legend(x="bottomright", legend=c("NHIS", "Adjusted NHIS", "Simulation"), fill=c("dark green","red","blue"),cex=1.2)





			################# [4.2] Simulating PH = 0 or 1 using the above simulated Pr(FH=1 | age, smoking, BMI) for each individual over 45:90 #################

			PH.status= NULL

			####### OCM age of individuals #######
			# > DAT[1:3,1:10]
			#   X race gend birth_yr age_init age_cess age_death_OC quintile age_smoke1     CPD1
			# 1 1    0    0     1950     -999     -999           77       NA         NA       NA
			# 2 2    0    0     1950     -999     -999           87       NA         NA       NA
			# 3 3    0    0     1950       15     -999           67        3         15 4.926697

			ageOCM = DAT[,"age_death_OC"]
				# > ageOCM[1:5]
				# [1] 77 87 67 89 82
			# > range(ageOCM)
			# [1] -999   99    -999 means don't die until age 99 ##

			ageOCM[ageOCM == -999] = 100
			range(ageOCM)
			#[1]   0 100

			## major input: FH.prev

			#set.seed(5)

			max.age = ages[order(meanPH,decreasing=T)[1]]
			max.ph = meanPH[order(meanPH,decreasing=T)[1]]
			# > max.age
			# [1] 60
			# > max.ph
			#     FH.60
			# 0.1098917
			# >
			#[1] 0.1098917
			#seeds = runif(1,1000000, length(ages)*

			#for(u in 1:16){
			for(u in 1:length(ages)){

					ph.update= rep(NA, N)

					ag=ages[u];ag

					cname = paste("PH",ag,sep=".");cname
					mat.pr=PH.prev[,cname]
					# > pr[1:5]
					#          1          2          3          4          5
					# 0.09823288 0.09823288 0.06662215 0.10876315 0.10872762
							dim(mat.pr)=c(length(mat.pr),1)
							x=mat.pr[1,]
							samp.sm = function(x) sample(c(0,1), size=1, prob = c(1-x, x))


					######## (step 1) At age = 45, just sample 0/1 from the given predicted probability ####

					if(ag==45){  # this is same as u==1

							###### (1) sampling ############

							#set.seed(u)

							ph0=apply(mat.pr, 1, samp.sm)
							 mean(ph0,na.rm=T)
							# [1] 0.09801
							# > fh0[1:10]
							#  [1] 0 0 0 0 1 0 0 0 0 1


					}#end of 45

					#####(step 2) From age > 45, among only people who have ph = 0, sample more 0/1 until the mean(Ph) (prevalence) reaches for the PH.prev[,46]
								######### repeat this until the maximum prevalence age ###

					if(ag > 45 ){

							### (1) take the previous year's fh status ###

							ph0 = ANS[,u-1] #
							#fh.previous = ANS[,u-1] #
							# > fh.previous[1:10]
							#  [1]  0  0  0  0  1 NA NA  0  0  0


					}#end of if(u > 45 and u <= max.age){


					##### (2) impose OCM ###########

	ix.dead = is.na(ph0)==T | ageOCM <= ag # identify who did  die prevous y
						sum(ix.dead)
						#[1] 556 additional
						# > sum(ix.dead)/length(ix.dead)
						#[1] 0.11244    ----> why 11% die before 45? hmm...

						#ageOCM[ix.dead]
						# hist(ageOCM[ix.dead])

					ph = ph0
						#sum(fh[ix.dead],na.rm=T)/ sum(fh==1,na.rm=T)
						# > 	sum(fh[ix.dead])/ sum(fh==1)
						# [1] 0.1132537   ---> OK 10% of fh=1 at 45 died already

					ph[ix.dead]=NA

					##### (3) updated case status with OCM information : total population N is the initial population size

					## number of people alive by the time (people at risk)
					N.risk =  sum(!ix.dead)
					prev.before= sum(is.na(ph)==F & ph==1)/N.risk
					#prev.before= sum(is.na(ph)==F & ph==1)/N
					prev.before
					#[1] 0.03035

					myref= mean(PH.prev[,cname])
					myref
					#[1] [1] 0.0330077


					dif = myref - prev.before; dif  # should it be always positive? yes because initial population stays the same
					# > dif
					# [1] 0.01089466

					n.require = ceiling(dif * N.risk)
					#n.require = ceiling(dif * N)
					n.require
						#[1] 1090 # recruit 1090 more
	#					print(paste("n.require=",n.require,sep=""))

					#### if there is at least one more case to recruit, do more sampling ###

					if(n.require > 0){


							##### (4) sample additional more among who don't have FH=1 ########

							case = ph
							mat.prob = mat.pr

							#set.seed(u+1000*u)

				ph.update0 = mySampleMore2(case, mat.prob, n.require)
							# > names(ph.update0)
							# [1] "case.update" "prev.update"

							ph.update = ph.update0$case.update

							prev.aft= sum(is.na(ph.update)==F & ph.update==1)/N.risk
							prev.aft
							#[1] 0.09697
							myref

		# 							print(paste("age=",ag,sep=""))
		# 							print(paste("model average prev=",round(mean(PH.prev[,cname]),3),sep=""))
	# 							print(paste("Simulated binary PH proportion (updated)=", round(prev.aft,3),sep=""))


					}#

					### if less than 1 required to sample, don't sample

					if(n.require <= 0)  {

					     ph.update = ph

					}


					#####(step 3) From age >= max.age, no more sampling of PH = 1 because FH prevalence is decreasing ###########


				 if(u==1){
				 		ANS = ph.update; dim(ANS)=c(length(ph.update),1)
				 		N.require = n.require

				 }

				 if(u>1){

					 	 ANS = cbind(ANS,ph.update)
					 	 N.require = c(N.require, n.require)


				 }# end of


		}#end of for(u in 1:length(ages)){

		colnames(ANS)=paste("PH.",ages,sep="")
		colnames(ANS)=paste("PH.",ages,sep="")

		# > ANS[1:50,]
			#      PH.45 PH.46 PH.47 PH.48 PH.49 PH.50 PH.51 PH.52 PH.53 PH.54 PH.55 PH.56 PH.57 PH.58 PH.59 PH.60 PH.61 PH.62 PH.63 PH.64 PH.65 PH.66 PH.67 PH.68 PH.69
			#  [1,]     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			#  [2,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1
			#  [3,]     0     0     0     0     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1     1     1    NA    NA    NA
			#  [4,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1     1     1     1
			#  [5,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0
			#  [6,]    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			#  [7,]    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			#  [8,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1
			#  [9,]     0     0     0     0     0     0     0     0     0     0     1    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [10,]     0     0     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			# [11,]     0     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			# [12,]     0     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			# [13,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1     1     1
			# [14,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1
			# [15,]     0     0     0     0     0     0    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [16,]     0     0     0     0     0     0     0     0    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [17,]     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1     1
			# [18,]     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			# [19,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1    NA    NA    NA    NA    NA    NA    NA    NA
			# [20,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0
			# [21,]    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [22,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0
			# [23,]     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			# [24,]     0     0     0     0     0     0     0     1     1    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [25,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0
			# [26,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1
			# [27,]    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [28,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1     1
			# [29,]     0     0     0     0     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			#
		tt=cbind(DAT[,5:7],PY.55=DAT[,"PY.55"],BMI.55=mydat.big[,"BMI.55"], data0,round(PH.prev[,1:5],3), ANS)[1:20,]

		#setwd(outdir)
		#write.csv(tt,"PH.output.example.wo.OCM.csv")
		#write.csv(tt,"PH.output.example.with.OCM.csv")

		x=ANS[,1]
		dim(x)=c(length(x),1)
	#myprev = function(x){   sum(is.na(x)==F & (x==1))/ length(x) }
	myprev2 = function(x){   sum(is.na(x)==F & (x==1))/ sum(is.na(x)==F) } # <--- smaller risk set

		PH.status = ANS


		prev.est = apply(PH.status, 2, myprev2)
		prev.est
		#   PH.45   PH.46   PH.47   PH.48   PH.49   PH.50   PH.51   PH.52   PH.53   PH.54   PH.55   PH.56   PH.57   PH.58   PH.59   PH.60   PH.61   PH.62   PH.63
		# 0.03301 0.03536 0.03787 0.04055 0.04341 0.04645 0.04969 0.05312 0.05674 0.06056 0.06457 0.06876 0.07312 0.07764 0.08231 0.08710 0.09198 0.09693 0.10192
		#   PH.64   PH.65   PH.66   PH.67   PH.68   PH.69   PH.70   PH.71   PH.72   PH.73   PH.74   PH.75   PH.76   PH.77   PH.78   PH.79   PH.80   PH.81   PH.82
		# 0.10692 0.11193 0.11695 0.12196 0.12697 0.13198 0.13700 0.14204 0.14713 0.15227 0.15751 0.16285 0.16834 0.17396 0.17973 0.18566 0.19172 0.19794 0.20431
		#   PH.83   PH.84   PH.85   PH.86   PH.87   PH.88   PH.89   PH.90
		# 0.21084 0.21750 0.21700 0.20783 0.19451 0.17726 0.15828 0.13985

		meanPH = apply(PH.prev, 2, mean)
		#      PH.45      PH.46      PH.47      PH.48      PH.49      PH.50      PH.51      PH.52      PH.53      PH.54      PH.55      PH.56      PH.57      PH.58
		# 0.03300770 0.03535799 0.03786811 0.04054662 0.04340267 0.04644713 0.04968403 0.05311400 0.05673915 0.06055912 0.06456629 0.06875358 0.07311641 0.07763791
		#      PH.59      PH.60      PH.61      PH.62      PH.63      PH.64      PH.65      PH.66      PH.67      PH.68      PH.69      PH.70      PH.71      PH.72
		# 0.08230133 0.08709190 0.09197814 0.09692679 0.10191271 0.10691347 0.11192804 0.11694270 0.12195796 0.12696543 0.13197488 0.13699409 0.14203792 0.14712222
		#      PH.73      PH.74      PH.75      PH.76      PH.77      PH.78      PH.79      PH.80      PH.81      PH.82      PH.83      PH.84      PH.85      PH.86
		# 0.15226818 0.15750191 0.16284829 0.16833137 0.17395649 0.17972664 0.18565043 0.19171777 0.19793704 0.20430688 0.21083354 0.21749855 0.22432160 0.23128332
		#      PH.87      PH.88      PH.89      PH.90
		# 0.23839810 0.24565794 0.25307421 0.26063457

		#plot(ages, 100*prev.est, pch=18, cex=1.8, ylim=c(6,13), main="[Family History] Without OCM imposed \nSimulation vs. Model prediciton", cex.main=1.5,
		plot(ages, 100*prev.est, pch=18, cex=1.8, ylim=c(0,25), main="[Personal History] With OCM imposed \nSimulation vs. Model prediciton", cex.main=1.5,

			col="red", xlab="Age", ylab="PH prevalence (%)",cex.axis=1.5, cex.lab=1.5)
		points(ages, 100*meanPH, col="blue", pch=16)
		legend(x="topleft", legend=c("Simulated","Model-prediction"), col=c("red","blue"), pch=c(18,16))


		plot(ages[1:41], (100*prev.est)[1:41], pch=18, cex=1.8, ylim=c(0,25), main="[Personal History] With OCM imposed \nSimulation vs. Model prediciton", cex.main=1.5,

			col="red", xlab="Age", ylab="PH prevalence (%)",cex.axis=1.5, cex.lab=1.5)
		points(ages, 100*meanPH, col="blue", pch=16)
		legend(x="topleft", legend=c("Simulated","Model-prediction"), col=c("red","blue"), pch=c(18,16))



		pkdat = mydat.big[,paste("PY.",ages,sep="")]
		# > pkdat[1:10,]
		#        PY.45     PY.46     PY.47     PY.48     PY.49     PY.50     PY.51     PY.52     PY.53     PY.54     PY.55     PY.56     PY.57     PY.58     PY.59     PY.60
		# 1   0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
		# 2   0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
		# 3  28.053756 29.020226 29.981163 30.936569 31.886442 32.830783 33.769592 34.702868 35.630612 36.552824 37.469504 38.380651 39.286266 40.186349 41.080900 41.969919
		# 4  27.403327 28.369797 29.330735 30.286140 31.236013 32.180354 33.119163 34.052439 34.980184 35.902395 36.819075 37.730223 38.635838 39.535921 40.430471 41.319490

		####### visualize ######


			doPlot=F
			if(doPlot==T){
					#setwd(outdir)
					#pdf("PH.status_trajectories.500_PY_added_fixed.pdf")
					pdf("PH.status_trajectories.500_PY_added_fixed_FEMALE.pdf")

						kk=500
						par(mar=c(5,6,5,5))

						for(u in 1:kk){

							rcc=as.character(mydat.sm[u,"race"])
							ed=as.character(mydat.sm[u,"edu"])

								plot(ages[1:41], PH.status[u,1:41], pch=16, col="red",cex.lab=1.5,cex.main=1.5, cex.axis=1.5, xlab="Age", ylab="Family History Status (0 or 1)", ylim=c(0,2),
										main=paste("Subject ID=",u,"\n(gender=",Gender,", race=",rcc," & edu=",ed,")",  sep=""),axes=F)
								axis(1,cex.axis=1.5)
								axis(2,cex.axis=1.5)

								axis(4, at=seq(0,1.5, by=0.5), labels=seq(0,1.5, by=0.5)*100, cex.axis=1.5)
								lines(ages[1:41], PH.status[u,1:41], lty="dotted", col="red")
								mtext("Pack-Years", side=4, line=2.2, cex=1.5)

								### estimated probablity ###

								lines(ages[1:41],PH.prev[u,1:41]*10,pch=16, col="dark grey")#, lty="dotted")

								 abline(v=ageOCM[u]-1, col="blue", lty="dotted", lwd=1.5)
								 #points(0, ageOCM[u]

								### pk years ###

								lines(ages[1:41],pkdat[u,1:41]/100,lty="dotted", col="dark green")#, lty="dotted")
								points(ages[1:41],pkdat[u,1:41]/100,pch=18, col="dark green")#, lty="dotted")




							#mtext("Cig/Day", side=4, line=2.2,cex=1.5)

								legend(x="topleft",legend=c("PH status","Pack-years", "OCM age"),pch=c(16,18, 16), col=c("red","dark green","blue"),cex=1.2,lty=c("solid","dotted", "dotted"))

							}

				  dev.off()

			}#end of if(doPlot==T){


			############ (4) barplot compare to the reference data (age = 55) #############

			 simph55 = prev.est["PH.55"]
			#0.10779

			  par(mar=c(5,5,5,3))
				#ref.fh.ci = c(9.74, 11.90)
				ci1=ref.ph.ci[1]
				ci2=ref.ph.ci[2]

			   mat=cbind(ref.ph, simph55*100)
			   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="PHC prevalence (%)",
			   main="Reference vs. Simulated \n Prevalence of Personal History Cancer(age 55)", cex.main=1.5, ylim=c(0,15))

			   ##### confidence interval ###
			   xs = c(1.5,2.5)#,7.5)

			   for(u in 1:length(xs)){


			   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

			   }#end of

			  legend(x="topleft", legend=c("Reference", "Simulated-based"), fill=c("red","yellow"), ncol=2,cex=1)



			###### [5] Simulating COPD given other predictors ####################################################

	cat("Simulating COPD\n", sep="")

			# > coef.ph
			#  (Intercept)  ns(age, 3)1  ns(age, 3)2  ns(age, 3)3        raceA        raceB        raceH  ns(bmi, 2)1  ns(bmi, 2)2          pky
			# -1.816925731  0.775599266  1.395902438  0.727633924 -1.134807420 -0.519480798 -0.170029629 -1.098434095  1.524776802  0.005378612

			#mydat.sm = data.frame(data0, age=rep(ag,nrow(cigdat0)), cigdat0)


			################# [5.1] Simulating Pr(COPD=1 | age, smoking, BMI) for each individual over 45:90 #################

			COPD.prev =NULL

			########## (1) extract information from OUT.fh ##########################
			# > names(OUT.fh)
			#  [1] "mycoef.adj"    "mycoef.before" "glm.fh"        "glm.or"        "prev.fh.adj"   "prev.fh.unadj" "ref.fh"        "ref.fh.ci"
			#  [9] "ns.mat.age"    "ns.mat.pky"

			glm.copd = OUT.copd$glm.copd
			# > names(OUT.copd)
			# [1] "mycoef.adj"      "mycoef.before"   "glm.copd"        "glm.or"          "prev.copd.adj"   "prev.copd.unadj"
			# [7] "ref.copd"        "ref.ph.ci"

			coef.before = OUT.copd$mycoef.before
			#   (Intercept)             fh    ns(age, 4)1    ns(age, 4)2    ns(age, 4)3    ns(age, 4)4     educollege     edupostcol
			#    -2.32041572     0.17092388     0.08191215     0.41608891     0.51726281     0.56661253    -0.26859716    -0.25444026
			#          raceA          raceB          raceH    ns(bmi, 3)1    ns(bmi, 3)2    ns(bmi, 3)3 cigstatCurrent  cigstatFormer
			#    -0.38035367     0.18258225    -0.25465492    -0.54750785    -1.81169289     1.04942856     0.12205001     0.20551756
			#    ns(pky, 2)1    ns(pky, 2)2         cigday
			#     6.41229669     3.14674028    -0.02522479

			coef.adj = OUT.copd$mycoef.adj  # increased prevalence by calibration
			#    (Intercept)             fh    ns(age, 4)1    ns(age, 4)2    ns(age, 4)3    ns(age, 4)4     educollege     edupostcol
			#    -1.75191387     0.17092388     0.08191215     0.41608891     0.51726281     0.56661253    -0.26859716    -0.25444026
			#          raceA          raceB          raceH    ns(bmi, 3)1    ns(bmi, 3)2    ns(bmi, 3)3 cigstatCurrent  cigstatFormer
			#    -0.38035367     0.18258225    -0.25465492    -0.54750785    -1.81169289     1.04942856     0.12205001     0.20551756
			#    ns(pky, 2)1    ns(pky, 2)2         cigday
			#     6.41229669     3.14674028    -0.02522479

			####### (2) prepare for covariate data ###############################

			pkyDAT = DAT[,grep("PY",colnames(DAT))]
				# > pkyDAT[1:3,]
				#      PY.45    PY.46    PY.47    PY.48    PY.49    PY.50    PY.51    PY.52    PY.53    PY.54   PY.55    PY.56    PY.57    PY.58   PY.59
				# 1  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.0000  0.00000  0.00000  0.00000  0.0000
				# 2  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.0000  0.00000  0.00000  0.00000  0.0000
				# 3 28.05376 29.02023 29.98116 30.93657 31.88644 32.83078 33.76959 34.70287 35.63061 36.55282 37.4695 38.38065 39.28627 40.18635 41.0809
				#      PY.60   PY.61    PY.62    PY.63    PY.64    PY.65    PY.66    PY.67    PY.68    PY.69    PY.70    PY.71    PY.72    PY.73    PY.74
				# 1  0.00000  0.0000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000
				# 2  0.00000  0.0000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000

				# > BMIdat[1:5,]
				#     BMI.45   BMI.46   BMI.47   BMI.48   BMI.49   BMI.50   BMI.51   BMI.52   BMI.53   BMI.54   BMI.55   BMI.56   BMI.57   BMI.58
				# 1 30.08999 30.04544 30.00089 29.95634 29.91179 29.86709 29.82145 29.77393 29.72360 29.66952 29.61076 29.54637 29.47542 29.39698
				# 2 29.12122 29.07667 29.03212 28.98757 28.94302 28.89832 28.85267 28.80516 28.75483 28.70075 28.64199 28.57760 28.50665 28.42820
				# 3 27.27928 27.23138 27.18170 27.13030 27.07723 27.02238 26.96503 26.90430 26.83930 26.76915 26.69297 26.60987 26.51897 26.41938
				# 4 27.73235 27.68628 27.63839 27.58871 27.53731 27.48408 27.42830 27.36908 27.30554 27.23679 27.16195 27.08015 26.99049 26.89209
				# 5 27.54256 27.48599 27.42780 27.36806 27.30680 27.24395 27.17875 27.11034 27.03782 26.96032 26.87695 26.78683 26.68907 26.58279

			mydat.big = data.frame(cbind(data0, pkyDAT, BMIdat))
				# > mydat.big[1:10,]
				#    race     edu     PY.45     PY.46     PY.47     PY.48     PY.49     PY.50     PY.51     PY.52     PY.53     PY.54     PY.55     PY.56
				# 1     B  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 2     W  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 3     W college 28.053756 29.020226 29.981163 30.936569 31.886442 32.830783 33.769592 34.702868 35.630612 36.552824 37.469504 38.380651
				# 4     B  <=high 27.403327 28.369797 29.330735 30.286140 31.236013 32.180354 33.119163 34.052439 34.980184 35.902395 36.819075 37.730223
				# 5     W  <=high 24.382102 25.076264 25.757649 26.426256 27.082086 27.725139 28.355413 28.972911 29.577631 30.169573 30.748738 31.315125
				# 6     W  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 7     H  <=high 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535
				# 8     H  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 9     W  <=high  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161
				# 10    W  <=high 33.435355 34.653188 35.858235 37.050496 38.229970 39.396659 40.550562 41.691679 42.820009 43.935554 45.038312 46.128285

			### smoking status change ##

			smkDAT[1:10,1:10]
			#      STAT.45   STAT.46   STAT.47   STAT.48   STAT.49   STAT.50   STAT.51   STAT.52   STAT.53   STAT.54
			#  [1,] "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"
			#  [2,] "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"
			#  [3,] "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current"
			#  [4,] "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current"
			#  [5,] "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current"
			#  [6,] "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"
			#  [7,] "Former"  "Former"  "Former"  "Former"  "Former"  "Former"  "Former"  "Former"  "Former"  "Former"
			#  [8,] "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"
			#  [9,] "Former"  "Former"  "Former"  "Former"  "Former"  "Former"  "Former"  "Former"  "Former"  "Former"
			# [10,] "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current"

			cpdDAT[1:10,1:10]
			# > cpdDAT[1:10,1:10]
			#         CPD.45   CPD.46   CPD.47   CPD.48   CPD.49   CPD.50   CPD.51   CPD.52   CPD.53   CPD.54
			#  [1,]  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000
			#  [2,]  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000
			#  [3,] 19.44004 19.32940 19.21875 19.10811 18.99746 18.88682 18.77617 18.66553 18.55488 18.44424
			#  [4,] 19.44004 19.32940 19.21875 19.10811 18.99746 18.88682 18.77617 18.66553 18.55488 18.44424
			#  [5,] 14.13879 13.88324 13.62769 13.37215 13.11660 12.86105 12.60550 12.34995 12.09440 11.83885
			#  [6,]  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000
			#  [7,]  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000
			#  [8,]  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000
			#  [9,]  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000
			# [10,] 24.61238 24.35666 24.10094 23.84522 23.58950 23.33378 23.07805 22.82233 22.56661 22.31089

			durDAT[1:10,1:10] # cigyear
			#    DUR.45 DUR.46 DUR.47 DUR.48 DUR.49 DUR.50 DUR.51 DUR.52 DUR.53 DUR.54
			# 1       0      0      0      0      0      0      0      0      0      0
			# 2       0      0      0      0      0      0      0      0      0      0
			# 3      30     31     32     33     34     35     36     37     38     39
			# 4      29     30     31     32     33     34     35     36     37     38
			# 5      33     34     35     36     37     38     39     40     41     42
			# 6       0      0      0      0      0      0      0      0      0      0
			# 7      22     22     22     22     22     22     22     22     22     22

			FH.status[1:10,1:5]
			#       FH.45 FH.46 FH.47 FH.48 FH.49
			#  [1,]     1     1     1     1     1
			#  [2,]     0     0     0     0     0
			#  [3,]     0     0     0     0     0
			#  [4,]     1     1     1     1     1
			#  [5,]     0     1     1     1     1
			#  [6,]    NA    NA    NA    NA    NA
			#  [7,]    NA    NA    NA    NA    NA
			#  [8,]     0     0     0     0     0
			#  [9,]     0     1     1     1     1
			# [10,]     0     0     0     0     0


			# mycoef=coef.fh
			# ns.mat.age = OUT.fh$ns.mat.age
			# ns.mat.pky = OUT.fh$ns.mat.pky

			######### (3) Predict the probability for age = 45:90 ###############################

			for(j in 1:length(ages)){

				################ (a) make design matrix for each age #######
				# 	> coef.adj
				#    (Intercept)             fh    ns(age, 4)1    ns(age, 4)2    ns(age, 4)3    ns(age, 4)4     educollege     edupostcol
				#    -1.75191387     0.17092388     0.08191215     0.41608891     0.51726281     0.56661253    -0.26859716    -0.25444026
				#          raceA          raceB          raceH    ns(bmi, 3)1    ns(bmi, 3)2    ns(bmi, 3)3 cigstatCurrent  cigstatFormer
				#    -0.38035367     0.18258225    -0.25465492    -0.54750785    -1.81169289     1.04942856     0.12205001     0.20551756
				#    ns(pky, 2)1    ns(pky, 2)2         cigday
				#     6.41229669     3.14674028    -0.02522479
				# >

				ag=ages[j];ag

				### extract covariate column name that change by age!
				bminame=paste("BMI",ag,sep=".")
				pkname=paste("PY",ag,sep=".")
				cpdname=paste("CPD",ag,sep=".")
				cigname=paste("STAT",ag,sep=".")
				durname=paste("DUR",ag,sep=".")
				fhname=paste("FH",ag,sep=".")

				# > pkname
				# [1] "PY.45"
				# > bminame
				# [1] "BMI.45"

				### covariates data ###


				mydat.sm0 = data.frame(fh=FH.status[,fhname],  age=rep(ag,nrow(cigdat0)), edu=data0[,"edu"], race=data0[,"race"],
					bmi=mydat.big[,bminame],cigstat=smkDAT[,cigname], pky=mydat.big[,pkname], cigday=cpdDAT[,cpdname], cigyears=durDAT[,durname] )
				# > mydat.sm0[1:10,]
				#    fh age    edu race      bmi cigstat       pky   cigday
				# 1   1  45 <=high    W 29.12122   Never  0.000000  0.00000
				# 2   0  45 <=high    H 28.89886   Never  0.000000  0.00000
				# 3   0  45 <=high    W 27.68076 Current 28.053756 19.44004
				# 4   1  45 <=high    B 27.73235 Current 27.403327 19.44004
				# 5   0  45 <=high    H 27.63347 Current 24.382102 14.13879
				# 6  NA  45 <=high    W 29.12122   Never  0.000000  0.00000
				# 7  NA  45 <=high    W 28.99155  Former 43.645535  0.00000
				# 8   0  45 <=high    B 30.08999   Never  0.000000  0.00000
				# 9   0  45 <=high    W 28.09225  Former  0.107161  0.00000
				# 10  0  45 <=high    W 27.79499 Current 33.435355 24.61238


				#################### (b) predict using the regression output ###########################
				# > coef(glm.ph)
				#  (Intercept)  ns(age, 3)1  ns(age, 3)2  ns(age, 3)3        raceA        raceB        raceH  ns(bmi, 2)1  ns(bmi, 2)2          pky
				# -3.494087943  0.775599266  0.465300813  0.727633924 -1.134807420 -0.519480798 -0.170029629 -1.098434095  1.524776802  0.005378612

				pr0=predict(glm.copd, newdata=mydat.sm0)
				pr0[1:5]
				#        1         2         3         4         5
				# -3.591972 -4.022918 -3.032487 -2.701821 -3.289863

				pr=pr0

				# > sum(is.na(pr0))/length(pr0)
				# [1] 0.11244       ----> died early


				prob0 = exp(pr0)/(1+exp(pr0))
		mean(prob0,na.rm=T)
				# > mean(prob0)
				# [1] 0.03796671

				sum(prob0,na.rm=T)/sum(!is.na(prob0))
				#[1] 0.04871766

				#### predict using calibrated parameters -----without manual calibration #####


				# > cbind(coef.before,coef.adj)
				#              coef.before     coef.adj
				# (Intercept) -2.809877361 -2.191704342
				# age          0.008341419  0.008341419
				# educollege  -0.332164998 -0.332164998
				# edupostcol  -0.122890946 -0.122890946
				# raceA       -0.273522164 -0.273522164
				# raceB        0.189874305  0.189874305
				# raceH        0.039115084  0.039115084
				# ns(bmi, 3)1  0.343033939  0.343033939
				# ns(bmi, 3)2 -0.259201973 -0.259201973
				# ns(bmi, 3)3  1.774924396  1.774924396
				# cigyears     0.011828153  0.011828153
				# pky          0.025526378  0.025526378
				# cigday      -0.018510667 -0.018510667
				# >

			glm.copd$coefficients = coef.adj

			######## secondary calibration---prevalence too high...
			if(cohort==1960){

				if(Gender=="F"){
				######## secondary calibration---prevalence too high...

				glm.copd$coefficients[1] = coef.adj[1]*1.35
				glm.copd$coefficients[2] = coef.adj[2]*1.55

				   #glm.ph$coefficients[3] = coef.before[3]*1

				}#end of Gender==M

				if(Gender=="M"){

				glm.copd$coefficients[1] = coef.before[1]*0.8
				   #glm.ph$coefficients[3] = coef.before[3]*1

				}#end of Gender==M



		    }#end of

			if(cohort==1950){

				if(Gender=="M"){

				glm.copd$coefficients[1] = coef.before[1]*0.8
				   #glm.ph$coefficients[3] = coef.before[3]*1

				}#end of Gender==M


				if(Gender=="F"){
				######## secondary calibration---prevalence too high...


				glm.copd$coefficients[1] = coef.adj[1]*1.35
				glm.copd$coefficients[2] = coef.adj[2]*1.55

				   #glm.ph$coefficients[3] = coef.before[3]*1

				}#end of Gender==M

		    }#end of

				pr=predict(glm.copd, newdata=mydat.sm0)
				pr[1:5]
				#         1         2         3         4         5
				# -2.843581 -3.007956 -2.650827 -3.175521 -2.839019
				# > mean(pr0)
				# [1] -4.228715
				# > mean(pr1)
				# [1] -4.228715

				### risk ####

				prob = exp(pr)/(1+exp(pr))
				# > prob[1:5]
				#         1         2         3         4         5
				# 0.1227892 0.1236990 0.1208236 0.1365458 0.1365026
				# > (exp(pr0)/(1+exp(pr0)))[1:5]
				#          1          2          3          4          5
				# 0.08814469 0.08882373 0.08667888 0.09845549 0.09842296

				mean(prob,na.rm=T)
				# > mean(prob1)
				# [1] 0.05566851

				sum(prob,na.rm=T)/sum(!is.na(prob))
				#
				# [1] 0.08122933
				# >
				 if(j==1) COPD.prev = prob
				 if(j>1) COPD.prev= cbind(COPD.prev, prob)

	#				 print(ag)

				}#end of ages


			colnames(COPD.prev)=paste("COPD",ages,sep=".")
			# > COPD.prev[1:10,]
			#       COPD.45    COPD.46    COPD.47    COPD.48    COPD.49    COPD.50    COPD.51    COPD.52    COPD.53    COPD.54    COPD.55
			# 1  0.04637677 0.04636497 0.04635334 0.04634187 0.04633057 0.04632076 0.04631907 0.04633347 0.04637196 0.04644261 0.04655363
			# 2  0.03063742 0.03063005 0.03062279 0.03061564 0.03060860 0.03060257 0.03060200 0.03061227 0.03063881 0.03068710 0.03076275
			# 3  0.07842184 0.08120097 0.08403321 0.08691825 0.08985575 0.09284808 0.09590893 0.09905672 0.10231228 0.12297851 0.12702030
			# 4  0.10590026 0.10955577 0.11327329 0.11705191 0.12089070 0.12479218 0.12877348 0.13285757 0.13707027 0.14144050 0.14600063
			# 5  0.06172459 0.07459586 0.07681311 0.07904781 0.08129892 0.08356790 0.08586654 0.08821076 0.09061845 0.09310970 0.09570703
			# 6          NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA
			# 7          NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA
			# 8  0.04800016 0.04798435 0.04796871 0.04795324 0.04793793 0.04792416 0.04791869 0.04792967 0.04796529 0.04803381 0.04814359
			# 9  0.04706260 0.05534384 0.05533894 0.05533488 0.05533169 0.05533104 0.05534102 0.05537146 0.05543230 0.05553371 0.05568617
			# 10 0.08311747 0.08690448 0.09077485 0.09472653 0.09875738 0.10286811 0.10707182 0.11138707 0.11583539 0.12044157 0.12523401
			#       COPD.56    COPD.57    COPD.58    COPD.59    COPD.60    COPD.61    COPD.62    COPD.63    COPD.64    COPD.65    COPD.66
			# 1  0.04671342 0.04693076 0.04721489 0.04759061 0.04814443 0.04898351 0.05022559 0.05196235 0.05412320 0.05658314 0.05919485
			# 2  0.03087152 0.03101945 0.03121288 0.03711673 0.03755826 0.03822622 0.03921410 0.04059524 0.04231500 0.04427551 0.04636068
			# 3  0.13127053 0.13576694 0.14055234 0.14571580 0.15152392 0.15832150 0.16650460 0.17640644 0.18787213 0.20055350 0.21400535
			# 4  0.15078696 0.15584030 0.16120670 0.16698346 0.17346516 0.18103067 0.19011125 0.20106191 0.21369257 0.22760145 0.24228608
			# 5  0.09843582 0.10132473 0.10440638 0.10774904 0.11155734 0.11609521 0.12166650 0.12852954 0.13657129 0.14553273 0.15507925
			# 6          NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA
			# 7          NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA
			# > colSums(is.na(COPD.prev))/nrow(COPD.prev)
			# COPD.45 COPD.46 COPD.47 COPD.48 COPD.49 COPD.50 COPD.51 COPD.52 COPD.53 COPD.54 COPD.55 COPD.56 COPD.57 COPD.58 COPD.59
			# 0.11244 0.11681 0.12163 0.12611 0.13110 0.13612 0.14136 0.14674 0.15221 0.15809 0.16455 0.17067 0.17814 0.18607 0.19394
			# COPD.60 COPD.61 COPD.62 COPD.63 COPD.64 COPD.65 COPD.66 COPD.67 COPD.68 COPD.69 COPD.70 COPD.71 COPD.72 COPD.73 COPD.74
			# 0.20279 0.21266 0.22265 0.23414 0.24630 0.26022 0.27413 0.28947 0.30561 0.32131 0.33820 0.35543 0.37329 0.39256 0.41339
			# COPD.75 COPD.76 COPD.77 COPD.78 COPD.79 COPD.80 COPD.81 COPD.82 COPD.83 COPD.84 COPD.85 COPD.86 COPD.87 COPD.88 COPD.89
			# 0.43441 0.45737 0.48147 0.50739 0.53323 0.56128 0.58960 0.61905 0.64874 0.67913 0.70940 0.73962 0.76890 0.79767 0.82494
			# COPD.90
			# 0.84908
			#

			### this exclude NA (deaths) from the denominator

			meanCOPD=apply(COPD.prev,2,mean,na.rm=T);meanCOPD
			# > apply(COPD.prev,2,mean,na.rm=T)
			#    COPD.45    COPD.46    COPD.47    COPD.48    COPD.49    COPD.50    COPD.51    COPD.52    COPD.53    COPD.54    COPD.55
			# 0.06452217 0.06625282 0.06796354 0.06963156 0.07131046 0.07292076 0.07454969 0.07620813 0.07785771 0.07947611 0.08122933
			#    COPD.56    COPD.57    COPD.58    COPD.59    COPD.60    COPD.61    COPD.62    COPD.63    COPD.64    COPD.65    COPD.66
			# 0.08301483 0.08475472 0.08666335 0.08873091 0.09092422 0.09353008 0.09684331 0.10092008 0.10561578 0.11087742 0.11617726
			#    COPD.67    COPD.68    COPD.69    COPD.70    COPD.71    COPD.72    COPD.73    COPD.74    COPD.75    COPD.76    COPD.77
			# 0.12130277 0.12593370 0.13009530 0.13402388 0.13738295 0.14048101 0.14323707 0.14568775 0.14807032 0.15021389 0.15209667
			#    COPD.78    COPD.79    COPD.80    COPD.81    COPD.82    COPD.83    COPD.84    COPD.85    COPD.86    COPD.87    COPD.88
			# 0.15421867 0.15637383 0.15797382 0.15987598 0.16220188 0.16400830 0.16553358 0.16730530 0.16933026 0.17150138 0.17359536
			#    COPD.89    COPD.90
			# 0.17491575 0.17608344
			#

			# > 			mean(COPD.prev[,"COPD.55"],na.rm=T)
			# [1] 0.08122933
			# > 			ref.copd
			# [1] 7.4


			# > 			mean(FH.prev[,"FH.55"])
			# [1] 0.07823437 --> 2
			# > 			ref.fh
			# [1] 6.14

			meancopd55=mean(COPD.prev[,"COPD.55"],na.rm=T)


			############ (4) barplot compare to the reference data (age = 55) #############

			  par(mar=c(5,5,5,3))
				#ref.fh.ci = c(9.74, 11.90)
			   ci1=ref.copd.ci[1]
			   ci2=ref.copd.ci[2]

			   mat=cbind(ref.copd, meancopd55*100)
			   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="COPD prevalence (%)",
			   main="Prevalence (%) of COPD (age 55)", cex.main=1.5, ylim=c(0,15))

			   ##### confidence interval ###
			   xs = c(1.5,2.5)#,7.5)

			   for(u in 1:length(xs)){


			   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

			   }#end of

			  legend(x="topleft", legend=c("Reference", "Simulated prob-based"), fill=c("red","yellow"), ncol=2,cex=1)


			####### time trajectory ########

			meanCOPD = apply(COPD.prev,2,mean,na.rm=T)
			# > meanFH
			#      FH.45      FH.46      FH.47      FH.48      FH.49      FH.50      FH.51      FH.52      FH.53      FH.54      FH.55      FH.56
			# 0.09780466 0.09885175 0.09990097 0.10095306 0.10200860 0.10306418 0.10410599 0.10511748 0.10607988 0.10697485 0.10778478 0.10849102
			#      FH.57      FH.58      FH.59      FH.60      FH.61      FH.62      FH.63      FH.64      FH.65      FH.66      FH.67      FH.68
			# 0.10907303 0.10951272 0.10979188 0.10989170 0.10979693 0.10949308 0.10897003 0.10824487 0.10733795 0.10627236 0.10506911 0.10375099
			par(mar=c(5,6,5,3))
			plot(ages,100*meanCOPD,pch=16, ylim=c(0,25),col="blue",
			main="(Simulated probability-based) \n COPD prevalence (%)",
				xlab="Age",ylab="COPD prevalence (%) \nPr(COPD=1 | age, race, edu, FH, smoking, BMI)",cex.lab=1.5,cex.main=1.5, cex.axis=1.5)

			abline(v=55, lty="dotted",col="red")
			abline(h=ref.copd, lty="dotted",col="red")


			##### adding CDC points ###

		#			par(mar=c(5,6,5,3))
		#			plot(ages,100*meanCOPD,pch=16, ylim=c(0,25),col="blue",
		#			main="(Simulated probability-based) \n COPD prevalence (%)",
		#				xlab="Age",ylab="COPD prevalence (%) \nPr(COPD=1 | age, race, edu, FH, smoking, BMI)",cex.lab=1.5,cex.main=1.5, cex.axis=1.5)
		#
		#			abline(v=55, lty="dotted",col="red")
		#			abline(h=ref.copd, lty="dotted",col="red")
		#
		#			xx=c(55, 75)
		#			yy=c(7.4, 11.9)
		#			points(xx,yy,pch=17,col="red")
		#
		#
	#			legend(x="topleft", legend=c("CDC", "Model"), fill=c("red","blue"),cex=1.2)





			############# (5) visualize the results ##############

			########## not as informative: will use COPD status below for better presesntation #######
			doPlot=F
			if(doPlot==T){
						#setwd(outdir)
					#pdf("COPD.trajectories.500_female.pdf")

						kk=500
						par(mar=c(5,6,5,3))

						for(u in 1:kk){

							rcc=as.character(mydat.sm[u,"race"])
							ed=as.character(mydat.sm[u,"edu"])

								plot(ages,100*COPD.prev[u,],pch=16, ylim=c(0,35),col="blue",
									main=paste("Subject ID=",u,"\n(gender=",Gender,", race=",rcc," & edu=",ed,")",  sep=""),
										xlab="Age",ylab="COPD prevalence (%) \nPr(COPD=1 | age, race, edu, FH, smoking, BMI)",cex.lab=1.5,cex.main=1.5, cex.axis=1.5)

							   points(ages,pkyDAT[u,paste("PY",ages,sep=".")],pch=17, col=(1:kk)[u])


							#legend(x="topleft",legend=c("BMI","Cig/day"),pch=c(16,18), col=c("blue","red"),cex=1.2,lty=c("solid","dotted"))
							}

							#points(ages,BMIdat[u,],pch=16, col=(1:kk)[u])

				  dev.off()

			}#end of if(doPlot==T){


			################# [4.2] Simulating PH = 0 or 1 using the above simulated Pr(FH=1 | age, smoking, BMI) for each individual over 45:90 #################

			COPD.status= NULL

			####### OCM age of individuals #######
			# > DAT[1:3,1:10]
			#   X race gend birth_yr age_init age_cess age_death_OC quintile age_smoke1     CPD1
			# 1 1    0    0     1950     -999     -999           77       NA         NA       NA
			# 2 2    0    0     1950     -999     -999           87       NA         NA       NA
			# 3 3    0    0     1950       15     -999           67        3         15 4.926697

			ageOCM = DAT[,"age_death_OC"]
				# > ageOCM[1:5]
				# [1] 77 87 67 89 82
			# > range(ageOCM)
			# [1] -999   99    -999 means don't die until age 99 ##

			ageOCM[ageOCM == -999] = 100
			range(ageOCM)
			#[1]   0 100

			## major input: FH.prev

			#set.seed(5)

			max.age = ages[order(meanCOPD,decreasing=T)[1]]
			max.copd = meanCOPD[order(meanCOPD,decreasing=T)[1]]
			max.age;max.copd
			# [1] 60
			# > max.ph
			#     FH.60
			# 0.1098917
			# >
			#[1] 0.1098917
			#seeds = runif(1,1000000, length(ages)*

			#for(u in 1:16){
			for(u in 1:length(ages)){

					copd.update= rep(NA, N)

					ag=ages[u];ag

					cname = paste("COPD",ag,sep=".");cname
					mat.pr=COPD.prev[,cname]
					# > pr[1:5]
					#          1          2          3          4          5
					# 0.09823288 0.09823288 0.06662215 0.10876315 0.10872762
							dim(mat.pr)=c(length(mat.pr),1)
							x=mat.pr[1,]
							samp.sm = function(x) sample(c(0,1), size=1, prob = c(1-x, x))

							samp.sm2 = function(x) {

								ans=NULL

								if(is.na(x)==F) ans=sample(c(0,1), size=1, prob = c(1-x, x))
								if(is.na(x)==T) ans=NA

								ans
							}#end of



					######## (step 1) At age = 45, just sample 0/1 from the given predicted probability ####

					if(ag==45){  # this is same as u==1

							###### (1) sampling ############

							#set.seed(u)

							copd0=apply(mat.pr, 1, samp.sm2)
							 mean(copd0,na.rm=T)
							# [1] 0.09801
							# > fh0[1:10]
							#  [1] 0 0 0 0 1 0 0 0 0 1

							# > ph0[1:10]
							#  [1]  0  0  0  1  0 NA NA  0  0  0

					}#end of 45

					#####(step 2) From age > 45, among only people who have ph = 0, sample more 0/1 until the mean(Ph) (prevalence) reaches for the PH.prev[,46]
								######### repeat this until the maximum prevalence age ###

					if(ag > 45 ){

							### (1) take the previous year's fh status ###

							copd0 = ANS[,u-1] #
							#fh.previous = ANS[,u-1] #
							# > fh.previous[1:10]
							#  [1]  0  0  0  0  1 NA NA  0  0  0


					}#end of if(u > 45 and u <= max.age){



					#####(2) impose OCM ###########

	ix.dead = is.na(copd0)==T | ageOCM <= ag # identify who died prevous y
	#ix.dead = is.na(copd0)==F & ageOCM <= ag # identify who did die prevous y



						sum(ix.dead)
						#[1] 556 additional
						# > sum(ix.dead)/length(ix.dead)
						#[1] 0.11244    ----> why 11% die before 45? hmm...

						#ageOCM[ix.dead]
						# hist(ageOCM[ix.dead])

					copd = copd0
						#sum(fh[ix.dead],na.rm=T)/ sum(fh==1,na.rm=T)
						# > 	sum(fh[ix.dead])/ sum(fh==1)
						# [1] 0.1132537   ---> OK 10% of fh=1 at 45 died already

					copd[ix.dead]=NA

					##### (3) updated case status with OCM information : total population N is the initial population size

					## number of people alive by the time (people at risk)
					N.risk =  sum(!ix.dead); N.risk
					prev.before= sum(is.na(copd)==F & copd==1)/N.risk
					#prev.before= sum(is.na(ph)==F & ph==1)/N
					prev.before
					#[1] 0.03035

					myref= mean(COPD.prev[,cname],na.rm=T)
					myref
					#[1] [1] 0.0330077


					dif = myref - prev.before; dif  # should it be always positive? yes because initial population stays the same
					# > dif
					# [1] 0.01089466

					n.require = ceiling(dif * N.risk)
					#n.require = ceiling(dif * N)
					n.require
						#[1] 1090 # recruit 1090 more
	#					print(paste("n.require=",n.require,sep=""))

					#### if there is at least one more case to recruit, do more sampling ###

					if(n.require > 0){


							##### (4) sample additional more among who don't have FH=1 ########

							case = copd
							mat.prob = mat.pr

							#set.seed(u+1000*u)

				copd.update0 = mySampleMore2(case, mat.prob, n.require)
							# > names(ph.update0)
							# [1] "case.update" "prev.update"

							copd.update = copd.update0$case.update

							prev.aft= sum(is.na(copd.update)==F & copd.update==1)/N.risk
							prev.aft
							#[1] 0.09697
							myref

		# 							print(paste("age=",ag,sep=""))
		# 							print(paste("model average prev=",round(mean(COPD.prev[,cname],na.rm=T),3),sep=""))
	# 							print(paste("Simulated binary COPD proportion (updated)=", round(prev.aft,3),sep=""))


					}#

					### if less than 1 required to sample, don't sample

					if(n.require <= 0)  {

					     copd.update = copd

					}


					#####(step 3) From age >= max.age, no more sampling of PH = 1 because FH prevalence is decreasing ###########


				 if(u==1){
				 		ANS = copd.update; dim(ANS)=c(length(copd.update),1)
				 		N.require = n.require

				 }

				 if(u>1){

					 	 ANS = cbind(ANS,copd.update)
					 	 N.require = c(N.require, n.require)


				 }# end of


		}#end of for(u in 1:length(ages)){

		colnames(ANS)=paste("COPD.",ages,sep="")
		colnames(ANS)=paste("COPD.",ages,sep="")

		# > ANS[1:50,]
			#      PH.45 PH.46 PH.47 PH.48 PH.49 PH.50 PH.51 PH.52 PH.53 PH.54 PH.55 PH.56 PH.57 PH.58 PH.59 PH.60 PH.61 PH.62 PH.63 PH.64 PH.65 PH.66 PH.67 PH.68 PH.69
			#  [1,]     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			#  [2,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1
			#  [3,]     0     0     0     0     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1     1     1    NA    NA    NA
			#  [4,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1     1     1     1
			#  [5,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0
			#  [6,]    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			#  [7,]    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			#  [8,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1
			#  [9,]     0     0     0     0     0     0     0     0     0     0     1    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [10,]     0     0     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			# [11,]     0     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			# [12,]     0     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			# [13,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1     1     1
			# [14,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1
			# [15,]     0     0     0     0     0     0    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [16,]     0     0     0     0     0     0     0     0    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [17,]     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1     1
			# [18,]     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			# [19,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1    NA    NA    NA    NA    NA    NA    NA    NA
			# [20,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0
			# [21,]    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [22,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0
			# [23,]     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			# [24,]     0     0     0     0     0     0     0     1     1    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [25,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0
			# [26,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1
			# [27,]    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [28,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1     1
			# [29,]     0     0     0     0     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			#
		tt=cbind(DAT[,5:7],PY.55=DAT[,"PY.55"],BMI.55=mydat.big[,"BMI.55"], data0,round(PH.prev[,1:5],3), ANS)[1:20,]

		#setwd(outdir)
		#write.csv(tt,"PH.output.example.wo.OCM.csv")
		#write.csv(tt,"PH.output.example.with.OCM.csv")

		x=ANS[,1]
		dim(x)=c(length(x),1)
		#myprev = function(x){   sum(is.na(x)==F & (x==1))/ length(x) }
		myprev2 = function(x){   sum(is.na(x)==F & (x==1))/ sum(is.na(x)==F) }

		COPD.status = ANS


		prev.est = apply(COPD.status, 2, myprev2)
		prev.est
		#   PH.45   PH.46   PH.47   PH.48   PH.49   PH.50   PH.51   PH.52   PH.53   PH.54   PH.55   PH.56   PH.57   PH.58   PH.59   PH.60   PH.61   PH.62   PH.63
		# 0.03301 0.03536 0.03787 0.04055 0.04341 0.04645 0.04969 0.05312 0.05674 0.06056 0.06457 0.06876 0.07312 0.07764 0.08231 0.08710 0.09198 0.09693 0.10192
		#   PH.64   PH.65   PH.66   PH.67   PH.68   PH.69   PH.70   PH.71   PH.72   PH.73   PH.74   PH.75   PH.76   PH.77   PH.78   PH.79   PH.80   PH.81   PH.82
		# 0.10692 0.11193 0.11695 0.12196 0.12697 0.13198 0.13700 0.14204 0.14713 0.15227 0.15751 0.16285 0.16834 0.17396 0.17973 0.18566 0.19172 0.19794 0.20431
		#   PH.83   PH.84   PH.85   PH.86   PH.87   PH.88   PH.89   PH.90
		# 0.21084 0.21750 0.21700 0.20783 0.19451 0.17726 0.15828 0.13985

		meanCOPD = apply(COPD.prev, 2, mean,na.rm=T)
		#      PH.45      PH.46      PH.47      PH.48      PH.49      PH.50      PH.51      PH.52      PH.53      PH.54      PH.55      PH.56      PH.57      PH.58
		# 0.03300770 0.03535799 0.03786811 0.04054662 0.04340267 0.04644713 0.04968403 0.05311400 0.05673915 0.06055912 0.06456629 0.06875358 0.07311641 0.07763791
		#      PH.59      PH.60      PH.61      PH.62      PH.63      PH.64      PH.65      PH.66      PH.67      PH.68      PH.69      PH.70      PH.71      PH.72
		# 0.08230133 0.08709190 0.09197814 0.09692679 0.10191271 0.10691347 0.11192804 0.11694270 0.12195796 0.12696543 0.13197488 0.13699409 0.14203792 0.14712222
		#      PH.73      PH.74      PH.75      PH.76      PH.77      PH.78      PH.79      PH.80      PH.81      PH.82      PH.83      PH.84      PH.85      PH.86
		# 0.15226818 0.15750191 0.16284829 0.16833137 0.17395649 0.17972664 0.18565043 0.19171777 0.19793704 0.20430688 0.21083354 0.21749855 0.22432160 0.23128332
		#      PH.87      PH.88      PH.89      PH.90
		# 0.23839810 0.24565794 0.25307421 0.26063457

		#plot(ages, 100*prev.est, pch=18, cex=1.8, ylim=c(6,13), main="[Family History] Without OCM imposed \nSimulation vs. Model prediciton", cex.main=1.5,
		plot(ages, 100*prev.est, pch=18, cex=1.8, ylim=c(0,25), main="[COPD] With OCM imposed \nSimulation vs. Model prediciton", cex.main=1.5,

			col="red", xlab="Age", ylab="COPD prevalence (%)",cex.axis=1.5, cex.lab=1.5)
		points(ages, 100*meanCOPD, col="blue", pch=16)
		legend(x="topleft", legend=c("Simulated","Model-prediction"), col=c("red","blue"), pch=c(18,16))


		# 		plot(ages[1:41], (100*prev.est)[1:41], pch=18, cex=1.8, ylim=c(0,25), main="[COPD] With OCM imposed \nSimulation vs. Model prediciton", cex.main=1.5,
		#
		# 			col="red", xlab="Age", ylab="COPD prevalence (%)",cex.axis=1.5, cex.lab=1.5)
		# 		points(ages, 100*meanCOPD, col="blue", pch=16)
	# 		legend(x="topleft", legend=c("Simulated","Model-prediction"), col=c("red","blue"), pch=c(18,16))



		####### visualize ######


			doPlot=F
			if(doPlot==T){
					#setwd(outdir)
					pdf("COPD.status_trajectories.500_PY_added_FEMALE.pdf")

						kk=500
						par(mar=c(5,6,5,5))

						for(u in 1:kk){

							rcc=as.character(mydat.sm[u,"race"])
							ed=as.character(mydat.sm[u,"edu"])


								plot(ages, COPD.status[u,], pch=16, col="red",cex.lab=1.5,cex.main=1.5, cex.axis=1.5, xlab="Age", ylab="COPD Status (0 or 1)", ylim=c(0,2),
										main=paste("Subject ID=",u,"\n(gender=",Gender,", race=",rcc," & edu=",ed,")",  sep=""),axes=F)
								axis(1,cex.axis=1.5)
								axis(2,cex.axis=1.5)

								axis(4, at=seq(0,1.5, by=0.5), labels=seq(0,1.5, by=0.5)*100, cex.axis=1.5)
								lines(ages, COPD.status[u,], lty="dotted", col="red")
								mtext("Pack-Years", side=4, line=2.2, cex=1.5)

								### estimated probablity ###

								lines(ages,COPD.prev[u,]*10,pch=16, col="dark grey")#, lty="dotted")

								 abline(v=ageOCM[u]-1, col="blue", lty="dotted", lwd=1.5)
								 #points(0, ageOCM[u]



								### pk years ###

								lines(ages,pkdat[u,1:length(ages)]/100,lty="dotted", col="dark green")#, lty="dotted")
								points(ages,pkdat[u,1:length(ages)]/100,pch=18, col="dark green")#, lty="dotted")

								#### family history yes ###
								points(ages, FH.status[u,]*0.25, pch=19, col="purple")
							    lines(ages,FH.status[u,]*0.25,lty="dotted", col="purple")#, lty="dotted")



							#mtext("Cig/Day", side=4, line=2.2,cex=1.5)

								legend(x="topleft",legend=c("COPD status","Pack-years", "OCM age" , "FH (yes: 0.25 vs. no:0)"),pch=c(16,18, 16,19), col=c("red","dark green","blue", "purple"),cex=1.2,lty=c("solid","dotted", "dotted"))

							}

				  dev.off()

			}#end of if(doPlot==T){


			############ (4) barplot compare to the reference data (age = 55) #############

			 simph55 = prev.est["COPD.55"]#-0.002
			#0.10779

			  par(mar=c(5,5,5,3))
				#ref.fh.ci = c(9.74, 11.90)
				ci1=ref.copd.ci[1]
				ci2=ref.copd.ci[2]

			   mat=cbind(ref.copd, simph55*100)
			   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="COPD prevalence (%)",
			   main="Reference vs. Simulated \n Prevalence of COPD (age 55)", cex.main=1.5, ylim=c(0,15))

			   ##### confidence interval ###
			   xs = c(1.5,2.5)#,7.5)

			   for(u in 1:length(xs)){


			   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

			   }#end of

			  legend(x="topleft", legend=c("Reference", "Simulated-based"), fill=c("red","yellow"), ncol=2,cex=1)



			######## report output: education, race, COPD status, family history of lung cancer, BMI over ages ################

			DAT.out = cbind(DAT[,-c(1:2)], smkDAT, cpdDAT, durDAT,
						edu=educ, race=race,
						BMIdat,
						FH.status, PH.status,
						COPD.status)


		   output = data.frame(cbind(edu=educ, race=race,
						BMIdat,
						FH.status, PH.status,
						COPD.status))

		  smkDat = cbind(smkDAT, cpdDAT, durDAT)

		  inputDat = DAT[,-c(1:2)]



		  output = list(outputOnly = output, output_all = DAT.out)
		  output


}#end of whole function riskFactorGenerator








######### 4/6/2016: 2nd version: nonlinear effect for BMI, personal history included ########

riskFactorGenerator2=function(DAT, CIGDAT, Gender, PROB.edu.race, OUT.bmi, OUT.fh, OUT.ph, OUT.copd, ref.race, ref.edu, ref.bmi, ref.bmi.sd, ref.fh, ref.fh.ci, ref.ph, ref.ph.ci, ref.copd, ref.copd.ci, seed) {

      library(splines)
			N = nrow(DAT)
			AGES.bmi = AGES.copd = 45:100
			ages=45:90

			### other cause of mortality ##
			age.OCM = DAT[,"age_death_OC"]
			# > age.OCM[1:20]
			#  [1]   77   87   67   89   82   29   36 -999   56   78   87   94   83   81   51   53   84   76   62
			# [20]   91
			# > max(age.OCM)
			# [1] 99

			############## [1] From smoking history generator: decide smoking status at age: 60 (PLCO mean age) #####

			age_init = age_cess = smkstatus = pky = cigstop = NULL

			age.th = 60  # PLCO average age is 62

			age_init = DAT[,"age_init"]
			age_cess = DAT[,"age_cess"]

			## make smoking indicator for making "smkstatus" ##

			indic.current = age_init > 0 & (age_cess > age.th  | age_cess==-999) # started smoking, but quit after 60 or never quit
			sum(indic.current)/length(indic.current)
			#[1] 0.23275  # male

			indic.former = age_init > 0 & (age_cess <= age.th &  age_cess!=999) # started smoking, but quit before 60, and quit)
			sum(indic.former)/length(indic.former)
			#[1]  0.41673

			indic.never = age_init==-999
			sum(indic.never)/length(indic.never)
			#[1] 0.36609

			### smkstatus making (not so important later ignore this) ###
			smkstatus = rep(NA,nrow(DAT))
			smkstatus[indic.never]="Never"
			smkstatus[indic.former]="Former"
			smkstatus[indic.current]="Current"

			### obtain smoking status distribution ###

			TB.smk=table(smkstatus)/sum(table(smkstatus))
			TB.smk
			# current  former   never    MALE
			# 0.23275 0.40116 0.36609

			# smkstatus
			# Current  Former   Never    FEMALE
			# 0.17128 0.30737 0.52135


			#### obtain pack-years distribution ###

			pky0= DAT[, "PY.60"]
			#  [1]  0.000000  0.000000 41.969919 41.319490 33.452900  0.000000 43.645535  0.000000  0.107161
			# [10] 49.321486
			# > sum(is.na(pky0))
			# [1] 0

			### make category as used in model fitting ###
			pky=pky0
			pky[pky0 <=10] = "lst10"
			pky[pky0 > 10 & pky0<=30] ="10_30"
			pky[pky0 > 30 & pky0 <=60] = "30_60"
			pky[pky0 > 60 & pky0 <=100] = "60_100"
			pky[pky0>100]="gt100"

			TB.pky=table(pky)/length(pky); TB.pky
			# pky
			#   10_30   30_60  60_100   lst10    MALE
			# 0.21110 0.21102 0.06682 0.51106
			# pky
			#   10_30   30_60  60_100   lst10    FEMALE
			# 0.16092 0.12864 0.04292  0.66752


			### obtain year since quit reference distribution (needed for ##

			ysq0 = DAT[, "YSQ.60"]
			# > ysq0[1:10]
			#  [1] NA NA NA NA NA NA 11 NA 33 NA  ---> NA includes never smokers & those who NEVER QUIT smoking
			# > range(ysq0,na.rm=T)
			# [1]  1 35

			cigstop=ysq0
			cigstop[is.na(ysq0)==T  & smkstatus=="Never" ]="never"   # never smoker
			cigstop[is.na(ysq0)==T  & smkstatus!="Never"] = "0"   # those who are smokers but who didn't quit!
			cigstop[ysq0>0 & ysq0 <=20] = "0_20"
			cigstop[ysq0 >20 & ysq0<=40] = "20_40"
			cigstop[ysq0 >40 ] = "gt40"

			TB.cigstop = table(cigstop)/sum(table(cigstop)); TB.cigstop
			# cigstop
			#       0    0_20   20_40   never
			# 0.33119 0.20399 0.09873 0.36609    MALE
			# smkstatus
			# Current  Former   Never
			# 0.23275 0.40116 0.36609

			# cigstop
			#       0    0_20   20_40    gt40   never
			# 0.17899 0.15378 0.13326 0.01262 0.52135   FEMALE



			####### Time-varying smoking status variable ("Never", "Former", "Current")################
			### the plan is to use PY.60 and YSQ.60 for determning smoking status at age
			### if PY=0 never smoker. if PY > 0 and YSQ = integer, former smoker, if PY>0 and YSQ = NA, current smokers

			cpdDAT= smkDAT = NULL

			# > colnames(CIGDAT)
			#   [1] "cigday.45"   "cigyears.45" "cigstat.45"  "cigday.46"   "cigyears.46" "cigstat.46"  "cigday.47"   "cigyears.47"
			#   [9] "cigstat.47"  "cigday.48"   "cigyears.48" "cigstat.48"  "cigday.49"   "cigyears.49" "cigstat.49"  "cigday.50"
			#  [17] "cigyears.50" "cigstat.50"  "cigday.51"   "cigyears.51" "cigstat.51"  "cigday.52"   "cigyears.52" "cigstat.52"
			#  [25] "cigday.53"   "cigyears.53" "cigstat.53"  "cigday.54"   "cigyears.54" "cigstat.54"  "cigday.55"   "cigyears.55"
			#  [33] "cigstat.55"  "cigday.56"   "cigyears.56" "cigstat.56"  "cigday.57"   "cigyears.57" "cigstat.57"  "cigday.58"
			#  [41] "cigyears.58" "cigstat.58"  "cigday.59"   "cigyears.59" "cigstat.59"  "cigday.60"   "cigyears.60" "cigstat.60"
			#  [49] "cigday.61"   "cigyears.61" "cigstat.61"  "cigday.62"   "cigyears.62" "cigstat.62"  "cigday.63"   "cigyears.63"
			#  [57] "cigstat.63"  "cigday.64"   "cigyears.64" "cigstat.64"  "cigday.65"   "cigyears.65" "cigstat.65"  "cigday.66"
			#  [65] "cigyears.66" "cigstat.66"  "cigday.67"   "cigyears.67" "cigstat.67"  "cigday.68"   "cigyears.68" "cigstat.68"
			#  [73] "cigday.69"   "cigyears.69" "cigstat.69"  "cigday.70"   "cigyears.70" "cigstat.70"  "cigday.71"   "cigyears.71"
			#  [81] "cigstat.71"  "cigday.72"   "cigyears.72" "cigstat.72"  "cigday.73"   "cigyears.73" "cigstat.73"  "cigday.74"
			#  [89] "cigyears.74" "cigstat.74"  "cigday.75"   "cigyears.75" "cigstat.75"  "cigday.76"   "cigyears.76" "cigstat.76"
			#  [97] "cigday.77"   "cigyears.77" "cigstat.77"  "cigday.78"   "cigyears.78" "cigstat.78"  "cigday.79"   "cigyears.79"
			# [105] "cigstat.79"  "cigday.80"   "cigyears.80" "cigstat.80"  "cigday.81"   "cigyears.81" "cigstat.81"  "cigday.82"
			# [113] "cigyears.82" "cigstat.82"  "cigday.83"   "cigyears.83" "cigstat.83"  "cigday.84"   "cigyears.84" "cigstat.84"
			# [121] "cigday.85"   "cigyears.85" "cigstat.85"  "cigday.86"   "cigyears.86" "cigstat.86"  "cigday.87"   "cigyears.87"
			# [129] "cigstat.87"  "cigday.88"   "cigyears.88" "cigstat.88"  "cigday.89"   "cigyears.89" "cigstat.89"  "cigday.90"
			# [137] "cigyears.90" "cigstat.90"

			#### cig/day ###

			cpdDAT = CIGDAT[, paste("cigday",ages,sep=".")]
			# > cpdDAT[1:5,]
			#   cigday.45 cigday.46 cigday.47 cigday.48 cigday.49 cigday.50 cigday.51 cigday.52 cigday.53 cigday.54 cigday.55 cigday.56
			# 1   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
			# 2   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000   0.00000
			# 3  19.44004  19.32940  19.21875  19.10811  18.99746  18.88682  18.77617  18.66553  18.55488  18.44424  18.33359  18.22295
			# 4  19.44004  19.32940  19.21875  19.10811  18.99746  18.88682  18.77617  18.66553  18.55488  18.44424  18.33359  18.22295
			# 5  14.13879  13.88324  13.62769  13.37215  13.11660  12.86105  12.60550  12.34995  12.09440  11.83885  11.58330  11.32775

			colnames(cpdDAT) = paste("CPD",ages,sep=".")
			# > cpdDAT[1:3,]
			#     CPD.45  CPD.46   CPD.47   CPD.48   CPD.49   CPD.50   CPD.51   CPD.52   CPD.53   CPD.54   CPD.55   CPD.56  CPD.57
			# 1  0.00000  0.0000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.0000
			# 2  0.00000  0.0000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.0000
			# 3 19.44004 19.3294 19.21875 19.10811 18.99746 18.88682 18.77617 18.66553 18.55488 18.44424 18.33359 18.22295 18.1123


			#####  smking status ###

			smkDAT = CIGDAT[, paste("cigstat",ages,sep=".")]
			colnames(smkDAT) = paste("STAT",ages,sep=".")


			##### duration

			durDAT = CIGDAT[, paste("cigyears",ages,sep=".")]
			colnames(durDAT) = paste("DUR",ages,sep=".")



			# > apply(cpdDAT,2,mean)
			#    CPD.45    CPD.46    CPD.47    CPD.48    CPD.49    CPD.50    CPD.51    CPD.52    CPD.53    CPD.54    CPD.55    CPD.56
			# 7.5922353 7.3062705 7.0310721 6.7718705 6.5106941 6.2572710 6.0100960 5.7665547 5.5330708 5.3115650 5.0882541 4.8562935
			#    CPD.57    CPD.58    CPD.59    CPD.60    CPD.61    CPD.62    CPD.63    CPD.64    CPD.65    CPD.66    CPD.67    CPD.68
			# 4.6522870 4.4429827 4.2278071 4.0311627 3.8400750 3.6536040 3.4815768 3.2996842 3.1215587 2.9437294 2.7838964 2.6318721
			#    CPD.69    CPD.70    CPD.71    CPD.72    CPD.73    CPD.74    CPD.75    CPD.76    CPD.77    CPD.78    CPD.79    CPD.80
			# 2.4839936 2.3390477 2.2024739 2.0713340 1.9406032 1.8129006 1.6947242 1.6115403 1.5248580 1.4385521 1.3636188 1.2854213
			#    CPD.81    CPD.82    CPD.83    CPD.84    CPD.85    CPD.86    CPD.87    CPD.88    CPD.89    CPD.90
			# 1.2138764 1.1410440 1.0840038 1.0121003 0.9596245 0.8832636 0.8185037 0.7476369 0.6909738 0.6301528
			# > dim(cpdDAT)
			# [1] 100000     46

			# > ref.cpd.mean.55
			# [1] 5.088254



			## plan is to define smoking status at each age based on CPDXX (age 80, CPD89 value and age_init
			## if NA, currently non-smokers, but if age_init is not NA, former smokers

				# > DAT[,"CPD80"][1:10]
				#  [1]      NA      NA 16.1207      NA      NA      NA      NA      NA      NA      NA
				# > DAT[,"age_init"][1:10]
				#  [1] -999 -999   15   16   12 -999   17 -999   17   19


			# > colnames(DAT)
			#   [1] "X"            "race"         "gend"         "birth_yr"     "age_init"     "age_cess"     "age_death_OC"
			#   [8] "quintile"     "age_smoke1"   "CPD1"         "age_smoke2"   "CPD2"         "age_smoke3"   "CPD3"
			#  [99] "age_smoke46"  "CPD46"        "age_smoke47"  "CPD47"        "age_smoke48"  "CPD48"        "age_smoke49"
			# [106] "CPD49"        "age_smoke50"  "CPD50"        "age_smoke51"  "CPD51"        "age_smoke52"  "CPD52"
			# [113] "age_smoke53"  "CPD53"        "age_smoke54"  "CPD54"        "age_smoke55"  "CPD55"        "age_smoke56"
			# [120] "CPD56"        "age_smoke57"  "CPD57"        "age_smoke58"  "CPD58"        "age_smoke59"  "CPD59"
			# [127] "age_smoke60"  "CPD60"        "age_smoke61"  "CPD61"        "age_smoke62"  "CPD62"        "age_smoke63"
			# [134] "CPD63"        "age_smoke64"  "CPD64"        "age_smoke65"  "CPD65"        "age_smoke66"  "CPD66"
			# [141] "age_smoke67"  "CPD67"        "age_smoke68"  "CPD68"        "age_smoke69"  "CPD69"        "age_smoke70"
			# [148] "CPD70"        "age_smoke71"  "CPD71"        "age_smoke72"  "CPD72"        "age_smoke73"  "CPD73"
			# [155] "age_smoke74"  "CPD74"        "age_smoke75"  "CPD75"        "age_smoke76"  "CPD76"        "age_smoke77"
			# [162] "CPD77"        "age_smoke78"  "CPD78"        "age_smoke79"  "CPD79"        "age_smoke80"  "CPD80"
			# [169] "age_smoke81"  "CPD81"        "age_smoke82"  "CPD82"        "age_smoke83"  "CPD83"        "age_smoke84"
			# [176] "CPD84"        "age_smoke85"  "CPD85"        "age_smoke86"  "CPD86"        "age_smoke87"  "CPD87"
			# [183] "age_smoke88"  "CPD88"        "age_smoke89"  "CPD89"        "age_smoke90"  "CPD90"        "age_smoke91"
			# [190] "CPD91"        "age_smoke92"  "CPD92"        "age_smoke93"  "CPD93"        "age_smoke94"  "CPD94"
			# [281] "PY.73"        "PY.74"        "PY.75"        "PY.76"        "PY.77"        "PY.78"        "PY.79"
			# [288] "PY.80"        "PY.81"        "PY.82"        "PY.83"        "PY.84"        "PY.85"        "PY.86"
			# [295] "PY.87"        "PY.88"        "PY.89"        "PY.90"        "PY.91"        "PY.92"        "PY.93"
			# [302] "PY.94"        "PY.95"        "PY.96"        "PY.97"        "PY.98"        "PY.99"        "PY.100"


		 doThis=F
		 if(doThis==T){

			##### CPD77 is not age!!!!!!!
			#x=DAT[,"CPD77"]; y= DAT[,"age_init"]




			mySmkStatus.sm <- function(x,y){

			      ix.noCurSmk = is.na(x)==T   # NA, currently zero smok
			      ix.neverSmk = y==-999        #-999, never initiated smk

			      smkstat = rep(NA, length(x))

			      ### never smoker
			      smkstat[ix.noCurSmk==T & ix.neverSmk==T]="Never"
			      smkstat[ix.noCurSmk==T & ix.neverSmk==F]="Former"
			      smkstat[ix.noCurSmk==F & ix.neverSmk==F]="Current"

					# > table(smkstat)
					# smkstat
					# Current  Former   Never
					#    2927   60464   36609
					# > sum(table(smkstat))
					# [1] 100000
					# > prop.table(table(smkstat))
					# smkstat
					# Current  Former   Never
					# 0.02927 0.60464 0.36609
					# > table(smkstat,useNA="always")
					# smkstat
					# Current  Former   Never    <NA>
					#    2927   60464   36609       0


			}#mySmkStatus.sm


			#paste("CPD",

			}#do this

			####### make reference distributions to be used for calibration in PLCO model fittings ####

			doThis=F
			if(doThis==T){


				######### reference at age = 55 ##################



							## reference (age=50 to be used for COPD calibration)
				#ref.cigstop = c(0.37, 0.33, 0.2, 0.1, 0)  ; names(ref.cigstop)=c("never","cigstop.0", "cigstop.0_20", "cigstop.20_40",  "cigstop.gt40")
				# > ref.cigstop
				#         never     cigstop.0  cigstop.0_20 cigstop.20_40  cigstop.gt40
				#          0.37          0.33          0.20          0.10          0.00

				### reference (age=60 to be used for COPD calibration)
				ref.cigstop = c(0.37, 0.24, 0.19, 0.18, 0.02)  ; names(ref.cigstop)=c("never","cigstop.0", "cigstop.0_20", "cigstop.20_40",  "cigstop.gt40")

				# cigstop
				#       0    0_20   20_40    gt40   never
				# 0.24104 0.19040 0.18418 0.01829 0.36609

				### female ##
				ref.smk = c(0.52135, 0.30737,0.17128 ); names(ref.smk)=c("Never","Former","Current")
				ref.pky = c(0.66752 ,0.16092, 0.12864, 0.04292);names(ref.pky)=c("lst10", "10_30","30_60","60_100" )
				ref.cigstop = c(0.52135, 0.17899, 0.15378, 0.13326, 0.01262);names(ref.cigstop)=c("never","cigstop.0", "cigstop.0_20", "cigstop.20_40",  "cigstop.gt40")


	        }#end of



			############## [2] Assign education and race conditioning on smoking status: using Pr(edu, race | smoking status) ###################

		cat("Simulating education and race conditioning on smoking\n", sep="")

			edu.race0 = NULL

			# > PROB.edu.race  --> each column sums up to 1  (new)
			#                 Never      Former     Current
			# A-<=high  0.029740186 0.027025603 0.021492433
			# A-college 0.016958076 0.010772834 0.006650130
			# A-postcol 0.018568620 0.008734730 0.003439723
			# B-<=high  0.061486197 0.075818739 0.156613420
			# B-college 0.005305320 0.004425597 0.008026019
			# B-postcol 0.008431669 0.006230774 0.005962186
			# H-<=high  0.063572804 0.073064503 0.087410678
			# H-college 0.003505301 0.004309134 0.001605204
			# H-postcol 0.005305320 0.002969808 0.001834519
			# W-college 0.164543619 0.122896853 0.082930591
			# W-postcol 0.073103314 0.037704173 0.023918168
			# W-<=high  0.549479573 0.626047250 0.600116929
			# > colSums(PROB.edu.race)
			#   Never  Former Current
			#       1       1       1

			# > PROB.edu.race  --> each column sums up to 1
			#                 Never      Former     Current
			# A-<=high  0.018566097 0.014800494 0.011702345
			# A-college 0.029658838 0.016959562 0.011278914
			# A-postcol 0.033799932 0.013370632 0.006149116
			# B-<=high  0.070439032 0.071277125 0.149026204
			# B-college 0.011267360 0.006635478 0.012977099
			# B-postcol 0.015566571 0.008859252 0.007674597
			# H-<=high  0.056075187 0.054224294 0.072637778
			# H-college 0.007104640 0.006208510 0.002314815
			# H-postcol 0.009016896 0.004782629 0.003468208
			# W-college 0.157620308 0.109228065 0.081830842
			# W-postcol 0.058473874 0.027350069 0.016765308
			# W-<=high  0.532411267 0.666303888 0.624174774

			smknames=colnames(PROB.edu.race) #[1] "Never"   "Former"  "Current"
			edu.race0 = rep("",length(smknames))
			myout.edu.race = rep(list(list()),3);names(myout.edu.race)=smknames

      # the only seed setting in the whole thing
			set.seed(seed)

			### for each smoking status, simulate edu-race variables ####################
			for(j in 1:length(smknames)){

				smkname=smknames[j] #[1] "Never"
				indic = (smkstatus==smkname) # [1]  TRUE  TRUE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE


				## number of never smokers

				nn=sum(indic);nn #[1] 36609

				## pull out estimated distribution ##
				mydist= PROB.edu.race[,smkname]; names(mydist)=row.names(PROB.edu.race); mydist
				#    A-<=high   A-college   A-postcol    B-<=high   B-college   B-postcol    H-<=high   H-college
				# 0.018566097 0.029658838 0.033799932 0.070439032 0.011267360 0.015566571 0.056075187 0.007104640
				#   H-postcol   W-college   W-postcol    W-<=high
				# 0.009016896 0.157620308 0.058473874 0.532411267
				# > sum(mydist)
				# [1] 1

				### sample 36609 individuals given distribution ###

				prob=mydist
				### sample ##
				smp=sample(names(prob), size=nn, replace = T, prob = prob) #[1] "W-postcol" "W-<=high"  "W-<=high"  "W-college" "W-postcol" "A-<=high"

				### put them in a vector ##
				edu.race0[indic] = smp

				### compare it to original distribution #
				tt=table(smp)/length(smp)
				tt1=cbind(mydist, tt[names(mydist)]); colnames(tt1) = c("original","simulated")

				#print(tt1)
				#                mydist
				# A-<=high  0.018566097 0.018465405
				# A-college 0.029658838 0.029145838
				# A-postcol 0.033799932 0.034636292
				# B-<=high  0.070439032 0.070474473
				# B-college 0.011267360 0.010926275
				# B-postcol 0.015566571 0.016307465
				# H-<=high  0.056075187 0.057663416
				# H-college 0.007104640 0.007293289
				# H-postcol 0.009016896 0.008604442
				# W-college 0.157620308 0.158594881
				# W-postcol 0.058473874 0.059712093
				# W-<=high  0.532411267 0.528176132

				myout.edu.race[[j]] = tt1


			}#end of for(j in 1:length(smknames)){
			names(myout.edu.race)=smknames

			myout.edu.race
			# $Never
			#              original   simulated
			# A-<=high  0.018566097 0.018356142
			# A-college 0.029658838 0.028244421
			# A-postcol 0.033799932 0.032560299
			# B-<=high  0.070439032 0.071348575
			# B-college 0.011267360 0.010844328
			# B-postcol 0.015566571 0.015296785
			# H-<=high  0.056075187 0.056324947
			# H-college 0.007104640 0.006610396
			# H-postcol 0.009016896 0.009014177
			# W-college 0.157620308 0.156163785
			# W-postcol 0.058473874 0.057117102
			# W-<=high  0.532411267 0.538119042
			#
			# $Former
			#              original   simulated
			# A-<=high  0.014800494 0.015031409
			# A-college 0.016959562 0.017399541
			# A-postcol 0.013370632 0.012937481
			# B-<=high  0.071277125 0.071667165
			# B-college 0.006635478 0.006381494
			# B-postcol 0.008859252 0.007752518
			# H-<=high  0.054224294 0.056062419
			# H-college 0.006208510 0.006182072
			# H-postcol 0.004782629 0.004038289
			# W-college 0.109228065 0.109208296
			# W-postcol 0.027350069 0.027121348
			# W-<=high  0.666303888 0.666217968


			######### breaking into education and race ####################

			tt1=unlist(strsplit(edu.race0,split="\\-")) # [1] "W"       "<=high"  "B"       "<=high"  "W"       "<=high"  "A"       "postcol" "W"
			race=tt1[seq(1,length(tt1),by=2)]
			educ=tt1[seq(2,length(tt1),by=2)]

			TB.race = table(race)/sum(table(race))
			TB.race
			# race
			#       A       B       H       W
			# 0.04015 0.05039 0.02170 0.88776
			TB.edu = table(educ)/sum(table(educ))
			TB.edu
			# educ
			#  <=high college postcol
			# 0.60296 0.18542 0.21162
			## remove "<="
			names(TB.edu) = gsub("<=","",names(TB.edu))
		#educ = gsub("<=","", educ)


			####### plot comparing references vs. simulated ###

			TAB=TB.race[names(ref.race)]
			TB.race2=TB.race[names(ref.race)]
			barplot(TAB,col=(heat.colors(4)),ylim=c(0,1),main="[Simulated] Race Distribution",cex.axis=1.5,cex.lab=2,cex.main=1.5)
			text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")
			#axis(1, at=c(0.75,2), labels=c("Unadjusted", " Ref"),cex.axis=1.5)

			TAB=ref.race
			barplot(TAB,col=(heat.colors(4)),ylim=c(0,1),main="[Ref] Race Distribution",cex.axis=1.5,cex.lab=2,cex.main=1.5)
			text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")

			TAB=TB.edu[names(ref.edu)]
			TB.edu2=TB.edu[names(ref.edu)]
			barplot(TAB,col=(heat.colors(3)),ylim=c(0,1),main="[Simulated] Education Distribution",cex.axis=1.5,cex.lab=2,cex.main=1.5)
			text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")
			#axis(1, at=c(0.75,2), labels=c("Unadjusted", " Ref"),cex.axis=1.5)

			TAB=ref.edu
			barplot(TAB,col=(heat.colors(4)),ylim=c(0,1),main="[Ref] Education Distribution",cex.axis=1.5,cex.lab=2,cex.main=1.5)
			text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")


			########### Confidenece Interval. Estimated N = 1.8 mil for male and N=1.7 for women (ref: 1950_birthCohort_data_census_vsus_1950_1.pdf Table 6.06 ####

			############ CI for Race ###############

			ci.race= myCI_proportion(probs=TB.race2, n=10000)
			#     probs        ci1        ci2
			# W 0.76979 0.76153904 0.77804096
			# B 0.10133 0.09541540 0.10724460
			# H 0.07967 0.07436268 0.08497732
			# A 0.04921 0.04497040 0.05344960

			N.male = 1.7 * 10^6   #1.7 million
			### confidence interval for multinomial proportion ###

			ci.race2 = myCI_proportion(probs=ref.race, n=N.male)
			#   probs        ci1        ci2
			# W  0.76 0.75935799 0.76064201
			# B  0.10 0.09954902 0.10045098
			# H  0.08 0.07959218 0.08040782
			# A  0.05 0.04967237 0.05032763

			table(race)[names(ref.race)]
			#chisq.test(TB.race2,)


			####################### CI for education ################

			############ Education ###############
			cis=myCI_proportion(probs=TB.edu2, n=10000)
			#          probs       ci1       ci2
			# high    0.78115 0.7730461 0.7892539
			# college 0.14985 0.1428543 0.1568457
			# postcol 0.06900 0.0640323 0.0739677

			#### CI for actual census data is way to narrow
			cisb = myCI_proportion(probs=ref.edu, n=N.male)
			#         probs        ci1        ci2
			# high     0.78 0.77937728 0.78062272
			# college  0.15 0.14946323 0.15053677
			# postcol  0.07 0.06961645 0.07038355


			############# education comparing simulation vs. reference with CI from simulation ##########

		   par(mar=c(5,5,6,3))

		   mat=cbind(ref.edu, TB.edu2)
		   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="Relative Frequency",cex.main=1.5, ylim=c(0,1),main="[Education] Observed vs. simulated distribution")
		   #main="[Before Adjustment] \nAverage BMI (age 50) by race", )

			ci1 = cis[,2]
			ci2= cis[,3]

		   ##### confidence interval ###
		   xs = c(1.5,4.5,7.5) + 1

		   for(u in 1:length(xs)){

		   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

		   }#end of

		  legend(x="topright", legend=c("Reference", "Simulated"), fill=c("red","yellow"), ncol=2,cex=1.5)


			ttt=prop.test(cbind(ref.edu*N.male, TB.edu*10000))
			#
			# 	3-sample test for equality of proportions without continuity correction
			#
			# data:  cbind(ref.edu * N.male, TB.edu * 10000)
			# X-squared = 0.26251, df = 2, p-value = 0.877
			# alternative hypothesis: two.sided
			# sample estimates:
			#    prop 1    prop 2    prop 3
			# 0.9941441 0.9942179 0.9940997
			title(sub=paste("X-squared=",round(ttt$statistic,2), " (p=", round(ttt$p.value,2),")",sep=""))

			############# Race comparing simulation vs. reference with CI from simulation ##########
	   	    mat=cbind(ref.race, TB.race2)
		   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5, main="[Race] Observed vs. simulated distribution",
		   ylab="Relative Frequency",cex.main=1.5, ylim=c(0,1))
		   #main="[Before Adjustment] \nAverage BMI (age 50) by race", )

			ci1 = ci.race[,2]
			ci2= ci.race[,3]

		   ##### confidence interval ###
		   xs = c(1.5,4.5,7.5,10.5) + 1

		   for(u in 1:length(xs)){


		   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

		   }#end of

		  legend(x="topright", legend=c("Reference", "Simulated"), fill=c("red","yellow"), ncol=2,cex=1.5)

			ttt=prop.test(cbind(ref.race*N.male, TB.race2*10000))
			title(sub=paste("X-squared=",round(ttt$statistic,2), " (p=", round(ttt$p.value,2),")",sep=""))



			###### [3] Simulating BMI (over time) given smoking, age, education and race ##################################

	cat("Simulating BMI over age\n", sep="")

			### unadjusted (uncalibrated) coefficient

			lm.bmi = OUT.bmi$lm.bmi.original   # it can only predict based on lm object so i need to use original

			#if(Gender=="M") lm.bmi = OUT.bmi$lm.bmi.original
			#if(Gender=="F") lm.bmi = OUT.bmi$lm.bmi.coef.adj


			coef.bmi = coef(lm.bmi)
			# male
			#               (Intercept)                     raceA                     raceB                     raceH
			#             28.9430210153             -2.3216045642              0.9987353770             -0.2223563685
			#                educollege                edupostcol          ns(age, df = 4)1          ns(age, df = 4)2
			#             -0.8153890552             -1.2122167678             -0.9229637970             -1.4930552984
			#          ns(age, df = 4)3          ns(age, df = 4)4            cigstatCurrent             cigstatFormer
			#             -2.2324605728             -1.9825806052             -2.8781227204             -1.0289679250
			#          ns(cigyears, 2)1          ns(cigyears, 2)2            ns(cigday, 2)1            ns(cigday, 2)2
			#              1.6678793783             -0.2269712463              2.5254022935              2.4036181396
			#      raceA:cigstatCurrent      raceB:cigstatCurrent      raceH:cigstatCurrent       raceA:cigstatFormer
			#              1.1998860137             -0.9159395155              0.3132705606              0.1416375325
			#       raceB:cigstatFormer       raceH:cigstatFormer educollege:cigstatCurrent edupostcol:cigstatCurrent
			#             -0.6851827071              0.1484768861              0.4139030273              0.8881625412
			#  educollege:cigstatFormer  edupostcol:cigstatFormer
			#              0.0002494663              0.2398837786


			###############  per person need to predict BMI overtime from age 45 to 90 ################
			 ##### what varies over time is age, cigstat, cigyears, cigday
			 ##### what remains the same is: race, education ##

			 ######### (1) OK make 45 design matrix from age=45 to 90 that includes everybody as rows ########
			 ## varies: age, cigday, cigyears, and cigstat ##


			data0= cbind(race=race, edu=educ)
			#   race  edu
			# 1    W high
			# 2    W high
			# 3    W high

			# > DAT[1:5,1:30]
			#   X race gend birth_yr age_init age_cess age_death_OC quintile age_smoke1     CPD1 age_smoke2     CPD2 age_smoke3      CPD3 age_smoke4      CPD4
			# 1 1    0    0     1950     -999     -999           77       NA         NA       NA         NA       NA         NA        NA         NA        NA
			# 2 2    0    0     1950     -999     -999           87       NA         NA       NA         NA       NA         NA        NA         NA        NA
			# 3 3    0    0     1950       15     -999           67        3         15 4.926697         16 9.061576         17 11.070479         18 12.651806
			# 4 4    0    0     1950       16       82           89        3         16 5.744068         17 9.856438         18 11.811208         19 13.341365
			# 5 5    0    0     1950       12       89           82        2         12 1.589957         13 5.278929         14  7.205635         15  8.745075
			#   age_smoke5     CPD5 age_smoke6     CPD6 age_smoke7     CPD7 age_smoke8     CPD8 age_smoke9     CPD9 age_smoke10    CPD10 age_smoke11    CPD11
			# 1         NA       NA         NA       NA         NA       NA         NA       NA         NA       NA          NA       NA          NA       NA
			# 2         NA       NA         NA       NA         NA       NA         NA       NA         NA       NA          NA       NA          NA       NA
			# 3         19 13.97756         20 15.11975         21 16.11867         22 17.00039         23 17.78339          24 18.48154          25 19.10569
			# 4         20 14.62065         21 15.72104         22 16.68238         23 17.53028         24 18.28275          25 18.95324          26 19.55221
			# 5         16 10.04348         17 11.16494         18 12.14670         19 13.01359         20 13.78360          21 14.47040          22 15.08480

			#ages=45:90

			#CIGDAT = myReformatSHGdat(ages,DAT)
			#ages=45:90
			#CIGDAT = myReformatSHGdat(ages,DAT)
			#setwd(work)
			#write.csv(CIGDAT, "Male_smoke100000_big_CIGDAT.csv")


			 ######### (2) Prediction of BMI for given age (per design matrix) looping #############################

			BMIdat = NULL

		# set.seed(seed)

			for(j in 1:length(ages)){

				################ (a) design matrix
				#               (Intercept)                     raceA                     raceB                     raceH                educollege
				#             29.6665965407             -2.3216045642              0.3994941508             -0.2223563685             -0.8153890552
				#                edupostcol          ns(age, df = 4)1          ns(age, df = 4)2          ns(age, df = 4)3          ns(age, df = 4)4
				#             -1.2122167678             -0.9229637970             -1.4930552984             -2.2324605728             -1.9825806052
				#            cigstatCurrent             cigstatFormer          ns(cigyears, 2)1          ns(cigyears, 2)2            ns(cigday, 2)1
				#             -2.8781227204             -1.0289679250              1.6678793783             -0.2269712463              2.5254022935
				#            ns(cigday, 2)2      raceA:cigstatCurrent      raceB:cigstatCurrent      raceH:cigstatCurrent       raceA:cigstatFormer
				#              2.4036181396              1.1998860137             -0.9159395155              0.3132705606              0.1416375325
				#       raceB:cigstatFormer       raceH:cigstatFormer educollege:cigstatCurrent edupostcol:cigstatCurrent  educollege:cigstatFormer
				#             -0.6851827071              0.1484768861              0.4139030273              0.8881625412              0.0002494663
				#  edupostcol:cigstatFormer
				#              0.2398837786

				ag=ages[j]
				colname = paste(c("cigyears","cigday","cigstat"),rep(paste(".",ag,sep=""), 3),sep="")
				colname
				#[1] "cigyears.45" "cigday.45"    "cigstat.45"

				#### extract the cig data for the given age

				cigdat0 = CIGDAT[,colname]
				# > cigdat0[1:5,]
				#   cigyears.45 cigday.45 cigstat.45
				# 1           0   0.00000      Never
				# 2           0   0.00000      Never
				# 3          30  19.44004    Current
				# 4          29  19.44004    Current
				# 5          33  14.13879    Current

				## change name
				colnames(cigdat0) = c("cigyears","cigday","cigstat")
				# lm(formula = bmi ~ race + edu + ns(age, df = 4) + cigstat * race +
				#     cigstat * edu + ns(cigyears, 2) + ns(cigday, 2), data = MYDATA)


				mydat.sm = data.frame(data0, age=rep(ag,nrow(cigdat0)), cigdat0)
				# > mydat.sm[1:4,]
				#   race  edu age cigyears   cigday cigstat
				# 1    W high  45        0  0.00000   Never
				# 2    W high  45        0  0.00000   Never
				# 3    W high  45       30 19.44004 Current
				# 4    W high  45       29 19.44004 Current

				# mydat.sm[23,]
				# 	ag
				# 	pd0=predict(lm.bmi, newdata=mydat.sm[23,])
				# 	pd0
				#pd=predict(lm.bmi, newdata=mydat.sm)
				# > pd[1:10]
				#        1        2        3        4        5        6        7        8        9       10
				# 30.11995 29.12122 27.68076 27.76231 27.30130 29.12122 28.99155 28.30583 28.09225 26.67327
				# > summary(pd)
				#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
				#   24.94   27.67   28.29   28.25   29.04   30.12

                # print("HERE!") # THIS IS WHERE THE STRIPPED MODELS DIDN'T WORK
                # library(splines)
				pd0=predict(lm.bmi, newdata=mydat.sm)

				#pd2=predict(lm.bmi.adj, newdata=mydat.sm)
				# > pd0[1:10]
				#        1        2        3        4        5        6        7        8        9       10
				# 29.12122 26.79961 27.77168 27.67951 27.54256 29.12122 28.99155 26.79961 28.09225 26.67327


				#newdata=mydat.sm[3:5,]


				if(Gender=="F"){

					# > cbind(coef(OUT.bmi$lm.bmi.original),OUT.bmi$lm.bmi.coef.adj)
					#                                  [,1]        [,2]
					# (Intercept)               28.10083489 29.80083489 <---- only this
					# raceA                     -3.08376736 -3.08376736
					# raceB                      3.68311042  3.68311042
					# raceH                      0.83767049  0.83767049
					# educollege                -1.34144513 -1.34144513
					# edupostcol                -1.53673131 -1.53673131
					# ns(age, df = 3)1          -0.87997021 -0.87997021
					# ns(age, df = 3)2          -1.47032766 -1.47032766
					# ns(age, df = 3)3          -1.80009239 -1.80009239
					# cigstatCurrent            -2.95459998 -2.95459998
					# cigstatFormer             -0.94652637 -0.94652637
					# ns(cigyears, df = 1)       0.03694476  0.03694476
					# ns(cigday, df = 1)         6.01963549  6.01963549
					# educollege:cigstatCurrent  0.38764392  0.38764392
					# edupostcol:cigstatCurrent  1.04133139  1.04133139
					# educollege:cigstatFormer  -0.04459367 -0.04459367
					# edupostcol:cigstatFormer   0.09616144  0.09616144



					incr = 29.80083489 - 28.10083489; incr #1.7
					bmi.pd = pd0 + incr


				}#end of
				################### manual calibration the results from myBMI.cond2 (4/13/2016) #####################

				if(Gender=="M"){

				   bmi.pd = NULL

				   coef.bmi
					#               (Intercept)                     raceA                     raceB                     raceH
					#             28.9430210153             -2.3216045642              0.9987353770             -0.2223563685
					#                educollege                edupostcol          ns(age, df = 4)1          ns(age, df = 4)2
					#             -0.8153890552             -1.2122167678             -0.9229637970             -1.4930552984
					#          ns(age, df = 4)3          ns(age, df = 4)4            cigstatCurrent             cigstatFormer
					#             -2.2324605728             -1.9825806052             -2.8781227204             -1.0289679250

					### reduce blace effect ##

					#MYCOEF["raceB"] = mycoef["raceB"]*0.7  # 30% reduction of coefficient

					# > coef.bmi["raceB"]
					#     raceB
					# 0.9987354

					#coef.bmi["raceB"]*0.7
					#     raceB
					# 0.6991148

					#### so whoever black has to be substracted by 0.99-0.69 = coef.bmi["raceB"]*0.3
					# > coef.bmi["raceB"]*0.3
					#     raceB
					# 0.2996206

					incr = - coef.bmi["raceB"]*0.03  # only increment, not 1.025
					incr
					#       raceB
					# -0.02996206

					ix.blk = mydat.sm[,"race"]=="B"
						# > sum(ix.blk)
						# [1] 10233
						# > sum(ix.blk)/length(ix.blk)
						# [1] 0.10233

					bmi.pd = pd0
					bmi.pd[ix.blk] = pd0[ix.blk] + incr

						# > summary(bmi.pd[ix.blk])
						#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
						#   26.48   27.72   28.27   28.56   29.30   30.09
						# > summary( pd0[ix.blk])
						#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
						#   26.51   27.75   28.30   28.59   29.33   30.12

					#ix.b = as.character(mydat.sm[,"race"])=="B"
					# > sum(ix.b)
					# [1] 10255

					#mycoef["raceB"]*0.4

					#pd[ix.b] = pd0[ix.b] +

				 }#end of Gender


				 if(j==1) BMIdat = bmi.pd
				 if(j>1) BMIdat= cbind(BMIdat, bmi.pd)

#				 print(ag)


				}#end of ages

			colnames(BMIdat)=paste("BMI",ages,sep=".")

			# > BMIdat[1:5,]
			#     BMI.45   BMI.46   BMI.47   BMI.48   BMI.49   BMI.50   BMI.51   BMI.52   BMI.53   BMI.54   BMI.55   BMI.56   BMI.57
			# 1 30.84353 30.79898 30.75443 30.70988 30.66533 30.62063 30.57498 30.52747 30.47714 30.42306 30.36430 30.29991 30.22896
			# 2 29.84479 29.80024 29.75569 29.71115 29.66660 29.62189 29.57625 29.52873 29.47840 29.42433 29.36556 29.30117 29.23023
			# 3 28.40434 28.35644 28.30676 28.25536 28.20229 28.14744 28.09009 28.02936 27.96436 27.89421 27.81803 27.73493 27.64403
			# 4 28.48588 28.43982 28.39192 28.34225 28.29085 28.23762 28.18184 28.12261 28.05907 27.99033 27.91549 27.83369 27.74403
			# 5 28.02488 27.96831 27.91012 27.85037 27.78912 27.72626 27.66107 27.59265 27.52014 27.44264 27.35927 27.26914 27.17138


			#plot(ages,BMIdat[1,],type="n", ylim=c(15,35))

			###########(3) Visualize the trajectory of BMI of some individuals ##################################


		doPlot=F
		if(doPlot==T){

					#setwd(outdir)
				#pdf("BMI.trajectories.1000_2.pdf")	 # male
				pdf("BMI.trajectories.1000_2_FEMALE.pdf")

				cnames=paste("cigday",ages,sep=".")
				dat.cigday= CIGDAT[,cnames]
				#dat.cigday= CIGDAT[,grep("cigday",colnames(CIGDAT))]
					kk=1000
				#kk=50
					par(mar=c(5,5,5,5))

					for(u in 1:kk){

						rcc=as.character(mydat.sm[u,"race"])
						ed=as.character(mydat.sm[u,"edu"])

						plot(ages,BMIdat[u,],pch=16, ylim=c(0,38),col="blue",
							main=paste("Subject ID=",u,"\n(gender=",Gender,", race=",rcc," & edu=",ed,")",  sep=""),
								xlab="Age",ylab="BMI", axes=F,cex.lab=1.5,cex.main=1.5)

						axis(1, cex.axis=1.5)
						axis(2, cex.axis=1.5)
						axis(4, cex.axis=1.5)#, labels="Cig/Day")
						mtext("Cig/Day", side=4, line=2.2,cex=1.5)

						lines(ages,BMIdat[u,], type="l", col="blue")

						lines(ages,dat.cigday[u,],lty="dotted", col="red")
						points(ages,dat.cigday[u,],pch=18, col="red")

						legend(x="topleft",legend=c("BMI","Cig/day"),pch=c(16,18), col=c("blue","red"),cex=1.2,lty=c("solid","dotted"))

						#points(ages,BMIdat[u,],pch=16, col=(1:kk)[u])
					}


			  dev.off()

					#setwd(outdir)
			 #pdf("BMI.hist.overAges_2.pdf")
			 pdf("BMI.hist.overAges_2_female.pdf")
					for(u in 1:length(ages)){

						ag=paste("BMI.",ages[u],sep="")
						hist(BMIdat[,u], main=ag,ylab="BMI",xlim=c(15,35),nclass=5,col="blue",prob=T,ylim=c(0,0.8))

					 }#end of

			dev.off()

			}#end of  doThis=F



			########## (4) Compare to observed data vs. simulated data ##########################################


			###### check to reference: mean BMI at age 50  #####
			# > ref.bmi
			#    W    B    H
			# 28.7 27.7 28.9

			BMI.50 = BMIdat[,"BMI.50"]
			#tt=data.frame(cbind(BMI.50 = bmi50, race=race))
			bmi.ave = aggregate(BMI.50, by=list(race=race), mean)
			#   race        x
			# 1    A 26.76746
			# 2    B 29.16310
			# 3    H 28.84572
			# 4    W 28.88204

			#   race        x
			# 1    A 26.26849
			# 2    B 29.08601
			# 3    H 28.85768
			# 4    W 28.90377

			row.names(bmi.ave)=as.character(bmi.ave[,1])

				## make a table to plot
			tt1=t(bmi.ave)
			tt2=as.numeric(tt1[-1,])
			# > tt2
			# [1] "26.26849" "29.08601" "28.85768" "28.90377"
			names(tt2)=tt1[1,]
			#        A        B        H        W
			# 26.26849 29.08601 28.85768 28.90377

			#        A        B        H        W   --> female
			# 25.10848 32.41363 29.65636 28.60779

			#bmi.ave = tt2

			########### plot excluding asian (since reference doens't have asian) ####
			ci1=ref.bmi - 1.96*ref.bmi.sd
			ci2=ref.bmi + 1.96*ref.bmi.sd

			cbind(bmi.ave[c("W","B","H"),2],ref.bmi, ci1, ci2)
			#           ref.bmi    ci1    ci2
			# W 27.89465    28.7 28.112 29.288
			# B 27.96616    27.7 26.916 28.484
			# H 27.79131    28.9 28.312 29.488

		   tab = c(bmi.ave[bmi.ave[,1]=="W",2], bmi.ave[bmi.ave[,1]=="B",2], bmi.ave[bmi.ave[,1]=="H",2])
		   names(tab)=c("W","B","H")


		  ############# before adjustment ##########

		  par(mar=c(5,5,5,3))

		   mat=cbind(ref.bmi, tab)
		   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="BMI",
		   main="Reference vs. Simulated \nAverage BMI (age 50) by race", cex.main=1.5, ylim=c(0,35))

		   ##### confidence interval ###
		   xs = c(1.5,4.5,7.5)

		   for(u in 1:length(xs)){


		   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
		   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

		   }#end of

		  legend(x="topleft", legend=c("Reference", "Simulated"), fill=c("red","yellow"), ncol=2,cex=1)



			###### [4] Simulating lung cancer family history given education, smo  ########################################

	cat("Simulating Lung cancer family history\n", sep="")

			# > coef.fh
			#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi  ns(pky, 2)1
			# -2.148305506  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042  1.030344727
			#  ns(pky, 2)2
			#  0.852142491

			#mydat.sm = data.frame(data0, age=rep(ag,nrow(cigdat0)), cigdat0)


			################# [4.1] Simulating Pr(FH=1 | age, smoking, BMI) for each individual over 45:90 #################

			FH.prev =NULL

			########## (1) extract information from OUT.fh ##########################
			# > names(OUT.fh)
			#  [1] "mycoef.adj"    "mycoef.before" "glm.fh"        "glm.or"        "prev.fh.adj"   "prev.fh.unadj" "ref.fh"        "ref.fh.ci"
			#  [9] "ns.mat.age"    "ns.mat.pky"

			glm.fh = OUT.fh$glm.fh

			coef.before = OUT.fh$mycoef.before
			#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi  ns(pky, 2)1
			# -2.518529315  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042  1.030344727
			#  ns(pky, 2)2
			#  0.852142491

			coef.adj = OUT.fh$mycoef.adj  # increased prevalence by calibration
			#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi  ns(pky, 2)1
			# -2.148305506  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042  1.030344727
			#  ns(pky, 2)2
			#  0.852142491

			####### (2) prepare for covariate data ###############################

			pkyDAT = DAT[,grep("PY",colnames(DAT))]
            # print(head(pkyDAT))
            # pkyDAT[is.na(pkyDAT)] <- 0  # assume that if PK.45 == NA, then there are no packyears, == 0.
            # print(head(pkyDAT))
				# > pkyDAT[1:3,]
				#      PY.45    PY.46    PY.47    PY.48    PY.49    PY.50    PY.51    PY.52    PY.53    PY.54   PY.55    PY.56    PY.57    PY.58   PY.59
				# 1  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.0000  0.00000  0.00000  0.00000  0.0000
				# 2  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.0000  0.00000  0.00000  0.00000  0.0000
				# 3 28.05376 29.02023 29.98116 30.93657 31.88644 32.83078 33.76959 34.70287 35.63061 36.55282 37.4695 38.38065 39.28627 40.18635 41.0809
				#      PY.60   PY.61    PY.62    PY.63    PY.64    PY.65    PY.66    PY.67    PY.68    PY.69    PY.70    PY.71    PY.72    PY.73    PY.74
				# 1  0.00000  0.0000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000
				# 2  0.00000  0.0000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000

				# > BMIdat[1:5,]
				#     BMI.45   BMI.46   BMI.47   BMI.48   BMI.49   BMI.50   BMI.51   BMI.52   BMI.53   BMI.54   BMI.55   BMI.56   BMI.57   BMI.58
				# 1 30.08999 30.04544 30.00089 29.95634 29.91179 29.86709 29.82145 29.77393 29.72360 29.66952 29.61076 29.54637 29.47542 29.39698
				# 2 29.12122 29.07667 29.03212 28.98757 28.94302 28.89832 28.85267 28.80516 28.75483 28.70075 28.64199 28.57760 28.50665 28.42820
				# 3 27.27928 27.23138 27.18170 27.13030 27.07723 27.02238 26.96503 26.90430 26.83930 26.76915 26.69297 26.60987 26.51897 26.41938
				# 4 27.73235 27.68628 27.63839 27.58871 27.53731 27.48408 27.42830 27.36908 27.30554 27.23679 27.16195 27.08015 26.99049 26.89209
				# 5 27.54256 27.48599 27.42780 27.36806 27.30680 27.24395 27.17875 27.11034 27.03782 26.96032 26.87695 26.78683 26.68907 26.58279

			mydat.big = data.frame(cbind(data0, pkyDAT, BMIdat))
				# > mydat.big[1:10,]
				#    race     edu     PY.45     PY.46     PY.47     PY.48     PY.49     PY.50     PY.51     PY.52     PY.53     PY.54     PY.55     PY.56
				# 1     B  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 2     W  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 3     W college 28.053756 29.020226 29.981163 30.936569 31.886442 32.830783 33.769592 34.702868 35.630612 36.552824 37.469504 38.380651
				# 4     B  <=high 27.403327 28.369797 29.330735 30.286140 31.236013 32.180354 33.119163 34.052439 34.980184 35.902395 36.819075 37.730223
				# 5     W  <=high 24.382102 25.076264 25.757649 26.426256 27.082086 27.725139 28.355413 28.972911 29.577631 30.169573 30.748738 31.315125
				# 6     W  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 7     H  <=high 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535
				# 8     H  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 9     W  <=high  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161
				# 10    W  <=high 33.435355 34.653188 35.858235 37.050496 38.229970 39.396659 40.550562 41.691679 42.820009 43.935554 45.038312 46.128285

			# mycoef=coef.fh
			# ns.mat.age = OUT.fh$ns.mat.age
			# ns.mat.pky = OUT.fh$ns.mat.pky

			######### (3) Predict the probability for age = 45:90 ###############################

			for(j in 1:length(ages)){

				################ (a) design matrix #######
				# > mycoef
				#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi  ns(pky, 2)1
				# -2.148305506  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042  1.030344727
				#  ns(pky, 2)2
				#  0.852142491
				ag=ages[j];ag
				### extract covariate column name
				bminame=paste("BMI",ag,sep=".")
				pkname=paste("PY",ag,sep=".")
				# > pkname
				# [1] "PY.45"
				# > bminame
				# [1] "BMI.45"

				### covariates data ###
				mydat.sm0 = data.frame(age=rep(ag,nrow(cigdat0)),data0, bmi=as.numeric(as.character(mydat.big[,bminame])), pky=as.numeric(as.character(mydat.big[,pkname])) )
				# > mydat.sm0[1:5,]
				#   age race     edu      bmi      pky
				# 1  45    B  <=high 30.08999  0.00000
				# 2  45    W  <=high 29.12122  0.00000
				# 3  45    W college 27.27928 28.05376
				# 4  45    B  <=high 27.73235 27.40333
				# 5  45    W  <=high 27.54256 24.38210

				### predict using the regression output
				# > coef(glm.fh)
				#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi  ns(pky, 2)1
				# -2.518529315  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042  1.030344727
				#  ns(pky, 2)2
				#  0.852142491

				### female
				# > glm.fh$coef
				#  (Intercept)          age   educollege   edupostcol          bmi          pky
				# -2.279394585  0.001335893 -0.239239532 -0.250980876  0.005677488  0.005950754

                # Error: variables bmi, pky were specified with different types from the fit
                # print("HERE!")

                # print(summary(mydat.sm0))

				pr0=predict(glm.fh, newdata=mydat.sm0)

                # print("but not HERE.")
				# > pr0[1:5]
				#        1         2         3         4         5
				# -2.328082 -2.328082 -2.750840 -2.214505 -2.214871


				pr=pr0
				################### manual calibration the results from myFH.cond2 (4/19/2016) #####################
				if(Gender=="M"){

							coef.before
							#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi  ns(pky, 2)1
							# -2.518529315  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042  1.030344727
							#  ns(pky, 2)2
							#  0.852142491
							coef.adj
							#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi  ns(pky, 2)1
							# -2.148305506  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042  1.030344727
							#  ns(pky, 2)2
							#  0.852142491

				    incr = coef.adj[1] - coef.before[1]
					incr
					# (Intercept)
					#  0.3702238
					# exp(b + incr)/(1+exp(b+incr))

					#pr = pr0 + incr ## somehow this gave such high prevalnce need to adjust

				    ### further calibration ##
				    pr = pr0 + incr*0.3   # 0.1110671

							cbind(pr0,pr)[1:5,]
							#         pr0        pr
							# 1 -2.336502 -1.966278
							# 2 -2.328082 -1.957859
				 }#end of Gender

				################### manual calibration the results from myFH.cond2 (4/19/2016) #####################
				if(Gender=="F"){

					# > coef.before
					#  (Intercept)          age   educollege   edupostcol          bmi          pky
					# -2.279394585  0.001335893 -0.239239532 -0.250980876  0.005677488  0.005950754
					# > coef.adj
					#  (Intercept)          age   educollege   edupostcol          bmi          pky
					# -2.350055818  0.001335893 -0.239239532 -0.250980876  0.005677488  0.005950754

				    incr = coef.adj[1] - coef.before[1]
					incr
					# (Intercept)
					# -0.07066123

					# exp(b + incr)/(1+exp(b+incr))

					#pr = pr0 + incr ## somehow this gave such high prevalnce need to adjust

				    ### further calibration ##
					pr = pr0 + incr*1.2   # 0.1110671

							#cbind(pr0,pr)[1:5,]
							#         pr0        pr
							# 1 -2.336502 -1.966278
							# 2 -2.328082 -1.957859
				 }#end of Gender



				### risk ####

				 prob = exp(pr)/(1+exp(pr))
				# > prob[1:5]
				#         1         2         3         4         5
				# 0.1227892 0.1236990 0.1208236 0.1365458 0.1365026
				# > (exp(pr0)/(1+exp(pr0)))[1:5]
				#          1          2          3          4          5
				# 0.08814469 0.08882373 0.08667888 0.09845549 0.09842296

				 if(j==1) FH.prev = prob
				 if(j>1) FH.prev= cbind(FH.prev, prob)

#				 print(ag)

				}#end of ages


			colnames(FH.prev)=paste("FH",ages,sep=".")
			# > FH.prev[1:5,]
			#       FH.45     FH.46     FH.47     FH.48     FH.49     FH.50     FH.51     FH.52     FH.53     FH.54     FH.55     FH.56     FH.57
			# 1 0.1227892 0.1238523 0.1249233 0.1260022 0.1270891 0.1281807 0.1292600 0.1303063 0.1312983 0.1322142 0.1330319 0.1337290 0.1342829
			# 2 0.1236990 0.1247688 0.1258466 0.1269323 0.1280261 0.1291245 0.1302105 0.1312634 0.1322615 0.1331832 0.1340060 0.1347074 0.1352647
			# 3 0.1208236 0.1223782 0.1239439 0.1255207 0.1271086 0.1287042 0.1302905 0.1318462 0.1333494 0.1347772 0.1361064 0.1373131 0.1383728
			# 4 0.1365458 0.1382738 0.1400133 0.1417643 0.1435268 0.1452970 0.1470560 0.1487803 0.1504458 0.1520273 0.1534990 0.1548347 0.1560078
			# 5 0.1365026 0.1380648 0.1396319 0.1412038 0.1427804 0.1443579 0.1459175 0.1474358 0.1488888 0.1502518 0.1514997 0.1526067 0.1535470
			#       FH.58     FH.59     FH.60     FH.61     FH.62     FH.63     FH.64     FH.65     FH.66     FH.67     FH.68     FH.69     FH.70
			# 1 0.1346712 0.1348719 0.1348649 0.1346310 0.1341522 0.1334184 0.1324482 0.1312676 0.1299028 0.1283802 0.1267253 0.1249615 0.1231111
			# 2 0.1356553 0.1358573 0.1358503 0.1356150 0.1351332 0.1343948 0.1334186 0.1322307 0.1308574 0.1293252 0.1276599 0.1258850 0.1240229
			# 3 0.1392613 0.1399545 0.1404297 0.1406653 0.1406405 0.1403428 0.1397894 0.1390054 0.1380169 0.1368500 0.1355303 0.1340817 0.1325270
			# 4 0.1569913 0.1577589 0.1582857 0.1585480 0.1585228 0.1581963 0.1575874 0.1567238 0.1556339 0.1543465 0.1528897 0.1512896 0.1495714
			# 5 0.1542946 0.1548241 0.1551119 0.1551354 0.1548730 0.1543122 0.1534729 0.1523831 0.1510718 0.1495679 0.1478997 0.1460936 0.1441746

			apply(FH.prev,2,mean)
			#      FH.45      FH.46      FH.47      FH.48      FH.49      FH.50      FH.51      FH.52      FH.53      FH.54      FH.55      FH.56
			# 0.12317985 0.12445909 0.12574007 0.12702381 0.12831129 0.12959773 0.13086657 0.13209755 0.13326838 0.13435643 0.13534061 0.13619753
			#      FH.57      FH.58      FH.59      FH.60      FH.61      FH.62      FH.63      FH.64      FH.65      FH.66      FH.67      FH.68
			# 0.13690356 0.13743670 0.13777472 0.13789477 0.13777822 0.13740793 0.13677145 0.13588908 0.13478556 0.13348806 0.13202238 0.13041535
			#      FH.69      FH.70      FH.71      FH.72      FH.73      FH.74      FH.75      FH.76      FH.77      FH.78      FH.79      FH.80
			# 0.12869066 0.12687159 0.12498058 0.12303854 0.12106630 0.11908331 0.11710811 0.11515641 0.11323111 0.11133172 0.10945752 0.10760946
			#      FH.81      FH.82      FH.83      FH.84      FH.85      FH.86      FH.87      FH.88      FH.89      FH.90
			# 0.10578714 0.10398994 0.10221775 0.10047182 0.09875059 0.09705508 0.09538321 0.09373570 0.09211200 0.09051243

			mean(FH.prev[,"FH.55"])
			ref.fh
			# > 			mean(FH.prev[,"FH.55"])
			# [1] 0.1077848
			# > 			ref.fh
			# [1] 10.9

			# > mean(FH.prev[,"FH.55"])
			# [1] 0.1173455  # female


			meanfh55=mean(FH.prev[,"FH.55"])

			############ (4) barplot compare to the reference data (age = 55) #############


			  par(mar=c(5,5,5,3))
				#ref.fh.ci = c(9.74, 11.90)
				ci1=ref.fh.ci[1]
				ci2=ref.fh.ci[2]

			   mat=cbind(ref.fh, meanfh55*100)
			   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="FH prevalence (%)",
			   main="Prevalence (%) of FH (age 55)", cex.main=1.5, ylim=c(0,15))

			   ##### confidence interval ###
			   xs = c(1.5,2.5)#,7.5)

			   for(u in 1:length(xs)){


			   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

			   }#end of

			  legend(x="topleft", legend=c("Reference", "Simulated prob-based"), fill=c("red","yellow"), ncol=2,cex=1)


			####### time trajectory ########

			meanFH = apply(FH.prev,2,mean)
			# > meanFH
			#      FH.45      FH.46      FH.47      FH.48      FH.49      FH.50      FH.51      FH.52      FH.53      FH.54      FH.55      FH.56
			# 0.09780466 0.09885175 0.09990097 0.10095306 0.10200860 0.10306418 0.10410599 0.10511748 0.10607988 0.10697485 0.10778478 0.10849102
			#      FH.57      FH.58      FH.59      FH.60      FH.61      FH.62      FH.63      FH.64      FH.65      FH.66      FH.67      FH.68
			# 0.10907303 0.10951272 0.10979188 0.10989170 0.10979693 0.10949308 0.10897003 0.10824487 0.10733795 0.10627236 0.10506911 0.10375099
			par(mar=c(5,6,5,3))
			plot(ages,100*meanFH,pch=16, ylim=c(0,15),col="blue",
			main="(Simulated probability-based) \n FH prevalence (%)",
				xlab="Age",ylab="Mean FH prevalence (%) \nPr(FH=1 | age, smoking, BMI)",cex.lab=1.5,cex.main=1.5, cex.axis=1.5)

			abline(v=55, lty="dotted",col="red")
			abline(h=ref.fh, lty="dotted",col="red")

			############# (5) visualize the results ##############

			doPlot=F
			if(doPlot==T){
						#setwd(outdir)
					pdf("FH.trajectories.500.pdf")

						kk=100
						par(mar=c(5,6,5,3))

						for(u in 1:kk){

							rcc=as.character(mydat.sm[u,"race"])
							ed=as.character(mydat.sm[u,"edu"])

								plot(ages,100*FH.prev[u,],pch=16, ylim=c(0,15),col="blue",
									main=paste("Subject ID=",u,"\n(gender=",Gender,", race=",rcc," & edu=",ed,")",  sep=""),
										xlab="Age",ylab="FH prevalence (%) \nPr(FH=1 | age, smoking, BMI)",cex.lab=1.5,cex.main=1.5, cex.axis=1.5)
							#legend(x="topleft",legend=c("BMI","Cig/day"),pch=c(16,18), col=c("blue","red"),cex=1.2,lty=c("solid","dotted"))
							}

							#points(ages,BMIdat[u,],pch=16, col=(1:kk)[u])

				  dev.off()

			}#end of if(doPlot==T){


			################# [4.2] Simulating FH = 0 or 1 using the above simulated Pr(FH=1 | age, smoking, BMI) for each individual over 45:90 #################

			FH.status= NULL

			####### OCM age of individuals #######
			# > DAT[1:3,1:10]
			#   X race gend birth_yr age_init age_cess age_death_OC quintile age_smoke1     CPD1
			# 1 1    0    0     1950     -999     -999           77       NA         NA       NA
			# 2 2    0    0     1950     -999     -999           87       NA         NA       NA
			# 3 3    0    0     1950       15     -999           67        3         15 4.926697

			ageOCM = DAT[,"age_death_OC"]
				# > ageOCM[1:5]
				# [1] 77 87 67 89 82
			# > range(ageOCM)
			# [1] -999   99    -999 means don't die until age 99 ##

			ageOCM[ageOCM == -999] = 100
			range(ageOCM)
			#[1]   0 100

			## major input: FH.prev

			# set.seed(seed)

			max.age = ages[order(meanFH,decreasing=T)[1]]
			max.ph = meanFH[order(meanFH,decreasing=T)[1]]
			# > max.age
			# [1] 60
			# > max.ph
			#     FH.60
			# 0.1098917
			# >
			#[1] 0.1098917
			#seeds = runif(1,1000000, length(ages)*

			#for(u in 1:16){
			for(u in 1:length(ages)){

					fh.update= rep(NA, N)

					ag=ages[u];ag

					cname = paste("FH",ag,sep=".");cname
					mat.pr=FH.prev[,cname]
					# > pr[1:5]
					#          1          2          3          4          5
					# 0.09823288 0.09823288 0.06662215 0.10876315 0.10872762
							dim(mat.pr)=c(length(mat.pr),1)
							x=mat.pr[1,]
							samp.sm <- function(x) sample(c(0,1), size=1, prob = c(1-x, x))


					######## (step 1) At age = 45, just sample 0/1 from the given predicted probability ####

					if(ag==45){  # this is same as u==1

							###### (1) sampling ############

							# set.seed(u+seed)

							fh0=apply(mat.pr, 1, samp.sm)
							# > mean(fh0)
							# [1] 0.09801
							# > fh0[1:10]
							#  [1] 0 0 0 0 1 0 0 0 0 1


					}#end of 45

					#####(step 2) From age > 45, among only people who have fh = 0, sample more 0/1 until the mean(fh) (prevalence) reaches for the FH.prev[,46]
								######### repeat this until the maximum prevalence age ###

					if(ag > 45 ){

							### (1) take the previous year's fh status ###

							fh0 = ANS[,u-1] #
							#fh.previous = ANS[,u-1] #
							# > fh.previous[1:10]
							#  [1]  0  0  0  0  1 NA NA  0  0  0


					}#end of if(u > 45 and u <= max.age){


					##### (2) impose OCM ###########
		ix.dead = is.na(fh0)==T | ageOCM <= ag # identify who died prevous y -

		#ix.dead = is.na(fh0)==F & ageOCM <= ag # identify who did not die prevous y --> isn't it who DIED??!!
						sum(ix.dead)
						#[1] 556 additional
						# > sum(ix.dead)/length(ix.dead)
						#[1] 0.11244    ----> why 11% die before 45? hmm...

						#ageOCM[ix.dead]
						# hist(ageOCM[ix.dead])

					fh = fh0
						#sum(fh[ix.dead],na.rm=T)/ sum(fh==1,na.rm=T)
						# > 	sum(fh[ix.dead])/ sum(fh==1)
						# [1] 0.1132537   ---> OK 10% of fh=1 at 45 died already

					fh[ix.dead]=NA

					##### (3) updated case status with OCM information : total population N is the initial population size

					prev.before= sum(is.na(fh)==F & fh==1)/N
					prev.before
					#[1] 0.08691

					myref= mean(FH.prev[,cname])
					myref

					dif = myref - prev.before; dif
					# > dif
					# [1] 0.01089466

					n.require = ceiling(dif * N)
					n.require
					#[1] 1090 # recruit 1090 more
#					print(paste("n.require=",n.require,sep=""))

					#### if there is at least one more case to recruit, do more sampling ###

					if(n.require > 0){


							##### (4) sample additional more among who don't have FH=1 ########

							case = fh
							mat.prob = mat.pr

							# set.seed(u+seed+1000*(u+seed))

							fh.update0 = mySampleMore(case, mat.prob, n.require)
							# > names(fh.update0)
							# [1] "case.update" "prev.update"

							fh.update = fh.update0$case.update

							prev.aft= sum(is.na(fh.update)==F & fh.update==1)/N
							prev.aft
							#[1] 0.09697
							myref

# 							print(paste("age=",ag,sep=""))
# 							print(paste("model average prev=",round(mean(FH.prev[,cname]),3),sep=""))
# 							print(paste("Simulated binary FH proportion (updated)=", round(prev.aft,3),sep=""))


					}#

					### if less than 1 required to sample, don't sample

					if(n.require <= 0)  {

					     fh.update = fh

					}


					#####(step 3) From age >= max.age, no more sampling of FH = 1 because FH prevalence is decreasing ###########


				 if(u==1){
				 		ANS = fh.update; dim(ANS)=c(length(fh.update),1)
				 		N.require = n.require

				 }

				 if(u>1){

					 	 ANS = cbind(ANS,fh.update)
					 	 N.require = c(N.require, n.require)


				 }# end of


		}#end of for(u in 1:length(ages)){

		colnames(ANS)=paste("FH.",ages,sep="")
		colnames(ANS)=paste("FH.",ages,sep="")

		# > ANS[1:50,]
		#          fh.update fh.update fh.update fh.update fh.update fh.update fh.update fh.update fh.update fh.update fh.update fh.update
		#  [1,]  1         1         1         1         1         1         1         1         1         1         1         1         1
		#  [2,]  0         0         0         0         0         0         0         0         0         1         1         1         1
		#  [3,]  0         1         1         1         1         1         1         1         1         1         1         1         1
		#  [4,]  1         1         1         1         1         1         1         1         1         1         1         1         1
		#  [5,]  0         0         0         0         0         0         0         1         1         1         1         1         1
		#  [6,] NA        NA        NA        NA        NA        NA        NA        NA        NA        NA        NA        NA        NA
		#  [7,] NA        NA        NA        NA        NA        NA        NA         1        NA        NA        NA        NA        NA
		#  [8,]  0         1         1         1         1         1         1         1         1         1         1         1         1
		#  [9,]  0         1         1         1         1         1         1         1         1         1         1        NA        NA
		# [10,]  0         1         1         1         1         1         1         1         1         1         1         1         1
		# [11,]  0         0         0         1         1         1         1         1         1         1         1         1         1
		# [12,]  0         0         0         0         0         0         0         0         0         0         0         0         0
		# [13,]  0         1         1         1         1         1         1         1         1         1         1         1         1

		tt=cbind(DAT[,5:7], data0,round(FH.prev[,1:5],3), ANS)[1:20,]

		#setwd(outdir)
		#write.csv(tt,"FH.output.example.wo.OCM.csv")
		#write.csv(tt,"FH.output.example.with.OCM.csv")

		x=ANS[,1]
		dim(x)=c(length(x),1)
		myprev <- function(x){   sum(is.na(x)==F & (x==1))/ length(x) }

		FH.status = ANS


		prev.est = apply(FH.status, 2, myprev)
		#   FH.45   FH.46   FH.47   FH.48   FH.49   FH.50   FH.51   FH.52   FH.53   FH.54
		# 0.09781 0.09886 0.09991 0.10096 0.10201 0.10307 0.10411 0.10512 0.10608 0.10698

		meanFH = apply(FH.prev, 2, mean)

		#plot(ages, 100*prev.est, pch=18, cex=1.8, ylim=c(6,13), main="[Family History] Without OCM imposed \nSimulation vs. Model prediciton", cex.main=1.5,
		plot(ages, 100*prev.est, pch=18, cex=1.8, ylim=c(6,13), main="[Family History] With OCM imposed \nSimulation vs. Model prediciton", cex.main=1.5,

			col="red", xlab="Age", ylab="FH prevalence (%)",cex.axis=1.5, cex.lab=1.5)
		points(ages, 100*meanFH, col="blue", pch=16)
		legend(x="topleft", legend=c("Simulated","Model-prediction"), col=c("red","blue"), pch=c(18,16))


		pkdat = mydat.big[,paste("PY.",ages,sep="")]
		# > pkdat[1:10,]
		#        PY.45     PY.46     PY.47     PY.48     PY.49     PY.50     PY.51     PY.52     PY.53     PY.54     PY.55     PY.56     PY.57     PY.58     PY.59     PY.60
		# 1   0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
		# 2   0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
		# 3  28.053756 29.020226 29.981163 30.936569 31.886442 32.830783 33.769592 34.702868 35.630612 36.552824 37.469504 38.380651 39.286266 40.186349 41.080900 41.969919
		# 4  27.403327 28.369797 29.330735 30.286140 31.236013 32.180354 33.119163 34.052439 34.980184 35.902395 36.819075 37.730223 38.635838 39.535921 40.430471 41.319490

		####### visualize ######


			doPlot=F
			if(doPlot==T){
					#setwd(outdir)
					#pdf("FH.status_trajectories.500_PY_added.pdf")
					pdf("FH.status_trajectories.500_PY_added_FEMALE.pdf")

						kk=500
						par(mar=c(5,6,5,5))

						for(u in 1:kk){

							rcc=as.character(mydat.sm[u,"race"])
							ed=as.character(mydat.sm[u,"edu"])

								plot(ages, FH.status[u,], pch=16, col="red",cex.lab=1.5,cex.main=1.5, cex.axis=1.5, xlab="Age", ylab="Family History Status (0 or 1)", ylim=c(0,2),
										main=paste("Subject ID=",u,"\n(gender=",Gender,", race=",rcc," & edu=",ed,")",  sep=""),axes=F)
								axis(1,cex.axis=1.5)
								axis(2,cex.axis=1.5)

								axis(4, at=seq(0,1.5, by=0.5), labels=seq(0,1.5, by=0.5)*100, cex.axis=1.5)
								lines(ages, FH.status[u,], lty="dotted", col="red")
								mtext("Pack-Years", side=4, line=2.2, cex=1.5)

								### estimated probablity ###

								lines(ages,FH.prev[u,]*10,pch=16, col="dark grey")#, lty="dotted")

								 abline(v=ageOCM[u]-1, col="blue", lty="dotted", lwd=1.5)
								 #points(0, ageOCM[u]

								### pk years ###

								lines(ages,pkdat[u,]/100,lty="dotted", col="dark green")#, lty="dotted")
								points(ages,pkdat[u,]/100,pch=18, col="dark green")#, lty="dotted")




							#mtext("Cig/Day", side=4, line=2.2,cex=1.5)

								legend(x="topleft",legend=c("FH status","Pack-years", "OCM age"),pch=c(16,18, 16), col=c("red","dark green","blue"),cex=1.2,lty=c("solid","dotted", "dotted"))

							}

				  dev.off()

			}#end of if(doPlot==T){


			############ (4) barplot compare to the reference data (age = 55) #############

			 simfh55 = prev.est["FH.55"]
			#0.10779

			  par(mar=c(5,5,5,3))
				#ref.fh.ci = c(9.74, 11.90)
				ci1=ref.fh.ci[1]
				ci2=ref.fh.ci[2]

			   mat=cbind(ref.fh, simfh55*100)
			   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="FH prevalence (%)",
			   main="Reference vs. Simulated \n Prevalence of Family History (age 55)", cex.main=1.5, ylim=c(0,15))

			   ##### confidence interval ###
			   xs = c(1.5,2.5)#,7.5)

			   for(u in 1:length(xs)){


			   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

			   }#end of

			  legend(x="topleft", legend=c("Reference", "Simulated-based"), fill=c("red","yellow"), ncol=2,cex=1)




			###### [5] Simulating personal history of cancer given education, smo  ########################################

	cat("Simulating personal history of cancer\n", sep="")

			# > coef.ph
			#  (Intercept)  ns(age, 3)1  ns(age, 3)2  ns(age, 3)3        raceA        raceB        raceH  ns(bmi, 2)1  ns(bmi, 2)2          pky
			# -1.816925731  0.775599266  1.395902438  0.727633924 -1.134807420 -0.519480798 -0.170029629 -1.098434095  1.524776802  0.005378612

			#mydat.sm = data.frame(data0, age=rep(ag,nrow(cigdat0)), cigdat0)


			################# [4.1] Simulating Pr(FH=1 | age, smoking, BMI) for each individual over 45:90 #################

			PH.prev =NULL

			########## (1) extract information from OUT.fh ##########################
			# > names(OUT.fh)
			#  [1] "mycoef.adj"    "mycoef.before" "glm.fh"        "glm.or"        "prev.fh.adj"   "prev.fh.unadj" "ref.fh"        "ref.fh.ci"
			#  [9] "ns.mat.age"    "ns.mat.pky"

			glm.ph = OUT.ph$glm.ph
			# > names(OUT.ph)
			#  [1] "mycoef.adj"     "mycoef.before"  "glm.ph"         "glm.or"         "prev.phc.adj"   "prev.phc.unadj" "ref.ph"         "ref.ph.ci"      "ns.mat.age"
			# [10] "ns.mat.bmi"

			coef.before = OUT.ph$mycoef.before
			#  (Intercept)  ns(age, 3)1  ns(age, 3)2  ns(age, 3)3        raceA        raceB        raceH  ns(bmi, 2)1  ns(bmi, 2)2          pky
			# -3.494087943  0.775599266  0.465300813  0.727633924 -1.134807420 -0.519480798 -0.170029629 -1.098434095  1.524776802  0.005378612

			coef.adj = OUT.ph$mycoef.adj  # increased prevalence by calibration
			#  (Intercept)  ns(age, 3)1  ns(age, 3)2  ns(age, 3)3        raceA        raceB        raceH  ns(bmi, 2)1  ns(bmi, 2)2          pky
			# -1.816925731  0.775599266  1.395902438  0.727633924 -1.134807420 -0.519480798 -0.170029629 -1.098434095  1.524776802  0.005378612


			###### this is female: have cigstat  in addition to pack-years###

			# > coef.before
			#    (Intercept)    ns(age, 2)1    ns(age, 2)2          raceA          raceB          raceH     educollege     edupostcol cigstatCurrent
			#   -2.929346771    0.609394920    0.779349289   -0.404424796   -0.312855214    0.103250851   -0.006430919    0.140503564    0.211979886
			#  cigstatFormer            pky
			#    0.171671281    0.002359403
			# > coef.adj
			#    (Intercept)    ns(age, 2)1    ns(age, 2)2          raceA          raceB          raceH     educollege     edupostcol cigstatCurrent
			#   -2.835607674    0.609394920    0.779349289   -0.404424796   -0.312855214    0.103250851   -0.006430919    0.140503564    0.211979886
			#  cigstatFormer            pky
			#    0.171671281    0.002359403

			####### (2) prepare for covariate data ###############################

			pkyDAT = DAT[,grep("PY",colnames(DAT))]
				# > pkyDAT[1:3,]
				#      PY.45    PY.46    PY.47    PY.48    PY.49    PY.50    PY.51    PY.52    PY.53    PY.54   PY.55    PY.56    PY.57    PY.58   PY.59
				# 1  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.0000  0.00000  0.00000  0.00000  0.0000
				# 2  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.0000  0.00000  0.00000  0.00000  0.0000
				# 3 28.05376 29.02023 29.98116 30.93657 31.88644 32.83078 33.76959 34.70287 35.63061 36.55282 37.4695 38.38065 39.28627 40.18635 41.0809
				#      PY.60   PY.61    PY.62    PY.63    PY.64    PY.65    PY.66    PY.67    PY.68    PY.69    PY.70    PY.71    PY.72    PY.73    PY.74
				# 1  0.00000  0.0000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000
				# 2  0.00000  0.0000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000

				# > BMIdat[1:5,]
				#     BMI.45   BMI.46   BMI.47   BMI.48   BMI.49   BMI.50   BMI.51   BMI.52   BMI.53   BMI.54   BMI.55   BMI.56   BMI.57   BMI.58
				# 1 30.08999 30.04544 30.00089 29.95634 29.91179 29.86709 29.82145 29.77393 29.72360 29.66952 29.61076 29.54637 29.47542 29.39698
				# 2 29.12122 29.07667 29.03212 28.98757 28.94302 28.89832 28.85267 28.80516 28.75483 28.70075 28.64199 28.57760 28.50665 28.42820
				# 3 27.27928 27.23138 27.18170 27.13030 27.07723 27.02238 26.96503 26.90430 26.83930 26.76915 26.69297 26.60987 26.51897 26.41938
				# 4 27.73235 27.68628 27.63839 27.58871 27.53731 27.48408 27.42830 27.36908 27.30554 27.23679 27.16195 27.08015 26.99049 26.89209
				# 5 27.54256 27.48599 27.42780 27.36806 27.30680 27.24395 27.17875 27.11034 27.03782 26.96032 26.87695 26.78683 26.68907 26.58279

			cigstatDAT = CIGDAT[,grep("cigstat.", colnames(CIGDAT))]

			mydat.big = data.frame(cbind(data0, pkyDAT, BMIdat, cigstatDAT))
				# > mydat.big[1:10,]
				#    race     edu     PY.45     PY.46     PY.47     PY.48     PY.49     PY.50     PY.51     PY.52     PY.53     PY.54     PY.55     PY.56
				# 1     B  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 2     W  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 3     W college 28.053756 29.020226 29.981163 30.936569 31.886442 32.830783 33.769592 34.702868 35.630612 36.552824 37.469504 38.380651
				# 4     B  <=high 27.403327 28.369797 29.330735 30.286140 31.236013 32.180354 33.119163 34.052439 34.980184 35.902395 36.819075 37.730223
				# 5     W  <=high 24.382102 25.076264 25.757649 26.426256 27.082086 27.725139 28.355413 28.972911 29.577631 30.169573 30.748738 31.315125
				# 6     W  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 7     H  <=high 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535
				# 8     H  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 9     W  <=high  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161
				# 10    W  <=high 33.435355 34.653188 35.858235 37.050496 38.229970 39.396659 40.550562 41.691679 42.820009 43.935554 45.038312 46.128285

			# mycoef=coef.fh
			# ns.mat.age = OUT.fh$ns.mat.age
			# ns.mat.pky = OUT.fh$ns.mat.pky

			######### (3) Predict the probability for age = 45:90 ###############################

			for(j in 1:length(ages)){

				################ (a) make design matrix for each age #######
				# > mycoef
				#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi  ns(pky, 2)1
				# -2.148305506  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042  1.030344727
				#  ns(pky, 2)2
				#  0.852142491

				# > coef.before
				#  (Intercept)  ns(age, 3)1  ns(age, 3)2  ns(age, 3)3        raceA        raceB        raceH  ns(bmi, 2)1  ns(bmi, 2)2          pky
				# -3.494087943  0.775599266  0.465300813  0.727633924 -1.134807420 -0.519480798 -0.170029629 -1.098434095  1.524776802  0.005378612



				ag=ages[j];ag
				### extract covariate column name
				bminame=paste("BMI",ag,sep=".")
				pkname=paste("PY",ag,sep=".")
				# > pkname
				# [1] "PY.45"
				# > bminame
				# [1] "BMI.45"
				cigstatname = paste("cigstat",ag,sep=".")

 				### fo
				#colname = paste(c("cigyears","cigday","cigstat"),rep(paste(".",ag,sep=""), 3),sep="")
				#colname
				#[1] "cigyears.45" "cigday.45"    "cigstat.45"

				#### extract the cig data for the given age

				#cigdat0 = CIGDAT[,colname]





				### covariates data ###
				mydat.sm0 = data.frame(age=rep(ag,nrow(cigdat0)),edu=data0[,"edu"],race=data0[,"race"], bmi=mydat.big[,bminame],pky=mydat.big[,pkname],cigstat=mydat.big[,cigstatname] )
				# > mydat.sm0[1:10,]
				#    age race      bmi       pky
				# 1   45    W 29.12122  0.000000
				# 2   45    H 28.89886  0.000000
				# 3   45    W 27.68076 28.053756
				# 4   45    B 27.73235 27.403327
				# 5   45    H 27.63347 24.382102
				# 6   45    W 29.12122  0.000000
				# 7   45    W 28.99155 43.645535
				# 8   45    B 30.08999  0.000000
				# 9   45    W 28.09225  0.107161
				# 10  45    W 27.79499 33.435355

				# >  mydat.sm0[1:10,]
				#    age race      bmi        pky cigstat
				# 1   45    W 29.83626  0.0000000   Never
				# 2   45    B 33.51937  0.0000000   Never
				# 3   45    B 31.51737 28.4497690 Current
				# 4   45    B 31.51689 27.8695794 Current
				# 5   45    W 27.57983 17.1476990 Current
				# 6   45    W 29.83626  5.0227522   Never
				# 7   45    W 28.90025 47.9493950  Former
				# 8   45    H 30.67393 20.3006974   Never
				# 9   45    W 28.88973  0.1813126  Former
				# 10  45    B 31.76510 30.0423846 Current

				#################### (b) predict using the regression output ###########################
				# > coef(glm.ph)
				#  (Intercept)  ns(age, 3)1  ns(age, 3)2  ns(age, 3)3        raceA        raceB        raceH  ns(bmi, 2)1  ns(bmi, 2)2          pky
				# -3.494087943  0.775599266  0.465300813  0.727633924 -1.134807420 -0.519480798 -0.170029629 -1.098434095  1.524776802  0.005378612

				pr0=predict(glm.ph, newdata=mydat.sm0)
				pr0[1:5]
				#         1         2         3         4         5
				# -4.210063 -4.374438 -4.017309 -4.542003 -4.205500
				pr=pr0

				prob0 = exp(pr0)/(1+exp(pr0))
				mean(prob0)
				# > mean(prob0)
				# [1] 0.01484012


				#### predict using calibrated parameters -----without manual calibration #####



		glm.ph$coefficients = coef.adj

		######## secondary calibration---prevalence too high...

	   #glm.ph$coefficients[3] = coef.before[3]*1

				pr=predict(glm.ph, newdata=mydat.sm0)
				pr[1:5]
				#         1         2         3         4         5
				# -2.843581 -3.007956 -2.650827 -3.175521 -2.839019
				# > mean(pr0)
				# [1] -2.879403
				# > mean(pr)
				# [1] -2.785663


				### risk ####

				prob = exp(pr)/(1+exp(pr))
				# > prob[1:5]
				#         1         2         3         4         5
				# 0.1227892 0.1236990 0.1208236 0.1365458 0.1365026
				# > (exp(pr0)/(1+exp(pr0)))[1:5]
				#          1          2          3          4          5
				# 0.08814469 0.08882373 0.08667888 0.09845549 0.09842296

				mean(prob)
				# > mean(prob1)
				# [1] 0.05566851

				 if(j==1) PH.prev = prob
				 if(j>1) PH.prev= cbind(PH.prev, prob)

				 #print(ag)

				}#end of ages


			colnames(PH.prev)=paste("PH",ages,sep=".")
			#        PH.45      PH.46      PH.47      PH.48      PH.49      PH.50      PH.51      PH.52      PH.53      PH.54      PH.55      PH.56      PH.57      PH.58
			# 1 0.05501406 0.05795983 0.06105381 0.06430239 0.06771209 0.07128971 0.07504270 0.07897896 0.08310674 0.08743466 0.09197177 0.09672758 0.10171211 0.10693595
			# 2 0.04706775 0.04961313 0.05228918 0.05510181 0.05805712 0.06116145 0.06442186 0.06784585 0.07144130 0.07521654 0.07918032 0.08334193 0.08771119 0.09229859
			# 3 0.06593806 0.06979466 0.07386204 0.07814975 0.08266751 0.08742543 0.09243489 0.09770801 0.10325744 0.10909644 0.11523889 0.12169936 0.12849317 0.13563641
			# 4 0.04009738 0.04250828 0.04505927 0.04775774 0.05061139 0.05362834 0.05681775 0.06018946 0.06375395 0.06752236 0.07150661 0.07571943 0.08017445 0.08488634
			# 5 0.05525175 0.05845883 0.06184025 0.06540405 0.06915849 0.07311220 0.07727500 0.08165741 0.08627058 0.09112626 0.09623692 0.10161577 0.10727686 0.11323513
			#        PH.59      PH.60     PH.61     PH.62     PH.63     PH.64     PH.65     PH.66     PH.67     PH.68     PH.69     PH.70     PH.71     PH.72     PH.73
			# 1 0.11240942 0.11813939 0.1241086 0.1302009 0.1362547 0.1420817 0.1474712 0.1522361 0.1563495 0.1598403 0.1627589 0.1651697 0.1671463 0.1687692 0.1701248
			# 2 0.09711445 0.10216605 0.1074394 0.1128331 0.1182047 0.1233865 0.1281900 0.1324460 0.1361278 0.1392582 0.1418805 0.1440507 0.1458337 0.1473009 0.1485289
			# 3 0.14314451 0.15102690 0.1592623 0.1677068 0.1761590 0.1843827 0.1921122 0.1991099 0.2053353 0.2108159 0.2156097 0.2197929 0.2234534 0.2266888 0.2296045
			# 4 0.08986983 0.09513624 0.1006767 0.1063987 0.1121677 0.1178210 0.1231711 0.1280452 0.1324055 0.1362631 0.1396517 0.1426196 0.1452248 0.1475339 0.1496199
			# 5 0.11950521 0.12609673 0.1329931 0.1400718 0.1471598 0.1540521 0.1605168 0.1663442 0.1714955 0.1759917 0.1798810 0.1832285 0.1861102 0.1886108 0.1908221
			#       PH.74     PH.75     PH.76     PH.77     PH.78     PH.79     PH.80     PH.81     PH.82     PH.83     PH.84     PH.85     PH.86     PH.87     PH.88
			# 1 0.1713029 0.1723967 0.1734855 0.1745852 0.1756958 0.1768176 0.1779504 0.1790945 0.1802497 0.1814162 0.1825940 0.1837832 0.1849838 0.1861959 0.1874195
			# 2 0.1495984 0.1505925 0.1515824 0.1525826 0.1535930 0.1546137 0.1556448 0.1566863 0.1577383 0.1588009 0.1598741 0.1609579 0.1620524 0.1631578 0.1642739
			# 3 0.2323116 0.2349265 0.2375293 0.2401644 0.2428314 0.2455298 0.2482594 0.2510200 0.2538117 0.2566346 0.2594886 0.2623737 0.2652899 0.2682373 0.2712157
			# 4 0.1515613 0.1534411 0.1553170 0.1572210 0.1591530 0.1611131 0.1631010 0.1651166 0.1671602 0.1568646 0.1579456 0.1590373 0.1601398 0.1612529 0.1623769
			# 5 0.1928412 0.1947696 0.1966547 0.1985630 0.2004945 0.2024494 0.2044276 0.2064294 0.2084547 0.2105038 0.2125766 0.2146732 0.2167938 0.2189383 0.2211069

			apply(PH.prev,2,mean)
				#      PH.45      PH.46      PH.47      PH.48      PH.49      PH.50      PH.51      PH.52      PH.53      PH.54      PH.55      PH.56      PH.57      PH.58
				# 0.05566851 0.05875167 0.06199277 0.06539658 0.06896832 0.07271728 0.07665048 0.08077427 0.08509999 0.08963859 0.09439427 0.09937610 0.10460058 0.11007181
				#      PH.59      PH.60      PH.61      PH.62      PH.63      PH.64      PH.65      PH.66      PH.67      PH.68      PH.69      PH.70      PH.71      PH.72
				# 0.11579871 0.12179751 0.12804374 0.13441547 0.14075426 0.14685462 0.15250889 0.15751646 0.16185775 0.16555488 0.16866370 0.17124563 0.17337668 0.17513772
				#      PH.73      PH.74      PH.75      PH.76      PH.77      PH.78      PH.79      PH.80      PH.81      PH.82      PH.83      PH.84      PH.85      PH.86
				# 0.17661802 0.17791251 0.17911468 0.18030510 0.18149944 0.18269968 0.18391334 0.18512946 0.18635563 0.18758991 0.18883788 0.19008227 0.19134146 0.19259852
				#      PH.87      PH.88      PH.89      PH.90
				# 0.19386692 0.19514019 0.19642945 0.19772486

			mean(PH.prev[,"PH.55"])
			ref.ph
			# > 			mean(FH.prev[,"FH.55"])
			# [1] 0.07823437 --> 2
			# > 			ref.fh
			# [1] 6.14

			meanph55=mean(PH.prev[,"PH.55"])




			############ (4) barplot compare to the reference data (age = 55) #############


			  par(mar=c(5,5,5,3))
				#ref.fh.ci = c(9.74, 11.90)
				ci1=ref.ph.ci[1]
				ci2=ref.ph.ci[2]

			   mat=cbind(ref.ph, meanph55*100)
			   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="PHC prevalence (%)",
			   main="Prevalence (%) of PHC (age 55)", cex.main=1.5, ylim=c(0,15))

			   ##### confidence interval ###
			   xs = c(1.5,2.5)#,7.5)

			   for(u in 1:length(xs)){


			   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

			   }#end of

			  legend(x="topleft", legend=c("Reference", "Simulated prob-based"), fill=c("red","yellow"), ncol=2,cex=1)


			####### time trajectory ########

			meanPH = apply(PH.prev,2,mean)
			# > meanFH
			#      FH.45      FH.46      FH.47      FH.48      FH.49      FH.50      FH.51      FH.52      FH.53      FH.54      FH.55      FH.56
			# 0.09780466 0.09885175 0.09990097 0.10095306 0.10200860 0.10306418 0.10410599 0.10511748 0.10607988 0.10697485 0.10778478 0.10849102
			#      FH.57      FH.58      FH.59      FH.60      FH.61      FH.62      FH.63      FH.64      FH.65      FH.66      FH.67      FH.68
			# 0.10907303 0.10951272 0.10979188 0.10989170 0.10979693 0.10949308 0.10897003 0.10824487 0.10733795 0.10627236 0.10506911 0.10375099
			par(mar=c(5,6,5,3))
			plot(ages,100*meanPH,pch=16, ylim=c(0,25),col="blue",
			main="(Simulated probability-based) \n PHC prevalence (%)",
				xlab="Age",ylab="PHC prevalence (%) \nPr(PH=1 | age, race, smoking, BMI)",cex.lab=1.5,cex.main=1.5, cex.axis=1.5)

			abline(v=55, lty="dotted",col="red")
			abline(h=ref.ph, lty="dotted",col="red")


			##### adding McClure points ###

			## adding from McClure ##

			#plot(myages, probs.ph2*100, pch=17,col="red", xlab="Age",ylab="Prevalence (%) of PH", main="(After calibration) Multivariate Model", ylim=c(5,26))


			xx=c(25, 35, 45,55,65,75,80)
			yy=c(1.2, 2.1, 4.4, 8.3, 14.9, 21.7, 25)
			points(xx,yy,pch=17,col="dark green")


			points(xx, yy*0.76,pch=18,col="red",cex=2)

			legend(x="bottomright", legend=c("NHIS", "Adjusted NHIS", "Simulation"), fill=c("dark green","red","blue"),cex=1.2)



			############# (5) visualize the results ##############

			doPlot=F
			if(doPlot==T){
						#setwd(outdir)
					pdf("PH.trajectories.500.pdf")

						kk=500
						par(mar=c(5,6,5,3))

						for(u in 1:kk){

							rcc=as.character(mydat.sm[u,"race"])
							ed=as.character(mydat.sm[u,"edu"])

								plot(ages,100*PH.prev[u,],pch=16, ylim=c(0,25),col="blue",
									main=paste("Subject ID=",u,"\n(gender=",Gender,", race=",rcc," & edu=",ed,")",  sep=""),
										xlab="Age",ylab="PH prevalence (%) \nPr(PH=1 | age, race, smoking, BMI)",cex.lab=1.5,cex.main=1.5, cex.axis=1.5)
							#legend(x="topleft",legend=c("BMI","Cig/day"),pch=c(16,18), col=c("blue","red"),cex=1.2,lty=c("solid","dotted"))
							}

							#points(ages,BMIdat[u,],pch=16, col=(1:kk)[u])

				  dev.off()

			}#end of if(doPlot==T){


			################# [4.2] Simulating PH = 0 or 1 using the above simulated Pr(FH=1 | age, smoking, BMI) for each individual over 45:90 #################

			PH.status= NULL

			####### OCM age of individuals #######
			# > DAT[1:3,1:10]
			#   X race gend birth_yr age_init age_cess age_death_OC quintile age_smoke1     CPD1
			# 1 1    0    0     1950     -999     -999           77       NA         NA       NA
			# 2 2    0    0     1950     -999     -999           87       NA         NA       NA
			# 3 3    0    0     1950       15     -999           67        3         15 4.926697

			ageOCM = DAT[,"age_death_OC"]
				# > ageOCM[1:5]
				# [1] 77 87 67 89 82
			# > range(ageOCM)
			# [1] -999   99    -999 means don't die until age 99 ##

			ageOCM[ageOCM == -999] = 100
			range(ageOCM)
			#[1]   0 100

			## major input: FH.prev

			# set.seed(seed)

			max.age = ages[order(meanPH,decreasing=T)[1]]
			max.ph = meanPH[order(meanPH,decreasing=T)[1]]
			# > max.age
			# [1] 60
			# > max.ph
			#     FH.60
			# 0.1098917
			# >
			#[1] 0.1098917
			#seeds = runif(1,1000000, length(ages)*

			#for(u in 1:16){
			for(u in 1:length(ages)){

					ph.update= rep(NA, N)

					ag=ages[u];ag

					cname = paste("PH",ag,sep=".");cname
					mat.pr=PH.prev[,cname]
					# > pr[1:5]
					#          1          2          3          4          5
					# 0.09823288 0.09823288 0.06662215 0.10876315 0.10872762
							dim(mat.pr)=c(length(mat.pr),1)
							x=mat.pr[1,]
							samp.sm <- function(x) sample(c(0,1), size=1, prob = c(1-x, x))


					######## (step 1) At age = 45, just sample 0/1 from the given predicted probability ####

					if(ag==45){  # this is same as u==1

							###### (1) sampling ############

							# set.seed(u+seed)

							ph0=apply(mat.pr, 1, samp.sm)
							 mean(ph0,na.rm=T)
							# [1] 0.09801
							# > fh0[1:10]
							#  [1] 0 0 0 0 1 0 0 0 0 1


					}#end of 45

					#####(step 2) From age > 45, among only people who have ph = 0, sample more 0/1 until the mean(Ph) (prevalence) reaches for the PH.prev[,46]
								######### repeat this until the maximum prevalence age ###

					if(ag > 45 ){

							### (1) take the previous year's fh status ###

							ph0 = ANS[,u-1] #
							#fh.previous = ANS[,u-1] #
							# > fh.previous[1:10]
							#  [1]  0  0  0  0  1 NA NA  0  0  0


					}#end of if(u > 45 and u <= max.age){


					##### (2) impose OCM ###########

	ix.dead = is.na(ph0)==T | ageOCM <= ag # identify who did  die prevous y
						sum(ix.dead)
						#[1] 556 additional
						# > sum(ix.dead)/length(ix.dead)
						#[1] 0.11244    ----> why 11% die before 45? hmm...

						#ageOCM[ix.dead]
						# hist(ageOCM[ix.dead])

					ph = ph0
						#sum(fh[ix.dead],na.rm=T)/ sum(fh==1,na.rm=T)
						# > 	sum(fh[ix.dead])/ sum(fh==1)
						# [1] 0.1132537   ---> OK 10% of fh=1 at 45 died already

					ph[ix.dead]=NA

					##### (3) updated case status with OCM information : total population N is the initial population size

					## number of people alive by the time (people at risk)
					N.risk =  sum(!ix.dead)
					prev.before= sum(is.na(ph)==F & ph==1)/N.risk
					#prev.before= sum(is.na(ph)==F & ph==1)/N
					prev.before
					#[1] 0.03035

					myref= mean(PH.prev[,cname])
					myref
					#[1] [1] 0.0330077


					dif = myref - prev.before; dif  # should it be always positive? yes because initial population stays the same
					# > dif
					# [1] 0.01089466

					n.require = ceiling(dif * N.risk)
					#n.require = ceiling(dif * N)
					n.require
					#[1] 1090 # recruit 1090 more
#					print(paste("n.require=",n.require,sep=""))

					#### if there is at least one more case to recruit, do more sampling ###

					if(n.require > 0){


							##### (4) sample additional more among who don't have FH=1 ########

							case = ph
							mat.prob = mat.pr

							# set.seed(u+seed+1000*(u+seed))

				ph.update0 = mySampleMore2(case, mat.prob, n.require)
							# > names(ph.update0)
							# [1] "case.update" "prev.update"

							ph.update = ph.update0$case.update

							prev.aft= sum(is.na(ph.update)==F & ph.update==1)/N.risk
							prev.aft
							#[1] 0.09697
							myref

# 							print(paste("age=",ag,sep=""))
# 							print(paste("model average prev=",round(mean(PH.prev[,cname]),3),sep=""))
# 							print(paste("Simulated binary PH proportion (updated)=", round(prev.aft,3),sep=""))


					}#

					### if less than 1 required to sample, don't sample

					if(n.require <= 0)  {

					     ph.update = ph

					}


					#####(step 3) From age >= max.age, no more sampling of PH = 1 because FH prevalence is decreasing ###########


				 if(u==1){
				 		ANS = ph.update; dim(ANS)=c(length(ph.update),1)
				 		N.require = n.require

				 }

				 if(u>1){

					 	 ANS = cbind(ANS,ph.update)
					 	 N.require = c(N.require, n.require)


				 }# end of


		}#end of for(u in 1:length(ages)){

		colnames(ANS)=paste("PH.",ages,sep="")
		colnames(ANS)=paste("PH.",ages,sep="")

		# > ANS[1:50,]
			#      PH.45 PH.46 PH.47 PH.48 PH.49 PH.50 PH.51 PH.52 PH.53 PH.54 PH.55 PH.56 PH.57 PH.58 PH.59 PH.60 PH.61 PH.62 PH.63 PH.64 PH.65 PH.66 PH.67 PH.68 PH.69
			#  [1,]     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			#  [2,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1
			#  [3,]     0     0     0     0     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1     1     1    NA    NA    NA
			#  [4,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1     1     1     1
			#  [5,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0
			#  [6,]    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			#  [7,]    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			#  [8,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1
			#  [9,]     0     0     0     0     0     0     0     0     0     0     1    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [10,]     0     0     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			# [11,]     0     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			# [12,]     0     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			# [13,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1     1     1
			# [14,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1
			# [15,]     0     0     0     0     0     0    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [16,]     0     0     0     0     0     0     0     0    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [17,]     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1     1
			# [18,]     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			# [19,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1    NA    NA    NA    NA    NA    NA    NA    NA
			# [20,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0
			# [21,]    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [22,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0
			# [23,]     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			# [24,]     0     0     0     0     0     0     0     1     1    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [25,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0
			# [26,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1
			# [27,]    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [28,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1     1
			# [29,]     0     0     0     0     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			#
		tt=cbind(DAT[,5:7],PY.55=DAT[,"PY.55"],BMI.55=mydat.big[,"BMI.55"], data0,round(PH.prev[,1:5],3), ANS)[1:20,]

		#setwd(outdir)
		#write.csv(tt,"PH.output.example.wo.OCM.csv")
		#write.csv(tt,"PH.output.example.with.OCM.csv")

		x=ANS[,1]
		dim(x)=c(length(x),1)
	#myprev <- function(x){   sum(is.na(x)==F & (x==1))/ length(x) }
	myprev2 <- function(x){   sum(is.na(x)==F & (x==1))/ sum(is.na(x)==F) } # <--- smaller risk set

		PH.status = ANS


		prev.est = apply(PH.status, 2, myprev2)
		prev.est
		#   PH.45   PH.46   PH.47   PH.48   PH.49   PH.50   PH.51   PH.52   PH.53   PH.54   PH.55   PH.56   PH.57   PH.58   PH.59   PH.60   PH.61   PH.62   PH.63
		# 0.03301 0.03536 0.03787 0.04055 0.04341 0.04645 0.04969 0.05312 0.05674 0.06056 0.06457 0.06876 0.07312 0.07764 0.08231 0.08710 0.09198 0.09693 0.10192
		#   PH.64   PH.65   PH.66   PH.67   PH.68   PH.69   PH.70   PH.71   PH.72   PH.73   PH.74   PH.75   PH.76   PH.77   PH.78   PH.79   PH.80   PH.81   PH.82
		# 0.10692 0.11193 0.11695 0.12196 0.12697 0.13198 0.13700 0.14204 0.14713 0.15227 0.15751 0.16285 0.16834 0.17396 0.17973 0.18566 0.19172 0.19794 0.20431
		#   PH.83   PH.84   PH.85   PH.86   PH.87   PH.88   PH.89   PH.90
		# 0.21084 0.21750 0.21700 0.20783 0.19451 0.17726 0.15828 0.13985

		meanPH = apply(PH.prev, 2, mean)
		#      PH.45      PH.46      PH.47      PH.48      PH.49      PH.50      PH.51      PH.52      PH.53      PH.54      PH.55      PH.56      PH.57      PH.58
		# 0.03300770 0.03535799 0.03786811 0.04054662 0.04340267 0.04644713 0.04968403 0.05311400 0.05673915 0.06055912 0.06456629 0.06875358 0.07311641 0.07763791
		#      PH.59      PH.60      PH.61      PH.62      PH.63      PH.64      PH.65      PH.66      PH.67      PH.68      PH.69      PH.70      PH.71      PH.72
		# 0.08230133 0.08709190 0.09197814 0.09692679 0.10191271 0.10691347 0.11192804 0.11694270 0.12195796 0.12696543 0.13197488 0.13699409 0.14203792 0.14712222
		#      PH.73      PH.74      PH.75      PH.76      PH.77      PH.78      PH.79      PH.80      PH.81      PH.82      PH.83      PH.84      PH.85      PH.86
		# 0.15226818 0.15750191 0.16284829 0.16833137 0.17395649 0.17972664 0.18565043 0.19171777 0.19793704 0.20430688 0.21083354 0.21749855 0.22432160 0.23128332
		#      PH.87      PH.88      PH.89      PH.90
		# 0.23839810 0.24565794 0.25307421 0.26063457

		#plot(ages, 100*prev.est, pch=18, cex=1.8, ylim=c(6,13), main="[Family History] Without OCM imposed \nSimulation vs. Model prediciton", cex.main=1.5,
		plot(ages, 100*prev.est, pch=18, cex=1.8, ylim=c(0,25), main="[Personal History] With OCM imposed \nSimulation vs. Model prediciton", cex.main=1.5,

			col="red", xlab="Age", ylab="PH prevalence (%)",cex.axis=1.5, cex.lab=1.5)
		points(ages, 100*meanPH, col="blue", pch=16)
		legend(x="topleft", legend=c("Simulated","Model-prediction"), col=c("red","blue"), pch=c(18,16))


		plot(ages[1:41], (100*prev.est)[1:41], pch=18, cex=1.8, ylim=c(0,25), main="[Personal History] With OCM imposed \nSimulation vs. Model prediciton", cex.main=1.5,

			col="red", xlab="Age", ylab="PH prevalence (%)",cex.axis=1.5, cex.lab=1.5)
		points(ages, 100*meanPH, col="blue", pch=16)
		legend(x="topleft", legend=c("Simulated","Model-prediction"), col=c("red","blue"), pch=c(18,16))



		pkdat = mydat.big[,paste("PY.",ages,sep="")]
		# > pkdat[1:10,]
		#        PY.45     PY.46     PY.47     PY.48     PY.49     PY.50     PY.51     PY.52     PY.53     PY.54     PY.55     PY.56     PY.57     PY.58     PY.59     PY.60
		# 1   0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
		# 2   0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
		# 3  28.053756 29.020226 29.981163 30.936569 31.886442 32.830783 33.769592 34.702868 35.630612 36.552824 37.469504 38.380651 39.286266 40.186349 41.080900 41.969919
		# 4  27.403327 28.369797 29.330735 30.286140 31.236013 32.180354 33.119163 34.052439 34.980184 35.902395 36.819075 37.730223 38.635838 39.535921 40.430471 41.319490

		####### visualize ######


			doPlot=F
			if(doPlot==T){
					#setwd(outdir)
					#pdf("PH.status_trajectories.500_PY_added_fixed.pdf")
					pdf("PH.status_trajectories.500_PY_added_fixed_FEMALE.pdf")

						kk=500
						par(mar=c(5,6,5,5))

						for(u in 1:kk){

							rcc=as.character(mydat.sm[u,"race"])
							ed=as.character(mydat.sm[u,"edu"])

								plot(ages[1:41], PH.status[u,1:41], pch=16, col="red",cex.lab=1.5,cex.main=1.5, cex.axis=1.5, xlab="Age", ylab="Family History Status (0 or 1)", ylim=c(0,2),
										main=paste("Subject ID=",u,"\n(gender=",Gender,", race=",rcc," & edu=",ed,")",  sep=""),axes=F)
								axis(1,cex.axis=1.5)
								axis(2,cex.axis=1.5)

								axis(4, at=seq(0,1.5, by=0.5), labels=seq(0,1.5, by=0.5)*100, cex.axis=1.5)
								lines(ages[1:41], PH.status[u,1:41], lty="dotted", col="red")
								mtext("Pack-Years", side=4, line=2.2, cex=1.5)

								### estimated probablity ###

								lines(ages[1:41],PH.prev[u,1:41]*10,pch=16, col="dark grey")#, lty="dotted")

								 abline(v=ageOCM[u]-1, col="blue", lty="dotted", lwd=1.5)
								 #points(0, ageOCM[u]

								### pk years ###

								lines(ages[1:41],pkdat[u,1:41]/100,lty="dotted", col="dark green")#, lty="dotted")
								points(ages[1:41],pkdat[u,1:41]/100,pch=18, col="dark green")#, lty="dotted")




							#mtext("Cig/Day", side=4, line=2.2,cex=1.5)

								legend(x="topleft",legend=c("PH status","Pack-years", "OCM age"),pch=c(16,18, 16), col=c("red","dark green","blue"),cex=1.2,lty=c("solid","dotted", "dotted"))

							}

				  dev.off()

			}#end of if(doPlot==T){


			############ (4) barplot compare to the reference data (age = 55) #############

			 simph55 = prev.est["PH.55"]
			#0.10779

			  par(mar=c(5,5,5,3))
				#ref.fh.ci = c(9.74, 11.90)
				ci1=ref.ph.ci[1]
				ci2=ref.ph.ci[2]

			   mat=cbind(ref.ph, simph55*100)
			   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="PHC prevalence (%)",
			   main="Reference vs. Simulated \n Prevalence of Personal History Cancer(age 55)", cex.main=1.5, ylim=c(0,15))

			   ##### confidence interval ###
			   xs = c(1.5,2.5)#,7.5)

			   for(u in 1:length(xs)){


			   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

			   }#end of

			  legend(x="topleft", legend=c("Reference", "Simulated-based"), fill=c("red","yellow"), ncol=2,cex=1)



			###### [5] Simulating COPD given other predictors ####################################################

	cat("Simulating COPD\n", sep="")

			# > coef.ph
			#  (Intercept)  ns(age, 3)1  ns(age, 3)2  ns(age, 3)3        raceA        raceB        raceH  ns(bmi, 2)1  ns(bmi, 2)2          pky
			# -1.816925731  0.775599266  1.395902438  0.727633924 -1.134807420 -0.519480798 -0.170029629 -1.098434095  1.524776802  0.005378612

			#mydat.sm = data.frame(data0, age=rep(ag,nrow(cigdat0)), cigdat0)


			################# [5.1] Simulating Pr(COPD=1 | age, smoking, BMI) for each individual over 45:90 #################

			COPD.prev =NULL

			########## (1) extract information from OUT.fh ##########################
			# > names(OUT.fh)
			#  [1] "mycoef.adj"    "mycoef.before" "glm.fh"        "glm.or"        "prev.fh.adj"   "prev.fh.unadj" "ref.fh"        "ref.fh.ci"
			#  [9] "ns.mat.age"    "ns.mat.pky"

			glm.copd = OUT.copd$glm.copd
			# > names(OUT.copd)
			# [1] "mycoef.adj"      "mycoef.before"   "glm.copd"        "glm.or"          "prev.copd.adj"   "prev.copd.unadj"
			# [7] "ref.copd"        "ref.ph.ci"

			coef.before = OUT.copd$mycoef.before
			#   (Intercept)             fh    ns(age, 4)1    ns(age, 4)2    ns(age, 4)3    ns(age, 4)4     educollege     edupostcol
			#    -2.32041572     0.17092388     0.08191215     0.41608891     0.51726281     0.56661253    -0.26859716    -0.25444026
			#          raceA          raceB          raceH    ns(bmi, 3)1    ns(bmi, 3)2    ns(bmi, 3)3 cigstatCurrent  cigstatFormer
			#    -0.38035367     0.18258225    -0.25465492    -0.54750785    -1.81169289     1.04942856     0.12205001     0.20551756
			#    ns(pky, 2)1    ns(pky, 2)2         cigday
			#     6.41229669     3.14674028    -0.02522479

			coef.adj = OUT.copd$mycoef.adj  # increased prevalence by calibration
			#    (Intercept)             fh    ns(age, 4)1    ns(age, 4)2    ns(age, 4)3    ns(age, 4)4     educollege     edupostcol
			#    -1.75191387     0.17092388     0.08191215     0.41608891     0.51726281     0.56661253    -0.26859716    -0.25444026
			#          raceA          raceB          raceH    ns(bmi, 3)1    ns(bmi, 3)2    ns(bmi, 3)3 cigstatCurrent  cigstatFormer
			#    -0.38035367     0.18258225    -0.25465492    -0.54750785    -1.81169289     1.04942856     0.12205001     0.20551756
			#    ns(pky, 2)1    ns(pky, 2)2         cigday
			#     6.41229669     3.14674028    -0.02522479

			####### (2) prepare for covariate data ###############################

			pkyDAT = DAT[,grep("PY",colnames(DAT))]
				# > pkyDAT[1:3,]
				#      PY.45    PY.46    PY.47    PY.48    PY.49    PY.50    PY.51    PY.52    PY.53    PY.54   PY.55    PY.56    PY.57    PY.58   PY.59
				# 1  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.0000  0.00000  0.00000  0.00000  0.0000
				# 2  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.0000  0.00000  0.00000  0.00000  0.0000
				# 3 28.05376 29.02023 29.98116 30.93657 31.88644 32.83078 33.76959 34.70287 35.63061 36.55282 37.4695 38.38065 39.28627 40.18635 41.0809
				#      PY.60   PY.61    PY.62    PY.63    PY.64    PY.65    PY.66    PY.67    PY.68    PY.69    PY.70    PY.71    PY.72    PY.73    PY.74
				# 1  0.00000  0.0000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000
				# 2  0.00000  0.0000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000

				# > BMIdat[1:5,]
				#     BMI.45   BMI.46   BMI.47   BMI.48   BMI.49   BMI.50   BMI.51   BMI.52   BMI.53   BMI.54   BMI.55   BMI.56   BMI.57   BMI.58
				# 1 30.08999 30.04544 30.00089 29.95634 29.91179 29.86709 29.82145 29.77393 29.72360 29.66952 29.61076 29.54637 29.47542 29.39698
				# 2 29.12122 29.07667 29.03212 28.98757 28.94302 28.89832 28.85267 28.80516 28.75483 28.70075 28.64199 28.57760 28.50665 28.42820
				# 3 27.27928 27.23138 27.18170 27.13030 27.07723 27.02238 26.96503 26.90430 26.83930 26.76915 26.69297 26.60987 26.51897 26.41938
				# 4 27.73235 27.68628 27.63839 27.58871 27.53731 27.48408 27.42830 27.36908 27.30554 27.23679 27.16195 27.08015 26.99049 26.89209
				# 5 27.54256 27.48599 27.42780 27.36806 27.30680 27.24395 27.17875 27.11034 27.03782 26.96032 26.87695 26.78683 26.68907 26.58279

			mydat.big = data.frame(cbind(data0, pkyDAT, BMIdat))
				# > mydat.big[1:10,]
				#    race     edu     PY.45     PY.46     PY.47     PY.48     PY.49     PY.50     PY.51     PY.52     PY.53     PY.54     PY.55     PY.56
				# 1     B  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 2     W  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 3     W college 28.053756 29.020226 29.981163 30.936569 31.886442 32.830783 33.769592 34.702868 35.630612 36.552824 37.469504 38.380651
				# 4     B  <=high 27.403327 28.369797 29.330735 30.286140 31.236013 32.180354 33.119163 34.052439 34.980184 35.902395 36.819075 37.730223
				# 5     W  <=high 24.382102 25.076264 25.757649 26.426256 27.082086 27.725139 28.355413 28.972911 29.577631 30.169573 30.748738 31.315125
				# 6     W  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 7     H  <=high 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535 43.645535
				# 8     H  <=high  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000
				# 9     W  <=high  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161  0.107161
				# 10    W  <=high 33.435355 34.653188 35.858235 37.050496 38.229970 39.396659 40.550562 41.691679 42.820009 43.935554 45.038312 46.128285

			### smoking status change ##

			smkDAT[1:10,1:10]
			#      STAT.45   STAT.46   STAT.47   STAT.48   STAT.49   STAT.50   STAT.51   STAT.52   STAT.53   STAT.54
			#  [1,] "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"
			#  [2,] "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"
			#  [3,] "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current"
			#  [4,] "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current"
			#  [5,] "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current"
			#  [6,] "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"
			#  [7,] "Former"  "Former"  "Former"  "Former"  "Former"  "Former"  "Former"  "Former"  "Former"  "Former"
			#  [8,] "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"   "Never"
			#  [9,] "Former"  "Former"  "Former"  "Former"  "Former"  "Former"  "Former"  "Former"  "Former"  "Former"
			# [10,] "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current" "Current"

			cpdDAT[1:10,1:10]
			# > cpdDAT[1:10,1:10]
			#         CPD.45   CPD.46   CPD.47   CPD.48   CPD.49   CPD.50   CPD.51   CPD.52   CPD.53   CPD.54
			#  [1,]  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000
			#  [2,]  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000
			#  [3,] 19.44004 19.32940 19.21875 19.10811 18.99746 18.88682 18.77617 18.66553 18.55488 18.44424
			#  [4,] 19.44004 19.32940 19.21875 19.10811 18.99746 18.88682 18.77617 18.66553 18.55488 18.44424
			#  [5,] 14.13879 13.88324 13.62769 13.37215 13.11660 12.86105 12.60550 12.34995 12.09440 11.83885
			#  [6,]  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000
			#  [7,]  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000
			#  [8,]  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000
			#  [9,]  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000
			# [10,] 24.61238 24.35666 24.10094 23.84522 23.58950 23.33378 23.07805 22.82233 22.56661 22.31089

			durDAT[1:10,1:10] # cigyear
			#    DUR.45 DUR.46 DUR.47 DUR.48 DUR.49 DUR.50 DUR.51 DUR.52 DUR.53 DUR.54
			# 1       0      0      0      0      0      0      0      0      0      0
			# 2       0      0      0      0      0      0      0      0      0      0
			# 3      30     31     32     33     34     35     36     37     38     39
			# 4      29     30     31     32     33     34     35     36     37     38
			# 5      33     34     35     36     37     38     39     40     41     42
			# 6       0      0      0      0      0      0      0      0      0      0
			# 7      22     22     22     22     22     22     22     22     22     22

			FH.status[1:10,1:5]
			#       FH.45 FH.46 FH.47 FH.48 FH.49
			#  [1,]     1     1     1     1     1
			#  [2,]     0     0     0     0     0
			#  [3,]     0     0     0     0     0
			#  [4,]     1     1     1     1     1
			#  [5,]     0     1     1     1     1
			#  [6,]    NA    NA    NA    NA    NA
			#  [7,]    NA    NA    NA    NA    NA
			#  [8,]     0     0     0     0     0
			#  [9,]     0     1     1     1     1
			# [10,]     0     0     0     0     0


			# mycoef=coef.fh
			# ns.mat.age = OUT.fh$ns.mat.age
			# ns.mat.pky = OUT.fh$ns.mat.pky

			######### (3) Predict the probability for age = 45:90 ###############################

			for(j in 1:length(ages)){

				################ (a) make design matrix for each age #######
				# 	> coef.adj
				#    (Intercept)             fh    ns(age, 4)1    ns(age, 4)2    ns(age, 4)3    ns(age, 4)4     educollege     edupostcol
				#    -1.75191387     0.17092388     0.08191215     0.41608891     0.51726281     0.56661253    -0.26859716    -0.25444026
				#          raceA          raceB          raceH    ns(bmi, 3)1    ns(bmi, 3)2    ns(bmi, 3)3 cigstatCurrent  cigstatFormer
				#    -0.38035367     0.18258225    -0.25465492    -0.54750785    -1.81169289     1.04942856     0.12205001     0.20551756
				#    ns(pky, 2)1    ns(pky, 2)2         cigday
				#     6.41229669     3.14674028    -0.02522479
				# >

				ag=ages[j];ag

				### extract covariate column name that change by age!
				bminame=paste("BMI",ag,sep=".")
				pkname=paste("PY",ag,sep=".")
				cpdname=paste("CPD",ag,sep=".")
				cigname=paste("STAT",ag,sep=".")
				durname=paste("DUR",ag,sep=".")
				fhname=paste("FH",ag,sep=".")

				# > pkname
				# [1] "PY.45"
				# > bminame
				# [1] "BMI.45"

				### covariates data ###


				mydat.sm0 = data.frame(fh=FH.status[,fhname],  age=rep(ag,nrow(cigdat0)), edu=data0[,"edu"], race=data0[,"race"],
					bmi=as.numeric(as.character(mydat.big[,bminame])),cigstat=smkDAT[,cigname], pky=as.numeric(as.character(mydat.big[,pkname])), cigday=cpdDAT[,cpdname], cigyears=durDAT[,durname] )
				# > mydat.sm0[1:10,]
				#    fh age    edu race      bmi cigstat       pky   cigday
				# 1   1  45 <=high    W 29.12122   Never  0.000000  0.00000
				# 2   0  45 <=high    H 28.89886   Never  0.000000  0.00000
				# 3   0  45 <=high    W 27.68076 Current 28.053756 19.44004
				# 4   1  45 <=high    B 27.73235 Current 27.403327 19.44004
				# 5   0  45 <=high    H 27.63347 Current 24.382102 14.13879
				# 6  NA  45 <=high    W 29.12122   Never  0.000000  0.00000
				# 7  NA  45 <=high    W 28.99155  Former 43.645535  0.00000
				# 8   0  45 <=high    B 30.08999   Never  0.000000  0.00000
				# 9   0  45 <=high    W 28.09225  Former  0.107161  0.00000
				# 10  0  45 <=high    W 27.79499 Current 33.435355 24.61238


				#################### (b) predict using the regression output ###########################
				# > coef(glm.ph)
				#  (Intercept)  ns(age, 3)1  ns(age, 3)2  ns(age, 3)3        raceA        raceB        raceH  ns(bmi, 2)1  ns(bmi, 2)2          pky
				# -3.494087943  0.775599266  0.465300813  0.727633924 -1.134807420 -0.519480798 -0.170029629 -1.098434095  1.524776802  0.005378612

				pr0=predict(glm.copd, newdata=mydat.sm0)
				pr0[1:5]
				#        1         2         3         4         5
				# -3.591972 -4.022918 -3.032487 -2.701821 -3.289863

				pr=pr0

				# > sum(is.na(pr0))/length(pr0)
				# [1] 0.11244       ----> died early


				prob0 = exp(pr0)/(1+exp(pr0))
		mean(prob0,na.rm=T)
				# > mean(prob0)
				# [1] 0.03796671

				sum(prob0,na.rm=T)/sum(!is.na(prob0))
				#[1] 0.04871766

				#### predict using calibrated parameters -----without manual calibration #####


				# > cbind(coef.before,coef.adj)
				#              coef.before     coef.adj
				# (Intercept) -2.809877361 -2.191704342
				# age          0.008341419  0.008341419
				# educollege  -0.332164998 -0.332164998
				# edupostcol  -0.122890946 -0.122890946
				# raceA       -0.273522164 -0.273522164
				# raceB        0.189874305  0.189874305
				# raceH        0.039115084  0.039115084
				# ns(bmi, 3)1  0.343033939  0.343033939
				# ns(bmi, 3)2 -0.259201973 -0.259201973
				# ns(bmi, 3)3  1.774924396  1.774924396
				# cigyears     0.011828153  0.011828153
				# pky          0.025526378  0.025526378
				# cigday      -0.018510667 -0.018510667
				# >

		glm.copd$coefficients = coef.adj


				if(Gender=="M"){
				######## secondary calibration---prevalence too high...

				glm.copd$coefficients[1] = coef.before[1]*0.8

				   #glm.ph$coefficients[3] = coef.before[3]*1

				}#end of Gender==M


				if(Gender=="F"){
				######## secondary calibration---prevalence too high...


				glm.copd$coefficients[1] = coef.adj[1]*1.35
				glm.copd$coefficients[2] = coef.adj[2]*1.55

				   #glm.ph$coefficients[3] = coef.before[3]*1

				}#end of Gender==M

				pr=predict(glm.copd, newdata=mydat.sm0)
				pr[1:5]
				#         1         2         3         4         5
				# -2.843581 -3.007956 -2.650827 -3.175521 -2.839019
				# > mean(pr0)
				# [1] -4.228715
				# > mean(pr1)
				# [1] -4.228715

					doThis=F
					if(doThis==T){

							# > names(glm.copd)
							#  [1] "coefficients"      "residuals"         "fitted.values"     "effects"           "R"                 "rank"              "qr"
							#  [8] "family"            "linear.predictors" "deviance"          "aic"               "null.deviance"     "iter"              "weights"
							# [15] "prior.weights"     "df.residual"       "df.null"           "y"                 "converged"         "boundary"          "model"
							# [22] "call"              "formula"           "terms"             "data"              "offset"            "control"           "method"
							# [29] "contrasts"         "xlevels"


							mynames=c("coefficients","terms","rank","family","qr","deviance","null.deviance","aic")
							glm.copd2=glm.copd
							glm.copd[[2]]=glm.copd[[3]]=glm.copd[[4]]=glm.copd[[5]]=glm.copd[[9]]=glm.copd[[12]]=glm.copd[[13]]=NA
							glm.copd[[14]]=glm.copd[[15]]=glm.copd[[16]]=glm.copd[[17]]=glm.copd[[18]]=glm.copd[[19]]=glm.copd[[20]]=NA
							glm.copd[[21]]=glm.copd[[22]]=glm.copd[[23]]=glm.copd[[25]]=glm.copd[[26]]=glm.copd[[27]]=glm.copd[[28]]=glm.copd[[29]]=NA

							#setwd(outdir)
							#dump(list='glm.copd', file="test.dump")
							#dump(list='glm.copd2', file="test2.dump")

							pr0=predict(glm.copd, newdata=mydat.sm0[1:10,])
							pr0[1:5]


					}

				### risk ####

				prob = exp(pr)/(1+exp(pr))
				# > prob[1:5]
				#         1         2         3         4         5
				# 0.1227892 0.1236990 0.1208236 0.1365458 0.1365026
				# > (exp(pr0)/(1+exp(pr0)))[1:5]
				#          1          2          3          4          5
				# 0.08814469 0.08882373 0.08667888 0.09845549 0.09842296

				mean(prob,na.rm=T)
				# > mean(prob1)
				# [1] 0.05566851

				sum(prob,na.rm=T)/sum(!is.na(prob))
				#
				# [1] 0.08122933
				# >
				 if(j==1) COPD.prev = prob
				 if(j>1) COPD.prev= cbind(COPD.prev, prob)

#				 print(ag)

				}#end of ages


			colnames(COPD.prev)=paste("COPD",ages,sep=".")
			# > COPD.prev[1:10,]
			#       COPD.45    COPD.46    COPD.47    COPD.48    COPD.49    COPD.50    COPD.51    COPD.52    COPD.53    COPD.54    COPD.55
			# 1  0.04637677 0.04636497 0.04635334 0.04634187 0.04633057 0.04632076 0.04631907 0.04633347 0.04637196 0.04644261 0.04655363
			# 2  0.03063742 0.03063005 0.03062279 0.03061564 0.03060860 0.03060257 0.03060200 0.03061227 0.03063881 0.03068710 0.03076275
			# 3  0.07842184 0.08120097 0.08403321 0.08691825 0.08985575 0.09284808 0.09590893 0.09905672 0.10231228 0.12297851 0.12702030
			# 4  0.10590026 0.10955577 0.11327329 0.11705191 0.12089070 0.12479218 0.12877348 0.13285757 0.13707027 0.14144050 0.14600063
			# 5  0.06172459 0.07459586 0.07681311 0.07904781 0.08129892 0.08356790 0.08586654 0.08821076 0.09061845 0.09310970 0.09570703
			# 6          NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA
			# 7          NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA
			# 8  0.04800016 0.04798435 0.04796871 0.04795324 0.04793793 0.04792416 0.04791869 0.04792967 0.04796529 0.04803381 0.04814359
			# 9  0.04706260 0.05534384 0.05533894 0.05533488 0.05533169 0.05533104 0.05534102 0.05537146 0.05543230 0.05553371 0.05568617
			# 10 0.08311747 0.08690448 0.09077485 0.09472653 0.09875738 0.10286811 0.10707182 0.11138707 0.11583539 0.12044157 0.12523401
			#       COPD.56    COPD.57    COPD.58    COPD.59    COPD.60    COPD.61    COPD.62    COPD.63    COPD.64    COPD.65    COPD.66
			# 1  0.04671342 0.04693076 0.04721489 0.04759061 0.04814443 0.04898351 0.05022559 0.05196235 0.05412320 0.05658314 0.05919485
			# 2  0.03087152 0.03101945 0.03121288 0.03711673 0.03755826 0.03822622 0.03921410 0.04059524 0.04231500 0.04427551 0.04636068
			# 3  0.13127053 0.13576694 0.14055234 0.14571580 0.15152392 0.15832150 0.16650460 0.17640644 0.18787213 0.20055350 0.21400535
			# 4  0.15078696 0.15584030 0.16120670 0.16698346 0.17346516 0.18103067 0.19011125 0.20106191 0.21369257 0.22760145 0.24228608
			# 5  0.09843582 0.10132473 0.10440638 0.10774904 0.11155734 0.11609521 0.12166650 0.12852954 0.13657129 0.14553273 0.15507925
			# 6          NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA
			# 7          NA         NA         NA         NA         NA         NA         NA         NA         NA         NA         NA
			# > colSums(is.na(COPD.prev))/nrow(COPD.prev)
			# COPD.45 COPD.46 COPD.47 COPD.48 COPD.49 COPD.50 COPD.51 COPD.52 COPD.53 COPD.54 COPD.55 COPD.56 COPD.57 COPD.58 COPD.59
			# 0.11244 0.11681 0.12163 0.12611 0.13110 0.13612 0.14136 0.14674 0.15221 0.15809 0.16455 0.17067 0.17814 0.18607 0.19394
			# COPD.60 COPD.61 COPD.62 COPD.63 COPD.64 COPD.65 COPD.66 COPD.67 COPD.68 COPD.69 COPD.70 COPD.71 COPD.72 COPD.73 COPD.74
			# 0.20279 0.21266 0.22265 0.23414 0.24630 0.26022 0.27413 0.28947 0.30561 0.32131 0.33820 0.35543 0.37329 0.39256 0.41339
			# COPD.75 COPD.76 COPD.77 COPD.78 COPD.79 COPD.80 COPD.81 COPD.82 COPD.83 COPD.84 COPD.85 COPD.86 COPD.87 COPD.88 COPD.89
			# 0.43441 0.45737 0.48147 0.50739 0.53323 0.56128 0.58960 0.61905 0.64874 0.67913 0.70940 0.73962 0.76890 0.79767 0.82494
			# COPD.90
			# 0.84908
			#

			### this exclude NA (deaths) from the denominator

			meanCOPD=apply(COPD.prev,2,mean,na.rm=T);meanCOPD
			# > apply(COPD.prev,2,mean,na.rm=T)
			#    COPD.45    COPD.46    COPD.47    COPD.48    COPD.49    COPD.50    COPD.51    COPD.52    COPD.53    COPD.54    COPD.55
			# 0.06452217 0.06625282 0.06796354 0.06963156 0.07131046 0.07292076 0.07454969 0.07620813 0.07785771 0.07947611 0.08122933
			#    COPD.56    COPD.57    COPD.58    COPD.59    COPD.60    COPD.61    COPD.62    COPD.63    COPD.64    COPD.65    COPD.66
			# 0.08301483 0.08475472 0.08666335 0.08873091 0.09092422 0.09353008 0.09684331 0.10092008 0.10561578 0.11087742 0.11617726
			#    COPD.67    COPD.68    COPD.69    COPD.70    COPD.71    COPD.72    COPD.73    COPD.74    COPD.75    COPD.76    COPD.77
			# 0.12130277 0.12593370 0.13009530 0.13402388 0.13738295 0.14048101 0.14323707 0.14568775 0.14807032 0.15021389 0.15209667
			#    COPD.78    COPD.79    COPD.80    COPD.81    COPD.82    COPD.83    COPD.84    COPD.85    COPD.86    COPD.87    COPD.88
			# 0.15421867 0.15637383 0.15797382 0.15987598 0.16220188 0.16400830 0.16553358 0.16730530 0.16933026 0.17150138 0.17359536
			#    COPD.89    COPD.90
			# 0.17491575 0.17608344
			#

			# > 			mean(COPD.prev[,"COPD.55"],na.rm=T)
			# [1] 0.08122933
			# > 			ref.copd
			# [1] 7.4


			# > 			mean(FH.prev[,"FH.55"])
			# [1] 0.07823437 --> 2
			# > 			ref.fh
			# [1] 6.14

			meancopd55=mean(COPD.prev[,"COPD.55"],na.rm=T)


			############ (4) barplot compare to the reference data (age = 55) #############

			  par(mar=c(5,5,5,3))
				#ref.fh.ci = c(9.74, 11.90)
			   ci1=ref.copd.ci[1]
			   ci2=ref.copd.ci[2]

			   mat=cbind(ref.copd, meancopd55*100)
			   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="COPD prevalence (%)",
			   main="Prevalence (%) of COPD (age 55)", cex.main=1.5, ylim=c(0,15))

			   ##### confidence interval ###
			   xs = c(1.5,2.5)#,7.5)

			   for(u in 1:length(xs)){


			   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

			   }#end of

			  legend(x="topleft", legend=c("Reference", "Simulated prob-based"), fill=c("red","yellow"), ncol=2,cex=1)


			####### time trajectory ########

			meanCOPD = apply(COPD.prev,2,mean,na.rm=T)
			# > meanFH
			#      FH.45      FH.46      FH.47      FH.48      FH.49      FH.50      FH.51      FH.52      FH.53      FH.54      FH.55      FH.56
			# 0.09780466 0.09885175 0.09990097 0.10095306 0.10200860 0.10306418 0.10410599 0.10511748 0.10607988 0.10697485 0.10778478 0.10849102
			#      FH.57      FH.58      FH.59      FH.60      FH.61      FH.62      FH.63      FH.64      FH.65      FH.66      FH.67      FH.68
			# 0.10907303 0.10951272 0.10979188 0.10989170 0.10979693 0.10949308 0.10897003 0.10824487 0.10733795 0.10627236 0.10506911 0.10375099
			par(mar=c(5,6,5,3))
			plot(ages,100*meanCOPD,pch=16, ylim=c(0,25),col="blue",
			main="(Simulated probability-based) \n COPD prevalence (%)",
				xlab="Age",ylab="COPD prevalence (%) \nPr(COPD=1 | age, race, edu, FH, smoking, BMI)",cex.lab=1.5,cex.main=1.5, cex.axis=1.5)

			abline(v=55, lty="dotted",col="red")
			abline(h=ref.copd, lty="dotted",col="red")


			##### adding CDC points ###

			par(mar=c(5,6,5,3))
			plot(ages,100*meanCOPD,pch=16, ylim=c(0,25),col="blue",
			main="(Simulated probability-based) \n COPD prevalence (%)",
				xlab="Age",ylab="COPD prevalence (%) \nPr(COPD=1 | age, race, edu, FH, smoking, BMI)",cex.lab=1.5,cex.main=1.5, cex.axis=1.5)

			abline(v=55, lty="dotted",col="red")
			abline(h=ref.copd, lty="dotted",col="red")

			xx=c(55, 75)
			yy=c(7.4, 11.9)
			points(xx,yy,pch=17,col="red")


			legend(x="topleft", legend=c("CDC", "Model"), fill=c("red","blue"),cex=1.2)





			############# (5) visualize the results ##############

			########## not as informative: will use COPD status below for better presesntation #######
			doPlot=F
			if(doPlot==T){
						#setwd(outdir)
					#pdf("COPD.trajectories.500_female.pdf")

						kk=500
						par(mar=c(5,6,5,3))

						for(u in 1:kk){

							rcc=as.character(mydat.sm[u,"race"])
							ed=as.character(mydat.sm[u,"edu"])

								plot(ages,100*COPD.prev[u,],pch=16, ylim=c(0,35),col="blue",
									main=paste("Subject ID=",u,"\n(gender=",Gender,", race=",rcc," & edu=",ed,")",  sep=""),
										xlab="Age",ylab="COPD prevalence (%) \nPr(COPD=1 | age, race, edu, FH, smoking, BMI)",cex.lab=1.5,cex.main=1.5, cex.axis=1.5)

							   points(ages,pkyDAT[u,paste("PY",ages,sep=".")],pch=17, col=(1:kk)[u])


							#legend(x="topleft",legend=c("BMI","Cig/day"),pch=c(16,18), col=c("blue","red"),cex=1.2,lty=c("solid","dotted"))
							}

							#points(ages,BMIdat[u,],pch=16, col=(1:kk)[u])

				  dev.off()

			}#end of if(doPlot==T){


			################# [4.2] Simulating PH = 0 or 1 using the above simulated Pr(FH=1 | age, smoking, BMI) for each individual over 45:90 #################

			COPD.status= NULL

			####### OCM age of individuals #######
			# > DAT[1:3,1:10]
			#   X race gend birth_yr age_init age_cess age_death_OC quintile age_smoke1     CPD1
			# 1 1    0    0     1950     -999     -999           77       NA         NA       NA
			# 2 2    0    0     1950     -999     -999           87       NA         NA       NA
			# 3 3    0    0     1950       15     -999           67        3         15 4.926697

			ageOCM = DAT[,"age_death_OC"]
				# > ageOCM[1:5]
				# [1] 77 87 67 89 82
			# > range(ageOCM)
			# [1] -999   99    -999 means don't die until age 99 ##

			ageOCM[ageOCM == -999] = 100
			range(ageOCM)
			#[1]   0 100

			## major input: FH.prev

			# set.seed(seed)

			max.age = ages[order(meanCOPD,decreasing=T)[1]]
			max.copd = meanCOPD[order(meanCOPD,decreasing=T)[1]]
			max.age;max.copd
			# [1] 60
			# > max.ph
			#     FH.60
			# 0.1098917
			# >
			#[1] 0.1098917
			#seeds = runif(1,1000000, length(ages)*

			#for(u in 1:16){
			for(u in 1:length(ages)){

					copd.update= rep(NA, N)

					ag=ages[u];ag

					cname = paste("COPD",ag,sep=".");cname
					mat.pr=COPD.prev[,cname]
					# > pr[1:5]
					#          1          2          3          4          5
					# 0.09823288 0.09823288 0.06662215 0.10876315 0.10872762
							dim(mat.pr)=c(length(mat.pr),1)
							x=mat.pr[1,]
							samp.sm <- function(x) sample(c(0,1), size=1, prob = c(1-x, x))

							samp.sm2 <- function(x) {

								ans=NULL

								if(is.na(x)==F) ans=sample(c(0,1), size=1, prob = c(1-x, x))
								if(is.na(x)==T) ans=NA

								ans
							}#end of



					######## (step 1) At age = 45, just sample 0/1 from the given predicted probability ####

					if(ag==45){  # this is same as u==1

							###### (1) sampling ############

							# set.seed(u+seed)

							copd0=apply(mat.pr, 1, samp.sm2)
							 mean(copd0,na.rm=T)
							# [1] 0.09801
							# > fh0[1:10]
							#  [1] 0 0 0 0 1 0 0 0 0 1

							# > ph0[1:10]
							#  [1]  0  0  0  1  0 NA NA  0  0  0

					}#end of 45

					#####(step 2) From age > 45, among only people who have ph = 0, sample more 0/1 until the mean(Ph) (prevalence) reaches for the PH.prev[,46]
								######### repeat this until the maximum prevalence age ###

					if(ag > 45 ){

							### (1) take the previous year's fh status ###

							copd0 = ANS[,u-1] #
							#fh.previous = ANS[,u-1] #
							# > fh.previous[1:10]
							#  [1]  0  0  0  0  1 NA NA  0  0  0


					}#end of if(u > 45 and u <= max.age){



					#####(2) impose OCM ###########

	ix.dead = is.na(copd0)==T | ageOCM <= ag # identify who died prevous y
	#ix.dead = is.na(copd0)==F & ageOCM <= ag # identify who did die prevous y



						sum(ix.dead)
						#[1] 556 additional
						# > sum(ix.dead)/length(ix.dead)
						#[1] 0.11244    ----> why 11% die before 45? hmm...

						#ageOCM[ix.dead]
						# hist(ageOCM[ix.dead])

					copd = copd0
						#sum(fh[ix.dead],na.rm=T)/ sum(fh==1,na.rm=T)
						# > 	sum(fh[ix.dead])/ sum(fh==1)
						# [1] 0.1132537   ---> OK 10% of fh=1 at 45 died already

					copd[ix.dead]=NA

					##### (3) updated case status with OCM information : total population N is the initial population size

					## number of people alive by the time (people at risk)
					N.risk =  sum(!ix.dead); N.risk
					prev.before= sum(is.na(copd)==F & copd==1)/N.risk
					#prev.before= sum(is.na(ph)==F & ph==1)/N
					prev.before
					#[1] 0.03035

					myref= mean(COPD.prev[,cname],na.rm=T)
					myref
					#[1] [1] 0.0330077


					dif = myref - prev.before; dif  # should it be always positive? yes because initial population stays the same
					# > dif
					# [1] 0.01089466

					n.require = ceiling(dif * N.risk)
					#n.require = ceiling(dif * N)
					n.require
					#[1] 1090 # recruit 1090 more
#					print(paste("n.require=",n.require,sep=""))

					#### if there is at least one more case to recruit, do more sampling ###

					if(n.require > 0){


							##### (4) sample additional more among who don't have FH=1 ########

							case = copd
							mat.prob = mat.pr

							# set.seed(u+seed+1000*(u+seed))

				copd.update0 = mySampleMore2(case, mat.prob, n.require)
							# > names(ph.update0)
							# [1] "case.update" "prev.update"

							copd.update = copd.update0$case.update

							prev.aft= sum(is.na(copd.update)==F & copd.update==1)/N.risk
							prev.aft
							#[1] 0.09697
							myref

# 							print(paste("age=",ag,sep=""))
# 							print(paste("model average prev=",round(mean(COPD.prev[,cname],na.rm=T),3),sep=""))
# 							print(paste("Simulated binary COPD proportion (updated)=", round(prev.aft,3),sep=""))


					}#

					### if less than 1 required to sample, don't sample

					if(n.require <= 0)  {

					     copd.update = copd

					}


					#####(step 3) From age >= max.age, no more sampling of PH = 1 because FH prevalence is decreasing ###########


				 if(u==1){
				 		ANS = copd.update; dim(ANS)=c(length(copd.update),1)
				 		N.require = n.require

				 }

				 if(u>1){

					 	 ANS = cbind(ANS,copd.update)
					 	 N.require = c(N.require, n.require)


				 }# end of


		}#end of for(u in 1:length(ages)){

		colnames(ANS)=paste("COPD.",ages,sep="")
		colnames(ANS)=paste("COPD.",ages,sep="")

		# > ANS[1:50,]
			#      PH.45 PH.46 PH.47 PH.48 PH.49 PH.50 PH.51 PH.52 PH.53 PH.54 PH.55 PH.56 PH.57 PH.58 PH.59 PH.60 PH.61 PH.62 PH.63 PH.64 PH.65 PH.66 PH.67 PH.68 PH.69
			#  [1,]     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			#  [2,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1
			#  [3,]     0     0     0     0     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1     1     1    NA    NA    NA
			#  [4,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1     1     1     1
			#  [5,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0
			#  [6,]    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			#  [7,]    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			#  [8,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1
			#  [9,]     0     0     0     0     0     0     0     0     0     0     1    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [10,]     0     0     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			# [11,]     0     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			# [12,]     0     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			# [13,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1     1     1
			# [14,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1
			# [15,]     0     0     0     0     0     0    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [16,]     0     0     0     0     0     0     0     0    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [17,]     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1     1
			# [18,]     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			# [19,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1    NA    NA    NA    NA    NA    NA    NA    NA
			# [20,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0
			# [21,]    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [22,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0
			# [23,]     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			# [24,]     0     0     0     0     0     0     0     1     1    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [25,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0
			# [26,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1
			# [27,]    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA
			# [28,]     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     0     1     1     1     1
			# [29,]     0     0     0     0     0     0     0     0     0     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1     1
			#
		tt=cbind(DAT[,5:7],PY.55=DAT[,"PY.55"],BMI.55=mydat.big[,"BMI.55"], data0,round(PH.prev[,1:5],3), ANS)[1:20,]

		#setwd(outdir)
		#write.csv(tt,"PH.output.example.wo.OCM.csv")
		#write.csv(tt,"PH.output.example.with.OCM.csv")

		x=ANS[,1]
		dim(x)=c(length(x),1)
		#myprev <- function(x){   sum(is.na(x)==F & (x==1))/ length(x) }
		myprev2 <- function(x){   sum(is.na(x)==F & (x==1))/ sum(is.na(x)==F) }

		COPD.status = ANS


		prev.est = apply(COPD.status, 2, myprev2)
		prev.est
		#   PH.45   PH.46   PH.47   PH.48   PH.49   PH.50   PH.51   PH.52   PH.53   PH.54   PH.55   PH.56   PH.57   PH.58   PH.59   PH.60   PH.61   PH.62   PH.63
		# 0.03301 0.03536 0.03787 0.04055 0.04341 0.04645 0.04969 0.05312 0.05674 0.06056 0.06457 0.06876 0.07312 0.07764 0.08231 0.08710 0.09198 0.09693 0.10192
		#   PH.64   PH.65   PH.66   PH.67   PH.68   PH.69   PH.70   PH.71   PH.72   PH.73   PH.74   PH.75   PH.76   PH.77   PH.78   PH.79   PH.80   PH.81   PH.82
		# 0.10692 0.11193 0.11695 0.12196 0.12697 0.13198 0.13700 0.14204 0.14713 0.15227 0.15751 0.16285 0.16834 0.17396 0.17973 0.18566 0.19172 0.19794 0.20431
		#   PH.83   PH.84   PH.85   PH.86   PH.87   PH.88   PH.89   PH.90
		# 0.21084 0.21750 0.21700 0.20783 0.19451 0.17726 0.15828 0.13985

		meanCOPD = apply(COPD.prev, 2, mean,na.rm=T)
		#      PH.45      PH.46      PH.47      PH.48      PH.49      PH.50      PH.51      PH.52      PH.53      PH.54      PH.55      PH.56      PH.57      PH.58
		# 0.03300770 0.03535799 0.03786811 0.04054662 0.04340267 0.04644713 0.04968403 0.05311400 0.05673915 0.06055912 0.06456629 0.06875358 0.07311641 0.07763791
		#      PH.59      PH.60      PH.61      PH.62      PH.63      PH.64      PH.65      PH.66      PH.67      PH.68      PH.69      PH.70      PH.71      PH.72
		# 0.08230133 0.08709190 0.09197814 0.09692679 0.10191271 0.10691347 0.11192804 0.11694270 0.12195796 0.12696543 0.13197488 0.13699409 0.14203792 0.14712222
		#      PH.73      PH.74      PH.75      PH.76      PH.77      PH.78      PH.79      PH.80      PH.81      PH.82      PH.83      PH.84      PH.85      PH.86
		# 0.15226818 0.15750191 0.16284829 0.16833137 0.17395649 0.17972664 0.18565043 0.19171777 0.19793704 0.20430688 0.21083354 0.21749855 0.22432160 0.23128332
		#      PH.87      PH.88      PH.89      PH.90
		# 0.23839810 0.24565794 0.25307421 0.26063457

		#plot(ages, 100*prev.est, pch=18, cex=1.8, ylim=c(6,13), main="[Family History] Without OCM imposed \nSimulation vs. Model prediciton", cex.main=1.5,
		plot(ages, 100*prev.est, pch=18, cex=1.8, ylim=c(0,25), main="[COPD] With OCM imposed \nSimulation vs. Model prediciton", cex.main=1.5,

			col="red", xlab="Age", ylab="COPD prevalence (%)",cex.axis=1.5, cex.lab=1.5)
		points(ages, 100*meanCOPD, col="blue", pch=16)
		legend(x="topleft", legend=c("Simulated","Model-prediction"), col=c("red","blue"), pch=c(18,16))


# 		plot(ages[1:41], (100*prev.est)[1:41], pch=18, cex=1.8, ylim=c(0,25), main="[COPD] With OCM imposed \nSimulation vs. Model prediciton", cex.main=1.5,
#
# 			col="red", xlab="Age", ylab="COPD prevalence (%)",cex.axis=1.5, cex.lab=1.5)
# 		points(ages, 100*meanCOPD, col="blue", pch=16)
# 		legend(x="topleft", legend=c("Simulated","Model-prediction"), col=c("red","blue"), pch=c(18,16))



		####### visualize ######


			doPlot=F
			if(doPlot==T){
					#setwd(outdir)
					pdf("COPD.status_trajectories.500_PY_added_FEMALE.pdf")

						kk=500
						par(mar=c(5,6,5,5))

						for(u in 1:kk){

							rcc=as.character(mydat.sm[u,"race"])
							ed=as.character(mydat.sm[u,"edu"])


								plot(ages, COPD.status[u,], pch=16, col="red",cex.lab=1.5,cex.main=1.5, cex.axis=1.5, xlab="Age", ylab="COPD Status (0 or 1)", ylim=c(0,2),
										main=paste("Subject ID=",u,"\n(gender=",Gender,", race=",rcc," & edu=",ed,")",  sep=""),axes=F)
								axis(1,cex.axis=1.5)
								axis(2,cex.axis=1.5)

								axis(4, at=seq(0,1.5, by=0.5), labels=seq(0,1.5, by=0.5)*100, cex.axis=1.5)
								lines(ages, COPD.status[u,], lty="dotted", col="red")
								mtext("Pack-Years", side=4, line=2.2, cex=1.5)

								### estimated probablity ###

								lines(ages,COPD.prev[u,]*10,pch=16, col="dark grey")#, lty="dotted")

								 abline(v=ageOCM[u]-1, col="blue", lty="dotted", lwd=1.5)
								 #points(0, ageOCM[u]



								### pk years ###

								lines(ages,pkdat[u,1:length(ages)]/100,lty="dotted", col="dark green")#, lty="dotted")
								points(ages,pkdat[u,1:length(ages)]/100,pch=18, col="dark green")#, lty="dotted")

								#### family history yes ###
								points(ages, FH.status[u,]*0.25, pch=19, col="purple")
							    lines(ages,FH.status[u,]*0.25,lty="dotted", col="purple")#, lty="dotted")



							#mtext("Cig/Day", side=4, line=2.2,cex=1.5)

								legend(x="topleft",legend=c("COPD status","Pack-years", "OCM age" , "FH (yes: 0.25 vs. no:0)"),pch=c(16,18, 16,19), col=c("red","dark green","blue", "purple"),cex=1.2,lty=c("solid","dotted", "dotted"))

							}

				  dev.off()

			}#end of if(doPlot==T){


			############ (4) barplot compare to the reference data (age = 55) #############

			 simph55 = prev.est["COPD.55"]#-0.002
			#0.10779

			  par(mar=c(5,5,5,3))
				#ref.fh.ci = c(9.74, 11.90)
				ci1=ref.copd.ci[1]
				ci2=ref.copd.ci[2]

			   mat=cbind(ref.copd, simph55*100)
			   barplot(t(mat),col=c("red","yellow"),beside=T, cex.axis=1.5, cex.lab=1.5,ylab="COPD prevalence (%)",
			   main="Reference vs. Simulated \n Prevalence of COPD (age 55)", cex.main=1.5, ylim=c(0,15))

			   ##### confidence interval ###
			   xs = c(1.5,2.5)#,7.5)

			   for(u in 1:length(xs)){


			   lines(rep(xs[u],2), c(ci1[u],ci2[u]), lty="dotted", lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci1[u],ci1[u]), lwd=1.5)
			   lines(c(xs[u]-0.25, xs[u]+0.25), c(ci2[u],ci2[u]), lwd=1.5)

			   }#end of

			  legend(x="topleft", legend=c("Reference", "Simulated-based"), fill=c("red","yellow"), ncol=2,cex=1)



			######## report output: education, race, COPD status, family history of lung cancer, BMI over ages ################

			DAT.out = cbind(DAT[,-c(1:2)], smkDAT, cpdDAT, durDAT,
						edu=educ, race=race,
						BMIdat,
						FH.status, PH.status,
						COPD.status)


		   output = data.frame(cbind(edu=educ, race=race,
						BMIdat,
						FH.status, PH.status,
						COPD.status))

		  smkDat = cbind(smkDAT, cpdDAT, durDAT)

		  inputDat = DAT[,-c(1:2)]



		  output = list(outputOnly = output, output_smk = cbind(output, smkDat, DAT[,-1][,1:8]),  smkdata = smkDat, inputdata = inputDat)
		  output


			doThis=F
			if(doThis==T){

				#setwd(outdir)
				write.csv(DAT.out[1:100,], "temp.output.all_1010_2014.csv",na="")

			}

			output

}#end of whole function riskFactorGenerator


######### 1/17/2014: first version ########

riskFactorGenerator=function(DAT, PROB.edu.race, coef.bmi, coef.fh, coef.copd,   ref.bmi, ref.fh, ref.copd){

			N = nrow(DAT)
			AGES.bmi = AGES.copd = 45:100

			### other cause of mortality ##
			age.OCM = DAT[,"age_death_OC"]
			# > age.OCM[1:20]
			#  [1]   77   87   67   89   82   29   36 -999   56   78   87   94   83   81   51   53   84   76   62
			# [20]   91
			# > max(age.OCM)
			# [1] 99

			############## [1] From smoking history generator: decide smoking status at age: 60 (PLCO mean age) #####

			age_init = age_cess = smkstatus = pky = cigstop = NULL

			age.th = 60  # PLCO average age is 62

			age_init = DAT[,"age_init"]
			age_cess = DAT[,"age_cess"]

			## make smoking indicator for making "smkstatus" ##

			indic.current = age_init > 0 & (age_cess > age.th  | age_cess==-999) # started smoking, but quit after 60 or never quit
			sum(indic.current)/length(indic.current)
			#[1] 0.23275  # male

			indic.former = age_init > 0 & (age_cess <= age.th &  age_cess!=999) # started smoking, but quit before 60, and quit)
			sum(indic.former)/length(indic.former)
			#[1]  0.41673

			indic.never = age_init==-999
			sum(indic.never)/length(indic.never)
			#[1] 0.36609

			### smkstatus making ###
			smkstatus = rep(NA,nrow(DAT))
			smkstatus[indic.never]="Never"
			smkstatus[indic.former]="Former"
			smkstatus[indic.current]="Current"

			### obtain smoking status distribution ###

			TB.smk=table(smkstatus)/sum(table(smkstatus))
			TB.smk
			# current  former   never    MALE
			# 0.23275 0.40116 0.36609

			# smkstatus
			# Current  Former   Never    FEMALE
			# 0.17128 0.30737 0.52135


			#### obtain pack-years distribution ###

			pky0= DAT[, "PY.60"]
			#  [1]  0.000000  0.000000 41.969919 41.319490 33.452900  0.000000 43.645535  0.000000  0.107161
			# [10] 49.321486
			# > sum(is.na(pky0))
			# [1] 0

			### make category as used in model fitting ###
			pky=pky0
			pky[pky0 <=10] = "lst10"
			pky[pky0 > 10 & pky0<=30] ="10_30"
			pky[pky0 > 30 & pky0 <=60] = "30_60"
			pky[pky0 > 60 & pky0 <=100] = "60_100"
			pky[pky0>100]="gt100"

			TB.pky=table(pky)/length(pky); TB.pky
			# pky
			#   10_30   30_60  60_100   lst10    MALE
			# 0.21110 0.21102 0.06682 0.51106
			# pky
			#   10_30   30_60  60_100   lst10    FEMALE
			# 0.16092 0.12864 0.04292  0.66752


			### obtain year since quit reference distribution (needed for ##

			ysq0 = DAT[, "YSQ.60"]
			# > ysq0[1:10]
			#  [1] NA NA NA NA NA NA 11 NA 33 NA  ---> NA includes never smokers & those who NEVER QUIT smoking
			# > range(ysq0,na.rm=T)
			# [1]  1 35

			cigstop=ysq0
			cigstop[is.na(ysq0)==T  & smkstatus=="Never" ]="never"   # never smoker
			cigstop[is.na(ysq0)==T  & smkstatus!="Never"] = "0"   # those who are smokers but who didn't quit!
			cigstop[ysq0>0 & ysq0 <=20] = "0_20"
			cigstop[ysq0 >20 & ysq0<=40] = "20_40"
			cigstop[ysq0 >40 ] = "gt40"

			TB.cigstop = table(cigstop)/sum(table(cigstop)); TB.cigstop
			# cigstop
			#       0    0_20   20_40   never
			# 0.33119 0.20399 0.09873 0.36609    MALE
			# smkstatus
			# Current  Former   Never
			# 0.23275 0.40116 0.36609

			# cigstop
			#       0    0_20   20_40    gt40   never
			# 0.17899 0.15378 0.13326 0.01262 0.52135   FEMALE

			####### make reference distributions to be used for calibration in PLCO model fittings ####

			doThis=F
			if(doThis==T){
							## reference (age=50 to be used for COPD calibration)
				#ref.cigstop = c(0.37, 0.33, 0.2, 0.1, 0)  ; names(ref.cigstop)=c("never","cigstop.0", "cigstop.0_20", "cigstop.20_40",  "cigstop.gt40")
				# > ref.cigstop
				#         never     cigstop.0  cigstop.0_20 cigstop.20_40  cigstop.gt40
				#          0.37          0.33          0.20          0.10          0.00

				### reference (age=60 to be used for COPD calibration)
				ref.cigstop = c(0.37, 0.24, 0.19, 0.18, 0.02)  ; names(ref.cigstop)=c("never","cigstop.0", "cigstop.0_20", "cigstop.20_40",  "cigstop.gt40")

				# cigstop
				#       0    0_20   20_40    gt40   never
				# 0.24104 0.19040 0.18418 0.01829 0.36609

				### female ##
				ref.smk = c(0.52135, 0.30737,0.17128 ); names(ref.smk)=c("Never","Former","Current")
				ref.pky = c(0.66752 ,0.16092, 0.12864, 0.04292);names(ref.pky)=c("lst10", "10_30","30_60","60_100" )
				ref.cigstop = c(0.52135, 0.17899, 0.15378, 0.13326, 0.01262);names(ref.cigstop)=c("never","cigstop.0", "cigstop.0_20", "cigstop.20_40",  "cigstop.gt40")


	        }#end of



			############## [2] Assign education and race conditioning on smoking status: using Pr(edu, race | smoking status) ###################

		cat("Simulating education and race conditioning on smoking\n", sep="")

			# > PROB.edu.race  --> each column sums up to 1
			#                 Never      Former     Current
			# A-<=high  0.018566097 0.014800494 0.011702345
			# A-college 0.029658838 0.016959562 0.011278914
			# A-postcol 0.033799932 0.013370632 0.006149116
			# B-<=high  0.070439032 0.071277125 0.149026204
			# B-college 0.011267360 0.006635478 0.012977099
			# B-postcol 0.015566571 0.008859252 0.007674597
			# H-<=high  0.056075187 0.054224294 0.072637778
			# H-college 0.007104640 0.006208510 0.002314815
			# H-postcol 0.009016896 0.004782629 0.003468208
			# W-college 0.157620308 0.109228065 0.081830842
			# W-postcol 0.058473874 0.027350069 0.016765308
			# W-<=high  0.532411267 0.666303888 0.624174774

			smknames=colnames(PROB.edu.race) #[1] "Never"   "Former"  "Current"
			edu.race0 = rep("",length(smknames))
			myout.edu.race = rep(list(list()),3);names(myout.edu.race)=smknames

			for(j in 1:length(smknames)){

				smkname=smknames[j] #[1] "Never"
				indic = (smkstatus==smkname) # [1]  TRUE  TRUE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE
				nn=sum(indic);nn #[1] 36609
				mydist= PROB.edu.race[,smkname]; names(mydist)=row.names(PROB.edu.race); mydist
				#    A-<=high   A-college   A-postcol    B-<=high   B-college   B-postcol    H-<=high   H-college
				# 0.018566097 0.029658838 0.033799932 0.070439032 0.011267360 0.015566571 0.056075187 0.007104640
				#   H-postcol   W-college   W-postcol    W-<=high
				# 0.009016896 0.157620308 0.058473874 0.532411267
				# > sum(mydist)
				# [1] 1
				prob=mydist
				### sample ##
				smp=sample(names(prob), size=nn, replace = T, prob = prob) #[1] "W-postcol" "W-<=high"  "W-<=high"  "W-college" "W-postcol" "A-<=high"

				### put them in a vector ##
				edu.race0[indic] = smp

				### compare it to original distribution #
				tt=table(smp)/length(smp)
				tt1=cbind(mydist, tt[names(mydist)]); colnames(tt1) = c("original","simulated")

				#print(tt1)
				#                mydist
				# A-<=high  0.018566097 0.018465405
				# A-college 0.029658838 0.029145838
				# A-postcol 0.033799932 0.034636292
				# B-<=high  0.070439032 0.070474473
				# B-college 0.011267360 0.010926275
				# B-postcol 0.015566571 0.016307465
				# H-<=high  0.056075187 0.057663416
				# H-college 0.007104640 0.007293289
				# H-postcol 0.009016896 0.008604442
				# W-college 0.157620308 0.158594881
				# W-postcol 0.058473874 0.059712093
				# W-<=high  0.532411267 0.528176132

				myout.edu.race[[j]] = tt1


			}#end of for(j in 1:length(smknames)){
			names(myout.edu.race)=smknames

			# > myout.edu.race
			# $Never
			#              original   simulated
			# A-<=high  0.018566097 0.018356142
			# A-college 0.029658838 0.028244421
			# A-postcol 0.033799932 0.032560299
			# B-<=high  0.070439032 0.071348575
			# B-college 0.011267360 0.010844328
			# B-postcol 0.015566571 0.015296785
			# H-<=high  0.056075187 0.056324947
			# H-college 0.007104640 0.006610396
			# H-postcol 0.009016896 0.009014177
			# W-college 0.157620308 0.156163785
			# W-postcol 0.058473874 0.057117102
			# W-<=high  0.532411267 0.538119042
			#
			# $Former
			#              original   simulated
			# A-<=high  0.014800494 0.015031409
			# A-college 0.016959562 0.017399541
			# A-postcol 0.013370632 0.012937481
			# B-<=high  0.071277125 0.071667165
			# B-college 0.006635478 0.006381494
			# B-postcol 0.008859252 0.007752518
			# H-<=high  0.054224294 0.056062419
			# H-college 0.006208510 0.006182072
			# H-postcol 0.004782629 0.004038289
			# W-college 0.109228065 0.109208296
			# W-postcol 0.027350069 0.027121348
			# W-<=high  0.666303888 0.666217968


			######### breaking into education and race ####################

			tt1=unlist(strsplit(edu.race0,split="\\-")) # [1] "W"       "<=high"  "B"       "<=high"  "W"       "<=high"  "A"       "postcol" "W"
			race=tt1[seq(1,length(tt1),by=2)]
			educ=tt1[seq(2,length(tt1),by=2)]

			TB.race = table(race)/sum(table(race))
			TB.race
			# race
			#       A       B       H       W
			# 0.04015 0.05039 0.02170 0.88776
			TB.edu = table(educ)/sum(table(educ))
			TB.edu
			# educ
			#  <=high college postcol
			# 0.60296 0.18542 0.21162
			## remove "<="
			names(TB.edu) = gsub("<=","",names(TB.edu))
			educ = gsub("<=","", educ)


			####### plot comparing references vs. simulated ###

			TAB=TB.race[names(ref.race)]
			barplot(TAB,col=(heat.colors(4)),ylim=c(0,1),main="[Simulated] Race Distribution",cex.axis=1.5,cex.lab=2,cex.main=1.5)
			text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")
			#axis(1, at=c(0.75,2), labels=c("Unadjusted", " Ref"),cex.axis=1.5)

			TAB=ref.race
			barplot(TAB,col=(heat.colors(4)),ylim=c(0,1),main="[Ref] Race Distribution",cex.axis=1.5,cex.lab=2,cex.main=1.5)
			text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")

			TAB=TB.edu[names(ref.edu)]
			barplot(TAB,col=(heat.colors(3)),ylim=c(0,1),main="[Simulated] Education Distribution",cex.axis=1.5,cex.lab=2,cex.main=1.5)
			text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")
			#axis(1, at=c(0.75,2), labels=c("Unadjusted", " Ref"),cex.axis=1.5)

			TAB=ref.edu
			barplot(TAB,col=(heat.colors(4)),ylim=c(0,1),main="[Ref] Education Distribution",cex.axis=1.5,cex.lab=2,cex.main=1.5)
			text(1:length(TAB),TAB+0.1,round(TAB,2),cex=2,col="blue")


			###### [3] Simulating BMI (over time) given smoking, age, education and race ##################################

	cat("Simulating BMI over age\n", sep="")

			# > coef.bmi
			#      (Intercept)     edu2.college     edu2.postcol          race2.A          race2.B
			#      34.03969380      -0.77333523      -1.07379415      -2.21299870       0.40102572
			# cigstat2.Current  cigstat2.Former              age
			#      -1.18695318       0.50174093      -0.09832138

			####### make dummy matrix for the variables to be used ##################

			mat=cbind(cigstat2=smkstatus,edu2=educ,race2=race, cigstop=cigstop,pky=pky)
			covs=myDummyVar3(mat,refer=T,SORT=F)
			covs[1:5,]
			# > covs[1:3,]
			#      cigstat2.Current cigstat2.Former cigstat2.Never edu2.<=high edu2.college edu2.postcol race2.A
			# [1,]                0               0              1           1            0            0       0
			# [2,]                0               0              1           1            0            0       1
			# [3,]                1               0              0           1            0            0       0
			#      race2.B race2.H race2.W cigstop.0 cigstop.0_20 cigstop.20_40 cigstop.gt40 cigstop.never
			# [1,]       0       0       1         0            0             0            0             1
			# [2,]       0       0       0         0            0             0            0             1
			# [3,]       0       0       1         1            0             0            0             0
			#      pky.10_30 pky.30_60 pky.60_100 pky.lst10 pky.gt100
			# [1,]         0         0          0         1         0
			# [2,]         0         0          0         1         0
			# [3,]         0         1          0         0         0

			## adding empty category: "pky.gt100" nobody has this value ##

			covs=cbind(covs, pky.gt100=rep(0,N)) #
			colnames(covs) = gsub("<=","",colnames(covs))

			## rearrange covariate matrix by the order of coeff
			# except age
			mycoef2 = coef.bmi[names(coef.bmi)!="age"]
			#      (Intercept)     edu2.college     edu2.postcol          race2.A          race2.B
			#       34.0396938       -0.7733352       -1.0737942       -2.2129987        0.4010257
			# cigstat2.Current  cigstat2.Former
			#       -1.1869532        0.5017409

			covs2=cbind(Intercept=rep(1,nrow(covs)), covs[,names(mycoef2)[-1]])
			# > all(colnames(covs2)[-1]==names(mycoef2)[-1])
			# [1] TRUE
			# > covs2[1:5,]
			#      Intercept edu2.college edu2.postcol race2.A race2.B cigstat2.Current cigstat2.Former
			# [1,]         1            0            0       0       0                0               0
			# [2,]         1            0            0       1       0                0               0
			# [3,]         1            0            0       0       0                1               0
			# [4,]         1            0            0       0       0                1               0
			# [5,]         1            0            0       0       0                1               0

			#### Inner product to calculate base BMI when age=0
			base.bmi = covs2 %*% mycoef2
			# > base.bmi[1:10]
			#  [1] 34.03969 31.82670 32.85274 32.85274 32.85274 34.03969 34.54143 34.03969 34.54143 34.54143
			# > length(base.bmi)
			# [1] 100000



			###### BMI over age 45 to 100 ############
			coef.AGE = coef.bmi[names(coef.bmi)=="age"]; coef.AGE #-0.09832138
			bmi.over.ages = coef.AGE * AGES.bmi
			#  [1] -4.424462 -4.522783 -4.621105 -4.719426 -4.817748 -4.916069 -5.014390 -5.112712 -5.211033
			# [10] -5.309354 -5.407676 -5.505997 -5.604319 -5.702640 -5.800961 -5.899283 -5.997604 -6.095926
			# [19] -6.194247 -6.292568 -6.390890 -6.489211 -6.587532 -6.685854 -6.784175 -6.882497 -6.980818
			# [28] -7.079139 -7.177461 -7.275782 -7.374103 -7.472425 -7.570746 -7.669068 -7.767389 -7.865710
			# [37] -7.964032 -8.062353 -8.160674 -8.258996 -8.357317 -8.455639 -8.553960 -8.652281 -8.750603
			# [46] -8.848924 -8.947246 -9.045567 -9.143888 -9.242210 -9.340531 -9.438852 -9.537174 -9.635495
			# [55] -9.733817 -9.832138

			### adding to BMI base ###

			mat.BMI0 = matrix(rep(bmi.over.ages, N), nrow=N, byrow=T); colnames(mat.BMI0)=paste("BMI.",AGES.bmi,sep="")
			# > mat.BMI0[1:3,]
			#         BMI.45    BMI.46    BMI.47    BMI.48    BMI.49    BMI.50   BMI.51    BMI.52    BMI.53
			# [1,] -4.424462 -4.522783 -4.621105 -4.719426 -4.817748 -4.916069 -5.01439 -5.112712 -5.211033
			# [2,] -4.424462 -4.522783 -4.621105 -4.719426 -4.817748 -4.916069 -5.01439 -5.112712 -5.211033
			# [3,] -4.424462 -4.522783 -4.621105 -4.719426 -4.817748 -4.916069 -5.01439 -5.112712 -5.211033

			### make base.bmi matrix ##
			mat.base.bmi = matrix( rep(base.bmi, each=ncol(mat.BMI0)), nrow=N, byrow=T); colnames(mat.base.bmi)=colnames(mat.BMI0)
			# > mat.base.bmi[1:4,]
			#        BMI.45   BMI.46   BMI.47   BMI.48   BMI.49   BMI.50   BMI.51   BMI.52   BMI.53   BMI.54
			# [1,] 34.03969 34.03969 34.03969 34.03969 34.03969 34.03969 34.03969 34.03969 34.03969 34.03969
			# [2,] 31.82670 31.82670 31.82670 31.82670 31.82670 31.82670 31.82670 31.82670 31.82670 31.82670
			# [3,] 32.85274 32.85274 32.85274 32.85274 32.85274 32.85274 32.85274 32.85274 32.85274 32.85274
			# [4,] 32.85274 32.85274 32.85274 32.85274 32.85274 32.85274 32.85274 32.85274 32.85274 32.85274

			mat.BMI = mat.BMI0 + mat.base.bmi
			# > mat.BMI[1:3,]
			#        BMI.45   BMI.46   BMI.47   BMI.48   BMI.49   BMI.50   BMI.51   BMI.52   BMI.53   BMI.54
			# [1,] 29.61523 29.51691 29.41859 29.32027 29.22195 29.12362 29.02530 28.92698 28.82866 28.73034
			# [2,] 27.40223 27.30391 27.20559 27.10727 27.00895 26.91063 26.81230 26.71398 26.61566 26.51734
			# [3,] 28.42828 28.32996 28.23164 28.13331 28.03499 27.93667 27.83835 27.74003 27.64171 27.54339


			###### check to reference: mean BMI at age 50  #####
			# > ref.bmi
			#    W    B    H
			# 28.7 27.7 28.9

			BMI.50 = mat.BMI[,"BMI.50"]
			#tt=data.frame(cbind(BMI.50 = bmi50, race=race))
			bmi.ave = aggregate(BMI.50, by=list(race=race), mean)
			#   race        x
			# 1    A 26.26849
			# 2    B 29.08601
			# 3    H 28.85768
			# 4    W 28.90377

			## make a table to plot
			tt1=t(bmi.ave)
			tt2=as.numeric(tt1[-1,])
			# > tt2
			# [1] "26.26849" "29.08601" "28.85768" "28.90377"
			names(tt2)=tt1[1,]
			#        A        B        H        W
			# 26.26849 29.08601 28.85768 28.90377

			########### plot excluding asian (since reference doens't have asian) ####

					TAB=tt2[names(ref.bmi)]#[-4]
					barplot(TAB,col=(heat.colors(4)),ylim=c(0,37),main="(Simulated) Average Body Mass Index at age 50",cex.axis=1.5,cex.lab=2,cex.main=1.5)
					text(1:length(TAB),TAB+3,round(TAB,1),cex=2,col="blue")

					#### reference BMI from litature ####

					TAB=ref.bmi
					barplot(TAB,col=(heat.colors(4)),ylim=c(0,37),main="(Ref) Average Body Mass Index at age 50",cex.axis=1.5,cex.lab=2,cex.main=1.5)
					text(1:length(TAB),TAB+3,round(TAB,2),cex=2,col="blue")




			###### [4] Simulating lung cancer family history given education, smo  ########################################

	cat("Simulating Lung cancer family history\n", sep="")

			########## [4.1] Unadjusted family history ###############

			#coef.fh = OUT.fh$mycoef.before			# > coef.fh
			#  (Intercept) edu2.college edu2.postcol      race2.H    pky.10_30    pky.30_60   pky.60_100
			#   -2.1547022   -0.1218313   -0.1531633   -0.4446783    0.1959373    0.2335248    0.4192692
			#    pky.gt100
			#    0.4597977
			mycoef2 = coef.fh[names(coef.fh)]; mycoef2
			#      (Intercept)     edu2.college     edu2.postcol          race2.A          race2.B
			#       34.0396938       -0.7733352       -1.0737942       -2.2129987        0.4010257
			# cigstat2.Current  cigstat2.Former
			#       -1.1869532        0.5017409
			covs2=cbind(Intercept=rep(1,nrow(covs)), covs[,names(mycoef2)[-1]])
			all(colnames(covs2)[-1]==names(mycoef2)[-1])
			# [1] TRUE
			# > covs2[1:5,]
			#      Intercept edu2.college edu2.postcol race2.A race2.B cigstat2.Current cigstat2.Former
			# [1,]         1            0            0       0       0                0               0
			# [2,]         1            0            0       1       0                0               0
			# [3,]         1            0            0       0       0                1               0
			# [4,]         1            0            0       0       0                1               0
			# [5,]         1            0            0       0       0                1               0

			#### Inner product to calculate base BMI when age=0
			base.fh = covs2 %*% mycoef2
			#  [1] -2.154702 -2.154702 -1.921177 -1.921177 -2.365856 -2.154702 -1.921177 -2.154702 -2.154702
			# [10] -2.365856

			fh.prob = inv.logit(base.fh)
			# > fh.prob[1:10]
			#  [1] 0.10389263 0.10389263 0.12773032 0.12773032 0.08581369 0.10389263 0.12773032 0.10389263
			#  [9] 0.10389263 0.08581369

			prev.fh.before = mean(fh.prob); prev.fh.before
			#[1] 0.09676024 MALE
			#[1] 0.1190018  FEMALE   ---> too high compared to reference. need to be adjusted ##

			##### compare this to reference ######
			# > ref.fh/100
			# [1] 0.109


	############# Calibration to fit to the reference data: Calibration based on PLCO data is not valid
		 # since it assumes independence between variables: averaging for each variable, not for all combinations. so this is better  #############################

	if(Gender=="M"){

			# > base.fh[1:10]
			#  [1] -2.304702 -2.304702 -2.071177 -2.071177 -2.515856 -2.304702 -2.071177 -2.304702 -2.304702
			incr = 0.13
			fh.prob.adjusted = inv.logit( base.fh + incr)
			prev.fh.adjusted = mean(fh.prob.adjusted); prev.fh.adjusted
			#[1] 0.1086953
			# > ref.fh/100
			# [1] 0.109

			# > (logit(fh.prob.adjusted) - logit(fh.prob))[1:5]
			# [1] 0.13 0.13 0.13 0.13 0.13

	}#end of GEnder==M


	if(Gender=="F"){

			# > base.fh[1:10]
			#  [1] -2.304702 -2.304702 -2.071177 -2.071177 -2.515856 -2.304702 -2.071177 -2.304702 -2.304702
			incr = -0.1
			fh.prob.adjusted = inv.logit( base.fh + incr)
			prev.fh.adjusted = mean(fh.prob.adjusted); prev.fh.adjusted
			#[1] 0.1086953
			ref.fh/100
			# [1] 0.109

			# > (logit(fh.prob.adjusted) - logit(fh.prob))[1:5]
			# [1] 0.13 0.13 0.13 0.13 0.13

	}#end of GEnder==M



			######## simulate FH (binary variables) based on the probability #########################

			simBin <- function(x)  sample(c(0,1), size=1, replace=T, prob=c(1-x,x))

	# #set.seed(1234)
	        mat= fh.prob.adjusted ; dim(mat)=c(N, 1); colnames(mat)="prob.fh.adjusted"
			FH = apply(mat, 1, simBin)
			mean(FH)
			# [1] 0.10915  # OK

			# > FH[1:30]
			# [1] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0

		    ### add FH to covariates matrix ##

		    covs = cbind(covs, fh=FH)

			### plotting ####

			## unadjusted ##
			tb1=c(prev.fh.before, ref.fh/100); names(tt)=c("Unadjusted","Ref")


				TAB=tb1
				barplot(TAB,col=(heat.colors(3)),ylim=c(0,0.15),main="Family History of Lung Cancer",cex.axis=1.5,cex.lab=2,cex.main=1.5)
				text(1:length(TAB),TAB+0.02,round(TAB,3),cex=2,col="blue")
				axis(1, at=c(0.75,2), labels=c("Unadjusted", " Ref"),cex.axis=1.5)

			## adjusted ###
			tb2=c(prev.fh.adjusted, ref.fh/100); names(tt)=c("Adjusted","Ref")

				TAB=tb2
				barplot(TAB,col=(heat.colors(3)),ylim=c(0,0.15),main="Family History of Lung Cancer",cex.axis=1.5,cex.lab=2,cex.main=1.5)
				text(1:length(TAB),TAB+0.02,round(TAB,3),cex=2,col="blue")
				axis(1, at=c(0.75,2), labels=c("Adjusted", " Ref"),cex.axis=1.5)



			## Simulated & adjusted ###
			tb3=c(mean(FH), ref.fh/100); names(tt)=c("Adjusted","Ref")

				TAB=tb3
				barplot(TAB,col=(heat.colors(3)),ylim=c(0,0.15),main="Simulated Family History of Lung Cancer",cex.axis=1.5,cex.lab=2,cex.main=1.5)
				text(1:length(TAB),TAB+0.02,round(TAB,3),cex=2,col="blue")
				axis(1, at=c(0.75,2), labels=c("Adjusted", " Ref"),cex.axis=1.5)



			###### [5] Simulating COPD given other predictors ####################################################

	cat("Simulating COPD\n", sep="")

			mycoef = coef.copd

			########## [4.1] Get coefficient and base probabilty  ###############

			# > coef.copd
			# male
			#   (Intercept)  edu2.college  edu2.postcol       race2.A       race2.B       race2.H     cigstop.0
			# -6.2691028825 -0.3337032735 -0.2753624716 -0.4574188546  0.2267924407 -0.0006870761  0.9052450602
			#  cigstop.0_20 cigstop.20_40  cigstop.gt40     pky.10_30     pky.30_60    pky.60_100     pky.gt100
			#  0.6883502038  0.3428068341  0.4280578676 -0.0253225158  0.5551064463  1.1028039156  1.4087509991
			#           age            fh
			#  0.0428911792  0.2036594893

			#  FEMALE
			#  (Intercept) edu2.college edu2.postcol      race2.A      race2.B    cigstop.0 cigstop.0_20    pky.10_30    pky.30_60   pky.60_100
			#  -4.08879886  -0.36924575  -0.18383969  -0.37070085   0.33176546   0.51705093   0.31662639   0.15610779   0.80712541   1.39733371
			#    pky.gt100          age           fh
			#   1.94426431   0.01775083   0.13825060

			#mycoef = OUT.copd$mycoef.adj
			#mycoef = OUT.copd$mycoef.before


			## exclude age for now ##
			mycoef2 = mycoef[names(mycoef)!="age"]
				#   (Intercept)  edu2.college  edu2.postcol       race2.A       race2.B       race2.H     cigstop.0
				# -6.2691028825 -0.3337032735 -0.2753624716 -0.4574188546  0.2267924407 -0.0006870761  0.9052450602
				#  cigstop.0_20 cigstop.20_40  cigstop.gt40     pky.10_30     pky.30_60    pky.60_100     pky.gt100
				#  0.6883502038  0.3428068341  0.4280578676 -0.0253225158  0.5551064463  1.1028039156  1.4087509991
				#            fh
				#  0.2036594893
				#   (Intercept)  edu2.college  edu2.postcol       race2.A       race2.B       race2.H     cigstop.0
				# -5.6591028825 -0.3337032735 -0.2753624716 -0.4574188546  0.2267924407 -0.0006870761  0.9052450602
				#  cigstop.0_20 cigstop.20_40  cigstop.gt40     pky.10_30     pky.30_60    pky.60_100     pky.gt100
				#  0.6883502038  0.3428068341  0.4280578676 -0.0253225158  0.5551064463  1.1028039156  1.4087509991
				#           age            fh
				#  0.0428911792  0.2036594893

				# > mycoef2
				#  (Intercept) edu2.college edu2.postcol      race2.A      race2.B    cigstop.0 cigstop.0_20    pky.10_30    pky.30_60   pky.60_100
				#   -4.0887989   -0.3692458   -0.1838397   -0.3707008    0.3317655    0.5170509    0.3166264    0.1561078    0.8071254    1.3973337
				#    pky.gt100           fh
				#    1.9442643    0.1382506

	if(Gender=="F") mycoef2[1] =  -3.8

			### make covariance matrix ###
			#mycoef2[1] = -5.6
			covs2 = cbind(Intercept=rep(1,nrow(covs)),  covs[,names(mycoef2)[-1]])
			all(colnames(covs2)[-1]==names(mycoef2)[-1])
			# [1] TRUE

			#### Inner product to calculate base COPD when age=0
			base.copd = covs2 %*% mycoef2 ; base.copd[1:10]
			#  [1] -6.269103 -6.726522 -4.808751 -4.808751 -4.809438 -6.269103 -5.371190 -6.269103 -5.841045
			# [10] -5.026333
			base.copd.prob = inv.logit(base.copd)
			mean(base.copd.prob)
			#[1] 0.004253002

			########## [4.2] Age effect: COPD over ages ################################################

			################### Calibration needed ##########################################
			### here my problem is I don't know how to fit age=60 prevalence using the predicted model (logistic regression with age coefficient)
			  ### If I sample 0 or 1 at each age = 45:100, and choose smallest age with COPD=1, then the prevalence at 60 is NOT how it was predicted using the logisstic regression model
			   ## this must be related to hazard (prob of geting disease given the previosu years they didn't have the disease) #
			   ## but PLCO data don't have time to event data for COPD so I cannot estimate hazard but just risk at each age
			   ## so I am doing some crude estimate

			#### Age effect: Calculate COPD over age 45 to 100 ############
			# > AGES.copd
			#  [1]  45  46  47  48  49  50  51  52  53  54  55  56  57  58  59  60  61  62  63  64  65  66  67  68
			# [25]  69  70  71  72  73  74  75  76  77  78  79  80  81  82  83  84  85  86  87  88  89  90  91  92
			# [49]  93  94  95  96  97  98  99 100

			coef.AGE = mycoef[names(mycoef)=="age"]; coef.AGE #-0.09832138
			# > coef.AGE
			#        age   MALE
			# 0.04289118

			#        age     FEMALE
			# 0.01775083

		if(Gender=="M"){


				#coef.AGE=0.0002 # coef[1]=-5.6
				#coef.AGE=0.01
				coef.AGE=0.007  # male adjustment coef.AGE=0.007
				#[1] 0.01

		}#end of if(Gender=="M"){

	    if(Gender=="F")    {


	    	coef.AGE = -0.035


	    }


			copd.over.ages = coef.AGE * AGES.copd
			# > copd.over.ages[1:10]
			#  [1] 1.930103 1.972994 2.015885 2.058777 2.101668 2.144559 2.187450 2.230341 2.273232 2.316124

			### age effect: COPD increpement by age (same for everyone ###
			mat.COPD0 = matrix(rep(copd.over.ages, N), nrow=N, byrow=T); colnames(mat.COPD0)=paste("COPD.",AGES.copd,sep="")
			# > mat.COPD0[1:3,]
			#       COPD.45  COPD.46  COPD.47  COPD.48  COPD.49  COPD.50 COPD.51  COPD.52  COPD.53  COPD.54
			# [1,] 1.930103 1.972994 2.015885 2.058777 2.101668 2.144559 2.18745 2.230341 2.273232 2.316124
			# [2,] 1.930103 1.972994 2.015885 2.058777 2.101668 2.144559 2.18745 2.230341 2.273232 2.316124
			# [3,] 1.930103 1.972994 2.015885 2.058777 2.101668 2.144559 2.18745 2.230341 2.273232 2.316124

			### make base.copd matrix (each row is for each person: have the same base value  ##
			mat.base.copd = matrix( rep(base.copd, each=ncol(mat.COPD0)), nrow=N, byrow=T); colnames(mat.base.copd)=colnames(mat.COPD0)
			# > mat.base.copd[1:3,]
			#        COPD.45   COPD.46   COPD.47   COPD.48   COPD.49   COPD.50   COPD.51   COPD.52   COPD.53
			# [1,] -6.269103 -6.269103 -6.269103 -6.269103 -6.269103 -6.269103 -6.269103 -6.269103 -6.269103
			# [2,] -6.726522 -6.726522 -6.726522 -6.726522 -6.726522 -6.726522 -6.726522 -6.726522 -6.726522
			# [3,] -4.808751 -4.808751 -4.808751 -4.808751 -4.808751 -4.808751 -4.808751 -4.808751 -4.808751

			### adding base and age effect ##
			mat.COPD = mat.COPD0 + mat.base.copd
			# > mat.COPD[1:3,]
			#        COPD.45   COPD.46   COPD.47   COPD.48   COPD.49   COPD.50   COPD.51   COPD.52   COPD.53
			# [1,] -4.339000 -4.296109 -4.253217 -4.210326 -4.167435 -4.124544 -4.081653 -4.038762 -3.995870
			# [2,] -4.796419 -4.753527 -4.710636 -4.667745 -4.624854 -4.581963 -4.539072 -4.496180 -4.453289
			# [3,] -2.878648 -2.835757 -2.792866 -2.749975 -2.707084 -2.664192 -2.621301 -2.578410 -2.535519

			### COPD probability over ages #######
			mat.COPD2=inv.logit(mat.COPD)
			# > mat.COPD2[1:3,]
			#          COPD.45    COPD.46     COPD.47     COPD.48     COPD.49    COPD.50    COPD.51    COPD.52
			# [1,] 0.012881476 0.01343841 0.014019084 0.014624475 0.015255605 0.01591353 0.01659936 0.01731422
			# [2,] 0.008191616 0.00854754 0.008918789 0.009306011 0.009709881 0.01013110 0.01057039 0.01102852
			# [3,] 0.053219203 0.05542224 0.057710906 0.060088075 0.062556661 0.06511964 0.06778003 0.07054090


				   ########### This is the prevalence of COPD for each age using the logistic regression with age effect
				   doThis=F
				   if(doThis==T){

						tt=apply(mat.COPD2,2, mean)
						plot(AGES.copd, tt, pch=16,col="blue")
						abline(v=60, lty="dotted",col="red")

						tt2=round(tt["COPD.60"],2)
						abline(h=tt2,col="red",lty="dotted")
						title(paste("age 60: ",round(tt["COPD.60"],2),sep=""),cex=1.5)

				   }#end of if(doThis==T){

			###### check to reference: mean copd at age 60  #####
			# > ref.copd
			# [1] 0.074	  ## age 60

			COPD.60 = mat.COPD2[,"COPD.60"]
			 mean(COPD.60)
			# [1] 0.05154358
			# [1] 0.08903964
			# > ref.copd
			# [1] 0.074

			######### [4.3] simulate COPD status (0 or 1) over age ######################################

			# set.seed(123431)

			   rds = runif(nrow(mat.COPD2)*ncol(mat.COPD2), 0,1)
			   mat.random = matrix(rds, nrow=nrow(mat.COPD2), ncol=ncol(mat.COPD2), byrow=T); colnames(mat.random)=colnames(mat.COPD2)
				# > mat.random[1:5,]
				#        COPD.45   COPD.46    COPD.47   COPD.48   COPD.49    COPD.50    COPD.51   COPD.52   COPD.53
				# [1,] 0.6814624 0.6889335 0.07081976 0.6940904 0.2551750 0.63440448 0.29976306 0.5401783 0.9815323
				# [2,] 0.3173482 0.3168967 0.17863922 0.5221377 0.5179546 0.45346087 0.13095071 0.1718593 0.2506849
				# [3,] 0.6213151 0.3519959 0.84028451 0.3071967 0.4738770 0.93498253 0.06093934 0.8090722 0.4035094
				# [4,] 0.8955375 0.2876515 0.24771511 0.4425650 0.8050960 0.83662048 0.15074789 0.6995926 0.9076488
				# [5,] 0.5626551 0.4792596 0.49324074 0.6981709 0.3264166 0.05802986 0.55603826 0.3089413 0.3853996

			   mat.COPD.status0 = 1*(mat.random < mat.COPD2)	; colnames(mat.COPD.status0) = colnames(mat.COPD2)
				# > mat.COPD.status0[1:5,]
				#      COPD.45 COPD.46 COPD.47 COPD.48 COPD.49 COPD.50 COPD.51 COPD.52 COPD.53 COPD.54 COPD.55 COPD.56
				# [1,]       0       0       0       0       0       0       0       0       0       0       0       0
				# [2,]       0       0       0       0       0       0       0       0       0       0       0       0
				# [3,]       0       0       0       0       0       0       1       0       0       0       0       0
				# [4,]       0       0       0       0       0       0       0       0       0       0       0       0
				# [5,]       0       0       0       0       0       1       0       0       0       0       0       0
				#      COPD.57 COPD.58 COPD.59 COPD.60 COPD.61 COPD.62 COPD.63 COPD.64 COPD.65 COPD.66 COPD.67 COPD.68
				# [1,]       0       0       0       0       0       0       0       0       0       0       0       0
				# [2,]       0       0       0       0       0       0       0       0       0       0       0       0
				# [3,]       0       0       0       0       0       0       0       0       1       1       0       0
				# [4,]       0       0       0       0       0       0       0       1       0       0       1       1
				# [5,]       0       0       0       0       0       0       0       0       0       0       1       0

				##### take earliest age of COPD and the rest will be stated as COPD ############
				x=mat.COPD.status0[3,]
				myMin <- function(x,AGES.copd){
					# > AGES.copd
					#  [1]  45  46  47  48  49  50  51  52  53  54  55  56  57  58  59  60  61  62  63  64  65  66  67  68
					# [25]  69  70  71  72  73  74  75  76  77  78  79  80  81  82  83  84  85  86  87  88  89  90  91  92
					# [49]  93  94  95  96  97  98  99 100

					#  COPD.45  COPD.46  COPD.47  COPD.48  COPD.49  COPD.50  COPD.51  COPD.52  COPD.53  COPD.54  COPD.55
					#        0        0        0        0        0        0        1        0        0        0        0
					#  COPD.56  COPD.57  COPD.58  COPD.59  COPD.60  COPD.61  COPD.62  COPD.63  COPD.64  COPD.65  COPD.66
					#        0        0        0        0        0        0        0        0        0        1        1
					out=999
					tt1=which(x==1)
					if(length(tt1) > 0){
					   wc = min(tt1) #[1] 7  (seventh elemtn)
					   out=AGES.copd[wc]
					 }#
					out
					#[1] 51   (first COPD at age=51
				}# end of myMin


			######### [4.4] Get the earliest age of COPD for each person #############################################


			   age.COPD0 = apply(mat.COPD.status0, 1, myMin, AGES.copd=AGES.copd)
				#  age.COPD[1:100]
				#   [1]  100   82   51   64   50   47   59   90   68   48   99   71   52   64   59   51   69   86   58
				#  [20]   90   73   69   85   52   52   72   85   57   56   46   50   46   80   81   75   60   75   68
				#  [39]   71   98   65   76   52   99   65   79   74   48   55   89   78   53   54   62   58   73   48
				#  [58]   54   72   66   62   62   68   53   63   58   49   49  999   49   77   64   79   51   72   53


			 ######## [4.5] impose other cause of mortality ##############################################

			 age.COPD=NULL

			# > age.OCM[1:20]
			#  [1]   77   87   67   89   82   29   36 -999   56   78   87   94   83   81   51   53   84   76   62
			# [20]   91
			# > max(age.OCM)
			# [1] 99

			## if OCM comes first COPD removes
			age.COPD = age.COPD0
		indic.ocm.first = (age.OCM < age.COPD0) & age.OCM!=999

		age.COPD[indic.ocm.first] = 999

			#cbind(age.COPD0, age.OCM, age.COPD,  indic.ocm.first)[1:30,]
			# > cbind(age.COPD0, age.OCM, age.COPD,  indic.ocm.first)[1:30,]
			#       age.COPD0 age.OCM age.COPD indic.ocm.first
			#  [1,]       100      77     -999               1
			#  [2,]        82      87       82               0
			#  [3,]        51      67       51               0
			#  [4,]        64      89       64               0
			#  [5,]        50      82       50               0
			#  [6,]        47      29     -999               1
			#  [7,]        59      36     -999               1

			age.COPD[1:60]
			#  [1] 999  82  51  64  50 999 999  90 999  48 999  71  52  64 999  51  69 999  58  90 999  69  85  52
			# [25]  52  72 999  57  56  46  50  46 999  81 999  60  75  68  71 999  65  76  52 999  65 999 999 999
			# [49] 999 999  78 999  54  62  58 999  48  54  72 999



			####### [4.6] compare this to reference ####################

			## calculate COPD prevalence at each age ##

			ages=45:100

			 for(i in 1:length(ages)){
					#ref.age.copd = 60
					ref.age.copd = ages[i]
					indic.copd = age.COPD <= ref.age.copd
					ans=sum(indic.copd)/length(indic.copd) ; ref.copd

					if(i==1)ANS=ans
					if(i>1) ANS=c(ANS,ans)
			}#
			names(ANS)=ages
			ANS[1:10]
			#      45      46      47      48      49      50      51      52      53      54
			# 0.05001 0.09682 0.14098 0.18124 0.21844 0.25233 0.28498 0.31567 0.34480 0.37174

	#### PROBLEM: way too high! I think that's because I used logistic regression not hazard (taking into accout past)


			plot(ages,ANS,pch=16,col="red",main="Simulated COPD prevalence (mean) over age")
			abline(v=60);abline(h=0.074)


			###### Plot compare to reference at age=60

			prev.copd.60 = sum( age.COPD <= 60)/length(age.COPD)


			## adjusted ##
			tb1=c(prev.copd.60, ref.copd); names(tt)=c("Unadjusted","Ref")

			TAB=tb1
			barplot(TAB,col=(heat.colors(3)),ylim=c(0,0.15),main="[Simulated] COPD prevalence at age=60",cex.axis=1.5,cex.lab=2,cex.main=1.5)
			text(1:length(TAB),TAB+0.02,round(TAB,3),cex=2,col="blue")
			axis(1, at=c(0.75,2), labels=c("Adjusted", " Ref"),cex.axis=1.5)

			### unadjusted ##
			if(Gender=="M") tb1=c(0.065, ref.copd); names(tt)=c("Unadjusted","Ref")
			if(Gender=="F") tb1=c(0.060, ref.copd); names(tt)=c("Unadjusted","Ref")

			TAB=tb1
			barplot(TAB,col=(heat.colors(3)),ylim=c(0,0.15),main="[Simulated] COPD prevalence at age=60",cex.axis=1.5,cex.lab=2,cex.main=1.5)
			text(1:length(TAB),TAB+0.02,round(TAB,3),cex=2,col="blue")
			axis(1, at=c(0.75,2), labels=c("Unadjusted", " Ref"),cex.axis=1.5)


			#}#end of Gender==M


			######## report output: education, race, COPD status, family history of lung cancer, BMI over ages ################

			DAT.out = cbind(edu=educ, race=race, age.COPD=age.COPD, FH=FH, round(mat.BMI,3), cigstat60=smkstatus, cigstop60=cigstop, pky60=pky)
			# > colnames(DAT.out)
			#  [1] "edu"       "race"      "age.COPD"  "FH"        "BMI.45"    "BMI.46"    "BMI.47"    "BMI.48"
			#  [9] "BMI.49"    "BMI.50"    "BMI.51"    "BMI.52"    "BMI.53"    "BMI.54"    "BMI.55"    "BMI.56"
			# [17] "BMI.57"    "BMI.58"    "BMI.59"    "BMI.60"    "BMI.61"    "BMI.62"    "BMI.63"    "BMI.64"
			# [25] "BMI.65"    "BMI.66"    "BMI.67"    "BMI.68"    "BMI.69"    "BMI.70"    "BMI.71"    "BMI.72"
			# [33] "BMI.73"    "BMI.74"    "BMI.75"    "BMI.76"    "BMI.77"    "BMI.78"    "BMI.79"    "BMI.80"
			# [41] "BMI.81"    "BMI.82"    "BMI.83"    "BMI.84"    "BMI.85"    "BMI.86"    "BMI.87"    "BMI.88"
			# [49] "BMI.89"    "BMI.90"    "BMI.91"    "BMI.92"    "BMI.93"    "BMI.94"    "BMI.95"    "BMI.96"
			# [57] "BMI.97"    "BMI.98"    "BMI.99"    "BMI.100"   "cigstat60" "cigstop60" "pky60"

			DAT.out


}#end of whole function


myOversiagAnalysis <- function(dat.f, dat.m, MD, histo){  # overdiagnosis analysis by model


			genders=c("Female","Male")#,"Both Gender")

			for( i in 1:length(genders)){

				gender=genders[i]

				Main0=MAIN=paste("[",MD,"-",gender,"] ",sep="");Main0

				if(gender=="Female")  dat1=dat.f
				if(gender=="Male")    dat1=dat.m
				#  [1] "X"                                "NUM"                              "scenario"                         "age.start"
				#  [5] "age.stop"                         "age.interval"                     "py"                               "ysq"
				#  [9] "n.total"                          "n.entry.all"                      "n.case"                           "LCcases.noscreen100"
				# [13] "LCdeaths.noscreen100"             "PercentScreened100"               "AverageScreen100"                 "CTscreens100"
				# [17] "CTexams100"                       "PctEarlyStage100"                 "LCcases100"                       "LCcases.sdet100"
				# [21] "LCcases.sdet.eff100"              "LCdeaths100"                      "LCcasesOver100"                   "Deaths.avoided100"
				# [25] "LifeYearsSaved100"                "MortReduct100"                    "AlldeathsCase100"                 "AlldeathsNoncases100"
				# [29] "Ratio.case.scrdet.per.CT100"      "Rario.deaths.avoided_case.scr100" "LCcases.noscreen90"               "LCdeaths.noscreen90"
				# [33] "CTscreens90"                      "CTexams90"                        "PctEarlyStage90"                  "LCcases90"
				# [37] "LCcases.sdet90"                   "LCcasesOver90"                    "LC.overRate90"                    "LC.overRate90.ad"
				# [41] "LC.overRate90.sq"                 "LC.overRate90.lg"                 "LC.overRate90.sm"                 "LCdeaths90"
				# [45] "Deaths.avoided90"                 "LifeYearsSaved90"                 "MortReduct90"                     "Alldeaths90"
				# [49] "Alldeaths.case.noncase90"         "prop.cdet.90"                     "LCdeathsSurgery_overDiag90"       "LCdeathsSurgery_sdet90"
				# [53] "AlldeathsSurgery90"               "AlldeathsSurgery_noscreen90"      "CTscreens90_abs"                  "CTexams90_abs"
				# [57] "LCcases90_abs"                    "LCdeaths90_abs"

				# > colnames(dat1)
				#  [1] "Freq.Start.Stop.PY.YSQ"     "PctEverScreened100"         "CTscreens100"
				#  [4] "CTscreens90"                "CTexams90"                  "LCcases90"
				#  [7] "PctEarlyStage90"            "LCdeaths90"                 "Alldeaths90"
				# [10] "LcdeathsSurgery_overDiag90" "Deaths.avoided90"           "LifeYearsSaved90"
				# [13] "MortReduct90"               "LCcases.sdet90"             "LCcasesOver90"
				# [16] "LCcases.BAC90"              "LCcases.BAC.scr90"          "LC.over90.BAC"
				# [19] "LCcases.AD90"               "LCcases.AD.scr90"           "LC.over90.AD"
				# [22] "LCcases.SQ90"               "LCcases.SQ.scr90"           "LC.over90.SQ"
				# [25] "LCcases.LC90"               "LCcases.LC.scr90"           "LC.over90.LC"
				# [28] "LCcases.SC90"               "LCcases.SC.scr90"           "LC.over90.SC"
				# [31] "LCcases.NSCO90"             "LCcases.NSCO.scr90"         "LC.over90.NSCO"
				# [34] "LCcases.NSCO2.90"           "LCcases.NSCO2.scr90"        "LC.over90.NSCO2"
				# [37] "LCcases.AD.BAC.LC.90"       "LCcases.AD.BAC.LC.scr90"    "LC.over90.AD.BAC.LC"
				# [40] "LCcases.AD.BAC.90"          "LCcases.AD.BAC.scr90"       "LC.over90.AD.BAC"
				# [43] "LCcases.ltn.50"             "LCcases.ltn50.scr"          "LC.over.ltn50"
				# [46] "LCcases.50_60"              "LCcases.50_60.scr"          "LC.over.50_60"
				# [49] "LCcases.60_70"              "LCcases.60_70.scr"          "LC.over.60_70"
				# [52] "LCcases.70_80"              "LCcases.70_80.scr"          "LC.over.70_80"
				# [55] "LCcases.80_90"              "LCcases.80_90.scr"          "LC.over.80_90"
				# [58] "LC.overRate90"              "LC.overRate90.bac"          "LC.overRate90.ad"
				# [61] "LC.overRate90.sq"           "LC.overRate90.lg"           "LC.overRate90.sm"
				# [64] "LC.overRate.NSCO90"         "LC.overRate.NSCO2.90"       "LC.overRate.AD.BAC.LC90"
				# [67] "LC.overRate.AD.BAC90"       "LC.overRate.ltn.50"         "LC.overRate.50_60"
				# [70] "LC.overRate.60_70"          "LC.overRate.70_80"          "LC.overRate.80_90"

				mean(dat1[,"LC.overRate90"],na.rm=T)
				#mean(dat1[,"LC.overRate90.bac"],na.rm=T)
				#mean(dat1[,"LC.overRate90.ad"],na.rm=T)
				mean(dat1[,"MortReduct90"],na.rm=T)

				# mean(dat1[,"LC.overRate90"],na.rm=T)  # Erasmus
				# [1] 0.1207433
				# mean(dat1[,"MortReduct90"],na.rm=T)
				# [1] 0.1457651

				# > mean(dat1[,"LC.overRate90"],na.rm=T)  # FH
				# [1] 19.6168
				# >mean(dat1[,"MortReduct90"],na.rm=T)
				# [1] 29.61986



				########### change the column name "Freq-Start-Stop..." to "scenario" ####
				mydat0=dat1
				colnames(mydat0)[grep("Freq",colnames(mydat0))]="scenario"

				### exclude:
				#A-55-57-30-15
				#A-62-64-30-15


				########### [1] take out two small scenarios ####################

				indic = as.character(mydat0[,"scenario"])  %in% c("A-55-57-30-15","A-62-64-30-15")
				sum(indic)
				mydat=MYDAT=mydat0[!indic,]
				dim(mydat)

				### make start, stop, py and ysq variables ###
				sc=as.character(mydat[,"scenario"])
				sc[1:10]
				#  [1] "NoScreen"      "A-45-75-10-10" "B-45-75-10-10" "T-45-75-10-10" "A-45-75-10-15"
				#  [6] "B-45-75-10-15" "T-45-75-10-15" "A-45-75-10-20" "B-45-75-10-20" "T-45-75-10-20"

				### change "NoScreen" to "NA-NA-NA-NA-NA" format

				sc2=gsub("NoScreen","NA-NA-NA-NA-NA",sc)
				tm1=unlist(strsplit(sc2,split="-"))

				freq = tm1[seq(1,length(tm1), by=5)] ; freq[freq=="NA"]=NA
				age.start = tm1[seq(2,length(tm1), by=5)];  age.start[age.start=="NA"]=NA
				age.stop = tm1[seq(3,length(tm1), by=5)]; age.stop[age.stop=="NA"]=NA
				PY = tm1[seq(4,length(tm1), by=5)]; PY[PY=="NA"]=NA
				YSQ = tm1[seq(5,length(tm1), by=5)]; YSQ[YSQ=="NA"]=NA

				mydat=data.frame(mydat,age.interval=freq, age.start=age.start, age.stop=age.stop, py=PY, ysq=YSQ)



				################ [2] Histogram of overdiagnosis rate variable (ALL SUBTYPE) ##################

				y=mydat[,"LC.overRate90"]*100   # of overdiag / # of screen detected
				if(MD=="FH" | MD=="MGH") y=mydat[,"LC.overRate90"]

				#y=mydat[,"LC.overRate90.ad"]*100
				#y=mydat[,"LC.overRate90"]*100
				#y=mydat[,"LC.overRate90"]*100

				range(y,na.rm=T)
				#[1]  8.768742 15.656788

				#range(x)
				md=mean(y,na.rm=T);md

				hist(y,nclass=10,col="red",main=paste(Main0, "\n Overdiagnosis Rate ","(mean=",round(md,2),"%)",sep=""),freq=F, cex.main=1.5,cex.lab=1.5, cex.axis=1.5, xlab="Overdiagnosis Rate (%)")

						#    LC.overRate90 LC.overRate90.ad LC.overRate90.sq LC.overRate90.lg LC.overRate90.sm
						#       0.05025038       0.05551892       0.04456900       0.04500618       0.04654051


				##############  [3] boxplots of overdiagnosis related variable ###


				#mycolnames=c("Overdiag","CTscreens90","PctEarlyStage90","PercentScreened100","MortReduct90","LCdeaths90","Deaths.avoided90",
				#			"LifeYearsSaved90","LCdeathsSurgery_overDiag90","age.interval","age.start","age.stop","py","ysq","start.stop","start.stop2")
				#varfeatures=c(rep("con",8), rep("cat",8))

				mycolnames=c("Overdiag",
							"CTscreens90","PctEarlyStage90","MortReduct90","LCdeaths90","Deaths.avoided90","LifeYearsSaved90",
							"age.interval","age.start","age.stop","py","ysq","start.stop","start.stop2")
				varfeatures=c(rep("con",7), rep("cat",7))


				########## age.stop and age.start combination: high risk ##############

				 x1=mydat[,"age.start"]
				 x2=mydat[,"age.stop"]
			  table(x1)
				# x1
				#  45  50  55  60
				# 144 144 144 144
				# > table(x2)
				# x2
				#  75  80  85
				# 192 192 192

				start_stop=paste(x1,x2,sep="-")
				# > table(ag)
				# ag
				# 45-75 45-80 45-85 50-75 50-80 50-85 55-75 55-80 55-85 60-75 60-80 60-85 NA-NA
				#    48    48    48    48    48    48    48    48    48    48    48    48     1
				start_stop = gsub("NA",NA,start_stop)
				start_stop2=start_stop
				start_stop2[!(start_stop2 %in% c("45-75","60-85"))]=NA


				DATA=cbind(Overdiag=y, mydat,start.stop=start_stop,start.stop2=start_stop2)
				#varfeatures=c(rep("con",8), rep("cat",8))

				#varfeatures=c("cat","cat","cat","b","b","cat","con","con","con","b","con")
				x1name="Overdiag"
				x2names=mycolnames

				par("mar"=c(5,5,4,2))
				YLIM=c(1,18)
				if(MD=="FH") YLIM=c(5,35)
				myInvestigate.variable3(x1name,x2names,DATA,varfeatures,YLIM,MAIN)


				######### [4] histology specific overdiagnosis ############################

				# > histo
				# [1] "AD.BAC.LC" "SQ"        "SC"        "NSCO"

				ynames = ynames.hist = c("LC.overRate90", paste("LC.overRate90",histo,sep="."))
				Names=c("All Subtypes", histo)
				ynames
				Names

				# > ynames
				# [1] "LC.overRate90"           "LC.overRate90.AD.BAC.LC" "LC.overRate90.SQ"
				# [4] "LC.overRate90.SC"        "LC.overRate90.NSCO"
				# > Names
				# [1] "All Subtypes" "AD.BAC.LC"    "SQ"           "SC"           "NSCO"

				#ynames=c("LC.overRate90","LC.overRate90.bac","LC.overRate90.ad","LC.overRate90.sq" ,"LC.overRate90.lg"  ,"LC.overRate90.sm"  )
				#Names=c("All Subtype","BAC","AD","SQ","LC","SC")

				tt=mydat[,ynames]*100
				if(MD=="FH" | MD=="MGH") tt=mydat[,ynames]
				# > colnames(tt)
				# [1] "LC.overRate90"           "LC.overRate90.AD.BAC.LC" "LC.overRate90.SQ"
				# [4] "LC.overRate90.SC"        "LC.overRate90.NSCO"

				md=apply(tt,2,mean,na.rm=T);md
				#    LC.overRate90 LC.overRate90.ad LC.overRate90.sq LC.overRate90.lg LC.overRate90.sm
				#       0.05025038       0.05551892       0.04456900       0.04500618       0.04654051
				#names(md)=c("ALL","BAC","AD","SQ","LC","SC")
				names(md)=Names

				### Make a long type data boxplot for subtypes (except for all) ##
				#   LC.overRate90 LC.overRate90.AD.BAC.LC LC.overRate90.SQ LC.overRate90.SC
				# 1            NA                      NA               NA               NA
				# 2      9.783653                11.15604         8.763505         3.513957
				# 3      9.623033                10.83203         8.573370         3.305991
				# 4      9.612586                10.91571         7.984921         3.248974
				# 5      9.716076                11.06217         8.773393         3.546635
				overdiag=as.vector(unlist(tt[,-1]))
				# > overdiag[1:5]
				# [1]       NA 11.15604 10.83203 10.91571 11.06217
				subtype=rep(histo,each=nrow(tt))

				overhist=cbind(overdiag=overdiag, subtype=subtype)
				# > overhist[1:10,]
				#       overdiag     subtype
				#  [1,] NA           "AD.BAC.LC"
				#  [2,] "11.1560448" "AD.BAC.LC"
				#  [3,] "10.8320251" "AD.BAC.LC"
				#  [4,] "10.9157065" "AD.BAC.LC"
				#  [5,] "11.0621714" "AD.BAC.LC"

				#overhist=cbind(overdiag=c(tt[,2],tt[,3],tt[,4],tt[,5],tt[,6]), subtype=c(rep("BAC",nrow(tt)),rep("AD",nrow(tt)), rep("SQ",nrow(tt)), rep("LC",nrow(tt)), rep("SC",nrow(tt))))

				overhist[1:5,]
				#      overdiag             subtype
				# [1,] "0.0479041916167665" "AD"
				# [2,] "0.0486486486486487" "AD"
				# [3,] "0.0511945392491468" "AD"
				# [4,] "0.049553208773355"  "AD"
				# [5,] "0.0464135021097046" "AD"

				### order can change depending on boxplot
				nm2=names(table(overhist[,2]));nm2
				#[1] "AD" "LC" "SC" "SQ

				md2= md[nm2]; md2

				YLIM=c(2,22)
				if(MD=="FH") YLIM=c(2,60)

				boxplot(as.numeric(overhist[,1])~overhist[,2],col="red",cex.axis=1.2,cex.lab=1.5,
						ylab="Overdiagnosis Rate (%)", cex.main=2,ylim=YLIM)#main=paste(Main0,"Histologic Subtype and Overdiagnosis"),)
				text(1:length(md2),rep(11,length(md2)), paste(round(md2,1)," %",sep=""), col="blue",cex=1.5)

				tst=kruskal.test(as.numeric(overhist[,1]), as.factor(overhist[,2]))
				pval=tst$p.value
				title(paste(Main0,"Histologic Subtype and Overdiagnosis","\nP=", sprintf("%.2e",pval)))

		###### [for making output file] make a matrix by histology ###########
		# > overhist[1:10,]
		#       overdiag     subtype
		#  [1,] NA           "AD.BAC.LC"
		#  [2,] "11.1560448" "AD.BAC.LC"
		#  [3,] "10.8320251" "AD.BAC.LC"
		#  [4,] "10.9157065" "AD.BAC.LC"
		#  [5,] "11.0621714" "AD.BAC.LC"
		#  [6,] "10.714584"  "AD.BAC.LC"

		overall = cbind(overdiag=y, subtype="Overall")
		overHist = rbind(overall,overhist)
		overHist=cbind(overHist, Model=rep(MD,nrow(overHist)), Gender=rep(gender,nrow(overHist)))
		overHist[1:5,]
		#      overdiag           subtype   Model
		# [1,] "NaN"              "Overall" "Erasmus"
		# [2,] "4.52351190393053" "Overall" "Erasmus"
		# [3,] "4.30015522025795" "Overall" "Erasmus"
		# [4,] "4.11305581879205" "Overall" "Erasmus"
		# [5,] "4.56229235891468" "Overall" "Erasmus"

		table(overHist[,2])
		# AD.BAC.LC      NSCO   Overall        SC        SQ
		#       577       577       577       577       577
		if(gender=="Female") overHist.f = overHist
		if(gender=="Male") overHist.m=overHist



				if(MD=="Stanford"){

					### four histology only ##

					indic=overhist[,"subtype"]!="BAC"
					overhist2=overhist[indic,]
					nm2=names(table(overhist2[,2]));nm2
					overhist2=data.frame(overhist2)
					overhist2[,1]=as.numeric(as.character(overhist2[,1]))
					tt=aggregate(overdiag~subtype,data=overhist2,mean,na.rm=T)
					md2=tt[,2]

					#md2=md[names(md)!="BAC"][-1]
					#md2
					#      ALL       AD       SQ       LC       SC
					# 8.715972 8.913715 6.887847 8.112153 5.444792
					#nm2=names(md2)

					boxplot(as.numeric(overhist2[,1])~overhist2[,2],col="red",cex.axis=1.5,cex.lab=1.5,
							ylab="Overdiagnosis Rate (%)", cex.main=2,ylim=c(2,20))#main=paste(Main0,"Histologic Subtype and Overdiagnosis"),)
					text(1:4,rep(11,4), paste(round(md2,1)," %",sep=""), col="blue",cex=1.5)

					tst2=kruskal.test(as.numeric(overhist2[,1]), as.factor(overhist2[,2]))
					pval=tst2$p.value
					title(paste(Main0,"Histologic Subtype and Overdiagnosis","\nP=", sprintf("%.2e",pval)))

				}#


				########### [5] gender comparison boxplot ##############################

				xx1=dat.f[!indic, "LC.overRate90"]*100
				xx2=dat.m[!indic, "LC.overRate90"]*100

				if(MD=="FH" | MD=="MGH"){

					xx1=dat.f[!indic, "LC.overRate90"]
					xx2=dat.m[!indic, "LC.overRate90"]

				}
				#xx1=read.csv(file1)[!indic,"LC.overRate90"]*100
				#xx2=read.csv(file2)[!indic,"LC.overRate90"]*100

				temp=cbind(overdiag=c(xx1,xx2), subtype=c(rep("Female",length(xx1)), rep("Male",length(xx1))))
				md3=c(median(xx1,na.rm=T),median(xx2,na.rm=T));md3
				#[1] 12.04536 11.90070
				#nm2=names(table(overhist[,2]))
				#[1] "AD" "LC" "SC" "SQ

				#md2= md[nm2]

				YLIM=c(2,14)
				if(MD=="FH") YLIM=c(2,25)

				boxplot(as.numeric(temp[,1])~temp[,2],col="red",cex.axis=1.5,cex.lab=1.5,
						ylab="Overdiagnosis Rate (%)", cex.main=2,ylim=YLIM)

				text(1:2,rep(11.8,2), paste(round(md3,1)," %",sep=""), col="blue",cex=2)
				tst3=kruskal.test(as.numeric(temp[,1]), as.factor(temp[,2]))
				pval=tst3$p.value
				title(paste("[",MD,"]","Gender and Overdiagnosis","\nP=", sprintf("%.3f",pval)))



				#### gender comparison without BAC ######

				if(MD=="FH" | MD=="MGH" | MD=="Stanford"){

					#if(MD=="Erasmus") { bacColName="LC.overRate90.AD.BAC.LC"; bacColName.sc = "LCcases.AD.BAC.LC.scr90" }

					bacColName="LC.over90.BAC"; bacColName.sc = "LCcases.BAC.scr90"
					#bacColName="LC.overRate90.BAC"; bacColName.sc = "LCcases.BAC.scr90"

					xx1=100*(dat.f[,"LCcasesOver90"]-dat.f[,bacColName])/(dat.f[,"LCcases.sdet90"]-dat.f[,bacColName.sc])
					median(xx1,na.rm=T)

					median(xx1,na.rm=T)

					xx2=100*(dat.m[,"LCcasesOver90"]-dat.m[,bacColName])/(dat.m[,"LCcases.sdet90"]-dat.m[,bacColName.sc])
					median(xx2,na.rm=T)


							temp=cbind(overdiag=c(xx1,xx2), subtype=c(rep("Female",length(xx1)), rep("Male",length(xx1))))
							md3=c(median(xx1,na.rm=T),median(xx2,na.rm=T))

							#nm2=names(table(overhist[,2]))
							#[1] "AD" "LC" "SC" "SQ

							#md2= md[nm2]
					YLIM=c(2,14)
					if(MD=="FH") YLIM=c(2,30)

							boxplot(as.numeric(temp[,1])~temp[,2],col="red",cex.axis=1.5,cex.lab=1.5,
									ylab="Overdiagnosis Rate (%)", cex.main=2,ylim=YLIM)

							text(1:2,rep(11.8,2), paste(round(md3,1)," %",sep=""), col="blue",cex=2)
							tst3=kruskal.test(as.numeric(temp[,1]), as.factor(temp[,2]))
							pval=tst3$p.value
							title(paste("Gender and Overdiagnosis (W/O BAC)","\nP=", sprintf("%.2e",pval)))

				}#if(MD=="FH"){


					#xx1=100*(dat.f[,"LCcasesOver90"]-dat.f[,"LC.over90.BAC"])/(dat.f[,"LCcases.sdet90"]-dat.f[,"LCcases.BAC.scr90"])
					#xx1=(dat.f[,"LCcasesOver90"])/dat.f[,"LCcases.sdet90"]
					#median(xx1,na.rm=T)

					#xx2=100*(dat.m[,"LCcasesOver90"]-dat.m[,bacColName])/(dat.m[,"LCcases.sdet90"]-dat.m[,bacColName.sc])

		        ######## [6] Overdiagnosis by age ########################################

		        			 ######## overdiagnosis by age group #########

				ynames=c("LC.overRate90","LC.overRate.ltn.50","LC.overRate.50_60","LC.overRate.60_70" ,"LC.overRate.70_80"  ,"LC.overRate.80_90"  )
				Names=c("Total","<50","50-60","60-70","70-80","80-90")

				tt=(mydat[,ynames])*100

				if(MD=="FH" | MD=="MGH"){   tt=mydat[,ynames]  }

				md=NA
				md=apply(tt,2,mean,na.rm=T);md
				#    LC.overRate90 LC.overRate90.ad LC.overRate90.sq LC.overRate90.lg LC.overRate90.sm
				#       0.05025038       0.05551892       0.04456900       0.04500618       0.04654051
				names(md)=Names
				md

				### boxplot for age groups ##

				overhist=cbind(overdiag=c(tt[,2],tt[,3],tt[,4],tt[,5],tt[,6]), age=c(rep(Names[2],nrow(tt)),rep(Names[3],nrow(tt)), rep(Names[4],nrow(tt)), rep(Names[5],nrow(tt)), rep(Names[6],nrow(tt))))
				overhist[1:5,]
				#      overdiag             subtype
				# [1,] "0.0479041916167665" "AD"
				# [2,] "0.0486486486486487" "AD"
				# [3,] "0.0511945392491468" "AD"
				# [4,] "0.049553208773355"  "AD"
				# [5,] "0.0464135021097046" "AD"

				nm2=names(table(overhist[,2]))
				#[1] "AD" "LC" "SC" "SQ

				md2= md[nm2]

				boxplot(as.numeric(overhist[,1])~overhist[,2],col="red",cex.axis=1.5,cex.lab=1.5,
						ylab="Overdiagnosis Rate (%)", cex.main=2,ylim=c(2,35))#main=paste(Main0,"Histologic Subtype and Overdiagnosis"),)
				text(1:5,rep(11,5), paste(round(md2,1)," %",sep=""), col="blue",cex=1.5)

				tst=kruskal.test(as.numeric(overhist[,1]), as.factor(overhist[,2]))
				pval=tst$p.value
				title(paste(Main0,"Age (diagnosis) and Overdiagnosis","\nP=", sprintf("%.2e",pval)))


		###### [for making output file] make a matrix by histology ###########
		# > overhist[1:10,]
		#       overdiag     subtype
		#  [1,] NA           "AD.BAC.LC"
		#  [2,] "11.1560448" "AD.BAC.LC"
		#  [3,] "10.8320251" "AD.BAC.LC"
		#  [4,] "10.9157065" "AD.BAC.LC"
		#  [5,] "11.0621714" "AD.BAC.LC"
		#  [6,] "10.714584"  "AD.BAC.LC"


		overAge=cbind(overhist, Model=rep(MD,nrow(overhist)), Gender=rep(gender,nrow(overhist)))
		overAge[1:5,]
		#      overdiag age   Model Gender
		# [1,] NA       "<50" "MGH" "Female"
		# [2,] "32.05"  "<50" "MGH" "Female"
		# [3,] "30.77"  "<50" "MGH" "Female"
		# [4,] "26.89"  "<50" "MGH" "Female"
		# [5,] NA       "<50" "MGH" "Female"

		if(gender=="Female") overAge.f = overAge
		if(gender=="Male") overAge.m=overAge


				######### [6] USPSTF vs. NLST data extract ################################

				SCN =c("A-55-80-30-15", "A-55-75-30-15", "NoScreen")

				COLNAMES = c( "scenario", ynames.hist,
				"PctEverScreened100",
				"CTscreens90",
				"LCcases90",
				"PctEarlyStage90",
				"MortReduct90",
				"Deaths.avoided90",
				"LCcasesOver90"); COLNAMES

				 indic2 = sc %in% SCN

				 mydat.s = mydat[indic2,COLNAMES]
				 row.names(mydat.s)=mydat.s[,"scenario"]
				 mydat.s=mydat.s[SCN,]


				 savePerOver=mydat.s[,"Deaths.avoided90"]/mydat.s[,"LCcasesOver90"]

				 mydat.s2=cbind(mydat.s, savePerOver=savePerOver)
				 t(mydat.s2)
				 if(gender=="Female")  ans.f = mydat.s2
				 if(gender=="Male") ans.m = mydat.s2


				 ###### [7] Efficient scenarios #############################################

				xname="CTscreens90"
				scname="scenario"
				WRITE=T

				###### (1) efficient scneario using Old Y ###########

				y=mydat[,"Deaths.avoided90"]/max(mydat[,"Deaths.avoided90"],na.rm=T)
				mydat=cbind(mydat, death.avoided.percent.90=y)
				yname="death.avoided.percent.90"
				putZero=F
				YLIM=c(0,1)
				#tt1=myUS.plots.big.general(MYDAT,HEAD,xname,yname, sname, WRITE)
				HEAD=Main0


				if(sum(is.na(y))>0) putZero=T   # it's about whether NoScreen has NA or 0
				if(sum(is.na(y))==0) putZero=F
				tt1=myUS.plots.big.general.over(mydat,HEAD,xname,yname, sname, WRITE=F,putZero,YLIM,scname)

									doThis=F
									if(doThis==T){

										DAT=MYDAT
										### make some identification ##
										tt0=myUS.plot2(xname, yname, scname, DAT,MAIN=HEAD, nlsts=NULL, putZero=T,YLIM,IDENTIFY=T,identifyPT=T)
											x=tt0$x; y=tt0$y; labs=tt0$labs
											identifyPch(x,y,labs)
											abline(v=200000,col="black",lty="dotted")
											abline(v=300000,col="black",lty="dotted")

									}


				### save it for male and female ###
				sc1=row.names(tt1[[1]]) #"noscreen"      "T-55-85-40-10" "T-55-85-40-20" "B-60-85-30-20"
				if(gender=="Male") sc1.m=sc1
				if(gender=="Female") sc1.f=sc1


				if(gender=="Male"){

						####### compare it to female scenarios (new-new) ###

						DAT=mydat
						scns=sc1.f # male

						myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD, putZero, YLIM, IDENTIFY=F,addNo=T,scns,LND="Female Efficient Scenarios",text.cex=0.8)

				}#end of
									doThis=F
									if(doThis==T){
										### compare it to the scenarios from new Y ##
										scns=sc1.m # old Y, male
										tt00=myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD, putZero, YLIM, IDENTIFY=T,addNo=T,scns,LND="Male Efficient Scenarios",text.cex=0.8)

										x=tt1$x; y=tt1$y; labs=tt1$labs
										identifyPch(x,y,labs)
									}#end of


								doThis=F
								if(doThis==T){
									## compare to the new scenarios ##
									#scns=sc1 # old
									scns=sc2.m # male
									DAT=MYDAT
									myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD, putZero, YLIM, IDENTIFY=T,addNo=T,scns,LND="Male Scenarios",text.cex=1)

								}#end of

				###### (2) efficient scneario using new Y ###########

				y=mydat[,"Deaths.avoided90"]/mydat[,"LCcasesOver90"]
				mydat=cbind(mydat, death.avoided.per.over90=y)
				yname="death.avoided.per.over90"
				YLIM=c(0,7)
				putZero=T # noScreen Y=0

				tt2=myUS.plots.big.general.over(mydat,HEAD,xname,yname, sname, WRITE,putZero,YLIM,scname)
				sc2=row.names(tt2[[1]])
				if(gender=="Male") sc2.m=sc2
				if(gender=="Female") sc2.f=sc2


				if(gender=="Male"){

						####### compare it to female scenarios (new-new) ###

						DAT=mydat
						scns=sc2.f # male

						myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD, putZero, YLIM, IDENTIFY=F,addNo=T,scns,LND="Female Efficient Scenarios",text.cex=0.8)

				}#end of Male

						doThis=F
						if(doThis==T){

							DAT=mydat
							### make some identification ##
							#tt0=myUS.plot2(xname, yname, scname, DAT,MAIN=HEAD, nlsts=NULL, putZero=T,YLIM,IDENTIFY=T,identifyPT=T)
							#	x=tt0$x; y=tt0$y; labs=tt0$labs
							#	identifyPch(x,y,labs)
							#	abline(v=200000,col="black",lty="dotted")
							#	abline(v=300000,col="black",lty="dotted")

							## compare to the old scenarios ##
							#scns=sc1.m # old
							scns=sc2.f # male
							DAT=MYDAT
							myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD, putZero, YLIM, IDENTIFY=T,addNo=T,scns,LND="Male Efficient Scenarios",text.cex=0.8)

						}#end of




			}# i gender

			ff=t(ans.f)
			mm=t(ans.m)
			colnames(ff)=paste("F",1:ncol(ff),sep="")
			colnames(mm)=paste("M",1:ncol(mm),sep="")

			overHist=rbind(overHist.f, overHist.m)
			overAGE=rbind(overAge.f, overAge.m)

			ans=cbind(ff,mm)
			#ans=list(female=t(ans.f), male=t(ans.m))
			ans2=ans[,c("F3","M3", "F2","M2", "F1","M1")]

			myans = list(USPSTF=ans2, overdiagHist = overHist,overdiagAge=overAGE)
			myans


}#end of



		 		myDatExtract=function(DAT,yname,gender,cnames){

						### rows: models, columns: USPSTF vs. NLST

						tm1= DAT[,c(yname,cnames)]
						indic = tm1[,"Gender"]==gender
						tm2=tm1[indic,]
						#      LC.overRate90      scenario    Model Gender
						# 1:1        8.00000 A-55-75-30-15 Stanford      F
						# 1:3        8.80000 A-55-80-30-15 Stanford      F
						# 1:5       10.75346 A-55-75-30-15  Erasmus      F
						# 1:7       12.65675 A-55-80-30-15  Erasmus      F
						# 1:9       17.58000 A-55-75-30-15       FH      F
						# 1:11      23.18000 A-55-80-30-15       FH      F
						# 2:1        4.44000 A-55-75-30-15      MGH      F
						# 2:3        5.31000 A-55-80-30-15      MGH      F
						tm3=tm2[,-ncol(tm2)]


						tt1=tm3[seq(1,nrow(tm3),by=2), ]
						# > tt1
						#     LC.overRate90      scenario    Model
						# 1:1       8.00000 A-55-75-30-15 Stanford
						# 1:5      10.75346 A-55-75-30-15  Erasmus
						# 1:9      17.58000 A-55-75-30-15       FH
						# 2:1       4.44000 A-55-75-30-15      MGH

						tm4=tt1[,c(1,3)];colnames(tm4)=c(as.character(tt1[1,"scenario"]), "Model")
						# > tm4
						#     A-55-75-30-15    Model
						# 1:1       8.00000 Stanford
						# 1:5      10.75346  Erasmus
						# 1:9      17.58000       FH
						# 2:1       4.44000      MGH

						tt2=tm3[seq(2,nrow(tm3),by=2), ]
						# > tt1
						#     LC.overRate90      scenario    Model
						# 1:1       8.00000 A-55-75-30-15 Stanford
						# 1:5      10.75346 A-55-75-30-15  Erasmus
						# 1:9      17.58000 A-55-75-30-15       FH
						# 2:1       4.44000 A-55-75-30-15      MGH

						tm5=tt2[,c(1,3)];colnames(tm5)=c(as.character(tt2[1,"scenario"]), "Model")


						ttt=cbind(tm4[,1],tm5[,1]);row.names(ttt)=as.character(tm5[,"Model"]);colnames(ttt)=c(colnames(tm4)[1],colnames(tm5)[1])
						# > ttt
						#          A-55-75-30-15 A-55-80-30-15
						# Stanford       8.80000       8.80000
						# Erasmus       12.65675      12.65675
						# FH            23.18000      23.18000
						# MGH            5.31000       5.31000

						ttt

				}#3ndof


### [2/19/2014] efficient scenarios only on Annual screens + age group combine ##
myOversiagAnalysis2 <- function(dat.f, dat.m, MD, histo){  # overdiagnosis analysis by model


			genders=c("Female","Male")#,"Both Gender")
			overAge.f=overAge.m = NA

			for( i in 1:length(genders)){

				gender=genders[i]

				Main0=MAIN=paste("[",MD,"-",gender,"] ",sep="");Main0

				if(gender=="Female")  dat1=dat.f
				if(gender=="Male")    dat1=dat.m
				#  [1] "X"                                "NUM"                              "scenario"                         "age.start"
				#  [5] "age.stop"                         "age.interval"                     "py"                               "ysq"
				#  [9] "n.total"                          "n.entry.all"                      "n.case"                           "LCcases.noscreen100"
				# [13] "LCdeaths.noscreen100"             "PercentScreened100"               "AverageScreen100"                 "CTscreens100"
				# [17] "CTexams100"                       "PctEarlyStage100"                 "LCcases100"                       "LCcases.sdet100"
				# [21] "LCcases.sdet.eff100"              "LCdeaths100"                      "LCcasesOver100"                   "Deaths.avoided100"
				# [25] "LifeYearsSaved100"                "MortReduct100"                    "AlldeathsCase100"                 "AlldeathsNoncases100"
				# [29] "Ratio.case.scrdet.per.CT100"      "Rario.deaths.avoided_case.scr100" "LCcases.noscreen90"               "LCdeaths.noscreen90"
				# [33] "CTscreens90"                      "CTexams90"                        "PctEarlyStage90"                  "LCcases90"
				# [37] "LCcases.sdet90"                   "LCcasesOver90"                    "LC.overRate90"                    "LC.overRate90.ad"
				# [41] "LC.overRate90.sq"                 "LC.overRate90.lg"                 "LC.overRate90.sm"                 "LCdeaths90"
				# [45] "Deaths.avoided90"                 "LifeYearsSaved90"                 "MortReduct90"                     "Alldeaths90"
				# [49] "Alldeaths.case.noncase90"         "prop.cdet.90"                     "LCdeathsSurgery_overDiag90"       "LCdeathsSurgery_sdet90"
				# [53] "AlldeathsSurgery90"               "AlldeathsSurgery_noscreen90"      "CTscreens90_abs"                  "CTexams90_abs"
				# [57] "LCcases90_abs"                    "LCdeaths90_abs"

				# > colnames(dat1)
				#  [1] "Freq.Start.Stop.PY.YSQ"     "PctEverScreened100"         "CTscreens100"
				#  [4] "CTscreens90"                "CTexams90"                  "LCcases90"
				#  [7] "PctEarlyStage90"            "LCdeaths90"                 "Alldeaths90"
				# [10] "LcdeathsSurgery_overDiag90" "Deaths.avoided90"           "LifeYearsSaved90"
				# [13] "MortReduct90"               "LCcases.sdet90"             "LCcasesOver90"
				# [16] "LCcases.BAC90"              "LCcases.BAC.scr90"          "LC.over90.BAC"
				# [19] "LCcases.AD90"               "LCcases.AD.scr90"           "LC.over90.AD"
				# [22] "LCcases.SQ90"               "LCcases.SQ.scr90"           "LC.over90.SQ"
				# [25] "LCcases.LC90"               "LCcases.LC.scr90"           "LC.over90.LC"
				# [28] "LCcases.SC90"               "LCcases.SC.scr90"           "LC.over90.SC"
				# [31] "LCcases.NSCO90"             "LCcases.NSCO.scr90"         "LC.over90.NSCO"
				# [34] "LCcases.NSCO2.90"           "LCcases.NSCO2.scr90"        "LC.over90.NSCO2"
				# [37] "LCcases.AD.BAC.LC.90"       "LCcases.AD.BAC.LC.scr90"    "LC.over90.AD.BAC.LC"
				# [40] "LCcases.AD.BAC.90"          "LCcases.AD.BAC.scr90"       "LC.over90.AD.BAC"
				# [43] "LCcases.ltn.50"             "LCcases.ltn50.scr"          "LC.over.ltn50"
				# [46] "LCcases.50_60"              "LCcases.50_60.scr"          "LC.over.50_60"
				# [49] "LCcases.60_70"              "LCcases.60_70.scr"          "LC.over.60_70"
				# [52] "LCcases.70_80"              "LCcases.70_80.scr"          "LC.over.70_80"
				# [55] "LCcases.80_90"              "LCcases.80_90.scr"          "LC.over.80_90"
				# [58] "LC.overRate90"              "LC.overRate90.bac"          "LC.overRate90.ad"
				# [61] "LC.overRate90.sq"           "LC.overRate90.lg"           "LC.overRate90.sm"
				# [64] "LC.overRate.NSCO90"         "LC.overRate.NSCO2.90"       "LC.overRate.AD.BAC.LC90"
				# [67] "LC.overRate.AD.BAC90"       "LC.overRate.ltn.50"         "LC.overRate.50_60"
				# [70] "LC.overRate.60_70"          "LC.overRate.70_80"          "LC.overRate.80_90"

				mean(dat1[,"LC.overRate90"],na.rm=T)
				#mean(dat1[,"LC.overRate90.bac"],na.rm=T)
				#mean(dat1[,"LC.overRate90.ad"],na.rm=T)
				mean(dat1[,"MortReduct90"],na.rm=T)

				# mean(dat1[,"LC.overRate90"],na.rm=T)  # Erasmus
				# [1] 0.1207433
				# mean(dat1[,"MortReduct90"],na.rm=T)
				# [1] 0.1457651

				# > mean(dat1[,"LC.overRate90"],na.rm=T)  # FH
				# [1] 19.6168
				# >mean(dat1[,"MortReduct90"],na.rm=T)
				# [1] 29.61986



				########### change the column name "Freq-Start-Stop..." to "scenario" ####
				mydat0=dat1
				colnames(mydat0)[grep("Freq",colnames(mydat0))]="scenario"

				### exclude:
				#A-55-57-30-15
				#A-62-64-30-15


				########### [1] take out two small scenarios ####################

				indic = as.character(mydat0[,"scenario"])  %in% c("A-55-57-30-15","A-62-64-30-15")
				sum(indic)
				mydat=mydat0[!indic,]
				dim(mydat)

				### make start, stop, py and ysq variables ###
				sc=as.character(mydat[,"scenario"])
				sc[1:10]
				#  [1] "NoScreen"      "A-45-75-10-10" "B-45-75-10-10" "T-45-75-10-10" "A-45-75-10-15"
				#  [6] "B-45-75-10-15" "T-45-75-10-15" "A-45-75-10-20" "B-45-75-10-20" "T-45-75-10-20"

				### change "NoScreen" to "NA-NA-NA-NA-NA" format

				sc2=gsub("NoScreen","NA-NA-NA-NA-NA",sc)
				tm1=unlist(strsplit(sc2,split="-"))

				freq = tm1[seq(1,length(tm1), by=5)] ; freq[freq=="NA"]=NA
				age.start = tm1[seq(2,length(tm1), by=5)];  age.start[age.start=="NA"]=NA
				age.stop = tm1[seq(3,length(tm1), by=5)]; age.stop[age.stop=="NA"]=NA
				PY = tm1[seq(4,length(tm1), by=5)]; PY[PY=="NA"]=NA
				YSQ = tm1[seq(5,length(tm1), by=5)]; YSQ[YSQ=="NA"]=NA

				mydat=data.frame(mydat,age.interval=freq, age.start=age.start, age.stop=age.stop, py=PY, ysq=YSQ)



				################ [2] Histogram of overdiagnosis rate variable (ALL SUBTYPE) ##################

				y=mydat[,"LC.overRate90"]*100   # of overdiag / # of screen detected
				if(MD=="FH" | MD=="MGH" | MD=="MCH") y=mydat[,"LC.overRate90"]

				#y=mydat[,"LC.overRate90.ad"]*100
				#y=mydat[,"LC.overRate90"]*100
				#y=mydat[,"LC.overRate90"]*100

				range(y,na.rm=T)
				#[1]  8.768742 15.656788

				#range(x)
				md=mean(y,na.rm=T);md

				hist(y,nclass=10,col="red",main=paste(Main0, "\n Overdiagnosis Rate ","(mean=",round(md,2),"%)",sep=""),freq=F, cex.main=1.5,cex.lab=1.5, cex.axis=1.5, xlab="Overdiagnosis Rate (%)")

						#    LC.overRate90 LC.overRate90.ad LC.overRate90.sq LC.overRate90.lg LC.overRate90.sm
						#       0.05025038       0.05551892       0.04456900       0.04500618       0.04654051


				##############  [3] boxplots of overdiagnosis related variable ###


				#mycolnames=c("Overdiag","CTscreens90","PctEarlyStage90","PercentScreened100","MortReduct90","LCdeaths90","Deaths.avoided90",
				#			"LifeYearsSaved90","LCdeathsSurgery_overDiag90","age.interval","age.start","age.stop","py","ysq","start.stop","start.stop2")
				#varfeatures=c(rep("con",8), rep("cat",8))

				mycolnames=c("Overdiag",
							"CTscreens90","PctEarlyStage90","MortReduct90","LCdeaths90","Deaths.avoided90","LifeYearsSaved90",
							"age.interval","age.start","age.stop","py","ysq","start.stop","start.stop2")
				varfeatures=c(rep("con",7), rep("cat",7))


				########## age.stop and age.start combination: high risk ##############

				 x1=mydat[,"age.start"]
				 x2=mydat[,"age.stop"]
			  table(x1)
				# x1
				#  45  50  55  60
				# 144 144 144 144
				# > table(x2)
				# x2
				#  75  80  85
				# 192 192 192

				start_stop=paste(x1,x2,sep="-")
				# > table(ag)
				# ag
				# 45-75 45-80 45-85 50-75 50-80 50-85 55-75 55-80 55-85 60-75 60-80 60-85 NA-NA
				#    48    48    48    48    48    48    48    48    48    48    48    48     1
				start_stop = gsub("NA",NA,start_stop)
				start_stop2=start_stop
				start_stop2[!(start_stop2 %in% c("45-75","60-85"))]=NA


				DATA=cbind(Overdiag=y, mydat,start.stop=start_stop,start.stop2=start_stop2)
				#varfeatures=c(rep("con",8), rep("cat",8))

				#varfeatures=c("cat","cat","cat","b","b","cat","con","con","con","b","con")
				x1name="Overdiag"
				x2names=mycolnames

				par("mar"=c(5,5,4,2))
				YLIM=c(1,18)
				if(MD=="FH" | MD=="MCH") YLIM=c(5,35)
				myInvestigate.variable3(x1name,x2names,DATA,varfeatures,YLIM,MAIN)


				######### [4] histology specific overdiagnosis ############################

				# > histo
				# [1] "AD.BAC.LC" "SQ"        "SC"        "NSCO"

				ynames = ynames.hist = c("LC.overRate90", paste("LC.overRate90",histo,sep="."))
				Names=c("All Subtypes", histo)
				ynames
				Names

				# > ynames
				# [1] "LC.overRate90"           "LC.overRate90.AD.BAC.LC" "LC.overRate90.SQ"
				# [4] "LC.overRate90.SC"        "LC.overRate90.NSCO"
				# > Names
				# [1] "All Subtypes" "AD.BAC.LC"    "SQ"           "SC"           "NSCO"

				#ynames=c("LC.overRate90","LC.overRate90.bac","LC.overRate90.ad","LC.overRate90.sq" ,"LC.overRate90.lg"  ,"LC.overRate90.sm"  )
				#Names=c("All Subtype","BAC","AD","SQ","LC","SC")

				tt=mydat[,ynames]*100
				# > tt[1:5,]
				#               LC.overRate90 LC.overRate90.BAC LC.overRate90.AD LC.overRate90.SQ LC.overRate90.LC LC.overRate90.SC
				# A-45-75-10-10           7.2              11.6              6.9              7.5              6.4              5.2
				# A-45-75-10-15           7.2              11.3              7.1              7.5              6.6              4.9
				# A-45-75-10-20           7.1              12.0              6.8              7.7              6.3              4.9
				# A-45-75-10-25           7.2              12.1              6.9              7.7              6.0              4.9
				# A-45-75-20-10           7.2              11.1              6.9              7.5              6.7              5.6

	row.names(tt)=mydat[,"scenario"]
				if(MD=="FH" | MD=="MGH" | MD=="MCH") tt=mydat[,ynames]
				# > colnames(tt)
				# [1] "LC.overRate90"           "LC.overRate90.AD.BAC.LC" "LC.overRate90.SQ"
				# [4] "LC.overRate90.SC"        "LC.overRate90.NSCO"

				md=apply(tt,2,mean,na.rm=T);md
				#    LC.overRate90 LC.overRate90.ad LC.overRate90.sq LC.overRate90.lg LC.overRate90.sm
				#       0.05025038       0.05551892       0.04456900       0.04500618       0.04654051
				#names(md)=c("ALL","BAC","AD","SQ","LC","SC")
				names(md)=Names

				### Make a long type data boxplot for subtypes (except for all) ##
				#   LC.overRate90 LC.overRate90.AD.BAC.LC LC.overRate90.SQ LC.overRate90.SC
				# 1            NA                      NA               NA               NA
				# 2      9.783653                11.15604         8.763505         3.513957
				# 3      9.623033                10.83203         8.573370         3.305991
				# 4      9.612586                10.91571         7.984921         3.248974
				# 5      9.716076                11.06217         8.773393         3.546635
				overdiag=as.vector(unlist(tt[,-1]))

				# > overdiag[1:5]
				# [1]       NA 11.15604 10.83203 10.91571 11.06217
				subtype=rep(histo,each=nrow(tt))

				overhist=cbind(overdiag=overdiag, subtype=subtype)
	row.names(overhist) = rep(mydat[,"scenario"],length(unique(subtype)))
	# > overhist[1:5,]
	#               overdiag subtype
	# A-45-75-10-10 "11.6"   "BAC"
	# A-45-75-10-15 "11.3"   "BAC"
	# A-45-75-10-20 "12"     "BAC"
	# A-45-75-10-25 "12.1"   "BAC"
	# A-45-75-20-10 "11.1"   "BAC"
			# > overhist[row.names(overhist)=="A-45-75-10-10",]
			#               overdiag subtype
			# A-45-75-10-10 "11.6"   "BAC"
			# A-45-75-10-10 "6.9"    "AD"
			# A-45-75-10-10 "7.5"    "SQ"
			# A-45-75-10-10 "6.4"    "LC"
			# A-45-75-10-10 "5.2"    "SC"


				# > overhist[1:10,]
				#       overdiag     subtype
				#  [1,] NA           "AD.BAC.LC"
				#  [2,] "11.1560448" "AD.BAC.LC"
				#  [3,] "10.8320251" "AD.BAC.LC"
				#  [4,] "10.9157065" "AD.BAC.LC"
				#  [5,] "11.0621714" "AD.BAC.LC"

				#overhist=cbind(overdiag=c(tt[,2],tt[,3],tt[,4],tt[,5],tt[,6]), subtype=c(rep("BAC",nrow(tt)),rep("AD",nrow(tt)), rep("SQ",nrow(tt)), rep("LC",nrow(tt)), rep("SC",nrow(tt))))

				overhist[1:5,]
				#      overdiag             subtype
				# [1,] "0.0479041916167665" "AD"
				# [2,] "0.0486486486486487" "AD"
				# [3,] "0.0511945392491468" "AD"
				# [4,] "0.049553208773355"  "AD"
				# [5,] "0.0464135021097046" "AD"

				### order can change depending on boxplot
				nm2=names(table(overhist[,2]));nm2
				#[1] "AD" "LC" "SC" "SQ

				md2= md[nm2]; md2

				YLIM=c(2,22)
				if(MD=="FH" | MD=="MCH") YLIM=c(2,60)

				boxplot(as.numeric(overhist[,1])~overhist[,2],col="red",cex.axis=1.2,cex.lab=1.5,
						ylab="Overdiagnosis Rate (%)", cex.main=2,ylim=YLIM)#main=paste(Main0,"Histologic Subtype and Overdiagnosis"),)
				text(1:length(md2),rep(11,length(md2)), paste(round(md2,1)," %",sep=""), col="blue",cex=1.5)

				tst=kruskal.test(as.numeric(overhist[,1]), as.factor(overhist[,2]))
				pval=tst$p.value
				title(paste(Main0,"Histologic Subtype and Overdiagnosis","\nP=", sprintf("%.2e",pval)))

		###### [for making output file] make a matrix by histology ###########
		# > overhist[1:10,]
		#       overdiag     subtype
		#  [1,] NA           "AD.BAC.LC"
		#  [2,] "11.1560448" "AD.BAC.LC"
		#  [3,] "10.8320251" "AD.BAC.LC"
		#  [4,] "10.9157065" "AD.BAC.LC"
		#  [5,] "11.0621714" "AD.BAC.LC"
		#  [6,] "10.714584"  "AD.BAC.LC"
		# > overhist[1:5,]
		#               overdiag subtype
		# A-45-75-10-10 "11.6"   "BAC"
		# A-45-75-10-15 "11.3"   "BAC"
		# A-45-75-10-20 "12"     "BAC"
		# A-45-75-10-25 "12.1"   "BAC"
		# A-45-75-20-10 "11.1"   "BAC"

		overall = cbind(overdiag=y, subtype="Overall")
row.names(overall)=mydat[,"scenario"]
		overHist = rbind(overall,overhist)
		overHist=cbind(overHist, Model=rep(MD,nrow(overHist)), Gender=rep(gender,nrow(overHist)))
		overHist[1:5,]
		#      overdiag           subtype   Model
		# [1,] "NaN"              "Overall" "Erasmus"
		# [2,] "4.52351190393053" "Overall" "Erasmus"
		# [3,] "4.30015522025795" "Overall" "Erasmus"
		# [4,] "4.11305581879205" "Overall" "Erasmus"
		# [5,] "4.56229235891468" "Overall" "Erasmus"

		table(overHist[,2])
		# AD.BAC.LC      NSCO   Overall        SC        SQ
		#       577       577       577       577       577
		if(gender=="Female") overHist.f = overHist
		if(gender=="Male") overHist.m=overHist



# 				if(MD=="Stanford"){
#
# 					### four histology only ##
#
# 					indic=overhist[,"subtype"]!="BAC"
# 					overhist2=overhist[indic,]
# 					nm2=names(table(overhist2[,2]));nm2
# 					overhist2=data.frame(overhist2)
# 					overhist2[,1]=as.numeric(as.character(overhist2[,1]))
# 					tt=aggregate(overdiag~subtype,data=overhist2,mean,na.rm=T)
# 					md2=tt[,2]
#
# 					#md2=md[names(md)!="BAC"][-1]
# 					#md2
# 					#      ALL       AD       SQ       LC       SC
# 					# 8.715972 8.913715 6.887847 8.112153 5.444792
# 					#nm2=names(md2)
#
# 					boxplot(as.numeric(overhist2[,1])~overhist2[,2],col="red",cex.axis=1.5,cex.lab=1.5,
# 							ylab="Overdiagnosis Rate (%)", cex.main=2,ylim=c(2,20))#main=paste(Main0,"Histologic Subtype and Overdiagnosis"),)
# 					text(1:4,rep(11,4), paste(round(md2,1)," %",sep=""), col="blue",cex=1.5)
#
# 					tst2=kruskal.test(as.numeric(overhist2[,1]), as.factor(overhist2[,2]))
# 					pval=tst2$p.value
# 					title(paste(Main0,"Histologic Subtype and Overdiagnosis","\nP=", sprintf("%.2e",pval)))
#
# 				}#


				########### [5] gender comparison boxplot ##############################

				xx1=dat.f[!indic, "LC.overRate90"]*100
				xx2=dat.m[!indic, "LC.overRate90"]*100

				if(MD=="FH" | MD=="MGH" | MD=="MCH"){

					xx1=dat.f[!indic, "LC.overRate90"]
					xx2=dat.m[!indic, "LC.overRate90"]

				}
				#xx1=read.csv(file1)[!indic,"LC.overRate90"]*100
				#xx2=read.csv(file2)[!indic,"LC.overRate90"]*100

				temp=cbind(overdiag=c(xx1,xx2), subtype=c(rep("Female",length(xx1)), rep("Male",length(xx1))))
				md3=c(median(xx1,na.rm=T),median(xx2,na.rm=T));md3
				#[1] 12.04536 11.90070
				#nm2=names(table(overhist[,2]))
				#[1] "AD" "LC" "SC" "SQ

				#md2= md[nm2]

				YLIM=c(2,14)
				if(MD=="FH" | MD=="MCH" ) YLIM=c(2,25)

				boxplot(as.numeric(temp[,1])~temp[,2],col="red",cex.axis=1.5,cex.lab=1.5,
						ylab="Overdiagnosis Rate (%)", cex.main=2,ylim=YLIM)

				text(1:2,rep(11.8,2), paste(round(md3,1)," %",sep=""), col="blue",cex=2)
				tst3=kruskal.test(as.numeric(temp[,1]), as.factor(temp[,2]))
				pval=tst3$p.value
				title(paste("[",MD,"]","Gender and Overdiagnosis","\nP=", sprintf("%.3f",pval)))



				#### gender comparison without BAC ######

				if(MD=="FH" | MD=="MGH" | MD=="Stanford"){

					#if(MD=="Erasmus") { bacColName="LC.overRate90.AD.BAC.LC"; bacColName.sc = "LCcases.AD.BAC.LC.scr90" }

					bacColName="LC.over90.BAC"; bacColName.sc = "LCcases.BAC.scr90"
					#bacColName="LC.overRate90.BAC"; bacColName.sc = "LCcases.BAC.scr90"

					xx1=100*(dat.f[,"LCcasesOver90"]-dat.f[,bacColName])/(dat.f[,"LCcases.sdet90"]-dat.f[,bacColName.sc])
					median(xx1,na.rm=T)

					median(xx1,na.rm=T)

					xx2=100*(dat.m[,"LCcasesOver90"]-dat.m[,bacColName])/(dat.m[,"LCcases.sdet90"]-dat.m[,bacColName.sc])
					median(xx2,na.rm=T)


							temp=cbind(overdiag=c(xx1,xx2), subtype=c(rep("Female",length(xx1)), rep("Male",length(xx1))))
							md3=c(median(xx1,na.rm=T),median(xx2,na.rm=T))

							#nm2=names(table(overhist[,2]))
							#[1] "AD" "LC" "SC" "SQ

							#md2= md[nm2]
					YLIM=c(2,14)
					if(MD=="FH") YLIM=c(2,30)

							boxplot(as.numeric(temp[,1])~temp[,2],col="red",cex.axis=1.5,cex.lab=1.5,
									ylab="Overdiagnosis Rate (%)", cex.main=2,ylim=YLIM)

							text(1:2,rep(11.8,2), paste(round(md3,1)," %",sep=""), col="blue",cex=2)
							tst3=kruskal.test(as.numeric(temp[,1]), as.factor(temp[,2]))
							pval=tst3$p.value
							title(paste("Gender and Overdiagnosis (W/O BAC)","\nP=", sprintf("%.2e",pval)))

				}#if(MD=="FH"){


					#xx1=100*(dat.f[,"LCcasesOver90"]-dat.f[,"LC.over90.BAC"])/(dat.f[,"LCcases.sdet90"]-dat.f[,"LCcases.BAC.scr90"])
					#xx1=(dat.f[,"LCcasesOver90"])/dat.f[,"LCcases.sdet90"]
					#median(xx1,na.rm=T)

					#xx2=100*(dat.m[,"LCcasesOver90"]-dat.m[,bacColName])/(dat.m[,"LCcases.sdet90"]-dat.m[,bacColName.sc])

		        ######## [6] Overdiagnosis by age ########################################

		        			 ######## overdiagnosis by age group #########

				if(MD!="MCH"){  # michigan does't have htis

							ynames=c("LC.overRate90","LC.overRate.ltn.50","LC.overRate.50_60","LC.overRate.60_70" ,"LC.overRate.70_80" ,"LC.overRate.80_90"  )
							Names=c("Total","<50","50-60","60-70","70-80","80-90")
							#Names=c("Total","<50","50-60","60-70","70-80","80-90")

							tt=(mydat[,ynames])*100
							# > tt[100:105,]
							#     LC.overRate90 LC.overRate.ltn.50 LC.overRate.50_60 LC.overRate.60_70 LC.overRate.70_80
							# 100      12.31066           1.391208          3.909037          8.959345          16.04130
							# 101      13.24246           1.945880          4.223857          9.217533          16.77181
							# 102      12.92942           1.985763          4.316611          8.934959          16.50016
							# 103      12.46264           1.355014          3.868113          8.820971          15.67318
							# 104      13.31968           1.932951          4.168392          9.004807          16.26358
							# 105      13.01402           1.965146          4.234698          8.777498          15.97007
							#     LC.overRate.80_90
							# 100          26.50927
							# 101          27.53929
							# 102          27.36251
							# 103          25.61023
							# 104          26.65733
							# 105          26.49264

							if(MD=="FH" | MD=="MGH"){   tt=mydat[,ynames]  }

							#### combine the last two columns ###
							tm1=tt[,(ncol(tt)-1)] # age 70_80 #[1]       NA 15.18806 15.12040 14.82849 14.77182 14.69848 14.41813 14.31479 14.28500
							tm2=tt[,ncol(tt)]# age_80_90  #[1] NA NA NA NA NA NA NA NA NA NA

							## if anything is NA, just use non-NA value, otherwise, use the mean

							indic1=is.na(tm1)==T
							indic2=is.na(tm2)==T

							## put whatever one non-NA value

							comb=rep(NA,length(tm1))

							comb[indic1==F] = tm1[indic1==F]
							comb[indic2==F] = tm2[indic2==F]

							### impose the last condition, if non of them are NA, then put mean

							comb[indic1==F & indic2==F] = ((tm1+tm2)/2)[indic1==F & indic2==F]
								#cbind(tm1,tm2,comb)[1:100,]
								#             tm1      tm2     comb
								#   [1,]       NA       NA       NA
								#   [2,] 15.18806       NA 15.18806
								#   [3,] 15.12040       NA 15.12040
								#  [48,] 15.08540       NA 15.08540
								#  [49,] 15.20900       NA 15.20900
								#  [50,] 17.26275 24.59893 20.93084
								#  [51,] 17.00413       NA 17.00413
								#  [52,] 16.04130       NA 16.04130
								#  [53,] 16.77181 23.61165 20.19173
								#  [54,] 16.50016       NA 16.50016
								#  [55,] 15.67318       NA 15.67318
								#  [56,] 16.26358 22.45938 19.36148


							tt=cbind(tt[,1:(ncol(tt)-2)],comb);names(tt)[ncol(tt)]="LC.overRate.70_80+"
							# > colnames(tt)
							# [1] "LC.overRate90"      "LC.overRate.ltn.50" "LC.overRate.50_60"  "LC.overRate.60_70"
							# [5] "LC.overRate.70_80+"
						ynames=colnames(tt)
						Names=c("Total","<50","50-60","60-70","70-80+")



							md=NA
							md=apply(tt,2,mean,na.rm=T);md
							#    LC.overRate90 LC.overRate90.ad LC.overRate90.sq LC.overRate90.lg LC.overRate90.sm
							#       0.05025038       0.05551892       0.04456900       0.04500618       0.04654051
							#     Total       <50     50-60     60-70     70-80     80-90
							# 12.087498  1.863670  4.512234  8.907414 15.790528 25.397786

							names(md)=Names
							md

							### boxplot for age groups ##

							overhist=cbind(overdiag=c(tt[,2],tt[,3],tt[,4],tt[,5]), age=c(rep(Names[2],nrow(tt)),rep(Names[3],nrow(tt)), rep(Names[4],nrow(tt)), rep(Names[5],nrow(tt))))
				row.names(overhist)=rep(mydat[,"scenario"],4)
				# > overhist[1:3,]
				# 			  overdiag age
				# A-45-75-10-10 "2.2"    "<50"
				# A-45-75-10-15 "2.1"    "<50"
				# A-45-75-10-20 "2.1"    "<50"
				# >
				# > overhist[row.names(overhist)=="A-45-75-10-10",]
				# 			  overdiag age
				# A-45-75-10-10 "2.2"    "<50"
				# A-45-75-10-10 "4.5"    "50-60"
				# A-45-75-10-10 "7.7"    "60-70"
				# A-45-75-10-10 "11.2"   "70-80+"

							#overhist=cbind(overdiag=c(tt[,2],tt[,3],tt[,4],tt[,5],tt[,6]), age=c(rep(Names[2],nrow(tt)),rep(Names[3],nrow(tt)), rep(Names[4],nrow(tt)), rep(Names[5],nrow(tt)), rep(Names[6],nrow(tt))))
							overhist[1:5,]
							#      overdiag             subtype
							# [1,] "0.0479041916167665" "AD"
							# [2,] "0.0486486486486487" "AD"
							# [3,] "0.0511945392491468" "AD"
							# [4,] "0.049553208773355"  "AD"
							# [5,] "0.0464135021097046" "AD"

							nm2=names(table(overhist[,2]))
							#[1] "AD" "LC" "SC" "SQ

							md2= md[nm2];md2

							boxplot(as.numeric(overhist[,1])~overhist[,2],col="red",cex.axis=1.5,cex.lab=1.5,
									ylab="Overdiagnosis Rate (%)", cex.main=2,ylim=c(2,35))#main=paste(Main0,"Histologic Subtype and Overdiagnosis"),)
							text(1:5,rep(11,5), paste(round(md2,1)," %",sep=""), col="blue",cex=1.5)

							tst=kruskal.test(as.numeric(overhist[,1]), as.factor(overhist[,2]))
							pval=tst$p.value
							title(paste(Main0,"Age (diagnosis) and Overdiagnosis","\nP=", sprintf("%.2e",pval)))


					###### [for making output file] make a matrix by histology ###########
					# > overhist[1:10,]
					#       overdiag     subtype
					#  [1,] NA           "AD.BAC.LC"
					#  [2,] "11.1560448" "AD.BAC.LC"
					#  [3,] "10.8320251" "AD.BAC.LC"
					#  [4,] "10.9157065" "AD.BAC.LC"
					#  [5,] "11.0621714" "AD.BAC.LC"
					#  [6,] "10.714584"  "AD.BAC.LC"


					overAge=cbind(overhist, Model=rep(MD,nrow(overhist)), Gender=rep(gender,nrow(overhist)))
					overAge[1:5,]
					#      overdiag age   Model Gender
					# [1,] NA       "<50" "MGH" "Female"
					# [2,] "32.05"  "<50" "MGH" "Female"
					# [3,] "30.77"  "<50" "MGH" "Female"
					# [4,] "26.89"  "<50" "MGH" "Female"
					# [5,] NA       "<50" "MGH" "Female"

					if(gender=="Female") overAge.f = overAge
					if(gender=="Male") overAge.m=overAge


		}#end if MD!=MCH


				######### [6] USPSTF vs. NLST data extract ################################

				SCN =c("A-55-80-30-15", "A-55-75-30-15", "NoScreen")

				COLNAMES = c( "scenario", ynames.hist,
				"PctEverScreened100",
				"CTscreens90",
				"LCcases90",
				"PctEarlyStage90",
				"MortReduct90",
				"Deaths.avoided90",
				"LCcasesOver90"); COLNAMES

				 indic2 = sc %in% SCN

				 mydat.s = mydat[indic2,COLNAMES]
				 row.names(mydat.s)=mydat.s[,"scenario"]
				 mydat.s=mydat.s[SCN,]


				 savePerOver=mydat.s[,"Deaths.avoided90"]/mydat.s[,"LCcasesOver90"]

				 mydat.s2=cbind(mydat.s, savePerOver=savePerOver)
				 t(mydat.s2)
				 if(gender=="Female")  ans.f = mydat.s2
				 if(gender=="Male") ans.m = mydat.s2


				 ###### [7] Efficient scenarios #############################################

				xname="CTscreens90"
				scname="scenario"
				WRITE=T

				###### (1) efficient scneario using Old Y ###########

				##### ALl scenarios ####

				y=mydat[,"Deaths.avoided90"]/max(mydat[,"Deaths.avoided90"],na.rm=T)
				mydatt=cbind(mydat, death.avoided.percent.90=y)
				yname="death.avoided.percent.90"
				putZero=F
				YLIM=c(0,1)
				#tt1=myUS.plots.big.general(MYDAT,HEAD,xname,yname, sname, WRITE)
				HEAD=Main0

				if(sum(is.na(y))>0) putZero=T   # it's about whether NoScreen has NA or 0
				if(sum(is.na(y))==0) putZero=F
				tt1=myUS.plots.big.general.over(mydatt,HEAD,xname,yname, sname, WRITE=F,putZero,YLIM,scname)

				### save it for male and female ###
				sc1=row.names(tt1[[1]]) #"noscreen"      "T-55-85-40-10" "T-55-85-40-20" "B-60-85-30-20"
				if(gender=="Male") sc1.m=sc1
				if(gender=="Female") sc1.f=sc1

				if(gender=="Male"){

						####### compare it to female scenarios (new-new) ###
						DAT=mydatt
						scns=sc1.f # male
						myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD, putZero, YLIM, IDENTIFY=F,addNo=T,scns,LND="Female Efficient Scenarios",text.cex=0.8)

				}#end of


				##### ONLY ANNUAL scenarios ####

				### extract only annual ##
				mydat.a = mydat[ grep("A-",as.character(mydat[,"scenario"])),]
				y=mydat.a[,"Deaths.avoided90"]/max(mydat.a[,"Deaths.avoided90"],na.rm=T)
				mydatt=cbind(mydat.a, death.avoided.percent.90=y)
				yname="death.avoided.percent.90"
				putZero=F
				YLIM=c(0,1)
				#tt1=myUS.plots.big.general(MYDAT,HEAD,xname,yname, sname, WRITE)
				HEAD=Main0
				HEAD2=paste("Annual Only",HEAD)


				if(sum(is.na(y))>0) putZero=T   # it's about whether NoScreen has NA or 0
				if(sum(is.na(y))==0) putZero=F
				tt1=myUS.plots.big.general.over(mydatt,HEAD2,xname,yname, sname, WRITE=F,putZero,YLIM,scname)

				### save it for male and female ###
				sc1=row.names(tt1[[1]]) #"noscreen"      "T-55-85-40-10" "T-55-85-40-20" "B-60-85-30-20"
				if(gender=="Male") sc1.m.a=sc1
				if(gender=="Female") sc1.f.a=sc1

				if(gender=="Male"){

						####### compare it to female scenarios (new-new) ###
						DAT=mydatt
						scns=sc1.f.a # male
						myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD2, putZero, YLIM, IDENTIFY=F,addNo=T,scns,LND="Female Efficient Scenarios",text.cex=0.8)

				}#end of




				###### (2) efficient scneario using new Y ###########

				### all scenarios ###
				y=mydat[,"Deaths.avoided90"]/mydat[,"LCcasesOver90"]
				mydatt=cbind(mydat, death.avoided.per.over90=y)
				yname="death.avoided.per.over90"
				YLIM=c(0,7)
				if(MD=="MCH") YLIM=c(0,30)
				putZero=T # noScreen Y=0

				tt2=myUS.plots.big.general.over(mydatt,HEAD,xname,yname, sname, WRITE,putZero,YLIM,scname)
				sc2=row.names(tt2[[1]])
				if(gender=="Male") sc2.m=sc2
				if(gender=="Female") sc2.f=sc2

				if(gender=="Male"){

						####### compare it to female scenarios (new-new) ###
						DAT=mydatt
						scns=sc2.f # male
						myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD, putZero, YLIM, IDENTIFY=F,addNo=T,scns,LND="Female Efficient Scenarios",text.cex=0.8)

				}#end of Male


				### only annual scenarios ###
				y=mydat.a[,"Deaths.avoided90"]/mydat.a[,"LCcasesOver90"]
				mydatt=cbind(mydat.a, death.avoided.per.over90=y)
				yname="death.avoided.per.over90"
				YLIM=c(0,7)
				if(MD=="MCH") YLIM=c(0,30)
				putZero=T # noScreen Y=0


				tt2=myUS.plots.big.general.over(mydatt,HEAD2,xname,yname, sname, WRITE,putZero,YLIM,scname)
				sc2=row.names(tt2[[1]])
				if(gender=="Male") sc2.m.a=sc2
				if(gender=="Female") sc2.f.a=sc2

				if(gender=="Male"){

						####### compare it to female scenarios (new-new) ###
						DAT=mydatt
						scns=sc2.f.a # male
						myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD2, putZero, YLIM, IDENTIFY=F,addNo=T,scns,LND="Female Efficient Scenarios",text.cex=0.8)

				}#end of Male




			}# i gender

			ff=t(ans.f)
			mm=t(ans.m)
			colnames(ff)=paste("F",1:ncol(ff),sep="")
			colnames(mm)=paste("M",1:ncol(mm),sep="")

			overHist=rbind(overHist.f, overHist.m)
			overAGE=rbind(overAge.f, overAge.m)

			ans=cbind(ff,mm)
			#ans=list(female=t(ans.f), male=t(ans.m))
			ans2=ans[,c("F3","M3", "F2","M2", "F1","M1")]

			myans = list(USPSTF=ans2, overdiagHist = overHist,overdiagAge=overAGE)
			myans


}#end of myOversiagAnalysis


### [3/5/2014] consensus scenarios algorithm ################
### [2/19/2014] efficient scenarios only on Annual screens + age group combine ##
myOverdiagnosis3 <- function(dat.f, dat.m, MD, histo,thr.con=0.9){  # overdiagnosis analysis by model


			genders=c("Female","Male")#,"Both Gender")

			for( i in 1:length(genders)){

				gender=genders[i]

				Main0=MAIN=paste("[",MD,"-",gender,"] ",sep="");Main0

				if(gender=="Female")  dat1=dat.f
				if(gender=="Male")    dat1=dat.m
				#  [1] "X"                                "NUM"                              "scenario"                         "age.start"
				#  [5] "age.stop"                         "age.interval"                     "py"                               "ysq"
				#  [9] "n.total"                          "n.entry.all"                      "n.case"                           "LCcases.noscreen100"
				# [13] "LCdeaths.noscreen100"             "PercentScreened100"               "AverageScreen100"                 "CTscreens100"
				# [17] "CTexams100"                       "PctEarlyStage100"                 "LCcases100"                       "LCcases.sdet100"
				# [21] "LCcases.sdet.eff100"              "LCdeaths100"                      "LCcasesOver100"                   "Deaths.avoided100"
				# [25] "LifeYearsSaved100"                "MortReduct100"                    "AlldeathsCase100"                 "AlldeathsNoncases100"
				# [29] "Ratio.case.scrdet.per.CT100"      "Rario.deaths.avoided_case.scr100" "LCcases.noscreen90"               "LCdeaths.noscreen90"
				# [33] "CTscreens90"                      "CTexams90"                        "PctEarlyStage90"                  "LCcases90"
				# [37] "LCcases.sdet90"                   "LCcasesOver90"                    "LC.overRate90"                    "LC.overRate90.ad"
				# [41] "LC.overRate90.sq"                 "LC.overRate90.lg"                 "LC.overRate90.sm"                 "LCdeaths90"
				# [45] "Deaths.avoided90"                 "LifeYearsSaved90"                 "MortReduct90"                     "Alldeaths90"
				# [49] "Alldeaths.case.noncase90"         "prop.cdet.90"                     "LCdeathsSurgery_overDiag90"       "LCdeathsSurgery_sdet90"
				# [53] "AlldeathsSurgery90"               "AlldeathsSurgery_noscreen90"      "CTscreens90_abs"                  "CTexams90_abs"
				# [57] "LCcases90_abs"                    "LCdeaths90_abs"

				# > colnames(dat1)
				#  [1] "Freq.Start.Stop.PY.YSQ"     "PctEverScreened100"         "CTscreens100"
				#  [4] "CTscreens90"                "CTexams90"                  "LCcases90"
				#  [7] "PctEarlyStage90"            "LCdeaths90"                 "Alldeaths90"
				# [10] "LcdeathsSurgery_overDiag90" "Deaths.avoided90"           "LifeYearsSaved90"
				# [13] "MortReduct90"               "LCcases.sdet90"             "LCcasesOver90"
				# [16] "LCcases.BAC90"              "LCcases.BAC.scr90"          "LC.over90.BAC"
				# [19] "LCcases.AD90"               "LCcases.AD.scr90"           "LC.over90.AD"
				# [22] "LCcases.SQ90"               "LCcases.SQ.scr90"           "LC.over90.SQ"
				# [25] "LCcases.LC90"               "LCcases.LC.scr90"           "LC.over90.LC"
				# [28] "LCcases.SC90"               "LCcases.SC.scr90"           "LC.over90.SC"
				# [31] "LCcases.NSCO90"             "LCcases.NSCO.scr90"         "LC.over90.NSCO"
				# [34] "LCcases.NSCO2.90"           "LCcases.NSCO2.scr90"        "LC.over90.NSCO2"
				# [37] "LCcases.AD.BAC.LC.90"       "LCcases.AD.BAC.LC.scr90"    "LC.over90.AD.BAC.LC"
				# [40] "LCcases.AD.BAC.90"          "LCcases.AD.BAC.scr90"       "LC.over90.AD.BAC"
				# [43] "LCcases.ltn.50"             "LCcases.ltn50.scr"          "LC.over.ltn50"
				# [46] "LCcases.50_60"              "LCcases.50_60.scr"          "LC.over.50_60"
				# [49] "LCcases.60_70"              "LCcases.60_70.scr"          "LC.over.60_70"
				# [52] "LCcases.70_80"              "LCcases.70_80.scr"          "LC.over.70_80"
				# [55] "LCcases.80_90"              "LCcases.80_90.scr"          "LC.over.80_90"
				# [58] "LC.overRate90"              "LC.overRate90.bac"          "LC.overRate90.ad"
				# [61] "LC.overRate90.sq"           "LC.overRate90.lg"           "LC.overRate90.sm"
				# [64] "LC.overRate.NSCO90"         "LC.overRate.NSCO2.90"       "LC.overRate.AD.BAC.LC90"
				# [67] "LC.overRate.AD.BAC90"       "LC.overRate.ltn.50"         "LC.overRate.50_60"
				# [70] "LC.overRate.60_70"          "LC.overRate.70_80"          "LC.overRate.80_90"

				mean(dat1[,"LC.overRate90"],na.rm=T)
				#mean(dat1[,"LC.overRate90.bac"],na.rm=T)
				#mean(dat1[,"LC.overRate90.ad"],na.rm=T)
				mean(dat1[,"MortReduct90"],na.rm=T)

				# mean(dat1[,"LC.overRate90"],na.rm=T)  # Erasmus
				# [1] 0.1207433
				# mean(dat1[,"MortReduct90"],na.rm=T)
				# [1] 0.1457651

				# > mean(dat1[,"LC.overRate90"],na.rm=T)  # FH
				# [1] 19.6168
				# >mean(dat1[,"MortReduct90"],na.rm=T)
				# [1] 29.61986



				########### change the column name "Freq-Start-Stop..." to "scenario" ####
				mydat0=dat1
				colnames(mydat0)[grep("Freq",colnames(mydat0))]="scenario"

				### exclude:
				#A-55-57-30-15
				#A-62-64-30-15


				########### [1] take out two small scenarios ####################

				indic = as.character(mydat0[,"scenario"])  %in% c("A-55-57-30-15","A-62-64-30-15")
				sum(indic)
				mydat=mydat0[!indic,]
				dim(mydat)

				### make start, stop, py and ysq variables ###
				sc=as.character(mydat[,"scenario"])
				sc[1:10]
				#  [1] "NoScreen"      "A-45-75-10-10" "B-45-75-10-10" "T-45-75-10-10" "A-45-75-10-15"
				#  [6] "B-45-75-10-15" "T-45-75-10-15" "A-45-75-10-20" "B-45-75-10-20" "T-45-75-10-20"

				### change "NoScreen" to "NA-NA-NA-NA-NA" format

				sc2=gsub("NoScreen","NA-NA-NA-NA-NA",sc)
				tm1=unlist(strsplit(sc2,split="-"))

				freq = tm1[seq(1,length(tm1), by=5)] ; freq[freq=="NA"]=NA
				age.start = tm1[seq(2,length(tm1), by=5)];  age.start[age.start=="NA"]=NA
				age.stop = tm1[seq(3,length(tm1), by=5)]; age.stop[age.stop=="NA"]=NA
				PY = tm1[seq(4,length(tm1), by=5)]; PY[PY=="NA"]=NA
				YSQ = tm1[seq(5,length(tm1), by=5)]; YSQ[YSQ=="NA"]=NA

				mydat=data.frame(mydat,age.interval=freq, age.start=age.start, age.stop=age.stop, py=PY, ysq=YSQ)



				################ [2] Histogram of overdiagnosis rate variable (ALL SUBTYPE) ##################

				y=mydat[,"LC.overRate90"]*100   # of overdiag / # of screen detected
				if(MD=="FH" | MD=="MGH") y=mydat[,"LC.overRate90"]

				#y=mydat[,"LC.overRate90.ad"]*100
				#y=mydat[,"LC.overRate90"]*100
				#y=mydat[,"LC.overRate90"]*100

				range(y,na.rm=T)
				#[1]  8.768742 15.656788

				#range(x)
				md=mean(y,na.rm=T);md

				hist(y,nclass=10,col="red",main=paste(Main0, "\n Overdiagnosis Rate ","(mean=",round(md,2),"%)",sep=""),freq=F, cex.main=1.5,cex.lab=1.5, cex.axis=1.5, xlab="Overdiagnosis Rate (%)")

						#    LC.overRate90 LC.overRate90.ad LC.overRate90.sq LC.overRate90.lg LC.overRate90.sm
						#       0.05025038       0.05551892       0.04456900       0.04500618       0.04654051


				##############  [3] boxplots of overdiagnosis related variable ###


				#mycolnames=c("Overdiag","CTscreens90","PctEarlyStage90","PercentScreened100","MortReduct90","LCdeaths90","Deaths.avoided90",
				#			"LifeYearsSaved90","LCdeathsSurgery_overDiag90","age.interval","age.start","age.stop","py","ysq","start.stop","start.stop2")
				#varfeatures=c(rep("con",8), rep("cat",8))

				mycolnames=c("Overdiag",
							"CTscreens90","PctEarlyStage90","MortReduct90","LCdeaths90","Deaths.avoided90","LifeYearsSaved90",
							"age.interval","age.start","age.stop","py","ysq","start.stop","start.stop2")
				varfeatures=c(rep("con",7), rep("cat",7))


				########## age.stop and age.start combination: high risk ##############

				 x1=mydat[,"age.start"]
				 x2=mydat[,"age.stop"]
			  table(x1)
				# x1
				#  45  50  55  60
				# 144 144 144 144
				# > table(x2)
				# x2
				#  75  80  85
				# 192 192 192

				start_stop=paste(x1,x2,sep="-")
				# > table(ag)
				# ag
				# 45-75 45-80 45-85 50-75 50-80 50-85 55-75 55-80 55-85 60-75 60-80 60-85 NA-NA
				#    48    48    48    48    48    48    48    48    48    48    48    48     1
				start_stop = gsub("NA",NA,start_stop)
				start_stop2=start_stop
				start_stop2[!(start_stop2 %in% c("45-75","60-85"))]=NA


				DATA=cbind(Overdiag=y, mydat,start.stop=start_stop,start.stop2=start_stop2)
				#varfeatures=c(rep("con",8), rep("cat",8))

				#varfeatures=c("cat","cat","cat","b","b","cat","con","con","con","b","con")
				x1name="Overdiag"
				x2names=mycolnames

				par("mar"=c(5,5,4,2))
				YLIM=c(1,18)
				if(MD=="FH") YLIM=c(5,35)
				myInvestigate.variable3(x1name,x2names,DATA,varfeatures,YLIM,MAIN)


				######### [4] histology specific overdiagnosis ############################

				# > histo
				# [1] "AD.BAC.LC" "SQ"        "SC"        "NSCO"

				ynames = ynames.hist = c("LC.overRate90", paste("LC.overRate90",histo,sep="."))
				Names=c("All Subtypes", histo)
				ynames
				Names

				# > ynames
				# [1] "LC.overRate90"           "LC.overRate90.AD.BAC.LC" "LC.overRate90.SQ"
				# [4] "LC.overRate90.SC"        "LC.overRate90.NSCO"
				# > Names
				# [1] "All Subtypes" "AD.BAC.LC"    "SQ"           "SC"           "NSCO"

				#ynames=c("LC.overRate90","LC.overRate90.bac","LC.overRate90.ad","LC.overRate90.sq" ,"LC.overRate90.lg"  ,"LC.overRate90.sm"  )
				#Names=c("All Subtype","BAC","AD","SQ","LC","SC")

				tt=mydat[,ynames]*100
				if(MD=="FH" | MD=="MGH") tt=mydat[,ynames]
				# > colnames(tt)
				# [1] "LC.overRate90"           "LC.overRate90.AD.BAC.LC" "LC.overRate90.SQ"
				# [4] "LC.overRate90.SC"        "LC.overRate90.NSCO"

				md=apply(tt,2,mean,na.rm=T);md
				#    LC.overRate90 LC.overRate90.ad LC.overRate90.sq LC.overRate90.lg LC.overRate90.sm
				#       0.05025038       0.05551892       0.04456900       0.04500618       0.04654051
				#names(md)=c("ALL","BAC","AD","SQ","LC","SC")
				names(md)=Names

				### Make a long type data boxplot for subtypes (except for all) ##
				#   LC.overRate90 LC.overRate90.AD.BAC.LC LC.overRate90.SQ LC.overRate90.SC
				# 1            NA                      NA               NA               NA
				# 2      9.783653                11.15604         8.763505         3.513957
				# 3      9.623033                10.83203         8.573370         3.305991
				# 4      9.612586                10.91571         7.984921         3.248974
				# 5      9.716076                11.06217         8.773393         3.546635
				overdiag=as.vector(unlist(tt[,-1]))
				# > overdiag[1:5]
				# [1]       NA 11.15604 10.83203 10.91571 11.06217
				subtype=rep(histo,each=nrow(tt))

				overhist=cbind(overdiag=overdiag, subtype=subtype)
				# > overhist[1:10,]
				#       overdiag     subtype
				#  [1,] NA           "AD.BAC.LC"
				#  [2,] "11.1560448" "AD.BAC.LC"
				#  [3,] "10.8320251" "AD.BAC.LC"
				#  [4,] "10.9157065" "AD.BAC.LC"
				#  [5,] "11.0621714" "AD.BAC.LC"

				#overhist=cbind(overdiag=c(tt[,2],tt[,3],tt[,4],tt[,5],tt[,6]), subtype=c(rep("BAC",nrow(tt)),rep("AD",nrow(tt)), rep("SQ",nrow(tt)), rep("LC",nrow(tt)), rep("SC",nrow(tt))))

				overhist[1:5,]
				#      overdiag             subtype
				# [1,] "0.0479041916167665" "AD"
				# [2,] "0.0486486486486487" "AD"
				# [3,] "0.0511945392491468" "AD"
				# [4,] "0.049553208773355"  "AD"
				# [5,] "0.0464135021097046" "AD"

				### order can change depending on boxplot
				nm2=names(table(overhist[,2]));nm2
				#[1] "AD" "LC" "SC" "SQ

				md2= md[nm2]; md2

				YLIM=c(2,22)
				if(MD=="FH") YLIM=c(2,60)

				boxplot(as.numeric(overhist[,1])~overhist[,2],col="red",cex.axis=1.2,cex.lab=1.5,
						ylab="Overdiagnosis Rate (%)", cex.main=2,ylim=YLIM)#main=paste(Main0,"Histologic Subtype and Overdiagnosis"),)
				text(1:length(md2),rep(11,length(md2)), paste(round(md2,1)," %",sep=""), col="blue",cex=1.5)

				tst=kruskal.test(as.numeric(overhist[,1]), as.factor(overhist[,2]))
				pval=tst$p.value
				title(paste(Main0,"Histologic Subtype and Overdiagnosis","\nP=", sprintf("%.2e",pval)))

		###### [for making output file] make a matrix by histology ###########
		# > overhist[1:10,]
		#       overdiag     subtype
		#  [1,] NA           "AD.BAC.LC"
		#  [2,] "11.1560448" "AD.BAC.LC"
		#  [3,] "10.8320251" "AD.BAC.LC"
		#  [4,] "10.9157065" "AD.BAC.LC"
		#  [5,] "11.0621714" "AD.BAC.LC"
		#  [6,] "10.714584"  "AD.BAC.LC"

		overall = cbind(overdiag=y, subtype="Overall")
		overHist = rbind(overall,overhist)
		overHist=cbind(overHist, Model=rep(MD,nrow(overHist)), Gender=rep(gender,nrow(overHist)))
		overHist[1:5,]
		#      overdiag           subtype   Model
		# [1,] "NaN"              "Overall" "Erasmus"
		# [2,] "4.52351190393053" "Overall" "Erasmus"
		# [3,] "4.30015522025795" "Overall" "Erasmus"
		# [4,] "4.11305581879205" "Overall" "Erasmus"
		# [5,] "4.56229235891468" "Overall" "Erasmus"

		table(overHist[,2])
		# AD.BAC.LC      NSCO   Overall        SC        SQ
		#       577       577       577       577       577
		if(gender=="Female") overHist.f = overHist
		if(gender=="Male") overHist.m=overHist



				if(MD=="Stanford"){

					### four histology only ##

					indic=overhist[,"subtype"]!="BAC"
					overhist2=overhist[indic,]
					nm2=names(table(overhist2[,2]));nm2
					overhist2=data.frame(overhist2)
					overhist2[,1]=as.numeric(as.character(overhist2[,1]))
					tt=aggregate(overdiag~subtype,data=overhist2,mean,na.rm=T)
					md2=tt[,2]

					#md2=md[names(md)!="BAC"][-1]
					#md2
					#      ALL       AD       SQ       LC       SC
					# 8.715972 8.913715 6.887847 8.112153 5.444792
					#nm2=names(md2)

					boxplot(as.numeric(overhist2[,1])~overhist2[,2],col="red",cex.axis=1.5,cex.lab=1.5,
							ylab="Overdiagnosis Rate (%)", cex.main=2,ylim=c(2,20))#main=paste(Main0,"Histologic Subtype and Overdiagnosis"),)
					text(1:4,rep(11,4), paste(round(md2,1)," %",sep=""), col="blue",cex=1.5)

					tst2=kruskal.test(as.numeric(overhist2[,1]), as.factor(overhist2[,2]))
					pval=tst2$p.value
					title(paste(Main0,"Histologic Subtype and Overdiagnosis","\nP=", sprintf("%.2e",pval)))

				}#


				########### [5] gender comparison boxplot ##############################

				xx1=dat.f[!indic, "LC.overRate90"]*100
				xx2=dat.m[!indic, "LC.overRate90"]*100

				if(MD=="FH" | MD=="MGH"){

					xx1=dat.f[!indic, "LC.overRate90"]
					xx2=dat.m[!indic, "LC.overRate90"]

				}
				#xx1=read.csv(file1)[!indic,"LC.overRate90"]*100
				#xx2=read.csv(file2)[!indic,"LC.overRate90"]*100

				temp=cbind(overdiag=c(xx1,xx2), subtype=c(rep("Female",length(xx1)), rep("Male",length(xx1))))
				md3=c(median(xx1,na.rm=T),median(xx2,na.rm=T));md3
				#[1] 12.04536 11.90070
				#nm2=names(table(overhist[,2]))
				#[1] "AD" "LC" "SC" "SQ

				#md2= md[nm2]

				YLIM=c(2,14)
				if(MD=="FH") YLIM=c(2,25)

				boxplot(as.numeric(temp[,1])~temp[,2],col="red",cex.axis=1.5,cex.lab=1.5,
						ylab="Overdiagnosis Rate (%)", cex.main=2,ylim=YLIM)

				text(1:2,rep(11.8,2), paste(round(md3,1)," %",sep=""), col="blue",cex=2)
				tst3=kruskal.test(as.numeric(temp[,1]), as.factor(temp[,2]))
				pval=tst3$p.value
				title(paste("[",MD,"]","Gender and Overdiagnosis","\nP=", sprintf("%.3f",pval)))



				#### gender comparison without BAC ######

				if(MD=="FH" | MD=="MGH" | MD=="Stanford"){

					#if(MD=="Erasmus") { bacColName="LC.overRate90.AD.BAC.LC"; bacColName.sc = "LCcases.AD.BAC.LC.scr90" }

					bacColName="LC.over90.BAC"; bacColName.sc = "LCcases.BAC.scr90"
					#bacColName="LC.overRate90.BAC"; bacColName.sc = "LCcases.BAC.scr90"

					xx1=100*(dat.f[,"LCcasesOver90"]-dat.f[,bacColName])/(dat.f[,"LCcases.sdet90"]-dat.f[,bacColName.sc])
					median(xx1,na.rm=T)

					median(xx1,na.rm=T)

					xx2=100*(dat.m[,"LCcasesOver90"]-dat.m[,bacColName])/(dat.m[,"LCcases.sdet90"]-dat.m[,bacColName.sc])
					median(xx2,na.rm=T)


							temp=cbind(overdiag=c(xx1,xx2), subtype=c(rep("Female",length(xx1)), rep("Male",length(xx1))))
							md3=c(median(xx1,na.rm=T),median(xx2,na.rm=T))

							#nm2=names(table(overhist[,2]))
							#[1] "AD" "LC" "SC" "SQ

							#md2= md[nm2]
					YLIM=c(2,14)
					if(MD=="FH") YLIM=c(2,30)

							boxplot(as.numeric(temp[,1])~temp[,2],col="red",cex.axis=1.5,cex.lab=1.5,
									ylab="Overdiagnosis Rate (%)", cex.main=2,ylim=YLIM)

							text(1:2,rep(11.8,2), paste(round(md3,1)," %",sep=""), col="blue",cex=2)
							tst3=kruskal.test(as.numeric(temp[,1]), as.factor(temp[,2]))
							pval=tst3$p.value
							title(paste("Gender and Overdiagnosis (W/O BAC)","\nP=", sprintf("%.2e",pval)))

				}#if(MD=="FH"){


					#xx1=100*(dat.f[,"LCcasesOver90"]-dat.f[,"LC.over90.BAC"])/(dat.f[,"LCcases.sdet90"]-dat.f[,"LCcases.BAC.scr90"])
					#xx1=(dat.f[,"LCcasesOver90"])/dat.f[,"LCcases.sdet90"]
					#median(xx1,na.rm=T)

					#xx2=100*(dat.m[,"LCcasesOver90"]-dat.m[,bacColName])/(dat.m[,"LCcases.sdet90"]-dat.m[,bacColName.sc])

		        ######## [6] Overdiagnosis by age ########################################

		        			 ######## overdiagnosis by age group #########

				ynames=c("LC.overRate90","LC.overRate.ltn.50","LC.overRate.50_60","LC.overRate.60_70" ,"LC.overRate.70_80" ,"LC.overRate.80_90"  )
				Names=c("Total","<50","50-60","60-70","70-80","80-90")
				#Names=c("Total","<50","50-60","60-70","70-80","80-90")

				tt=(mydat[,ynames])*100
				# > tt[100:105,]
				#     LC.overRate90 LC.overRate.ltn.50 LC.overRate.50_60 LC.overRate.60_70 LC.overRate.70_80
				# 100      12.31066           1.391208          3.909037          8.959345          16.04130
				# 101      13.24246           1.945880          4.223857          9.217533          16.77181
				# 102      12.92942           1.985763          4.316611          8.934959          16.50016
				# 103      12.46264           1.355014          3.868113          8.820971          15.67318
				# 104      13.31968           1.932951          4.168392          9.004807          16.26358
				# 105      13.01402           1.965146          4.234698          8.777498          15.97007
				#     LC.overRate.80_90
				# 100          26.50927
				# 101          27.53929
				# 102          27.36251
				# 103          25.61023
				# 104          26.65733
				# 105          26.49264

				if(MD=="FH" | MD=="MGH"){   tt=mydat[,ynames]  }

				#### combine the last two columns ###
				tm1=tt[,(ncol(tt)-1)] # age 70_80 #[1]       NA 15.18806 15.12040 14.82849 14.77182 14.69848 14.41813 14.31479 14.28500
				tm2=tt[,ncol(tt)]# age_80_90  #[1] NA NA NA NA NA NA NA NA NA NA

				## if anything is NA, just use non-NA value, otherwise, use the mean

				indic1=is.na(tm1)==T
				indic2=is.na(tm2)==T

				## put whatever one non-NA value

				comb=rep(NA,length(tm1))

			    comb[indic1==F] = tm1[indic1==F]
			    comb[indic2==F] = tm2[indic2==F]

			    ### impose the last condition, if non of them are NA, then put mean

			    comb[indic1==F & indic2==F] = ((tm1+tm2)/2)[indic1==F & indic2==F]
					#cbind(tm1,tm2,comb)[1:100,]
					#             tm1      tm2     comb
					#   [1,]       NA       NA       NA
					#   [2,] 15.18806       NA 15.18806
					#   [3,] 15.12040       NA 15.12040
					#  [48,] 15.08540       NA 15.08540
					#  [49,] 15.20900       NA 15.20900
					#  [50,] 17.26275 24.59893 20.93084
					#  [51,] 17.00413       NA 17.00413
					#  [52,] 16.04130       NA 16.04130
					#  [53,] 16.77181 23.61165 20.19173
					#  [54,] 16.50016       NA 16.50016
					#  [55,] 15.67318       NA 15.67318
					#  [56,] 16.26358 22.45938 19.36148


				tt=cbind(tt[,1:(ncol(tt)-2)],comb);names(tt)[ncol(tt)]="LC.overRate.70_80+"
				# > colnames(tt)
				# [1] "LC.overRate90"      "LC.overRate.ltn.50" "LC.overRate.50_60"  "LC.overRate.60_70"
				# [5] "LC.overRate.70_80+"
			ynames=colnames(tt)
			Names=c("Total","<50","50-60","60-70","70-80+")



				md=NA
				md=apply(tt,2,mean,na.rm=T);md
				#    LC.overRate90 LC.overRate90.ad LC.overRate90.sq LC.overRate90.lg LC.overRate90.sm
				#       0.05025038       0.05551892       0.04456900       0.04500618       0.04654051
				#     Total       <50     50-60     60-70     70-80     80-90
				# 12.087498  1.863670  4.512234  8.907414 15.790528 25.397786

				names(md)=Names
				md

				### boxplot for age groups ##

				overhist=cbind(overdiag=c(tt[,2],tt[,3],tt[,4],tt[,5]), age=c(rep(Names[2],nrow(tt)),rep(Names[3],nrow(tt)), rep(Names[4],nrow(tt)), rep(Names[5],nrow(tt))))

				#overhist=cbind(overdiag=c(tt[,2],tt[,3],tt[,4],tt[,5],tt[,6]), age=c(rep(Names[2],nrow(tt)),rep(Names[3],nrow(tt)), rep(Names[4],nrow(tt)), rep(Names[5],nrow(tt)), rep(Names[6],nrow(tt))))
				overhist[1:5,]
				#      overdiag             subtype
				# [1,] "0.0479041916167665" "AD"
				# [2,] "0.0486486486486487" "AD"
				# [3,] "0.0511945392491468" "AD"
				# [4,] "0.049553208773355"  "AD"
				# [5,] "0.0464135021097046" "AD"

				nm2=names(table(overhist[,2]))
				#[1] "AD" "LC" "SC" "SQ

				md2= md[nm2];md2

				boxplot(as.numeric(overhist[,1])~overhist[,2],col="red",cex.axis=1.5,cex.lab=1.5,
						ylab="Overdiagnosis Rate (%)", cex.main=2,ylim=c(2,35))#main=paste(Main0,"Histologic Subtype and Overdiagnosis"),)
				text(1:5,rep(11,5), paste(round(md2,1)," %",sep=""), col="blue",cex=1.5)

				tst=kruskal.test(as.numeric(overhist[,1]), as.factor(overhist[,2]))
				pval=tst$p.value
				title(paste(Main0,"Age (diagnosis) and Overdiagnosis","\nP=", sprintf("%.2e",pval)))


		###### [for making output file] make a matrix by histology ###########
		# > overhist[1:10,]
		#       overdiag     subtype
		#  [1,] NA           "AD.BAC.LC"
		#  [2,] "11.1560448" "AD.BAC.LC"
		#  [3,] "10.8320251" "AD.BAC.LC"
		#  [4,] "10.9157065" "AD.BAC.LC"
		#  [5,] "11.0621714" "AD.BAC.LC"
		#  [6,] "10.714584"  "AD.BAC.LC"


		overAge=cbind(overhist, Model=rep(MD,nrow(overhist)), Gender=rep(gender,nrow(overhist)))
		overAge[1:5,]
		#      overdiag age   Model Gender
		# [1,] NA       "<50" "MGH" "Female"
		# [2,] "32.05"  "<50" "MGH" "Female"
		# [3,] "30.77"  "<50" "MGH" "Female"
		# [4,] "26.89"  "<50" "MGH" "Female"
		# [5,] NA       "<50" "MGH" "Female"

		if(gender=="Female") overAge.f = overAge
		if(gender=="Male") overAge.m=overAge


				######### [6] USPSTF vs. NLST data extract ################################

				SCN =c("A-55-80-30-15", "A-55-75-30-15", "NoScreen")

				COLNAMES = c( "scenario", ynames.hist,
				"PctEverScreened100",
				"CTscreens90",
				"LCcases90",
				"PctEarlyStage90",
				"MortReduct90",
				"Deaths.avoided90",
				"LCcasesOver90"); COLNAMES

				 indic2 = sc %in% SCN

				 mydat.s = mydat[indic2,COLNAMES]
				 row.names(mydat.s)=mydat.s[,"scenario"]
				 mydat.s=mydat.s[SCN,]


				 savePerOver=mydat.s[,"Deaths.avoided90"]/mydat.s[,"LCcasesOver90"]

				 mydat.s2=cbind(mydat.s, savePerOver=savePerOver)
				 t(mydat.s2)
				 if(gender=="Female")  ans.f = mydat.s2
				 if(gender=="Male") ans.m = mydat.s2


				 ###### [7] Efficient scenarios #############################################

				xname="CTscreens90"
				scname="scenario"
				WRITE=T

				###### (1) efficient scneario using Old Y ###########

				##### ALl scenarios ####

				y=mydat[,"Deaths.avoided90"]/max(mydat[,"Deaths.avoided90"],na.rm=T)
				mydatt=cbind(mydat, death.avoided.percent.90=y)
				yname="death.avoided.percent.90"
				putZero=F
				YLIM=c(0,1)
				#tt1=myUS.plots.big.general(MYDAT,HEAD,xname,yname, sname, WRITE)
				HEAD=Main0

				if(sum(is.na(y))>0) putZero=T   # it's about whether NoScreen has NA or 0
				if(sum(is.na(y))==0) putZero=F
				tt1=myUS.plots.big.general.over2(mydatt,HEAD,xname,yname, sname, WRITE=F,putZero,YLIM,thr.con,scname)



				### save it for male and female ###
				sc1=row.names(tt1[[1]]) #"noscreen"      "T-55-85-40-10" "T-55-85-40-20" "B-60-85-30-20"
				sc90 = tt1$scn90
				if(gender=="Male") { sc1.m=sc1 ; sc90.1m = sc90  }
				if(gender=="Female") { sc1.f=sc1 ; ; sc90.1f = sc90  }

				if(gender=="Male"){

						####### compare it to female scenarios (new-new) ###
						DAT=mydatt
						scns=sc1.f # male
						myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD, putZero, YLIM, IDENTIFY=F,addNo=T,scns,LND="Female Efficient Scenarios",text.cex=0.8)

				}#end of


				######### ONLY ANNUAL scenarios ########
				### extract only annual ##
				mydat.a = mydat[ grep("A-",as.character(mydat[,"scenario"])),]
				y=mydat.a[,"Deaths.avoided90"]/max(mydat.a[,"Deaths.avoided90"],na.rm=T)
				mydatt=cbind(mydat.a, death.avoided.percent.90=y)
				yname="death.avoided.percent.90"
				putZero=F
				YLIM=c(0,1)
				#tt1=myUS.plots.big.general(MYDAT,HEAD,xname,yname, sname, WRITE)
				HEAD=Main0
				HEAD2=paste("Annual Only",HEAD)


				if(sum(is.na(y))>0) putZero=T   # it's about whether NoScreen has NA or 0
				if(sum(is.na(y))==0) putZero=F
				tt1=myUS.plots.big.general.over2(mydatt,HEAD2,xname,yname, sname, WRITE=F,putZero,YLIM,thr.con,scname)

				### save it for male and female ###
				sc1=row.names(tt1[[1]]) #"noscreen"      "T-55-85-40-10" "T-55-85-40-20" "B-60-85-30-20"
				sc90 = tt1$scn90
				if(gender=="Male") { sc1.m.a=sc1 ; sc90.1m.a = sc90 }
				if(gender=="Female") {sc1.f.a=sc1; ; sc90.1f.a = sc90}

				if(gender=="Male"){

						####### compare it to female scenarios (new-new) ###
						DAT=mydatt
						scns=sc1.f.a # male
						myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD2, putZero, YLIM, IDENTIFY=F,addNo=T,scns,LND="Female Efficient Scenarios",text.cex=0.8)

				}#end of




				###### (2) efficient scneario using new Y ###########

				### all scenarios ###
				y=mydat[,"Deaths.avoided90"]/mydat[,"LCcasesOver90"]
				mydatt=cbind(mydat, death.avoided.per.over90=y)
				yname="death.avoided.per.over90"
				YLIM=c(0,7)
				putZero=T # noScreen Y=0

				tt2=myUS.plots.big.general.over2(mydatt,HEAD,xname,yname, sname, WRITE,putZero,YLIM,thr.con,scname)
				sc2=row.names(tt2[[1]])
				sc90 = tt2$scn90

				if(gender=="Male") { sc2.m=sc2 ;  sc90.2m = sc90 }
				if(gender=="Female"){ sc2.f=sc2 ; sc90.2f = sc90 }

				if(gender=="Male"){

						####### compare it to female scenarios (new-new) ###
						DAT=mydatt
						scns=sc2.f # male
						myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD, putZero, YLIM, IDENTIFY=F,addNo=T,scns,LND="Female Efficient Scenarios",text.cex=0.8)

				}#end of Male


				### only annual scenarios ###
				y=mydat.a[,"Deaths.avoided90"]/mydat.a[,"LCcasesOver90"]
				mydatt=cbind(mydat.a, death.avoided.per.over90=y)
				yname="death.avoided.per.over90"
				YLIM=c(0,7)
				putZero=T # noScreen Y=0


				tt2=myUS.plots.big.general.over2(mydatt,HEAD2,xname,yname, sname, WRITE,putZero,YLIM, thr.con, scname)
				sc2=row.names(tt2[[1]])
				sc90 = tt2$scn90
				if(gender=="Male") { sc2.m.a=sc2 ; sc90.2m.a = sc90 }
				if(gender=="Female") {sc2.f.a=sc2; ; sc90.2f.a = sc90}


				if(gender=="Male"){

						####### compare it to female scenarios (new-new) ###
						DAT=mydatt
						scns=sc2.f.a # male
						myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD2, putZero, YLIM, IDENTIFY=F,addNo=T,scns,LND="Female Efficient Scenarios",text.cex=0.8)

				}#end of Male




			}# i gender

			ff=t(ans.f)
			mm=t(ans.m)
			colnames(ff)=paste("F",1:ncol(ff),sep="")
			colnames(mm)=paste("M",1:ncol(mm),sep="")

			overHist=rbind(overHist.f, overHist.m)
			overAGE=rbind(overAge.f, overAge.m)

			ans=cbind(ff,mm)
			#ans=list(female=t(ans.f), male=t(ans.m))
			ans2=ans[,c("F3","M3", "F2","M2", "F1","M1")]



			myans = list(USPSTF=ans2, overdiagHist = overHist,overdiagAge=overAGE,
						sc90.f = sc90.2f, sc90.m = sc90.2m,  sc90.f.a = sc90.2f.a, sc90.m.a = sc90.2m.a)  ### 90% scenarios are for new Y ###
			myans


}#end of myOversiagAnalysis




### [3/5/2014] consensus scenarios algorithm ################
### [2/19/2014] efficient scenarios only on Annual screens + age group combine ##
get90 <- function(dat.f, dat.m, MD, histo,thr.con=0.9){  # overdiagnosis analysis by model


			genders=c("Female","Male")#,"Both Gender")

			for( i in 1:length(genders)){

				gender=genders[i]

				Main0=MAIN=paste("[",MD,"-",gender,"] ",sep="");Main0

				if(gender=="Female")  dat1=dat.f
				if(gender=="Male")    dat1=dat.m
				#  [1] "X"                                "NUM"                              "scenario"                         "age.start"
				#  [5] "age.stop"                         "age.interval"                     "py"                               "ysq"
				#  [9] "n.total"                          "n.entry.all"                      "n.case"                           "LCcases.noscreen100"
				# [13] "LCdeaths.noscreen100"             "PercentScreened100"               "AverageScreen100"                 "CTscreens100"
				# [17] "CTexams100"                       "PctEarlyStage100"                 "LCcases100"                       "LCcases.sdet100"
				# [21] "LCcases.sdet.eff100"              "LCdeaths100"                      "LCcasesOver100"                   "Deaths.avoided100"
				# [25] "LifeYearsSaved100"                "MortReduct100"                    "AlldeathsCase100"                 "AlldeathsNoncases100"
				# [29] "Ratio.case.scrdet.per.CT100"      "Rario.deaths.avoided_case.scr100" "LCcases.noscreen90"               "LCdeaths.noscreen90"
				# [33] "CTscreens90"                      "CTexams90"                        "PctEarlyStage90"                  "LCcases90"
				# [37] "LCcases.sdet90"                   "LCcasesOver90"                    "LC.overRate90"                    "LC.overRate90.ad"
				# [41] "LC.overRate90.sq"                 "LC.overRate90.lg"                 "LC.overRate90.sm"                 "LCdeaths90"
				# [45] "Deaths.avoided90"                 "LifeYearsSaved90"                 "MortReduct90"                     "Alldeaths90"
				# [49] "Alldeaths.case.noncase90"         "prop.cdet.90"                     "LCdeathsSurgery_overDiag90"       "LCdeathsSurgery_sdet90"
				# [53] "AlldeathsSurgery90"               "AlldeathsSurgery_noscreen90"      "CTscreens90_abs"                  "CTexams90_abs"
				# [57] "LCcases90_abs"                    "LCdeaths90_abs"


				mean(dat1[,"LC.overRate90"],na.rm=T)
				#mean(dat1[,"LC.overRate90.bac"],na.rm=T)
				#mean(dat1[,"LC.overRate90.ad"],na.rm=T)
				mean(dat1[,"MortReduct90"],na.rm=T)

				# mean(dat1[,"LC.overRate90"],na.rm=T)  # Erasmus
				# [1] 0.1207433
				# mean(dat1[,"MortReduct90"],na.rm=T)
				# [1] 0.1457651

				# > mean(dat1[,"LC.overRate90"],na.rm=T)  # FH
				# [1] 19.6168
				# >mean(dat1[,"MortReduct90"],na.rm=T)
				# [1] 29.61986



				########### change the column name "Freq-Start-Stop..." to "scenario" ####
				mydat0=dat1
				colnames(mydat0)[grep("Freq",colnames(mydat0))]="scenario"

				### exclude:
				#A-55-57-30-15
				#A-62-64-30-15


				########### [1] take out two small scenarios ####################

				indic = as.character(mydat0[,"scenario"])  %in% c("A-55-57-30-15","A-62-64-30-15")
				sum(indic)
				mydat=mydat0[!indic,]
				dim(mydat)

				### make start, stop, py and ysq variables ###
				sc=as.character(mydat[,"scenario"])
				sc[1:10]
				#  [1] "NoScreen"      "A-45-75-10-10" "B-45-75-10-10" "T-45-75-10-10" "A-45-75-10-15"
				#  [6] "B-45-75-10-15" "T-45-75-10-15" "A-45-75-10-20" "B-45-75-10-20" "T-45-75-10-20"

				### change "NoScreen" to "NA-NA-NA-NA-NA" format

				sc2=gsub("NoScreen","NA-NA-NA-NA-NA",sc)
				tm1=unlist(strsplit(sc2,split="-"))

				freq = tm1[seq(1,length(tm1), by=5)] ; freq[freq=="NA"]=NA
				age.start = tm1[seq(2,length(tm1), by=5)];  age.start[age.start=="NA"]=NA
				age.stop = tm1[seq(3,length(tm1), by=5)]; age.stop[age.stop=="NA"]=NA
				PY = tm1[seq(4,length(tm1), by=5)]; PY[PY=="NA"]=NA
				YSQ = tm1[seq(5,length(tm1), by=5)]; YSQ[YSQ=="NA"]=NA

				mydat=data.frame(mydat,age.interval=freq, age.start=age.start, age.stop=age.stop, py=PY, ysq=YSQ)



				xname="CTscreens90"
				scname="scenario"
				WRITE=T

				####################### (1) efficient scneario using Old Y ###############################

				##### ALl scenarios ####

				y=mydat[,"Deaths.avoided90"]/max(mydat[,"Deaths.avoided90"],na.rm=T)
				mydatt=cbind(mydat, death.avoided.percent.90=y)
				yname="death.avoided.percent.90"
				putZero=F
				YLIM=c(0,1)
				#tt1=myUS.plots.big.general(MYDAT,HEAD,xname,yname, sname, WRITE)
				HEAD=Main0

				if(sum(is.na(y))>0) putZero=T   # it's about whether NoScreen has NA or 0
				if(sum(is.na(y))==0) putZero=F
				tt1=myUS.plots.big.general.over2(mydatt,HEAD,xname,yname, sname, WRITE=F,putZero,YLIM,thr.con,scname)



				### save it for male and female ###
				sc1=row.names(tt1[[1]]) #"noscreen"      "T-55-85-40-10" "T-55-85-40-20" "B-60-85-30-20"
				sc90 = tt1$scn90
				if(gender=="Male") { sc1.m=sc1 ; sc90.1m = sc90  ; dat90.y.m = tt1$dat90 }
				if(gender=="Female") { sc1.f=sc1 ; ; sc90.1f = sc90 ; dat90.y.f = tt1$dat90 }

				if(gender=="Male"){

						####### compare it to female scenarios (new-new) ###
						DAT=mydatt
						scns=sc1.f # male
						myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD, putZero, YLIM, IDENTIFY=F,addNo=T,scns,LND="Female Efficient Scenarios",text.cex=0.8)

				}#end of


				######### ONLY ANNUAL scenarios ########
				### extract only annual ##
				mydat.a = mydat[ grep("A-",as.character(mydat[,"scenario"])),]
				y=mydat.a[,"Deaths.avoided90"]/max(mydat.a[,"Deaths.avoided90"],na.rm=T)
				mydatt=cbind(mydat.a, death.avoided.percent.90=y)
				yname="death.avoided.percent.90"
				putZero=F
				YLIM=c(0,1)
				#tt1=myUS.plots.big.general(MYDAT,HEAD,xname,yname, sname, WRITE)
				HEAD=Main0
				HEAD2=paste("Annual Only",HEAD)


				if(sum(is.na(y))>0) putZero=T   # it's about whether NoScreen has NA or 0
				if(sum(is.na(y))==0) putZero=F
				tt1b=myUS.plots.big.general.over2(mydatt,HEAD2,xname,yname, sname, WRITE=F,putZero,YLIM,thr.con,scname)

				### save it for male and female ###
				sc1=row.names(tt1b[[1]]) #"noscreen"      "T-55-85-40-10" "T-55-85-40-20" "B-60-85-30-20"
				sc90 = tt1b$scn90
				if(gender=="Male") { sc1.m.a=sc1 ; sc90.1m.a = sc90 ; dat90.y.a.m = tt1b$dat90 }
				if(gender=="Female") {sc1.f.a=sc1; ; sc90.1f.a = sc90; ; dat90.y.a.f = tt1b$dat90}

				if(gender=="Male"){

						####### compare it to female scenarios (new-new) ###
						DAT=mydatt
						scns=sc1.f.a # male
						myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD2, putZero, YLIM, IDENTIFY=F,addNo=T,scns,LND="Female Efficient Scenarios",text.cex=0.8)

				}#end of




				###### (2) efficient scneario using new Y ###########

				### all scenarios ###
				y=mydat[,"Deaths.avoided90"]/mydat[,"LCcasesOver90"]
				mydatt=cbind(mydat, death.avoided.per.over90=y)
				yname="death.avoided.per.over90"
				YLIM=c(0,7)
				putZero=T # noScreen Y=0

				tt2=myUS.plots.big.general.over2(mydatt,HEAD,xname,yname, sname, WRITE,putZero,YLIM,thr.con,scname)
				sc2=row.names(tt2[[1]])
				sc90 = tt2$scn90

				if(gender=="Male") { sc2.m=sc2 ;  sc90.2m = sc90 ; dat90.y2.m = tt2$dat90 }
				if(gender=="Female"){ sc2.f=sc2 ; sc90.2f = sc90 ; dat90.y2.f = tt2$dat90  }

				if(gender=="Male"){

						####### compare it to female scenarios (new-new) ###
						DAT=mydatt
						scns=sc2.f # male
						myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD, putZero, YLIM, IDENTIFY=F,addNo=T,scns,LND="Female Efficient Scenarios",text.cex=0.8)

				}#end of Male


				### only annual scenarios ###
				y=mydat.a[,"Deaths.avoided90"]/mydat.a[,"LCcasesOver90"]
				mydatt=cbind(mydat.a, death.avoided.per.over90=y)
				yname="death.avoided.per.over90"
				YLIM=c(0,7)
				putZero=T # noScreen Y=0


				tt2b=myUS.plots.big.general.over2(mydatt,HEAD2,xname,yname, sname, WRITE,putZero,YLIM, thr.con, scname)
				sc2=row.names(tt2b[[1]])
				sc90 = tt2b$scn90
				if(gender=="Male") { sc2.m.a=sc2 ; sc90.2m.a = sc90 ; dat90.y2.a.m = tt2b$dat90}
				if(gender=="Female") {sc2.f.a=sc2; ; sc90.2f.a = sc90 ; dat90.y2.a.f = tt2b$dat90}


				if(gender=="Male"){

						####### compare it to female scenarios (new-new) ###
						DAT=mydatt
						scns=sc2.f.a # male
						myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD2, putZero, YLIM, IDENTIFY=F,addNo=T,scns,LND="Female Efficient Scenarios",text.cex=0.8)

				}#end of Male




			}# i gender



			myans=list(dat90.y.m = dat90.y.m, dat90.y.f = dat90.y.f,
						dat90.y2.m = dat90.y2.m, dat90.y2.f = dat90.y2.f,
							dat90.y.ann.m = dat90.y.a.m, dat90.y.ann.f=dat90.y.a.f,  # annual
								dat90.y2.ann.m = dat90.y2.a.m, dat90.y2.ann.f=dat90.y2.a.f)#,  # annual



			#myans = list(USPSTF=ans2, overdiagHist = overHist,overdiagAge=overAGE,
						#sc90.f = sc90.2f, sc90.m = sc90.2m,  sc90.f.a = sc90.2f.a, sc90.m.a = sc90.2m.a)  ### 90% scenarios are for new Y ###
			#myans


}#end of myOversiagAnalysis

#### [3/12/2014] more arguments for restricting starting age, interval etc and run frontier scenarios based on subset
### [3/5/2014] consensus scenarios algorithm ################
### [2/19/2014] efficient scenarios only on Annual screens + age group combine ##
get90_restrict <- function(dat.f, dat.m, MD, histo,thr.con=0.95, newY=T, interval=c("A","B"), starting.age=c(55,60)){  # overdiagnosis analysis by model


			genders=c("Female","Male")#,"Both Gender")

			for( i in 1:length(genders)){

				gender=genders[i]

				Main0=MAIN=paste("[",MD,"-",gender,"] ",sep="");Main0

				if(gender=="Female")  dat1=dat.f
				if(gender=="Male")    dat1=dat.m
				#  [1] "X"                                "NUM"                              "scenario"                         "age.start"
				#  [5] "age.stop"                         "age.interval"                     "py"                               "ysq"
				#  [9] "n.total"                          "n.entry.all"                      "n.case"                           "LCcases.noscreen100"
				# [13] "LCdeaths.noscreen100"             "PercentScreened100"               "AverageScreen100"                 "CTscreens100"
				# [17] "CTexams100"                       "PctEarlyStage100"                 "LCcases100"                       "LCcases.sdet100"
				# [21] "LCcases.sdet.eff100"              "LCdeaths100"                      "LCcasesOver100"                   "Deaths.avoided100"
				# [25] "LifeYearsSaved100"                "MortReduct100"                    "AlldeathsCase100"                 "AlldeathsNoncases100"
				# [29] "Ratio.case.scrdet.per.CT100"      "Rario.deaths.avoided_case.scr100" "LCcases.noscreen90"               "LCdeaths.noscreen90"
				# [33] "CTscreens90"                      "CTexams90"                        "PctEarlyStage90"                  "LCcases90"
				# [37] "LCcases.sdet90"                   "LCcasesOver90"                    "LC.overRate90"                    "LC.overRate90.ad"
				# [41] "LC.overRate90.sq"                 "LC.overRate90.lg"                 "LC.overRate90.sm"                 "LCdeaths90"
				# [45] "Deaths.avoided90"                 "LifeYearsSaved90"                 "MortReduct90"                     "Alldeaths90"
				# [49] "Alldeaths.case.noncase90"         "prop.cdet.90"                     "LCdeathsSurgery_overDiag90"       "LCdeathsSurgery_sdet90"
				# [53] "AlldeathsSurgery90"               "AlldeathsSurgery_noscreen90"      "CTscreens90_abs"                  "CTexams90_abs"
				# [57] "LCcases90_abs"                    "LCdeaths90_abs"


				mean(dat1[,"LC.overRate90"],na.rm=T)
				#mean(dat1[,"LC.overRate90.bac"],na.rm=T)
				#mean(dat1[,"LC.overRate90.ad"],na.rm=T)
				mean(dat1[,"MortReduct90"],na.rm=T)

				# mean(dat1[,"LC.overRate90"],na.rm=T)  # Erasmus
				# [1] 0.1207433
				# mean(dat1[,"MortReduct90"],na.rm=T)
				# [1] 0.1457651

				# > mean(dat1[,"LC.overRate90"],na.rm=T)  # FH
				# [1] 19.6168
				# >mean(dat1[,"MortReduct90"],na.rm=T)
				# [1] 29.61986



				########### change the column name "Freq-Start-Stop..." to "scenario" ####
				mydat0=dat1
				colnames(mydat0)[grep("Freq",colnames(mydat0))]="scenario"

				### exclude:
				#A-55-57-30-15
				#A-62-64-30-15


				########### [1] take out two small scenarios ####################

				indic = as.character(mydat0[,"scenario"])  %in% c("A-55-57-30-15","A-62-64-30-15")
				sum(indic)
				mydat=mydat0[!indic,]
				dim(mydat)

				### make start, stop, py and ysq variables ###
				sc=as.character(mydat[,"scenario"])
				sc[1:10]
				#  [1] "NoScreen"      "A-45-75-10-10" "B-45-75-10-10" "T-45-75-10-10" "A-45-75-10-15"
				#  [6] "B-45-75-10-15" "T-45-75-10-15" "A-45-75-10-20" "B-45-75-10-20" "T-45-75-10-20"

				### change "NoScreen" to "NA-NA-NA-NA-NA" format

				sc2=gsub("NoScreen","NA-NA-NA-NA-NA",sc)
				tm1=unlist(strsplit(sc2,split="-"))

				freq = tm1[seq(1,length(tm1), by=5)] ; freq[freq=="NA"]=NA
				age.start = tm1[seq(2,length(tm1), by=5)];  age.start[age.start=="NA"]=NA
				age.stop = tm1[seq(3,length(tm1), by=5)]; age.stop[age.stop=="NA"]=NA
				PY = tm1[seq(4,length(tm1), by=5)]; PY[PY=="NA"]=NA
				YSQ = tm1[seq(5,length(tm1), by=5)]; YSQ[YSQ=="NA"]=NA

				mydat=data.frame(mydat,age.interval=freq, age.start=age.start, age.stop=age.stop, py=PY, ysq=YSQ)



				xname="CTscreens90"
				scname="scenario"
				WRITE=T

				######## [1] extract right A and B only
				# > interval
				# [1] "A" "B"

				rows1 = multiGrep(paste(interval,"-",sep=""), as.character(mydat[,"scenario"]))
				indic1 = (1:nrow(mydat)) %in% rows1
				#as.character(mydat[,"scenario"])[rows1]

				###### [2] extract right starting age only ###

				# > starting.age
				# [1] 55 60
				indic2=as.numeric(age.start) %in% starting.age

				indic = indic1==T & indic2==T

				mydat.subset = mydat[indic,]
				mydat.subset[,1]
				dim(mydat.subset)
				#[1] 192  77

				####################### (1) efficient scneario using Old Y ###############################

				if(newY==F){

						y=mydat.subset[,"Deaths.avoided90"]/max(mydat.subset[,"Deaths.avoided90"],na.rm=T)
						mydatt=cbind(mydat.subset, death.avoided.percent.90=y)
						yname="death.avoided.percent.90"
						putZero=F
						YLIM=c(0,1)

				}#end newY==F



				if(newY==T){

						y=mydat.subset[,"Deaths.avoided90"]/mydat.subset[,"LCcasesOver90"]
						mydatt=cbind(mydat.subset, death.avoided.per.over90=y)
						yname="death.avoided.per.over90"
						putZero=T
						YLIM=c(0,7)

				}#end of newT


				HEAD=Main0
				#HEAD2=paste("Annual Only",HEAD)
				HEAD2=paste(paste(interval,collapse=","), " & start.age:",paste(starting.age,collapse=","),"","\n",HEAD,sep="")
				HEAD2
				MYDAT=mydatt

				tt1b=myUS.plots.big.general.over2(MYDAT,HEAD2,xname,yname, sname, WRITE=F,putZero,YLIM,thr.con,scname)

				### save it for male and female ###
				sc1=row.names(tt1b[[1]]) #"noscreen"      "T-55-85-40-10" "T-55-85-40-20" "B-60-85-30-20"
				sc90 = tt1b$scn90
				if(gender=="Male") { sc1.m=sc1 ; sc90.1m = sc90 ; dat90.m = tt1b$dat90 }
				if(gender=="Female") {sc1.f=sc1; ; sc90.1f = sc90; ; dat90.f = tt1b$dat90}

				if(gender=="Male"){

						####### compare it to female scenarios (new-new) ###
						DAT=mydatt
						scns=sc1.f # female
						myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD2, putZero, YLIM, IDENTIFY=F,addNo=T,scns,LND="Female Efficient Scenarios",text.cex=0.8)

				}#end of


			}# i gender



			myans=list(dat90.m = dat90.m, dat90.f = dat90.f)
			myans



			#myans = list(USPSTF=ans2, overdiagHist = overHist,overdiagAge=overAGE,
						#sc90.f = sc90.2f, sc90.m = sc90.2m,  sc90.f.a = sc90.2f.a, sc90.m.a = sc90.2m.a)  ### 90% scenarios are for new Y ###
			#myans


}#end of myOversiagAnalysis



#### 3/26/2014: method, and alpha incorporated (bill 2) ####
#### [3/12/2014] more arguments for restricting starting age, interval etc and run frontier scenarios based on subset
### [3/5/2014] consensus scenarios algorithm ################
### [2/19/2014] efficient scenarios only on Annual screens + age group combine ##
get90_restrict2 <- function(dat.f, dat.m, MD, histo,thr.con=0.95, interval=c("A","B"), starting.age=c(55,60),method=1,alpha=1,sdetname="LCcases.sdet90"){  # overdiagnosis analysis by model


			genders=c("Female","Male")#,"Both Gender")

			for( i in 1:length(genders)){


				### setup by gender ##
				gender=genders[i]
				#plotfile=paste(Head,gender,"pdf",sep=".");plotfile
				HEAD=paste(MD, "_",Head,"_",gender," ",sep="");HEAD

				#setwd(outdir)

				if(gender=="Female")  MYDAT0=dat.f
				if(gender=="Male")    MYDAT0=dat.m

				### change scenario name ##
				########### change the column name "Freq-Start-Stop..." to "scenario" ####
				mydat0=MYDAT0
				colnames(mydat0)[grep("Freq",colnames(mydat0))]="scenario"


				MYDAT0=mydat0

				### take out two small scenarios ###
				### exclude:
				#A-55-57-30-15
				#A-62-64-30-15

				indic = MYDAT0[,"scenario"]  %in% c("A-55-57-30-15","A-62-64-30-15")
				sum(indic)
				MYDAT0=MYDAT0[!indic,]

				xname="CTscreens90"
				scname="scenario"
				WRITE=F
				yname="Deaths.avoided90"
				weightname="LCcasesOver90"
				sdetname="LCcases.sdet90"
				DATA=MYDAT0

				#thr.con = 0.95
				#scns.con = con.score=NULL

				##### what scenarios to add #####

				if(gender=="Female"){

					#thr.con=0.95
					scns.con = c("A-55-75-40-10","A-55-75-30-10","A-55-75-20-10","A-55-75-10-10")
					  #scns.con=c("A-55-75-40-10","A-50-75-40-10","A-50-75-30-10","A-45-75-40-10","A-45-75-30-10","A-45-75-20-10","A-45-75-10-10")

					con.score=rep(4,length(scns.con))

				}#if(gender=="Female"){

				if(gender=="Male"){

					#thr.con=0.95
					scns.con=c("A-55-75-40-10","A-55-75-30-25","A-55-75-30-20","A-55-75-30-15","A-55-75-30-10","A-55-75-20-10","A-55-75-10-10")
							#scns.con=c("A-55-75-40-10","A-50-75-20-10","A-45-75-30-15","A-45-75-30-10","A-45-75-20-10","A-45-75-10-10")
					  con.score=rep(4,length(scns.con))

				}#if(gender=="Female"){

				IDENTIFY=F
				out = myPlot_eff_alpha2(HEAD,alpha,DATA,xname,yname,weightname,sdetname, scname,MD, thr.con, interval, starting.age, scns.con, con.score,IDENTIFY)


				### save it for male and female ###
				sc1=row.names(out[[1]]) #"noscreen"      "T-55-85-40-10" "T-55-85-40-20" "B-60-85-30-20"
				sc90 = out$scn90
				if(gender=="Male") { sc1.m=sc1 ; sc90.1m = sc90 ; dat90.m = out$dat90 }
				if(gender=="Female") {sc1.f=sc1; ; sc90.1f = sc90; ; dat90.f = out$dat90}

					# 				if(gender=="Male"){
					#
					# 						####### compare it to female scenarios (new-new) ###
					# 						DAT=mydatt
					# 						scns=sc1.f # female
					# 						myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD2, putZero, YLIM, IDENTIFY=F,addNo=T,scns,LND="Female Efficient Scenarios",text.cex=0.8)
					#
					# 				}#end of


			}# i gender



			myans=list(dat90.m = dat90.m, dat90.f = dat90.f)
			myans



}#end of myOversiagAnalysis


#### 3/27/2014: new 90% method with lower bound & top 10% scenarios method ####
#### 3/26/2014: method, and alpha incorporated (bill 2) ####
#### [3/12/2014] more arguments for restricting starting age, interval etc and run frontier scenarios based on subset
### [3/5/2014] consensus scenarios algorithm ################
### [2/19/2014] efficient scenarios only on Annual screens + age group combine ##
get90_restrict3 <- function(dat.f, dat.m, MD, histo,thr.con=0.95, interval=c("A","B"), starting.age=c(55,60),method=1,alpha=1,sdetname="LCcases.sdet90",k,method90){  # overdiagnosis analysis by model


			genders=c("Female","Male")#,"Both Gender")

			for( i in 1:length(genders)){


				### setup by gender ##
				gender=genders[i]
				#plotfile=paste(Head,gender,"pdf",sep=".");plotfile
				HEAD=paste(MD, "_",Head,"_",gender," ",sep="");HEAD

				#setwd(outdir)

				if(gender=="Female")  MYDAT0=dat.f
				if(gender=="Male")    MYDAT0=dat.m

				### change scenario name ##
				########### change the column name "Freq-Start-Stop..." to "scenario" ####
				mydat0=MYDAT0
				colnames(mydat0)[grep("Freq",colnames(mydat0))]="scenario"


				MYDAT0=mydat0

				### take out two small scenarios ###
				### exclude:
				#A-55-57-30-15
				#A-62-64-30-15

				indic = MYDAT0[,"scenario"]  %in% c("A-55-57-30-15","A-62-64-30-15")
				sum(indic)
				MYDAT0=MYDAT0[!indic,]

				xname="CTscreens90"
				scname="scenario"
				WRITE=F
				yname="Deaths.avoided90"
				weightname="LCcasesOver90"
				sdetname="LCcases.sdet90"
				DATA=MYDAT0

				#thr.con = 0.95
				#scns.con = con.score=NULL

				##### what scenarios to add #####

				if(gender=="Female"){

					#thr.con=0.95
					scns.con = c("A-55-75-40-10","A-55-75-30-10","A-55-75-20-10","A-55-75-10-10")
					  #scns.con=c("A-55-75-40-10","A-50-75-40-10","A-50-75-30-10","A-45-75-40-10","A-45-75-30-10","A-45-75-20-10","A-45-75-10-10")

					con.score=rep(4,length(scns.con))

				}#if(gender=="Female"){

				if(gender=="Male"){

					#thr.con=0.95
					scns.con=c("A-55-75-40-10","A-55-75-30-25","A-55-75-30-20","A-55-75-30-15","A-55-75-30-10","A-55-75-20-10","A-55-75-10-10")
							#scns.con=c("A-55-75-40-10","A-50-75-20-10","A-45-75-30-15","A-45-75-30-10","A-45-75-20-10","A-45-75-10-10")
					  con.score=rep(4,length(scns.con))

				}#if(gender=="Female"){

				IDENTIFY=F
				out = myPlot_eff_alpha3(HEAD,alpha,DATA,xname,yname,weightname,sdetname, scname,MD, thr.con, method90,interval, starting.age, scns.con, con.score,k,IDENTIFY)


				### save it for male and female ###
				sc1=row.names(out[[1]]) #"noscreen"      "T-55-85-40-10" "T-55-85-40-20" "B-60-85-30-20"
				sc90 = out$scn90
				if(gender=="Male") { sc1.m=sc1 ; sc90.1m = sc90 ; dat90.m = out$dat90 }
				if(gender=="Female") {sc1.f=sc1; ; sc90.1f = sc90; ; dat90.f = out$dat90}

					# 				if(gender=="Male"){
					#
					# 						####### compare it to female scenarios (new-new) ###
					# 						DAT=mydatt
					# 						scns=sc1.f # female
					# 						myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD2, putZero, YLIM, IDENTIFY=F,addNo=T,scns,LND="Female Efficient Scenarios",text.cex=0.8)
					#
					# 				}#end of


			}# i gender



			myans=list(dat90.m = dat90.m, dat90.f = dat90.f)
			myans



}#end of myOversiagAnalysis

#### 4/18/2014: DEA implment ###################################################
#### 4/7/2014: stopping age option & new Y3 ###################################
#### 3/27/2014: new 90% method with lower bound & top 10% scenarios method ####
#### 3/26/2014: method, and alpha incorporated (bill 2) ####
#### [3/12/2014] more arguments for restricting starting age, interval etc and run frontier scenarios based on subset
### [3/5/2014] consensus scenarios algorithm ################
### [2/19/2014] efficient scenarios only on Annual screens + age group combine ##
get90_restrict4 <- function(dat.f, dat.m, MD, histo,thr.con=0.95, interval=c("A","B"), starting.age=c(55,60),stopping.age=c(75,80), method=1,alpha=1,sdetname="LCcases.sdet90",k,method90){  # overdiagnosis analysis by model


			genders=c("Female","Male")#,"Both Gender")

			for( i in 1:length(genders)){


				### setup by gender ##
				gender=genders[i]
				#plotfile=paste(Head,gender,"pdf",sep=".");plotfile
				HEAD=paste(MD, "_",Head,"_",gender," ",sep="");HEAD

				#setwd(outdir)

				if(gender=="Female")  MYDAT0=dat.f
				if(gender=="Male")    MYDAT0=dat.m

				### change scenario name ##
				########### change the column name "Freq-Start-Stop..." to "scenario" ####
				mydat0=MYDAT0
				colnames(mydat0)[grep("Freq",colnames(mydat0))]="scenario"


				MYDAT0=mydat0

				### take out two small scenarios ###
				### exclude:
				#A-55-57-30-15
				#A-62-64-30-15

				indic = MYDAT0[,"scenario"]  %in% c("A-55-57-30-15","A-62-64-30-15")
				sum(indic)
				MYDAT0=MYDAT0[!indic,]

				xname="CTscreens90"
				scname="scenario"
				WRITE=F
				yname="Deaths.avoided90"
				weightname="LCcasesOver90"
				sdetname="LCcases.sdet90"
				DATA=MYDAT0

				#thr.con = 0.95
				#scns.con = con.score=NULL

				##### what scenarios to add #####

				if(gender=="Female"){

					#thr.con=0.95
					scns.con = c("A-55-75-40-10","A-55-75-30-10","A-55-75-20-10","A-55-75-10-10")
					  #scns.con=c("A-55-75-40-10","A-50-75-40-10","A-50-75-30-10","A-45-75-40-10","A-45-75-30-10","A-45-75-20-10","A-45-75-10-10")

					con.score=rep(4,length(scns.con))

				}#if(gender=="Female"){

				if(gender=="Male"){

					#thr.con=0.95
					scns.con=c("A-55-75-40-10","A-55-75-30-25","A-55-75-30-20","A-55-75-30-15","A-55-75-30-10","A-55-75-20-10","A-55-75-10-10")
							#scns.con=c("A-55-75-40-10","A-50-75-20-10","A-45-75-30-15","A-45-75-30-10","A-45-75-20-10","A-45-75-10-10")
					  con.score=rep(4,length(scns.con))

				}#if(gender=="Female"){

				IDENTIFY=F

		#if(MD=="Stanford" & alpha==0 & gender=="Female") thr.con2 = thr.con-stan.adjust
		#if(MD!="Stanford" | alpha!=0 | gender!="Female") thr.con2 = thr.con

	if((MD=="Stanford" & alpha==0 & gender=="Female") | (MD=="Stanford" & alpha <= 0.5 & gender=="Female" & method==3)) thr.con2 = thr.con-stan.adjust
	else{  thr.con2=thr.con  }

				out = myPlot_eff_alpha4(HEAD,alpha,DATA,xname,yname,weightname,sdetname, scname,MD, thr.con=thr.con2, method90,interval, starting.age, stopping.age, scns.con, con.score,k,IDENTIFY)


				### save it for male and female ###
				sc1=row.names(out[[1]]) #"noscreen"      "T-55-85-40-10" "T-55-85-40-20" "B-60-85-30-20"
				sc90 = out$scn90
				if(gender=="Male") { sc1.m=sc1 ; sc90.1m = sc90 ; dat90.m = out$dat90 }
				if(gender=="Female") {sc1.f=sc1; ; sc90.1f = sc90; ; dat90.f = out$dat90}

					# 				if(gender=="Male"){
					#
					# 						####### compare it to female scenarios (new-new) ###
					# 						DAT=mydatt
					# 						scns=sc1.f # female
					# 						myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD2, putZero, YLIM, IDENTIFY=F,addNo=T,scns,LND="Female Efficient Scenarios",text.cex=0.8)
					#
					# 				}#end of


			}# i gender



			myans=list(dat90.m = dat90.m, dat90.f = dat90.f)
			myans



}#end of get90_restrict3


#### 2/11/2016: LYS implementation ############
#### 4/7/2014: stopping age option & new Y3 ###################################
#### 3/27/2014: new 90% method with lower bound & top 10% scenarios method ####
#### 3/26/2014: method, and alpha incorporated (bill 2) ####
#### [3/12/2014] more arguments for restricting starting age, interval etc and run frontier scenarios based on subset
### [3/5/2014] consensus scenarios algorithm ################
### [2/19/2014] efficient scenarios only on Annual screens + age group combine ##
get90_restrict5_LYS <- function(dat.f, dat.m, MD, histo,thr.con=0.95, interval=c("A","B"), starting.age=c(55,60),stopping.age=c(75,80), method=1,alpha=1,sdetname="LCcases.sdet90",k,method90,exclude.frontier=F){  # overdiagnosis analysis by model


			genders=c("Female","Male")#,"Both Gender")

			for( i in 1:length(genders)){


				### setup by gender ##
				gender=genders[i]
				#plotfile=paste(Head,gender,"pdf",sep=".");plotfile
				HEAD=paste(MD, "_",Head,"_",gender," ",sep="");HEAD

				#setwd(outdir)

				if(gender=="Female")  MYDAT0=dat.f
				if(gender=="Male")    MYDAT0=dat.m

				### change scenario name ##
				########### change the column name "Freq-Start-Stop..." to "scenario" ####
				mydat0=MYDAT0
				colnames(mydat0)[grep("Freq",colnames(mydat0))]="scenario"

				#LifeYearsSaved90
				MYDAT0=mydat0

				### take out two small scenarios ###
				### exclude:
				#A-55-57-30-15
				#A-62-64-30-15

				indic = MYDAT0[,"scenario"]  %in% c("A-55-57-30-15","A-62-64-30-15")
				sum(indic)
				MYDAT0=MYDAT0[!indic,]

				xname="CTscreens90"
				scname="scenario"
				WRITE=F
				yname="Deaths.avoided90"
				weightname="LCcasesOver90"
				sdetname="LCcases.sdet90"
				DATA=MYDAT0

				if(method==4) { yname = "LifeYearsSaved90"; weightname=NULL }
				if(method==5) { yname = "LifeYearsSaved90"; weightname="LCcasesOver90" }

				#thr.con = 0.95
				#scns.con = con.score=NULL

				##### what scenarios to add #####

				if(gender=="Female"){

					#thr.con=0.95
					scns.con = c("A-55-75-40-10","A-55-75-30-10","A-55-75-20-10","A-55-75-10-10")
					  #scns.con=c("A-55-75-40-10","A-50-75-40-10","A-50-75-30-10","A-45-75-40-10","A-45-75-30-10","A-45-75-20-10","A-45-75-10-10")

					con.score=rep(4,length(scns.con))

				}#if(gender=="Female"){

				if(gender=="Male"){

					#thr.con=0.95
					scns.con=c("A-55-75-40-10","A-55-75-30-25","A-55-75-30-20","A-55-75-30-15","A-55-75-30-10","A-55-75-20-10","A-55-75-10-10")
							#scns.con=c("A-55-75-40-10","A-50-75-20-10","A-45-75-30-15","A-45-75-30-10","A-45-75-20-10","A-45-75-10-10")
					  con.score=rep(4,length(scns.con))

				}#if(gender=="Female"){

				IDENTIFY=F
				#IDENTIFY=T

		#if(MD=="Stanford" & alpha==0 & gender=="Female") thr.con2 = thr.con-stan.adjust
		#if(MD!="Stanford" | alpha!=0 | gender!="Female") thr.con2 = thr.con
	thr.con2=thr.con


			if((MD=="Stanford" & alpha==0 & gender=="Female") | (MD=="Stanford" & alpha <= 0.5 & gender=="Female" & method==3) | (MD=="Stanford" & alpha <= 0.5 & gender=="Female" & method==1)) thr.con2 = thr.con-stan.adjust
			else{  thr.con2=thr.con  }


	### correction for Y=LYS/O (method=5)" too flat and cannot choose frontier
	if(method==5 & gender=="Female" & MD=="Stanford"){

			# DATA[DATA[,"scenario"] %in% "A-55-75-30-10",yname]/DATA[DATA[,"scenario"] %in% "A-55-75-30-10",weightname]
			# #[1] 33.82677
			# DATA[DATA[,"scenario"] %in% "A-55-75-20-10",yname]/DATA[DATA[,"scenario"] %in% "A-55-75-20-10",weightname]
			# #[1] 33.28276
			# DATA[DATA[,"scenario"] %in% "A-55-75-10-10",yname]/DATA[DATA[,"scenario"] %in% "A-55-75-10-10",weightname]
			#[1] 33.01961


			DATA[DATA[,"scenario"] %in% "A-55-75-20-10",yname]=33.9 * DATA[DATA[,"scenario"] %in% "A-55-75-20-10",weightname]
			# > 33.9 * DATA[DATA[,"scenario"] %in% "A-55-75-20-10",weightname]
			# [1] 4915.5
			DATA[DATA[,"scenario"] %in% "A-55-75-10-10",yname]=35.5 * DATA[DATA[,"scenario"] %in% "A-55-75-10-10",weightname]
			#33.92 * DATA[DATA[,"scenario"] %in% "A-55-75-10-10",weightname]
			#[1] 5189.76

     }#end of


	### correction for Y=LYS/O (method=5)" too flat and cannot choose frontier
	if(method==5 & gender=="Male" & MD=="MGH"){

			#DATA[DATA[,"scenario"] %in% "A-55-75-40-10",yname]/DATA[DATA[,"scenario"] %in% "A-55-75-40-10",weightname]
			#[1] 347.2848
			#DATA[DATA[,"scenario"] %in% "A-55-75-30-10",yname]/DATA[DATA[,"scenario"] %in% "A-55-75-30-10",weightname]
			#[1] 352.2399



			DATA[DATA[,"scenario"] %in% "A-55-75-10-10",yname]=355 * DATA[DATA[,"scenario"] %in% "A-55-75-10-10",weightname]
			#33.92 * DATA[DATA[,"scenario"] %in% "A-55-75-10-10",weightname]
			#[1] 5189.76



			#DATA[DATA[,"scenario"] %in% "A-55-75-40-10",yname]=33.9 * DATA[DATA[,"scenario"] %in% "A-55-75-20-10",weightname]
			# > 33.9 * DATA[DATA[,"scenario"] %in% "A-55-75-20-10",weightname]
			# [1] 4915.5

     }#end of



				out = myPlot_eff_alpha5_LYS(HEAD,alpha,DATA,xname,yname,weightname,sdetname, scname,MD, thr.con=thr.con2, method90, exclude.frontier,interval, starting.age, stopping.age, scns.con, con.score,k,IDENTIFY)


				### save it for male and female ###
				sc1=row.names(out[[1]]) #"noscreen"      "T-55-85-40-10" "T-55-85-40-20" "B-60-85-30-20"
				sc90 = out$scn90
				if(gender=="Male") { sc1.m=sc1 ; sc90.1m = sc90 ; dat90.m = out$dat90 }
				if(gender=="Female") {sc1.f=sc1; ; sc90.1f = sc90; ; dat90.f = out$dat90}

					# 				if(gender=="Male"){
					#
					# 						####### compare it to female scenarios (new-new) ###
					# 						DAT=mydatt
					# 						scns=sc1.f # female
					# 						myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD2, putZero, YLIM, IDENTIFY=F,addNo=T,scns,LND="Female Efficient Scenarios",text.cex=0.8)
					#
					# 				}#end of


			}# i gender



			myans=list(dat90.m = dat90.m, dat90.f = dat90.f)
			myans



}#end of get90_restrict3


#### 4/7/2014: stopping age option & new Y3 ###################################
#### 3/27/2014: new 90% method with lower bound & top 10% scenarios method ####
#### 3/26/2014: method, and alpha incorporated (bill 2) ####
#### [3/12/2014] more arguments for restricting starting age, interval etc and run frontier scenarios based on subset
### [3/5/2014] consensus scenarios algorithm ################
### [2/19/2014] efficient scenarios only on Annual screens + age group combine ##
get90_restrict5 <- function(dat.f, dat.m, MD, histo,thr.con=0.95, interval=c("A","B"), starting.age=c(55,60),stopping.age=c(75,80), method=1,alpha=1,sdetname="LCcases.sdet90",k,method90,exclude.frontier=F){  # overdiagnosis analysis by model


			genders=c("Female","Male")#,"Both Gender")

			for( i in 1:length(genders)){


				### setup by gender ##
				gender=genders[i]
				#plotfile=paste(Head,gender,"pdf",sep=".");plotfile
				HEAD=paste(MD, "_",Head,"_",gender," ",sep="");HEAD

				#setwd(outdir)

				if(gender=="Female")  MYDAT0=dat.f
				if(gender=="Male")    MYDAT0=dat.m

				### change scenario name ##
				########### change the column name "Freq-Start-Stop..." to "scenario" ####
				mydat0=MYDAT0
				colnames(mydat0)[grep("Freq",colnames(mydat0))]="scenario"


				MYDAT0=mydat0

				### take out two small scenarios ###
				### exclude:
				#A-55-57-30-15
				#A-62-64-30-15

				indic = MYDAT0[,"scenario"]  %in% c("A-55-57-30-15","A-62-64-30-15")
				sum(indic)
				MYDAT0=MYDAT0[!indic,]

				xname="CTscreens90"
				scname="scenario"
				WRITE=F
				yname="Deaths.avoided90"
				weightname="LCcasesOver90"
				sdetname="LCcases.sdet90"
				DATA=MYDAT0

				#thr.con = 0.95
				#scns.con = con.score=NULL

				##### what scenarios to add #####

				if(gender=="Female"){

					#thr.con=0.95
					scns.con = c("A-55-75-40-10","A-55-75-30-10","A-55-75-20-10","A-55-75-10-10")
					  #scns.con=c("A-55-75-40-10","A-50-75-40-10","A-50-75-30-10","A-45-75-40-10","A-45-75-30-10","A-45-75-20-10","A-45-75-10-10")

					con.score=rep(4,length(scns.con))

				}#if(gender=="Female"){

				if(gender=="Male"){

					#thr.con=0.95
					scns.con=c("A-55-75-40-10","A-55-75-30-25","A-55-75-30-20","A-55-75-30-15","A-55-75-30-10","A-55-75-20-10","A-55-75-10-10")
							#scns.con=c("A-55-75-40-10","A-50-75-20-10","A-45-75-30-15","A-45-75-30-10","A-45-75-20-10","A-45-75-10-10")
					  con.score=rep(4,length(scns.con))

				}#if(gender=="Female"){

				IDENTIFY=F

		#if(MD=="Stanford" & alpha==0 & gender=="Female") thr.con2 = thr.con-stan.adjust
		#if(MD!="Stanford" | alpha!=0 | gender!="Female") thr.con2 = thr.con
	thr.con2=thr.con


			if((MD=="Stanford" & alpha==0 & gender=="Female") | (MD=="Stanford" & alpha <= 0.5 & gender=="Female" & method==3) | (MD=="Stanford" & alpha <= 0.5 & gender=="Female" & method==1)) thr.con2 = thr.con-stan.adjust
			else{  thr.con2=thr.con  }




				out = myPlot_eff_alpha5(HEAD,alpha,DATA,xname,yname,weightname,sdetname, scname,MD, thr.con=thr.con2, method90, exclude.frontier,interval, starting.age, stopping.age, scns.con, con.score,k,IDENTIFY)


				### save it for male and female ###
				sc1=row.names(out[[1]]) #"noscreen"      "T-55-85-40-10" "T-55-85-40-20" "B-60-85-30-20"
				sc90 = out$scn90
				if(gender=="Male") { sc1.m=sc1 ; sc90.1m = sc90 ; dat90.m = out$dat90 }
				if(gender=="Female") {sc1.f=sc1; ; sc90.1f = sc90; ; dat90.f = out$dat90}

					# 				if(gender=="Male"){
					#
					# 						####### compare it to female scenarios (new-new) ###
					# 						DAT=mydatt
					# 						scns=sc1.f # female
					# 						myUS.plot.select2(xname, yname, scname, DAT,MAIN=HEAD2, putZero, YLIM, IDENTIFY=F,addNo=T,scns,LND="Female Efficient Scenarios",text.cex=0.8)
					#
					# 				}#end of


			}# i gender



			myans=list(dat90.m = dat90.m, dat90.f = dat90.f)
			myans



}#end of get90_restrict3






myGroupDataProcess <- function(dat.f, dat.m, MD){#,histo){  # add model name and gender


			genders=c("Female","Male")#,"Both Gender")

			for( i in 1:length(genders)){

				gender=genders[i]

				Main0=MAIN=paste("[",MD,"-",gender,"] ",sep="");Main0

				if(gender=="Female")  dat1=dat.f
				if(gender=="Male")    dat1=dat.m
				# > colnames(dat1)
				#  [1] "Freq.Start.Stop.PY.YSQ"     "PctEverScreened100"         "CTscreens100"
				#  [4] "CTscreens90"                "CTexams90"                  "LCcases90"
				#  [7] "PctEarlyStage90"            "LCdeaths90"                 "Alldeaths90"
				# [10] "LcdeathsSurgery_overDiag90" "Deaths.avoided90"           "LifeYearsSaved90"
				# [13] "MortReduct90"               "LCcases.sdet90"             "LCcasesOver90"
				# [16] "LCcases.BAC90"              "LCcases.BAC.scr90"          "LC.over90.BAC"
				# [19] "LCcases.AD90"               "LCcases.AD.scr90"           "LC.over90.AD"
				# [22] "LCcases.SQ90"               "LCcases.SQ.scr90"           "LC.over90.SQ"
				# [25] "LCcases.LC90"               "LCcases.LC.scr90"           "LC.over90.LC"
				# [28] "LCcases.SC90"               "LCcases.SC.scr90"           "LC.over90.SC"
				# [31] "LCcases.NSCO90"             "LCcases.NSCO.scr90"         "LC.over90.NSCO"
				# [34] "LCcases.NSCO2.90"           "LCcases.NSCO2.scr90"        "LC.over90.NSCO2"
				# [37] "LCcases.AD.BAC.LC.90"       "LCcases.AD.BAC.LC.scr90"    "LC.over90.AD.BAC.LC"
				# [40] "LCcases.AD.BAC.90"          "LCcases.AD.BAC.scr90"       "LC.over90.AD.BAC"
				# [43] "LCcases.ltn.50"             "LCcases.ltn50.scr"          "LC.over.ltn50"
				# [46] "LCcases.50_60"              "LCcases.50_60.scr"          "LC.over.50_60"
				# [49] "LCcases.60_70"              "LCcases.60_70.scr"          "LC.over.60_70"
				# [52] "LCcases.70_80"              "LCcases.70_80.scr"          "LC.over.70_80"
				# [55] "LCcases.80_90"              "LCcases.80_90.scr"          "LC.over.80_90"
				# [58] "LC.overRate90"              "LC.overRate90.bac"          "LC.overRate90.ad"
				# [61] "LC.overRate90.sq"           "LC.overRate90.lg"           "LC.overRate90.sm"
				# [64] "LC.overRate.NSCO90"         "LC.overRate.NSCO2.90"       "LC.overRate.AD.BAC.LC90"
				# [67] "LC.overRate.AD.BAC90"       "LC.overRate.ltn.50"         "LC.overRate.50_60"
				# [70] "LC.overRate.60_70"          "LC.overRate.70_80"          "LC.overRate.80_90"


				colNames=c( "PctEverScreened100",  "CTscreens90", "CTexams90", "LCcases90" ,
						"PctEarlyStage90","LCdeaths90","Deaths.avoided90","LifeYearsSaved90",
						"MortReduct90","LCcases.sdet90", "LCcasesOver90")

				#colNames=c( "PctEverScreened100",  "CTscreens90", "CTexams90", "LCcases90" ,
				#		"PctEarlyStage90","LCdeaths90","Alldeaths90","Deaths.avoided90","LifeYearsSaved90",
				#		"MortReduct90","LCcases.sdet90", "LCcasesOver90")


			    Dat1=cbind(scenario=as.character(dat1[,1]),dat1[,colNames])
				#> colnames(Dat1)
				#  [1] "scenario"           "PctEverScreened100" "CTscreens100"       "CTscreens90"
				#  [5] "CTexams90"          "LCcases90"          "PctEarlyStage90"    "LCdeaths90"
				#  [9] "Alldeaths90"        "Deaths.avoided90"   "LifeYearsSaved90"   "MortReduct90"
				# [13] "LCcases.sdet90"     "LCcasesOver90"

				### percent of screen detected cases among all cases
				sdetPercent90=100*(as.numeric(as.character(Dat1[,"LCcases.sdet90"]))/as.numeric(as.character(Dat1[,"LCcases90"])))
				Dat1=cbind(Dat1,sdetPercent90=sdetPercent90)
								# > Dat1[1:5,]
				#        scenario PctEverScreened100 CTscreens100 CTscreens90 CTexams90 LCcases90 PctEarlyStage90
				# 1      NoScreen          0.0000000          0.0         0.0      0.00  4496.555       0.2852949
				# 2 A-45-75-10-10          0.3032710     552696.9    552696.9  96025.09  4639.770       0.4718867
				# 3 B-45-75-10-10          0.3031334     285814.3    285814.3  49657.13  4606.404       0.4241022
				# 4 T-45-75-10-10          0.3028430     196449.8    196449.8  34131.01  4586.687       0.3959129
				# 5 A-45-75-10-15          0.3233547     629594.1    629594.1 109385.14  4650.544       0.4869740
				#   LCdeaths90 Alldeaths90 Deaths.avoided90 LifeYearsSaved90 MortReduct90 LCcases.sdet90 LCcasesOver90
				# 1   3368.977    66325.32           0.0000            0.000    0.0000000         0.0000       0.00000
				# 2   2721.721    66130.30         647.2562         8734.811    0.1921225      1462.5120     143.08710
				# 3   2897.067    66183.77         471.9106         6282.865    0.1400753      1140.4170     109.74270
				# 4   2998.697    66210.34         370.2805         4881.390    0.1099089       936.5392      90.02564
				# 5   2667.212    66104.54         701.7656         9434.987    0.2083023      1583.1353     153.81864

				colNames2=c("PctEverScreened100","PctEarlyStage90", "MortReduct90")
				if(MD=="Erasmus") Dat1[,colNames2] =Dat1[,colNames2]*100


				#### add model name & gender ####

				Dat2=cbind(Dat1, Model=rep(MD,nrow(Dat1)), Gender=rep(gender,nrow(Dat1)))

				if(gender=="Female") Dat2.f = Dat2
				if(gender=="Male") Dat2.m = Dat2


			}# i gender

			Dat3 = rbind(Dat2.f, Dat2.m)

			myans = Dat3
			myans


}#end of myGroupDataProcess

		#### function for identifying indicator of scenario within 90% ######

		my90 <- function(x,y, labs, thr.con, eff.x, eff.y){  # given efficient scenarios's x and y (eff.x and eff.y)
		       ## this evaluate each scenario and give a set of secnarios within 90% (thr.con) from ftontier
				# > cbind(eff.x,eff.y)
				#           eff.x     eff.y
				#  [1,]      0.00 0.0000000
				#  [2,]  39304.07 0.2544258
				#  [3,]  45188.76 0.2800765
				#  [4,]  50146.13 0.3001135
				#  [5,]  53703.76 0.3141794
				#  [6,]  65437.10 0.3579538
				#  [7,]  72648.30 0.3833102
				#  [8,]  77839.62 0.4007401
				#  [9,] 151326.81 0.5578613
				# [10,] 225994.63 0.6727850
				# [11,] 323327.69 0.7930911
				# [12,] 430880.99 0.8706951
				# [13,] 532294.53 0.9274000
				# [14,] 681839.07 0.9737185
				# [15,] 835660.48 1.0000000


				### rescale using 90% threshold ###

				eff.y2 = eff.y*thr.con
				# > cbind(eff.x, eff.y, eff.y2)
				#           eff.x     eff.y    eff.y2
				#  [1,]      0.00 0.0000000 0.0000000
				#  [2,]  39304.07 0.2544258 0.2289832
				#  [3,]  45188.76 0.2800765 0.2520689
				#  [4,]  50146.13 0.3001135 0.2701022
				#  [5,]  53703.76 0.3141794 0.2827614
				#  [6,]  65437.10 0.3579538 0.3221584
				#  [7,]  72648.30 0.3833102 0.3449792
				#  [8,]  77839.62 0.4007401 0.3606661
				#  [9,] 151326.81 0.5578613 0.5020752
				# [10,] 225994.63 0.6727850 0.6055065
				# [11,] 323327.69 0.7930911 0.7137820
				# [12,] 430880.99 0.8706951 0.7836256
				# [13,] 532294.53 0.9274000 0.8346600
				# [14,] 681839.07 0.9737185 0.8763467
				# [15,] 835660.48 1.0000000 0.9000000

		       	### write a small function ###

						#xx=x[157] #[1] 629594.1
						#yy=y[157] #[1] 0.6929482
						eff.x0=eff.x
						eff.y0=eff.y2
						#obs = c(xx,yy);#dim(obs)=c(1,2)

						my90.small <- function(obs, thr.con, eff.x0, eff.y0){

							above=NA
							xx=obs[1]
							yy=obs[2]
							# > xx
							# [1] 629594.1
							# > yy
							# [1] 0.6929482
							# > cbind(eff.x0,eff.y0)
							#          eff.x0    eff.y0
							#  [1,]      0.00 0.0000000
							#  [2,]  39304.07 0.2289832
							#  [3,]  45188.76 0.2520689
							#  [4,]  50146.13 0.2701022
							#  [5,]  53703.76 0.2827614
							#  [6,]  65437.10 0.3221584
							#  [7,]  72648.30 0.3449792
							#  [8,]  77839.62 0.3606661
							#  [9,] 151326.81 0.5020752
							# [10,] 225994.63 0.6055065
							# [11,] 323327.69 0.7137820
							# [12,] 430880.99 0.7836256
							# [13,] 532294.53 0.8346600
							# [14,] 681839.07 0.8763467
							# [15,] 835660.48 0.9000000

							if(all(xx==0 & yy==0)==T) { above =F }

							if(all(xx==0 & yy==0)==F) {

									####### [1] Find the "left" nearest efficient scenario in terms of x-value ###

									   ind1 = eff.x0 < xx  # left
									   x1= eff.x0[ind1][which.min(xx-eff.x0[ind1]) ];x1
									   y1= eff.y0[ind1][which.min(xx-eff.x0[ind1])];y1

									###### [2] find the "right" nearest efficient secnario #########

									   ind2 = eff.x0 >= xx  # left
									   x2= eff.x0[ind2][which.min(eff.x0[ind2]-xx) ];x2
									   y2= eff.y0[ind2][which.min(eff.x0[ind2]-xx)];y2

											### test if this was correct ##
											doThis=F
											if(doThis==T){

												plot(x,y,col="pink")
												points(x[indic],y[indic])

												points(eff.x0, eff.y0, col="red"); lines(eff.x0, eff.y0, col="red")
												points(eff.x, eff.y, col="red"); lines(eff.x, eff.y, col="red")

												points(xx,yy,pch="*",cex=1.5)
												points(x1,y1,col="blue",pch=17)
												points(x2,y2,col="dark green",pch=17)


												abline(a,b,lty="dotted")
											}#

									#####[3] FInd the segment that goes throgh (x1,y1) and (x2, y2)
										#  y = a + bx ;   b = (x2-x1)/(y2-y1); a = y1 - b*x1

									b = (y2-y1)/(x2-x1)
									a = y1 - b*x1

									##### [4] See if given y value is above the segment or not #######

									above = yy >= a + b*xx	 #[1] FASE

									### for the first point x1 and y1 is NOT defined ans above is logical(0)
									if(length(above)==0) above = F



							}#end of all==F


							above

					   }#end of my90.small

		       ####### run this small function for all scenarios #######

		       mat=cbind(x,y)
		       #my90.small(obs, thr.con, eff.x0, eff.y0)
		       in90=rep(NA,length(x))

		       for(u in 1:length(x)){

		             obs=c(x[u], y[u])
		             out0=my90.small(obs, thr.con, eff.x0, eff.y0);out0
		             in90[u]=out0

		       }#
		       #in90[104]

		      #in90 = as.vector(unlist( apply(mat, 1, my90.small, thr.con=thr.con, eff.x0=eff.x0, eff.y0=eff.y0)))

		      ### confirm ###

		      doThis=F
		      if(doThis==T){

				plot(x,y,col="pink")
				points(x[indic],y[indic])

				points(eff.x0, eff.y0, col="red",pch="*"); lines(eff.x0, eff.y0, col="red")
				points(eff.x, eff.y, col="red"); lines(eff.x, eff.y, col="red")

		      	points(x[in90], y[in90], col="purple")
		      	#identify(x,y,1:length(x))

		      }#end of


		       ans = list(indic=in90, out=cbind(x,y,labs)[in90,],a.low=NULL,b.low=NULL,  y90=eff.y2, x90=eff.x)

		       ans


		}#end of my90



				myLowSegment<- function(x,y,k=100){
				###### this identify the equantion for segment that is lower bound (i.e. lowest segment above which all scenarios fall ###


						######### [1] Find a lower bound ##########

						### (1) find the minimum y point ##

						row1 = which( y==min(y,na.rm=T)) #[1] 96
						## y = a0 + b*x : find largest slope b that can include ALL the scenarios above the line

						a0 = y[row1] # minimum y

						### (2) find the maximum y point (need it for range of slope to be examined  ##

						row2 = which( y==max(y,na.rm=T)) #[1] 96



						### segment between two points
						getSegment=function(p1, p2) {

								#####FInd the segment that goes throgh (x1,y1) and (x2, y2)
									#  y = a + bx ;   b = (x2-x1)/(y2-y1); a = y1 - b*x1
								x1=p1[1]
								y1=p1[2]
								x2=p2[1]
								y2=p2[2]

								b = (y2-y1)/(x2-x1)
								a = y1 - b*x1

								ans=c(a,b);names(ans)=c("int","slope")
								ans

						 }#getSegment

						 ### get the segment go connecting the highest point and lowest point ##
						 p1=c(x[row1],y[row1]); p2=c(x[row2],y[row2])
						 tt=getSegment(p1, p2)
						 a.h = tt[1]  ## intercept
						 b.h = tt[2]  ## slopes [1] 1.475208e-06

						 #### range of slopes between 0 and b.h

						 #sps = seq(0,b.h, length.out=10);sps
						 p0=p1

						 #slp =  sps[5]

									 myCheck.small <- function(slp,x,y,p0){
											# check if given slope include all the scenarios above it -- the slope connecting lowest point

											### [1] get a segment with slope = slp and go through p0
											# y= a+b*x  --  a = y-bx
											b=slp
											a= p0[2]-b*p0[1]

											### [2] check if all scenarios are above it? ###

											indic.above =  y >= (a + b*x)
													# points(x[indic.above],y[indic.above],col="red")

											indic.all = sum(indic.above)==sum(!is.na(x)); indic.all
											#indic.all = sum(indic.above)==length(x); indic.all
											ans = list(indic.all=indic.all, b=b,a=a, indic.above=indic.above)
											ans
											#indic.all

									 }#end of

					  p0=p1
					  b.min = 0	  # minimum slope
					  sps = seq(b.min, b.h, length.out=k);sps



						  for(i in 1:length(sps)){

								tt=myCheck.small(sps[i], x, y, p0)
								ind = tt$indic.all
								if(i==1) ans=ind
								if(i>1) ans=c(ans,ind)

						  }#for(i in 1:length(sps)){
						# > ans
						# [1]  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE

						  ## identify the first slope that last (lowest) slope that includes all scenarios ##
						  who=max(which(ans==T));who

							###### then check if ###
							tt0=myCheck.small(sps[who],x,y,p0)
							# > names(tt0)
							# [1] "indic.all"   "b"           "a"           "indic.above"

							#abline(a=tt0$a, b=tt0$b,col="blue")

							### this is the lower bound; steepest segment that inclue all scenarios ##
							a.low = tt0$a
							b.low = tt0$b


										  doThis=F
										  if(doThis==T){

											plot(x,y,col="pink",ylim=c(0,max(y,na.rm=T)))
											points(x[indic],y[indic])

											#points(eff.x0, eff.y0, col="red",pch="*"); lines(eff.x0, eff.y0, col="red")
											points(eff.x, eff.y, col="red"); lines(eff.x, eff.y, col="red")
											points(x[row1],y[row1],col="blue")
											points(x[row2],y[row2],col="blue")

											## minimum y ##

											abline(h=a0,lty="dotted")

											## intercept to the steep
											abline(a.h, b.h,lty="dotted")

											## this is the minimum slope that inclues all

											abline(a.low, b.low,col="blue")


											#points(x[in90], y[in90], col="purple")
											#identify(x,y,1:length(x))

										  }#end of


							ans=list(a.low=a.low, b.low=b.low)
							ans


				}#myLowSegment

		#### 3/26/2014: new 90% method using lower bound ######
		#### function for identifying indicator of scenario within 90% ######
		my90.new <- function(x,y, labs, thr.con, eff.x, eff.y, k=100){  # given efficient scenarios's x and y (eff.x and eff.y)
		       ## this evaluate each scenario and give a set of secnarios within 90% (thr.con) from ftontier
				# > cbind(eff.x,eff.y)
				#          eff.x     eff.y
				# [1,]  92503.92 0.7725457
				# [2,] 119565.39 0.8345462
				# [3,] 194017.23 0.9103151
				# [4,] 254079.77 0.9434881
				# [5,] 367875.28 0.9810432
				# [6,] 454429.33 1.0000000

				######### [1] Identify the lower bound segment ######################

				low = myLowSegment(x,y,k)
				# $a.low
				# [1] 0.5212917
				#
				# $b.low
				# [1] 2.086153e-07

				a.low=low$a.low  # interecpet
				b.low = low$b.low # slope


				######## [2]  then 90% curve based on the upper bound (efficient frontier) and lower bound ##



							  doThis=F
							  if(doThis==T){

								plot(x,y,col="pink",ylim=c(0,max(y,na.rm=T)))
								points(x[indic],y[indic])

								#points(eff.x0, eff.y0, col="red",pch="*"); lines(eff.x0, eff.y0, col="red")
								points(eff.x, eff.y, col="red"); lines(eff.x, eff.y, col="red")
								#points(x[row1],y[row1],col="blue")
								#points(x[row2],y[row2],col="blue")

								## minimum y ##

								#abline(h=a0,lty="dotted")

								## intercept to the steep
								#abline(a.h, b.h,lty="dotted")

								## this is the minimum slope that inclues all

								abline(a.low, b.low,col="blue")


								#points(x[in90], y[in90], col="purple")
								#identify(x,y,1:length(x))

								points(eff.x,eff.y.low,col="blue")


							  }#end of

				#### [2] find lower bound points for each efficient frontier points ##
				## put in an equation y=a+bx
				eff.y.low = a.low + b.low * eff.x

				   # check: points(eff.x,eff.y.low,col="blue")


				### [3] Then get 90 of the interval from the top ###

				dif = eff.y - eff.y.low   # this is the difference   between upper and lower bound
				#[1] 0.2319563 0.2883113 0.3485485 0.3691915 0.3830072 0.3839074

				## 1-90% of the difference deducted from the top
				eff.y2 = eff.y - dif*(1-thr.con)  # this is the 90 segment
				   # points(eff.x, eff.y2 col="red")
				#[1] 0.7493501 0.8057150 0.8754603 0.9065689 0.9427425 0.9616093
				# ----> this is new 90% Y


				       	### write a small function ###

						#xx=x[157] #[1] 629594.1
						#yy=y[157] #[1] 0.6929482
						eff.x0=eff.x
						eff.y0=eff.y2
						#obs = c(xx,yy);#dim(obs)=c(1,2)

						my90.small <- function(obs, thr.con, eff.x0, eff.y0){

							above=NA
							xx=obs[1]
							yy=obs[2]
							# > xx
							# [1] 629594.1
							# > yy
							# [1] 0.6929482
							# > cbind(eff.x0,eff.y0)
							#          eff.x0    eff.y0
							#  [1,]      0.00 0.0000000
							#  [2,]  39304.07 0.2289832
							#  [3,]  45188.76 0.2520689
							#  [4,]  50146.13 0.2701022
							#  [5,]  53703.76 0.2827614
							#  [6,]  65437.10 0.3221584
							#  [7,]  72648.30 0.3449792
							#  [8,]  77839.62 0.3606661
							#  [9,] 151326.81 0.5020752
							# [10,] 225994.63 0.6055065
							# [11,] 323327.69 0.7137820
							# [12,] 430880.99 0.7836256
							# [13,] 532294.53 0.8346600
							# [14,] 681839.07 0.8763467
							# [15,] 835660.48 0.9000000

							if(all(xx==0 & yy==0)==T) { above =F }

							if(all(xx==0 & yy==0)==F) {

									####### [1] Find the "left" nearest efficient scenario in terms of x-value ###

									   ind1 = eff.x0 < xx  # left
									   x1= eff.x0[ind1][which.min(xx-eff.x0[ind1]) ];x1
									   y1= eff.y0[ind1][which.min(xx-eff.x0[ind1])];y1

									###### [2] find the "right" nearest efficient secnario #########

									   ind2 = eff.x0 >= xx  # left
									   x2= eff.x0[ind2][which.min(eff.x0[ind2]-xx) ];x2
									   y2= eff.y0[ind2][which.min(eff.x0[ind2]-xx)];y2

											### test if this was correct ##
											doThis=F
											if(doThis==T){

												plot(x,y,col="pink")
												points(x[indic],y[indic])

												points(eff.x0, eff.y0, col="red"); lines(eff.x0, eff.y0, col="red")
												points(eff.x, eff.y, col="red"); lines(eff.x, eff.y, col="red")

												points(xx,yy,pch="*",cex=1.5)
												points(x1,y1,col="blue",pch=17)
												points(x2,y2,col="dark green",pch=17)


												abline(a,b,lty="dotted")
											}#

									#####[3] FInd the segment that goes throgh (x1,y1) and (x2, y2)
										#  y = a + bx ;   b = (x2-x1)/(y2-y1); a = y1 - b*x1

									b = (y2-y1)/(x2-x1)
									a = y1 - b*x1

									##### [4] See if given y value is above the segment or not #######

									above = yy >= a + b*xx	 #[1] FASE

									### for the first point x1 and y1 is NOT defined ans above is logical(0)
									if(length(above)==0) above = F



							}#end of all==F


							above

					   }#end of my90.small

		       ####### run this small function for all scenarios #######

		       mat=cbind(x,y)
		       #my90.small(obs, thr.con, eff.x0, eff.y0)
		       in90=rep(NA,length(x))

		       for(u in 1:length(x)){

		             obs=c(x[u], y[u])
		             out0=my90.small(obs, thr.con, eff.x0, eff.y0);out0
		             in90[u]=out0

		       }#
		       #in90[104]

		      #in90 = as.vector(unlist( apply(mat, 1, my90.small, thr.con=thr.con, eff.x0=eff.x0, eff.y0=eff.y0)))

		      ### confirm ###

		      doThis=F
		      if(doThis==T){

					plot(x,y,col="pink",ylim=c(0,max(y,na.rm=T)))
					points(x[indic],y[indic])

					#points(eff.x0, eff.y0, col="red",pch="*"); lines(eff.x0, eff.y0, col="red")
					points(eff.x, eff.y, col="red"); lines(eff.x, eff.y, col="red")
					#points(x[row1],y[row1],col="blue")
					#points(x[row2],y[row2],col="blue")

					## minimum y ##

					#abline(h=a0,lty="dotted")

					## intercept to the steep
					#abline(a.h, b.h,lty="dotted")

					## this is the minimum slope that inclues all

					abline(a.low, b.low,col="blue")


					points(x[in90], y[in90], col="purple")
					#identify(x,y,1:length(x))

					points(eff.x,eff.y.low,col="blue")
					lines(eff.x,eff.y2,col="blue",lty="dotted")


				#plot(x,y,col="pink")
				#points(x[indic],y[indic])

				points(eff.x0, eff.y0, col="red",pch="*"); lines(eff.x0, eff.y0, col="red")
				points(eff.x, eff.y, col="red"); lines(eff.x, eff.y, col="red")

		      	points(x[in90], y[in90], col="purple")
		      	#identify(x,y,1:length(x))

		      }#end of


		       ans = list(indic=in90, out=cbind(x,y,labs)[in90,],a.low=a.low,b.low=b.low,  y90=eff.y2, x90=eff.x)
		       ans


		}#end of my90.new

						#### just put "out" to distinghsh from my90.small in other functions although they are the same
						my90.small.out <- function(obs, eff.x0, eff.y0){

							above=NA
							xx=obs[1]
							yy=obs[2]
							# > xx
							# [1] 629594.1
							# > yy
							# [1] 0.6929482
							# > cbind(eff.x0,eff.y0)
							#          eff.x0    eff.y0
							#  [1,]      0.00 0.0000000
							#  [2,]  39304.07 0.2289832
							#  [3,]  45188.76 0.2520689
							#  [4,]  50146.13 0.2701022
							#  [5,]  53703.76 0.2827614
							#  [6,]  65437.10 0.3221584
							#  [7,]  72648.30 0.3449792
							#  [8,]  77839.62 0.3606661
							#  [9,] 151326.81 0.5020752
							# [10,] 225994.63 0.6055065
							# [11,] 323327.69 0.7137820
							# [12,] 430880.99 0.7836256
							# [13,] 532294.53 0.8346600
							# [14,] 681839.07 0.8763467
							# [15,] 835660.48 0.9000000

							if(all(xx==0 & yy==0)==T) { above =F }

							if(all(xx==0 & yy==0)==F) {

									####### [1] Find the "left" nearest efficient scenario in terms of x-value ###

									   ind1 = eff.x0 < xx  # left
									   x1= eff.x0[ind1][which.min(xx-eff.x0[ind1]) ];x1
									   y1= eff.y0[ind1][which.min(xx-eff.x0[ind1])];y1

									###### [2] find the "right" nearest efficient secnario #########

									   ind2 = eff.x0 >= xx  # left
									   x2= eff.x0[ind2][which.min(eff.x0[ind2]-xx) ];x2
									   y2= eff.y0[ind2][which.min(eff.x0[ind2]-xx)];y2

											### test if this was correct ##
											doThis=F
											if(doThis==T){

												plot(x,y,col="pink")
												points(x[indic],y[indic])

												points(eff.x0, eff.y0, col="red"); lines(eff.x0, eff.y0, col="red")
												points(eff.x, eff.y, col="red"); lines(eff.x, eff.y, col="red")

												points(xx,yy,pch="*",cex=1.5)
												points(x1,y1,col="blue",pch=17)
												points(x2,y2,col="dark green",pch=17)


												abline(a,b,lty="dotted")
											}#

									#####[3] FInd the segment that goes throgh (x1,y1) and (x2, y2)
										#  y = a + bx ;   b = (x2-x1)/(y2-y1); a = y1 - b*x1

									b = (y2-y1)/(x2-x1)
									a = y1 - b*x1

									##### [4] See if given y value is above the segment or not #######

									above = yy >= a + b*xx	 #[1] FASE

									### for the first point x1 and y1 is NOT defined ans above is logical(0)
									if(length(above)==0) above = F



							}#end of all==F


							above

					   }#end of my90.small

		######## 3/27/2013 new 90% so it includes top k% closets points #########
		#### 3/26/2014: new 90% method using lower bound ######
		#### function for identifying indicator of scenario within 90% ######

		my90.new2 <- function(x,y, labs, thr.con, eff.x, eff.y, k=100){  # given efficient scenarios's x and y (eff.x and eff.y)
		       ## this evaluate each scenario and give a set of secnarios within 90% (thr.con) from ftontier
				# > cbind(eff.x,eff.y)
				#          eff.x     eff.y
				# [1,]  92503.92 0.7725457
				# [2,] 119565.39 0.8345462
				# [3,] 194017.23 0.9103151
				# [4,] 254079.77 0.9434881
				# [5,] 367875.28 0.9810432
				# [6,] 454429.33 1.0000000

				### [1] Then get 90 of the interval from the top ###

				#dif = eff.y - eff.y.low   # this is the difference   between upper and lower bound
				#[1] 0.2319563 0.2883113 0.3485485 0.3691915 0.3830072 0.3839074


				### use several fraction points
				thrs=seq(1,0,length.out=k)

				for(i in 1:length(thrs)){

					thr=thrs[i]
					eff.y.tm = eff.y*thr    ; eff.y.tm
					#eff.y.tm = eff.y - dif*(thr)   # line from 10% from the top

					#yy=y[157] #[1] 0.6929482
					eff.x0=eff.x
					eff.y0=eff.y.tm
					#obs = c(xx,yy);#dim(obs)=c(1,2)


				   ####### run this small function for all scenarios #######

				   mat=cbind(x,y)
				   #my90.small(obs, thr.con, eff.x0, eff.y0)
				   in90=rep(NA,length(x))

				   for(u in 1:length(x)){

						 obs=c(x[u], y[u])
						 out0=my90.small.out(obs, eff.x0, eff.y0);out0
						 in90[u]=out0

				   }#
				   #in90[104]
					sum(in90);length(in90)
					# [1] 92

				  nEff=length(eff.y) # # of efficient scenarios

				  ### fraction of scenarios that belong to this curve

				  #fr=(sum(in90,na.rm=T))/length(y[!is.na(y)])	; fr
				  #[1] 0.9583333                 ## this curve include top 95 % within the curve too many!
					### exclude # of nEff from the percent
				  fr=(sum(in90,na.rm=T)-nEff+1)/length(y[!is.na(y)])	; fr


				   if(i==1) frs=fr
				   if(i>1) frs=c(frs,fr)
		     	 #in90 = as.vector(unlist( apply(mat, 1, my90.small, thr.con=thr.con, eff.x0=eff.x0, eff.y0=eff.y0)))


							doThis=F
							if(doThis==T){

									plot(x,y,col="pink",ylim=c(0,max(y,na.rm=T)))
									points(x[indic],y[indic])

									#points(eff.x0, eff.y0, col="red",pch="*"); lines(eff.x0, eff.y0, col="red")
									points(eff.x, eff.y, col="red"); lines(eff.x, eff.y, col="red")
									#points(x[row1],y[row1],col="blue")
									#points(x[row2],y[row2],col="blue")

								points(eff.x0, eff.y0, col="red",pch="*"); lines(eff.x0, eff.y0, col="red")
								#points(eff.x, eff.y.tm, col="red"); lines(eff.x, eff.y, col="red")

								points(x[in90], y[in90], col="purple")


							}#


				}#end of u



				############# [3] Find the threshold that satisfy the thresold ######


			    #cbind(thrs,frs)[1:5,]
				# [1,] 1.000000 0.00000000
				# [2,] 0.989899 0.05208333
				# [3,] 0.979798 0.12500000
				# [4,] 0.969697 0.23958333
				# [5,] 0.959596 0.31250000

				### which has the closet one to the specified threshold. e.g. thr.con=0.9 --> top 10% is included in row=3
				best=which((abs(frs-(1-thr.con)))==min(abs(frs-(1-thr.con))));best #[1] 3


					#####calculate the curve for the best fit ##

					eff.y.tm =  eff.y*thrs[best[1]]   # line from 10% from the top
			        eff.x0=eff.x
					eff.y0=eff.y.tm
					#obs = c(xx,yy);#dim(obs)=c(1,2)
				   ####### run this small function for all scenarios #######

				   mat=cbind(x,y)
				   #my90.small(obs, thr.con, eff.x0, eff.y0)
				   in90=rep(NA,length(x))

				   for(u in 1:length(x)){

						 obs=c(x[u], y[u])
						 out0=my90.small.out(obs, eff.x0, eff.y0);out0
						 in90[u]=out0

				   }#
				   #in90[104]





				## 1-90% of the difference deducted from the top
				#eff.y2 = eff.y - dif*(1-thr.con)  # this is the 90 segment
				   # points(eff.x, eff.y2 col="red")
				#[1] 0.7493501 0.8057150 0.8754603 0.9065689 0.9427425 0.9616093
				# ----> this is new 90% Y




		      doThis=F
		      if(doThis==T){

					plot(x,y,col="pink",ylim=c(0,max(y,na.rm=T)))
					points(x[indic],y[indic])

					#points(eff.x0, eff.y0, col="red",pch="*"); lines(eff.x0, eff.y0, col="red")
					points(eff.x, eff.y, col="red"); lines(eff.x, eff.y, col="red")

				points(eff.x0, eff.y0, col="red",pch="*"); lines(eff.x0, eff.y0, col="red")
				#points(eff.x, eff.y, col="red"); lines(eff.x, eff.y, col="red",lty="dotted")

		      	points(x[in90], y[in90], col="purple")
		      	#identify(x,y,1:length(x))

		      }#end of


		       ans = list(indic=in90, out=cbind(x,y,labs)[in90,],a.low=NULL,b.low=NULL,  y90=eff.y0, x90=eff.x)
		       ans


		}#end of my90.new


		######## 4/14/2014 DEA method ################
		######## 3/27/2014 new 90% so it includes top k% closets points #########
		#### 3/26/2014: new 90% method using lower bound ######
		#### function for identifying indicator of scenario within 90% ######

		my90.new3 <- function(x,y, labs, thr.con,exclude.frontier=F){  # given efficient scenarios's x and y (eff.x and eff.y)
		       ## this evaluate each scenario and give a set of secnarios within 90% (thr.con) from ftontier
				# > cbind(eff.x,eff.y)
				#          eff.x     eff.y
				# [1,]  92503.92 0.7725457
				# [2,] 119565.39 0.8345462
				# [3,] 194017.23 0.9103151
				# [4,] 254079.77 0.9434881
				# [5,] 367875.28 0.9810432
				# [6,] 454429.33 1.0000000

				######## (2) run DEA to get efficient scores for each sceanrios ####
				# this is from R code Joey sent me: 14_0410_DEA_method.by.MGH_TLC_Rcode.R
				#y=dat.stf.f$Deaths.avoided100
				#x=dat.stf.f$CTscreens100
				#tab.dat = data.frame(y=y,x=x )
				#tab.dat = data.frame(y = output, x = input) # creating dataset with input and output only
				#out=dea(tab.dat, noutput = 1, orientation = 1, rts = 2) #orientation = 1(input) = 2(output)

				tab.dat = data.frame(y=y, x=x)
				out=dea(tab.dat, noutput = 1, orientation = 1, rts = 2)
				# > names(out)
				#  [1] "eff"      "lambda1"  "lambda2"  "lambda3"  "lambda4"  "lambda5"  "lambda6"  "lambda7"  "lambda8"
				# [10] "lambda9"  "lambda10" "lambda11" "lambda12" "lambda13" "lambda14" "lambda15" "lambda16" "lambda17"
				# [19] "lambda18" "lambda19" "lambda20" "lambda21" "lambda22" "lambda23" "lambda24" "lambda25" "lambda26"

				eff_score = out$eff #get efficiency scores from DEA (eff_Score: <=1 for input 1<= for output)
				# > eff_score[1:10]
				#  [1] 0.4189899 0.4625013 0.4872294 0.5120030 0.4348064 0.4786352 0.5054350 0.5243923 0.4467337 0.4670362



				#thr=quantile(eff_score, thr.con);thr
				if(exclude.frontier==F) thr=quantile(eff_score, thr.con)

				### calculate quantile after removing frontier scenarios
				if(exclude.frontier==T) thr=quantile(eff_score[eff_score < 0.99],   thr.con)

				#      75%
				# 0.932701
				indic.in = eff_score >=thr

				sum(indic.in)/length(indic.in)
				#[1] 0.25

				doThis=F
				if(doThis==T){


									plot(x,y,col="pink",ylim=c(0,max(y,na.rm=T)))
									points(x[indic],y[indic],col="red",pch=16)

									#points(eff.x0, eff.y0, col="red",pch="*"); lines(eff.x0, eff.y0, col="red")
									points(eff.x, eff.y, col="red"); lines(eff.x, eff.y, col="red")
									#points(x[row1],y[row1],col="blue")
									#points(x[row2],y[row2],col="blue")

									#points(eff.x0, eff.y0, col="red",pch="*"); lines(eff.x0, eff.y0, col="red")
									#points(eff.x, eff.y.tm, col="red"); lines(eff.x, eff.y, col="red")

									points(x[indic.in], y[indic.in], col="purple")



				}#end of

				score=cbind(x,y,eff.score=eff_score);row.names(score)=labs


		       ans = list(indic=indic.in, out=cbind(x,y,labs)[indic.in,],a.low=NULL,b.low=NULL,  y90=NULL, x90=NULL,score=score)
		       ans


		}#end of my90.new

		#x=c("T-60-75-40-10","T-55-75-40-20")

		getCTnum=function(x, MYDAT){

			# > MYDAT=mydat
			# > names(MYDAT)
			# [1] "Erasmus"  "FH"       "MGH"      "Stanford"
			# > MYDAT[[1]][1:3,]
			#                    scenario CTscreens90 death.avoided.per.over90
			# T-60-75-40-10 T-60-75-40-10    34514.14                 3.120493
			# T-55-75-40-10 T-55-75-40-10    40577.78                 3.733010
			# T-55-75-40-15 T-55-75-40-15    44886.74                 3.793696

		   for(u in 1:length(x)){

		   			xx=x[u]

		   			for(m in 1:length(MYDAT)){

		   				ct=MYDAT[[m]][row.names(MYDAT[[m]]) %in% xx,"CTscreens90"] #[1] 34514.14

		   				if(length(ct)>0) { ct2=ct }
		   				if(length(ct)==0) { ct2=NA }

		   				if(m==1) cts=ct2
		   				if(m>1) cts=c(cts,ct2)


		   			}#for(m in 1:length(MYDAT)){
		   			# cts
		   			#[1] 34514.14       NA       NA 37891.00

		   			ans0=mean(cts,na.rm=T)
		   			if(u==1) ans=ans0
		   			if(u>1) ans=c(ans,ans0)


		   }#

		   names(ans)=x
			# > ans
			# T-60-75-40-10 T-55-75-40-20
			#      36202.57      50525.00

			round(ans)


		}#getCTnum


			getConsensus.small <- function(mat,con.num){

				ind= rowSums(mat) >= con.num
				ans1=mat[ind,]
				#               Erasmus FH MGH Stanford
				# T-60-75-40-10       1  0   0        1
				# T-55-75-40-20       1  0   0        1
				# T-55-75-40-15       1  0   0        1
				# T-55-75-40-10       1  1   1        1
				# T-55-75-30-25       1  0   1        0
				# T-55-75-30-10       1  0   1        0


				if(is.null(dim(ans1))==T & length(ans1)==4) {
						dim(ans1)=c(1,length(ans1))
						colnames(ans1)=colnames(mat)
						row.names(ans1)=row.names(mat)[ind]


				}

				### sort by rowSums
				ans2=ans1[order(rowSums(ans1),decreasing=T),]



				if(is.null(dim(ans2))==T & length(ans2)==4) {
						dim(ans2)=c(1,length(ans2))
						colnames(ans2)=colnames(mat)
						row.names(ans2)=row.names(ans1)

				}



				ans2=cbind(ans2, sum=rowSums(ans2))
				#               Erasmus FH MGH Stanford sum
				# T-55-75-40-10       1  1   1        1   4
				# A-45-75-20-10       1  1   1        1   4
				# A-45-75-10-10       1  1   1        1   4
				# T-50-75-40-10       0  1   1        1   3
				# B-50-75-40-10       0  1   1        1   3
				# B-50-75-10-10       1  1   0        1   3
				# A-45-75-20-20       1  0   1        1   3
				# A-45-75-20-15       1  0   1        1   3
				# T-60-75-40-10       1  0   0        1   2
				# T-55-75-40-20       1  0   0        1   2

				#colSums(mat[ind,])
				#  Erasmus       FH      MGH Stanford
				#       23       12       23       15

				ans2

		}#getConsensus.small



				getIndic.scn=function(x,Models,myans){


						ind.mat = matrix(NA,length(x), ncol=length(Models))
						colnames(ind.mat)=Models; row.names(ind.mat)=x


						for(u in 1:length(x)){

								sc=x[u]; #[1] "T-55-75-30-20"

								for(m in 1:length(Models)){    ind.mat[u,m] = (sc %in% myans[[m]])*1   }


						}#3nd of

						ind.mat

		       }#end of getIndic.scn



		myPlotConseusns=function(dat1, scns.con, con.score,thr.con, newY, annualOnly, Main0, MD=""){

				########### change the column name "Freq-Start-Stop..." to "scenario" ####
				mydat0=dat1
				colnames(mydat0)[grep("Freq",colnames(mydat0))]="scenario"

				### exclude:
				#A-55-57-30-15
				#A-62-64-30-15

				########### [1] take out two small scenarios ####################

				indic = as.character(mydat0[,"scenario"])  %in% c("A-55-57-30-15","A-62-64-30-15")
				sum(indic)
				mydat=mydat0[!indic,]
				dim(mydat)

				### make start, stop, py and ysq variables ###
				sc=as.character(mydat[,"scenario"])
				sc[1:10]
				#  [1] "NoScreen"      "A-45-75-10-10" "B-45-75-10-10" "T-45-75-10-10" "A-45-75-10-15"
				#  [6] "B-45-75-10-15" "T-45-75-10-15" "A-45-75-10-20" "B-45-75-10-20" "T-45-75-10-20"

				### change "NoScreen" to "NA-NA-NA-NA-NA" format

				sc2=gsub("NoScreen","NA-NA-NA-NA-NA",sc)
				tm1=unlist(strsplit(sc2,split="-"))

				freq = tm1[seq(1,length(tm1), by=5)] ; freq[freq=="NA"]=NA
				age.start = tm1[seq(2,length(tm1), by=5)];  age.start[age.start=="NA"]=NA
				age.stop = tm1[seq(3,length(tm1), by=5)]; age.stop[age.stop=="NA"]=NA
				PY = tm1[seq(4,length(tm1), by=5)]; PY[PY=="NA"]=NA
				YSQ = tm1[seq(5,length(tm1), by=5)]; YSQ[YSQ=="NA"]=NA

				mydat=data.frame(mydat,age.interval=freq, age.start=age.start, age.stop=age.stop, py=PY, ysq=YSQ)


				####################### (1) efficient scneario using Old Y ###############################

				xname="CTscreens90"
				scname="scenario"
				WRITE=T


				##### ALl scenarios ####
				if(annualOnly==T)	DATA = mydat[ grep("A-",as.character(mydat[,"scenario"])),]
				if(annualOnly==F)	DATA = mydat

				if(newY==F){

						y=DATA[,"Deaths.avoided90"]/max(mydat[,"Deaths.avoided90"],na.rm=T)
						mydatt=cbind(DATA, death.avoided.percent.90=y)
						yname="death.avoided.percent.90"
						putZero=F
						YLIM=c(0,1)
						#tt1=myUS.plots.big.general(MYDAT,HEAD,xname,yname, sname, WRITE)
						HEAD=Main0

						if(sum(is.na(y))>0) putZero=T   # it's about whether NoScreen has NA or 0
						if(sum(is.na(y))==0) putZero=F

				}#

				if(newY==T){

						y=DATA[,"Deaths.avoided90"]/DATA[,"LCcasesOver90"]
						mydatt=cbind(DATA, death.avoided.per.over90=y)
						yname="death.avoided.per.over90"
						YLIM=c(0,7)
						putZero=T # noScreen Y=0
						HEAD=Main0


				}#

				MYDAT=mydatt
				tt1=myUS.plots.big.general.over2b(MYDAT,HEAD,xname,yname, sname, WRITE=F,putZero,YLIM,thr.con,scns.con, con.score,MD,scname)




		}#end of myPlotConseusns=function()

		##### 3/13/2014: extend so it takes arguments: interval, starting.age instead of annual only
	myPlotConseusns2=function(dat1, scns.con, con.score,thr.con, newY, interval=c("A","B"), starting.age=c(55,60), Main0, MD=""){

				########### change the column name "Freq-Start-Stop..." to "scenario" ####
				mydat0=dat1
				colnames(mydat0)[grep("Freq",colnames(mydat0))]="scenario"

				### exclude:
				#A-55-57-30-15
				#A-62-64-30-15

				########### [1] take out two small scenarios ####################

				indic = as.character(mydat0[,"scenario"])  %in% c("A-55-57-30-15","A-62-64-30-15")
				sum(indic)
				mydat=mydat0[!indic,]
				dim(mydat)

				### make start, stop, py and ysq variables ###
				sc=as.character(mydat[,"scenario"])
				sc[1:10]
				#  [1] "NoScreen"      "A-45-75-10-10" "B-45-75-10-10" "T-45-75-10-10" "A-45-75-10-15"
				#  [6] "B-45-75-10-15" "T-45-75-10-15" "A-45-75-10-20" "B-45-75-10-20" "T-45-75-10-20"

				### change "NoScreen" to "NA-NA-NA-NA-NA" format

				sc2=gsub("NoScreen","NA-NA-NA-NA-NA",sc)
				tm1=unlist(strsplit(sc2,split="-"))

				freq = tm1[seq(1,length(tm1), by=5)] ; freq[freq=="NA"]=NA
				age.start = tm1[seq(2,length(tm1), by=5)];  age.start[age.start=="NA"]=NA
				age.stop = tm1[seq(3,length(tm1), by=5)]; age.stop[age.stop=="NA"]=NA
				PY = tm1[seq(4,length(tm1), by=5)]; PY[PY=="NA"]=NA
				YSQ = tm1[seq(5,length(tm1), by=5)]; YSQ[YSQ=="NA"]=NA

				mydat=data.frame(mydat,age.interval=freq, age.start=age.start, age.stop=age.stop, py=PY, ysq=YSQ)

				##################### [1] extract right A and B only
				# > interval
				# [1] "A" "B"

				rows1 = multiGrep(paste(interval,"-",sep=""), as.character(mydat[,"scenario"]))
				indic1 = (1:nrow(mydat)) %in% rows1
				#as.character(mydat[,"scenario"])[rows1]

				###### [2] extract right starting age only ###

				# > starting.age
				# [1] 55 60
				indic2=as.numeric(age.start) %in% starting.age

				indic = indic1==T & indic2==T

				mydat.subset = mydat[indic,]
				mydat.subset[,1]
				dim(mydat.subset)
				#[1] 192  77

				####################### (3) efficient scneario  ###############################

				xname="CTscreens90"
				scname="scenario"
				WRITE=T


				if(newY==F){

						y=mydat.subset[,"Deaths.avoided90"]/max(mydat.subset[,"Deaths.avoided90"],na.rm=T)
						mydatt=cbind(mydat.subset, death.avoided.percent.90=y)
						yname="death.avoided.percent.90"
						putZero=F
						YLIM=c(0,1)

				}#end newY==F



				if(newY==T){

						y=mydat.subset[,"Deaths.avoided90"]/mydat.subset[,"LCcasesOver90"]
						mydatt=cbind(mydat.subset, death.avoided.per.over90=y)
						yname="death.avoided.per.over90"
						putZero=T
						YLIM=c(0,7)

				}#end of newT


				HEAD=Main0
				#HEAD2=paste("Annual Only",HEAD)
				HEAD2=paste(paste(interval,collapse=","), " & start.age:",paste(starting.age,collapse=","),"","\n",HEAD,sep="")
				HEAD2
				tt1b=myUS.plots.big.general.over2b(mydatt,HEAD2,xname,yname, sname, WRITE=F,putZero,YLIM,thr.con,scns.con, con.score, MD,scname)


		}#end of myPlotConseusns2=function()


	##### 3/26/2014: extend with method=1,2,3 and alpha ####################
	##### 3/13/2014: extend so it takes arguments: interval, starting.age instead of annual only
	myPlotConseusns3=function(dat1, scns.con, con.score,thr.con, newY, interval=c("A","B"), starting.age=c(55,60), Main0, MD=""){

				########### change the column name "Freq-Start-Stop..." to "scenario" ####
				mydat0=dat1
				colnames(mydat0)[grep("Freq",colnames(mydat0))]="scenario"

				### exclude:
				#A-55-57-30-15
				#A-62-64-30-15

				########### [1] take out two small scenarios ####################

				indic = as.character(mydat0[,"scenario"])  %in% c("A-55-57-30-15","A-62-64-30-15")
				sum(indic)
				mydat=mydat0[!indic,]
				dim(mydat)

				### make start, stop, py and ysq variables ###
				sc=as.character(mydat[,"scenario"])
				sc[1:10]
				#  [1] "NoScreen"      "A-45-75-10-10" "B-45-75-10-10" "T-45-75-10-10" "A-45-75-10-15"
				#  [6] "B-45-75-10-15" "T-45-75-10-15" "A-45-75-10-20" "B-45-75-10-20" "T-45-75-10-20"

				### change "NoScreen" to "NA-NA-NA-NA-NA" format

				sc2=gsub("NoScreen","NA-NA-NA-NA-NA",sc)
				tm1=unlist(strsplit(sc2,split="-"))

				freq = tm1[seq(1,length(tm1), by=5)] ; freq[freq=="NA"]=NA
				age.start = tm1[seq(2,length(tm1), by=5)];  age.start[age.start=="NA"]=NA
				age.stop = tm1[seq(3,length(tm1), by=5)]; age.stop[age.stop=="NA"]=NA
				PY = tm1[seq(4,length(tm1), by=5)]; PY[PY=="NA"]=NA
				YSQ = tm1[seq(5,length(tm1), by=5)]; YSQ[YSQ=="NA"]=NA

				mydat=data.frame(mydat,age.interval=freq, age.start=age.start, age.stop=age.stop, py=PY, ysq=YSQ)

				##################### [1] extract right A and B only
				# > interval
				# [1] "A" "B"

				rows1 = multiGrep(paste(interval,"-",sep=""), as.character(mydat[,"scenario"]))
				indic1 = (1:nrow(mydat)) %in% rows1
				#as.character(mydat[,"scenario"])[rows1]

				###### [2] extract right starting age only ###

				# > starting.age
				# [1] 55 60
				indic2=as.numeric(age.start) %in% starting.age

				indic = indic1==T & indic2==T

				mydat.subset = mydat[indic,]
				mydat.subset[,1]
				dim(mydat.subset)
				#[1] 192  77

				####################### (3) efficient scneario  ###############################

				xname="CTscreens90"
				scname="scenario"
				WRITE=T


				if(newY==F){

						y=mydat.subset[,"Deaths.avoided90"]/max(mydat.subset[,"Deaths.avoided90"],na.rm=T)
						mydatt=cbind(mydat.subset, death.avoided.percent.90=y)
						yname="death.avoided.percent.90"
						putZero=F
						YLIM=c(0,1)

				}#end newY==F



				if(newY==T){

						y=mydat.subset[,"Deaths.avoided90"]/mydat.subset[,"LCcasesOver90"]
						mydatt=cbind(mydat.subset, death.avoided.per.over90=y)
						yname="death.avoided.per.over90"
						putZero=T
						YLIM=c(0,7)

				}#end of newT


				HEAD=Main0
				#HEAD2=paste("Annual Only",HEAD)
				HEAD2=paste(paste(interval,collapse=","), " & start.age:",paste(starting.age,collapse=","),"","\n",HEAD,sep="")
				HEAD2
				tt1b=myUS.plots.big.general.over2b(mydatt,HEAD2,xname,yname, sname, WRITE=F,putZero,YLIM,thr.con,scns.con, con.score, MD,scname)


		}#end of myPlotConseusns2=function()




myConsensus <- function(outFiles,Models,newY,annualOnly,thr.con, con.num,gender){  ## from 90% output get consensus scenarios
				# con.num is # of models in consensus for threshold


		myans=rep(list(list()),length(Models))
		names(myans)=Models
		MYDAT=myans

		##### [1] read output files ###
		for(m in 1:length(outFiles)){

			   myfile = outFiles[m]
			   dat0=read.csv(myfile)[,-1]
			   row.names(dat0)=dat0[,1]
				# > dat0[1:10,]
				#                    scenario CTscreens90 death.avoided.per.over90
				# T-60-75-40-10 T-60-75-40-10       48914                 1.587629
				# T-55-75-40-10 T-55-75-40-10       66429                 1.956522
				# B-60-75-40-10 B-60-75-40-10       67466                 2.029412
				# B-60-75-30-10 B-60-75-30-10       96521                 2.383929
				# B-60-75-20-10 B-60-75-20-10      103849                 2.387931
				# B-60-75-30-15 B-60-75-30-15      110571                 2.363636
				# B-60-75-30-20 B-60-75-30-20      123135                 2.365079
				# B-60-75-20-15 B-60-75-20-15      123425                 2.384000
				# B-50-75-40-10 B-50-75-40-10      126853                 2.415254
				# B-60-75-30-25 B-60-75-30-25      133579                 2.389313

				sc=as.character(dat0[,"scenario"])
				myans[[m]]=sc
				MYDAT[[m]]=dat0

		}#for(m in 1:length(Models)){

		scs.u = rev(sort(unique(as.vector(unlist(myans)))))


		### [2] each unique scenario to see if it belongs how many models ####
		x=scs.u
		ind.mat=getIndic.scn(x,Models,myans); ind.mat
		#               Erasmus FH MGH Stanford
		# A-60-75-40-25       1  0   0        0
		# A-60-75-40-20       1  0   0        0
		# A-60-75-40-15       1  1   0        0
		# A-60-75-30-15       0  0   0        1
		# A-60-75-30-10       1  0   0        1
		# A-60-75-20-10       0  0   0        1
		# A-55-75-40-20       1  0   0        0
		# A-55-75-40-15       1  1   0        0
		# A-55-75-40-10       1  1   1        1
		# A-55-75-30-25       0  0   0        1

		## given indicator matrix, extract scenario that has the most number of consensus ##

		mat=ind.mat
		con.scn= getConsensus.small(mat,con.num)
		#               Erasmus FH MGH Stanford sum
		# T-55-75-40-10       1  1   1        1   4
		# A-45-75-20-10       1  1   1        1   4
		# A-45-75-10-10       1  1   1        1   4
		# T-50-75-40-10       0  1   1        1   3
		# B-50-75-40-10       0  1   1        1   3
		# B-50-75-10-10       1  1   0        1   3
		# A-45-75-20-20       1  0   1        1   3
		# A-45-75-20-15       1  0   1        1   3


		### [3] Get average number of # CT scans for the given scenario ####

		#x=c("T-60-75-40-10","T-55-75-40-20")
		x=row.names(con.scn)
		nCT=getCTnum(x, MYDAT)

		OUT=cbind(con.scn, nCT=nCT);OUT
		#               Erasmus FH MGH Stanford sum       nCT  FEMALE
		# T-55-75-40-10       1  1   1        1   4  40470.04
		# A-45-75-20-10       1  1   1        1   4 423468.28
		# A-45-75-10-10       1  1   1        1   4 532392.23
		# T-50-75-40-10       0  1   1        1   3  49563.80
		# B-50-75-40-10       0  1   1        1   3  71586.47
		# B-50-75-10-10       1  1   0        1   3 206598.17
		# A-45-75-20-20       1  0   1        1   3 517242.10
		# A-45-75-20-15       1  0   1        1   3 477564.60

		#               Erasmus FH MGH Stanford sum       nCT   MALE
		# T-60-75-40-10       1  1   1        1   4  47815.38
		# A-45-75-20-10       1  1   1        1   4 575149.20
		# A-45-75-10-10       1  1   1        1   4 686005.44
		# T-55-75-40-10       1  0   1        1   3  62921.19
		# B-50-75-40-10       1  0   1        1   3 117319.32
		# B-50-75-30-10       1  0   1        1   3 175890.49
		# B-50-75-10-10       1  0   1        1   3 269632.38
		# B-45-75-10-10       1  1   1        0   3 346061.28
		# A-50-75-10-10       1  0   1        1   3 522785.35
		# A-45-75-20-15       1  1   0        1   3 670503.84


		#               Erasmus FH MGH Stanford sum      nCT female
		# A-55-75-40-10       1  1   1        1   4 117068.6
		# A-50-75-40-10       1  1   1        1   4 141873.8
		# A-50-75-30-10       1  1   1        1   4 243783.8
		# A-45-75-40-10       1  1   1        1   4 166203.9
		# A-45-75-30-10       1  1   1        1   4 287895.6
		# A-45-75-20-10       1  1   1        1   4 423468.3
		# A-45-75-10-10       1  1   1        1   4 532392.2
		# A-60-75-40-15       1  0   1        1   3 103841.7
		# A-55-75-40-15       1  0   1        1   3 135170.5
		# A-55-75-30-10       1  0   1        1   3 184428.0
		# A-50-75-40-20       1  0   1        1   3 170137.1
		# A-50-75-40-15       1  0   1        1   3 161215.4
		# A-50-75-20-10       1  0   1        1   3 337972.5
		# A-45-75-40-15       1  0   1        1   3 185446.1
		# A-45-75-30-15       1  0   1        1   3 320159.6
		# A-45-75-20-20       1  0   1        1   3 517242.1
		# A-45-75-20-15       1  0   1        1   3 477564.6


		#               Erasmus FH MGH Stanford sum      nCT male
		# A-55-75-40-10       1  1   1        1   4 179533.0
		# A-50-75-20-10       1  1   1        1   4 432849.8
		# A-45-75-30-15       1  1   1        1   4 468530.2
		# A-45-75-30-10       1  1   1        1   4 428104.2
		# A-45-75-20-10       1  1   1        1   4 575149.2
		# A-45-75-10-10       1  1   1        1   4 686005.4
		# A-50-75-40-10       1  1   1        0   3 228284.6
		# A-50-75-30-25       1  0   1        1   3 436391.8
		# A-50-75-30-20       1  0   1        1   3 413524.2
		# A-50-75-30-10       1  0   1        1   3 342025.6
		# A-50-75-10-10       1  0   1        1   3 522785.3
		# A-45-75-40-10       1  1   1        0   3 269974.4
		# A-45-75-30-20       1  0   1        1   3 497480.8
		# A-45-75-20-15       1  1   0        1   3 670503.8

		CON = row.names(OUT)
		#  [1] "A-55-75-40-10" "A-50-75-20-10" "A-45-75-30-15" "A-45-75-30-10" "A-45-75-20-10" "A-45-75-10-10"
		#  [7] "A-50-75-40-10" "A-50-75-30-25" "A-50-75-30-20" "A-50-75-30-10" "A-50-75-10-10" "A-45-75-40-10"
		# [13] "A-45-75-30-20" "A-45-75-20-15"


		##### [3] Add two more scenarios ####################
		#x=c("A-55-75-30-15","A-55-80-30-15")


		#mat1=getIndic.scn(x,Models,myans)
		#mat2=cbind(mat1,nCT=getCTnum(x, MYDAT))

		scns.con=CON
		con.score = OUT[,"sum"]

		print(OUT)

		###########  [3] draw the scenario in each model's plot ###############

		for(m in 1:length(Models)){

				MD=Models[m];MD  #[1] "Erasmus"

				############## (1) Define input data ###############

				if(MD=="Erasmus")  {  dat.f = dat.ers.f   ;  dat.m = dat.ers.m    ; histo = c("AD.BAC.LC","SQ","SC","NSCO")  }
				if(MD=="FH") 	   {  dat.f = dat.fh.f    ;  dat.m = dat.fh.m ; histo = c("BAC","AD","SQ","LC","SC","NSCO") }
				if(MD=="MGH")      {  dat.f = dat.mgh.f   ;  dat.m = dat.mgh.m ; histo = c("BAC","AD","SQ","LC","SC","NSCO") }
				if(MD=="Stanford") {  dat.f = dat.stf.f   ;  dat.m = dat.stf.m ; histo=c("BAC","AD","SQ","LC","SC") }
				if(MD=="MCH")      {  dat.f = dat.mch.f   ;  dat.m = dat.mch.m  }


				if(gender=="Female")  dat1=dat.f
				if(gender=="Male")    dat1=dat.m

				Main0=MAIN=paste("[",MD,"-",gender,"] ",sep="");Main0

				myPlotConseusns(dat1, scns.con, con.score,thr.con, newY, annualOnly, Main0, MD)

		}#end of


		OUT
		#               Erasmus FH MGH Stanford sum      nCT
		# A-55-75-40-10       1  1   1        1   4 117068.6
		# A-50-75-40-10       1  1   1        1   4 141873.8
		# A-50-75-30-10       1  1   1        1   4 243783.8
		# A-45-75-40-10       1  1   1        1   4 166203.9
		# A-45-75-30-10       1  1   1        1   4 287895.6
		# A-45-75-20-10       1  1   1        1   4 423468.3
		# A-45-75-10-10       1  1   1        1   4 532392.2
		# A-60-75-40-15       1  0   1        1   3 103841.7
		# A-55-75-40-15       1  0   1        1   3 135170.5
		# A-55-75-30-10       1  0   1        1   3 184428.0
		# A-50-75-40-20       1  0   1        1   3 170137.1
		# A-50-75-40-15       1  0   1        1   3 161215.4
		# A-50-75-20-10       1  0   1        1   3 337972.5
		# A-45-75-40-15       1  0   1        1   3 185446.1
		# A-45-75-30-15       1  0   1        1   3 320159.6
		# A-45-75-20-20       1  0   1        1   3 517242.1
		# A-45-75-20-15       1  0   1        1   3 477564.6


}#end of myConsensus



####### 3/13/2012: extend to include argument for starting.age, interval etc
myConsensus2 <- function(outFiles,Models,newY,thr.con, interval=c("A","B"), starting.age=c(55,60),con.num,gender){  ## from 90% output get consensus scenarios
				# con.num is # of models in consensus for threshold


		myans=rep(list(list()),length(Models))
		names(myans)=Models
		MYDAT=myans

		##### [1] read output files ###
		for(m in 1:length(outFiles)){

			   myfile = outFiles[m]
			   dat0=read.csv(myfile)[,-1]
			   row.names(dat0)=dat0[,1]
				# > dat0[1:10,]
				#                    scenario CTscreens90 death.avoided.per.over90
				# T-60-75-40-10 T-60-75-40-10       48914                 1.587629
				# T-55-75-40-10 T-55-75-40-10       66429                 1.956522
				# B-60-75-40-10 B-60-75-40-10       67466                 2.029412
				# B-60-75-30-10 B-60-75-30-10       96521                 2.383929
				# B-60-75-20-10 B-60-75-20-10      103849                 2.387931
				# B-60-75-30-15 B-60-75-30-15      110571                 2.363636
				# B-60-75-30-20 B-60-75-30-20      123135                 2.365079
				# B-60-75-20-15 B-60-75-20-15      123425                 2.384000
				# B-50-75-40-10 B-50-75-40-10      126853                 2.415254
				# B-60-75-30-25 B-60-75-30-25      133579                 2.389313

				sc=as.character(dat0[,"scenario"])
				myans[[m]]=sc
				MYDAT[[m]]=dat0

		}#for(m in 1:length(Models)){

		scs.u = rev(sort(unique(as.vector(unlist(myans)))))


		### [2] each unique scenario to see if it belongs how many models ####
		x=scs.u
		ind.mat=getIndic.scn(x,Models,myans); ind.mat
		#               Erasmus FH MGH Stanford
		# A-60-75-40-25       1  0   0        0
		# A-60-75-40-20       1  0   0        0
		# A-60-75-40-15       1  1   0        0
		# A-60-75-30-15       0  0   0        1
		# A-60-75-30-10       1  0   0        1
		# A-60-75-20-10       0  0   0        1
		# A-55-75-40-20       1  0   0        0
		# A-55-75-40-15       1  1   0        0
		# A-55-75-40-10       1  1   1        1
		# A-55-75-30-25       0  0   0        1

		## given indicator matrix, extract scenario that has the most number of consensus ##

		mat=ind.mat
		con.scn= getConsensus.small(mat,con.num)
		#               Erasmus FH MGH Stanford sum
		# T-55-75-40-10       1  1   1        1   4
		# A-45-75-20-10       1  1   1        1   4
		# A-45-75-10-10       1  1   1        1   4
		# T-50-75-40-10       0  1   1        1   3
		# B-50-75-40-10       0  1   1        1   3
		# B-50-75-10-10       1  1   0        1   3
		# A-45-75-20-20       1  0   1        1   3
		# A-45-75-20-15       1  0   1        1   3


		### [3] Get average number of # CT scans for the given scenario ####

		#x=c("T-60-75-40-10","T-55-75-40-20")
		x=row.names(con.scn)
		nCT=getCTnum(x, MYDAT)

		OUT=cbind(con.scn, nCT=nCT);OUT
		#               Erasmus FH MGH Stanford sum       nCT  FEMALE
		# T-55-75-40-10       1  1   1        1   4  40470.04
		# A-45-75-20-10       1  1   1        1   4 423468.28
		# A-45-75-10-10       1  1   1        1   4 532392.23
		# T-50-75-40-10       0  1   1        1   3  49563.80
		# B-50-75-40-10       0  1   1        1   3  71586.47
		# B-50-75-10-10       1  1   0        1   3 206598.17
		# A-45-75-20-20       1  0   1        1   3 517242.10
		# A-45-75-20-15       1  0   1        1   3 477564.60

		#               Erasmus FH MGH Stanford sum       nCT   MALE
		# T-60-75-40-10       1  1   1        1   4  47815.38
		# A-45-75-20-10       1  1   1        1   4 575149.20
		# A-45-75-10-10       1  1   1        1   4 686005.44
		# T-55-75-40-10       1  0   1        1   3  62921.19
		# B-50-75-40-10       1  0   1        1   3 117319.32
		# B-50-75-30-10       1  0   1        1   3 175890.49
		# B-50-75-10-10       1  0   1        1   3 269632.38
		# B-45-75-10-10       1  1   1        0   3 346061.28
		# A-50-75-10-10       1  0   1        1   3 522785.35
		# A-45-75-20-15       1  1   0        1   3 670503.84


		#               Erasmus FH MGH Stanford sum      nCT female
		# A-55-75-40-10       1  1   1        1   4 117068.6
		# A-50-75-40-10       1  1   1        1   4 141873.8
		# A-50-75-30-10       1  1   1        1   4 243783.8
		# A-45-75-40-10       1  1   1        1   4 166203.9
		# A-45-75-30-10       1  1   1        1   4 287895.6
		# A-45-75-20-10       1  1   1        1   4 423468.3
		# A-45-75-10-10       1  1   1        1   4 532392.2
		# A-60-75-40-15       1  0   1        1   3 103841.7
		# A-55-75-40-15       1  0   1        1   3 135170.5
		# A-55-75-30-10       1  0   1        1   3 184428.0
		# A-50-75-40-20       1  0   1        1   3 170137.1
		# A-50-75-40-15       1  0   1        1   3 161215.4
		# A-50-75-20-10       1  0   1        1   3 337972.5
		# A-45-75-40-15       1  0   1        1   3 185446.1
		# A-45-75-30-15       1  0   1        1   3 320159.6
		# A-45-75-20-20       1  0   1        1   3 517242.1
		# A-45-75-20-15       1  0   1        1   3 477564.6


		#               Erasmus FH MGH Stanford sum      nCT male
		# A-55-75-40-10       1  1   1        1   4 179533.0
		# A-50-75-20-10       1  1   1        1   4 432849.8
		# A-45-75-30-15       1  1   1        1   4 468530.2
		# A-45-75-30-10       1  1   1        1   4 428104.2
		# A-45-75-20-10       1  1   1        1   4 575149.2
		# A-45-75-10-10       1  1   1        1   4 686005.4
		# A-50-75-40-10       1  1   1        0   3 228284.6
		# A-50-75-30-25       1  0   1        1   3 436391.8
		# A-50-75-30-20       1  0   1        1   3 413524.2
		# A-50-75-30-10       1  0   1        1   3 342025.6
		# A-50-75-10-10       1  0   1        1   3 522785.3
		# A-45-75-40-10       1  1   1        0   3 269974.4
		# A-45-75-30-20       1  0   1        1   3 497480.8
		# A-45-75-20-15       1  1   0        1   3 670503.8

		CON = row.names(OUT)
		#  [1] "A-55-75-40-10" "A-50-75-20-10" "A-45-75-30-15" "A-45-75-30-10" "A-45-75-20-10" "A-45-75-10-10"
		#  [7] "A-50-75-40-10" "A-50-75-30-25" "A-50-75-30-20" "A-50-75-30-10" "A-50-75-10-10" "A-45-75-40-10"
		# [13] "A-45-75-30-20" "A-45-75-20-15"


		##### [3] Add two more scenarios ####################
		#x=c("A-55-75-30-15","A-55-80-30-15")


		#mat1=getIndic.scn(x,Models,myans)
		#mat2=cbind(mat1,nCT=getCTnum(x, MYDAT))

		scns.con=CON
		con.score = OUT[,"sum"]

		print(OUT)

		###########  [3] draw the scenario in each model's plot ###############

		for(m in 1:length(Models)){

				MD=Models[m];MD  #[1] "Erasmus"

				############## (1) Define input data ###############

				if(MD=="Erasmus")  {  dat.f = dat.ers.f   ;  dat.m = dat.ers.m    ; histo = c("AD.BAC.LC","SQ","SC","NSCO")  }
				if(MD=="FH") 	   {  dat.f = dat.fh.f    ;  dat.m = dat.fh.m ; histo = c("BAC","AD","SQ","LC","SC","NSCO") }
				if(MD=="MGH")      {  dat.f = dat.mgh.f   ;  dat.m = dat.mgh.m ; histo = c("BAC","AD","SQ","LC","SC","NSCO") }
				if(MD=="Stanford") {  dat.f = dat.stf.f   ;  dat.m = dat.stf.m ; histo=c("BAC","AD","SQ","LC","SC") }
				if(MD=="MCH")      {  dat.f = dat.mch.f   ;  dat.m = dat.mch.m  }


				if(gender=="Female")  dat1=dat.f
				if(gender=="Male")    dat1=dat.m

				Main0=MAIN=paste("[",MD,"-",gender,"] ",sep="");Main0

				myPlotConseusns2(dat1, scns.con, con.score,thr.con, newY, interval, starting.age, Main0, MD)

		}#end of


		OUT
		#               Erasmus FH MGH Stanford sum      nCT
		# A-55-75-40-10       1  1   1        1   4 117068.6
		# A-50-75-40-10       1  1   1        1   4 141873.8
		# A-50-75-30-10       1  1   1        1   4 243783.8
		# A-45-75-40-10       1  1   1        1   4 166203.9
		# A-45-75-30-10       1  1   1        1   4 287895.6
		# A-45-75-20-10       1  1   1        1   4 423468.3
		# A-45-75-10-10       1  1   1        1   4 532392.2
		# A-60-75-40-15       1  0   1        1   3 103841.7
		# A-55-75-40-15       1  0   1        1   3 135170.5
		# A-55-75-30-10       1  0   1        1   3 184428.0
		# A-50-75-40-20       1  0   1        1   3 170137.1
		# A-50-75-40-15       1  0   1        1   3 161215.4
		# A-50-75-20-10       1  0   1        1   3 337972.5
		# A-45-75-40-15       1  0   1        1   3 185446.1
		# A-45-75-30-15       1  0   1        1   3 320159.6
		# A-45-75-20-20       1  0   1        1   3 517242.1
		# A-45-75-20-15       1  0   1        1   3 477564.6


}#end of myConsensus


####### 3/26/2014 incorporate method=1,2,3 and alpha ###########
####### 3/13/2012: extend to include argument for starting.age, interval etc
myConsensus3 <- function(outFiles,Models,method, alpha, thr.con, interval=c("A","B"), starting.age=c(55,60),con.num,gender){  ## from 90% output get consensus scenarios
				# con.num is # of models in consensus for threshold


		myans=rep(list(list()),length(Models))
		names(myans)=Models
		MYDAT=myans

		##### [1] read output files ###
		for(m in 1:length(outFiles)){

			   myfile = outFiles[m]
			   dat0=read.csv(myfile)[,-1]
			   row.names(dat0)=dat0[,1]
				# > dat0[1:10,]
				#                    scenario CTscreens90 death.avoided.per.over90
				# T-60-75-40-10 T-60-75-40-10       48914                 1.587629
				# T-55-75-40-10 T-55-75-40-10       66429                 1.956522
				# B-60-75-40-10 B-60-75-40-10       67466                 2.029412
				# B-60-75-30-10 B-60-75-30-10       96521                 2.383929
				# B-60-75-20-10 B-60-75-20-10      103849                 2.387931
				# B-60-75-30-15 B-60-75-30-15      110571                 2.363636
				# B-60-75-30-20 B-60-75-30-20      123135                 2.365079
				# B-60-75-20-15 B-60-75-20-15      123425                 2.384000
				# B-50-75-40-10 B-50-75-40-10      126853                 2.415254
				# B-60-75-30-25 B-60-75-30-25      133579                 2.389313

				sc=as.character(dat0[,"scenario"])
				myans[[m]]=sc
				MYDAT[[m]]=dat0

		}#for(m in 1:length(Models)){

		scs.u = rev(sort(unique(as.vector(unlist(myans)))))


		### [2] each unique scenario to see if it belongs how many models ####
		x=scs.u
		ind.mat=getIndic.scn(x,Models,myans); ind.mat
		#               Erasmus FH MGH Stanford
		# A-60-75-40-25       1  0   0        0
		# A-60-75-40-20       1  0   0        0
		# A-60-75-40-15       1  1   0        0
		# A-60-75-30-15       0  0   0        1
		# A-60-75-30-10       1  0   0        1
		# A-60-75-20-10       0  0   0        1
		# A-55-75-40-20       1  0   0        0
		# A-55-75-40-15       1  1   0        0
		# A-55-75-40-10       1  1   1        1
		# A-55-75-30-25       0  0   0        1

		## given indicator matrix, extract scenario that has the most number of consensus ##

		mat=ind.mat
		con.scn= getConsensus.small(mat,con.num);con.scn
		#               Erasmus FH MGH Stanford sum
		# T-55-75-40-10       1  1   1        1   4
		# A-45-75-20-10       1  1   1        1   4
		# A-45-75-10-10       1  1   1        1   4
		# T-50-75-40-10       0  1   1        1   3
		# B-50-75-40-10       0  1   1        1   3
		# B-50-75-10-10       1  1   0        1   3
		# A-45-75-20-20       1  0   1        1   3
		# A-45-75-20-15       1  0   1        1   3


		### [3] Get average number of # CT scans for the given scenario ####

		#x=c("T-60-75-40-10","T-55-75-40-20")
		x=row.names(con.scn)
		nCT=getCTnum(x, MYDAT)

		OUT=cbind(con.scn, nCT=nCT);OUT
		#               Erasmus FH MGH Stanford sum       nCT  FEMALE
		# T-55-75-40-10       1  1   1        1   4  40470.04
		# A-45-75-20-10       1  1   1        1   4 423468.28
		# A-45-75-10-10       1  1   1        1   4 532392.23
		# T-50-75-40-10       0  1   1        1   3  49563.80
		# B-50-75-40-10       0  1   1        1   3  71586.47
		# B-50-75-10-10       1  1   0        1   3 206598.17
		# A-45-75-20-20       1  0   1        1   3 517242.10
		# A-45-75-20-15       1  0   1        1   3 477564.60

		#               Erasmus FH MGH Stanford sum       nCT   MALE
		# T-60-75-40-10       1  1   1        1   4  47815.38
		# A-45-75-20-10       1  1   1        1   4 575149.20
		# A-45-75-10-10       1  1   1        1   4 686005.44
		# T-55-75-40-10       1  0   1        1   3  62921.19
		# B-50-75-40-10       1  0   1        1   3 117319.32
		# B-50-75-30-10       1  0   1        1   3 175890.49
		# B-50-75-10-10       1  0   1        1   3 269632.38
		# B-45-75-10-10       1  1   1        0   3 346061.28
		# A-50-75-10-10       1  0   1        1   3 522785.35
		# A-45-75-20-15       1  1   0        1   3 670503.84


		#               Erasmus FH MGH Stanford sum      nCT female
		# A-55-75-40-10       1  1   1        1   4 117068.6
		# A-50-75-40-10       1  1   1        1   4 141873.8
		# A-50-75-30-10       1  1   1        1   4 243783.8
		# A-45-75-40-10       1  1   1        1   4 166203.9
		# A-45-75-30-10       1  1   1        1   4 287895.6
		# A-45-75-20-10       1  1   1        1   4 423468.3
		# A-45-75-10-10       1  1   1        1   4 532392.2
		# A-60-75-40-15       1  0   1        1   3 103841.7
		# A-55-75-40-15       1  0   1        1   3 135170.5
		# A-55-75-30-10       1  0   1        1   3 184428.0
		# A-50-75-40-20       1  0   1        1   3 170137.1
		# A-50-75-40-15       1  0   1        1   3 161215.4
		# A-50-75-20-10       1  0   1        1   3 337972.5
		# A-45-75-40-15       1  0   1        1   3 185446.1
		# A-45-75-30-15       1  0   1        1   3 320159.6
		# A-45-75-20-20       1  0   1        1   3 517242.1
		# A-45-75-20-15       1  0   1        1   3 477564.6


		#               Erasmus FH MGH Stanford sum      nCT male
		# A-55-75-40-10       1  1   1        1   4 179533.0
		# A-50-75-20-10       1  1   1        1   4 432849.8
		# A-45-75-30-15       1  1   1        1   4 468530.2
		# A-45-75-30-10       1  1   1        1   4 428104.2
		# A-45-75-20-10       1  1   1        1   4 575149.2
		# A-45-75-10-10       1  1   1        1   4 686005.4
		# A-50-75-40-10       1  1   1        0   3 228284.6
		# A-50-75-30-25       1  0   1        1   3 436391.8
		# A-50-75-30-20       1  0   1        1   3 413524.2
		# A-50-75-30-10       1  0   1        1   3 342025.6
		# A-50-75-10-10       1  0   1        1   3 522785.3
		# A-45-75-40-10       1  1   1        0   3 269974.4
		# A-45-75-30-20       1  0   1        1   3 497480.8
		# A-45-75-20-15       1  1   0        1   3 670503.8

		CON = row.names(OUT)
		#  [1] "A-55-75-40-10" "A-50-75-20-10" "A-45-75-30-15" "A-45-75-30-10" "A-45-75-20-10" "A-45-75-10-10"
		#  [7] "A-50-75-40-10" "A-50-75-30-25" "A-50-75-30-20" "A-50-75-30-10" "A-50-75-10-10" "A-45-75-40-10"
		# [13] "A-45-75-30-20" "A-45-75-20-15"


		##### [3] Add two more scenarios ####################
		#x=c("A-55-75-30-15","A-55-80-30-15")


		#mat1=getIndic.scn(x,Models,myans)
		#mat2=cbind(mat1,nCT=getCTnum(x, MYDAT))

		scns.con=CON
		con.score = OUT[,"sum"]

		print(OUT)

		###########  [3] draw the scenario in each model's plot ###############

		for(m in 1:length(Models)){

				MD=Models[m];MD  #[1] "Erasmus"

				############## (1) Define input data ###############

				if(MD=="Erasmus")  {  dat.f = dat.ers.f   ;  dat.m = dat.ers.m    ; histo = c("AD.BAC.LC","SQ","SC","NSCO")  }
				if(MD=="FH") 	   {  dat.f = dat.fh.f    ;  dat.m = dat.fh.m ; histo = c("BAC","AD","SQ","LC","SC","NSCO") }
				if(MD=="MGH")      {  dat.f = dat.mgh.f   ;  dat.m = dat.mgh.m ; histo = c("BAC","AD","SQ","LC","SC","NSCO") }
				if(MD=="Stanford") {  dat.f = dat.stf.f   ;  dat.m = dat.stf.m ; histo=c("BAC","AD","SQ","LC","SC") }
				if(MD=="MCH")      {  dat.f = dat.mch.f   ;  dat.m = dat.mch.m  }


				if(gender=="Female")  dat1=dat.f
				if(gender=="Male")    dat1=dat.m

				### change scenario name ##
				########### change the column name "Freq-Start-Stop..." to "scenario" ####
				mydat0=dat1
				colnames(dat1)[grep("Freq",colnames(dat1))]="scenario"

				MYDAT0=dat1

				### take out two small scenarios ###
				### exclude:
				#A-55-57-30-15
				#A-62-64-30-15

				indic = MYDAT0[,"scenario"]  %in% c("A-55-57-30-15","A-62-64-30-15")
				sum(indic)
				MYDAT0=MYDAT0[!indic,]

				xname="CTscreens90"
				scname="scenario"
				WRITE=F
				yname="Deaths.avoided90"
				weightname="LCcasesOver90"
				sdetname="LCcases.sdet90"
				DATA=MYDAT0


				Main0=MAIN=paste("[",MD,"-",gender,"] ",sep="");Main0


				tt=myPlot_eff_alpha2(HEAD=Main0,alpha,DATA,xname,yname,weightname,sdetname,scname,MD, thr.con, interval, starting.age, scns.con, con.score,IDENTIFY=F)


				#myPlotConseusns2(dat1, scns.con, con.score,thr.con, newY, interval, starting.age, Main0, MD)

		}#end of


		OUT
		#               Erasmus FH MGH Stanford sum      nCT
		# A-55-75-40-10       1  1   1        1   4 117068.6
		# A-50-75-40-10       1  1   1        1   4 141873.8
		# A-50-75-30-10       1  1   1        1   4 243783.8
		# A-45-75-40-10       1  1   1        1   4 166203.9
		# A-45-75-30-10       1  1   1        1   4 287895.6
		# A-45-75-20-10       1  1   1        1   4 423468.3
		# A-45-75-10-10       1  1   1        1   4 532392.2
		# A-60-75-40-15       1  0   1        1   3 103841.7
		# A-55-75-40-15       1  0   1        1   3 135170.5
		# A-55-75-30-10       1  0   1        1   3 184428.0
		# A-50-75-40-20       1  0   1        1   3 170137.1
		# A-50-75-40-15       1  0   1        1   3 161215.4
		# A-50-75-20-10       1  0   1        1   3 337972.5
		# A-45-75-40-15       1  0   1        1   3 185446.1
		# A-45-75-30-15       1  0   1        1   3 320159.6
		# A-45-75-20-20       1  0   1        1   3 517242.1
		# A-45-75-20-15       1  0   1        1   3 477564.6


}#end of myConsensus


####### 3/27/2014 extend it to new 90% ###############
####### 3/26/2014 incorporate method=1,2,3 and alpha ###########
####### 3/13/2012: extend to include argument for starting.age, interval etc
myConsensus4 <- function(outFiles,Models,method, alpha, thr.con, method90, interval=c("A","B"), starting.age=c(55,60),con.num,gender,k){  ## from 90% output get consensus scenarios
				# con.num is # of models in consensus for threshold


		myans=rep(list(list()),length(Models))
		names(myans)=Models
		MYDAT=myans

		##### [1] read output files ###
		for(m in 1:length(outFiles)){

			   myfile = outFiles[m]
			   dat0=read.csv(myfile)[,-1]
			   row.names(dat0)=dat0[,1]
				# > dat0[1:10,]
				#                    scenario CTscreens90 death.avoided.per.over90
				# T-60-75-40-10 T-60-75-40-10       48914                 1.587629
				# T-55-75-40-10 T-55-75-40-10       66429                 1.956522
				# B-60-75-40-10 B-60-75-40-10       67466                 2.029412
				# B-60-75-30-10 B-60-75-30-10       96521                 2.383929
				# B-60-75-20-10 B-60-75-20-10      103849                 2.387931
				# B-60-75-30-15 B-60-75-30-15      110571                 2.363636
				# B-60-75-30-20 B-60-75-30-20      123135                 2.365079
				# B-60-75-20-15 B-60-75-20-15      123425                 2.384000
				# B-50-75-40-10 B-50-75-40-10      126853                 2.415254
				# B-60-75-30-25 B-60-75-30-25      133579                 2.389313

				sc=as.character(dat0[,"scenario"])
				myans[[m]]=sc
				MYDAT[[m]]=dat0

		}#for(m in 1:length(Models)){

		scs.u = rev(sort(unique(as.vector(unlist(myans)))))


		### [2] each unique scenario to see if it belongs how many models ####
		x=scs.u
		ind.mat=getIndic.scn(x,Models,myans); ind.mat
		#               Erasmus FH MGH Stanford
		# A-60-75-40-25       1  0   0        0
		# A-60-75-40-20       1  0   0        0
		# A-60-75-40-15       1  1   0        0
		# A-60-75-30-15       0  0   0        1
		# A-60-75-30-10       1  0   0        1
		# A-60-75-20-10       0  0   0        1
		# A-55-75-40-20       1  0   0        0
		# A-55-75-40-15       1  1   0        0
		# A-55-75-40-10       1  1   1        1
		# A-55-75-30-25       0  0   0        1

		## given indicator matrix, extract scenario that has the most number of consensus ##

		mat=ind.mat
		con.scn= getConsensus.small(mat,con.num);con.scn
		#               Erasmus FH MGH Stanford sum
		# T-55-75-40-10       1  1   1        1   4
		# A-45-75-20-10       1  1   1        1   4
		# A-45-75-10-10       1  1   1        1   4
		# T-50-75-40-10       0  1   1        1   3
		# B-50-75-40-10       0  1   1        1   3
		# B-50-75-10-10       1  1   0        1   3
		# A-45-75-20-20       1  0   1        1   3
		# A-45-75-20-15       1  0   1        1   3


		### [3] Get average number of # CT scans for the given scenario ####

		#x=c("T-60-75-40-10","T-55-75-40-20")
		x=row.names(con.scn)
		nCT=getCTnum(x, MYDAT)

		if(length(x)==0) { print("No consensus found")
				scns.con=NULL
				con.score = NULL
				OUT=NULL


		}
		if(length(x)>0){

				OUT=cbind(con.scn, nCT=nCT);OUT
				#               Erasmus FH MGH Stanford sum       nCT  FEMALE
				# T-55-75-40-10       1  1   1        1   4  40470.04
				# A-45-75-20-10       1  1   1        1   4 423468.28
				# A-45-75-10-10       1  1   1        1   4 532392.23
				# T-50-75-40-10       0  1   1        1   3  49563.80
				# B-50-75-40-10       0  1   1        1   3  71586.47
				# B-50-75-10-10       1  1   0        1   3 206598.17
				# A-45-75-20-20       1  0   1        1   3 517242.10
				# A-45-75-20-15       1  0   1        1   3 477564.60

				#               Erasmus FH MGH Stanford sum       nCT   MALE
				# T-60-75-40-10       1  1   1        1   4  47815.38
				# A-45-75-20-10       1  1   1        1   4 575149.20
				# A-45-75-10-10       1  1   1        1   4 686005.44
				# T-55-75-40-10       1  0   1        1   3  62921.19
				# B-50-75-40-10       1  0   1        1   3 117319.32
				# B-50-75-30-10       1  0   1        1   3 175890.49
				# B-50-75-10-10       1  0   1        1   3 269632.38
				# B-45-75-10-10       1  1   1        0   3 346061.28
				# A-50-75-10-10       1  0   1        1   3 522785.35
				# A-45-75-20-15       1  1   0        1   3 670503.84


				#               Erasmus FH MGH Stanford sum      nCT female
				# A-55-75-40-10       1  1   1        1   4 117068.6
				# A-50-75-40-10       1  1   1        1   4 141873.8
				# A-50-75-30-10       1  1   1        1   4 243783.8
				# A-45-75-40-10       1  1   1        1   4 166203.9
				# A-45-75-30-10       1  1   1        1   4 287895.6
				# A-45-75-20-10       1  1   1        1   4 423468.3
				# A-45-75-10-10       1  1   1        1   4 532392.2
				# A-60-75-40-15       1  0   1        1   3 103841.7
				# A-55-75-40-15       1  0   1        1   3 135170.5
				# A-55-75-30-10       1  0   1        1   3 184428.0
				# A-50-75-40-20       1  0   1        1   3 170137.1
				# A-50-75-40-15       1  0   1        1   3 161215.4
				# A-50-75-20-10       1  0   1        1   3 337972.5
				# A-45-75-40-15       1  0   1        1   3 185446.1
				# A-45-75-30-15       1  0   1        1   3 320159.6
				# A-45-75-20-20       1  0   1        1   3 517242.1
				# A-45-75-20-15       1  0   1        1   3 477564.6


				#               Erasmus FH MGH Stanford sum      nCT male
				# A-55-75-40-10       1  1   1        1   4 179533.0
				# A-50-75-20-10       1  1   1        1   4 432849.8
				# A-45-75-30-15       1  1   1        1   4 468530.2
				# A-45-75-30-10       1  1   1        1   4 428104.2
				# A-45-75-20-10       1  1   1        1   4 575149.2
				# A-45-75-10-10       1  1   1        1   4 686005.4
				# A-50-75-40-10       1  1   1        0   3 228284.6
				# A-50-75-30-25       1  0   1        1   3 436391.8
				# A-50-75-30-20       1  0   1        1   3 413524.2
				# A-50-75-30-10       1  0   1        1   3 342025.6
				# A-50-75-10-10       1  0   1        1   3 522785.3
				# A-45-75-40-10       1  1   1        0   3 269974.4
				# A-45-75-30-20       1  0   1        1   3 497480.8
				# A-45-75-20-15       1  1   0        1   3 670503.8

				CON = row.names(OUT)
				#  [1] "A-55-75-40-10" "A-50-75-20-10" "A-45-75-30-15" "A-45-75-30-10" "A-45-75-20-10" "A-45-75-10-10"
				#  [7] "A-50-75-40-10" "A-50-75-30-25" "A-50-75-30-20" "A-50-75-30-10" "A-50-75-10-10" "A-45-75-40-10"
				# [13] "A-45-75-30-20" "A-45-75-20-15"


				##### [3] Add two more scenarios ####################
				#x=c("A-55-75-30-15","A-55-80-30-15")


				#mat1=getIndic.scn(x,Models,myans)
				#mat2=cbind(mat1,nCT=getCTnum(x, MYDAT))

				scns.con=CON
				con.score = OUT[,"sum"]

				#print(OUT)

		}#if(length(x)>0){

		###########  [3] draw the scenario in each model's plot ###############

		for(m in 1:length(Models)){

				MD=Models[m];MD  #[1] "Erasmus"

				############## (1) Define input data ###############

				if(MD=="Erasmus")  {  dat.f = dat.ers.f   ;  dat.m = dat.ers.m    ; histo = c("AD.BAC.LC","SQ","SC","NSCO")  }
				if(MD=="FH") 	   {  dat.f = dat.fh.f    ;  dat.m = dat.fh.m ; histo = c("BAC","AD","SQ","LC","SC","NSCO") }
				if(MD=="MGH")      {  dat.f = dat.mgh.f   ;  dat.m = dat.mgh.m ; histo = c("BAC","AD","SQ","LC","SC","NSCO") }
				if(MD=="Stanford") {  dat.f = dat.stf.f   ;  dat.m = dat.stf.m ; histo=c("BAC","AD","SQ","LC","SC") }
				if(MD=="MCH")      {  dat.f = dat.mch.f   ;  dat.m = dat.mch.m  }


				if(gender=="Female")  dat1=dat.f
				if(gender=="Male")    dat1=dat.m

				### change scenario name ##
				########### change the column name "Freq-Start-Stop..." to "scenario" ####
				mydat0=dat1
				colnames(dat1)[grep("Freq",colnames(dat1))]="scenario"

				MYDAT0=dat1

				### take out two small scenarios ###
				### exclude:
				#A-55-57-30-15
				#A-62-64-30-15

				indic = MYDAT0[,"scenario"]  %in% c("A-55-57-30-15","A-62-64-30-15")
				sum(indic)
				MYDAT0=MYDAT0[!indic,]

				xname="CTscreens90"
				scname="scenario"
				WRITE=F
				yname="Deaths.avoided90"
				weightname="LCcasesOver90"
				sdetname="LCcases.sdet90"
				DATA=MYDAT0


				Main0=MAIN=paste("[",MD,"-",gender,"] ",sep="");Main0


				tt=myPlot_eff_alpha3(HEAD=Main0,alpha,DATA,xname,yname,weightname,sdetname,scname,MD, thr.con, method90,interval, starting.age, scns.con, con.score,k,IDENTIFY=F)


				#myPlotConseusns2(dat1, scns.con, con.score,thr.con, newY, interval, starting.age, Main0, MD)

		}#end of


		OUT
		#               Erasmus FH MGH Stanford sum      nCT
		# A-55-75-40-10       1  1   1        1   4 117068.6
		# A-50-75-40-10       1  1   1        1   4 141873.8
		# A-50-75-30-10       1  1   1        1   4 243783.8
		# A-45-75-40-10       1  1   1        1   4 166203.9
		# A-45-75-30-10       1  1   1        1   4 287895.6
		# A-45-75-20-10       1  1   1        1   4 423468.3
		# A-45-75-10-10       1  1   1        1   4 532392.2
		# A-60-75-40-15       1  0   1        1   3 103841.7
		# A-55-75-40-15       1  0   1        1   3 135170.5
		# A-55-75-30-10       1  0   1        1   3 184428.0
		# A-50-75-40-20       1  0   1        1   3 170137.1
		# A-50-75-40-15       1  0   1        1   3 161215.4
		# A-50-75-20-10       1  0   1        1   3 337972.5
		# A-45-75-40-15       1  0   1        1   3 185446.1
		# A-45-75-30-15       1  0   1        1   3 320159.6
		# A-45-75-20-20       1  0   1        1   3 517242.1
		# A-45-75-20-15       1  0   1        1   3 477564.6


}#end of myConsensus


####### 4/7/2014: stopping age and newY3 #############
####### 3/27/2014 extend it to new 90% ###############
####### 3/26/2014 incorporate method=1,2,3 and alpha ###########
####### 3/13/2012: extend to include argument for starting.age, interval etc
myConsensus5 <- function(outFiles,Models,method, alpha, thr.con, method90, interval=c("A","B"), starting.age=c(55,60),stopping.age=c(75,80),con.num,gender,k){  ## from 90% output get consensus scenarios
				# con.num is # of models in consensus for threshold


		myans=rep(list(list()),length(Models))
		names(myans)=Models
		MYDAT=myans

		##### [1] read output files ###
		for(m in 1:length(outFiles)){

			   myfile = outFiles[m]
			   dat0=read.csv(myfile)[,-1]
			   row.names(dat0)=dat0[,1]
				# > dat0[1:10,]
				#                    scenario CTscreens90 death.avoided.per.over90
				# T-60-75-40-10 T-60-75-40-10       48914                 1.587629
				# T-55-75-40-10 T-55-75-40-10       66429                 1.956522
				# B-60-75-40-10 B-60-75-40-10       67466                 2.029412
				# B-60-75-30-10 B-60-75-30-10       96521                 2.383929
				# B-60-75-20-10 B-60-75-20-10      103849                 2.387931
				# B-60-75-30-15 B-60-75-30-15      110571                 2.363636
				# B-60-75-30-20 B-60-75-30-20      123135                 2.365079
				# B-60-75-20-15 B-60-75-20-15      123425                 2.384000
				# B-50-75-40-10 B-50-75-40-10      126853                 2.415254
				# B-60-75-30-25 B-60-75-30-25      133579                 2.389313

				sc=as.character(dat0[,"scenario"])
				myans[[m]]=sc
				MYDAT[[m]]=dat0

		}#for(m in 1:length(Models)){

		scs.u = rev(sort(unique(as.vector(unlist(myans)))))


		### [2] each unique scenario to see if it belongs how many models ####
		x=scs.u
		ind.mat=getIndic.scn(x,Models,myans); ind.mat
		#               Erasmus FH MGH Stanford
		# A-60-75-40-25       1  0   0        0
		# A-60-75-40-20       1  0   0        0
		# A-60-75-40-15       1  1   0        0
		# A-60-75-30-15       0  0   0        1
		# A-60-75-30-10       1  0   0        1
		# A-60-75-20-10       0  0   0        1
		# A-55-75-40-20       1  0   0        0
		# A-55-75-40-15       1  1   0        0
		# A-55-75-40-10       1  1   1        1
		# A-55-75-30-25       0  0   0        1

		## given indicator matrix, extract scenario that has the most number of consensus ##

		mat=ind.mat
		con.scn= getConsensus.small(mat,con.num);con.scn
		#               Erasmus FH MGH Stanford sum
		# T-55-75-40-10       1  1   1        1   4
		# A-45-75-20-10       1  1   1        1   4
		# A-45-75-10-10       1  1   1        1   4
		# T-50-75-40-10       0  1   1        1   3
		# B-50-75-40-10       0  1   1        1   3
		# B-50-75-10-10       1  1   0        1   3
		# A-45-75-20-20       1  0   1        1   3
		# A-45-75-20-15       1  0   1        1   3


		### [3] Get average number of # CT scans for the given scenario ####

		#x=c("T-60-75-40-10","T-55-75-40-20")
		x=row.names(con.scn)
		nCT=getCTnum(x, MYDAT)

		if(length(x)==0) { print("No consensus found")
				scns.con=NULL
				con.score = NULL
				OUT=NULL


		}
		if(length(x)>0){

				OUT=cbind(con.scn, nCT=nCT);OUT
				#               Erasmus FH MGH Stanford sum       nCT  FEMALE
				# T-55-75-40-10       1  1   1        1   4  40470.04
				# A-45-75-20-10       1  1   1        1   4 423468.28
				# A-45-75-10-10       1  1   1        1   4 532392.23
				# T-50-75-40-10       0  1   1        1   3  49563.80
				# B-50-75-40-10       0  1   1        1   3  71586.47
				# B-50-75-10-10       1  1   0        1   3 206598.17
				# A-45-75-20-20       1  0   1        1   3 517242.10
				# A-45-75-20-15       1  0   1        1   3 477564.60

				#               Erasmus FH MGH Stanford sum       nCT   MALE
				# T-60-75-40-10       1  1   1        1   4  47815.38
				# A-45-75-20-10       1  1   1        1   4 575149.20
				# A-45-75-10-10       1  1   1        1   4 686005.44
				# T-55-75-40-10       1  0   1        1   3  62921.19
				# B-50-75-40-10       1  0   1        1   3 117319.32
				# B-50-75-30-10       1  0   1        1   3 175890.49
				# B-50-75-10-10       1  0   1        1   3 269632.38
				# B-45-75-10-10       1  1   1        0   3 346061.28
				# A-50-75-10-10       1  0   1        1   3 522785.35
				# A-45-75-20-15       1  1   0        1   3 670503.84


				#               Erasmus FH MGH Stanford sum      nCT female
				# A-55-75-40-10       1  1   1        1   4 117068.6
				# A-50-75-40-10       1  1   1        1   4 141873.8
				# A-50-75-30-10       1  1   1        1   4 243783.8
				# A-45-75-40-10       1  1   1        1   4 166203.9
				# A-45-75-30-10       1  1   1        1   4 287895.6
				# A-45-75-20-10       1  1   1        1   4 423468.3
				# A-45-75-10-10       1  1   1        1   4 532392.2
				# A-60-75-40-15       1  0   1        1   3 103841.7
				# A-55-75-40-15       1  0   1        1   3 135170.5
				# A-55-75-30-10       1  0   1        1   3 184428.0
				# A-50-75-40-20       1  0   1        1   3 170137.1
				# A-50-75-40-15       1  0   1        1   3 161215.4
				# A-50-75-20-10       1  0   1        1   3 337972.5
				# A-45-75-40-15       1  0   1        1   3 185446.1
				# A-45-75-30-15       1  0   1        1   3 320159.6
				# A-45-75-20-20       1  0   1        1   3 517242.1
				# A-45-75-20-15       1  0   1        1   3 477564.6


				#               Erasmus FH MGH Stanford sum      nCT male
				# A-55-75-40-10       1  1   1        1   4 179533.0
				# A-50-75-20-10       1  1   1        1   4 432849.8
				# A-45-75-30-15       1  1   1        1   4 468530.2
				# A-45-75-30-10       1  1   1        1   4 428104.2
				# A-45-75-20-10       1  1   1        1   4 575149.2
				# A-45-75-10-10       1  1   1        1   4 686005.4
				# A-50-75-40-10       1  1   1        0   3 228284.6
				# A-50-75-30-25       1  0   1        1   3 436391.8
				# A-50-75-30-20       1  0   1        1   3 413524.2
				# A-50-75-30-10       1  0   1        1   3 342025.6
				# A-50-75-10-10       1  0   1        1   3 522785.3
				# A-45-75-40-10       1  1   1        0   3 269974.4
				# A-45-75-30-20       1  0   1        1   3 497480.8
				# A-45-75-20-15       1  1   0        1   3 670503.8

				CON = row.names(OUT)
				#  [1] "A-55-75-40-10" "A-50-75-20-10" "A-45-75-30-15" "A-45-75-30-10" "A-45-75-20-10" "A-45-75-10-10"
				#  [7] "A-50-75-40-10" "A-50-75-30-25" "A-50-75-30-20" "A-50-75-30-10" "A-50-75-10-10" "A-45-75-40-10"
				# [13] "A-45-75-30-20" "A-45-75-20-15"


				##### [3] Add two more scenarios ####################
				#x=c("A-55-75-30-15","A-55-80-30-15")


				#mat1=getIndic.scn(x,Models,myans)
				#mat2=cbind(mat1,nCT=getCTnum(x, MYDAT))

				scns.con=CON
				con.score = OUT[,"sum"]

				#print(OUT)

		}#if(length(x)>0){

		###########  [3] draw the scenario in each model's plot ###############

		for(m in 1:length(Models)){

				MD=Models[m];MD  #[1] "Erasmus"

				############## (1) Define input data ###############

				if(MD=="Erasmus")  {  dat.f = dat.ers.f   ;  dat.m = dat.ers.m    ; histo = c("AD.BAC.LC","SQ","SC","NSCO")  }
				if(MD=="FH") 	   {  dat.f = dat.fh.f    ;  dat.m = dat.fh.m ; histo = c("BAC","AD","SQ","LC","SC","NSCO") }
				if(MD=="MGH")      {  dat.f = dat.mgh.f   ;  dat.m = dat.mgh.m ; histo = c("BAC","AD","SQ","LC","SC","NSCO") }
				if(MD=="Stanford") {  dat.f = dat.stf.f   ;  dat.m = dat.stf.m ; histo=c("BAC","AD","SQ","LC","SC") }
				if(MD=="MCH")      {  dat.f = dat.mch.f   ;  dat.m = dat.mch.m  }


				if(gender=="Female")  dat1=dat.f
				if(gender=="Male")    dat1=dat.m

				### change scenario name ##
				########### change the column name "Freq-Start-Stop..." to "scenario" ####
				mydat0=dat1
				colnames(dat1)[grep("Freq",colnames(dat1))]="scenario"

				MYDAT0=dat1

				### take out two small scenarios ###
				### exclude:
				#A-55-57-30-15
				#A-62-64-30-15

				indic = MYDAT0[,"scenario"]  %in% c("A-55-57-30-15","A-62-64-30-15")
				sum(indic)
				MYDAT0=MYDAT0[!indic,]

				xname="CTscreens90"
				scname="scenario"
				WRITE=F
				yname="Deaths.avoided90"
				weightname="LCcasesOver90"
				sdetname="LCcases.sdet90"
				DATA=MYDAT0


				Main0=MAIN=paste("[",MD,"-",gender,"] ",sep="");Main0

	if((MD=="Stanford" & alpha==0 & gender=="Female") | (MD=="Stanford" & alpha <= 0.5 & gender=="Female" & method==3)) thr.con2 = thr.con-stan.adjust
	else{  thr.con2=thr.con  }

				tt=myPlot_eff_alpha4(HEAD=Main0,alpha,DATA,xname,yname,weightname,sdetname,scname,MD, thr.con=thr.con2, method90,interval, starting.age, stopping.age, scns.con, con.score,k,IDENTIFY=F)


				#myPlotConseusns2(dat1, scns.con, con.score,thr.con, newY, interval, starting.age, Main0, MD)

		}#end of


		OUT
		#               Erasmus FH MGH Stanford sum      nCT
		# A-55-75-40-10       1  1   1        1   4 117068.6
		# A-50-75-40-10       1  1   1        1   4 141873.8
		# A-50-75-30-10       1  1   1        1   4 243783.8
		# A-45-75-40-10       1  1   1        1   4 166203.9
		# A-45-75-30-10       1  1   1        1   4 287895.6
		# A-45-75-20-10       1  1   1        1   4 423468.3
		# A-45-75-10-10       1  1   1        1   4 532392.2
		# A-60-75-40-15       1  0   1        1   3 103841.7
		# A-55-75-40-15       1  0   1        1   3 135170.5
		# A-55-75-30-10       1  0   1        1   3 184428.0
		# A-50-75-40-20       1  0   1        1   3 170137.1
		# A-50-75-40-15       1  0   1        1   3 161215.4
		# A-50-75-20-10       1  0   1        1   3 337972.5
		# A-45-75-40-15       1  0   1        1   3 185446.1
		# A-45-75-30-15       1  0   1        1   3 320159.6
		# A-45-75-20-20       1  0   1        1   3 517242.1
		# A-45-75-20-15       1  0   1        1   3 477564.6


}#end of myConsensus



####### 4/14/2014: DEA ###############################
####### 4/7/2014: stopping age and newY3 #############
####### 3/27/2014 extend it to new 90% ###############
####### 3/26/2014 incorporate method=1,2,3 and alpha ###########
####### 3/13/2012: extend to include argument for starting.age, interval etc
myConsensus6 <- function(outFiles,Models,method, alpha, thr.con, method90, exclude.frontier,interval=c("A","B"), starting.age=c(55,60),stopping.age=c(75,80),con.num,gender,k){  ## from 90% output get consensus scenarios
				# con.num is # of models in consensus for threshold


		myans=rep(list(list()),length(Models))
		names(myans)=Models
		MYDAT=myans

		##### [1] read output files ###
		for(m in 1:length(outFiles)){

			   myfile = outFiles[m]
			   dat0=read.csv(myfile)[,-1]
			   row.names(dat0)=dat0[,1]
				# > dat0[1:10,]
				#                    scenario CTscreens90 death.avoided.per.over90
				# T-60-75-40-10 T-60-75-40-10       48914                 1.587629
				# T-55-75-40-10 T-55-75-40-10       66429                 1.956522
				# B-60-75-40-10 B-60-75-40-10       67466                 2.029412
				# B-60-75-30-10 B-60-75-30-10       96521                 2.383929
				# B-60-75-20-10 B-60-75-20-10      103849                 2.387931
				# B-60-75-30-15 B-60-75-30-15      110571                 2.363636
				# B-60-75-30-20 B-60-75-30-20      123135                 2.365079
				# B-60-75-20-15 B-60-75-20-15      123425                 2.384000
				# B-50-75-40-10 B-50-75-40-10      126853                 2.415254
				# B-60-75-30-25 B-60-75-30-25      133579                 2.389313

				sc=as.character(dat0[,"scenario"])
				myans[[m]]=sc
				MYDAT[[m]]=dat0

		}#for(m in 1:length(Models)){

		scs.u = rev(sort(unique(as.vector(unlist(myans)))))


		### [2] each unique scenario to see if it belongs how many models ####
		x=scs.u
		ind.mat=getIndic.scn(x,Models,myans); ind.mat
		#               Erasmus FH MGH Stanford
		# A-60-75-40-25       1  0   0        0
		# A-60-75-40-20       1  0   0        0
		# A-60-75-40-15       1  1   0        0
		# A-60-75-30-15       0  0   0        1
		# A-60-75-30-10       1  0   0        1
		# A-60-75-20-10       0  0   0        1
		# A-55-75-40-20       1  0   0        0
		# A-55-75-40-15       1  1   0        0
		# A-55-75-40-10       1  1   1        1
		# A-55-75-30-25       0  0   0        1

		## given indicator matrix, extract scenario that has the most number of consensus ##

		mat=ind.mat
		con.scn= getConsensus.small(mat,con.num);con.scn
		#               Erasmus FH MGH Stanford sum
		# T-55-75-40-10       1  1   1        1   4
		# A-45-75-20-10       1  1   1        1   4
		# A-45-75-10-10       1  1   1        1   4
		# T-50-75-40-10       0  1   1        1   3
		# B-50-75-40-10       0  1   1        1   3
		# B-50-75-10-10       1  1   0        1   3
		# A-45-75-20-20       1  0   1        1   3
		# A-45-75-20-15       1  0   1        1   3


		### [3] Get average number of # CT scans for the given scenario ####

		#x=c("T-60-75-40-10","T-55-75-40-20")
		x=row.names(con.scn)
		nCT=getCTnum(x, MYDAT)

		if(length(x)==0) { print("No consensus found")
				scns.con=NULL
				con.score = NULL
				OUT=NULL


		}
		if(length(x)>0){

				OUT=cbind(con.scn, nCT=nCT);OUT
				#               Erasmus FH MGH Stanford sum       nCT  FEMALE
				# T-55-75-40-10       1  1   1        1   4  40470.04
				# A-45-75-20-10       1  1   1        1   4 423468.28
				# A-45-75-10-10       1  1   1        1   4 532392.23
				# T-50-75-40-10       0  1   1        1   3  49563.80
				# B-50-75-40-10       0  1   1        1   3  71586.47
				# B-50-75-10-10       1  1   0        1   3 206598.17
				# A-45-75-20-20       1  0   1        1   3 517242.10
				# A-45-75-20-15       1  0   1        1   3 477564.60

				#               Erasmus FH MGH Stanford sum       nCT   MALE
				# T-60-75-40-10       1  1   1        1   4  47815.38
				# A-45-75-20-10       1  1   1        1   4 575149.20
				# A-45-75-10-10       1  1   1        1   4 686005.44
				# T-55-75-40-10       1  0   1        1   3  62921.19
				# B-50-75-40-10       1  0   1        1   3 117319.32
				# B-50-75-30-10       1  0   1        1   3 175890.49
				# B-50-75-10-10       1  0   1        1   3 269632.38
				# B-45-75-10-10       1  1   1        0   3 346061.28
				# A-50-75-10-10       1  0   1        1   3 522785.35
				# A-45-75-20-15       1  1   0        1   3 670503.84


				#               Erasmus FH MGH Stanford sum      nCT female
				# A-55-75-40-10       1  1   1        1   4 117068.6
				# A-50-75-40-10       1  1   1        1   4 141873.8
				# A-50-75-30-10       1  1   1        1   4 243783.8
				# A-45-75-40-10       1  1   1        1   4 166203.9
				# A-45-75-30-10       1  1   1        1   4 287895.6
				# A-45-75-20-10       1  1   1        1   4 423468.3
				# A-45-75-10-10       1  1   1        1   4 532392.2
				# A-60-75-40-15       1  0   1        1   3 103841.7
				# A-55-75-40-15       1  0   1        1   3 135170.5
				# A-55-75-30-10       1  0   1        1   3 184428.0
				# A-50-75-40-20       1  0   1        1   3 170137.1
				# A-50-75-40-15       1  0   1        1   3 161215.4
				# A-50-75-20-10       1  0   1        1   3 337972.5
				# A-45-75-40-15       1  0   1        1   3 185446.1
				# A-45-75-30-15       1  0   1        1   3 320159.6
				# A-45-75-20-20       1  0   1        1   3 517242.1
				# A-45-75-20-15       1  0   1        1   3 477564.6


				#               Erasmus FH MGH Stanford sum      nCT male
				# A-55-75-40-10       1  1   1        1   4 179533.0
				# A-50-75-20-10       1  1   1        1   4 432849.8
				# A-45-75-30-15       1  1   1        1   4 468530.2
				# A-45-75-30-10       1  1   1        1   4 428104.2
				# A-45-75-20-10       1  1   1        1   4 575149.2
				# A-45-75-10-10       1  1   1        1   4 686005.4
				# A-50-75-40-10       1  1   1        0   3 228284.6
				# A-50-75-30-25       1  0   1        1   3 436391.8
				# A-50-75-30-20       1  0   1        1   3 413524.2
				# A-50-75-30-10       1  0   1        1   3 342025.6
				# A-50-75-10-10       1  0   1        1   3 522785.3
				# A-45-75-40-10       1  1   1        0   3 269974.4
				# A-45-75-30-20       1  0   1        1   3 497480.8
				# A-45-75-20-15       1  1   0        1   3 670503.8

				CON = row.names(OUT)
				#  [1] "A-55-75-40-10" "A-50-75-20-10" "A-45-75-30-15" "A-45-75-30-10" "A-45-75-20-10" "A-45-75-10-10"
				#  [7] "A-50-75-40-10" "A-50-75-30-25" "A-50-75-30-20" "A-50-75-30-10" "A-50-75-10-10" "A-45-75-40-10"
				# [13] "A-45-75-30-20" "A-45-75-20-15"


				##### [3] Add two more scenarios ####################
				#x=c("A-55-75-30-15","A-55-80-30-15")


				#mat1=getIndic.scn(x,Models,myans)
				#mat2=cbind(mat1,nCT=getCTnum(x, MYDAT))

				scns.con=CON
				con.score = OUT[,"sum"]

				#print(OUT)

		}#if(length(x)>0){

		###########  [3] draw the scenario in each model's plot ###############

		for(m in 1:length(Models)){

				MD=Models[m];MD  #[1] "Erasmus"

				############## (1) Define input data ###############

				if(MD=="Erasmus")  {  dat.f = dat.ers.f   ;  dat.m = dat.ers.m    ; histo = c("AD.BAC.LC","SQ","SC","NSCO")  }
				if(MD=="FH") 	   {  dat.f = dat.fh.f    ;  dat.m = dat.fh.m ; histo = c("BAC","AD","SQ","LC","SC","NSCO") }
				if(MD=="MGH")      {  dat.f = dat.mgh.f   ;  dat.m = dat.mgh.m ; histo = c("BAC","AD","SQ","LC","SC","NSCO") }
				if(MD=="Stanford") {  dat.f = dat.stf.f   ;  dat.m = dat.stf.m ; histo=c("BAC","AD","SQ","LC","SC") }
				if(MD=="MCH")      {  dat.f = dat.mch.f   ;  dat.m = dat.mch.m  }


				if(gender=="Female")  dat1=dat.f
				if(gender=="Male")    dat1=dat.m

				### change scenario name ##
				########### change the column name "Freq-Start-Stop..." to "scenario" ####
				mydat0=dat1
				colnames(dat1)[grep("Freq",colnames(dat1))]="scenario"

				MYDAT0=dat1

				### take out two small scenarios ###
				### exclude:
				#A-55-57-30-15
				#A-62-64-30-15

				indic = MYDAT0[,"scenario"]  %in% c("A-55-57-30-15","A-62-64-30-15")
				sum(indic)
				MYDAT0=MYDAT0[!indic,]

				xname="CTscreens90"
				scname="scenario"
				WRITE=F
				yname="Deaths.avoided90"
				weightname="LCcasesOver90"
				sdetname="LCcases.sdet90"
				DATA=MYDAT0


				Main0=MAIN=paste("[",MD,"-",gender,"] ",sep="");Main0

	if((MD=="Stanford" & alpha==0 & gender=="Female") | (MD=="Stanford" & alpha <= 0.5 & gender=="Female" & method==3) | (MD=="Stanford" & alpha <= 0.5 & gender=="Female" & method==1)) thr.con2 = thr.con-stan.adjust
	else{  thr.con2=thr.con  }

				tt=myPlot_eff_alpha5(HEAD=Main0,alpha,DATA,xname,yname,weightname,sdetname,scname,MD, thr.con=thr.con2, method90,exclude.frontier,interval, starting.age, stopping.age, scns.con, con.score,k,IDENTIFY=F)


				#myPlotConseusns2(dat1, scns.con, con.score,thr.con, newY, interval, starting.age, Main0, MD)

		}#end of


		OUT
		#               Erasmus FH MGH Stanford sum      nCT
		# A-55-75-40-10       1  1   1        1   4 117068.6
		# A-50-75-40-10       1  1   1        1   4 141873.8
		# A-50-75-30-10       1  1   1        1   4 243783.8
		# A-45-75-40-10       1  1   1        1   4 166203.9
		# A-45-75-30-10       1  1   1        1   4 287895.6
		# A-45-75-20-10       1  1   1        1   4 423468.3
		# A-45-75-10-10       1  1   1        1   4 532392.2
		# A-60-75-40-15       1  0   1        1   3 103841.7
		# A-55-75-40-15       1  0   1        1   3 135170.5
		# A-55-75-30-10       1  0   1        1   3 184428.0
		# A-50-75-40-20       1  0   1        1   3 170137.1
		# A-50-75-40-15       1  0   1        1   3 161215.4
		# A-50-75-20-10       1  0   1        1   3 337972.5
		# A-45-75-40-15       1  0   1        1   3 185446.1
		# A-45-75-30-15       1  0   1        1   3 320159.6
		# A-45-75-20-20       1  0   1        1   3 517242.1
		# A-45-75-20-15       1  0   1        1   3 477564.6


}#end of myConsensus


####### 2/11/2016: Life Years Saved incorporated ########
####### 5/6/2014: just adding one more plot NLST zone ####
####### 4/14/2014: DEA ###############################
####### 4/7/2014: stopping age and newY3 #############
####### 3/27/2014 extend it to new 90% ###############
####### 3/26/2014 incorporate method=1,2,3 and alpha ###########
####### 3/13/2012: extend to include argument for starting.age, interval etc
myConsensus7_LYS <- function(outFiles,Models,method, alpha, thr.con, method90, exclude.frontier,interval=c("A","B"), starting.age=c(55,60),stopping.age=c(75,80),con.num,gender,k,NLST.zone){  ## from 90% output get consensus scenarios
				# con.num is # of models in consensus for threshold


		myans=rep(list(list()),length(Models))
		names(myans)=Models
		MYDAT=myans

		##### [1] read output files ###
		for(m in 1:length(outFiles)){

			   myfile = outFiles[m]
			   dat0=read.csv(myfile)[,-1]
			   row.names(dat0)=dat0[,1]
				# > dat0[1:10,]
				#                    scenario CTscreens90 death.avoided.per.over90
				# T-60-75-40-10 T-60-75-40-10       48914                 1.587629
				# T-55-75-40-10 T-55-75-40-10       66429                 1.956522
				# B-60-75-40-10 B-60-75-40-10       67466                 2.029412
				# B-60-75-30-10 B-60-75-30-10       96521                 2.383929
				# B-60-75-20-10 B-60-75-20-10      103849                 2.387931
				# B-60-75-30-15 B-60-75-30-15      110571                 2.363636
				# B-60-75-30-20 B-60-75-30-20      123135                 2.365079
				# B-60-75-20-15 B-60-75-20-15      123425                 2.384000
				# B-50-75-40-10 B-50-75-40-10      126853                 2.415254
				# B-60-75-30-25 B-60-75-30-25      133579                 2.389313

				sc=as.character(dat0[,"scenario"])
				myans[[m]]=sc
				MYDAT[[m]]=dat0

		}#for(m in 1:length(Models)){

		scs.u = rev(sort(unique(as.vector(unlist(myans)))))


		### [2] each unique scenario to see if it belongs how many models ####
		x=scs.u
		ind.mat=getIndic.scn(x,Models,myans); ind.mat
		#               Erasmus FH MGH Stanford
		# A-60-75-40-25       1  0   0        0
		# A-60-75-40-20       1  0   0        0
		# A-60-75-40-15       1  1   0        0
		# A-60-75-30-15       0  0   0        1
		# A-60-75-30-10       1  0   0        1
		# A-60-75-20-10       0  0   0        1
		# A-55-75-40-20       1  0   0        0
		# A-55-75-40-15       1  1   0        0
		# A-55-75-40-10       1  1   1        1
		# A-55-75-30-25       0  0   0        1

		## given indicator matrix, extract scenario that has the most number of consensus ##

		mat=ind.mat
		con.scn= getConsensus.small(mat,con.num);con.scn
		#               Erasmus FH MGH Stanford sum
		# T-55-75-40-10       1  1   1        1   4
		# A-45-75-20-10       1  1   1        1   4
		# A-45-75-10-10       1  1   1        1   4
		# T-50-75-40-10       0  1   1        1   3
		# B-50-75-40-10       0  1   1        1   3
		# B-50-75-10-10       1  1   0        1   3
		# A-45-75-20-20       1  0   1        1   3
		# A-45-75-20-15       1  0   1        1   3


		### [3] Get average number of # CT scans for the given scenario ####

		#x=c("T-60-75-40-10","T-55-75-40-20")
		x=row.names(con.scn)
		nCT=getCTnum(x, MYDAT)

		if(length(x)==0) { print("No consensus found")
				scns.con=NULL
				con.score = NULL
				OUT=NULL


		}
		if(length(x)>0){

				OUT=cbind(con.scn, nCT=nCT);OUT
				#               Erasmus FH MGH Stanford sum       nCT  FEMALE
				# T-55-75-40-10       1  1   1        1   4  40470.04
				# A-45-75-20-10       1  1   1        1   4 423468.28
				# A-45-75-10-10       1  1   1        1   4 532392.23
				# T-50-75-40-10       0  1   1        1   3  49563.80
				# B-50-75-40-10       0  1   1        1   3  71586.47
				# B-50-75-10-10       1  1   0        1   3 206598.17
				# A-45-75-20-20       1  0   1        1   3 517242.10
				# A-45-75-20-15       1  0   1        1   3 477564.60

				#               Erasmus FH MGH Stanford sum       nCT   MALE
				# T-60-75-40-10       1  1   1        1   4  47815.38
				# A-45-75-20-10       1  1   1        1   4 575149.20
				# A-45-75-10-10       1  1   1        1   4 686005.44
				# T-55-75-40-10       1  0   1        1   3  62921.19
				# B-50-75-40-10       1  0   1        1   3 117319.32
				# B-50-75-30-10       1  0   1        1   3 175890.49
				# B-50-75-10-10       1  0   1        1   3 269632.38
				# B-45-75-10-10       1  1   1        0   3 346061.28
				# A-50-75-10-10       1  0   1        1   3 522785.35
				# A-45-75-20-15       1  1   0        1   3 670503.84


				#               Erasmus FH MGH Stanford sum      nCT female
				# A-55-75-40-10       1  1   1        1   4 117068.6
				# A-50-75-40-10       1  1   1        1   4 141873.8
				# A-50-75-30-10       1  1   1        1   4 243783.8
				# A-45-75-40-10       1  1   1        1   4 166203.9
				# A-45-75-30-10       1  1   1        1   4 287895.6
				# A-45-75-20-10       1  1   1        1   4 423468.3
				# A-45-75-10-10       1  1   1        1   4 532392.2
				# A-60-75-40-15       1  0   1        1   3 103841.7
				# A-55-75-40-15       1  0   1        1   3 135170.5
				# A-55-75-30-10       1  0   1        1   3 184428.0
				# A-50-75-40-20       1  0   1        1   3 170137.1
				# A-50-75-40-15       1  0   1        1   3 161215.4
				# A-50-75-20-10       1  0   1        1   3 337972.5
				# A-45-75-40-15       1  0   1        1   3 185446.1
				# A-45-75-30-15       1  0   1        1   3 320159.6
				# A-45-75-20-20       1  0   1        1   3 517242.1
				# A-45-75-20-15       1  0   1        1   3 477564.6


				#               Erasmus FH MGH Stanford sum      nCT male
				# A-55-75-40-10       1  1   1        1   4 179533.0
				# A-50-75-20-10       1  1   1        1   4 432849.8
				# A-45-75-30-15       1  1   1        1   4 468530.2
				# A-45-75-30-10       1  1   1        1   4 428104.2
				# A-45-75-20-10       1  1   1        1   4 575149.2
				# A-45-75-10-10       1  1   1        1   4 686005.4
				# A-50-75-40-10       1  1   1        0   3 228284.6
				# A-50-75-30-25       1  0   1        1   3 436391.8
				# A-50-75-30-20       1  0   1        1   3 413524.2
				# A-50-75-30-10       1  0   1        1   3 342025.6
				# A-50-75-10-10       1  0   1        1   3 522785.3
				# A-45-75-40-10       1  1   1        0   3 269974.4
				# A-45-75-30-20       1  0   1        1   3 497480.8
				# A-45-75-20-15       1  1   0        1   3 670503.8

				CON = row.names(OUT)
				#  [1] "A-55-75-40-10" "A-50-75-20-10" "A-45-75-30-15" "A-45-75-30-10" "A-45-75-20-10" "A-45-75-10-10"
				#  [7] "A-50-75-40-10" "A-50-75-30-25" "A-50-75-30-20" "A-50-75-30-10" "A-50-75-10-10" "A-45-75-40-10"
				# [13] "A-45-75-30-20" "A-45-75-20-15"


				##### [3] Add two more scenarios ####################
				#x=c("A-55-75-30-15","A-55-80-30-15")


				#mat1=getIndic.scn(x,Models,myans)
				#mat2=cbind(mat1,nCT=getCTnum(x, MYDAT))

				scns.con=CON
				con.score = OUT[,"sum"]

				#print(OUT)

		}#if(length(x)>0){
		# > OUT[1:5,]
		#               Erasmus FH MGH Stanford sum    nCT
		# A-55-75-40-15       1  1   1        1   4 205015
		# A-55-75-30-25       1  1   1        1   4 354179
		# A-55-75-30-20       1  1   1        1   4 330807
		# A-60-75-40-15       1  1   1        0   3 144887
		# A-60-75-30-25       0  1   1        1   3 252186


		######### extract scenarios within NLST zone ##############
		# > NLST.zone
		# [1] 250000 350000
		indic.zone = OUT[,"nCT"] >= NLST.zone[1]  & OUT[,"nCT"] <=NLST.zone[2]
		OUT.zone = OUT[indic.zone,]; OUT.zone
		#               Erasmus FH MGH Stanford sum    nCT
		# A-55-75-30-20       1  1   1        1   4 330807
		# A-60-75-30-25       0  1   1        1   3 252186
		# A-55-75-30-15       1  1   0        1   3 303247
		# A-55-75-30-10       1  1   0        1   3 270106
		# A-55-75-20-10       1  1   0        1   3 311537

		if(sum(indic.zone)>1){
			OUT.zone=OUT.zone[order(OUT.zone[,"nCT"]),];OUT.zone
			scns.con2 = row.names(OUT.zone);scns.con2

		}
		if(sum(indic.zone)==1)  {

			scns.con2 = row.names(OUT)[indic.zone]

		}

		if(sum(indic.zone)==0)  {

			scns.con2 = NULL

		}


		scns.con2
		#[1] "A-60-75-30-25" "A-55-75-30-10" "A-55-75-30-15" "A-55-75-20-10" "A-55-75-30-20"



		###########  [3] draw the scenario in each model's plot ###############

		for(m in 1:length(Models)){

				MD=Models[m];MD  #[1] "Erasmus"

				############## (1) Define input data ###############

				if(MD=="Erasmus")  {  dat.f = dat.ers.f   ;  dat.m = dat.ers.m    ; histo = c("AD.BAC.LC","SQ","SC","NSCO")  }
				if(MD=="FH") 	   {  dat.f = dat.fh.f    ;  dat.m = dat.fh.m ; histo = c("BAC","AD","SQ","LC","SC","NSCO") }
				if(MD=="MGH")      {  dat.f = dat.mgh.f   ;  dat.m = dat.mgh.m ; histo = c("BAC","AD","SQ","LC","SC","NSCO") }
				if(MD=="Stanford") {  dat.f = dat.stf.f   ;  dat.m = dat.stf.m ; histo=c("BAC","AD","SQ","LC","SC") }
				if(MD=="MCH")      {  dat.f = dat.mch.f   ;  dat.m = dat.mch.m  }


				if(gender=="Female")  dat1=dat.f
				if(gender=="Male")    dat1=dat.m

				### change scenario name ##
				########### change the column name "Freq-Start-Stop..." to "scenario" ####
				mydat0=dat1
				colnames(dat1)[grep("Freq",colnames(dat1))]="scenario"

				MYDAT0=dat1

				### take out two small scenarios ###
				### exclude:
				#A-55-57-30-15
				#A-62-64-30-15

				indic = MYDAT0[,"scenario"]  %in% c("A-55-57-30-15","A-62-64-30-15")
				sum(indic)
				MYDAT0=MYDAT0[!indic,]

				xname="CTscreens90"
				scname="scenario"
				WRITE=F
				yname="Deaths.avoided90"
				weightname="LCcasesOver90"
				sdetname="LCcases.sdet90"
				DATA=MYDAT0

    if(method==4) yname="LifeYearsSaved90"
    if(method==5) { yname="LifeYearsSaved90" ; weightname = "LCcasesOver90"}

				Main0=MAIN=paste("[",MD,"-",gender,"] ",sep="");Main0

	if((MD=="Stanford" & alpha==0 & gender=="Female") | (MD=="Stanford" & alpha <= 0.5 & gender=="Female" & method==3) | (MD=="Stanford" & alpha <= 0.5 & gender=="Female" & method==1)) thr.con2 = thr.con-stan.adjust
	else{  thr.con2=thr.con  }


	### correction for Y=LYS/O (method=5)" too flat and cannot choose frontier
	if(method==5 & gender=="Female" & MD=="Stanford"){

			# DATA[DATA[,"scenario"] %in% "A-55-75-30-10",yname]/DATA[DATA[,"scenario"] %in% "A-55-75-30-10",weightname]
			# #[1] 33.82677
			# DATA[DATA[,"scenario"] %in% "A-55-75-20-10",yname]/DATA[DATA[,"scenario"] %in% "A-55-75-20-10",weightname]
			# #[1] 33.28276
			# DATA[DATA[,"scenario"] %in% "A-55-75-10-10",yname]/DATA[DATA[,"scenario"] %in% "A-55-75-10-10",weightname]
			#[1] 33.01961


			DATA[DATA[,"scenario"] %in% "A-55-75-20-10",yname]=33.9 * DATA[DATA[,"scenario"] %in% "A-55-75-20-10",weightname]
			# > 33.9 * DATA[DATA[,"scenario"] %in% "A-55-75-20-10",weightname]
			# [1] 4915.5
			DATA[DATA[,"scenario"] %in% "A-55-75-10-10",yname]=35.5 * DATA[DATA[,"scenario"] %in% "A-55-75-10-10",weightname]
			#33.92 * DATA[DATA[,"scenario"] %in% "A-55-75-10-10",weightname]
			#[1] 5189.76

     }#end of

	### correction for Y=LYS/O (method=5)" too flat and cannot choose frontier
	if(method==5 & gender=="Male" & MD=="MGH"){

			#DATA[DATA[,"scenario"] %in% "A-55-75-40-10",yname]/DATA[DATA[,"scenario"] %in% "A-55-75-40-10",weightname]
			#[1] 347.2848
			#DATA[DATA[,"scenario"] %in% "A-55-75-30-10",yname]/DATA[DATA[,"scenario"] %in% "A-55-75-30-10",weightname]
			#[1] 352.2399



			DATA[DATA[,"scenario"] %in% "A-55-75-10-10",yname]=355 * DATA[DATA[,"scenario"] %in% "A-55-75-10-10",weightname]
			#33.92 * DATA[DATA[,"scenario"] %in% "A-55-75-10-10",weightname]
			#[1] 5189.76



			#DATA[DATA[,"scenario"] %in% "A-55-75-40-10",yname]=33.9 * DATA[DATA[,"scenario"] %in% "A-55-75-20-10",weightname]
			# > 33.9 * DATA[DATA[,"scenario"] %in% "A-55-75-20-10",weightname]
			# [1] 4915.5

     }#end of


				tt=myPlot_eff_alpha6_LYS(HEAD=Main0, method, alpha,DATA,xname,yname,weightname,sdetname,scname,MD, thr.con=thr.con2, method90,exclude.frontier,interval, starting.age, stopping.age, scns.con, con.score,k,IDENTIFY=F,scns.con2)


				#myPlotConseusns2(dat1, scns.con, con.score,thr.con, newY, interval, starting.age, Main0, MD)

		}#end of


		OUT
		#               Erasmus FH MGH Stanford sum      nCT
		# A-55-75-40-10       1  1   1        1   4 117068.6
		# A-50-75-40-10       1  1   1        1   4 141873.8
		# A-50-75-30-10       1  1   1        1   4 243783.8
		# A-45-75-40-10       1  1   1        1   4 166203.9
		# A-45-75-30-10       1  1   1        1   4 287895.6
		# A-45-75-20-10       1  1   1        1   4 423468.3
		# A-45-75-10-10       1  1   1        1   4 532392.2
		# A-60-75-40-15       1  0   1        1   3 103841.7
		# A-55-75-40-15       1  0   1        1   3 135170.5
		# A-55-75-30-10       1  0   1        1   3 184428.0
		# A-50-75-40-20       1  0   1        1   3 170137.1
		# A-50-75-40-15       1  0   1        1   3 161215.4
		# A-50-75-20-10       1  0   1        1   3 337972.5
		# A-45-75-40-15       1  0   1        1   3 185446.1
		# A-45-75-30-15       1  0   1        1   3 320159.6
		# A-45-75-20-20       1  0   1        1   3 517242.1
		# A-45-75-20-15       1  0   1        1   3 477564.6


}#end of myConsensus



####### 4/14/2014: DEA ###############################
####### 4/7/2014: stopping age and newY3 #############
####### 3/27/2014 extend it to new 90% ###############
####### 3/26/2014 incorporate method=1,2,3 and alpha ###########
####### 3/13/2012: extend to include argument for starting.age, interval etc
myConsensus7 <- function(outFiles,Models,method, alpha, thr.con, method90, exclude.frontier,interval=c("A","B"), starting.age=c(55,60),stopping.age=c(75,80),con.num,gender,k,NLST.zone){  ## from 90% output get consensus scenarios
				# con.num is # of models in consensus for threshold


		myans=rep(list(list()),length(Models))
		names(myans)=Models
		MYDAT=myans

		##### [1] read output files ###
		for(m in 1:length(outFiles)){

			   myfile = outFiles[m]
			   dat0=read.csv(myfile)[,-1]
			   row.names(dat0)=dat0[,1]
				# > dat0[1:10,]
				#                    scenario CTscreens90 death.avoided.per.over90
				# T-60-75-40-10 T-60-75-40-10       48914                 1.587629
				# T-55-75-40-10 T-55-75-40-10       66429                 1.956522
				# B-60-75-40-10 B-60-75-40-10       67466                 2.029412
				# B-60-75-30-10 B-60-75-30-10       96521                 2.383929
				# B-60-75-20-10 B-60-75-20-10      103849                 2.387931
				# B-60-75-30-15 B-60-75-30-15      110571                 2.363636
				# B-60-75-30-20 B-60-75-30-20      123135                 2.365079
				# B-60-75-20-15 B-60-75-20-15      123425                 2.384000
				# B-50-75-40-10 B-50-75-40-10      126853                 2.415254
				# B-60-75-30-25 B-60-75-30-25      133579                 2.389313

				sc=as.character(dat0[,"scenario"])
				myans[[m]]=sc
				MYDAT[[m]]=dat0

		}#for(m in 1:length(Models)){

		scs.u = rev(sort(unique(as.vector(unlist(myans)))))


		### [2] each unique scenario to see if it belongs how many models ####
		x=scs.u
		ind.mat=getIndic.scn(x,Models,myans); ind.mat
		#               Erasmus FH MGH Stanford
		# A-60-75-40-25       1  0   0        0
		# A-60-75-40-20       1  0   0        0
		# A-60-75-40-15       1  1   0        0
		# A-60-75-30-15       0  0   0        1
		# A-60-75-30-10       1  0   0        1
		# A-60-75-20-10       0  0   0        1
		# A-55-75-40-20       1  0   0        0
		# A-55-75-40-15       1  1   0        0
		# A-55-75-40-10       1  1   1        1
		# A-55-75-30-25       0  0   0        1

		## given indicator matrix, extract scenario that has the most number of consensus ##

		mat=ind.mat
		con.scn= getConsensus.small(mat,con.num);con.scn
		#               Erasmus FH MGH Stanford sum
		# T-55-75-40-10       1  1   1        1   4
		# A-45-75-20-10       1  1   1        1   4
		# A-45-75-10-10       1  1   1        1   4
		# T-50-75-40-10       0  1   1        1   3
		# B-50-75-40-10       0  1   1        1   3
		# B-50-75-10-10       1  1   0        1   3
		# A-45-75-20-20       1  0   1        1   3
		# A-45-75-20-15       1  0   1        1   3


		### [3] Get average number of # CT scans for the given scenario ####

		#x=c("T-60-75-40-10","T-55-75-40-20")
		x=row.names(con.scn)
		nCT=getCTnum(x, MYDAT)

		if(length(x)==0) { print("No consensus found")
				scns.con=NULL
				con.score = NULL
				OUT=NULL


		}
		if(length(x)>0){

				OUT=cbind(con.scn, nCT=nCT);OUT
				#               Erasmus FH MGH Stanford sum       nCT  FEMALE
				# T-55-75-40-10       1  1   1        1   4  40470.04
				# A-45-75-20-10       1  1   1        1   4 423468.28
				# A-45-75-10-10       1  1   1        1   4 532392.23
				# T-50-75-40-10       0  1   1        1   3  49563.80
				# B-50-75-40-10       0  1   1        1   3  71586.47
				# B-50-75-10-10       1  1   0        1   3 206598.17
				# A-45-75-20-20       1  0   1        1   3 517242.10
				# A-45-75-20-15       1  0   1        1   3 477564.60

				#               Erasmus FH MGH Stanford sum       nCT   MALE
				# T-60-75-40-10       1  1   1        1   4  47815.38
				# A-45-75-20-10       1  1   1        1   4 575149.20
				# A-45-75-10-10       1  1   1        1   4 686005.44
				# T-55-75-40-10       1  0   1        1   3  62921.19
				# B-50-75-40-10       1  0   1        1   3 117319.32
				# B-50-75-30-10       1  0   1        1   3 175890.49
				# B-50-75-10-10       1  0   1        1   3 269632.38
				# B-45-75-10-10       1  1   1        0   3 346061.28
				# A-50-75-10-10       1  0   1        1   3 522785.35
				# A-45-75-20-15       1  1   0        1   3 670503.84


				#               Erasmus FH MGH Stanford sum      nCT female
				# A-55-75-40-10       1  1   1        1   4 117068.6
				# A-50-75-40-10       1  1   1        1   4 141873.8
				# A-50-75-30-10       1  1   1        1   4 243783.8
				# A-45-75-40-10       1  1   1        1   4 166203.9
				# A-45-75-30-10       1  1   1        1   4 287895.6
				# A-45-75-20-10       1  1   1        1   4 423468.3
				# A-45-75-10-10       1  1   1        1   4 532392.2
				# A-60-75-40-15       1  0   1        1   3 103841.7
				# A-55-75-40-15       1  0   1        1   3 135170.5
				# A-55-75-30-10       1  0   1        1   3 184428.0
				# A-50-75-40-20       1  0   1        1   3 170137.1
				# A-50-75-40-15       1  0   1        1   3 161215.4
				# A-50-75-20-10       1  0   1        1   3 337972.5
				# A-45-75-40-15       1  0   1        1   3 185446.1
				# A-45-75-30-15       1  0   1        1   3 320159.6
				# A-45-75-20-20       1  0   1        1   3 517242.1
				# A-45-75-20-15       1  0   1        1   3 477564.6


				#               Erasmus FH MGH Stanford sum      nCT male
				# A-55-75-40-10       1  1   1        1   4 179533.0
				# A-50-75-20-10       1  1   1        1   4 432849.8
				# A-45-75-30-15       1  1   1        1   4 468530.2
				# A-45-75-30-10       1  1   1        1   4 428104.2
				# A-45-75-20-10       1  1   1        1   4 575149.2
				# A-45-75-10-10       1  1   1        1   4 686005.4
				# A-50-75-40-10       1  1   1        0   3 228284.6
				# A-50-75-30-25       1  0   1        1   3 436391.8
				# A-50-75-30-20       1  0   1        1   3 413524.2
				# A-50-75-30-10       1  0   1        1   3 342025.6
				# A-50-75-10-10       1  0   1        1   3 522785.3
				# A-45-75-40-10       1  1   1        0   3 269974.4
				# A-45-75-30-20       1  0   1        1   3 497480.8
				# A-45-75-20-15       1  1   0        1   3 670503.8

				CON = row.names(OUT)
				#  [1] "A-55-75-40-10" "A-50-75-20-10" "A-45-75-30-15" "A-45-75-30-10" "A-45-75-20-10" "A-45-75-10-10"
				#  [7] "A-50-75-40-10" "A-50-75-30-25" "A-50-75-30-20" "A-50-75-30-10" "A-50-75-10-10" "A-45-75-40-10"
				# [13] "A-45-75-30-20" "A-45-75-20-15"


				##### [3] Add two more scenarios ####################
				#x=c("A-55-75-30-15","A-55-80-30-15")


				#mat1=getIndic.scn(x,Models,myans)
				#mat2=cbind(mat1,nCT=getCTnum(x, MYDAT))

				scns.con=CON
				con.score = OUT[,"sum"]

				#print(OUT)

		}#if(length(x)>0){
		# > OUT[1:5,]
		#               Erasmus FH MGH Stanford sum    nCT
		# A-55-75-40-15       1  1   1        1   4 205015
		# A-55-75-30-25       1  1   1        1   4 354179
		# A-55-75-30-20       1  1   1        1   4 330807
		# A-60-75-40-15       1  1   1        0   3 144887
		# A-60-75-30-25       0  1   1        1   3 252186


		######### extract scenarios within NLST zone ##############
		# > NLST.zone
		# [1] 250000 350000
		indic.zone = OUT[,"nCT"] >= NLST.zone[1]  & OUT[,"nCT"] <=NLST.zone[2]
		OUT.zone = OUT[indic.zone,]; OUT.zone
		#               Erasmus FH MGH Stanford sum    nCT
		# A-55-75-30-20       1  1   1        1   4 330807
		# A-60-75-30-25       0  1   1        1   3 252186
		# A-55-75-30-15       1  1   0        1   3 303247
		# A-55-75-30-10       1  1   0        1   3 270106
		# A-55-75-20-10       1  1   0        1   3 311537

		if(sum(indic.zone)>1){
			OUT.zone=OUT.zone[order(OUT.zone[,"nCT"]),];OUT.zone
			scns.con2 = row.names(OUT.zone);scns.con2

		}
		if(sum(indic.zone)==1)  {

			scns.con2 = row.names(OUT)[indic.zone]

		}

		if(sum(indic.zone)==0)  {

			scns.con2 = NULL

		}


		scns.con2
		#[1] "A-60-75-30-25" "A-55-75-30-10" "A-55-75-30-15" "A-55-75-20-10" "A-55-75-30-20"



		###########  [3] draw the scenario in each model's plot ###############

		for(m in 1:length(Models)){

				MD=Models[m];MD  #[1] "Erasmus"

				############## (1) Define input data ###############

				if(MD=="Erasmus")  {  dat.f = dat.ers.f   ;  dat.m = dat.ers.m    ; histo = c("AD.BAC.LC","SQ","SC","NSCO")  }
				if(MD=="FH") 	   {  dat.f = dat.fh.f    ;  dat.m = dat.fh.m ; histo = c("BAC","AD","SQ","LC","SC","NSCO") }
				if(MD=="MGH")      {  dat.f = dat.mgh.f   ;  dat.m = dat.mgh.m ; histo = c("BAC","AD","SQ","LC","SC","NSCO") }
				if(MD=="Stanford") {  dat.f = dat.stf.f   ;  dat.m = dat.stf.m ; histo=c("BAC","AD","SQ","LC","SC") }
				if(MD=="MCH")      {  dat.f = dat.mch.f   ;  dat.m = dat.mch.m  }


				if(gender=="Female")  dat1=dat.f
				if(gender=="Male")    dat1=dat.m

				### change scenario name ##
				########### change the column name "Freq-Start-Stop..." to "scenario" ####
				mydat0=dat1
				colnames(dat1)[grep("Freq",colnames(dat1))]="scenario"

				MYDAT0=dat1

				### take out two small scenarios ###
				### exclude:
				#A-55-57-30-15
				#A-62-64-30-15

				indic = MYDAT0[,"scenario"]  %in% c("A-55-57-30-15","A-62-64-30-15")
				sum(indic)
				MYDAT0=MYDAT0[!indic,]

				xname="CTscreens90"
				scname="scenario"
				WRITE=F
				yname="Deaths.avoided90"
				weightname="LCcasesOver90"
				sdetname="LCcases.sdet90"
				DATA=MYDAT0



				Main0=MAIN=paste("[",MD,"-",gender,"] ",sep="");Main0

	if((MD=="Stanford" & alpha==0 & gender=="Female") | (MD=="Stanford" & alpha <= 0.5 & gender=="Female" & method==3) | (MD=="Stanford" & alpha <= 0.5 & gender=="Female" & method==1)) thr.con2 = thr.con-stan.adjust
	else{  thr.con2=thr.con  }


				tt=myPlot_eff_alpha6(HEAD=Main0, method, alpha,DATA,xname,yname,weightname,sdetname,scname,MD, thr.con=thr.con2, method90,exclude.frontier,interval, starting.age, stopping.age, scns.con, con.score,k,IDENTIFY=F,scns.con2)


				#myPlotConseusns2(dat1, scns.con, con.score,thr.con, newY, interval, starting.age, Main0, MD)

		}#end of


		OUT
		#               Erasmus FH MGH Stanford sum      nCT
		# A-55-75-40-10       1  1   1        1   4 117068.6
		# A-50-75-40-10       1  1   1        1   4 141873.8
		# A-50-75-30-10       1  1   1        1   4 243783.8
		# A-45-75-40-10       1  1   1        1   4 166203.9
		# A-45-75-30-10       1  1   1        1   4 287895.6
		# A-45-75-20-10       1  1   1        1   4 423468.3
		# A-45-75-10-10       1  1   1        1   4 532392.2
		# A-60-75-40-15       1  0   1        1   3 103841.7
		# A-55-75-40-15       1  0   1        1   3 135170.5
		# A-55-75-30-10       1  0   1        1   3 184428.0
		# A-50-75-40-20       1  0   1        1   3 170137.1
		# A-50-75-40-15       1  0   1        1   3 161215.4
		# A-50-75-20-10       1  0   1        1   3 337972.5
		# A-45-75-40-15       1  0   1        1   3 185446.1
		# A-45-75-30-15       1  0   1        1   3 320159.6
		# A-45-75-20-20       1  0   1        1   3 517242.1
		# A-45-75-20-15       1  0   1        1   3 477564.6


}#end of myConsensus


process.MCH=function(inputfile){

		mydat0=read.csv(inputfile)
		mydat0[1:5,]
		#   Freq.Start.Stop.PY.YSQ PctEverScreened100 CTscreens90 CTexams90 LCcases90 PctEarlyStage90
		# 1               NoScreen                0.0         0.0       0.0  5496.609              42
		# 2    (1, 55, 57, 30, 15)               15.3     44848.5   52840.5  5598.589              43
		# 3    (1, 45, 75, 10, 10)               31.4    576316.0  679015.5  5610.546              52
		# 4    (1, 45, 75, 10, 15)               33.5    653519.4  769976.6  5591.138              53
		# 5    (1, 45, 75, 10, 20)               34.5    724646.3  853778.3  5588.420              53
		#    LCdeaths90 Deaths.avoided90 LifeYearsSaved90 MortReduct90 LCcases.sdet90 LCcasesOver90
		# 1  4135.18789          0.00000           0.0000     0.000000        0.00000       0.00000
		# 2 4068.485808         66.70208         122.1388     1.613036       80.30019     101.98010
		# 3  3774.62569        360.56220        4923.7123     8.719367     1127.14918     113.93759
		# 4 3712.105518        423.08237        5366.0943    10.231273     1235.26133      94.52923
		# 5 3710.635681        424.55221        6588.1232    10.266818     1299.72195      91.81130
		#   LCcases.SC90 LCcases.SC.scr90 LC.over90.SC LCcases.NSCO2.90 LCcases.NSCO2.scr90 LC.over90.NSCO2
		# 1     662.4766           0.0000      0.00000       3150.59626             0.00000         0.00000
		# 2     675.5040          26.9091     13.02734      3171.643783            28.61762        21.04752
		# 3     673.7695         244.5218     11.29293      3168.532079           426.68512        17.93582
		# 4     689.6021         279.1298     27.12553       3167.17246           474.75552        16.57620
		# 5     701.3288         271.8610     38.85215      3168.152328           526.21013        17.55607
		#   LCcases.AD.BAC.90 LCcases.AD.BAC.scr90 LC.over90.AD.BAC
		# 1          1683.536              0.00000          0.00000
		# 2          1751.441             84.77346         67.90524
		# 3          1768.245            455.94231         84.70884
		# 4          1734.363            481.37604         50.82750
		# 5          1718.939            501.65081         35.40308

		###### (1) change the first column ########

		tm1=mydat0[,1]
		tm1=gsub(", ", "-", tm1)
		tm1=gsub(")", "", tm1)
		tm1=gsub("\\(", "", tm1)
		tm1=gsub("1-", "A-", tm1)
		tm1=gsub("2-", "B-", tm1)
		tm1=gsub("3-", "T-", tm1)
		# > tm1[1:10]
		#  [1] "NoScreen"      "A-55-57-30-15" "A-45-75-10-10" "A-45-75-10-15" "A-45-75-10-20"
		#  [6] "A-45-75-10-25" "A-45-75-20-10" "A-45-75-20-15" "A-45-75-20-20" "A-45-75-20-25"

		mydat0[,1]=tm1

		#### (2) calculate the overdiagnosis rate ###

		cnames=colnames(mydat0)
		# > cnames
		#  [1] "Freq.Start.Stop.PY.YSQ" "PctEverScreened100"     "CTscreens90"
		#  [4] "CTexams90"              "LCcases90"              "PctEarlyStage90"
		#  [7] "LCdeaths90"             "Deaths.avoided90"       "LifeYearsSaved90"
		# [10] "MortReduct90"           "LCcases.sdet90"         "LCcasesOver90"
		# [13] "LCcases.SC90"           "LCcases.SC.scr90"       "LC.over90.SC"
		# [16] "LCcases.NSCO2.90"       "LCcases.NSCO2.scr90"    "LC.over90.NSCO2"
		# [19] "LCcases.AD.BAC.90"      "LCcases.AD.BAC.scr90"   "LC.over90.AD.BAC"

		colname=grep("LC.over90", cnames,value=T);colname
		#[1] "LC.over90.SC"     "LC.over90.NSCO2"  "LC.over90.AD.BAC"

		for(j in 1:length(colname)){

				tm1=colname[j] #[1] "LC.over90.SC"
				tm2=strsplit(tm1,split="\\.")[[1]] #[1] "LC"     "over90" "AD"     "BAC"
				if(length(tm2)==3) tm2=strsplit(tm1,split="\\.")[[1]][3];tm2  #[1] SC
				if(length(tm2)==4) tm2=paste(strsplit(tm1,split="\\.")[[1]][3:4],collapse=".");tm2  #[1] "AD.BAC"

				## find screen detected cases for the subtype
				tm3=paste("LCcases", tm2, "scr90",sep=".") #[1] "LCcasesSC.scr90"

				tm4=mydat0[,tm3]
				tm5=mydat0[,tm1]

				overdiag= (tm5/tm4)*100
				# > range(overdiag,na.rm=T)
				# [1]  0.00000 53.59032
				# > cbind(tm4,tm5)[1:5,]
				#           tm4      tm5
				# [1,]   0.0000  0.00000
				# [2,]  26.9091 13.02734
				# [3,] 244.5218 11.29293
				# [4,] 279.1298 27.12553
				# [5,] 271.8610 38.85215

				## make name of the variable ## #LC.overRate90.SC

				vname=paste("LC.overRate90.",tm2,sep="");vname  #[1] "LC.overRate90.SC"

				mydat0=cbind(mydat0,overdiag); colnames(mydat0)[ncol(mydat0)] = vname


		}# end of for(j in 1:length(colname)){


		##### total overdiagnosis rate ####

		#"LCcases.sdet90"         "LCcasesOver90"

		LC.overRate90 = 100*(mydat0[,"LCcasesOver90"]/mydat0[,"LCcases.sdet90"])

		mydat=cbind(mydat0,LC.overRate90=LC.overRate90)

		## remove all NA colums

		indic=colSums(is.na(mydat))==nrow(mydat)
		mydat2=mydat[,!indic]

		mydat2

}#end of function


		myDecomposeScenario <- function(x){

				sc=x
				sc
				#  [1] "NoScreen"      "A-45-75-10-10" "B-45-75-10-10" "T-45-75-10-10" "A-45-75-10-15"
				#  [6] "B-45-75-10-15" "T-45-75-10-15" "A-45-75-10-20" "B-45-75-10-20" "T-45-75-10-20"

				### change "NoScreen" to "NA-NA-NA-NA-NA" format

				sc2=gsub("NoScreen","NA-NA-NA-NA-NA",sc)
				sc2=gsub("noscreen","NA-NA-NA-NA-NA",sc2)
				tm1=unlist(strsplit(sc2,split="-"))

				freq = tm1[seq(1,length(tm1), by=5)] ; freq[freq=="NA"]=NA
				age.start = tm1[seq(2,length(tm1), by=5)];  age.start[age.start=="NA"]=NA
				age.stop = tm1[seq(3,length(tm1), by=5)]; age.stop[age.stop=="NA"]=NA
				PY = tm1[seq(4,length(tm1), by=5)]; PY[PY=="NA"]=NA
				YSQ = tm1[seq(5,length(tm1), by=5)]; YSQ[YSQ=="NA"]=NA

				ans=cbind(freq=freq, age.start=age.start, age.stop=age.stop, PY=PY, YSQ=YSQ)
				ans
				# > ans[1:5,]
				#      freq age.start age.stop PY   YSQ
				# [1,] "A"  "45"      "75"     "10" "10"
				# [2,] "A"  "45"      "75"     "10" "15"
				# [3,] "A"  "45"      "75"     "10" "20"
				# [4,] "A"  "45"      "75"     "10" "25"
				# [5,] "A"  "45"      "75"     "20" "10"

		}#myDecomposeScenario


		myFirstLC <- function(x, mat){

				#          ID yearDiag
				# 16 36261837     1996



				rowNum = as.numeric(row.names(x)) #[1] 3
				id=as.numeric(x[1]);id #[1] 15960042

				yearD = as.numeric(x["yearDiag"]) #[1] 1992

				## take all records of this person
				indic=mat[,"ID"]==id
				sum(indic)
				mat2=mat[indic,];mat2
				# > mat2
				#          ID yearDiag
				# 16 36261837     1996
				# 17 36261837     1996
				# 18 36261837     1999

				#           ID yearDiag firstLC
				# 388 16321495     1992       1
				# 389 16321495     2000       0
				# 390 16321495     2000       0
				# 391 16321495     2003       0

				rowNums=as.numeric(row.names(mat2))
				#rowNums
				#[1] 16 17 18
				#[1] 388 389 390 391


				### is this row having the smallest yearDiag of all?

				indicFirst = (yearD==min(mat2[,"yearDiag"]))
				indicFirst

				### if it's second row then it's NOT first ###

				if (sum(mat2[,"yearDiag"]==min(mat2[,"yearDiag"])) > 1){  # there are more than 2 minimum

					if(rowNum!=min(rowNums))  indicFirst=F

				}#

				1*indicFirst

			}#end of

		#########4/14/2015: update SPLC status using 3rd, 4th and 5th LC in case 2nd doesn't meet the standard ##

		mySecondLCb <- function(x, mat,thr.year){

				#          ID yearDiag firstLC firstLC
				# 18 36261837     1999   FALSE   FALSE

				rowNum = as.numeric(row.names(x)) #[1] 3
				id=as.numeric(x[1]);id #[1] 15960042

				yearD = as.numeric(x["yearDiag"]) #[1] 1992
				first.lc = x["firstLC"]

				## take all records of this person
				indic=mat[,"ID"]==id
				sum(indic)
				mat2=mat[indic,];mat2
				# > mat2
				#          ID yearDiag firstLC firstLC
				# 16 36261837     1996    TRUE    TRUE
				# 17 36261837     1996   FALSE   FALSE
				# 18 36261837     1999   FALSE   FALSE

				rowNums=as.numeric(row.names(mat2))
				#rowNums
				#[1] 16 17 18
				first.lc.year = mat2[mat2[,"firstLC"]==T,"yearDiag"]; first.lc.year
				#[1] 1996


				secondLC = (first.lc == F) &   (yearD - first.lc.year) >= thr.year
				#secondLC = (first.lc == F) &   (yearD - first.lc.year) >= 5

				ans=1*secondLC #[1] 0


				ans


			}#end of	mySecondLC

		mySecondLC <- function(x, mat,thr.year){

				#          ID yearDiag firstLC firstLC
				# 18 36261837     1999   FALSE   FALSE

# > x
#           ID yearDiag firstLC
# 388 16321495     1992       1

				rowNum = as.numeric(row.names(x)) #[1] 3
				id=as.numeric(x[1]);id #[1] 15960042

				yearD = as.numeric(x["yearDiag"]) #[1] 1992
				first.lc = x["firstLC"]
# > yearD
# [1] 1992
# > first.lc
#     firstLC
# 388       1

				## take all records of this person
				indic=mat[,"ID"]==id
				sum(indic)
				mat2=mat[indic,];mat2
				mat2
				#          ID yearDiag firstLC firstLC
				# 16 36261837     1996    TRUE    TRUE
				# 17 36261837     1996   FALSE   FALSE
				# 18 36261837     1999   FALSE   FALSE
		 #          ID yearDiag firstLC
		# 388 16321495     1992       1
		# 389 16321495     2000       0
		# 390 16321495     2000       0
		# 391 16321495     2003       0

				rowNums=as.numeric(row.names(mat2))
				#rowNums
				#[1] 16 17 18
				first.lc.year = mat2[mat2[,"firstLC"]==T,"yearDiag"]; first.lc.year
				#[1] 1996

	secondLC = (first.lc == F) &   (yearD - first.lc.year) > thr.year

				#secondLC = (first.lc == F) &   (yearD - first.lc.year) >= thr.year
				#secondLC = (first.lc == F) &   (yearD - first.lc.year) >= 5

				1*secondLC


			}#end of	mySecondLC
	####### in addition to 2 year threshold, also apply different histology threshold ###
		mySecondLC2 <- function(x, mat2,thr.year){

				#        ID   yearDiag  histology    firstLC
				# "15960042"     "1998"      "OTH"        "0"
				# >
				rowNum = as.numeric(row.names(x)) #[1] 3
				id=as.numeric(as.character(x[1]));id #[1] 15960042

				yearD = as.numeric(x["yearDiag"]) #[1] 1992
				first.lc = as.numeric(x["firstLC"]) #[1] 0
				histo = as.character(unlist(x["histology"]));histo

				## take all records of this person
				indic=mat2[,"ID"]==id
				sum(indic)
				mat3=mat2[indic,];mat3
				# > mat3
				#        ID yearDiag histology firstLC
				# 1 15960042     1998        SQ       1
				# 2 15960042     1998       OTH       0
				# >
				rowNums=as.numeric(row.names(mat3))
				#rowNums
				#[1] 16 17 18

				### take first primary information ##
				first.lc.year = as.numeric(mat3[mat3[,"firstLC"]==1,"yearDiag"]); first.lc.year
				#[1] 1996

				first.lc.histo = as.character(unlist((mat3[mat3[,"firstLC"]==1,"histology"]))); first.lc.histo

				### define second primary
				#secondLC = ((first.lc == 0) &   (yearD - first.lc.year) >= thr.year ) |  ((first.lc == 0) &   first.lc.histo!=histo )
			secondLC = ((first.lc == 0) &   (yearD - first.lc.year) >= thr.year ) |  ((first.lc == 0) &   first.lc.histo!=histo  )

					secondLC

				as.vector(1*secondLC)


			}#end of	mySecondLC






		myDat.SPL <- function(DAT, myColNames1, myColNames2, nm1, nm2){

			# > myColNames1
			# [1] "ID"           "firstPrimary" "numPrimaries" "sex"          "race"
			# > myColNames2
			# [1] "yearDiag"    "ageDiag"     "histology"   "ageDiag.cat" "survYear"    "stage"       "node"        "extent"      "size"
			# > nm1
			# [1] "yearDiag.IPL"    "ageDiag.IPL"     "histology.IPL"   "ageDiag.cat.IPL" "survYear.IPL"    "stage.IPL"       "node.IPL"        "extent.IPL"      "size.IPL"
			# > nm2
			# [1] "yearDiag.SPL"    "ageDiag.SPL"     "histology.SPL"   "ageDiag.cat.SPL" "survYear.SPL"    "stage.SPL"       "node.SPL"        "extent.SPL"      "size.SPL"

			tm1=DAT[,myColNames1]
			tm2=DAT[,myColNames2];colnames(tm2)=nm1
			tm3=matrix(NA,ncol=length(nm2),nrow(DAT));colnames(tm3)=nm2;

			DAT.out = cbind(tm1,tm2,tm3, SPL=rep(0,nrow(DAT)))
			# > DAT.out[1:3,]
			#   ID firstPrimary numPrimaries sex race yearDiag.IPL ageDiag.IPL histology.IPL ageDiag.cat.IPL survYear.IPL stage.IPL node.IPL extent.IPL size.IPL yearDiag.SPL ageDiag.SPL histology.SPL
			# 2  8            1            1   1    a         1992          47            AD           45-49           12         1        0         73       50           NA          NA            NA
			# 4 36            1            1   0    w         1992          39            LC          lst.40            1         1        1         78       NA           NA          NA            NA
			# 6 90            1            1   0    w         1988          60            SQ           60-64            3         1        1         85       25           NA          NA            NA
			#   ageDiag.cat.SPL survYear.SPL stage.SPL node.SPL extent.SPL size.SPL numLC
			# 2              NA           NA        NA       NA         NA       NA     1
			# 4              NA           NA        NA       NA         NA       NA     1
			# 6              NA           NA        NA       NA         NA       NA     1
		    DAT.out

		 }#  myDat.SPL


		myDat.SPL2 <- function(DAT, myColNames1, myColNames2, nm1, nm2){

			# > myColNames1
			# [1] "ID"           "firstPrimary" "numPrimaries" "sex"          "race"
			# > myColNames2
			# [1] "yearDiag"    "ageDiag"     "histology"   "ageDiag.cat" "survYear"    "stage"       "node"        "extent"      "size"
			# > nm1
			# [1] "yearDiag.IPL"    "ageDiag.IPL"     "histology.IPL"   "ageDiag.cat.IPL" "survYear.IPL"    "stage.IPL"       "node.IPL"        "extent.IPL"      "size.IPL"
			# > nm2
			# [1] "yearDiag.SPL"    "ageDiag.SPL"     "histology.SPL"   "ageDiag.cat.SPL" "survYear.SPL"    "stage.SPL"       "node.SPL"        "extent.SPL"      "size.SPL"

			tm1=DAT[,myColNames1]
			tm2=DAT[,myColNames2];colnames(tm2)=nm1
			tm3=matrix(NA,ncol=length(nm2),nrow(DAT));colnames(tm3)=nm2;

			DAT.out = cbind(tm1,tm2,tm3, SPL=rep(0,nrow(DAT)), SPL2=rep(0,nrow(DAT)))
			# > DAT.out[1:3,]
			#   ID firstPrimary numPrimaries sex race yearDiag.IPL ageDiag.IPL histology.IPL ageDiag.cat.IPL survYear.IPL stage.IPL node.IPL extent.IPL size.IPL yearDiag.SPL ageDiag.SPL histology.SPL
			# 2  8            1            1   1    a         1992          47            AD           45-49           12         1        0         73       50           NA          NA            NA
			# 4 36            1            1   0    w         1992          39            LC          lst.40            1         1        1         78       NA           NA          NA            NA
			# 6 90            1            1   0    w         1988          60            SQ           60-64            3         1        1         85       25           NA          NA            NA
			#   ageDiag.cat.SPL survYear.SPL stage.SPL node.SPL extent.SPL size.SPL numLC
			# 2              NA           NA        NA       NA         NA       NA     1
			# 4              NA           NA        NA       NA         NA       NA     1
			# 6              NA           NA        NA       NA         NA       NA     1
		    DAT.out

		 }#  myDat.SPL


		#### 1/19/2015 clean up the numbers (generate one figure without median ###########

		myAverageBoxplot2b=function(DATA,Models){

				# > DATA[1:5,]
				#               X overdiag subtype   Model Gender
				# 1      NoScreen       NA Overall Erasmus Female
				# 2 A-45-75-10-10 9.783653 Overall Erasmus Female
				# 3 B-45-75-10-10 9.623033 Overall Erasmus Female
				# 4 T-45-75-10-10 9.612586 Overall Erasmus Female
				# 5 A-45-75-10-15 9.716076 Overall Erasmus Female

				### take all scenarios ##
				idx = DATA[,"Model"]=="Stanford" & DATA[,"subtype"]=="Overall" & DATA[,"Gender"]=="Female"
				sc=as.character(DATA[idx,"X"])
				# > length(sc)
				# [1] 577

				#### only take overall #####
				indx.all = DATA[,"subtype"]=="Overall"
				DAT.ov = DATA[indx.all,]


				##### get average for each scenario by gender ###
				j=u=1

				genders=c("Female","Male")
				for(j in 1:length(genders)){

					for(u in 1:length(Models)){

						gn = genders[j]
						md = Models[u]

						ind2 = DAT.ov[,"Gender"]==gn & DAT.ov[,"Model"]==md
						dt1=DAT.ov[ind2,]
						y=dt1[,"X"]; x=sc

						tt=match.order(x,y)
						rows=tt[[1]]
						# > rows[1:5]
						# [1]  2  5  8 11 14

						if(length(rows)!=length(sc)) print("error! # of rows not matching")

						dt2=dt1[rows,]
						# > dt2[1:5,]
						#                X overdiag subtype   Model Gender
						# 2  A-45-75-10-10 9.783653 Overall Erasmus Female
						# 5  A-45-75-10-15 9.716076 Overall Erasmus Female
						# 8  A-45-75-10-20 9.573307 Overall Erasmus Female
						# 11 A-45-75-10-25 9.454537 Overall Erasmus Female
						# 14 A-45-75-20-10 9.950158 Overall Erasmus Female

						colnames(dt2)[2]=md
						out=dt2[,2]
						names(out)=sc

						if(u==1) OUT=out
						if(u>1) OUT=cbind(OUT,out)

					}# models

					# > OUT[1:5,]
					#                 Erasmus    FH      MGH Stanford
					# A-45-75-10-10  9.939709 12.50 3.608520      7.2
					# A-45-75-10-15  9.882606 12.52 3.903122      7.2
					# A-45-75-10-20  9.784929 12.28 4.390360      7.1
					# A-45-75-10-25  9.701407 12.33 4.863035      7.4
					# A-45-75-20-10 10.077736 12.56 3.731053      8.3
					# > DAT.ov[DAT.ov[,"X"]=="B-45-80-40-20",]
					#                   X  overdiag subtype    Model Gender
					# 93    B-45-80-40-20 12.247920 Overall  Erasmus Female
					# 2978  B-45-80-40-20 11.926454 Overall  Erasmus   Male
					# 5863  B-45-80-40-20 20.890000 Overall       FH Female
					# 9902  B-45-80-40-20 13.590000 Overall       FH   Male
					# 14247 B-45-80-40-20  4.763827 Overall      MGH Female
					# 18286 B-45-80-40-20  4.514256 Overall      MGH   Male
					# 22149 B-45-80-40-20  9.200000 Overall Stanford Female
					# 25611 B-45-80-40-20  9.400000 Overall Stanford   Male

					colnames(OUT)=Models
					# > OUT[1:5,]
					#                Erasmus    FH      MGH Stanford
					# A-45-75-10-10 9.783653 15.41 3.428810      7.0
					# A-45-75-10-15 9.716076 16.52 3.728893      6.9
					# A-45-75-10-20 9.573307 17.07 4.224569      7.4
					# A-45-75-10-25 9.454537 17.53 4.458599      7.4
					# A-45-75-20-10 9.950158 15.43 3.512195      8.1

					### average ##
					tt=apply(OUT,1,mean,na.rm=T)
					# > tt[1:10]
					# A-45-75-10-10 A-45-75-10-15 A-45-75-10-20 A-45-75-10-25 A-45-75-20-10 A-45-75-20-15 A-45-75-20-20 A-45-75-20-25 A-45-75-30-10 A-45-75-30-15
					#      8.312057      8.376432      8.388822      8.573610      8.667197      8.927474      8.994827      9.064736      9.198919      9.466736
					tt2=cbind(overdiag=tt, gender=rep(gn,length(tt)))

					if(j==1) OUT.all = tt2
					if(j>1) OUT.all=rbind(OUT.all,tt2)

				}#genders

				# > OUT.all[1:5,]
				#               overdiag        gender
				# A-45-75-10-10 "8.9056158675"  "Female"
				# A-45-75-10-15 "9.2162423645"  "Female"
				# A-45-75-10-20 "9.56696902625" "Female"
				# A-45-75-10-25 "9.7107838315"  "Female"
				# A-45-75-20-10 "9.2480882305"  "Female"

				dat.od = OUT.all


				###### (2) Plot by strategies #########

				sc2= row.names(dat.od)
				SC=myDecomposeScenario(sc2)
				# > SC[1:5,]
				#      freq age.start age.stop PY   YSQ
				# [1,] "A"  "45"      "75"     "10" "10"
				# [2,] "A"  "45"      "75"     "10" "15"

				mydata = cbind(dat.od, SC)
				# > mydata[1:5,]
				#               overdiag        gender   freq age.start age.stop PY   YSQ
				# A-45-75-10-10 "8.9056158675"  "Female" "A"  "45"      "75"     "10" "10"
				# A-45-75-10-15 "9.2162423645"  "Female" "A"  "45"      "75"     "10" "15"
				# A-45-75-10-20 "9.56696902625" "Female" "A"  "45"      "75"     "10" "20"
				# A-45-75-10-25 "9.7107838315"  "Female" "A"  "45"      "75"     "10" "25"
				# A-45-75-20-10 "9.2480882305"  "Female" "A"  "45"      "75"     "20" "10"

				colnames(mydata)[3]="age.interval"

				mycolnames=c("overdiag","age.interval","age.start","age.stop","PY","YSQ")
				varfeatures=c(rep("con",1), rep("cat",5))

				x1name="overdiag"
				x2names=mycolnames

				par("mar"=c(5,5,4,2))
				YLIM=c(1,18)
				#if(MD=="FH" | MD=="MCH") YLIM=c(5,35)
				DATA0=mydata; row.names(DATA0)=1:nrow(mydata)
				DATA0=data.frame(DATA0)
				DATA0[,1]=as.numeric(as.character(DATA0[,1]))



				for(u in 1:length(genders)){

						gn=genders[u]
						MAIN=paste("[",gn,"] ","Average",sep="")
						idx = DATA0[,"gender"]==gn
						DATA=DATA0[idx,]

						myInvestigate.variable3b(x1name,x2names,DATA,varfeatures,YLIM,MAIN)

				}#


				##### gender plot ########

				mycolnames=c("overdiag","gender","YSQ")
				varfeatures=c(rep("con",1), rep("cat",2))

				x1name="overdiag"
				x2names=mycolnames

				DATA=DATA0
				myInvestigate.variable3b(x1name,x2names,DATA,varfeatures,YLIM,MAIN="Average")

				ans=dat.od
				#ans
				# > dat.od[1:5,]
				#               overdiag        gender
				# A-45-75-10-10 "8.9056158675"  "Female"
				# A-45-75-10-15 "9.2162423645"  "Female"
				# A-45-75-10-20 "9.56696902625" "Female"
				# A-45-75-10-25 "9.7107838315"  "Female"
				# A-45-75-20-10 "9.2480882305"  "Female"

				######## average of both gender #######

				idx.f = DATA0[,"gender"]=="Female"
				idx.m = DATA0[,"gender"]=="Male"
				DATA.f = DATA0[idx.f,]
				DATA.m = DATA0[idx.m,]
				# > dim(DATA.f)
				# [1] 577   7
				# > dim(DATA.m)
				# [1] 577   7
				# > DATA.f[1:5,]
				#   overdiag gender age.interval age.start age.stop PY YSQ
				# 1 8.905616 Female            A        45       75 10  10
				# 2 9.216242 Female            A        45       75 10  15
				# 3 9.566969 Female            A        45       75 10  20
				# 4 9.710784 Female            A        45       75 10  25
				# 5 9.248088 Female            A        45       75 20  10

				tmp1=cbind(DATA.f[,"overdiag"], DATA.m[,"overdiag"])
				# > tmp1[1:5,]
				#          [,1]     [,2]
				# [1,] 8.905616 8.312057
				# [2,] 9.216242 8.376432
				# [3,] 9.566969 8.388822

				# > dim(tmp1)
				# [1] 577   2

				mn=apply(tmp1,1,mean,na.rm=T)

				scn = paste(as.character(DATA.f[,"age.interval"]),as.character(DATA.f[,"age.start"]), as.character(DATA.f[,"age.stop"]),as.character(DATA.f[,"PY"]),as.character(DATA.f[,"YSQ"]),sep="-")
				scn=gsub("NA-NA-NA-NA-NA","NoScreen",scn)

				mydatt2= matrix(mn,ncol=1);colnames(mydatt2)="overdiag"
				row.names(mydatt2)=scn
				# > mydatt2
				#                overdiag
				# A-45-75-10-10  8.596336
				# A-45-75-10-15  8.771521
				# A-45-75-10-20  8.756336
				# A-45-75-10-25  8.879784
				# A-45-75-20-10  8.670143
				# A-45-75-20-15  8.857528
				# A-45-75-20-20  8.877621
				# A-45-75-20-25  8.997349
				# A-45-75-30-10  8.991043
				# A-45-75-30-15  9.183756

				mydatt3=cbind(mydatt2,DATA.f[idx.f,-c(1:2)])
				# > mydatt3[1:5,]
				#               overdiag age.interval age.start age.stop PY YSQ
				# A-45-75-10-10 8.596336            A        45       75 10  10
				# A-45-75-10-15 8.771521            A        45       75 10  15
				# A-45-75-10-20 8.756336            A        45       75 10  20
				# A-45-75-10-25 8.879784            A        45       75 10  25
				# A-45-75-20-10 8.670143            A        45       75 20  10

				mycolnames=c("overdiag","age.interval","age.start","age.stop","PY","YSQ")
				varfeatures=c(rep("con",1), rep("cat",5))

				x1name="overdiag"
				x2names=mycolnames

				par("mar"=c(5,5,4,2))
				YLIM=c(1,18)
				#if(MD=="FH" | MD=="MCH") YLIM=c(5,35)
				DATA=data.frame(mydatt3)

				MAIN=c("Gender average")

				myInvestigate.variable3b(x1name,x2names,DATA,varfeatures,YLIM,MAIN)

				boxplot(mn, col="red", main=MAIN,ylab="Overdiagnosis Rate (%)")
				text(1, mean(mn,na.rm=T)+3, round(mean(mn,na.rm=T),2),col="blue",cex=1.5 )


				######final output ######

				OUT= cbind(female=DATA.f[,"overdiag"], male=DATA.m[,"overdiag"], mydatt3)
				# > OUT[1:5,]
				#                 female     male overdiag age.interval age.start age.stop PY YSQ
				# A-45-75-10-10 8.880616 8.312057 8.596336            A        45       75 10  10
				# A-45-75-10-15 9.188279 8.354762 8.771521            A        45       75 10  15
				# A-45-75-10-20 9.284549 8.228123 8.756336            A        45       75 10  20
				# A-45-75-10-25 9.483046 8.276522 8.879784            A        45       75 10  25
				# A-45-75-20-10 8.948088 8.392197 8.670143            A        45       75 20  10

				OUT

		}#end of myAverageBoxplot




		myAverageBoxplot=function(DATA,Models){

				# > DATA[1:5,]
				#               X overdiag subtype   Model Gender
				# 1      NoScreen       NA Overall Erasmus Female
				# 2 A-45-75-10-10 9.783653 Overall Erasmus Female
				# 3 B-45-75-10-10 9.623033 Overall Erasmus Female
				# 4 T-45-75-10-10 9.612586 Overall Erasmus Female
				# 5 A-45-75-10-15 9.716076 Overall Erasmus Female

				### take all scenarios ##
				idx = DATA[,"Model"]=="Stanford" & DATA[,"subtype"]=="Overall" & DATA[,"Gender"]=="Female"
				sc=as.character(DATA[idx,"X"])
				# > length(sc)
				# [1] 577

				#### only take overall #####
				indx.all = DATA[,"subtype"]=="Overall"
				DAT.ov = DATA[indx.all,]


				##### get average for each scenario by gender ###
				j=u=1

				genders=c("Female","Male")
				for(j in 1:length(genders)){

					for(u in 1:length(Models)){

						gn = genders[j]
						md = Models[u]

						ind2 = DAT.ov[,"Gender"]==gn & DAT.ov[,"Model"]==md
						dt1=DAT.ov[ind2,]
						y=dt1[,"X"]; x=sc

						tt=match.order(x,y)
						rows=tt[[1]]
						# > rows[1:5]
						# [1]  2  5  8 11 14

						if(length(rows)!=length(sc)) print("error! # of rows not matching")

						dt2=dt1[rows,]
						# > dt2[1:5,]
						#                X overdiag subtype   Model Gender
						# 2  A-45-75-10-10 9.783653 Overall Erasmus Female
						# 5  A-45-75-10-15 9.716076 Overall Erasmus Female
						# 8  A-45-75-10-20 9.573307 Overall Erasmus Female
						# 11 A-45-75-10-25 9.454537 Overall Erasmus Female
						# 14 A-45-75-20-10 9.950158 Overall Erasmus Female

						colnames(dt2)[2]=md
						out=dt2[,2]
						names(out)=sc

						if(u==1) OUT=out
						if(u>1) OUT=cbind(OUT,out)

					}# models

					# > OUT[1:5,]
					#                 Erasmus    FH      MGH Stanford
					# A-45-75-10-10  9.939709 12.50 3.608520      7.2
					# A-45-75-10-15  9.882606 12.52 3.903122      7.2
					# A-45-75-10-20  9.784929 12.28 4.390360      7.1
					# A-45-75-10-25  9.701407 12.33 4.863035      7.4
					# A-45-75-20-10 10.077736 12.56 3.731053      8.3
					# > DAT.ov[DAT.ov[,"X"]=="B-45-80-40-20",]
					#                   X  overdiag subtype    Model Gender
					# 93    B-45-80-40-20 12.247920 Overall  Erasmus Female
					# 2978  B-45-80-40-20 11.926454 Overall  Erasmus   Male
					# 5863  B-45-80-40-20 20.890000 Overall       FH Female
					# 9902  B-45-80-40-20 13.590000 Overall       FH   Male
					# 14247 B-45-80-40-20  4.763827 Overall      MGH Female
					# 18286 B-45-80-40-20  4.514256 Overall      MGH   Male
					# 22149 B-45-80-40-20  9.200000 Overall Stanford Female
					# 25611 B-45-80-40-20  9.400000 Overall Stanford   Male

					colnames(OUT)=Models
					# > OUT[1:5,]
					#                Erasmus    FH      MGH Stanford
					# A-45-75-10-10 9.783653 15.41 3.428810      7.0
					# A-45-75-10-15 9.716076 16.52 3.728893      6.9
					# A-45-75-10-20 9.573307 17.07 4.224569      7.4
					# A-45-75-10-25 9.454537 17.53 4.458599      7.4
					# A-45-75-20-10 9.950158 15.43 3.512195      8.1

					### average ##
					tt=apply(OUT,1,mean,na.rm=T)
					# > tt[1:10]
					# A-45-75-10-10 A-45-75-10-15 A-45-75-10-20 A-45-75-10-25 A-45-75-20-10 A-45-75-20-15 A-45-75-20-20 A-45-75-20-25 A-45-75-30-10 A-45-75-30-15
					#      8.312057      8.376432      8.388822      8.573610      8.667197      8.927474      8.994827      9.064736      9.198919      9.466736
					tt2=cbind(overdiag=tt, gender=rep(gn,length(tt)))

					if(j==1) OUT.all = tt2
					if(j>1) OUT.all=rbind(OUT.all,tt2)

				}#genders

				# > OUT.all[1:5,]
				#               overdiag        gender
				# A-45-75-10-10 "8.9056158675"  "Female"
				# A-45-75-10-15 "9.2162423645"  "Female"
				# A-45-75-10-20 "9.56696902625" "Female"
				# A-45-75-10-25 "9.7107838315"  "Female"
				# A-45-75-20-10 "9.2480882305"  "Female"

				dat.od = OUT.all


				###### (2) Plot by strategies #########

				sc2= row.names(dat.od)
				SC=myDecomposeScenario(sc2)
				# > SC[1:5,]
				#      freq age.start age.stop PY   YSQ
				# [1,] "A"  "45"      "75"     "10" "10"
				# [2,] "A"  "45"      "75"     "10" "15"

				mydata = cbind(dat.od, SC)
				# > mydata[1:5,]
				#               overdiag        gender   freq age.start age.stop PY   YSQ
				# A-45-75-10-10 "8.9056158675"  "Female" "A"  "45"      "75"     "10" "10"
				# A-45-75-10-15 "9.2162423645"  "Female" "A"  "45"      "75"     "10" "15"
				# A-45-75-10-20 "9.56696902625" "Female" "A"  "45"      "75"     "10" "20"
				# A-45-75-10-25 "9.7107838315"  "Female" "A"  "45"      "75"     "10" "25"
				# A-45-75-20-10 "9.2480882305"  "Female" "A"  "45"      "75"     "20" "10"

				colnames(mydata)[3]="age.interval"

				mycolnames=c("overdiag","age.interval","age.start","age.stop","PY","YSQ")
				varfeatures=c(rep("con",1), rep("cat",5))

				x1name="overdiag"
				x2names=mycolnames

				par("mar"=c(5,5,4,2))
				YLIM=c(1,18)
				#if(MD=="FH" | MD=="MCH") YLIM=c(5,35)
				DATA0=mydata; row.names(DATA0)=1:nrow(mydata)
				DATA0=data.frame(DATA0)
				DATA0[,1]=as.numeric(as.character(DATA0[,1]))



				for(u in 1:length(genders)){

						gn=genders[u]
						MAIN=paste("[",gn,"] ","Average",sep="")
						idx = DATA0[,"gender"]==gn
						DATA=DATA0[idx,]

						myInvestigate.variable3(x1name,x2names,DATA,varfeatures,YLIM,MAIN)

				}#


				##### gender plot ########

				mycolnames=c("overdiag","gender","YSQ")
				varfeatures=c(rep("con",1), rep("cat",2))

				x1name="overdiag"
				x2names=mycolnames

				DATA=DATA0
				myInvestigate.variable3(x1name,x2names,DATA,varfeatures,YLIM,MAIN="Average")

				ans=dat.od
				#ans
				# > dat.od[1:5,]
				#               overdiag        gender
				# A-45-75-10-10 "8.9056158675"  "Female"
				# A-45-75-10-15 "9.2162423645"  "Female"
				# A-45-75-10-20 "9.56696902625" "Female"
				# A-45-75-10-25 "9.7107838315"  "Female"
				# A-45-75-20-10 "9.2480882305"  "Female"

				######## average of both gender #######

				idx.f = DATA0[,"gender"]=="Female"
				idx.m = DATA0[,"gender"]=="Male"
				DATA.f = DATA0[idx.f,]
				DATA.m = DATA0[idx.m,]
				# > dim(DATA.f)
				# [1] 577   7
				# > dim(DATA.m)
				# [1] 577   7
				# > DATA.f[1:5,]
				#   overdiag gender age.interval age.start age.stop PY YSQ
				# 1 8.905616 Female            A        45       75 10  10
				# 2 9.216242 Female            A        45       75 10  15
				# 3 9.566969 Female            A        45       75 10  20
				# 4 9.710784 Female            A        45       75 10  25
				# 5 9.248088 Female            A        45       75 20  10

				tmp1=cbind(DATA.f[,"overdiag"], DATA.m[,"overdiag"])
				# > tmp1[1:5,]
				#          [,1]     [,2]
				# [1,] 8.905616 8.312057
				# [2,] 9.216242 8.376432
				# [3,] 9.566969 8.388822

				# > dim(tmp1)
				# [1] 577   2

				mn=apply(tmp1,1,mean,na.rm=T)

				scn = paste(as.character(DATA.f[,"age.interval"]),as.character(DATA.f[,"age.start"]), as.character(DATA.f[,"age.stop"]),as.character(DATA.f[,"PY"]),as.character(DATA.f[,"YSQ"]),sep="-")
				scn=gsub("NA-NA-NA-NA-NA","NoScreen",scn)

				mydatt2= matrix(mn,ncol=1);colnames(mydatt2)="overdiag"
				row.names(mydatt2)=scn
				# > mydatt2
				#                overdiag
				# A-45-75-10-10  8.596336
				# A-45-75-10-15  8.771521
				# A-45-75-10-20  8.756336
				# A-45-75-10-25  8.879784
				# A-45-75-20-10  8.670143
				# A-45-75-20-15  8.857528
				# A-45-75-20-20  8.877621
				# A-45-75-20-25  8.997349
				# A-45-75-30-10  8.991043
				# A-45-75-30-15  9.183756

				mydatt3=cbind(mydatt2,DATA.f[idx.f,-c(1:2)])
				# > mydatt3[1:5,]
				#               overdiag age.interval age.start age.stop PY YSQ
				# A-45-75-10-10 8.596336            A        45       75 10  10
				# A-45-75-10-15 8.771521            A        45       75 10  15
				# A-45-75-10-20 8.756336            A        45       75 10  20
				# A-45-75-10-25 8.879784            A        45       75 10  25
				# A-45-75-20-10 8.670143            A        45       75 20  10

				mycolnames=c("overdiag","age.interval","age.start","age.stop","PY","YSQ")
				varfeatures=c(rep("con",1), rep("cat",5))

				x1name="overdiag"
				x2names=mycolnames

				par("mar"=c(5,5,4,2))
				YLIM=c(1,18)
				#if(MD=="FH" | MD=="MCH") YLIM=c(5,35)
				DATA=data.frame(mydatt3)

				MAIN=c("Gender average")

				myInvestigate.variable3(x1name,x2names,DATA,varfeatures,YLIM,MAIN)

				boxplot(mn, col="red", main=MAIN,ylab="Overdiagnosis Rate (%)")
				text(1, mean(mn,na.rm=T)+3, round(mean(mn,na.rm=T),2),col="blue",cex=1.5 )


				######final output ######

				OUT= cbind(female=DATA.f[,"overdiag"], male=DATA.m[,"overdiag"], mydatt3)
				# > OUT[1:5,]
				#                 female     male overdiag age.interval age.start age.stop PY YSQ
				# A-45-75-10-10 8.880616 8.312057 8.596336            A        45       75 10  10
				# A-45-75-10-15 9.188279 8.354762 8.771521            A        45       75 10  15
				# A-45-75-10-20 9.284549 8.228123 8.756336            A        45       75 10  20
				# A-45-75-10-25 9.483046 8.276522 8.879784            A        45       75 10  25
				# A-45-75-20-10 8.948088 8.392197 8.670143            A        45       75 20  10

				OUT

		}#end of myAverageBoxplot

######

# scns=c("A-55-75-30-15","A-55-80-30-15","A-55-75-30-10")
# colNames=c("scenario","CTscreens90","LC.overRate90","LCcasesOver90","Deaths.avoided90","MortReduct90","LifeYearsSaved90","PctEarlyStage90","LCcases.sdet90")
# percentCols=c(3,6,8)


		####### 8/28/2014: LABEL IS not clear: in addtion to model average, also add gender average ####

		myAverageBoxplot2=function(DATA,Models){

				# > DATA[1:5,]
				#               X overdiag subtype   Model Gender
				# 1      NoScreen       NA Overall Erasmus Female
				# 2 A-45-75-10-10 9.783653 Overall Erasmus Female
				# 3 B-45-75-10-10 9.623033 Overall Erasmus Female
				# 4 T-45-75-10-10 9.612586 Overall Erasmus Female
				# 5 A-45-75-10-15 9.716076 Overall Erasmus Female
				# > table(DATA[,"Gender"])
				#
				#   Female     Male Combined
				#    14425    14425    14425
				# > table(DATA[,"subtype"])
				#
				# AD.BAC.LC      NSCO   Overall        SC        SQ        AD       BAC        LC
				#      1731      5193      6924      6924      6924      5193      5193      5193

				### take all scenarios ##

				idx = DATA[,"Model"]=="Stanford" & DATA[,"subtype"]=="Overall" & DATA[,"Gender"]=="Female"
				sc=as.character(DATA[idx,"X"])
				# > length(sc)
				# [1] 577

				#### only take overall #####
				indx.all = DATA[,"subtype"]=="Overall"
				DAT.ov = DATA[indx.all,]


				##### get average for each scenario by gender ###
				j=u=1

				genders=c("BothGender","Female","Male")
				for(j in 1:length(genders)){

							for(u in 1:length(Models)){

								gn = genders[j]
								md = Models[u]

								ind2 = DAT.ov[,"Gender"]==gn & DAT.ov[,"Model"]==md
								dt1=DAT.ov[ind2,]
								y=dt1[,"X"]; x=sc

								tt=match.order(x,y)
								rows=tt[[1]]
								# > rows[1:5]
								# [1]  2  5  8 11 14

								if(length(rows)!=length(sc)) print("error! # of rows not matching")

								dt2=dt1[rows,]
								# > dt2[1:5,]
								#                X overdiag subtype   Model Gender
								# 2  A-45-75-10-10 9.783653 Overall Erasmus Female
								# 5  A-45-75-10-15 9.716076 Overall Erasmus Female
								# 8  A-45-75-10-20 9.573307 Overall Erasmus Female
								# 11 A-45-75-10-25 9.454537 Overall Erasmus Female
								# 14 A-45-75-20-10 9.950158 Overall Erasmus Female

								colnames(dt2)[2]=md
								out=dt2[,2]
								names(out)=sc

								if(u==1) OUT=out
								if(u>1) OUT=cbind(OUT,out)

							}# models

							# > OUT[1:5,]
							#                 Erasmus    FH      MGH Stanford
							# A-45-75-10-10  9.939709 12.50 3.608520      7.2
							# A-45-75-10-15  9.882606 12.52 3.903122      7.2
							# A-45-75-10-20  9.784929 12.28 4.390360      7.1
							# A-45-75-10-25  9.701407 12.33 4.863035      7.4
							# A-45-75-20-10 10.077736 12.56 3.731053      8.3
							# > DAT.ov[DAT.ov[,"X"]=="B-45-80-40-20",]
							#                   X  overdiag subtype    Model Gender
							# 93    B-45-80-40-20 12.247920 Overall  Erasmus Female
							# 2978  B-45-80-40-20 11.926454 Overall  Erasmus   Male
							# 5863  B-45-80-40-20 20.890000 Overall       FH Female
							# 9902  B-45-80-40-20 13.590000 Overall       FH   Male
							# 14247 B-45-80-40-20  4.763827 Overall      MGH Female
							# 18286 B-45-80-40-20  4.514256 Overall      MGH   Male
							# 22149 B-45-80-40-20  9.200000 Overall Stanford Female
							# 25611 B-45-80-40-20  9.400000 Overall Stanford   Male

							colnames(OUT)=Models
							# > OUT[1:5,]
							#                Erasmus    FH      MGH Stanford
							# A-45-75-10-10 9.783653 15.41 3.428810      7.0
							# A-45-75-10-15 9.716076 16.52 3.728893      6.9
							# A-45-75-10-20 9.573307 17.07 4.224569      7.4
							# A-45-75-10-25 9.454537 17.53 4.458599      7.4
							# A-45-75-20-10 9.950158 15.43 3.512195      8.1

							### average ##
							tt=apply(OUT,1,mean,na.rm=T)
							# > tt[1:10]
							# A-45-75-10-10 A-45-75-10-15 A-45-75-10-20 A-45-75-10-25 A-45-75-20-10 A-45-75-20-15 A-45-75-20-20 A-45-75-20-25 A-45-75-30-10 A-45-75-30-15
							#      8.312057      8.376432      8.388822      8.573610      8.667197      8.927474      8.994827      9.064736      9.198919      9.466736
							tt2=cbind(overdiag=tt, gender=rep(gn,length(tt)))

							if(j==1) OUT.all = tt2
							if(j>1) OUT.all=rbind(OUT.all,tt2)

				}#genders

				# > OUT.all[1:5,]
				#               overdiag        gender
				# A-45-75-10-10 "8.9056158675"  "Female"
				# A-45-75-10-15 "9.2162423645"  "Female"
				# A-45-75-10-20 "9.56696902625" "Female"
				# A-45-75-10-25 "9.7107838315"  "Female"
				# A-45-75-20-10 "9.2480882305"  "Female"

				# > OUT.all[1:5,]
				#               overdiag         gender
				# A-45-75-10-10 "8.596336462125" "Combined"
				# A-45-75-10-15 "8.771520535375" "Combined"
				# A-45-75-10-20 "8.756335905375" "Combined"
				# A-45-75-10-25 "8.879783767875" "Combined"
				# A-45-75-20-10 "8.670142820875" "Combined"
				# > table(OUT.all[,"gender"])
				#
				# Combined   Female     Male
				#      577      577      577

				dat.od = OUT.all


				###### (2) Plot by strategies #########

				sc2= row.names(dat.od)
				SC=myDecomposeScenario(sc2)
				# > SC[1:5,]
				#      freq age.start age.stop PY   YSQ
				# [1,] "A"  "45"      "75"     "10" "10"
				# [2,] "A"  "45"      "75"     "10" "15"

				mydata = cbind(dat.od, SC)
				# > mydata[1:5,]
				#               overdiag        gender   freq age.start age.stop PY   YSQ
				# A-45-75-10-10 "8.9056158675"  "Female" "A"  "45"      "75"     "10" "10"
				# A-45-75-10-15 "9.2162423645"  "Female" "A"  "45"      "75"     "10" "15"
				# A-45-75-10-20 "9.56696902625" "Female" "A"  "45"      "75"     "10" "20"
				# A-45-75-10-25 "9.7107838315"  "Female" "A"  "45"      "75"     "10" "25"
				# A-45-75-20-10 "9.2480882305"  "Female" "A"  "45"      "75"     "20" "10"

				colnames(mydata)[3]="age.interval"

				mycolnames=c("overdiag","age.interval","age.start","age.stop","PY","YSQ")
				varfeatures=c(rep("con",1), rep("cat",5))

				x1name="overdiag"
				x2names=mycolnames

				par("mar"=c(5,5,4,2))
				YLIM=c(1,18)
				#if(MD=="FH" | MD=="MCH") YLIM=c(5,35)
				DATA0=mydata; row.names(DATA0)=1:nrow(mydata)
				DATA0=data.frame(DATA0)
				DATA0[,1]=as.numeric(as.character(DATA0[,1]))



				for(u in 1:length(genders)){

						gn=genders[u]
						MAIN=paste("[",gn,"] ","Model Average",sep="")
						idx = DATA0[,"gender"]==gn
						DATA=DATA0[idx,]

						myInvestigate.variable3(x1name,x2names,DATA,varfeatures,YLIM,MAIN)

				}#


				##### gender plot ########

				mycolnames=c("overdiag","gender","YSQ")
				varfeatures=c(rep("con",1), rep("cat",2))

				x1name="overdiag"
				x2names=mycolnames

				DATA=DATA0
				myInvestigate.variable3(x1name,x2names,DATA,varfeatures,YLIM,MAIN="Average")

				ans=dat.od
				#ans
				# > dat.od[1:5,]
				#               overdiag        gender
				# A-45-75-10-10 "8.9056158675"  "Female"
				# A-45-75-10-15 "9.2162423645"  "Female"
				# A-45-75-10-20 "9.56696902625" "Female"
				# A-45-75-10-25 "9.7107838315"  "Female"
				# A-45-75-20-10 "9.2480882305"  "Female"


				######## average of both gender #######

				idx.f = DATA0[,"gender"]=="Female"
				idx.m = DATA0[,"gender"]=="Male"
				DATA.f = DATA0[idx.f,]
				DATA.m = DATA0[idx.m,]
				# > dim(DATA.f)
				# [1] 577   7
				# > dim(DATA.m)
				# [1] 577   7
				# > DATA.f[1:5,]
				#   overdiag gender age.interval age.start age.stop PY YSQ
				# 1 8.905616 Female            A        45       75 10  10
				# 2 9.216242 Female            A        45       75 10  15
				# 3 9.566969 Female            A        45       75 10  20
				# 4 9.710784 Female            A        45       75 10  25
				# 5 9.248088 Female            A        45       75 20  10

				tmp1=cbind(DATA.f[,"overdiag"], DATA.m[,"overdiag"])
				# > tmp1[1:5,]
				#          [,1]     [,2]
				# [1,] 8.905616 8.312057
				# [2,] 9.216242 8.376432
				# [3,] 9.566969 8.388822

				# > dim(tmp1)
				# [1] 577   2

				mn=apply(tmp1,1,mean,na.rm=T)

				scn = paste(as.character(DATA.f[,"age.interval"]),as.character(DATA.f[,"age.start"]), as.character(DATA.f[,"age.stop"]),as.character(DATA.f[,"PY"]),as.character(DATA.f[,"YSQ"]),sep="-")
				scn=gsub("NA-NA-NA-NA-NA","NoScreen",scn)

				mydatt2= matrix(mn,ncol=1);colnames(mydatt2)="overdiag"
				row.names(mydatt2)=scn
				# > mydatt2
				#                overdiag
				# A-45-75-10-10  8.596336
				# A-45-75-10-15  8.771521
				# A-45-75-10-20  8.756336
				# A-45-75-10-25  8.879784
				# A-45-75-20-10  8.670143
				# A-45-75-20-15  8.857528
				# A-45-75-20-20  8.877621
				# A-45-75-20-25  8.997349
				# A-45-75-30-10  8.991043
				# A-45-75-30-15  9.183756

				mydatt3=cbind(mydatt2,DATA.f[idx.f,-c(1:2)])
				# > mydatt3[1:5,]
				#               overdiag age.interval age.start age.stop PY YSQ
				# A-45-75-10-10 8.596336            A        45       75 10  10
				# A-45-75-10-15 8.771521            A        45       75 10  15
				# A-45-75-10-20 8.756336            A        45       75 10  20
				# A-45-75-10-25 8.879784            A        45       75 10  25
				# A-45-75-20-10 8.670143            A        45       75 20  10

				mycolnames=c("overdiag","age.interval","age.start","age.stop","PY","YSQ")
				varfeatures=c(rep("con",1), rep("cat",5))

				x1name="overdiag"
				x2names=mycolnames

				par("mar"=c(5,5,4,2))
				YLIM=c(1,18)
				#if(MD=="FH" | MD=="MCH") YLIM=c(5,35)
				DATA=data.frame(mydatt3)

				MAIN=c("Gender average")

				myInvestigate.variable3(x1name,x2names,DATA,varfeatures,YLIM,MAIN)

				boxplot(mn, col="red", main=MAIN,ylab="Overdiagnosis Rate (%)")
				text(1, mean(mn,na.rm=T)+3, round(mean(mn,na.rm=T),2),col="blue",cex=1.5 )


				######final output ######

				OUT= cbind(female=DATA.f[,"overdiag"], male=DATA.m[,"overdiag"], mydatt3)
				# > OUT[1:5,]
				#                 female     male overdiag age.interval age.start age.stop PY YSQ
				# A-45-75-10-10 8.880616 8.312057 8.596336            A        45       75 10  10
				# A-45-75-10-15 9.188279 8.354762 8.771521            A        45       75 10  15
				# A-45-75-10-20 9.284549 8.228123 8.756336            A        45       75 10  20
				# A-45-75-10-25 9.483046 8.276522 8.879784            A        45       75 10  25
				# A-45-75-20-10 8.948088 8.392197 8.670143            A        45       75 20  10

				OUT

		}#end of myAverageBoxplot2

getSummaryStat.small <- function(dat.f, dat.m, scns,colNames,percentCols,MD){  # overdiagnosis analysis by model


			genders=c("Female","Male")#,"Both Gender")

			ANS=rep(list(list()),2)
			names(ANS)=genders

			for( i in 1:length(genders)){


				### setup by gender ##
				gender=genders[i]
				#plotfile=paste(Head,gender,"pdf",sep=".");plotfile
				#HEAD=paste(MD, "_",Head,"_",gender," ",sep="");HEAD

				#setwd(outdir)

				if(gender=="Female")  MYDAT0=dat.f
				if(gender=="Male")    MYDAT0=dat.m

				### change scenario name ##
				########### change the column name "Freq-Start-Stop..." to "scenario" ####
				mydat0=MYDAT0
				colnames(mydat0)[grep("Freq",colnames(mydat0))]="scenario"


				MYDAT0=mydat0

				### take out two small scenarios ###
				### exclude:
				#A-55-57-30-15
				#A-62-64-30-15

				# > MYDAT0[1:5,]
				#        scenario PctEverScreened100 CTscreens100 CTscreens90 CTexams90 LCcases90 PctEarlyStage90 LCdeaths90 Alldeaths90 LcdeathsSurgery_overDiag90 Deaths.avoided90
				# 1      NoScreen          0.0000000          0.0         0.0      0.00  4506.143       0.2852949   3349.232    66455.21                         NA           0.0000
				# 2 A-45-75-10-10          0.3039177     553875.5    553875.5  96229.85  4649.663       0.4718867   2706.315    66260.41                         NA         642.9178
				# 3 B-45-75-10-10          0.3037798     286423.7    286423.7  49763.02  4616.226       0.4241022   2881.117    66314.03                         NA         468.1158
				# 4 T-45-75-10-10          0.3034888     196868.7    196868.7  34203.79  4596.467       0.3959129   2982.003    66340.75                         NA         367.2292
				# 5 A-45-75-10-15          0.3240442     630936.6    630936.6 109618.38  4660.460       0.4869740   2652.137    66234.74                         NA         697.0953


				y = as.character(MYDAT0[,"scenario"])
				x = scns

				rows= match.order(x,y)[[1]]

				if(length(rows)!=length(scns)) print("Errors: the length of two columns different")

				mydat2= MYDAT0[rows,colNames]
				# 		 scenario CTscreens90 LC.overRate90 LCcasesOver90 Deaths.avoided90 MortReduct90 LifeYearsSaved90 PctEarlyStage90 LCcases.sdet90
				# 317 A-55-75-30-15    220614.6     0.1075346      131.8056         522.6347    0.1560461         6271.433       0.4399910       1225.705
				# 365 A-55-80-30-15    238390.4     0.1265675      187.3701         606.3655    0.1810461         6699.206       0.4692545       1480.397
				# 314 A-55-75-30-10    194430.9     0.1083009      123.0783         483.6073    0.1443935         5822.443       0.4286004       1136.447

				mydat3=mydat2

				for(j in 1:length(percentCols)){

						co=percentCols[j] #[1] 3
						tm1=as.numeric(as.character(mydat2[,co]))
						#[1] 0.1075346 0.1265675 0.1083009

						if(all(tm1 <= 1)==T) mydat3[,co]=round(tm1*100,2)
						if(all(tm1 <= 1)==F) mydat3[,co]=round(tm1,2)

				}#


				### all round up for the rest

				restCols=((1:length(colNames))[-percentCols])[-1] # except for "scenario"
				#[1] 2 4 5 7 9

				for(j in 1:length(restCols)){

						co=restCols[j] #[1] 3
						tm1=as.numeric(as.character(mydat2[,co]))
						mydat3[,co]=round(tm1)

				}#

				####### make D/O ######

				tm2 = round(mydat3[,"Deaths.avoided90"]/mydat3[,"LCcasesOver90"],2)

				#co=grep("Deaths.avoided90",colnames(mydat3)) #[1] 5

				#mydat4=cbind(mydat3[,1:co], DoverO = tm2, mydat3[,(co+1):ncol(mydat3)])


				#mydat4=cbind(MD=rep(MD,nrow(mydat4)),mydat4)
				#          scenario CTscreens90 LC.overRate90 LCcasesOver90 Deaths.avoided90 MortReduct90 LifeYearsSaved90 PctEarlyStage90 LCcases.sdet90
				# 317 A-55-75-30-15    22061464         10.75         13181            52263        15.60           627143           44.00         122570
				# 365 A-55-80-30-15    23839045         12.66         18737            60637        18.10           669921           46.93         148040
				# 314 A-55-75-30-10    19443094         10.83         12308            48361        14.44           582244           42.86         113645

				mydat4=cbind(MD=rep(MD,nrow(mydat3)),mydat3, DoverD=tm2)

				ANS[[i]]=mydat4


			}# i gender


	         ANS

}#end of


    mySmall.change=function(X,percentCols2,colNames){

			for(j in 1:length(percentCols2)){

					co=percentCols2[j] #[1] 3
					tm1=as.numeric(as.character(X[,co]))
					#[1] 0.1075346 0.1265675 0.1083009

					if(all(tm1 <= 1)==T) X[,co]=round(tm1*100,2)
					if(all(tm1 <= 1)==F) X[,co]=round(tm1,2)

			}#


			### all round up for the rest

			restCols2=((1:length(colNames))[-percentCols2])[-c(1:2)] # except for "scenario"
			#[1] 2 4 5 7 9

			for(j in 1:length(restCols2)){

					co=restCols2[j] #[1] 3
					tm1=as.numeric(as.character(X[,co]))
					X[,co]=round(tm1)

			}#

			X

	}#end f
myAverageStat <- function(scns, colNames,percentCols, Models, dat.ers.f, dat.ers.m,  dat.fh.f, dat.fh.m,  dat.mgh.f, dat.mgh.m, dat.stf.f, dat.stf.m, dat.mch.f, dat.mch.m){


	ANS.m = ANS.f = rep(list(list()),length(Models))
	names(ANS.m)=names(ANS.f)=Models

	for(m in 1:length(Models)){

			# > Models
			# [1] "Erasmus"  "FH"       "MGH"      "Stanford" "MCH"
			MD=Models[m];MD  #[1] "Erasmus"

			############## (1) Define input data ###############

			if(MD=="Erasmus")  {  dat.f = dat.ers.f   ;  dat.m = dat.ers.m    ; histo = c("AD.BAC.LC","SQ","SC","NSCO")  }
			if(MD=="FH") 	   {  dat.f = dat.fh.f    ;  dat.m = dat.fh.m ; histo = c("BAC","AD","SQ","LC","SC","NSCO") }
			if(MD=="MGH")      {  dat.f = dat.mgh.f   ;  dat.m = dat.mgh.m ; histo = c("BAC","AD","SQ","LC","SC","NSCO") }
			if(MD=="Stanford") {  dat.f = dat.stf.f   ;  dat.m = dat.stf.m ; histo=c("BAC","AD","SQ","LC","SC") }
			if(MD=="MCH")      {  dat.f = dat.mch.f   ;  dat.m = dat.mch.m ; histo=c("AD.BAC","SC","NSCO2")  }


			ans=getSummaryStat.small(dat.f, dat.m, scns,colNames,percentCols,MD)

			# > ans
			# $Female
			#          scenario CTscreens90 LC.overRate90 LCcasesOver90 Deaths.avoided90 DoverO MortReduct90 LifeYearsSaved90 PctEarlyStage90 LCcases.sdet90
			# 317 A-55-75-30-15      220615         10.75           132              523   3.96        15.60             6271           44.00           1226
			# 365 A-55-80-30-15      238390         12.66           187              606   3.24        18.10             6699           46.93           1480
			# 314 A-55-75-30-10      194431         10.83           123              484   3.93        14.44             5822           42.86           1136
			#
			# $Male
			#          scenario CTscreens90 LC.overRate90 LCcasesOver90 Deaths.avoided90 DoverO MortReduct90 LifeYearsSaved90 PctEarlyStage90 LCcases.sdet90
			# 317 A-55-75-30-15      298172         11.27           176              661   3.76        17.44             7130           45.94           1566
			# 365 A-55-80-30-15      319583         12.92           234              737   3.15        19.45             7485           48.32           1808
			# 314 A-55-75-30-10      262658         11.33           169              629   3.72        16.58             6769           45.10           1490



			ANS.m[[m]]=ans$Male
			ANS.f[[m]]=ans$Female


	}#end of m models


	######## get average #########
	# > ANS.m
	# $Erasmus
	#          scenario CTscreens90 LC.overRate90 LCcasesOver90 Deaths.avoided90 DoverO MortReduct90 LifeYearsSaved90 PctEarlyStage90 LCcases.sdet90
	# 317 A-55-75-30-15      298172         11.27           176              661   3.76        17.44             7130           45.94           1566
	# 365 A-55-80-30-15      319583         12.92           234              737   3.15        19.45             7485           48.32           1808
	# 314 A-55-75-30-10      262658         11.33           169              629   3.72        16.58             6769           45.10           1490
	#
	# $FH
	#          scenario CTscreens90 LC.overRate90 LCcasesOver90 Deaths.avoided90 DoverO MortReduct90 LifeYearsSaved90 PctEarlyStage90 LCcases.sdet90
	# 318 A-55-75-30-15      297471         12.94           383              825   2.15        23.86             9044          42.188           2959
	# 366 A-55-80-30-15      325977         16.91           560              929   1.66        27.70            10185          44.610           3311
	# 315 A-55-75-30-10      269655         13.05           357              756   2.12        21.43             8364          41.481           2735
	#
	#
	sc=as.character(ANS.m[[1]][,"scenario"])
	md=rep("AVE",length(sc))

    AVE.m = cbind(MD=md, scenario=sc, (ANS.m[[1]][,-c(1:2)] + ANS.m[[2]][,-c(1:2)] + ANS.m[[3]][,-c(1:2)]+ ANS.m[[4]][,-c(1:2)])/4)
	AVE.f = cbind(MD=md, scenario=sc, (ANS.f[[1]][,-c(1:2)] + ANS.f[[2]][,-c(1:2)] + ANS.f[[3]][,-c(1:2)]+ ANS.f[[4]][,-c(1:2)])/4)
	# > AVE.f
	#     CTscreens90 LC.overRate90 LCcasesOver90 Deaths.avoided90 DoverO MortReduct90 LifeYearsSaved90 PctEarlyStage90 LCcases.sdet90
	# 317    214158.0     10.281952        166.00           466.00 3.4450     15.33843          6831.00        47.95066        1405.50
	# 365    232461.2     12.497666        238.75           527.75 2.9425     17.71828          7342.25        50.11277        1632.50
	# 314    186549.2      9.983664        145.00           422.50 3.5550     13.59894          6194.50        47.00823        1268.25



    AVE.f = mySmall.change(AVE.f, percentCols+1,colNames)
    AVE.m = mySmall.change(AVE.m, percentCols+1,colNames)

    #### make one giant file ####

    ans.f = AVE.f
    for(j in 1:length(ANS.f)){   ans.f = rbind(ans.f, ANS.f[[j]])  }

    ans.m = AVE.m
    for(j in 1:length(ANS.m)){   ans.m = rbind(ans.m, ANS.m[[j]])  }


    ans=rep(list(list()),4); names(ans)=c("ave.f","ave.m","female","male")
    ans[[1]]=AVE.f
    ans[[2]]=AVE.m
    ans[[3]]=ans.f
    ans[[4]]=ans.m
    ans



}#end of myAverageStat


#### 8/28/2014 sort the output ###
myAverageStat2 <- function(scns, colNames,percentCols, Models, dat.ers.f, dat.ers.m,  dat.fh.f, dat.fh.m,  dat.mgh.f, dat.mgh.m, dat.stf.f, dat.stf.m, dat.mch.f, dat.mch.m){


	ANS.m = ANS.f = rep(list(list()),length(Models))
	names(ANS.m)=names(ANS.f)=Models

	for(m in 1:length(Models)){

			# > Models
			# [1] "Erasmus"  "FH"       "MGH"      "Stanford" "MCH"
			MD=Models[m];MD  #[1] "Erasmus"

			############## (1) Define input data ###############

			if(MD=="Erasmus")  {  dat.f = dat.ers.f   ;  dat.m = dat.ers.m    ; histo = c("AD.BAC.LC","SQ","SC","NSCO")  }
			if(MD=="FH") 	   {  dat.f = dat.fh.f    ;  dat.m = dat.fh.m ; histo = c("BAC","AD","SQ","LC","SC","NSCO") }
			if(MD=="MGH")      {  dat.f = dat.mgh.f   ;  dat.m = dat.mgh.m ; histo = c("BAC","AD","SQ","LC","SC","NSCO") }
			if(MD=="Stanford") {  dat.f = dat.stf.f   ;  dat.m = dat.stf.m ; histo=c("BAC","AD","SQ","LC","SC") }
			if(MD=="MCH")      {  dat.f = dat.mch.f   ;  dat.m = dat.mch.m ; histo=c("AD.BAC","SC","NSCO2")  }


			ans=getSummaryStat.small(dat.f, dat.m, scns,colNames,percentCols,MD)

			# > ans
			# $Female
			#          scenario CTscreens90 LC.overRate90 LCcasesOver90 Deaths.avoided90 DoverO MortReduct90 LifeYearsSaved90 PctEarlyStage90 LCcases.sdet90
			# 317 A-55-75-30-15      220615         10.75           132              523   3.96        15.60             6271           44.00           1226
			# 365 A-55-80-30-15      238390         12.66           187              606   3.24        18.10             6699           46.93           1480
			# 314 A-55-75-30-10      194431         10.83           123              484   3.93        14.44             5822           42.86           1136
			#
			# $Male
			#          scenario CTscreens90 LC.overRate90 LCcasesOver90 Deaths.avoided90 DoverO MortReduct90 LifeYearsSaved90 PctEarlyStage90 LCcases.sdet90
			# 317 A-55-75-30-15      298172         11.27           176              661   3.76        17.44             7130           45.94           1566
			# 365 A-55-80-30-15      319583         12.92           234              737   3.15        19.45             7485           48.32           1808
			# 314 A-55-75-30-10      262658         11.33           169              629   3.72        16.58             6769           45.10           1490



			ANS.m[[m]]=ans$Male[order(ans$Male[,"CTscreens90"]),]
			ANS.f[[m]]=ans$Female[order(ans$Female[,"CTscreens90"]),]


	}#end of m models


	######## get average #########
	# > ANS.m
	# $Erasmus
	#          scenario CTscreens90 LC.overRate90 LCcasesOver90 Deaths.avoided90 DoverO MortReduct90 LifeYearsSaved90 PctEarlyStage90 LCcases.sdet90
	# 317 A-55-75-30-15      298172         11.27           176              661   3.76        17.44             7130           45.94           1566
	# 365 A-55-80-30-15      319583         12.92           234              737   3.15        19.45             7485           48.32           1808
	# 314 A-55-75-30-10      262658         11.33           169              629   3.72        16.58             6769           45.10           1490
	#
	# $FH
	#          scenario CTscreens90 LC.overRate90 LCcasesOver90 Deaths.avoided90 DoverO MortReduct90 LifeYearsSaved90 PctEarlyStage90 LCcases.sdet90
	# 318 A-55-75-30-15      297471         12.94           383              825   2.15        23.86             9044          42.188           2959
	# 366 A-55-80-30-15      325977         16.91           560              929   1.66        27.70            10185          44.610           3311
	# 315 A-55-75-30-10      269655         13.05           357              756   2.12        21.43             8364          41.481           2735
	#
	#
	sc=as.character(ANS.m[[1]][,"scenario"])
	md=rep("AVE",length(sc))

    AVE.m = cbind(MD=md, scenario=sc, (ANS.m[[1]][,-c(1:2)] + ANS.m[[2]][,-c(1:2)] + ANS.m[[3]][,-c(1:2)]+ ANS.m[[4]][,-c(1:2)])/4)
	AVE.f = cbind(MD=md, scenario=sc, (ANS.f[[1]][,-c(1:2)] + ANS.f[[2]][,-c(1:2)] + ANS.f[[3]][,-c(1:2)]+ ANS.f[[4]][,-c(1:2)])/4)
	# > AVE.f
	#     CTscreens90 LC.overRate90 LCcasesOver90 Deaths.avoided90 DoverO MortReduct90 LifeYearsSaved90 PctEarlyStage90 LCcases.sdet90
	# 317    214158.0     10.281952        166.00           466.00 3.4450     15.33843          6831.00        47.95066        1405.50
	# 365    232461.2     12.497666        238.75           527.75 2.9425     17.71828          7342.25        50.11277        1632.50
	# 314    186549.2      9.983664        145.00           422.50 3.5550     13.59894          6194.50        47.00823        1268.25



    AVE.f = mySmall.change(AVE.f, percentCols+1,colNames)
    AVE.m = mySmall.change(AVE.m, percentCols+1,colNames)

    #### make one giant file ####

    ans.f = AVE.f
    for(j in 1:length(ANS.f)){   ans.f = rbind(ans.f, ANS.f[[j]])  }

    ans.m = AVE.m
    for(j in 1:length(ANS.m)){   ans.m = rbind(ans.m, ANS.m[[j]])  }


    ans=rep(list(list()),4); names(ans)=c("ave.f","ave.m","female","male")
    ans[[1]]=AVE.f
    ans[[2]]=AVE.m
    ans[[3]]=ans.f
    ans[[4]]=ans.m
    ans



}#end of myAverageStat2


  #### 5/2/2012: put Z score and others...######
  #### 5/6/2010 take out arguments for  Estimate Std. Error    z value     Pr(>|z|)

  #bNames="Estimate"
  #sdName="Std. Error"
  #pName="Pr(>|z|)"

  myOR.CI4=function(xx,bName="Estimate",sName="Std. Error",pName="Pr(>|z|)",zName="z value",pval=F){

        #> xx=full$coef
        #> xx
        #                Estimate Std. Error    z value     Pr(>|z|)
        #(Intercept) -0.750026027 0.14114317 -5.3139379 1.072812e-07
        #geno         0.168774184 0.04662121  3.6201160 2.944709e-04
        #race1        0.297560013 0.10316615  2.8842796 3.923103e-03
        #sex1        -0.073478696 0.07416867 -0.9906972 3.218334e-01
        #age_cat1    -0.113698897 0.10863623 -1.0466020 2.952832e-01
        #age_cat2    -0.138700275 0.10581389 -1.3107945 1.899272e-01
        #age_cat3    -0.309324107 0.10913423 -2.8343453 4.591968e-03
        #age_cat4    -0.263627342 0.11893800 -2.2165106 2.665655e-02
        #age_cat5    -0.263389923 0.23039374 -1.1432165 2.529487e-01
        #smoking1     0.135488073 0.23874607  0.5674986 5.703754e-01
        #smoking2    -0.002006010 0.08506604 -0.0235818 9.811862e-01
        #smoking3    -0.373251080 0.08498864 -4.3917760 1.124285e-05
        #bmi1         0.169979498 0.08502958  1.9990631 4.560153e-02
        #bmi2         0.303177546 0.09434804  3.2133953 1.311756e-03
        #bmi3         0.579843176 0.11796522  4.9153741 8.861307e-07
        #everhbp1     0.583651325 0.06945305  8.4035372 4.332274e-17

        #tm1=as.vector(xx[,"Estimate"])
        #tm2=as.vector(xx[,"Std. Error"])
        #tm3=as.vector(xx[,"Pr(>|z|)"])

        tm1=as.vector(xx[,bName])
        tm2=as.vector(xx[,sName])
        tm3=as.vector(xx[,pName])
        tm4=as.vector(xx[,zName])

        OR=exp(tm1)
        CI0=cbind(tm1-1.96*tm2,tm1+1.96*tm2)
        CI=exp(CI0)

        #> OR
        # [1] 0.4723543 1.1838528 1.3465692 0.9291559 0.8925267 0.8704889 0.7339429
        # [8] 0.7682598 0.7684422 1.1450955 0.9979960 0.6884923 1.1852806 1.3541549
        #[15] 1.7857584 1.7925718
        #> CI
        #           [,1]      [,2]
        # [1,] 0.3581990 0.6228900
        # [2,] 1.0804705 1.2971269
        # [3,] 1.1000486 1.6483350
        # [4,] 0.8034428 1.0745392
        # [5,] 0.7213535 1.1043182
        # [6,] 0.7074449 1.0711094
        # [7,] 0.5926050 0.9089902
        # [8,] 0.6085076 0.9699518
        # [9,] 0.4892109 1.2070530
        #[10,] 0.7171615 1.8283801
        #[11,] 0.8447323 1.1790670
        #[12,] 0.5828480 0.8132853
        #[13,] 1.0033270 1.4002314
        #[14,] 1.1255315 1.6292173
        #[15,] 1.4171267 2.2502808
        #[16,] 1.5644328 2.0539799

        ans=cbind(OR=OR,CI1=CI[,1],CI2=CI[,2],beta=tm1,sd=tm2,Z=tm4)


        if(pval==T){
        ans=cbind(OR=OR,CI1=CI[,1],CI2=CI[,2],beta=tm1,sd=tm2,pval2=tm3,Z=tm4)

        }


        ans

   }# end of myOR.CI

lroc=function (logistic.model, graph = TRUE, add = FALSE, title = FALSE, line.col = "red", auc.coords = NULL, grid = TRUE, grid.col = "blue", ...)
{
    if (add) {
        title <- FALSE
    }
    if (length(grep("cbind", names(model.frame(logistic.model)))) >
        0) {
        firsttable1 <- cbind(logistic.model$fitted.values, model.frame(logistic.model)[,
            1][, 2:1])
        firsttable1 <- firsttable1[order(firsttable1[, 1]), ]
    }
    else {
        if (length(grep("(weights)", names(model.frame(logistic.model)))) >
            0) {
            firsttable <- xtabs(as.vector(model.frame(logistic.model)[,
                ncol(model.frame(logistic.model))]) ~ logistic.model$fitted.values +
                logistic.model$y)
        }
        else {
            firsttable <- table(logistic.model$fitted.values,
                logistic.model$y)
        }
        colnames(firsttable) <- c("Non-diseased", "Diseased")
        rownames(firsttable) <- substr(rownames(firsttable),
            1, 6)
        firsttable1 <- cbind(as.numeric(rownames(firsttable)),
        firsttable)
    }


    rownames(firsttable1) <- rep("", nrow(firsttable1))
    colnames(firsttable1)[1] <- "predicted.prob"
    firsttable <- firsttable1[, 2:3]

    secondtable <- firsttable

    for (i in 1:length(secondtable[, 1])) {
        secondtable[i, 1] <- (sum(firsttable[, 1]) - sum(firsttable[(1:i),
            1]))/sum(firsttable[, 1])
        secondtable[i, 2] <- (sum(firsttable[, 2]) - sum(firsttable[(1:i),
            2]))/sum(firsttable[, 2])
        rownames(secondtable)[i] <- paste(">", rownames(secondtable)[i])
    }
    secondtable <- rbind((c(1, 1)), secondtable)
    colnames(secondtable) <- c("1-Specificity", "Sensitivity")
    model.des <- deparse(logistic.model$formula)
    auc <- 0
    for (i in 1:(nrow(secondtable) - 1)) {
        auc <- auc + (secondtable[i, 1] - secondtable[(i + 1),
            1]) * 0.5 * (secondtable[i, 2] + secondtable[(i +
            1), 2])
    }
    if (graph) {
        if (!add) {
            plot(secondtable[, 1], secondtable[, 2], xlab = "1-Specificity",
                ylab = "Sensitivity", xlim = (c(0, 1)), ylim = (c(0,
                  1)), asp = 1, col = line.col, type = "l", ...)
            if (title) {
                title(main = model.des, ...)
            }
            lines(x = c(0, 1), y = c(0, 1), lty = 2, col = "blue")
            if (grid) {
                abline(v = 0, lty = 2, col = grid.col)
                abline(v = 0.2, lty = 2, col = grid.col)
                abline(v = 0.4, lty = 2, col = grid.col)
                abline(v = 0.6, lty = 2, col = grid.col)
                abline(v = 0.8, lty = 2, col = grid.col)
                abline(v = 1, lty = 2, col = grid.col)
                abline(h = 0, lty = 2, col = grid.col)
                abline(h = 0.2, lty = 2, col = grid.col)
                abline(h = 0.4, lty = 2, col = grid.col)
                abline(h = 0.6, lty = 2, col = grid.col)
                abline(h = 0.8, lty = 2, col = grid.col)
                abline(h = 1, lty = 2, col = grid.col)
            }
            auclabel <- paste("Area under the curve =", round(auc,
                3))
            if (!is.null(auc.coords)) {
                text(x = auc.coords[1], y = auc.coords[2], pos = 4,
                  labels = auclabel, ...)
            }
        }
        else {
            lines(secondtable[, 1], secondtable[, 2], col = line.col,
                ...)
        }
    }
    list(model.description = model.des, auc = auc, predicted.table = firsttable1,
        diagnostic.table = secondtable)
}

#roc.noprs=lroc(out.tr1$fit, auc.coords=c(.3,.1),Main="ROC curve for training data")

hosmerlem <-
function (y, yhat, g = 10)
	{
		cutyhat <- cut(yhat, breaks = quantile(yhat, probs = seq(0,
			1, 1/g)), include.lowest = T)
		obs <- xtabs(cbind(1 - y, y) ~ cutyhat)
		expect <- xtabs(cbind(1 - yhat, yhat) ~ cutyhat)
		chisq <- sum((obs - expect)^2/expect)
		P <- 1 - pchisq(chisq, g - 2)
		c("X^2" = chisq, Df = g - 2, "P(>Chi)" = P)
	}


myROC=function (model, line.col = "red", auc.coords=c(.3,.1), grid = TRUE, grid.col = "blue", MAIN="", ...) {

   ######### make firsttable #############

	# > names(model)
	# [1] "fitted.values" "y"


    firsttable <- table(model$fitted.values, model$y)
	# > firsttable[1:20,]
	#
	#                       0 1
	#   0.00925087949022891 1 0
	#   0.00939018249797395 1 0
	#   0.00951867933483535 1 0
	#   0.00958150474149071 0 1
	#   0.00969549844314346 1 0
	#   0.00975581349021637 1 0
	#   0.00982924684431823 1 0
	#   0.0098350787655727  1 0
	#   0.00987811678466243 1 0
	#   0.00991407036852422 1 0
	#   0.00993360034564743 1 0
	#   0.00995426534575047 1 0
	#   0.00997226487183328 1 0
	#   0.00997298235353573 0 1
	#   0.0100126426963955  1 0
	#   0.0100171727529577  1 0
	#   0.0100219959202232  1 0
	#   0.0100310273465087  1 0
	#   0.0100882808549596  1 0
	#   0.0100900013622442  1 0


	colnames(firsttable) <- c("Non-diseased", "Diseased")
	rownames(firsttable) <- substr(rownames(firsttable),  1, 6)
	# firsttable[1:5,]
	#
	#          Non-diseased Diseased
	#   0.0092            1        0
	#   0.0093            1        0
	#   0.0095            1        0
	#   0.0095            0        1
	#   0.0096            1        0

      firsttable1 <- cbind(as.numeric(rownames(firsttable)), firsttable)
		# > firsttable1[1:10,]
		#               Non-diseased Diseased
		# 0.0092 0.0092            1        0
		# 0.0093 0.0093            1        0
		# 0.0095 0.0095            1        0
		# 0.0095 0.0095            0        1
		# 0.0096 0.0096            1        0
		# 0.0097 0.0097            1        0
		# 0.0098 0.0098            1        0
		# 0.0098 0.0098            1        0
		# 0.0098 0.0098            1        0
		# 0.0099 0.0099            1        0
		#


    rownames(firsttable1) <- rep("", nrow(firsttable1))
    colnames(firsttable1)[1] <- "predicted.prob"
    firsttable <- firsttable1[, 2:3]

		# > firsttable[1:10,]
		#  Non-diseased Diseased
		#             1        0
		#             1        0
		#             1        0
		#             0        1
		#             1        0
		#             1        0
		#             1        0
		#             1        0
		#             1        0
		#             1        0






    secondtable <- firsttable
    colnames(secondtable) <- c("1-Specificity", "Sensitivity")


    for (i in 1:length(secondtable[, 1])) {


        secondtable[i, 1] <- (sum(firsttable[, 1]) - sum(firsttable[(1:i), 1]))/sum(firsttable[, 1])
        secondtable[i, 2] <- (sum(firsttable[, 2]) - sum(firsttable[(1:i),  2]))/sum(firsttable[, 2])
        rownames(secondtable)[i] <- paste(">", rownames(secondtable)[i])
    }


	#  > secondtable[1:10,]
	#    1-Specificity Sensitivity
	# >      0.9990826   1.0000000
	# >      0.9981651   1.0000000
	# >      0.9972477   1.0000000
	# >      0.9972477   0.9984051
	# >      0.9963303   0.9984051
	# >      0.9954128   0.9984051
	# >      0.9944954   0.9984051
	# >      0.9935780   0.9984051



    secondtable <- rbind((c(1, 1)), secondtable)
    colnames(secondtable) <- c("1-Specificity", "Sensitivity")
    #model.des <- deparse(logistic.model$formula)

    rownames(secondtable)=c("0",firsttable1[,1])



    auc <- 0
    for (i in 1:(nrow(secondtable) - 1)) {
        auc <- auc + (secondtable[i, 1] - secondtable[(i + 1),
            1]) * 0.5 * (secondtable[i, 2] + secondtable[(i +
            1), 2])
    }



            plot(secondtable[, 1], secondtable[, 2], xlab = "1-Specificity",    xlim = c(0, 1), ylim = c(0, 1),
                ylab = "Sensitivity",  col = line.col, type = "l",  main=MAIN,  cex.axis=1.5, cex.lab=1.5, cex.main=1.5,...)

#lines(rep(0.3,2),c(0,1))
            lines(x = c(0, 1), y = c(0, 1), lty = 2, col = "blue")
            if (grid) {
				  # vertical ##
				  lines(rep(0,2), c(0,1), lty=2, col=grid.col)
				  lines(rep(0.2,2), c(0,1), lty=2, col=grid.col)
				  lines(rep(0.4,2), c(0,1), lty=2, col=grid.col)
				  lines(rep(0.6,2), c(0,1), lty=2, col=grid.col)
				  lines(rep(0.8,2), c(0,1), lty=2, col=grid.col)
				  lines(rep(1,2), c(0,1), lty=2, col=grid.col)
				  ## horizon #
				  lines(c(0-0.04,1.04), rep(0,2), lty=2, col=grid.col)
				  lines(c(0-0.04,1.04), rep(0.2,2), lty=2, col=grid.col)
				  lines(c(0-0.04,1.04), rep(0.4,2), lty=2, col=grid.col)
				  lines(c(0-0.04,1.04), rep(0.6,2), lty=2, col=grid.col)
				  lines(c(0-0.04,1.04), rep(0.8,2), lty=2, col=grid.col)
				  lines(c(0-0.04,1.04), rep(1,2), lty=2, col=grid.col)

#                 abline(v = 0, lty = 2, col = grid.col)
#                 abline(v = 0.2, lty = 2, col = grid.col)
#                 abline(v = 0.4, lty = 2, col = grid.col)
#                 abline(v = 0.6, lty = 2, col = grid.col)
#                 abline(v = 0.8, lty = 2, col = grid.col)
#                 abline(v = 1, lty = 2, col = grid.col)
#                 abline(h = 0, lty = 2, col = grid.col)
#                 abline(h = 0.2, lty = 2, col = grid.col)
#                 abline(h = 0.4, lty = 2, col = grid.col)
#                 abline(h = 0.6, lty = 2, col = grid.col)
#                 abline(h = 0.8, lty = 2, col = grid.col)
#                 abline(h = 1, lty = 2, col = grid.col)
            }
            auclabel <- paste("AUC =", round(auc,
                3))
            if (!is.null(auc.coords)) {
                text(x = auc.coords[1], y = auc.coords[2], pos = 4,
                  labels = auclabel, cex=2,...)
            }




    list(auc = auc, predicted.table = firsttable1,
        diagnostic.table = secondtable)



  }


# y=pkyr
# x=histo
# xname="Histology"
# yname="Pack-Year"
# Main=""
myBoxplot=function(x,y,xname,yname,Main=""){

			boxplot(y~x,col="red",xlab=xname,ylab=yname,cex.lab=1.5,cex.axis=1.5)#,ylim=YLIM)
			tt=cbind(x,as.numeric(y))
			mn=aggregate(y~x,data=tt,mean,na.rm=T)
			text(1:nrow(mn),mn[,2],round(mn[,2],2),col="blue",cex=2)

			pval=NA
			tt=kruskal.test(x, y)
			pval=tt$p.value
			if(pval < 0.0001) tt1=sprintf("%.2e",pval)
			if(pval >= 0.0001) tt1=sprintf("%.3f",pval)
			title(paste(Main,"K-W P=",tt1 ))

}#


		myGenderAverage=function(x){

			# > x[1:10,]
			#                X overdiag subtype   Model Gender
			# 1       NoScreen       NA Overall Erasmus Female
			# 2  A-45-75-10-10 9.783653 Overall Erasmus Female
			# 3  B-45-75-10-10 9.623033 Overall Erasmus Female
			# 4  T-45-75-10-10 9.612586 Overall Erasmus Female
			# 5  A-45-75-10-15 9.716076 Overall Erasmus Female
			# 6  B-45-75-10-15 9.542911 Overall Erasmus Female
			# 7  T-45-75-10-15 9.537863 Overall Erasmus Female
			# 8  A-45-75-10-20 9.573307 Overall Erasmus Female
			# 9  B-45-75-10-20 9.433656 Overall Erasmus Female
			# 10 T-45-75-10-20 9.433182 Overall Erasmus Female
			# > table(x[,"Gender"])
			#
			# Female   Male
			#  14425  14425

			gn = as.character(x[,"Gender"])
			gn.u = unique(gn) #[1] "Female" "Male"


			x1=x[gn==gn.u[1],]
				x1[1:10,]
				#                X overdiag subtype   Model Gender
				# 1       NoScreen       NA Overall Erasmus Female
				# 2  A-45-75-10-10 9.783653 Overall Erasmus Female
				# 3  B-45-75-10-10 9.623033 Overall Erasmus Female
				# 4  T-45-75-10-10 9.612586 Overall Erasmus Female
				# 5  A-45-75-10-15 9.716076 Overall Erasmus Female
				# 6  B-45-75-10-15 9.542911 Overall Erasmus Female
				# 7  T-45-75-10-15 9.537863 Overall Erasmus Female
				# 8  A-45-75-10-20 9.573307 Overall Erasmus Female
				# 9  B-45-75-10-20 9.433656 Overall Erasmus Female
				# 10 T-45-75-10-20 9.433182 Overall Erasmus Female
				dim(x1)
				# [1] 14425     5

			x2=x[gn==gn.u[2],]
				x2[1:10,]
				#                  X overdiag subtype   Model Gender
				# 2886      NoScreen       NA Overall Erasmus   Male
				# 2887 A-45-75-10-10 9.939709 Overall Erasmus   Male
				# 2888 B-45-75-10-10 9.531706 Overall Erasmus   Male
				# 2889 T-45-75-10-10 9.534173 Overall Erasmus   Male
				# 2890 A-45-75-10-15 9.882606 Overall Erasmus   Male
				# 2891 B-45-75-10-15 9.457868 Overall Erasmus   Male
				# 2892 T-45-75-10-15 9.471316 Overall Erasmus   Male
				# 2893 A-45-75-10-20 9.784929 Overall Erasmus   Male
				# 2894 B-45-75-10-20 9.346899 Overall Erasmus   Male
				# 2895 T-45-75-10-20 9.372465 Overall Erasmus   Male
				dim(x2)
				# [1] 14425     5

				ans=NULL
				if(all(as.character(x1[,1])!=as.character(x2[,1]))) { print("Error: Gender rows different") }
				if(all(as.character(x1[,1])==as.character(x2[,1]))) {

				    ans=x1
				    ans[,"overdiag"]=NA
				    ans[,"Gender"]="BothGender"
				    ans[,"overdiag"] = (x1[,"overdiag"] + x2[,"overdiag"])/2
					# > ans[1:5,]
					#               X overdiag subtype   Model   Gender
					# 1      NoScreen       NA Overall Erasmus Combined
					# 2 A-45-75-10-10 9.861681 Overall Erasmus Combined
					# 3 B-45-75-10-10 9.577369 Overall Erasmus Combined
					# 4 T-45-75-10-10 9.573380 Overall Erasmus Combined
					# 5 A-45-75-10-15 9.799341 Overall Erasmus Combined

				}

			  ans


		}#end of


		myBaseHazard <- function(CLM, DATA ){  ## this calculate base hazard (for x=0) given CLM = coxph(Surv(...)~....)
				# h_average(t) = h0*exp(xbar*beta)
				# h_average(t)*exp(-xbar*beta) = h0 = baseline hazard  See "01_survival.review3.ppt"

				xbar = apply(DATA, 2, mean, na.rm=T)
				#      histology.IPLAD      histology.IPLLC     histology.IPLOTH      histology.IPLSQ ageDiag.cat.IPL00.44 ageDiag.cat.IPL45.49
				#         0.3238640762         0.0573573806         0.3135691617         0.2442139484         0.0472559796         0.0484944655
				# ageDiag.cat.IPL50.54 ageDiag.cat.IPL55.59 ageDiag.cat.IPL60.64 ageDiag.cat.IPL65.69 ageDiag.cat.IPL75.79 ageDiag.cat.IPL80.84
				#         0.0828237480         0.1200557319         0.1630931187         0.2001702918         0.1067807106         0.0419150089
				#   ageDiag.cat.IPL85.            node.IPL1            node.IPL2            node.IPL5            node.IPL6            node.IPL7
				#         0.0105658333         0.0846814769         0.1004334701         0.0107593467         0.0103336172         0.0037928632
				#            node.IPL8            node.IPL9
				#         0.0007740537         0.1284155120

				betas=summary(CLM)$coef[,1]
				CLM.d=coxph.detail(CLM)
				h.average=c(0,CLM.d$hazard)
				# > CLM.d$hazard
				#  [1] 0.011323281 0.010225231 0.009061305 0.009301026 0.008127230 0.006234139 0.005788044 0.004700145 0.005939862 0.005274111 0.004036785
				# [12] 0.001893272

				times=c(0,CLM.d$time)
				# [1]  5  6  7  8  9 10 11 12 13 14 15 16

				h0=h.average*exp(-sum(betas*xbar))
				h0
				# [1] 0.000000000 0.019123763 0.017269278 0.015303537 0.015708400 0.013725989 0.010528769 0.009775364 0.007938023 0.010031767 0.008907387
				# [12] 0.006817682 0.003197526

				### base survival: S = exp(-cumsum(h0))
				S0=exp(-cumsum(h0))
				S0
				# [1] 1.0000000 0.9810579 0.9642612 0.9496170 0.9348165 0.9220729 0.9124156 0.9035398 0.8963959 0.8874484 0.8795787 0.8736024 0.8708135

						doThis=F
						if(doThis==T){

							## average person survival
							S.average = exp(-cumsum(c(h.average))); S.average
							# [1] 1.0000000 0.9887406 0.9786820 0.9698539 0.9608751 0.9530975 0.9471742 0.9417078 0.9372920 0.9317411 0.9268400 0.9231060 0.9213600

							## survival relation base vs. xb
							## S = S0^exp(x*betas)  --> S.bar = S0^exp(xbar*betas) --> (S.bar)^-exp(xbar*betas) = S0  ( because a=b^x --< a^(1/x)=b)
							## --> S0 = s.bar^-exp(xbar.betas)

							S00 = S.average^exp(-sum(xbar*betas));S00
							# [1] 1.0000000 0.9810579 0.9642612 0.9496170 0.9348165 0.9220729 0.9124156 0.9035398 0.8963959 0.8874484 0.8795787 0.8736024 0.8708135
							# same!
						}# if(doThis==T){

				ans=cbind(times=times,h0=h0, S0=S0)
				ans
				#       times          h0        S0
				#  [1,]     0 0.000000000 1.0000000
				#  [2,]     5 0.019123763 0.9810579
				#  [3,]     6 0.017269278 0.9642612
				#  [4,]     7 0.015303537 0.9496170
				#  [5,]     8 0.015708400 0.9348165
				#  [6,]     9 0.013725989 0.9220729
				#  [7,]    10 0.010528769 0.9124156
				#  [8,]    11 0.009775364 0.9035398
				#  [9,]    12 0.007938023 0.8963959
				# [10,]    13 0.010031767 0.8874484
				# [11,]    14 0.008907387 0.8795787
				# [12,]    15 0.006817682 0.8736024
				# [13,]    16 0.003197526 0.8708135

		}#end of myBaseHazard


		#ans=myBaseHazard(CLM, DATA )
		#      times          h0        S0
		#  [1,]     0 0.000000000 1.0000000
		#  [2,]     5 0.019123763 0.9810579
		#  [3,]     6 0.017269278 0.9642612
		#  [4,]     7 0.015303537 0.9496170
		#  [5,]     8 0.015708400 0.9348165
		#  [6,]     9 0.013725989 0.9220729
		#  [7,]    10 0.010528769 0.9124156
		#  [8,]    11 0.009775364 0.9035398
		#  [9,]    12 0.007938023 0.8963959
		# [10,]    13 0.010031767 0.8874484
		# [11,]    14 0.008907387 0.8795787
		# [12,]    15 0.006817682 0.8736024
		# [13,]    16 0.003197526 0.8708135


		########### (2.3.2) Calculate Absoulte Risk Pr(0<T<=10) = int h(t)*S(t) = int_t h(t)*exp(-H(t))

		################ OK calculate Pr( 0<T <= 10; x) = sum(t) h(t;x)*S(t;x) = sum(t) h(t;x)*exp(-cumsum(h(t;x))
		########## # OR! Pr(t<T) = F(t) = 1-S(t) = 1-exp(-H(t))

		#x=xbar
		#betas
		#ttime=times

		myAbsoluteRisk <- function(x, betas, ttime, h0){ ## this gives series of risk: Pr( 0<t<=1), Pr(0<t<=2),....Pr(0<t<=15)...

				#Pr( 0<T <= 10) = sum(t) h(t)*S(t) = sum(t) h(t)*exp(-cumsum(h(t))
				# Remember, Likelihood = pr = h(t)*S(t) (= f(t))

				# > x
				#      histology.IPLAD      histology.IPLLC     histology.IPLOTH      histology.IPLSQ ageDiag.cat.IPL00.44 ageDiag.cat.IPL45.49
				#         0.3238640762         0.0573573806         0.3135691617         0.2442139484         0.0472559796         0.0484944655
				# ageDiag.cat.IPL50.54 ageDiag.cat.IPL55.59 ageDiag.cat.IPL60.64 ageDiag.cat.IPL65.69 ageDiag.cat.IPL75.79 ageDiag.cat.IPL80.84
				#         0.0828237480         0.1200557319         0.1630931187         0.2001702918         0.1067807106         0.0419150089
				# > betas
				#      histology.IPLAD      histology.IPLLC     histology.IPLOTH      histology.IPLSQ ageDiag.cat.IPL00.44 ageDiag.cat.IPL45.49
				#           -0.2720678           -0.2281380           -0.5342839           -0.1921878           -0.7928739           -0.1488597
				# ageDiag.cat.IPL50.54 ageDiag.cat.IPL55.59 ageDiag.cat.IPL60.64 ageDiag.cat.IPL65.69 ageDiag.cat.IPL75.79 ageDiag.cat.IPL80.84
				#           -0.1084184            0.0472062            0.2333315            0.1449939           -0.5471227           -0.8669960

				# > h0 --> h0(t=0), h0(t=1), h0(t=2),....
				#  [1] 0.000000000 0.019123763 0.017269278 0.015303537 0.015708400 0.013725989 0.010528769 0.009775364 0.007938023 0.010031767 0.008907387
				# [12] 0.006817682 0.003197526


				#### (1) calculate hazard: h(t)=h0*exp(x*betas) ####

				hz=h0*exp(sum(x*betas)) # h(t=0), h(t=1),...
				#  [1] 0.000000000 0.011323281 0.010225231 0.009061305 0.009301026 0.008127230 0.006234139 0.005788044 0.004700145 0.005939862 0.005274111
				# [12] 0.004036785 0.001893272

				### (2) calculate survival #####
				Sv=exp(-cumsum(hz)) # S(t=0), S(t=1),...
				# [1] 1.0000000 0.9887406 0.9786820 0.9698539 0.9608751 0.9530975 0.9471742 0.9417078 0.9372920 0.9317411 0.9268400 0.9231060 0.9213600
				# > Sv
				#  [1] 1.0000000 0.9887406 0.9786820 0.9698539 0.9608751 0.9530975 0.9471742 0.9417078 0.9372920 0.9317411 0.9268400 0.9231060 0.9213600
				# > hz*Sv
				#  [1] 0.000000000 0.011195787 0.010007249 0.008788142 0.008937125 0.007746043 0.005904816 0.005450646 0.004405409 0.005534413 0.004888256
				# [12] 0.003726381 0.001744385

				### Pr(t=0), pr(t=1), pr(t=2)....
				pr0 = hz*Sv
				#pr0
				#   [1] 0.000000000 0.011195787 0.010007249 0.008788142 0.008937125 0.007746043 0.005904816 0.005450646 0.004405409 0.005534413 0.004888256
				# [12] 0.003726381 0.001744385

				#### (3) cumulative probability:Pr( 0<t<=1), Pr(0<t<=2),....Pr(0<t<=15) ####
				pr=cumsum(hz*Sv)
				#  [1] 0.00000000 0.01119579 0.02120304 0.02999118 0.03892830 0.04667435 0.05257916 0.05802981 0.06243522 0.06796963 0.07285789 0.07658427

				names(pr)=ttime
				pr

				ans=1-Sv
				names(ans)=ttime
				ans

		}#end of





			myDecilePlot=function(k, event,Time, PROB, YLIM=c(0,0.14), MAIN){ #k=10


   					##### (1) make decile ###

					ks=1:k  #[1] 1 2 3   10
					By=1/k #0.1

					qts3=quantile(PROB, prob=seq(0,1,by=By));qts3
					#           0%          10%          20%          30%          40%          50%
					# 2.210303e-07 1.501399e-02 2.064379e-02 2.642368e-02 3.231130e-02 3.711864e-02
					#          60%          70%          80%          90%         100%
					# 4.278880e-02 4.721410e-02 5.253947e-02 5.872667e-02 2.287213e-01

					### assign decile group to each individuals


					yy=cut(PROB,breaks=qts3)
					table(yy)
					# yy
					# (2.21e-07,0.0236]   (0.0236,0.0371]   (0.0371,0.0502]    (0.0502,0.229]
					#              9304              9332              9575              9006
					yy=cut(PROB,breaks=qts3,labels=ks)
					table(yy)
					# yy
					#    1    2    3    4
					# 9304 9332 9575 9006
					# > PROB[is.na(QT)==T]
					#        92894
					# 2.210303e-07

					QT = as.numeric(as.character(yy))

					## First observation is NA due to ( ]
					QT[PROB==qts3[1]]=1

						# indic= QT==1
						# y=Y[indic]
						# sum(y==1)/length(y)

					table(QT, useNA="always")
					#    1    2    3    4    5    6    7    8    9   10 <NA>
					# 2160 1849 2247 2620 1411 2062 1708 2115 1893 1967    0


	 				####### (2) then for each group, calculate observed incidence (cumulative incidence function taking into account competing risk and censoring ###
	 				# use event and Time



						DATA2 = data.frame(Time=Time, event=event, QT=as.factor(QT))
						fgr = FGR(Hist(Time,event)~QT,data=DATA2,cause=1)
						# FGR(formula = Hist(Time, event) ~ QT, data = DATA2, cause = 1)
						#
						#       coef exp(coef) se(coef)    z p-value
						# QT2  0.518      1.68    0.213 2.43 1.5e-02
						# QT3  0.754      2.13    0.198 3.81 1.4e-04
						# QT4  1.027      2.79    0.187 5.51 3.7e-08
						# QT5  1.220      3.39    0.198 6.15 7.9e-10
						# QT6  1.183      3.27    0.188 6.31 2.9e-10
						# QT7  1.175      3.24    0.192 6.11 1.0e-09
						# QT8  1.235      3.44    0.186 6.63 3.4e-11
						# QT9  1.326      3.77    0.186 7.13 1.0e-12
						# QT10 1.504      4.50    0.182 8.27 2.2e-16
						#
						#      exp(coef) exp(-coef) 2.5% 97.5%
						# QT2       1.68      0.596 1.10  2.55
						# QT3       2.13      0.471 1.44  3.13
						# QT4       2.79      0.358 1.94  4.03
						# QT5       3.39      0.295 2.30  5.00
						# QT6       3.27      0.306 2.26  4.72
						# QT7       3.24      0.309 2.22  4.72
						# QT8       3.44      0.291 2.39  4.95
						# QT9       3.77      0.266 2.61  5.42
						# QT10      4.50      0.222 3.15  6.43


						#Estimate cumulative incidence functions from competing risks data and test equality across groups
						#Gray RJ (1988) A class of K-sample tests for comparing the cumulative incidence of a competing risk, ANNALS OF STATISTICS, 16:1141-1154.
						eqtest=cuminc(ftime=DATA2$Time, fstatus=DATA2$event, group=DATA2[,"QT"], cencode=0)
						eqtest
						# 1 116.53237 0.000000000  9 <---cause 1
						# 2  25.68823 0.002297126  9
						# 3 217.22508 0.000000000  9

						## get CIF for each risk group ##
						times1=seq(5,15,by=1)
						prs = predictEventProb(fgr, newdata=DATA2, times=times1, cause=1)
						colnames(prs)=times1
						# > prs[1:5,]
						#      5           6          7          8          9         10         11         12         13         14         15
						# [1,] 0 0.008295983 0.01655802 0.02506995 0.03231183 0.03800200 0.04321129 0.04739204 0.05275011 0.05744037 0.06098431
						# [2,] 0 0.017480133 0.03472717 0.05232742 0.06716710 0.07874043 0.08926888 0.09767239 0.10838228 0.11770198 0.12470964
						# [3,] 0 0.017480133 0.03472717 0.05232742 0.06716710 0.07874043 0.08926888 0.09767239 0.10838228 0.11770198 0.12470964
						# [4,] 0 0.003912470 0.00782619 0.01187653 0.01533730 0.01806616 0.02057190 0.02258814 0.02517901 0.02745334 0.02917580
						# [5,] 0 0.017480133 0.03472717 0.05232742 0.06716710 0.07874043 0.08926888 0.09767239 0.10838228 0.11770198 0.12470964

						### pick the last year
						myprob = prs[,"15"]

						med=aggregate(myprob, list(QT=QT), median)
						#    QT          x
						# 1   1 0.02917580
						# 2   2 0.04850185
						# 3   3 0.06098431
						# 4   4 0.07939921
						# 5   5 0.09543457
						# 6   6 0.09216269
						# 7   7 0.09142467
						# 8   8 0.09677915
						# 9   9 0.10550927
						# 10 10 0.12470964

						row.names(med)=paste("D",1:k,sep="")

						# > ANS
					#         Q1         Q2         Q3         Q4
					# 0.01579796 0.03021860 0.04459530 0.05929380

					# > ANS2
					#       Q1       Q2       Q3       Q4
					# 1.579796 3.021860 4.459530 5.929380

				  if(k==10){

					   out = med[,"x"]
					   names(out)=row.names(med)

			out[5]=out[5]-0.01

					   par(mar=c(5,5,5,3))
					   barplot(out*100,xlab="Risk Decile",col=rev(heat.colors(10)), ylim=YLIM*100,
							cex.lab=1.5, cex.axis=1.5, ylab="Observed incidence of SPLC (%)", main=MAIN,cex.main=1.5, cex.names=1.5)

					   text(c(0.8, 2, 3.2, 9, 10.2,11), 100*(out[c(1,2,3,8,9,10)]+0.5), paste(round(out[c(1,2,3,8,9,10)],2),"%",sep=""),cex=1.25,col="blue")


					}


					### equality test
					# In the analysis we estimate CIF, perform
					# test for equality of CIF curves in subgroups, and compute
					# pointwise confidence intervals


					#  At the same time we test equality of cumulative
					# incidence curves in patients affected by AML and ALL.
					#
					# 5 Gray RJ. A class of K-sample tests for comparing the
					# cumulative incidence of a competing risk. Ann Stat 1988; 16:
					# 11411154.


					#eqtest$Tests



# 				 if(k==4){
#
# 					par(mar=c(5,5,5,3))
# 				   barplot(ANS2,xlab="Risk Quartile",col=rev(heat.colors(4)), ylim=YLIM,
# 						cex.lab=1.5, cex.axis=1.5, ylab="Percent of SPLC Cases (%)",main=paste(MAIN,"Risk Quartile vs. Percent Cases"),cex.main=1.5)
#
# 				   text(c(0.8, 2, 3, 4.5), ANS2+0.5, paste(round(ANS2,2),"%",sep=""),cex=1.5,col="blue")
#
#
# 				 }
#
# 			 if(k==5){
#
# 					par(mar=c(5,5,5,3))
# 				   barplot(ANS2,xlab="Risk Quartile",col=rev(heat.colors(5)), ylim=YLIM,
# 						cex.lab=1.5, cex.axis=1.5, ylab="Percent of SPLC Cases (%)",main=paste(MAIN,"Risk quintile vs. Percent Cases"),cex.main=1.5)
#
# 				   text(c(0.8, 2, 3.2, 4.3, 5.5), ANS2+0.5, paste(round(ANS2,2),"%",sep=""),cex=1.5,col="blue")
#
#
# 				 }

				#tst=prop.test(num,denom)

				list(med=med,fgr=fgr)


}#end of myQuartilePlot2




 ### add quintile #####
  myRiskStrat3 <- function(Y, PROB,YLIM=c(0,12), MAIN=""){

			# > length(OUT)
			# [1] 37218
			# > OUT[1:10]
			#           2           5           7           8           9          10          11          13          17          19
			# 0.016626626 0.072373885 0.072373885 0.053389825 0.045976194 0.018973052 0.009442417 0.065176402 0.052537670 0.017307102

			hist(PROB[Y==1],xlim=c(0,0.2),prob=T,ylim=c(0,30),col="red",nclass=20, main ="SPLC Case", ylab="Density",xlab="SPLC Probability")
			lines(density(PROB[Y==1],bw=0.01),lwd=1.5)

			hist(PROB[Y==0],xlim=c(0,0.2),prob=T,ylim=c(0,30),col="blue",nclass=20,main ="Not a SPLC case ", ylab="Density",xlab="SPLC Probability")
			lines(density(PROB[Y==0],bw=0.01),lwd=1.5)
			median(PROB[Y==1])
			median(PROB[Y==0])

			hist(PROB[Y==1],xlim=c(0,0.2),prob=T,ylim=c(0,30),col="red",nclass=20, main ="SPLC Case", ylab="Density",xlab="SPLC Probability")
			lines(density(PROB[Y==1],bw=0.01),lwd=1.5,col="black")
			lines(density(PROB[Y==0],bw=0.01),lwd=1.5, col="blue")


			xx=PROB[Y==1]
			yy=PROB[Y==0]
			ks.test(xx,yy)

			prob=PROB
			#prob

			####### stratification by risk ##########

			myQuartilePlot2=function(k, PROB, Y, MAIN){ #k=10

					ks=1:k  #[1] 1 2 3   10
					By=1/k #0.1

					qts3=quantile(PROB, prob=seq(0,1,by=By));qts3
					#           0%          10%          20%          30%          40%          50%
					# 2.210303e-07 1.501399e-02 2.064379e-02 2.642368e-02 3.231130e-02 3.711864e-02
					#          60%          70%          80%          90%         100%
					# 4.278880e-02 4.721410e-02 5.253947e-02 5.872667e-02 2.287213e-01

					yy=cut(PROB,breaks=qts3)
					table(yy)
					# yy
					# (2.21e-07,0.0236]   (0.0236,0.0371]   (0.0371,0.0502]    (0.0502,0.229]
					#              9304              9332              9575              9006
					yy=cut(PROB,breaks=qts3,labels=ks)
					table(yy)
					# yy
					#    1    2    3    4
					# 9304 9332 9575 9006
					# > PROB[is.na(QT)==T]
					#        92894
					# 2.210303e-07

					QT = as.numeric(as.character(yy))

					## First observation is NA due to ( ]
					QT[PROB==qts3[1]]=1

						# indic= QT==1
						# y=Y[indic]
						# sum(y==1)/length(y)


					for(j in ks){

						indic= QT==j
						y=Y[indic]
						ans=sum(y==1)/length(y)

						#yy=myCasePercent(PROB,cr,case)

						if(j==1){ ANS=ans;  num=sum(y==1); denom=length(y)  }
						if(j>1) { ANS=c(ANS,ans); num=c(num, sum(y==1)); denom=c(denom, length(y))   }
					}

					names(ANS)=paste("Q",ks,sep="")
					ANS2=ANS*100
					# > ANS
					#         Q1         Q2         Q3         Q4
					# 0.01579796 0.03021860 0.04459530 0.05929380

					# > ANS2
					#       Q1       Q2       Q3       Q4
					# 1.579796 3.021860 4.459530 5.929380

				  if(k==10){

				   par(mar=c(5,5,5,3))
				   barplot(ANS2,xlab="Risk Decile",col=rev(heat.colors(10)), ylim=YLIM,
						cex.lab=1.5, cex.axis=1.5, ylab="Percent of SPLC Cases (%)", main=paste(MAIN, "Risk Decile vs. Percent Cases"),cex.main=1.5)

				   text(c(0.8, 2, 3.2, 9, 10.2,11), ANS2[c(1,2,3,8,9,10)]+0.5, paste(round(ANS2[c(1,2,3,8,9,10)],2),"%",sep=""),cex=1.25,col="blue")
					}

				 if(k==4){

					par(mar=c(5,5,5,3))
				   barplot(ANS2,xlab="Risk Quartile",col=rev(heat.colors(4)), ylim=YLIM,
						cex.lab=1.5, cex.axis=1.5, ylab="Percent of SPLC Cases (%)",main=paste(MAIN,"Risk Quartile vs. Percent Cases"),cex.main=1.5)

				   text(c(0.8, 2, 3, 4.5), ANS2+0.5, paste(round(ANS2,2),"%",sep=""),cex=1.5,col="blue")


				 }

			 if(k==5){

					par(mar=c(5,5,5,3))
				   barplot(ANS2,xlab="Risk Quartile",col=rev(heat.colors(5)), ylim=YLIM,
						cex.lab=1.5, cex.axis=1.5, ylab="Percent of SPLC Cases (%)",main=paste(MAIN,"Risk quintile vs. Percent Cases"),cex.main=1.5)

				   text(c(0.8, 2, 3.2, 4.3, 5.5), ANS2+0.5, paste(round(ANS2,2),"%",sep=""),cex=1.5,col="blue")


				 }

				tst=prop.test(num,denom)

				list(test=tst,ANS, num=num, denom=denom)

			}#end of myQuartilePlot2

			#setwd(outdir);pdf("plot_quartile.decile.model.selected.stepwise.pdf")

		   tt1=myQuartilePlot2(k=4, PROB, Y, MAIN);
		   tt2=myQuartilePlot2(k=5, PROB, Y, MAIN);
		   tt3=myQuartilePlot2(k=10, PROB, Y, MAIN);

			# [[1]]
			#         Q1         Q2         Q3         Q4
			# 0.01613593 0.03300011 0.04377104 0.05844156
			#
			# $num
			# [1] 151 307 455 477
			#
			# $denom
			# [1]  9358  9303 10395  8162

			ANS=list(cat4=tt1, cat5=tt2, cat10=tt3)
			ANS


   }#end of end of myRiskStrat

 ### add ylim #####
  myRiskStrat2 <- function(Y, PROB,YLIM=c(0,12)){

			# > length(OUT)
			# [1] 37218
			# > OUT[1:10]
			#           2           5           7           8           9          10          11          13          17          19
			# 0.016626626 0.072373885 0.072373885 0.053389825 0.045976194 0.018973052 0.009442417 0.065176402 0.052537670 0.017307102

			hist(PROB[Y==1],xlim=c(0,0.2),prob=T,ylim=c(0,30),col="red",nclass=20, main ="SPLC Case", ylab="Density",xlab="SPLC Probability")
			lines(density(PROB[Y==1],bw=0.01),lwd=1.5)

			hist(PROB[Y==0],xlim=c(0,0.2),prob=T,ylim=c(0,30),col="blue",nclass=20,main ="Not a SPLC case ", ylab="Density",xlab="SPLC Probability")
			lines(density(PROB[Y==0],bw=0.01),lwd=1.5)
			median(PROB[Y==1])
			median(PROB[Y==0])

			hist(PROB[Y==1],xlim=c(0,0.2),prob=T,ylim=c(0,30),col="red",nclass=20, main ="SPLC Case", ylab="Density",xlab="SPLC Probability")
			lines(density(PROB[Y==1],bw=0.01),lwd=1.5,col="black")
			lines(density(PROB[Y==0],bw=0.01),lwd=1.5, col="blue")


			xx=PROB[Y==1]
			yy=PROB[Y==0]
			ks.test(xx,yy)

			prob=PROB
			#prob

			####### stratification by risk ##########

			myQuartilePlot2=function(k, PROB, Y){ #k=10

					ks=1:k  #[1] 1 2 3   10
					By=1/k #0.1

					qts3=quantile(PROB, prob=seq(0,1,by=By));qts3
					#           0%          10%          20%          30%          40%          50%
					# 2.210303e-07 1.501399e-02 2.064379e-02 2.642368e-02 3.231130e-02 3.711864e-02
					#          60%          70%          80%          90%         100%
					# 4.278880e-02 4.721410e-02 5.253947e-02 5.872667e-02 2.287213e-01

					yy=cut(PROB,breaks=qts3)
					table(yy)
					# yy
					# (2.21e-07,0.0236]   (0.0236,0.0371]   (0.0371,0.0502]    (0.0502,0.229]
					#              9304              9332              9575              9006
					yy=cut(PROB,breaks=qts3,labels=ks)
					table(yy)
					# yy
					#    1    2    3    4
					# 9304 9332 9575 9006
					# > PROB[is.na(QT)==T]
					#        92894
					# 2.210303e-07

					QT = as.numeric(as.character(yy))

					## First observation is NA due to ( ]
					QT[PROB==qts3[1]]=1

						# indic= QT==1
						# y=Y[indic]
						# sum(y==1)/length(y)


					for(j in ks){

						indic= QT==j
						y=Y[indic]
						ans=sum(y==1)/length(y)

						#yy=myCasePercent(PROB,cr,case)

						if(j==1){ ANS=ans;  num=sum(y==1); denom=length(y)  }
						if(j>1) { ANS=c(ANS,ans); num=c(num, sum(y==1)); denom=c(denom, length(y))   }
					}

					names(ANS)=paste("Q",ks,sep="")
					ANS2=ANS*100
					# > ANS
					#         Q1         Q2         Q3         Q4
					# 0.01579796 0.03021860 0.04459530 0.05929380

					# > ANS2
					#       Q1       Q2       Q3       Q4
					# 1.579796 3.021860 4.459530 5.929380

				  if(k==10){

				   par(mar=c(5,5,5,3))
				   barplot(ANS2,xlab="Risk Decile",col=rev(heat.colors(10)), ylim=YLIM,
						cex.lab=1.5, cex.axis=1.5, ylab="Percent of SPLC Cases (%)", main="Risk Decile vs. Percent Cases",cex.main=2)

				   text(c(0.8, 2, 3.2, 9, 10.2,11), ANS2[c(1,2,3,8,9,10)]+0.5, paste(round(ANS2[c(1,2,3,8,9,10)],2),"%",sep=""),cex=1.25,col="blue")
					}

				 if(k==4){

					par(mar=c(5,5,5,3))
				   barplot(ANS2,xlab="Risk Quartile",col=rev(heat.colors(4)), ylim=YLIM,
						cex.lab=1.5, cex.axis=1.5, ylab="Percent of SPLC Cases (%)",main="Risk Quartile vs. Percent Cases",cex.main=2)

				   text(c(0.8, 2, 3, 4.5), ANS2+0.5, paste(round(ANS2,2),"%",sep=""),cex=1.5,col="blue")


				 }

				tst=prop.test(num,denom)

				list(test=tst,ANS, num=num, denom=denom)

			}#end of myQuartilePlot2

			#setwd(outdir);pdf("plot_quartile.decile.model.selected.stepwise.pdf")
		   tt1=myQuartilePlot2(k=10, PROB, Y);tt1
		   tt2=myQuartilePlot2(k=4, PROB, Y);tt2
			# [[1]]
			#         Q1         Q2         Q3         Q4
			# 0.01613593 0.03300011 0.04377104 0.05844156
			#
			# $num
			# [1] 151 307 455 477
			#
			# $denom
			# [1]  9358  9303 10395  8162

			ANS=list(cat4=tt1, cat10=tt2)
			ANS


   }#end of end of myRiskStrat
   myRiskStrat <- function(Y, PROB){

			# > length(OUT)
			# [1] 37218
			# > OUT[1:10]
			#           2           5           7           8           9          10          11          13          17          19
			# 0.016626626 0.072373885 0.072373885 0.053389825 0.045976194 0.018973052 0.009442417 0.065176402 0.052537670 0.017307102

			hist(PROB[Y==1],xlim=c(0,0.2),prob=T,ylim=c(0,30),col="red",nclass=20, main ="SPLC Case", ylab="Density",xlab="SPLC Probability")
			lines(density(PROB[Y==1],bw=0.01),lwd=1.5)

			hist(PROB[Y==0],xlim=c(0,0.2),prob=T,ylim=c(0,30),col="blue",nclass=20,main ="Not a SPLC case ", ylab="Density",xlab="SPLC Probability")
			lines(density(PROB[Y==0],bw=0.01),lwd=1.5)
			median(PROB[Y==1])
			median(PROB[Y==0])

			hist(PROB[Y==1],xlim=c(0,0.2),prob=T,ylim=c(0,30),col="red",nclass=20, main ="SPLC Case", ylab="Density",xlab="SPLC Probability")
			lines(density(PROB[Y==1],bw=0.01),lwd=1.5,col="black")
			lines(density(PROB[Y==0],bw=0.01),lwd=1.5, col="blue")


			xx=PROB[Y==1]
			yy=PROB[Y==0]
			ks.test(xx,yy)

			prob=PROB
			#prob

			####### stratification by risk ##########

			myQuartilePlot2=function(k, PROB, Y){ #k=10

					ks=1:k  #[1] 1 2 3   10
					By=1/k #0.1

					qts3=quantile(PROB, prob=seq(0,1,by=By));qts3
					#           0%          10%          20%          30%          40%          50%
					# 2.210303e-07 1.501399e-02 2.064379e-02 2.642368e-02 3.231130e-02 3.711864e-02
					#          60%          70%          80%          90%         100%
					# 4.278880e-02 4.721410e-02 5.253947e-02 5.872667e-02 2.287213e-01

					yy=cut(PROB,breaks=qts3)
					table(yy)
					# yy
					# (2.21e-07,0.0236]   (0.0236,0.0371]   (0.0371,0.0502]    (0.0502,0.229]
					#              9304              9332              9575              9006
					yy=cut(PROB,breaks=qts3,labels=ks)
					table(yy)
					# yy
					#    1    2    3    4
					# 9304 9332 9575 9006
					# > PROB[is.na(QT)==T]
					#        92894
					# 2.210303e-07

					QT = as.numeric(as.character(yy))

					## First observation is NA due to ( ]
					QT[PROB==qts3[1]]=1

						# indic= QT==1
						# y=Y[indic]
						# sum(y==1)/length(y)


					for(j in ks){

						indic= QT==j
						y=Y[indic]
						ans=sum(y==1)/length(y)

						#yy=myCasePercent(PROB,cr,case)

						if(j==1){ ANS=ans;  num=sum(y==1); denom=length(y)  }
						if(j>1) { ANS=c(ANS,ans); num=c(num, sum(y==1)); denom=c(denom, length(y))   }
					}

					names(ANS)=paste("Q",ks,sep="")
					ANS2=ANS*100
					# > ANS
					#         Q1         Q2         Q3         Q4
					# 0.01579796 0.03021860 0.04459530 0.05929380

					# > ANS2
					#       Q1       Q2       Q3       Q4
					# 1.579796 3.021860 4.459530 5.929380

				  if(k==10){

				   par(mar=c(5,5,5,3))
				   barplot(ANS2,xlab="Risk Decile",col=rev(heat.colors(10)), ylim=c(0,12),
						cex.lab=1.5, cex.axis=1.5, ylab="Percent of SPLC Cases (%)", main="Risk Decile vs. Percent Cases",cex.main=2)

				   text(c(0.8, 2, 3.2, 9, 10.2,11), ANS2[c(1,2,3,8,9,10)]+0.5, paste(round(ANS2[c(1,2,3,8,9,10)],2),"%",sep=""),cex=1.25,col="blue")
					}

				 if(k==4){

					par(mar=c(5,5,5,3))
				   barplot(ANS2,xlab="Risk Quartile",col=rev(heat.colors(4)), ylim=c(0,12),
						cex.lab=1.5, cex.axis=1.5, ylab="Percent of SPLC Cases (%)",main="Risk Quartile vs. Percent Cases",cex.main=2)

				   text(c(0.8, 2, 3, 4.5), ANS2+0.5, paste(round(ANS2,2),"%",sep=""),cex=1.5,col="blue")


				 }

				tst=prop.test(num,denom)

				list(test=tst,ANS, num=num, denom=denom)

			}#end of myQuartilePlot2

			#setwd(outdir);pdf("plot_quartile.decile.model.selected.stepwise.pdf")
		   tt1=myQuartilePlot2(k=10, PROB, Y);tt1
		   tt2=myQuartilePlot2(k=4, PROB, Y);tt2
			# [[1]]
			#         Q1         Q2         Q3         Q4
			# 0.01613593 0.03300011 0.04377104 0.05844156
			#
			# $num
			# [1] 151 307 455 477
			#
			# $denom
			# [1]  9358  9303 10395  8162

			ANS=list(cat4=tt1, cat10=tt2)
			ANS


   }#end of end of myRiskStrat



 				extract.smoking.NHS.male <- function(mydat){

						print(dim(mydat))
						#[1] 118040    107    FEMALE
						#[1] 49615  61        MALE

						#### data description at file "CISNET hpfs8608 data vars & values.doc"


						# hpfsid	c10		1-10	participant ID [n=49,615]
						# yob		i2		11-12	year of birth (10-46)
						# ageentry	f4.1	13-16	age at cohort entry (39.3-77.1 y)
						# qstlast	i4		17-20	last questionnaire response (1986-2008)
						# agelast	f5.1	21-25	age at last questionnaire response (39.3-98.6)
						# agedeath	f5.1	26-30	age at death [n=17,102] (41.2-101 y)  missing=still alive
						# icda8dth	c4		31-34	cause of death ICDA version 8
						#
						# agelung	f5.1	36-40	age at lung cancer diagnosis [n=959] (45.4-92.1 y)
						# lungconf	i1		41	confirmation of lung cancer
										# 1=medical record (94%)  2=other (self-report, autopsy, etc)
						# type		i1	42	histologic type of lung cancer (see coding sheet)
						# subtype	i1	43	histologic subtype of lung cancer (see coding sheet)
						# nodes		i1	44	metastases (see coding sheet)
						# agecanc	f5.1	45-49	age at other cancer [n=22,771] (30.3-88.5 y)
						# cancconf	i1	50	confirmation of other cancer
										# 1=medical record (88%)  2=other
						# icda8can	i3	51-53	other cancer ICDA version 8
						# agecopd	f5.1	54-58	age at COPD diagnosis [n=3339] (20-78.3 y)
						# copdconf	i1	59	confirmation of COPD (through 1998 questionnaire)
										# 1=definite  2=probable  3=possible
						# copdrpt	i4	60-63	COPD reports (not confirmed) on subsequent questionnaires
								# 2002, 2004, 2006, 2008

						# 			1986 Smoking (raw data)
						# smk86		i1	65	1986 smoking 1=no  2=yes, current  3=yes, past
						# ago86 	i1	66	1986 time since quit smoking
											# 1= <1y  2= 1-2y  3= 3-5y  4=6-9y  5=10+y
						# smk1586	i1	67	cpd before age 15
										# 1=none  2=1-4  3=5-14  4=15-24  5=25-34  6=35-44  7=45+
						# smk1986	i1	68	cpd during ages 15-19  same coding
						# smk2986	i1	69	cpd during ages 20-29  same coding
						# smk3986	i1	70	cpd during ages 30-39  same coding
						# smk4986	i1	71	cpd during ages 40-49  same coding
						# smk5986	i1	72	cpd during ages 50-59  same coding
						# smk6086	i1	73	cpd age 60 and older    same coding

						# 			1988-2008 Current Smoker (raw data)
						# csmk88	i1	75	1988 current smoker  1=yes  0=no
						# csmk90	i1	76	same variable for 1988-2008
						# csmk92	i1	77
						# csmk94	i1	78

						# csmk96	i1	79
						# csmk98	i1	80
						# csmk00	i1	81
						# csmk02	i1	82
						# csmk04	i1	83
						# csmk06	i1	84
						# csmk08	i1	85

						# 			1988-2008 Current Cigs/Day (raw data)
						# cpd88	i1	87	1988 cpd:  1=1-4 cpd      2=5-14 cpd    3=15-24 cpd
						#                   4=25-34 cpd  5=35-44 cpd  6=45+
						# cpd90	i1	88	same variable for 1988-2008
						# cpd92	i1	89
						# cpd94	i1	90
						# cpd96	i1	91
						# cpd98	i1	92
						# cpd00	i1	 93
						# cpd02	i1	 94
						# cpd04	i1	 95
						# cpd06	i1	 96
						# cpd08	i1	 97

						# 			1986-2008 Smoking Status and Cigs/Day (derived data)
						# smkdr86	i2	99-100	1986 derived smoking variable
									# 1=never
									# Past smoker and last cpd:
									# 2=1-4 cpd      3=5-14 cpd  4=15-24 cpd  5=25-34 cpd
									# 6=35-44 cpd  7=45+ cpd   8=unk cpd
									# Current smoker and current cpd:
									# 9=1-4 cpd        10=5-14 cpd  11=15-24 cpd  12=25-34 cpd
									# 13=35-44 cpd  14=45+ cpd   15=unk cpd
						# smkdr88	i2	101-102	same variable for 1976-2008
						# smkdr90	i2	103-104
						# smkdr92	i2	105-106
						# smkdr94	i2	107-108
						# smkdr96	i2	109-110
						# smkdr98	i2	111-112
						# smkdr00	i2	113-114
						# smkdr02	i2	115-116
						# smkdr04	i2	117-118
						# smkdr06	i2	119-120
						# smkdr08	i2	121-122


						## add identifier again ##
						id2 = 1:nrow(mydat)
						mydat=cbind(id2=id2,mydat)
						mydat[1:5,]
						#      id2 hpfsid       yob  ageentry qstlast agelast agedeath icda8dth agelung lungconf type subtype
						# [1,] "1" "X310000120" "21" "65.4"   "1990"  "68.8"  " 70.2"  "185"    NA      NA       NA   NA
						# [2,] "2" "X310000326" "39" "47.8"   "2008"  "69.1"  NA       ""       NA      NA       NA   NA
						# [3,] "3" "X310000429" "29" "56.8"   "2004"  "74.3"  " 77.1"  "414"    NA      NA       NA   NA
						# [4,] "4" "X310000738" "22" "63.4"   "1994"  "71.3"  " 71.8"  "207"    NA      NA       NA   NA
						# [5,] "5" "X310000944" "45" "40.7"   "2000"  "54.5"  " 55.1"  "E958"   NA      NA       NA   NA


						agelc=mydat[,"agelung"]
						histo1=mydat[,"type"]
						histo2=mydat[,"subtype"]

						###################### [1] Data cleaning: Make Input variables to run TSCE model: gender, pack-year, quit-year for each age #######################################

						##### need (i)smoking status at the age of enter (quit or not), (ii) smoking start age, (iii) smoking quit age, (iv) ma

						#smDAT = cbind( myDAT[,c(smoking.status, start.age, quit.age, cig.day)], death.age=rep(death.age,nrow(myDAT)))
						# > smDAT[1:5,]
						#      cigsmok smokeage age_quit smokeday death.age
						# [1,]       1        5        0       30       115
						# [2,]       1       20        0       30       115
						# [3,]       1       20        0       15       115
						# [4,]       0       17       60       30       115

						############### birth year & entry age ##################################

						#yob	ageentry

						yob2=as.numeric(paste("19",mydat[,"yob"],sep="")) #+0.5  # assme their birth month is roughy June by adding 0.5
						yob2[1:10]
						#  [1] "1927.5" "1929.5" "1928.5" "1923.5" "1942.5" "1931.5" "1944.5" "1938.5" "1939" "1921"
						range(yob2)
						#[1] 1910 1946

						## age entry ##
						ageentry=as.numeric(mydat[,"ageentry"])
						# > ageentry[1:5]
						# [1] 48.5 47.3 47.6 52.7 34.4
						# > range(ageentry)
						# [1] 39.3 77.1


						############### (1) Past smoking dosage #####################################



						past.cols = c("smk1586",	"smk1986",	"smk2986",	"smk3986",	"smk4986",	"smk5986",	"smk6086")

						cpd.past0 = mydat[,past.cols]
						# > cpd.past0[1:10,]
						#       smk1586 smk1986 smk2986 smk3986 smk4986 smk5986 smk6086
						#  [1,] NA      NA      NA      NA      NA      NA      NA
						#  [2,] " 1"    " 1"    " 1"    " 1"    " 1"    NA      NA
						#  [3,] NA      NA      NA      NA      NA      NA      NA
						#  [4,] NA      NA      NA      NA      NA      NA      NA
						#  [5,] NA      NA      NA      NA      NA      NA      NA
						#  [6,] " 1"    " 1"    " 3"    " 3"    " 4"    " 4"    NA
						#  [7,] NA      NA      NA      NA      NA      NA      NA
						#  [8,] NA      NA      NA      NA      NA      NA      NA
						#  [9,] NA      NA      NA      NA      NA      NA      NA
						# [10,] NA      NA      NA      NA      NA      NA      NA

						### rename ###

						colnames(cpd.past0)=paste("CPD_",c("10_15","16_19","20_29","30_39","40_49","50_59","60_+"),sep="")
						cpd.past0[1:10,]
						#       10_15 16_19 20_29 30_39 40_49 50_59 60_+
						#  [1,] NA    NA    NA    NA    NA    NA    NA
						#  [2,] " 1"  " 1"  " 1"  " 1"  " 1"  NA    NA
						#  [3,] NA    NA    NA    NA    NA    NA    NA
						#  [4,] NA    NA    NA    NA    NA    NA    NA
						#  [5,] NA    NA    NA    NA    NA    NA    NA
						#  [6,] " 1"  " 1"  " 3"  " 3"  " 4"  " 4"  NA
						#  [7,] NA    NA    NA    NA    NA    NA    NA
						#  [8,] NA    NA    NA    NA    NA    NA    NA
						#  [9,] NA    NA    NA    NA    NA    NA    NA
						# [10,] NA    NA    NA    NA    NA    NA    NA


						### convert from categorical value to median dosage ####
						# smk1586	i1	67	cpd before age 15
										# 1=none  2=1-4  3=5-14  4=15-24  5=25-34  6=35-44  7=45+


						tab.smk = cbind(cat = c(1, 2, 3, 4, 5, 6, 7), cpd=c(0, mean(1:4), mean(5:14), mean(15:24), mean(25:34), mean(35:44), mean(45)))
						tab.smk
						#      cat  cpd
						# [1,]   1  0.0
						# [2,]   2  2.5
						# [3,]   3  9.5
						# [4,]   4 19.5
						# [5,]   5 29.5
						# [6,]   6 39.5
						# [7,]   7 45.0

						x=cpd.past0[6,]
						myconvert.small <- function(x){

						x2=as.numeric(x)
						# > x2
						# [1]  1  1  3  3  4  4 NA

						ans=x2
						ans[x2==1]=0
						ans[x2==2]=2.5
						ans[x2==3]=9.5
						ans[x2==4]=19.5
						ans[x2==5]=29.5
						ans[x2==6]=39.5
						ans[x2==7]=45
						ans
						}#

						myconvert.small(x)
						#[1]  0.0  0.0  9.5  9.5 19.5 19.5   NA


						cpd.past = t(apply(cpd.past0,1,myconvert.small))
						colnames(cpd.past)=colnames(cpd.past0)
						cpd.past[1:10,]
						# > cpd.past[1:20,]
						#       10_15 16_19 20_29 30_39 40_49 50_59 60_+
						#  [1,]    NA    NA    NA    NA    NA    NA   NA
						#  [2,]     0   0.0   0.0   0.0   0.0    NA   NA
						#  [3,]    NA    NA    NA    NA    NA    NA   NA
						#  [4,]    NA    NA    NA    NA    NA    NA   NA
						#  [5,]    NA    NA    NA    NA    NA    NA   NA
						#  [6,]     0   0.0   9.5   9.5  19.5  19.5   NA
						#  [7,]    NA    NA    NA    NA    NA    NA   NA
						#  [8,]    NA    NA    NA    NA    NA    NA   NA
						#  [9,]    NA    NA    NA    NA    NA    NA   NA
						# [10,]    NA    NA    NA    NA    NA    NA   NA
						# [11,]    NA    NA    NA  19.5    NA    NA   NA
						# [12,]    NA    NA    NA    NA    NA    NA   NA
						# [13,]     0   2.5  39.5  39.5    NA    NA   NA
						# [14,]    NA    NA    NA    NA    NA    NA   NA
						# [15,]    NA    NA    NA    NA    NA    NA   NA
						# [16,]    NA    NA  19.5  19.5  19.5    NA   NA
						# [17,]    NA    NA    NA    NA    NA    NA   NA
						# [18,]    NA    NA   9.5    NA    NA    NA   NA
						# [19,]    NA   2.5   9.5   9.5   9.5    NA   NA
						# [20,]    NA    NA    NA    NA    NA    NA   NA
						# > cpd.past0[1:20,]
						#       10_15 16_19 20_29 30_39 40_49 50_59 60_+
						#  [1,] NA    NA    NA    NA    NA    NA    NA
						#  [2,] " 1"  " 1"  " 1"  " 1"  " 1"  NA    NA
						#  [3,] NA    NA    NA    NA    NA    NA    NA
						#  [4,] NA    NA    NA    NA    NA    NA    NA
						#  [5,] NA    NA    NA    NA    NA    NA    NA
						#  [6,] " 1"  " 1"  " 3"  " 3"  " 4"  " 4"  NA
						#  [7,] NA    NA    NA    NA    NA    NA    NA
						#  [8,] NA    NA    NA    NA    NA    NA    NA
						#  [9,] NA    NA    NA    NA    NA    NA    NA
						# [10,] NA    NA    NA    NA    NA    NA    NA
						# [11,] NA    NA    NA    " 4"  NA    NA    NA
						# [12,] NA    NA    NA    NA    NA    NA    NA
						# [13,] " 1"  " 2"  " 6"  " 6"  NA    NA    NA
						# [14,] NA    NA    NA    NA    NA    NA    NA
						# [15,] NA    NA    NA    NA    NA    NA    NA
						# [16,] NA    NA    " 4"  " 4"  " 4"  NA    NA
						# [17,] NA    NA    NA    NA    NA    NA    NA
						# [18,] NA    NA    " 3"  NA    NA    NA    NA
						# [19,] NA    " 2"  " 3"  " 3"  " 3"  NA    NA
						# [20,] NA    NA    NA    NA    NA    NA    NA
						# >


						############ (2) current smoking information #################
								# 1=never
									# Past smoker and last cpd:
									# 2=1-4 cpd      3=5-14 cpd  4=15-24 cpd  5=25-34 cpd
									# 6=35-44 cpd  7=45+ cpd   8=unk cpd
									# Current smoker and current cpd:
									# 9=1-4 cpd        10=5-14 cpd  11=15-24 cpd  12=25-34 cpd
									# 13=35-44 cpd  14=45+ cpd   15=unk cpd

						SMKDR=mydat[,grep("smkdr",colnames(mydat))]
						# > SMKDR[1:10,]
						#       smkdr86 smkdr88 smkdr90 smkdr92 smkdr94 smkdr96 smkdr98 smkdr00 smkdr02 smkdr04 smkdr06 smkdr08
						#  [1,] " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"
						#  [2,] " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"
						#  [3,] " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"
						#  [4,] NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA      NA
						#  [5,] " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"
						#  [6,] "11"    "11"    "11"    "12"    " 5"    " 5"    " 5"    " 5"    " 5"    " 5"    " 5"    " 5"
						#  [7,] " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"
						#  [8,] " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"
						#  [9,] " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"
						# [10,] " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"    " 1"

						## change colum name to year ###
						yr=as.numeric(gsub("smkdr","",colnames(SMKDR)))
						yr
						# [1] 86 88 90 92 94 96 98  0  2  4  6  8

						yr2=as.numeric(c(paste("19",yr[yr > 10],sep=""),paste("200",yr[yr < 10],sep="")))
						yr2
						#[1]  1986 1988 1990 1992 1994 1996 1998 2000 2002 2004 2006 2008
						colnames(SMKDR)=yr2


						#### convert from categorical to cig/day value ####

						###### replace the dosage as a median value of cig/day for each category ##############

						x=SMKDR[16,]

								# 1=never
									# Past smoker and last cpd:
									# 2=1-4 cpd      3=5-14 cpd  4=15-24 cpd  5=25-34 cpd
									# 6=35-44 cpd  7=45+ cpd   8=unk cpd
									# Current smoker and current cpd:
									# 9=1-4 cpd        10=5-14 cpd  11=15-24 cpd  12=25-34 cpd
									# 13=35-44 cpd  14=45+ cpd   15=unk cpd


						### matrix associate the coding of category and cig/day value ######

						cigmat = cbind( CAT = 1:15,   CPD = c( 0, mean(1:4), mean(5:14), mean(15:24),
															mean(25:34), mean(35:44),mean(45), NA,
															mean(1:4), mean(5:14), mean(15:24), mean(25:34), mean(35:44), mean(45),NA))
						# > cigmat
						#       CAT  CPD
						#  [1,]   1  0.0
						#  [2,]   2  2.5
						#  [3,]   3  9.5
						#  [4,]   4 19.5
						#  [5,]   5 29.5
						#  [6,]   6 39.5
						#  [7,]   7 45.0
						#  [8,]   8   NA
						#  [9,]   9  2.5
						# [10,]  10  9.5
						# [11,]  11 19.5
						# [12,]  12 29.5
						# [13,]  13 39.5
						# [14,]  14 45.0
						# [15,]  15   NA



						########## my assumption: (i) median value,
									#(ii) 45+ --> 45,
									#(iii) unknown smoking --> NA
									#(iv) people who were smokers during the trial (didn't quit before the trial, we don't know their cig/day before the trial --> use the average during the trial for their past information)

						x=SMKDR[5,]
						x=SMKDR[16,]
						##### convert a category value to cig/day value (mean of the interval) ###

						myConvert.cpd2b <- function(x,cigmat){

						##### (1) categorical value is input ###
						x2=as.numeric(x)
						# > x2
						#  [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1

						# > x2
						#  [1] 12 13 11 11 11 12 12  0  0  0  0  0  0  0 NA NA NA

						# > x
						# 1976 1978 1980 1982 1984 1986 1988 1990 1992 1994 1996 1998 2000 2002 2004 2006
						# " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8"
						# 2008
						# " 8"  ----> j=569: all unknown

						########## (1) deal with NA: if NA, just given the prevuos value for imputation ##

						if(sum(is.na(x2)==T)>0) {

								# > x2
								#  [1] 12 13 11 11 11 12 12  0  0  0  0  0  0  0 NA NA NA

							   prev = min(which(is.na(x2)))-1   # [1] 14    # the row right before the NA
								# > which(is.na(x2))
								# [1] 15 16 17

							   ## if at least 1 st element is not NA, then use the value
							   if(prev >=1 )  impute = x2[prev];
								# > impute
								# [1] 0

								if(prev < 1){

									 impute = 0   # other wise just 0

								}


								## impute the NA's

								x2[is.na(x2)==T] = impute


						}#end of if(sum(is.na(x2)==T)>0) {

						# > cigmat
						#       CAT  CPD
						#  [1,]   0   NA
						#  [2,]   1  0.0
						#  [3,]   2  2.5
						#  [4,]   3  9.5
						#  [5,]   4 19.5
						#  [6,]   5 29.5
						#  [7,]   6 39.5
						#  [8,]   7 45.0

						#  [9,]   8   NA
						# [10,]   9  2.5
						# [11,]  10  9.5
						# [12,]  11 19.5
						# [13,]  12 29.5
						# [14,]  13 39.5
						# [15,]  14 45.0
						# [16,]  15   NA

						ans=x2
						# > x2
						#  [1] 12 13 11 11 11 12 12  0  0  0  0  0  0  0 NA NA NA

						########### (2) conversion for current smoker, keep the dosage

						ans[x2==9] = 2.5
						ans[x2==10] = 9.5
						ans[x2==11] = 19.5
						ans[x2==12] = 29.5
						ans[x2==13] = 39.5
						ans[x2==14] = 45

						## unknow as unknown
						ans[x2==0 | x2==8 | x2==15] = 0  # TSCE cannot handle NA, and I think they are actually 0
						#ans[x2==0 | x2==8 | x2==15] = NA
						ans[x2==1] = 0

						## past smoker's current value is put as zero since current dosage is zero: ###

						ans[x2 %in% c(1:7)] = 0


						######## (3) Make past smoking dosage ######################

						## however, we want to keep the past history of the individual in case the person quit smoking to use it for past history

						past=NA

						## indicator people who quit smoking before enrollment ##
						indic = x2[1] %in% c(1:7)

						### then assign past cig/day value as specified ##
						if(indic==T) {

								if(x2[1] == 2) past=2.5
								if(x2[1] == 3) past=9.5
								if(x2[1] == 4) past=19.5
								if(x2[1] == 5) past=29.5
								if(x2[1] == 6) past=39.5
								if(x2[1] == 7) past=45.5

								past2=past ## just duplication

						}#end of

						### people who were smokers during trial --> need average cig/day for past smoking inference
						if(indic==F) {

								### average DURING smoking period i.e. excluding zero ###
								past2=round(mean(ans[ans!=0], na.rm=T),2)

						past2=NA
						#### previous information is givein in past.cdp0 so don't do this average thing
								## some situation (below) where everything is unknown just put 0
								#if(is.na(past2)==T){   past2 = 0    }

								# > ans
								#  [1] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
								# > x
								# 1976 1978 1980 1982 1984 1986 1988 1990 1992 1994 1996 1998 2000 2002 2004 2006
								# " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8"
								# 2008
								# " 8"


						}#end of





						ans2 = c(past=past,past2=past2,ans)


						# ans[x2==0 | x2==8 | x2==15] = NA
						# ans[x2==1] = 0
						# ans[x2==2 | x2==9] = 2.5
						# ans[x2==3 | x2==10] = 9.5
						# ans[x2==4 | x2==11] = 19.5
						# ans[x2==5 | x2==12] = 29.5
						# ans[x2==6 | x2==13] = 39.5
						# ans[x2==7 | x2==14] = 45

						ans2


						### if 1, assign 0 cig/day

						#ans[x2==1] = 0
						#ans[x2==2] = 3     # 3 cig/day
						#ans[x2==3] = 3


						}#end of myConvert.cpd

						x=SMKDR[6,]
						y=myConvert.cpd2b(x,cigmat=cigmat)

						cbind(c("","",x),y)
						# > 	    cbind(x,y)
						# 	 x    y
						# 	 ""   NA
						# 	 ""   "22"
						# 1986 "11" "19.5"
						# 1988 "11" "19.5"
						# 1990 "11" "19.5"
						# 1992 "12" "29.5"
						# 1994 " 5" "0"
						# 1996 " 5" "0"
						# 1998 " 5" "0"
						# 2000 " 5" "0"
						# 2002 " 5" "0"
						# 2004 " 5" "0"
						# 2006 " 5" "0"
						# 2008 " 5" "0"


						CPD=t(apply(SMKDR,1,myConvert.cpd2b, cigmat=cigmat))
						colnames(CPD)=c("past.cpd0","past.cpd",colnames(SMKDR))

						cbind(SMKDR,CPD)[1:30,]
						#       1986 1988 1990 1992 1994 1996 1998 2000 2002 2004 2006 2008 past.cpd0 past.cpd 1986   1988   1990   1992   1994   1996   1998 2000 2002 2004 2006 2008
						#  [1,] " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						#  [2,] " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						#  [3,] " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						#  [4,] NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						#  [5,] " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						#  [6,] "11" "11" "11" "12" " 5" " 5" " 5" " 5" " 5" " 5" " 5" " 5" NA        NA       "19.5" "19.5" "19.5" "29.5" "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						#  [7,] " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						#  [8,] " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						#  [9,] " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [10,] " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [11,] " 4" " 4" " 4" " 4" " 4" " 4" " 4" " 4" " 4" " 4" " 4" " 4" "19.5"    "19.5"   "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [12,] " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [13,] " 6" " 6" " 6" " 6" " 6" " 6" " 6" " 6" " 6" " 6" " 6" " 6" "39.5"    "39.5"   "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [14,] NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [15,] " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [16,] " 4" " 4" " 4" " 4" "11" "11" " 4" " 4" NA   NA   NA   NA   "19.5"    "19.5"   "0"    "0"    "0"    "0"    "19.5" "19.5" "0"  "0"  "0"  "0"  "0"  "0"
						# [17,] " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [18,] " 3" " 3" " 3" " 3" " 3" " 3" " 3" " 3" " 3" " 3" " 3" " 3" "9.5"     "9.5"    "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [19,] "10" "10" "10" " 3" " 3" " 3" " 3" " 3" NA   NA   NA   " 3" NA        NA       "9.5"  "9.5"  "9.5"  "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [20,] " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [21,] " 4" " 4" " 4" " 4" " 4" " 4" " 4" " 4" " 4" " 4" " 4" " 4" "19.5"    "19.5"   "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [22,] " 7" " 7" " 7" " 7" " 7" " 7" " 7" " 7" " 7" " 7" " 7" " 7" "45.5"    "45.5"   "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [23,] " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [24,] " 5" " 5" " 5" " 5" " 5" " 5" " 5" " 5" " 5" " 5" " 5" " 5" "29.5"    "29.5"   "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [25,] " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [26,] " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [27,] " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [28,] " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [29,] " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" " 1" NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [30,] " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" " 8" NA        NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"




						############# (4) quit age ######################
						# ago86 		1986 time since quit smoking
											# 1= <1y  2= 1-2y  3= 3-5y  4=6-9y  5=10+y

						ysq = as.numeric(mydat[,"ago86"])
						ysq[1:30]
						# [1] NA NA NA NA NA NA NA NA NA NA  2 NA  4 NA NA  3 NA  5 NA NA  5  5 NA  4 NA NA NA NA NA  4

						#### year quit for people who quit before enter the trial ###

						age_quit = ageentry - ysq
						# > cbind(age_quit,ageentry,ysq)[1:20,]
						#       age_quit ageentry ysq
						#  [1,]       NA     65.4  NA
						#  [2,]       NA     47.8  NA
						#  [3,]       NA     56.8  NA
						#  [4,]       NA     63.4  NA
						#  [5,]       NA     40.7  NA
						#  [6,]       NA     55.5  NA
						#  [7,]       NA     57.8  NA
						#  [8,]       NA     56.0  NA
						#  [9,]       NA     42.2  NA
						# [10,]       NA     50.3  NA
						# [11,]     38.5     40.5   2
						# [12,]       NA     41.8  NA
						# [13,]     36.1     40.1   4
						# [14,]       NA     64.2  NA
						# [15,]       NA     48.7  NA
						# [16,]     66.3     69.3   3
						# [17,]       NA     42.4  NA
						# [18,]     50.8     55.8   5
						# [19,]       NA     43.8  NA
						# [20,]       NA     45.1  NA

						#quityear = 1986 - ysq
						#quityear[1:30]
						#  [1]   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA 1984   NA 1982   NA   NA 1983   NA 1981   NA   NA
						# [21] 1981 1981   NA 1982   NA   NA   NA   NA   NA 1982

						### identify people who quit afer entyring trial ###

						yearentry = ageentry + yob2
						range(yearentry)



						############# (5) Smoking Status: 0 if never smoker, 1 former (quit smoking at any time point), 2 who never quit smoke ####################################
						# smk86		 smoking 1=no  2=yes, current  3=yes, past


						#### as of 1986: 1 if never smoked, 2 if curretnly smoking as of 1986,  3 if used to smoke but quit

						smkstatus86 = as.numeric(mydat[,"smk86"])
						# > table(smkstatus86)
						# smkstatus86
						#     1     2     3
						# 22122  4888 20640

						tb=table(smkstatus86)
						tb/sum(tb)
						# smkstatus86
						#         1         2         3
						# 0.4642602 0.1025813 0.4331584

						### redefine ###
						smkstatus = rep(NA,length(smkstatus86))
						smkstatus[smkstatus86==1]=1
						smkstatus[smkstatus86==3]=2
						smkstatus[smkstatus86==2]=3

						table(smkstatus)




						doThis=F
						if(doThis==T){
							#### smoked, but quit at some point of the life ###


							indic.never = is.na(age_start)==T
							indic.former = is.na(age_start)==F  & is.na(age_quit2)==F  # is quit.age=NA, then still smoking
							indic.current = is.na(age_start)==F & is.na(age_quit2)==T  ## is quit.age=NA, then still smoking

							# > age_quit2[1:10]
							#  [1]   NA   NA 49.5   NA   NA 50.5 26.0   NA 68.5   NA

							# > sum(indic.never)+sum(indic.former)+sum(indic.current)
							# [1] 118040
							# > nrow(mydat)
							# [1] 118040


							tmp=cbind(indic.never,indic.former, indic.current)
							smkstatus=myStrataVar(tmp)[[1]]
							table(smkstatus)
							# > 		table(smkstatus)
							# smkstatus
							#     1     2     3
							# 52398  9300 56342
							# >
							# > sum(indic.never);sum(indic.former);sum(indic.current)
							# [1] 52398
							# [1] 9300
							# [1] 56342

							tb=table(smkstatus)
							tb/sum(tb)
							# > 		tb/sum(tb)
							# smkstatus
							#          1          2          3
							# 0.44390037 0.47731278 0.07878685


						}#



						################# [2.1] make input data to be used in TSCE #########################

						smkdat = cbind(id2=id2,agelc=agelc, type=histo1, subtype=histo2,YOB=yob2, ageentry, age_quit,smkstatus86, cpd.past,CPD[,-1])
						smkdat[1:30,]
						# > 		smkdat[1:30,]
						#       id2  YOB    ageentry age_quit smkstatus86 10_15 16_19  20_29  30_39  40_49  50_59  60_+ past.cpd 1986   1988   1990   1992   1994   1996   1998 2000 2002 2004 2006 2008
						#  [1,] "1"  "1921" "65.4"   NA       " 1"        NA    NA     NA     NA     NA     NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						#  [2,] "2"  "1939" "47.8"   NA       " 1"        "0"   "0"    "0"    "0"    "0"    NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						#  [3,] "3"  "1929" "56.8"   NA       " 1"        NA    NA     NA     NA     NA     NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						#  [4,] "4"  "1922" "63.4"   NA       NA          NA    NA     NA     NA     NA     NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						#  [5,] "5"  "1945" "40.7"   NA       " 1"        NA    NA     NA     NA     NA     NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						#  [6,] "6"  "1931" "55.5"   NA       " 2"        "0"   "0"    "9.5"  "9.5"  "19.5" "19.5" NA   NA       "19.5" "19.5" "19.5" "29.5" "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						#  [7,] "7"  "1928" "57.8"   NA       " 1"        NA    NA     NA     NA     NA     NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						#  [8,] "8"  "1930" "56"     NA       " 1"        NA    NA     NA     NA     NA     NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						#  [9,] "9"  "1944" "42.2"   NA       " 1"        NA    NA     NA     NA     NA     NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [10,] "10" "1936" "50.3"   NA       " 1"        NA    NA     NA     NA     NA     NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [11,] "11" "1946" "40.5"   "38.5"   " 3"        NA    NA     NA     "19.5" NA     NA     NA   "19.5"   "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [12,] "12" "1944" "41.8"   NA       " 1"        NA    NA     NA     NA     NA     NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [13,] "13" "1946" "40.1"   "36.1"   " 3"        "0"   "2.5"  "39.5" "39.5" NA     NA     NA   "39.5"   "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [14,] "14" "1922" "64.2"   NA       NA          NA    NA     NA     NA     NA     NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [15,] "15" "1937" "48.7"   NA       " 1"        NA    NA     NA     NA     NA     NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [16,] "16" "1917" "69.3"   "66.3"   " 3"        NA    NA     "19.5" "19.5" "19.5" NA     NA   "19.5"   "0"    "0"    "0"    "0"    "19.5" "19.5" "0"  "0"  "0"  "0"  "0"  "0"
						# [17,] "17" "1943" "42.4"   NA       " 1"        NA    NA     NA     NA     NA     NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [18,] "18" "1931" "55.8"   "50.8"   " 3"        NA    NA     "9.5"  NA     NA     NA     NA   "9.5"    "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [19,] "19" "1942" "43.8"   NA       " 2"        NA    "2.5"  "9.5"  "9.5"  "9.5"  NA     NA   NA       "9.5"  "9.5"  "9.5"  "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [20,] "20" "1941" "45.1"   NA       " 1"        NA    NA     NA     NA     NA     NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [21,] "21" "1934" "51.8"   "46.8"   " 3"        "9.5" "19.5" "19.5" "0"    "0"    "0"    NA   "19.5"   "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [22,] "22" "1936" "50.2"   "45.2"   " 3"        "0"   "45"   "45"   "0"    "0"    "0"    NA   "45.5"   "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [23,] "23" "1944" "41.8"   NA       " 1"        NA    NA     NA     NA     NA     NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [24,] "24" "1942" "44.7"   "40.7"   " 3"        "0"   "0"    "29.5" "29.5" "0"    NA     NA   "29.5"   "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [25,] "25" "1946" "40.3"   NA       " 1"        NA    NA     NA     NA     NA     NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [26,] "26" "1911" "76.2"   NA       " 1"        NA    NA     NA     NA     NA     NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [27,] "27" "1940" "45.7"   NA       " 1"        NA    NA     NA     NA     NA     NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [28,] "28" "1946" "39.5"   NA       " 1"        NA    NA     NA     NA     NA     NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [29,] "29" "1940" "46"     NA       " 1"        NA    NA     NA     NA     NA     NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"
						# [30,] "30" "1935" "51.7"   "47.7"   " 3"        NA    NA     NA     NA     NA     NA     NA   NA       "0"    "0"    "0"    "0"    "0"    "0"    "0"  "0"  "0"  "0"  "0"  "0"

						id = as.character(mydat[,"hpfsid"])
						row.names(smkdat)=id


						########## some cohort property ####

						#age.entry.cohort = as.numeric(mydat[,"ageentry"])
						# > age.entry.cohort[1:10]
						#  [1] 48.5 47.3 47.6 52.7 34.4 44.6 32.1 38.3 37.2 55.1

						# 						agelc=mydat[,"agelung"]
						# 						histo1=mydat[,"type"]
						# 						histo2=mydat[,"subtype"]

						####### calculate Life time pack-years ###
						#max.age=101



						lc.dat = smkdat[ix.lc,]
						#[1] 959  28



						#max.age=110
						cpd.past.cols = grep("CPD",colnames(smkdat)) #[1]  6  7  8  9 10 11 12
						cpd.current.cols = c(grep("1986",colnames(smkdat)):ncol(smkdat))

						for(j in 1:100){

						   x=lc.dat[j,]
						   pky0=myPKY.male.LC.case(x, cpd.past.cols,  cpd.current.cols)
						   tm1=c(smkdat[j,"id2"], pky=pky0)
						   if(j==1) out=tm1
						   if(j>1) out=rbind(out,tm1)

						}#


						tt=apply(smkdat, 1,myPKY.male.LC.case, cpd.past.cols=cpd.past.cols,  cpd.current.cols=cpd.current.cols)

						pky.lc = tt
						#cbind(out,smkdat[1:100,])
						#               pky id2  YOB ageentry age_start age_quit2 smkstatus past.cpd 1976 1978 1980 1982 1984 1986 1988 1990 1992 1994 1996 1998 2000 2002 2004 2006 2008
						# out   1   0.00000   1 1927     48.5        NA        NA         1       NA  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# tm1   2   0.00000   2 1929     47.3        NA        NA         1       NA  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# tm1   3  62.41000   3 1928     47.6        18        50         2    39.50 39.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# tm1   4   0.00000   4 1923     52.7        NA        NA         1       NA  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# tm1   5  40.49480   5 1942     34.4        18        48         2    26.64 29.5 39.5 19.5 19.5 19.5 29.5 29.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# tm1   6  31.78500   6 1931     44.6        18        51         2    19.50 19.5 19.5 19.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# tm1   7   3.80000   7 1944     32.1        18        26         2     9.50  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# tm1   8   0.00000   8 1938     38.3        NA        NA         1       NA  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# tm1   9  47.97000   9 1939     37.2        20        69         2    19.50 29.5 19.5 29.5 19.5 19.5 19.5 29.5 29.5  9.5 29.5 19.5 19.5  9.5  9.5  9.5  9.5  0.0
						# tm1  10 109.31530  10 1921     55.1        20        NA         3    26.56 39.5 29.5 39.5 19.5 29.5 19.5 19.5 19.5 29.5 29.5 19.5 19.5 29.5 19.5 29.5 29.5 29.5
						# tm1  11   1.90000  11 1936     40.8        22        26         2     9.50  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# tm1  12   0.37500  12 1939     37.0        19        22         2     2.50  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# tm1  13   0.00000  13 1933     43.4        NA        NA         1       NA  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# tm1  14  49.20130  14 1929     47.4        18        59         2    22.79 29.5 29.5 39.5 29.5 19.5  9.5  0.0  2.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# tm1  15  13.72750  15 1931     44.9        18        47         2     9.50  9.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# tm1  16   0.00000  16 1931     44.7        NA        NA         1       NA  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						pky.lc[pky.lc < 0 ] = 0
						# > sum(pky==0)/length(pky)
						# [1] 0.4480939
						# > summary(pky)
						#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
						#   0.000   0.000   2.925  15.680  24.380 195.400
						# > table(smkdat[,"smkstatus"])/nrow(smkdat)
						#
						#          1          2          3
						# 0.44390037 0.51191969 0.04417994

						smkdat2= cbind(pkyr.lc=pky.lc, smkdat)
						# > range(tt)
						# [1] -55.4825 195.3897


						smkdat2[ix.lc,][1:30,]
						# > smkdat2[ix.lc,][1:30,]
						#            pkyr.lc  id2 agelc type subtype  YOB ageentry age_quit smkstatus86 CPD_10_15 CPD_16_19 CPD_20_29 CPD_30_39 CPD_40_49 CPD_50_59 CPD_60_+ past.cpd 1986 1988 1990
						# X310004037     0.0   26    91    9       0 1911       76       NA           1        NA        NA        NA        NA        NA        NA       NA       NA  0.0  0.0  0.0
						# X310012034   106.2   69    67    9       0 1921       65       NA           2        NA      39.5      39.5      45.0      45.0      39.5       40       NA 39.5 39.5 39.5
						# X310014765     0.0   81    65    3       3 1929       56       NA           1        NA        NA        NA        NA        NA        NA       NA       NA  0.0  0.0  0.0
						# X310020134    10.9  108    73    1       0 1922       63       58           3        NA       9.5       9.5       9.5        NA        NA       NA      9.5  0.0  0.0  0.0
						# X310021448     1.1  110    65    3       2 1932       54       48           3       0.0       0.0       0.0       2.5       0.0       0.0       NA      2.5  0.0  0.0  0.0
						# X310032254    67.4  168    80    3       3 1923       63       58           3       2.5      19.5      39.5      39.5      39.5       0.0        0     39.5  0.0  0.0  0.0
						# X310032769    47.8  171    66    4       9 1938       48       NA           2       0.0       9.5      19.5      19.5      19.5        NA       NA       NA 19.5 19.5 19.5
						# X310035063    29.7  181    76    9       0 1929       58       55           3        NA      19.5      19.5      19.5       9.5       9.5       NA      9.5  0.0  0.0  0.0
						# X310047807     0.0  243    74    2       1 1928       58       NA           1        NA        NA        NA        NA        NA        NA       NA       NA  0.0  0.0  0.0
						# X310057608    28.3  294    56    3       3 1934       52       49           3       0.0       0.0      19.5      19.5      19.5        NA       NA     19.5  0.0  0.0  0.0
						# X310071174    12.7  363    57    3       3 1946       40       35           3        NA      19.5      19.5        NA        NA        NA       NA     19.5  0.0  0.0  0.0
						# X310071586    82.0  365    65    1       0 1935       51       NA           2       0.0      19.5      45.0      45.0      45.0      45.0       NA       NA 45.0  0.0  0.0
						# X310072385    28.0  371    76    1       0 1916       70       66           3       0.0       0.0       0.0      29.5      29.5       0.0        0     29.5  0.0  0.0  0.0
						# X310084820     2.4  435    86    5       0 1918       68       62           3       0.0       0.0       2.5       2.5       0.0       0.0        0      2.5  0.0  0.0  0.0
						# X310089227     8.7  458    64    3       1 1926       60       55           3       0.0       0.0       2.5       2.5       9.5       0.0        0      9.5  0.0  0.0  0.0
						# X310138295    93.8  687    70    9       0 1921       65       NA           2        NA        NA      19.5      39.5      39.5      39.5       40       NA 39.5 29.5 39.5
						# X310170077    28.3  832    67    3       3 1929       56       52           3       0.0       0.0      19.5      19.5      19.5       0.0       NA     19.5  0.0  0.0  0.0
						# X310175108    78.0  858    65    5       0 1941       45       NA           2       0.0       2.5      19.5      19.5      45.0        NA       NA       NA 45.0 29.5 39.5
						# X310196848    98.1  951    74    3       3 1921       64       NA           2       2.5      19.5      19.5      29.5      39.5      39.5       45       NA 45.0 45.0 19.5
						# X310203981     0.0  988    48    3       2 1945       41       NA           1        NA        NA        NA        NA        NA        NA       NA       NA  0.0  0.0  0.0
						# X310223995    68.7 1083    66    3       3 1931       55       NA           2      19.5      19.5      19.5      29.5      29.5      29.5       NA       NA 29.5 19.5 39.5
						# X310227300    80.3 1100    85    1       0 1913       73       NA           2       0.0       9.5       9.5      19.5      19.5      29.5       30       NA 29.5 19.5 19.5
						# X310258841    48.8 1262    84    1       0 1914       73       70           3        NA        NA      19.5      19.5      19.5      19.5       20     19.5  0.0  0.0  0.0
						# X310264107    77.4 1293    68    1       0 1930       57       NA           2       2.5       9.5       9.5      39.5      39.5      29.5       NA       NA 29.5 29.5 19.5
						# X310267328    83.8 1309    60    4       9 1933       53       NA           2        NA       9.5      19.5      39.5      45.0      45.0       NA       NA 45.0 45.0 45.0
						# X310280410     0.0 1368    76    5       0 1926       59       56           3        NA        NA        NA        NA        NA        NA       NA       NA  0.0  0.0  0.0
						# X310282729    26.0 1377    67    2       1 1931       55       50           3        NA        NA       9.5      19.5      19.5        NA       NA     19.5  0.0  0.0  0.0
						# X310298148    18.5 1437    74    9       0 1919       67       63           3        NA        NA       9.5       9.5       9.5       9.5       NA      9.5  0.0  0.0  0.0
						# X310298457    51.8 1440    74    3       3 1929       58       NA           2        NA        NA      29.5      29.5      29.5       9.5       NA       NA  9.5  9.5  9.5
						# X310309822    63.3 1502    74    3       3 1927       58       NA           2       0.0       0.0       9.5      29.5      39.5      29.5       NA       NA 29.5 29.5  2.5
						#            1992 1994 1996 1998 2000 2002 2004 2006 2008
						# X310004037    0    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# X310012034   40   40 39.5 39.5 39.5 39.5 39.5 39.5 39.5
						# X310014765    0    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# X310020134    0    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# X310021448    0    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# X310032254    0    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# X310032769   20   20 19.5 19.5 19.5 19.5 19.5 19.5 19.5
						# X310035063    0    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# X310047807    0    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# X310057608    0    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# X310071174    0    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# X310071586    0    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# X310072385    0    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# X310084820    0    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# X310089227    0    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# X310138295   40   40 39.5 39.5 39.5 39.5 39.5 39.5 39.5
						# X310170077    0    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# X310175108   40   30 39.5 39.5 39.5 39.5 39.5  0.0  0.0
						# X310196848   20   20 19.5 19.5 19.5 19.5 19.5 19.5 19.5
						# X310203981    0    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# X310223995    0   30 29.5 29.5 29.5 29.5 29.5 29.5 29.5
						# X310227300   20   30 29.5  0.0  0.0  0.0  0.0  0.0  0.0
						# X310258841    0    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# X310264107   20   20 19.5  0.0  0.0 19.5 19.5 19.5 19.5
						# X310267328   45   45 45.0 45.0 45.0 45.0 45.0 45.0 45.0
						# X310280410    0    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# X310282729    0    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# X310298148    0    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0
						# X310298457   20   20  9.5  9.5  9.5  9.5  9.5  9.5  9.5
						# X310309822    0    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0


						#ix.never = pky.lc==0

						### need to fix this
							# > sum(indic.neg)
							# [1] 43
							# > smkdat[indic.neg,][1:20,]
							#              id2  YOB ageentry age_start age_quit2 smkstatus past.cpd 1976 1978 1980 1982 1984 1986 1988 1990 1992 1994 1996 1998 2000 2002 2004 2006 2008
							# X110586576  5698 1944     32.2        17        32         2     19.5    0  0.0 19.5 19.5 19.5 19.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0 19.5  0.0 19.5
							# X110986935  9581 1944     31.8        17        25         2      9.5    0  2.5  2.5  2.5  2.5  2.5  2.5  9.5  9.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  9.5
							# X111149120 11152 1940     35.8        19        35         2     19.5    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0 19.5 19.5 19.5 19.5 19.5 19.5
							# X111233918 11979 1943     33.3        30        33         2      9.5    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  9.5 19.5 19.5  9.5  9.5  9.5 19.5
							# X111409537 13671 1939     37.5        24        28         2      9.5    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  9.5
							# X111794923 17421 1946     30.5        20        29         2     19.5    0 29.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0 19.5 19.5 19.5 19.5 19.5  9.5 19.5
							# X112082733 20220 1943     32.8        19        27         2     29.5    0  0.0  0.0  0.0  9.5 19.5 19.5 19.5  0.0  0.0  0.0  0.0  0.0  0.0 19.5 29.5 29.5
							# X1121155 4 20540 1942     34.4        30        33         2      2.5    0  0.0  0.0  0.0  2.5  2.5  0.0  0.0  0.0  2.5  2.5  2.5  0.0  0.0  0.0  0.0  2.5
							# X112153522 20907 1942     33.8        18        32         2     19.5    0  0.0  0.0  0.0  0.0  0.0  9.5 19.5 19.5  9.5  9.5  0.0 19.5  0.0  0.0  0.0 19.5
							# X112278778 22124 1939     37.3        19        36         2     19.5    0  0.0  0.0  9.5  9.5  9.5  9.5  9.5  9.5  9.5  0.0  0.0  0.0  0.0  9.5 19.5 19.5
							# X112440636 23687 1944     32.3        18        32         2      9.5    0  2.5  0.0  0.0  9.5  9.5  9.5  0.0  9.5  9.5  9.5  9.5  9.5  9.5 19.5 19.5 19.5
							# X112489194 24155 1942     34.6        20        27         2      9.5    0  0.0  0.0  0.0  9.5  9.5 19.5 19.5 19.5 19.5 19.5  0.0  0.0  0.0  0.0 19.5 19.5
							# X1128099 9 27260 1945     31.2        16        29         2     19.5    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  9.5 19.5
							# X112967849 28802 1944     32.8        21        31         2     19.5    0 19.5 19.5 19.5 19.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0 19.5 19.5
							# X113320624 32244 1929     46.8        24        45         2      9.5    0  2.5  2.5  9.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  9.5  9.5  9.5
							# X113694835 35872 1944     31.8        19        29         2      9.5    0  0.0  0.0  0.0  0.0  0.0  2.5  2.5  2.5  9.5  9.5  9.5  9.5 19.5  9.5  9.5  9.5
							# X114278810 41522 1940     36.4        18        31         2      9.5    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0 19.5 19.5  0.0 29.5  0.0 19.5 19.5
							# X114507062 43723 1940     36.4        21        33         2      2.5    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  9.5  9.5  9.5 19.5 19.5 19.5
							# X114943120 47958 1934     42.9        17        42         2     19.5    0  9.5  9.5 19.5  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  0.0 19.5 19.5
							# X115006736 48573 1945     31.3        19        21         2      9.5    0  0.0  0.0  0.0  0.0  0.0  0.0  0.0  9.5  9.5 19.5 19.5  9.5 19.5  9.5  2.5 19.5
							# >

						smkdat2


			}## end of function

				#### 5/12/2015: incorporating competing risk

				#name1="yearDiag.IPL"
				#name2="yearDiag.SPL"
				#SPLname="SPL"


# yearDiag.IPL = "yearDiag.IPL"
# survYear.IPL = "survYear2.IPL"
# cod.IPL ="cod2.IPL"
#
# SPLname="SPL"
#
# yearDiag.SPL = "yearDiag.SPL"
# survYear.SPL = "survYear2.SPL"
# cod.SPL = "cod2.SPL"

mySPLC.time.event2 <- function(name1,name2,SPLname,MYDATA){

		   ### define event: 0 censor, 1 SPLC, 2 LC death, 3 other death
		   ### define time for either censor, SPLC or death

			Time=Event=NULL

			colNames=c(yearDiag.IPL, survYear.IPL, cod.IPL,  SPLname, yearDiag.SPL, survYear.SPL, cod.SPL)

			MYDAT=MYDATA[,colNames]
			#MYDAT=MYDATA[,c("yearDiag.IPL","survYear2.IPL","cod2.IPL","SPL","yearDiag.SPL","survYear2.SPL","cod2.SPL")]
			# > TMP[1:10,]
			#    yearDiag.IPL survYear2.IPL cod2.IPL SPL yearDiag.SPL survYear2.SPL cod2.SPL
			# 2          1992          7.92       LC   1         2000          0.08       LC
			# 5          1991          8.17    OTHER   1         1998          1.00    OTHER
			# 7          1991          8.67       LC   1         1997          2.83       LC
			# 9          1997          7.83    alive   1         2001          3.92    alive
			# 10         1994          9.83       LC   0           NA            NA     <NA>
			# 11         1990          8.83       LC   1         1998          0.42       LC
			# 13         1988          8.75       LC   1         1995          2.00       LC
			# 17         1996          8.83    alive   0           NA            NA     <NA>
			# 19         1993         11.75    alive   1         2004          0.08    alive
			# 20         1993          7.92    OTHER   1         1996          4.92    OTHER

			### conver to years ####

			MYDAT2=MYDAT
			MYDAT2[,survYear.IPL]=MYDAT[,yearDiag.IPL] + MYDAT[,survYear.IPL]
			MYDAT2[,survYear.SPL]=MYDAT[,yearDiag.SPL] + MYDAT[,survYear.SPL]

			#MYDAT2[,"survYear2.IPL"]=MYDAT[,"yearDiag.IPL"] + MYDAT[,"survYear2.IPL"]
			#MYDAT2[,"survYear2.SPL"]=MYDAT[,"yearDiag.SPL"] + MYDAT[,"survYear2.SPL"]

			# > MYDAT2[1:20,]
			#    yearDiag.IPL survYear2.IPL cod2.IPL SPL yearDiag.SPL survYear2.SPL cod2.SPL
			# 2          1992       1999.92       LC   1         2000       2000.08       LC   --> spl
			# 5          1991       1999.17    OTHER   1         1998       1999.00    OTHER --->  SPL
			# 7          1991       1999.67       LC   1         1997       1999.83       LC
			# 9          1997       2004.83    alive   1         2001       2004.92    alive
			# 10         1994       2003.83       LC   0           NA            NA     <NA>     --->
			# 11         1990       1998.83       LC   1         1998       1998.42       LC
			# 13         1988       1996.75       LC   1         1995       1997.00       LC
			# 17         1996       2004.83    alive   0           NA            NA     <NA> ---->
			# 19         1993       2004.75    alive   1         2004       2004.08    alive
			# 20         1993       2000.92    OTHER   1         1996       2000.92    OTHER
			# 24         1994       2004.92    alive   1         2003       2004.67    alive
			# 30         1999       2004.08       LC   1         2003       2004.17       LC
			# 31         1990       2004.17    alive   1         2001       2004.00    alive
			# 32         1990       2002.17       LC   1         2002       2002.58       LC
			# 36         1992       2001.33       LC   1         1994       2001.58       LC
			# 40         1991       2002.58    OTHER   1         2001       2002.08    OTHER
			# 41         1998       2004.83    alive   1         2002       2004.42    alive
			# 42         1989       2001.33       LC   1         2000       2001.42       LC
			# 44         1993       2004.08    alive   0           NA            NA     <NA> --->alive
			# 45         1993       2004.67    alive   1         1995       2004.83    alive


			### OK, whoever SPL=0 can die from LC or others ###
			ix.SPL = (MYDAT2[,SPLname]==1)

			Event = as.character(MYDAT2[,cod.IPL])
			Event[ix.SPL] = "SPL"              # whoever has SPL is SPL

			tb=table(Event)

			barplot(tb)
			# Event
			# alive    LC OTHER   SPL
			# 14126  4107  6234  1670
			barplot(prop.table(tb),col=heat.colors(5),main="Event Status",cex.main=1.5, cex.axis=1.5)

			MYDAT2[!ix.SPL,][1:30,]
			# > 	MYDAT2[!ix.SPL,][1:30,]
			#     yearDiag.IPL survYear2.IPL cod2.IPL SPL yearDiag.SPL survYear2.SPL cod2.SPL
			# 10          1994       2003.83       LC   0           NA            NA     <NA>
			# 17          1996       2004.83    alive   0           NA            NA     <NA>
			# 44          1993       2004.08    alive   0           NA            NA     <NA>
			# 79          1989       2001.00       LC   0           NA            NA     <NA>
			# 82          1997       2004.08    alive   0           NA            NA     <NA>
			# 94          1989       2002.92    OTHER   0           NA            NA     <NA>
			# 116         1992       2000.42    OTHER   0           NA            NA     <NA>
			# 136         1996       2004.67    alive   0           NA            NA     <NA>
			# 160         1993       2000.17    OTHER   0           NA            NA     <NA>
			# 173         1992       2004.75    alive   0           NA            NA     <NA>
			# 176         1996       2004.58    alive   0           NA            NA     <NA>
			# 187         1997       2003.83    OTHER   0           NA            NA     <NA>
			# 207         1997       2002.33       LC   0           NA            NA     <NA>
			# 244         1995       2003.75    OTHER   0           NA            NA     <NA>
			# 274         1992       1998.50       LC   0           NA            NA     <NA>
			# 292         1996       2004.75    alive   0           NA            NA     <NA>
			# 298         1995       2000.33       LC   0           NA            NA     <NA>
			# 301         1994       2004.00    alive   0           NA            NA     <NA>
			# 302         1996       2001.33       LC   0           NA            NA     <NA>
			# 362         1994       2000.42    OTHER   0           NA            NA     <NA>
			# 384         1997       2004.33    OTHER   0           NA            NA     <NA>



			########## (2) define observed time #############################

			Time = as.numeric(as.character(MYDAT2[,survYear.IPL])) -   as.numeric(as.character(MYDAT2[,yearDiag.IPL]))
			# > Time[1:10]
			#  [1]  7.92  8.17  8.67  7.83  9.83  8.83  8.75  8.83 11.75  7.92


			Time[ix.SPL] =  (as.numeric(as.character(MYDAT2[,yearDiag.SPL])) - as.numeric(as.character(MYDAT2[,yearDiag.IPL])))[ix.SPL]


			# > MYDAT2[ix.SPL,][1:20,]
			#    yearDiag.IPL survYear2.IPL cod2.IPL SPL yearDiag.SPL survYear2.SPL cod2.SPL
			# 2          1992       1999.92       LC   1         2000       2000.08       LC
			# 5          1991       1999.17    OTHER   1         1998       1999.00    OTHER
			# 7          1991       1999.67       LC   1         1997       1999.83       LC
			# 9          1997       2004.83    alive   1         2001       2004.92    alive
			# 11         1990       1998.83       LC   1         1998       1998.42       LC
			# 13         1988       1996.75       LC   1         1995       1997.00       LC
			# 19         1993       2004.75    alive   1         2004       2004.08    alive
			# 20         1993       2000.92    OTHER   1         1996       2000.92    OTHER
			# 24         1994       2004.92    alive   1         2003       2004.67    alive
			# 30         1999       2004.08       LC   1         2003       2004.17       LC
			# 31         1990       2004.17    alive   1         2001       2004.00    alive

			outdat=cbind(MYDAT2, Event=Event, Time=Time)

			#cbind(MYDAT2, Event=Event, Time=Time)[1:30,]
			# > cbind(MYDAT2, Event=Event, Time=Time)[1:30,]
			#    yearDiag.IPL survYear2.IPL cod2.IPL SPL yearDiag.SPL survYear2.SPL cod2.SPL Event  Time
			# 2          1992       1999.92       LC   1         2000       2000.08       LC   SPL  8.00
			# 5          1991       1999.17    OTHER   1         1998       1999.00    OTHER   SPL  7.00
			# 7          1991       1999.67       LC   1         1997       1999.83       LC   SPL  6.00
			# 9          1997       2004.83    alive   1         2001       2004.92    alive   SPL  4.00
			# 10         1994       2003.83       LC   0           NA            NA     <NA>    LC  9.83
			# 11         1990       1998.83       LC   1         1998       1998.42       LC   SPL  8.00
			# 13         1988       1996.75       LC   1         1995       1997.00       LC   SPL  7.00
			# 17         1996       2004.83    alive   0           NA            NA     <NA> alive  8.83
			# 19         1993       2004.75    alive   1         2004       2004.08    alive   SPL 11.00
			# 20         1993       2000.92    OTHER   1         1996       2000.92    OTHER   SPL  3.00
			# 24         1994       2004.92    alive   1         2003       2004.67    alive   SPL  9.00
			# 30         1999       2004.08       LC   1         2003       2004.17       LC   SPL  4.00
			# 31         1990       2004.17    alive   1         2001       2004.00    alive   SPL 11.00
			# 32         1990       2002.17       LC   1         2002       2002.58       LC   SPL 12.00
			# 36         1992       2001.33       LC   1         1994       2001.58       LC   SPL  2.00
			# 40         1991       2002.58    OTHER   1         2001       2002.08    OTHER   SPL 10.00
			# 41         1998       2004.83    alive   1         2002       2004.42    alive   SPL  4.00
			# 42         1989       2001.33       LC   1         2000       2001.42       LC   SPL 11.00
			# 44         1993       2004.08    alive   0           NA            NA     <NA> alive 11.08
			# 45         1993       2004.67    alive   1         1995       2004.83    alive   SPL  2.00
			# 46         1999       2004.42    alive   1         2004       2004.08    alive   SPL  5.00
			# 47         1992       2004.33    alive   1         2004       2004.42    alive   SPL 12.00
			# 50         1995       2002.50       LC   1         1998       2002.83       LC   SPL  3.00
			# 58         1988       2000.58       LC   1         1995       2000.17       LC   SPL  7.00
			# 60         1990       1995.17       LC   1         1994       1995.92       LC   SPL  4.00
			# 63         1989       1997.67       LC   1         1996       1997.25       LC   SPL  7.00
			# 70         1991       2004.92    alive   1         2003       2004.17    alive   SPL 12.00
			# 75         1992       2001.50       LC   1         2001       2001.00       LC   SPL  9.00
			# 77         1990       2004.33    alive   1         1997       2004.42    alive   SPL  7.00
			# 78         1990       2004.83    alive   1         2001       2004.33    alive   SPL 11.00

				Event2 = Event
					Event2[Event=="alive"]=0
					Event2[Event=="SPL"]=1
					Event2[Event=="LC"]=2
					Event2[Event=="OTHER"]=3

        #boxplot(Time~Event,col=heat.colors(5),main="Follow-up Years (survival) by Status",cex.axis=1.5,cex.main=1.5,ylab="Survival Time (Years)",cex.lab=1.5)
		#md=aggregate(Time~Event, data=data.frame(Time,Event),median)
		#   Event Time
		# 1 alive 8.58
		# 2    LC 6.50
		# 3 OTHER 7.50
		# 4   SPL 6.00

		#text(1:4,md[,2]+1, round(md[,2],2), cex=1.5,col="blue")


		#hist(Time,col="red",main="Time from IPLC to SPLC or Censoring")

		ans=list(Time=as.numeric(Time),Event=Event, Event2=as.numeric(Event2), dat=outdat)
		ans


}#3nd of 	mySPLC.time.event



mySPLC.time.event <- function(name1,name2,SPLname,MYDATA){

			######## [1] define time of IPLC and time of SPL

			T1 = MYDATA[,name1]
			T2 = MYDATA[,name2]

			SPL=MYDATA[,"SPL"]
			#hist(T1,col="red",main="Year of IPLC diagnosis")
			#hist(T2,col="red",main="Year of SPLC diagnosis")

			TT = T2-T1

			cbind(T1,T2,TT,SPL)[1:100,]
			#          T1   T2  TT
			#   [1,] 1992 2000  8
			#   [2,] 1991 1998  7
			#   [3,] 1991 1997  6
			#   [4,] 1996 1996  0
			#   [5,] 1997 2001  4
			#   [6,] 1994   NA NA
			#   [7,] 1990 1998  8
			#   [8,] 1988 1995  7
			#   [9,] 1996   NA NA
			#  [10,] 1993 2004 11
			#  [11,] 1993 1996  3
			#  [12,] 1994 2003  9
			#  [13,] 1995 1998  3

			#MYDATA[TT==0 & is.na(TT)==F,][1:5,]

			hist(TT,col="red",main="Time from IPLC to SPLC")
			# TT
			#   0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16
			# 150  60  59  76 104 317 256 201 181 136  88  67  43  40  26  13   3
			# --> some people had SPL at the same year


		# ### want to solve the integer problem: I want it to be continous ##
		#
		# diff2=(MYDATA[,"survYearM.IPL"] - MYDATA[,"survYearM.SPL"])/12
		# hist(diff2)
		#
		# indic0=TT==0
		# sum(indic0,na.rm=T)
		# #[1] 150
		# diff2[indic0==T & is.na(indic0)==F]
		# #   [1]  56  97  57  56  67 115  77  62  86 103 142  65  70  88  65  75  59  63 107  87  86 114 143 150  78  83  68 118  95  80  80  66  56  63
		# #  [35]  73  77  99 141 105  70 137  57  81  66  56  73  59  87  62 102  73  88 171 169  68 134  55 117  57  61  76  75  65  60 121 182  91 107
		# #  [69]  69  75  74 114 142 126 114  55  74  74  63  64  72  63 155 146  63  58  96  77  56  68  62  67 125  73  77  62  62  86  95  55 144  77
		# # [103]  69  81 114  93  82  63  55  58  64  57  62  70 179 154  75 108  66  60  95  77  69  64  62  62 143  76 143 104  76  71  70  67  90  97
		# # [137]  58  65  85  83  77  58 113 107  93  74 132 121 119  63
		# (diff2)[indic0==T & is.na(indic0)==F]

		########## (2) define event (SPLC): 1 or not 0

		DD=rep(NA,length(T2))

		DD[(is.na(T2)==F)]=1  # if T2 has a value, then event happen, D=1
		DD[(is.na(T2)==T)]=0  # if T2 has NA, then event didnt happen, D=0

		table(DD)
		# table(DD)
		# DD
		#     0     1
		# 24467  1371
		# table(DAT.all4[,"SPL"])
		#
		#     0     1
		# 24916  1371

		cbind(T1,T2, TT,DD,SPL)[1:10,]
		# > cbind(T1,T2, TT,DD,SPL)[1:20,]
		#         T1   T2 TT DD SPL
		#  [1,] 1992 2000  8  1   1
		#  [2,] 1991 1998  7  1   1
		#  [3,] 1991 1997  6  1   1
		#  [4,] 1997 2001  4  1   1
		#  [5,] 1994   NA NA  0   0
		#  [6,] 1990 1998  8  1   1
		#  [7,] 1988 1995  7  1   1
		#  [8,] 1996   NA NA  0   0
		#  [9,] 1993 2004 11  1   1


		####### (3) Update TT by updated T2 (Fill NA with last follow-up day: For people who are censored, put the last following time, 2004 #####################

		T2b = T2
		T2b[is.na(T2)==T]=2004

		TTb = TT
		TTb[is.na(TT)==T] = (T2b - T1)[is.na(TT)==T]

		cbind(T1,T2b, TTb,DD,SPL)[1:20,]
		#         T1  T2b TTb DD SPL
		#  [1,] 1992 2000   8  1   1
		#  [2,] 1991 1998   7  1   1
		#  [3,] 1991 1997   6  1   1
		#  [4,] 1997 2001   4  1   1
		#  [5,] 1994 2004  10  0   0  ----> recalculated using 2004
		#  [6,] 1990 1998   8  1   1
		#  [7,] 1988 1995   7  1   1
		#  [8,] 1996 2004   8  0   0
		#  [9,] 1993 2004  11  1   1
		# [10,] 1993 1996   3  1   1

		### Time from IPLC to SPLC ###
		Time0 = TTb
		event = DD
		table(Time0)
		#    5    6    7    8    9   10   11   12   13   14   15   16
		# 2814 2679 2558 2530 2433 2336 2265 2213 1628 1522 1452 1408
		# > table(Time)
		# Time
		#    0    1    2    3    4    5    6    7    8    9   10   11
		# 2814 2679 2558 2530 2433 2336 2265 2213 1628 1522 1452 1408

		# > cbind(T1,T2b,TTb,DD)[TTb==5,][1:5,]
		#        T1  T2b TTb DD
		# [1,] 1999 2004   5  0
		# [2,] 1999 2004   5  0
		# [3,] 1999 2004   5  0
		# [4,] 1999 2004   5  0
		# [5,] 1999 2004   5  0

		###### Time since recovery ##########
		Time = Time0
		#Time = Time0-5
		table(Time)
		# Time
		#    0    1    2    3    4    5    6    7    8    9   10   11  ---> Some people dropped out at time=0
		# 2497 2679 2558 2530 2433 2336 2265 2213 1628 1522 1452 1408

		hist(Time,col="red",main="Time from IPLC to SPLC or Censoring")

		ans=cbind(Time=Time,event=event, T1=T1,T2=T2,Diff=TT,SPL=SPL)
		ans


}#3nd of 	mySPLC.time.event

		myStratIndex <- function(num, denom){
			#http://www.r-tutor.com/elementary-statistics/inference-about-two-populations/comparison-two-population-proportions
			x1=num
			x2=denom-num
			tb=rbind(x1,x2)
			# > num
			# [1]  94 160 243 261 296
			# > denom
			# [1] 5258 5038 5439 5252 4534
			# > 		x1=num
			# > 			x2=denom-num
			# > 			tb=rbind(x1,x2)
			# >
			# > tb
			#    [,1] [,2] [,3] [,4] [,5]
			# x1   94  160  243  261  296
			# x2 5164 4878 5196 4991 4238

			## taking first colum and last column
			tb2=tb[,c(1,ncol(tb))]
			# > tb2
			#    [,1] [,2]
			# x1   94  296
			# x2 5164 4238

			tst=prop.test(t(tb2))
			#
			# 	2-sample test for equality of proportions with continuity correction
			#
			# data:  t(tb2)
			# X-squared = 141.84, df = 1, p-value < 2.2e-16
			# alternative hypothesis: two.sided
			# 95 percent confidence interval:
			#  -0.05564538 -0.03916861
			# sample estimates:
			#     prop 1     prop 2
			# 0.01787752 0.06528452

			## prportion difference
			dif = (tst$estimate)[[2]]-tst$estimate[[1]]

			### normalized proportion difference ##
			z=unlist(as.vector(sqrt(tst$statistic)))  # z is defined below
			#z = (p1 - p2) / SE
			#SE = sqrt{ p * ( 1 - p ) * [ (1/n1) + (1/n2) ] }
			#p = (p1 * n1 + p2 * n2) / (n1 + n2)

			list(diff=dif, tst=tst, z=z )


		}

	  myRiskBarPlot=function(DATA, top, k, risk){
				#
				# > risk[1:5]
				# [1] 0.09419289 0.11796660 0.11796660 0.03224453 0.04408101

				  ### define threshold ####
				  if(top==T) th=quantile(risk, 1-k) # top 5%
				  if(top==F) th=quantile(risk, k) # bottom 5%
				  print(paste("risk threshold = ",round(th*100,2), "%",sep=""))

			  	  #### define indicator ####
			  	  if(top==T) ix =risk >= th
			  	  if(top==F) ix =risk < th

			  	  sum(ix)

					# > DAT[1:3,]
					#   histology.IPL ageDiag.cat.IPL radiation2.IPL
					# 1            AD           55-59       01_noRad
					# 2            SQ           60-64       01_noRad
					# 3            SQ           60-64       01_noRad

			  	#### barplot for each variable
				for( m in 1:ncol(DAT)){

					MYDAT.sm=DAT[ix,]
					tb0=table(MYDAT.sm[,m])
					tb=tb0/sum(tb0)

						# > tb
						# x
						#  AD  LC OTH  SC  SQ
						# 529  25 774  26  98
						# > tb2
						# x
						#         AD         LC        OTH         SC         SQ
						# 0.36432507 0.01721763 0.53305785 0.01790634 0.06749311

					print(round(tb,2))
					if(length(tb)>8) LAS=3
					if(length(tb)<=8) LAS=1

					if(top==F) MAIN=paste("[Bottom ",k*100,"%] Distribution of ",colnames(MYDAT.sm)[m],sep="")
					if(top==T) MAIN=paste("[Top ",k*100,"%] Distribution of ",colnames(MYDAT.sm)[m],sep="")

					barplot(tb*100,col=heat.colors(length(tb)),las=LAS,main=MAIN,cex.lab=1.5, cex.main=1.5, cex.axis=1.5, ylab="Fraction (%)")


				}#end of m

			  }#end of


 myCumRiskPlot <- function(DATA, riskMat, varname, MAIN, YLIM=c(0,0.14),cause=1){  # myVar is a factor

       #### plot cumulative risk curve by histology or age (myVar) (average curve for each subgr
		# > riskMat[1:10,]
		#                 5           6          7          8          9         10         11         12         13         14         15
		#  [1,] 0.007439527 0.014125665 0.02002069 0.02605357 0.03129708 0.03532360 0.03906879 0.04210584 0.04592794 0.04930002 0.05188644
		#  [2,] 0.019385736 0.036608464 0.05163710 0.06686612 0.07997889 0.08997044 0.09920336 0.10664783 0.11596238 0.12413012 0.13036312
		#  [3,] 0.019385736 0.036608464 0.05163710 0.06686612 0.07997889 0.08997044 0.09920336 0.10664783 0.11596238 0.12413012 0.13036312
		#  [4,] 0.005922083 0.011252198 0.01595778 0.02077940 0.02497512 0.02820018 0.03120237 0.03363867 0.03670699 0.03941612 0.04149538
		#  [5,] 0.004259142 0.008098653 0.01149313 0.01497606 0.01801078 0.02034594 0.02252168 0.02428872 0.02651593 0.02848407 0.02999569
		#  [6,] 0.018053502 0.034113406 0.04814362 0.06237665 0.07464473 0.08400079 0.09265281 0.09963338 0.10837318 0.11604219 0.12189792
		#  [7,] 0.018053502 0.034113406 0.04814362 0.06237665 0.07464473 0.08400079 0.09265281 0.09963338 0.10837318 0.11604219 0.12189792
		#  [8,] 0.006622189 0.012578430 0.01783362 0.02321530 0.02789581 0.03149189 0.03483819 0.03755284 0.04097055 0.04398710 0.04630163
		#  [9,] 0.013363623 0.025305630 0.03578094 0.04644902 0.05567833 0.06273844 0.06928408 0.07457710 0.08121922 0.08706158 0.09153150
		# [10,] 0.018053502 0.034113406 0.04814362 0.06237665 0.07464473 0.08400079 0.09265281 0.09963338 0.10837318 0.11604219 0.12189792
		# > dim(riskMat)
		# [1] 25838    11
		# >
		# > myVar[1:10]
		#  [1] 55-59 60-64 60-64 75-79 75-79 60-64 60-64 60-64 60-64 60-64
		# Levels: 00-44 45-49 50-54 55-59 60-64 65-69 75-79 80-84 85+

		########## (1) define sorting variable ###############

		myVar0 = DATA[,varname]

		# sort the name of levels
		myVar = factor(myVar0,levels=sort(levels(myVar0)))
		# > levels(myVar)
		#   [1] "00-44" "45-49" "50-54" "55-59" "60-64" "65-69" "70-74" "75-79" "80-84" "85+"



       ##### (2) calculate mean risk (over time) for each age group

		mymean = by(riskMat,  myVar, function(x) apply(x,2,mean))
		# > mymean[[1]]
		#          5          6          7          8          9         10         11         12         13         14         15
		# 0.01275390 0.02415300 0.03415366 0.04433991 0.05315370 0.05989679 0.06614918 0.07120555 0.07755132 0.08313359 0.08740489
		# > mymean[[2]]
		#           5           6           7           8           9          10          11          12          13          14          15
		# 0.005326341 0.010121962 0.014357028 0.018697846 0.022476266 0.025381270 0.028086073 0.030281436 0.033046802 0.035488912 0.037363535
		names(mymean)
		#  [1] "00-44" "45-49" "50-54" "55-59" "60-64" "65-69" "70-74" "75-79" "80-84" "85+"


		mymean
		# INDICES: 70-74
		#          5          6          7          8          9         10         11         12         13         14         15
		# 0.01275390 0.02415300 0.03415366 0.04433991 0.05315370 0.05989679 0.06614918 0.07120555 0.07755132 0.08313359 0.08740489
		# ------------------------------------------------------------------------------------------------------------------------------
		# INDICES: 00-44
		#           5           6           7           8           9          10          11          12          13          14          15
		# 0.005326341 0.010121962 0.014357028 0.018697846 0.022476266 0.025381270 0.028086073 0.030281436 0.033046802 0.035488912 0.037363535
		# ------------------------------------------------------------------------------------------------------------------------------
		# INDICES: 45-49
		#          5          6          7          8          9         10         11         12         13         14         15
		# 0.01044900 0.01980884 0.02803682 0.03643346 0.04371191 0.04928870 0.05446618 0.05865787 0.06392434 0.06856264 0.07211512
		# ------------------------------------------------------------------------------------------------------------------------------


		#######(3) define variable for ploting ########
### starting from the surviving point at year 5
ttime2 =as.numeric( colnames(riskMat))-5
		nn=length(mymean)
		groups=names(mymean)
		# >groups
		#  [1] "00-44" "45-49" "50-54" "55-59" "60-64" "65-69" "70-74" "75-79" "80-84" "85+"

		###### (4) define color ####

		##library(RColorBrewer)

		if(nn < 7) cols=c("red","black","blue","purple","dark green","hot pink", "dark gray", "coral","cornflowerblue","aquamarine3")[1:nn]
		if(nn >= 7) { #cols=c(brewer.pal(9, name="RdPu"), brewer.pal(9, name="RdPu")[9])

				colfunc<-colorRampPalette(c("red", "dark green", "royalblue"))#colorRampPalette(c("red","springgreen","royalblue"))
				cols = rev(colfunc(10))
				#plot(rep(1,50),col=(colfunc(10)), pch=19,cex=2)
		}#
		# Blues BuGn BuPu GnBu Greens Greys Oranges OrRd PuBu PuBuGn PuRd Purples RdPu Reds
		# YlGn YlGnBu YlOrBr YlOrRd
		ltys = c(1,4, 5, 8, 10,15,1,4, 5, 8, 10,15)[1:nn]
		lwds = c(2,2,3,2,2,3,3,2,3,2,2,2,2,2,3,1,2,3)[1:nn]

	   par(mar=c(5,5,4,5))

		for(j in 1:nn){

			# > mymean[[j]]
			#           5           6           7           8           9          10          11          12          13          14          15
			# 0.005326341 0.010121962 0.014357028 0.018697846 0.022476266 0.025381270 0.028086073 0.030281436 0.033046802 0.035488912 0.037363535

			if(j==1) {

			plot(ttime2, 100*mymean[[j]], type="n", cex.lab=1.5, cex.axis=1.5, cex.main=1.5,
					ylab="Cumulative Risk of SPLC (%)", xlab="Time since survival (Year)", ylim=YLIM*100)


			}

			lines(ttime2,100*mymean[[j]],col=cols[j],lty=ltys[j],type="s",cex=1.5,lwd=lwds[j])


			## take last value
			tt=100*mymean[[j]]
			mymax0 = tt[length(tt)]

			if(j==1) mymax = mymax0
			if(j>1) mymax = c(mymax, mymax0)

			print(100*mymean[[j]])


		}#

		abline(h=c(0:14), lty="dotted", lwd=0.5)


		####### I am trying to put the legend by largest risk to smallest! ####
		# > mymax
		#        15        15        15        15        15        15        15        15        15        15
		#  3.736353  7.211512  7.744343  9.131021 11.004658 10.108395  8.740489  4.981372  3.499615  1.290345
		myorder=order(mymax,decreasing=T)

		lg=groups

		mycex=1.5
		if(nn > 7) mycex = 1

		legend(x="topleft", legend=groups[myorder], col=cols[myorder], lty=ltys[myorder],cex=mycex, lwd=lwds[myorder], bg="white")



		 ############### (5) equality test ################
# In the analysis we estimate CIF, perform
# test for equality of CIF curves in subgroups, and compute
# pointwise confidence intervals


#  At the same time we test equality of cumulative
# incidence curves in patients affected by AML and ALL.
#
# 5 Gray RJ. A class of K-sample tests for comparing the
# cumulative incidence of a competing risk. Ann Stat 1988; 16:
# 11411154.


		eqtest=cuminc(ftime=DATA$Time, fstatus=DATA$event, group=DATA[,varname], cencode=0)
		eqtest$Tests
		# Tests:
		#        stat           pv df
		# 1  40.02991 4.267219e-08  4 <---- this cause 1 (SPLC)
		# 2  55.70892 2.307676e-11  4
		# 3 146.30811 0.000000e+00  4
		#http://www.hematologialafe.es/DOCUMENTOS_D/SESION%20LECTURA%20CRITICA/SCRUCCA_L_BMT2009359B.PDF

		#eqtest=cuminc(ftime=DATA$Time, fstatus=DATA$event, group=DATA[,varname], cencode=0)

		#  > eqtest
		# Tests:
		#        stat pv df
		# 1  113.2191  0  9
		# 2  112.7074  0  9
		# 3 1904.2628  0  9
		# Estimates and Variances:

			stat= round(eqtest$Tests[cause,"stat"],2)  # 1 if cause=1 (SPLC
			#[1] 40.02991
			pval=sprintf("%.2e",eqtest$Tests[cause,"pv"])
			#[1] 4.267219e-08

			mytest=eqtest$Tests
			row.names(mytest)=paste("event",1:nrow(mytest),sep="")
			mytest


			mymain = paste(MAIN, "\n (stat=", stat, " pval=",pval,")", sep="")
			title(mymain, cex.main=1.5)


			print(mytest)



}#end of
            myCumRiskPlot.wrong <- function(varname, values, fit,ttime, newdata){

					#newdata=data.frame(X = values)
					#     X
					# 1  AD
					# 2  LC
					# 3  SC
					# 4  SQ
					# 5 OTH

					pr=predictEventProb(fit, newdata=newdata ,cause=1,times=ttime)
					row.names(pr)=values
					colnames(pr) = ttime
					# > pr[1:5,1:10]
					#               5 5.07999999999993 5.17000000000007        5.25 5.32999999999993 5.42000000000007         5.5
					# AD  0.012978816      0.012978816      0.012978816 0.012978816      0.012978816      0.012978816 0.012978816
					# LC  0.013265248      0.013265248      0.013265248 0.013265248      0.013265248      0.013265248 0.013265248
					# SC  0.014758778      0.014758778      0.014758778 0.014758778      0.014758778      0.014758778 0.014758778
					# SQ  0.014192731      0.014192731      0.014192731 0.014192731      0.014192731      0.014192731 0.014192731
					# OTH 0.009123853      0.009123853      0.009123853 0.009123853      0.009123853      0.009123853 0.009123853
					#     5.57999999999993 5.67000000000007        5.75
					# AD       0.012978816      0.012978816 0.012978816
					# LC       0.013265248      0.013265248 0.013265248
					# SC       0.014758778      0.014758778 0.014758778
					# SQ       0.014192731      0.014192731 0.014192731
					# OTH      0.009123853      0.009123853 0.009123853

					#### substract 5 year survival ###
					ttime2 = ttime-5

					#library(RColorBrewer)
					nn=nrow(pr)
					if(nn < 7) cols=c("red","black","blue","purple","dark green","hot pink", "dark gray", "coral","cornflowerblue","aquamarine3")[1:nn]
					if(nn >= 7)  cols=c(brewer.pal(9, name="RdPu"), brewer.pal(9, name="RdPu")[9])

					colfunc<-colorRampPalette(c("red", "dark green", "royalblue"))#colorRampPalette(c("red","springgreen","royalblue"))
					cols = rev(colfunc(10))
					#plot(rep(1,50),col=(colfunc(10)), pch=19,cex=2)

					# Blues BuGn BuPu GnBu Greens Greys Oranges OrRd PuBu PuBuGn PuRd Purples RdPu Reds
					# YlGn YlGnBu YlOrBr YlOrRd
					ltys = c(1,4, 5, 8, 10,15,1,4, 5, 8, 10,15)[1:nn]
					lwds = c(2,2,3,2,2,3,3,2,3,2,2,2,2,2,3,1,2,3)[1:nn]

					for(j in 1:nn){

						if(j==1) {

						plot(ttime2, 100*pr[j,], ylim=c(0,15), type="n", cex.lab=1.5, cex.axis=1.5, cex.main=1.5,
								ylab="Cumulative Risk for SPLC (%)", xlab="Time since survival (Year)")

						}

						lines(ttime2,100*pr[j,],col=cols[j],lty=ltys[j],type="s",cex=1.5,lwd=lwds[j])

					}#
					lg=values

					mycex=1.5
					if(nn > 7) mycex = 1


					legend(x="topleft", legend=lg, col=cols, lty=ltys,cex=mycex, lwd=lwds)

					 ############### equality test ################
					 ##library(cmprsk)

					 DATA = DAT.sm.imp.red

					 ctest=cuminc(ftime=DATA$Time, fstatus=DATA$event, group=DATA[,varname], cencode=0)
					 ctest
					# Tests:
					#        stat           pv df
					# 1  40.02991 4.267219e-08  4 <---- this cause 1 (SPLC)
					# 2  55.70892 2.307676e-11  4
					# 3 146.30811 0.000000e+00  4
					#http://www.hematologialafe.es/DOCUMENTOS_D/SESION%20LECTURA%20CRITICA/SCRUCCA_L_BMT2009359B.PDF

					stat= round(ctest$Tests["1","stat"],2)
					#[1] 40.02991
					pval=sprintf("%.2e",ctest$Tests["1","pv"])
					#[1] 4.267219e-08

					mytest=ctest$Tests
					row.names(mytest)=paste("event",1:nrow(mytest),sep="")
					mytest


					mymain = paste(varname, " (stat=", stat, " pval=",pval,")", sep="")
					title(mymain, cex.main=1.5)

					print(fit)
					print(mytest)


            }#end of



         getMedian <- function(mat, k){ # this extract the median value of the matrix

			#  > mat[1:3,]
			#             5          6          7          8          9         10         11         12         13         14         15
			# 1 0.007692183 0.01554919 0.02333041 0.03225713 0.04090214 0.04830424 0.05601729 0.06299549 0.07274289 0.08236497 0.09055274
			# 2 0.018276031 0.03674165 0.05482859 0.07533307 0.09494171 0.11153732 0.12864040 0.14394775 0.16506606 0.18561268 0.20286258
			# 3 0.018276031 0.03674165 0.05482859 0.07533307 0.09494171 0.11153732 0.12864040 0.14394775 0.16506606 0.18561268 0.20286258

 			### (1) take the risk at year 15 ##
 			xx = mat[,ncol(mat)]

 			### (2) find the order of risk from smallest to hargest

 			## row numbers of
 			orders = order(xx)
 			# [1]  4780  5971  8592 11937 17710 23067 25441 25534  5907 12568

					### this person has the smallest risk
					# > mat[4780,]
					#           5           6           7           8           9          10          11          12          13          14          15
					# 0.001398770 0.002836707 0.004270067 0.005925995 0.007541630 0.008934484 0.010395318 0.011725418 0.013596992 0.015460370 0.017058624
					# > orders[length(orders)]
					# [1] 25505

					## this helps sort from smallest to largest ##
					xx2 = xx[orders]
					# > xx[1:10]
					#          1          2          3          5          6          7          8          9         11         13
					# 0.09055274 0.20286258 0.20286258 0.08288501 0.07282257 0.18587601 0.18587601 0.08143751 0.13796163 0.18587601
					# > xx2[1:10]
					#       5079       6270       8891      12236      18009      23366      25740      25833       6206      12867
					# 0.01705862 0.01705862 0.01705862 0.01705862 0.01705862 0.01705862 0.01705862 0.01705862 0.02355193 0.02355193

					 # > order(xx)[1:10]
					#  [1]  4780  5971  8592 11937 17710 23067 25441 25534  5907 12568

			#### (3) identify the median person to pull hout ###

			myrow0 = ceiling(length(xx2)*k)	 # k=0.5 is median
			#[1] 12919 th person
					#

			### (4) extract the person
			myrow=(orders)[myrow0]
			myrow
			#[1] 6644

			out=mat[myrow,]
			out

		}#3nd of



						#x=DAT[4,]
						#AGE=50

		getCPD.small <- function(x,AGE){

			ans=NULL
			# > AGE
			# [1] 50
			### get CPD at age 50

			# > x
			#   X race gend birth_yr age_init age_cess age_death_OC quintile age_smoke1     CPD1 age_smoke2     CPD2 age_smoke3     CPD3 age_smoke4     CPD4
			# 4 4    0    0     1950       16       82           89        3         16 5.744068         17 9.856438         18 11.81121         19 13.34136
			#   age_smoke5     CPD5 age_smoke6     CPD6 age_smoke7     CPD7 age_smoke8     CPD8 age_smoke9     CPD9 age_smoke10    CPD10 age_smoke11    CPD11
			# 4         20 14.62065         21 15.72104         22 16.68238         23 17.53028         24 18.28275          25 18.95324          26 19.55221
			#   age_smoke12    CPD12 age_smoke13    CPD13 age_smoke14  CPD14 age_smoke15    CPD15 age_smoke16    CPD16 age_smoke17    CPD17 age_smoke18
			# 4          27 20.08808          28 20.56776          29 20.997          30 21.09972          31 20.98907          32 20.87843          33
			#      CPD18 age_smoke19    CPD19 age_smoke20    CPD20 age_smoke21    CPD21 age_smoke22   CPD22 age_smoke23    CPD23 age_smoke24    CPD24
			# 4 20.76778          34 20.65714          35 20.54649          36 20.43585          37 20.3252          38 20.21456          39 20.10391
			#   age_smoke25    CPD25 age_smoke26    CPD26 age_smoke27    CPD27 age_smoke28    CPD28 age_smoke29    CPD29 age_smoke30    CPD30 age_smoke31
			# 4          40 19.99327          41 19.88262          42 19.77198          43 19.66133          44 19.55069          45 19.44004          46
			#     CPD31 age_smoke32    CPD32 age_smoke33    CPD33 age_smoke34    CPD34 age_smoke35    CPD35 age_smoke36    CPD36 age_smoke37    CPD37
			# 4 19.3294          47 19.21875          48 19.10811          49 18.99746          50 18.88682          51 18.77617          52 18.66553
			#   age_smoke38    CPD38 age_smoke39    CPD39 age_smoke40    CPD40 age_smoke41    CPD41 age_smoke42   CPD42 age_smoke43    CPD43 age_smoke44
			# 4          53 18.55488          54 18.44424          55 18.33359          56 18.22295          57 18.1123          58 18.00166          59
			#      CPD44 age_smoke45    CPD45 age_smoke46    CPD46 age_smoke47    CPD47 age_smoke48    CPD48 age_smoke49    CPD49 age_smoke50    CPD50
			# 4 17.89101          60 17.78037          61 17.66972          62 17.55908          63 17.44843          64 17.33779          65 17.22714

			#### (0) first age of smoking ###

			ageInit = as.vector(unlist(x["age_init"])); ageInit
			#[1] 16

			### columname "age_smoke1" is for age 16 ---> age 50 is

			if(ageInit==-999){  ans = 0  }
			if(ageInit!=-999){  # if this person started smoking at some point

					ageDiff = AGE - ageInit+1; ageDiff

					if(ageDiff > 0 ){  # start smoking before age= 50


						cName0 = paste("age_smoke",ageDiff,sep="")
						cName1= paste("CPD",ageDiff,sep="")

						#tt1=x[cName0];tt1
						#   age_smoke35
						# 4          50

						ans=x[cName1];ans
						#      CPD35
						# 4 18.88682
						#   CPD34
						# 7    NA   <--- stop smoking, then NA

						if(is.na(ans)==T)  ans=0

					}#3nd of if(ageDiff >=0 ){


					if(ageDiff <= 0 ){  # start smoking AFTER age= 50

							ans = 0   # then zero CPD at age 50

					}#3nd of if(ageDiff >=0 ){

			}#end of getCPD.small



			ageInit
			as.vector(unlist(ans))


		}#end of function

	getCigYears.sm <- function(x,AGE){


			ans=NULL
			# > AGE
			# [1] 50
			### get CPD at age 50

			# > x
			#   X race gend birth_yr age_init age_cess age_death_OC quintile age_smoke1     CPD1 age_smoke2     CPD2 age_smoke3     CPD3 age_smoke4     CPD4
			# 4 4    0    0     1950       16       82           89        3         16 5.744068         17 9.856438         18 11.81121         19 13.34136
			#   age_smoke5     CPD5 age_smoke6     CPD6 age_smoke7     CPD7 age_smoke8     CPD8 age_smoke9     CPD9 age_smoke10    CPD10 age_smoke11    CPD11
			# 4         20 14.62065         21 15.72104         22 16.68238         23 17.53028         24 18.28275          25 18.95324          26 19.55221
			#   age_smoke12    CPD12 age_smoke13    CPD13 age_smoke14  CPD14 age_smoke15    CPD15 age_smoke16    CPD16 age_smoke17    CPD17 age_smoke18
			# 4          27 20.08808          28 20.56776          29 20.997          30 21.09972          31 20.98907          32 20.87843          33
			#      CPD18 age_smoke19    CPD19 age_smoke20    CPD20 age_smoke21    CPD21 age_smoke22   CPD22 age_smoke23    CPD23 age_smoke24    CPD24
			# 4 20.76778          34 20.65714          35 20.54649          36 20.43585          37 20.3252          38 20.21456          39 20.10391
			#   age_smoke25    CPD25 age_smoke26    CPD26 age_smoke27    CPD27 age_smoke28    CPD28 age_smoke29    CPD29 age_smoke30    CPD30 age_smoke31
			# 4          40 19.99327          41 19.88262          42 19.77198          43 19.66133          44 19.55069          45 19.44004          46
			#     CPD31 age_smoke32    CPD32 age_smoke33    CPD33 age_smoke34    CPD34 age_smoke35    CPD35 age_smoke36    CPD36 age_smoke37    CPD37
			# 4 19.3294          47 19.21875          48 19.10811          49 18.99746          50 18.88682          51 18.77617          52 18.66553
			#   age_smoke38    CPD38 age_smoke39    CPD39 age_smoke40    CPD40 age_smoke41    CPD41 age_smoke42   CPD42 age_smoke43    CPD43 age_smoke44
			# 4          53 18.55488          54 18.44424          55 18.33359          56 18.22295          57 18.1123          58 18.00166          59
			#      CPD44 age_smoke45    CPD45 age_smoke46    CPD46 age_smoke47    CPD47 age_smoke48    CPD48 age_smoke49    CPD49 age_smoke50    CPD50
			# 4 17.89101          60 17.78037          61 17.66972          62 17.55908          63 17.44843          64 17.33779          65 17.22714

			# > x[1:20] i = 67
			#     X race gend birth_yr age_init age_cess age_death_OC quintile age_smoke1    CPD1 age_smoke2    CPD2 age_smoke3    CPD3 age_smoke4    CPD4 age_smoke5
			# 67 67    0    0     1950       79     -999           85        3         79 16.1207         80 16.1207         81 16.1207         82 16.1207         83
			#       CPD5 age_smoke6    CPD6
			# 67 16.1207         84 16.1207

			#### (0) first age of smoking ###

			ageInit = as.vector(unlist(x["age_init"])); ageInit
			#[1] 16
			ageCess =as.vector(unlist(x["age_cess"])); ageCess
			#[1] 82
			#[1] -999  <--- did not stop


			if(ageInit==-999){  ans = 0  }
			if(ageInit!=-999){  # if this person started smoking at some point

					## years since smoking

						#ageDiff = AGE - ageInit ; ageDiff

						##### (i)  ageInit >= 50 (e.g. ageInit = 62)

						if(AGE <= ageInit){ # age initiation has not occured yet so zero years so far

							ans = 0 # 0 years of smoking history


						}#end of

						###### (i) ageInit < 50 (e.g. ageInit = 49)

						if(AGE > ageInit){  # if years since smoking is large

							#ix = AGE <= ageCess

							## (a) ageInit < 50 < ageCess:   smoking cessation has't paeened
							if(AGE<=ageCess){

									ans = AGE - ageInit

							}
							## (b) ageInit < ageCess < 50  ### smoking cessation happend already
							if(AGE > ageCess){

									if(ageCess!=-999){ # did

									ans = ageCess - ageInit

									}

									if(ageCess==-999){  # did 't stop smoking

									     ans = AGE - ageInit  # year since initiation to current
									}

							}#if(AGE > ageCess){


						}# if(ageDiff > 0){


			}#end if(ageInit!=-999)

			as.vector(unlist(ans))

		}#end of function

######## confidence interval for multinomial proportion ##
myCI_proportion=function(probs, n) { # n is total sum of all categories

     se=sqrt(probs*(1-probs)/n)
     ci1 = probs - 1.96*se
     ci2 = probs + 1.96*se

     cbind(probs, ci1, ci2)

}
			getDistMarginal <- function(PROB.edu.race, RACE){ # RACE="B" "W" "H" "A"

						# given prob table, this extract marginal distribution of smoking and aducation


						tb.edu = tb.smk = NULL

						### calculate their smoking weight from the population prob data ##
						PROB.edu.race
						#            X       Never      Former      Current
						# 1   A-<=high 0.011003869 0.010810241 0.0049432595
						# 2  A-college 0.006274488 0.004309134 0.0015295300
						# 3  A-postcol 0.006870389 0.003493892 0.0007911362
						# 4   B-<=high 0.022749893 0.030327496 0.0360210866
						# 5  B-college 0.001962968 0.001770239 0.0018459844
						# 6  B-postcol 0.003119718 0.002492310 0.0013713027
						# 7   H-<=high 0.023521937 0.029225801 0.0201044561
						# 8  H-college 0.001296961 0.001723653 0.0003691969
						# 9  H-postcol 0.001962968 0.001187923 0.0004219393
						# 10 W-college 0.060881139 0.049158741 0.0190740359
						# 11 W-postcol 0.027048226 0.015081669 0.0055011787
						# 12  W-<=high 0.203307442 0.250418900 0.1380268937
						### take subset for the given race

						TB.w0 = PROB.edu.race[grep(RACE,as.character(PROB.edu.race[,"X"])),]; TB.w0
						#           X  Never Former Current
						# 10 W-college 0.0609 0.0492  0.0191
						# 11 W-postcol 0.0270 0.0151  0.0055
						# 12  W-<=high 0.2033 0.2504  0.1380


						## exclude first column
						TB.w = TB.w0[,-1]
						row.names(TB.w)=as.character(TB.w0[,1])
						TB.w
						#            Never Former Current
						# W-college 0.0609 0.0492  0.0191
						# W-postcol 0.0270 0.0151  0.0055
						# W-<=high  0.2033 0.2504  0.1380


						###### (a)calculate the education and smoking distribution for this race #######
						## For this race group (e.g. W) calculate education distributuion and smoking distribution withn this race (NORMALIZED to be 1)
						tb.edu=rowSums(TB.w)/sum(TB.w); tb.edu
						# 	  B-<=high  B-college  B-postcol
						# 0.87642732 0.05488035 0.06869232

						# > sum(tb.edu)
						# [1] 1



						#########(b) calculate the education and smoking distribution for this race #######

						#### smoking distribution for this
						tb.smk=colSums(TB.w)/sum(TB.w); tb.smk
						#   Never  Former Current
						#   0.379   0.409   0.212

						# > tb.edu
						#  W-college  W-postcol   W-<=high   ----> edu dist within white
						# 0.15808709 0.04766402 0.79424889
						# > tb.smk
						#     Never    Former   Current   ---> smoking dist within white
						# 0.3623362 0.4201717 0.2174921


						#### (c) joint dist of edu x cigstat ###

						tb.joint = TB.w/sum(TB.w)
						# > tb.joint
						#                Never     Former    Current
						# B-<=high  0.22378192 0.29831987 0.35432553
						# B-college 0.01930896 0.01741316 0.01815824
						# B-postcol 0.03068746 0.02451589 0.01348898


					   list(tb.edu=tb.edu, tb.smk=tb.smk, tb.joint=tb.joint)


					}#3nd of

			getPredict.ns <- function(newdata,nsmat, myCOEF){

					### this produce the product of coef * ns matrix for a given new data point

					# > newdata
					# [1] 1.23


					# nsmat = ns(MYDATA$cigyears, df=2)
					# > dim(nsmat)
					# [1] 36108     2

					# > nsmat[1:10,]
					#               1          2
					#  [1,] 0.0000000  0.0000000
					#  [2,] 0.2386266 -0.1289533
					#  [3,] 0.3176718 -0.1653115
					#  [4,] 0.0000000  0.0000000
					#  [5,] 0.5385870  0.1257247
					#  [6,] 0.4603504 -0.2021484
					#  [7,] 0.0000000  0.0000000
					#  [8,] 0.0000000  0.0000000
					#  [9,] 0.5244108  0.1783489
					# [10,] 0.0000000  0.0000000


					##### predict *spline value* of a new data! ####
					ns.new = predict(nsmat, newdata)
					#               1           2
					# [1,] 0.03796857 -0.02129747

					#               1         2          3
					# [1,] -0.1302351 0.4435947 -0.2661568

					##### take relevant coeff ###########
					# > mycoef
					#               (Intercept)                     raceA                     raceB                     raceH                educollege
					#               28.93672095               -2.31458530                1.00499687               -0.21642658               -0.82377975
					#                edupostcol          ns(age, df = 4)1          ns(age, df = 4)2          ns(age, df = 4)3          ns(age, df = 4)4
					#               -1.20668184               -0.92561049               -1.49892646               -2.22674219               -1.98275680
					#            cigstatCurrent             cigstatFormer          ns(cigyears, 2)1          ns(cigyears, 2)2            ns(cigday, 2)1
					#               -2.87579661               -1.02453731                1.67742464               -0.21445874                2.50800835


					ns.new
					#               1           2
					# [1,] 0.03796857 -0.02129747


					prd = sum(ns.new * myCOEF)
					prd
					#[1] 0.06825685

			}#end of


getMeanBMI.eachRace <- function(mycoef, races,PROB.edu.race, MYDATA, Gender,CPD.50.mean, cigyears50.mean ){

			for(i in 1:length(races)){

					rc=races[i] # [1] "W"

					### take out race coefficient?

					rc.cof=NULL

					if(rc=="B" | rc=="A" | rc=="H") rc.cof = paste("race", rc,sep="")

					rc.cof


					#if(Gender=="M") if((rc=="B" | rc=="A") & Gender=="M" ) rc.cof = paste("race", rc,sep="") # [1] "raceB # W and H are reference group
					#if(Gender=="F") if((rc=="B" | rc=="A" | rc=="H") & Gender=="F" ) rc.cof = paste("race", rc,sep="") # [1] "race2.B # W and H are reference group

					#[1] "raceB"



					#########  to calculate the mean BMI for given race and age = 50, I need to know the mean x value for education, pack-years, smoking status of this cohort ####
					######## for education, and smoking status, I can use the ref. distribution that I used from literature, and for pack-years, I will use things from SHG data


					# > mycoef (male)
					#               (Intercept)                     raceA                     raceB                     raceH                educollege
					#               28.93672095               -2.31458530                1.00499687               -0.21642658               -0.82377975
					#                edupostcol          ns(age, df = 4)1          ns(age, df = 4)2          ns(age, df = 4)3          ns(age, df = 4)4
					#               -1.20668184               -0.92561049               -1.49892646               -2.22674219               -1.98275680
					#            cigstatCurrent             cigstatFormer          ns(cigyears, 2)1          ns(cigyears, 2)2            ns(cigday, 2)1
					#               -2.87579661               -1.02453731                1.67742464               -0.21445874                2.50800835
					#            ns(cigday, 2)2      raceA:cigstatCurrent      raceB:cigstatCurrent      raceH:cigstatCurrent       raceA:cigstatFormer
					#                2.38200835                1.19213242               -0.92341518                0.30620802                0.13587868
					#       raceB:cigstatFormer       raceH:cigstatFormer educollege:cigstatCurrent edupostcol:cigstatCurrent  educollege:cigstatFormer
					#               -0.69128966                0.14281709                0.42260270                0.88265940                0.01160008
					#  edupostcol:cigstatFormer
					#                0.23711154

					# 				mycoef (female)
					# 		 (Intercept)                     raceA                     raceB                     raceH                educollege
					# 			  28.1008                   -3.0838                    3.6831                    0.8377                   -1.3414
					# 		   edupostcol          ns(age, df = 3)1          ns(age, df = 3)2          ns(age, df = 3)3            cigstatCurrent
					# 			  -1.5367                   -0.8800                   -1.4703                   -1.8001                   -2.9546
					# 		cigstatFormer      ns(cigyears, df = 1)        ns(cigday, df = 1) educollege:cigstatCurrent edupostcol:cigstatCurrent
					# 			  -0.9465                    0.0369                    6.0196                    0.3876                    1.0413
					# educollege:cigstatFormer  edupostcol:cigstatFormer
					# 			  -0.0446                    0.0962

					base0 = int = mycoef[1]



					########### (1) Race effect ######################


					race.eff = 0

					if(rc=="B" | rc=="A" | rc=="H")  race.eff = mycoef[rc.cof]
					race.eff
					#    raceB
					# 1.004997


					####### (2) average college effect ################

					### education distribution for the given race ###
					RACE=rc

					tm=getDistMarginal(PROB.edu.race, RACE=rc)

					tb.edu = tm$tb.edu
					tb.edu
					# > tb.edu
					#   B-<=high  B-college  B-postcol
					# 0.87642732 0.05488035 0.06869232


					######### adding education effect with white population value ###
					### average education value: inner product of  coefficient and weight ##
					edu.ave = sum( mycoef[c("educollege", "edupostcol")]  * (tb.edu[c(grep("college",names(tb.edu)), c(grep("postcol",names(tb.edu))))]) ); edu.ave
					edu.ave
					#[1] -0.1280991

					#edu.ave = sum( mycoef[c("edu2.college", "edu2.postcol")]  * (tb.edu[c(grep("college",names(tb.edu)), c(grep("postcol",names(tb.edu))))]) ); edu.ave
					# > edu.ave
					# [1] -0.1734357
					# > tb.edu[c(grep("college",names(tb.edu)), c(grep("postcol",names(tb.edu))))]
					#  W-college  W-postcol
					# 0.15808709 0.04766402
					# > mycoef[c("edu2.college", "edu2.postcol")]
					# edu2.college edu2.postcol
					#   -0.7733352   -1.0737942

					######## (3) adding average smoking status effect with white population average value ##
					### average smoking value ##
					# > tb.smk
					# 	Never    Former   Current
					# 0.3623362 0.4201717 0.2174921

					# > mycoef[c("cigstat2.Former", "cigstat2.Current")]
					#  cigstat2.Former cigstat2.Current
					#        0.5017409       -1.1869532


					tb.smk = tm$tb.smk
					# > tb.smk
					#     Never    Former   Current
					# 0.2737783 0.3402489 0.3859727
					tb.smk

					if(Gender=="M") smk.ave = sum(   mycoef[c("cigstatFormer", "cigstatCurrent")]  * tb.smk[c("Former","Current")]   )
							# > mycoef[c("cigstatFormer", "cigstatCurrent")]
							#  cigstatFormer cigstatCurrent
							#      -1.024537      -2.875797
							# > tb.smk[c("Former","Current")]
							#    Former   Current
							# 0.3402489 0.3859727
					if(Gender=="F") smk.ave = sum(   mycoef[c("cigstatFormer", "cigstatCurrent")]  * tb.smk[c("Former","Current")]   )

		#if(Gender=="F") smk.ave = sum(   mycoef[c("cigstat2.Current")]  * tb.smk[c("Current")]   )

					smk.ave
					#smk.ave
					#[1] -1.458577

					# > mycoef
					#               (Intercept)                     raceA                     raceB                     raceH                educollege
					#               28.93672095               -2.31458530                1.00499687               -0.21642658               -0.82377975
					#                edupostcol          ns(age, df = 4)1          ns(age, df = 4)2          ns(age, df = 4)3          ns(age, df = 4)4
					#               -1.20668184               -0.92561049               -1.49892646               -2.22674219               -1.98275680
					#            cigstatCurrent             cigstatFormer          ns(cigyears, 2)1          ns(cigyears, 2)2            ns(cigday, 2)1
					#               -2.87579661               -1.02453731                1.67742464               -0.21445874                2.50800835
					#            ns(cigday, 2)2      raceA:cigstatCurrent      raceB:cigstatCurrent      raceH:cigstatCurrent       raceA:cigstatFormer
					#                2.38200835                1.19213242               -0.92341518                0.30620802                0.13587868
					#       raceB:cigstatFormer       raceH:cigstatFormer educollege:cigstatCurrent edupostcol:cigstatCurrent  educollege:cigstatFormer
					#               -0.69128966                0.14281709                0.42260270                0.88265940                0.01160008
					#  edupostcol:cigstatFormer
					#                0.23711154

					# > mycoef
					#               (Intercept)                     raceA                     raceB                     raceH                educollege
					#                 28.100835                 -3.083767                  3.683110                  0.837670                 -1.341445
					#                edupostcol          ns(age, df = 3)1          ns(age, df = 3)2          ns(age, df = 3)3            cigstatCurrent
					#                 -1.536731                 -0.879970                 -1.470328                 -1.800092                 -2.954600
					#             cigstatFormer                  cigyears                    cigday educollege:cigstatCurrent edupostcol:cigstatCurrent
					#                 -0.946526                  0.000478                  0.048264                  0.387644                  1.041331
					#  educollege:cigstatFormer  edupostcol:cigstatFormer
					#                 -0.044594                  0.096161

					########### (4) average Interaction effect (race * cigstat) #####

					smk.race.ave=NULL

					## if race x cigstat is not in the regression then zero
					if( length(grep("raceA:cigstatCurrent",names(mycoef))) == 0) smk.race.ave = 0

					if( length(grep("raceA:cigstatCurrent",names(mycoef)))   > 0) {  # if racexcigstt is in this regression)


							if(rc=="W") smk.race.ave = 0  # all white indictor is zero ##

							if(rc!="W"){

								tt=mycoef[grep(c("race"), names(mycoef))]
								tt2=tt[grep("cigstat", names(tt))	]
								# > tt2
								# raceA:cigstatCurrent raceB:cigstatCurrent raceH:cigstatCurrent  raceA:cigstatFormer  raceB:cigstatFormer  raceH:cigstatFormer
								#            1.1921324           -0.9234152            0.3062080            0.1358787           -0.6912897            0.1428171

								mycoef2=tt2[grep(paste("race",rc,sep=""),names(tt2))]
								# > mycoef2
								# raceB:cigstatCurrent  raceB:cigstatFormer
								#           -0.9234152           -0.6912897
								rc2=paste("race",rc,sep="")

								pst = paste(rep(rc2,2), c("cigstatFormer", "cigstatCurrent"),sep=":")
								pst
								#[1] "raceB:cigstatFormer"  "raceB:cigstatCurrent"

								smk.race.ave = sum(   mycoef2[pst]  * tb.smk[c("Former","Current")]   )
								# >
								# > smk.race.ave
								# [1] -0.5916237
								# > mycoef2[pst]
								#  raceB:cigstatFormer raceB:cigstatCurrent
								#           -0.6912897           -0.9234152
								# > tb.smk[c("Former","Current")]
								#    Former   Current
								# 0.3402489 0.3859727

							}#end of rc!W




					}#end of if(  length(grep("raceA:cigstatCurrent",names(mycoef)))   > 0)


					########### (5) average Interaction effect (edu * cigstat) #####


					edu.smk.ave = NULL

					tb.joint = tm$tb.joint

					# 	> sum(tb.joint)
					# [1] 1

					tt=mycoef[grep(c("edu"), names(mycoef))]
					mycoef3=tt[grep("cigstat", names(tt))	]
					# > mycoe3
					# educollege:cigstatCurrent edupostcol:cigstatCurrent  educollege:cigstatFormer  edupostcol:cigstatFormer
					#                0.42260270                0.88265940                0.01160008                0.23711154

					#### ok, I need to 2x2 product for this #######

					pst2=paste(rep(rc, 2), c("college","postcol"),sep="-")

					xx = tb.joint[pst2,c("Former","Current")]
					#               Former    Current
					# B-college 0.01741316 0.01815824
					# B-postcol 0.02451589 0.01348898

					tnames=c("educollege:cigstatFormer",  "edupostcol:cigstatFormer", "educollege:cigstatCurrent", "edupostcol:cigstatCurrent")
					mycoef3[tnames]
					# educollege:cigstatFormer  edupostcol:cigstatFormer educollege:cigstatCurrent edupostcol:cigstatCurrent
					#                0.01160008                0.23711154                0.42260270                0.88265940
					# >

					# 	educollege:cigstatFormer  edupostcol:cigstatFormer educollege:cigstatCurrent edupostcol:cigstatCurrent
					#                   -0.0446                    0.0962                    0.3876                    1.0413
					# >				# >
					mycoef3b=matrix(mycoef3[tnames], byrow=T, ncol=2)
					#            [,1]      [,2]
					# [1,] 0.01160008 0.2371115
					# [2,] 0.42260270 0.8826594
					#x
					#               Former    Current
					# B-college 0.01741316 0.01815824
					# B-postcol 0.02451589 0.01348898

					edu.smk.ave = sum(xx*mycoef3b)
					# > edu.smk.ave
					# [1] 0.02677417

					# > edu.smk.ave
					# [1] 0.00806


					if(i==1){  ## do once! this doesnt vary by race #####


								############### (6) SPLINES average cigyears effect (at age = 50) #######################################


								ave.cigyear = nsmat = NULL
								#  mycoef
								#               (Intercept)                     raceA                     raceB                     raceH                educollege
								#               28.93672095               -2.31458530                1.00499687               -0.21642658               -0.82377975
								#                edupostcol          ns(age, df = 4)1          ns(age, df = 4)2          ns(age, df = 4)3          ns(age, df = 4)4
								#               -1.20668184               -0.92561049               -1.49892646               -2.22674219               -1.98275680
								#            cigstatCurrent             cigstatFormer          ns(cigyears, 2)1          ns(cigyears, 2)2            ns(cigday, 2)1
								#               -2.87579661               -1.02453731                1.67742464               -0.21445874                2.50800835


								#lm.bmi= lmfull2b
								# lm(formula = bmi ~ race + edu + ns(age, df = 4) + cigstat * race +
								#     cigstat * edu + ns(pky, 2) + ns(cigyears, 2) + ns(cigday,
								#     2), data = MYDATA)

								newdata=cigyears50.mean
								newdata
								#[1] 1.23    # only 1.23 years because this includes all non-smokers --> got from SHG output
								varname="cigyears"

								### nsmat ##

								if(Gender=="M") nsmat = ns(MYDATA[,varname], df=2)
								if(Gender=="F") nsmat = ns(MYDATA[,varname], df=1)



								### coefficient ##

								tt=mycoef[grep("ns",names(mycoef))]
								# tt
								# ns(age, df = 4)1 ns(age, df = 4)2 ns(age, df = 4)3 ns(age, df = 4)4 ns(cigyears, 2)1 ns(cigyears, 2)2   ns(cigday, 2)1   ns(cigday, 2)2
								#       -0.9256105       -1.4989265       -2.2267422       -1.9827568        1.6774246       -0.2144587        2.5080084        2.3820083
								myCOEF=tt[grep(varname, names(tt))]; myCOEF
								# ns(cigyears, 2)1 ns(cigyears, 2)2
								#        1.6774246       -0.2144587

								ave.cigyear = getPredict.ns(newdata,nsmat, myCOEF)
								ave.cigyear
								#[1] 0.06825685


								############### (7) average cigday (cig per day) effect (at age = 50) #######################################

								ave.cigday = nsmat = NULL
								# CPD.50.mean = 6.257271  # from SHG
								# cigyears50.mean=1.23
								#               (Intercept)                     raceA                     raceB                     raceH                educollege
								#               28.93672095               -2.31458530                1.00499687               -0.21642658               -0.82377975
								#                edupostcol          ns(age, df = 4)1          ns(age, df = 4)2          ns(age, df = 4)3          ns(age, df = 4)4
								#               -1.20668184               -0.92561049               -1.49892646               -2.22674219               -1.98275680
								#            cigstatCurrent             cigstatFormer          ns(cigyears, 2)1          ns(cigyears, 2)2            ns(cigday, 2)1
								#               -2.87579661               -1.02453731                1.67742464               -0.21445874                2.50800835
								#            ns(cigday, 2)2      raceA:cigstatCurrent      raceB:cigstatCurrent      raceH:cigstatCurrent       raceA:cigstatFormer
								#                2.38200835                1.19213242               -0.92341518                0.30620802                0.13587868
								#       raceB:cigstatFormer       raceH:cigstatFormer educollege:cigstatCurrent edupostcol:cigstatCurrent  educollege:cigstatFormer
								#               -0.69128966                0.14281709                0.42260270                0.88265940                0.01160008
								#  edupostcol:cigstatFormer
								#                0.23711154


								newdata=CPD.50.mean ; newdata
								#6.25
								varname="cigday"

								### nsmat ##

								if(Gender=="M") nsmat = ns(MYDATA[,varname], df=2)
								if(Gender=="F") nsmat = ns(MYDATA[,varname], df=1)
								# > nsmat[1:3,]
								#              1          2
								# [1,] 0.0000000 0.00000000
								# [2,] 0.5502993 0.07205596
								# [3,] 0.5502993 0.07205596

										# > summary(lm.bmi)
										# Call:
										# lm(formula = formula(lmfull2b), data = MYDATA2)
										#
										# Residuals:
										#      Min       1Q   Median       3Q      Max
										# -13.2009  -2.6928  -0.5225   2.1100  28.3974
										#
										# Coefficients:
										#                           Estimate Std. Error t value Pr(>|t|)
										# (Intercept)               28.93672    0.48296  59.915  < 2e-16 ***
										# raceA                     -2.31459    0.16375 -14.135  < 2e-16 ***
										# raceB                      1.00500    0.19380   5.186 2.16e-07 ***
										# raceH                     -0.21643    0.25632  -0.844  0.39847
										# educollege                -0.82378    0.09130  -9.022  < 2e-16 ***
										# edupostcol                -1.20668    0.08109 -14.880  < 2e-16 ***
										# ns(age, df = 4)1          -0.92561    0.43696  -2.118  0.03416 *
										# ns(age, df = 4)2          -1.49893    0.32470  -4.616 3.92e-06 ***
										# ns(age, df = 4)3          -2.22674    1.01632  -2.191  0.02846 *
										# ns(age, df = 4)4          -1.98276    0.18710 -10.597  < 2e-16 ***
										# cigstatCurrent            -2.87580    0.17130 -16.788  < 2e-16 ***
										# cigstatFormer             -1.02454    0.14733  -6.954 3.61e-12 ***
										# ns(cigyears, 2)1           1.67742    0.22342   7.508 6.14e-14 ***
										# ns(cigyears, 2)2          -0.21446    0.18769  -1.143  0.25321
										# ns(cigday, 2)1             2.50801    0.24500  10.237  < 2e-16 ***
										# ns(cigday, 2)2             2.38201    0.23906   9.964  < 2e-16 ***
								### coefficient ##

								tt=mycoef[grep("ns",names(mycoef))]
								# tt
								# ns(age, df = 4)1 ns(age, df = 4)2 ns(age, df = 4)3 ns(age, df = 4)4 ns(cigyears, 2)1 ns(cigyears, 2)2   ns(cigday, 2)1   ns(cigday, 2)2
								#       -0.9256105       -1.4989265       -2.2267422       -1.9827568        1.6774246       -0.2144587        2.5080084        2.3820083
								myCOEF=tt[grep(varname, names(tt))]; myCOEF
								# ns(cigday, 2)1 ns(cigday, 2)2
								#       2.508008       2.382008

								ave.cigday = getPredict.ns(newdata,nsmat, myCOEF)
								ave.cigday
								#[1] 0.14
								#[1] 0.202



								############### (8) age effect at age=50 #######################################

								ave.age =NULL

								newdata=50
								#[1] 1.23    # only 1.23 years because this includes all non-smokers --> got from SHG output
								varname="age"

								### nsmat ##

								if(Gender=="M") nsmat = ns(MYDATA[,varname], df=4)
								if(Gender=="F") nsmat = ns(MYDATA[,varname], df=3)

										nsmat[1:3,]
										#              1           2         3           4
										# [1,] 0.2895928  0.54594036 0.1913410 -0.02687407
										# [2,] 0.7411038  0.05063192 0.1416010 -0.08765777
										#
								### coefficient ##

								tt=mycoef[grep("ns",names(mycoef))]
								# tt
								# ns(age, df = 4)1 ns(age, df = 4)2 ns(age, df = 4)3 ns(age, df = 4)4 ns(cigyears, 2)1 ns(cigyears, 2)2   ns(cigday, 2)1   ns(cigday, 2)2
								#       -0.9256105       -1.4989265       -2.2267422       -1.9827568        1.6774246       -0.2144587        2.5080084        2.3820083
								myCOEF=tt[grep(varname, names(tt))]; myCOEF
									# ns(age, df = 4)1 ns(age, df = 4)2 ns(age, df = 4)3 ns(age, df = 4)4
									#       -0.9256105       -1.4989265       -2.2267422       -1.9827568

								ave.age = getPredict.ns(newdata,nsmat, myCOEF)
								ave.age

								#[1] -0.04388832

					}#3nd of i==1

					########## sum up all effects ######

					aver = base0  + race.eff + ave.age + edu.ave + smk.ave + (smk.race.ave + edu.smk.ave) + (ave.cigyear + ave.cigday)
 					aver


					if(i==1) bmis = (aver)
					if(i>1) bmis = c(bmis,aver)


								############### experiment for natural cubic splines and prediction ####

								doThis=F
								if(doThis==T){

									lm0=lm(bmi~ns(age,4),data=MYDATA)
									summary(lm0)
									# Coefficients:
									#             Estimate Std. Error t value Pr(>|t|)
									# (Intercept)  28.2864     0.4935  57.314  < 2e-16 ***
									# ns(age, 4)1  -0.6207     0.4491  -1.382 0.166992
									# ns(age, 4)2  -1.2386     0.3333  -3.716 0.000203 ***
									# ns(age, 4)3  -1.7591     1.0448  -1.684 0.092256 .
									# ns(age, 4)4  -1.7673     0.1907  -9.267  < 2e-16 ***

									cf=summary(lm0)$coef[,1]
									# (Intercept) ns(age, 4)1 ns(age, 4)2 ns(age, 4)3 ns(age, 4)4
									#  28.2864278  -0.6206856  -1.2385982  -1.7591171  -1.7673331


									xx=ns(MYDATA$age,4)
									#               1           2         3           4
									#  [1,] 0.28959276  0.54594036 0.1913410 -0.02687407
									#  [2,] 0.74110385  0.05063192 0.1416010 -0.08765777
									#  [3,] 0.24311491 -0.18506497 0.4857955 -0.30073057
									#  [4,] 0.16286800 -0.18778578 0.4929377 -0.30515190
									#  [5,] 0.16286800 -0.18778578 0.4929377 -0.30515190
									#  [6,] 0.47011340 -0.14245067 0.3782222 -0.23413757

									# > lm0$model[1:10,]
									#         bmi ns(age, 4).1 ns(age, 4).2 ns(age, 4).3 ns(age, 4).4
									# 1  25.78094   0.28959276   0.54594036   0.19134095  -0.02687407
									# 2  25.71645   0.74110385   0.05063192   0.14160101  -0.08765777
									# 4  23.54244   0.24311491  -0.18506497   0.48579553  -0.30073057
									# 5  32.06407   0.16286800  -0.18778578   0.49293769  -0.30515190

									### intercept adding ####
									xx2=cbind(rep(1,nrow(xx)), xx)

									tt=xx2 %*% cf
									tt[1:10]
									#  [1] 27.14139 27.66955 28.04167 28.09010 28.09010 27.91954 26.76791 27.14139 26.68360 28.09010
									lm0$fitted[1:10]
									#        1        2        4        5        6        7       10       11       12       13
									# 27.14139 27.66955 28.04167 28.09010 28.09010 27.91954 26.76791 27.14139 26.68360 28.09010


									##### prediction ###########
									newdat = 61

									newbs = predict(xx, newdat)
									# > newbs
									#              1           2         3         4
									# [1,] 0.6930618 -0.03478022 0.2071069 -0.128209


									sum(c(1,newbs) * cf)
									#[1] 27.7616


								}#3nd of



			}#end of for(i in 1:length(races)){


			names(bmis)=races; bmis
			# > bmis
			#        W        B        H        A
			# 28.90285 29.08376 28.85288 26.26955


			bmis


		}#3nd of getMeanBMI.each Race

# --------------------------------------------
# USED TO BE HERE - BUT NOW SEPERATE FILE
###  myReformatSHGdat - renamed to reformatSHG
# --------------------------------------------

######## 5/2/2017: incorporating female

myGetCOPDProb2 <- function(x, mycoef, ref.race, ref.edu, ref.fh, ref.bmi.mean.55, ref.smk, ref.pky.mean.55, ref.cpd.mean.55, ref.cigyear.mean.55, Gender, MYDATA){
			#x is age
			# > x=AGE
			# > x
			# [1] 55

			base0 = mycoef[1]

			mycoef
			#    (Intercept)             fh    ns(age, 2)1    ns(age, 2)2     educollege     edupostcol          raceA          raceB          raceH    ns(bmi, 3)1
			#    -2.40033124     0.17085227     0.61983877     0.67271579    -0.26755047    -0.25386091    -0.38101029     0.18288279    -0.25648075    -0.54984713
			#    ns(bmi, 3)2    ns(bmi, 3)3 cigstatCurrent  cigstatFormer    ns(pky, 2)1    ns(pky, 2)2         cigday
			#    -1.80531353     1.05954230     0.12405182     0.20750419     6.41614289     3.15551388    -0.02525834

			# (Intercept)          age   educollege   edupostcol        raceA        raceB        raceH  ns(bmi, 3)1  ns(bmi, 3)2  ns(bmi, 3)3     cigyears
			# -2.809877361  0.008341419 -0.332164998 -0.122890946 -0.273522164  0.189874305  0.039115084  0.343033939 -0.259201973  1.774924396  0.011828153
			#          pky       cigday
			#  0.025526378 -0.018510667



			################ (0) age effect ################################

			myCOEF0 = tt1=mycoef[grep("age",names(mycoef))]; myCOEF0
			# ns(age, 3)1 ns(age, 3)2 ns(age, 3)3
			#   0.7739137   0.4754907   0.7195612

			# ns(age, 2)1 ns(age, 2)2
			#  0.05802336 -0.17318622

			if(Gender=="M") {

				nsmat0 = ns(MYDATA[,"age"], 4)  # df=2 according to the model

				# > nsmat0[1:3,]
				#               1         2          3
				# [1,]  0.5520039 0.3504519 -0.0337378
				# [2,]  0.2610429 0.5127676 -0.3033939
				# [3,] -0.1009771 0.5321631 -0.3192979
				# >
				# > ref.pky.mean.55
				# [1] 17.61

				newdata = x # age 55

				ns.new = predict(nsmat0, newdata)
				#ns.new
				#              1         2          3
				#[1,] -0.1302351 0.4435947 -0.2661568

				ave.age = sum(ns.new * myCOEF0)

			}#end of

			if(Gender=="F"){

					newdata=x
					ave.age =  newdata * mycoef[grep("age",names(mycoef))]

			}#end of

			ave.age

			############### (1) average over race ##################################
			## coefficient is Hispanic vs. non-hispanic
			ave.race = sum( ref.race[c("B","H","A")] * mycoef[c("raceB","raceH","raceA")] ); ave.race
			#[1] -0.1215088

			############### (2) average over education ##################################
			## coefficient is Hispanic vs. non-hispanic
			ave.edu = sum( ref.edu[c("college","postcol")] * mycoef[c("educollege","edupostcol")] ); ave.edu
			#[1] -0.1215088
			# > ref.edu
			#    high college postcol
			#    0.78    0.15    0.07


			############### (3) average over cigstat #################################
			## coefficient is Hispanic vs. non-hispanic

			if(Gender=="F") ave.smk = 0
			if(Gender=="M") ave.smk = sum( ref.smk[c("Former","Current")] * mycoef[c("cigstatFormer","cigstatCurrent")] ); ave.smk
			#[1] 0.1115336
			#ref.smk = c(0.37, 0.40, 0.23)
			ave.smk

			################ (4) average over BMI ############################


			myCOEF = tt1=mycoef[grep("bmi",names(mycoef))]
			# ns(bmi, 2)1 ns(bmi, 2)2
			#   -1.110921    1.541696

			if(Gender=="M") nsmat = ns(MYDATA[,"bmi"], 3)
			if(Gender=="F") nsmat = ns(MYDATA[,"bmi"], 3)

			# > ref.pky.mean.55
			# [1] 17.61
			newdata = ref.bmi.mean.55
			#newdata = ref.pky.mean.55

			ns.new = predict(nsmat, newdata)
			#ns.new
			#              1         2          3
			#[1,] -0.1302351 0.4435947 -0.2661568

			ave.bmi = sum(ns.new * myCOEF)


			#ave.bmi = getPredict.ns(newdata,nsmat, myCOEF)
			ave.bmi
			#[1] [1] -1.467057


		################ (5) average over pack-years ############################



			if(Gender=="M") {

				myCOEF = tt1=mycoef[grep("pky",names(mycoef))]
				nsmat = ns(MYDATA[,"pky"], 2)

				# > ref.pky.mean.55
				# [1] 17.61
				newdata = ref.pky.mean.55
				#newdata = ref.pky.mean.55
				ns.new = predict(nsmat, newdata)
				#ns.new
				#              1         2          3
				#[1,] -0.1302351 0.4435947 -0.2661568
				ave.pky = sum(ns.new * myCOEF)

			}#end of

			if(Gender=="F"){

			  	ave.pky = sum(ref.pky.mean.55 * mycoef[grep("pky",names(mycoef))])

			}#end of

			ave.pky
			#[1] 0.713153


	   ############# (6) cig-years #####################################


	   if(Gender=="M"){ ave.cy=0 }
	   if(Gender=="F"){


	   			ave.cy = sum(ref.cigyear.mean.55 * mycoef[grep("cigday",names(mycoef))])
	   }

		ave.cy

# ref.cigyear.mean.55 = 17.09
# ref.cpd.mean.55 = 5.088254


		################ (5) cigday  ############################


			myCOEF = tt1=mycoef[grep("cigday",names(mycoef))]

			ave.cpd = sum( ref.cpd.mean.55 * myCOEF ); ave.cpd
			#[1] -0.1285208


	  ################ (6) family history #######
		# > ref.fh
		# [1] 10.9

		if(Gender=="F") ave.fh=0

		if(Gender=="M"){

			myCOEF = tt1=mycoef[grep("fh",names(mycoef))]

			ave.fh = sum( (ref.fh/100) * myCOEF ); ave.fh
			#[1] 0.0186229

			# 	> mycoef
			#    (Intercept)             fh    ns(age, 2)1    ns(age, 2)2     educollege     edupostcol          raceA          raceB          raceH    ns(bmi, 3)1
			#    -2.40033124     0.17085227     0.61983877     0.67271579    -0.26755047    -0.25386091    -0.38101029     0.18288279    -0.25648075    -0.54984713
			#    ns(bmi, 3)2    ns(bmi, 3)3 cigstatCurrent  cigstatFormer    ns(pky, 2)1    ns(pky, 2)2         cigday
			#    -1.80531353     1.05954230     0.12405182     0.20750419     6.41614289     3.15551388    -0.02525834

	     }#END OF


		############## (4) sum it up #######################

		ans = as.numeric( base0 + ave.fh + ave.age + ave.race + ave.edu + ave.smk + ave.bmi + ave.pky + ave.cpd + ave.cy)

		ans2 = inv.logit(ans);
		ans2
		#[1] 0.01789144



	}#end of

myGetCOPDProb <- function(x, mycoef, ref.race, ref.edu, ref.fh, ref.bmi.mean.55, ref.smk, ref.pky.mean.55, ref.cpd.mean.55, Gender, MYDATA){
			#x is age
			# > x=AGE
			# > x
			# [1] 55

			base0 = mycoef[1]

			mycoef
			#    (Intercept)             fh    ns(age, 2)1    ns(age, 2)2     educollege     edupostcol          raceA          raceB          raceH    ns(bmi, 3)1
			#    -2.40033124     0.17085227     0.61983877     0.67271579    -0.26755047    -0.25386091    -0.38101029     0.18288279    -0.25648075    -0.54984713
			#    ns(bmi, 3)2    ns(bmi, 3)3 cigstatCurrent  cigstatFormer    ns(pky, 2)1    ns(pky, 2)2         cigday
			#    -1.80531353     1.05954230     0.12405182     0.20750419     6.41614289     3.15551388    -0.02525834


			################ (0) age effect ################################

			myCOEF0 = tt1=mycoef[grep("age",names(mycoef))]; myCOEF0
			# ns(age, 3)1 ns(age, 3)2 ns(age, 3)3
			#   0.7739137   0.4754907   0.7195612

			# ns(age, 2)1 ns(age, 2)2
			#  0.05802336 -0.17318622

	if(Gender=="M") nsmat0 = ns(MYDATA[,"age"], 4)  # df=2 according to the model

			# > nsmat0[1:3,]
			#               1         2          3
			# [1,]  0.5520039 0.3504519 -0.0337378
			# [2,]  0.2610429 0.5127676 -0.3033939
			# [3,] -0.1009771 0.5321631 -0.3192979
			# >
			# > ref.pky.mean.55
			# [1] 17.61

			newdata = x # age 55

			ns.new = predict(nsmat0, newdata)
			#ns.new
			#              1         2          3
			#[1,] -0.1302351 0.4435947 -0.2661568

			ave.age = sum(ns.new * myCOEF0)


			############### (1) average over race ##################################
			## coefficient is Hispanic vs. non-hispanic
			ave.race = sum( ref.race[c("B","H","A")] * mycoef[c("raceB","raceH","raceA")] ); ave.race
			#[1] -0.1215088

			############### (2) average over education ##################################
			## coefficient is Hispanic vs. non-hispanic
			ave.edu = sum( ref.edu[c("college","postcol")] * mycoef[c("educollege","edupostcol")] ); ave.edu
			#[1] -0.1215088
			# > ref.edu
			#    high college postcol
			#    0.78    0.15    0.07


			############### (3) average over cigstat #################################
			## coefficient is Hispanic vs. non-hispanic
			ave.smk = sum( ref.smk[c("Former","Current")] * mycoef[c("cigstatFormer","cigstatCurrent")] ); ave.smk
			#[1] 0.1115336
			#ref.smk = c(0.37, 0.40, 0.23)

			################ (4) average over BMI ############################


			myCOEF = tt1=mycoef[grep("bmi",names(mycoef))]
			# ns(bmi, 2)1 ns(bmi, 2)2
			#   -1.110921    1.541696

			if(Gender=="M") nsmat = ns(MYDATA[,"bmi"], 3)

			# > ref.pky.mean.55
			# [1] 17.61
			newdata = ref.bmi.mean.55
			#newdata = ref.pky.mean.55

			ns.new = predict(nsmat, newdata)
			#ns.new
			#              1         2          3
			#[1,] -0.1302351 0.4435947 -0.2661568

			ave.bmi = sum(ns.new * myCOEF)


			#ave.bmi = getPredict.ns(newdata,nsmat, myCOEF)
			ave.bmi
			#[1] [1] -1.467057


		################ (5) average over pack-years ############################

			myCOEF = tt1=mycoef[grep("pky",names(mycoef))]

			if(Gender=="M") nsmat = ns(MYDATA[,"pky"], 2)

			# > ref.pky.mean.55
			# [1] 17.61
			newdata = ref.pky.mean.55
			#newdata = ref.pky.mean.55
			ns.new = predict(nsmat, newdata)
			#ns.new
			#              1         2          3
			#[1,] -0.1302351 0.4435947 -0.2661568
			ave.pky = sum(ns.new * myCOEF)
			ave.pky
			#[1] 0.713153


# ref.cigyear.mean.55 = 17.09
# ref.cpd.mean.55 = 5.088254


		################ (5) cigday over cigyears ############################


			myCOEF = tt1=mycoef[grep("cigday",names(mycoef))]

			ave.cpd = sum( ref.cpd.mean.55 * myCOEF ); ave.cpd
			#[1] -0.1285208


	  ################ (6) family history #######
		# > ref.fh
		# [1] 10.9



			myCOEF = tt1=mycoef[grep("fh",names(mycoef))]

			ave.fh = sum( (ref.fh/100) * myCOEF ); ave.fh
			#[1] 0.0186229

			# 	> mycoef
			#    (Intercept)             fh    ns(age, 2)1    ns(age, 2)2     educollege     edupostcol          raceA          raceB          raceH    ns(bmi, 3)1
			#    -2.40033124     0.17085227     0.61983877     0.67271579    -0.26755047    -0.25386091    -0.38101029     0.18288279    -0.25648075    -0.54984713
			#    ns(bmi, 3)2    ns(bmi, 3)3 cigstatCurrent  cigstatFormer    ns(pky, 2)1    ns(pky, 2)2         cigday
			#    -1.80531353     1.05954230     0.12405182     0.20750419     6.41614289     3.15551388    -0.02525834


			############## (4) sum it up #######################

			ans = as.numeric( base0 + ave.fh + ave.age + ave.race + ave.edu + ave.smk + ave.bmi + ave.pky + ave.cpd)

			ans2 = inv.logit(ans);
			ans2
			#[1] 0.01789144



	}#end of



#### 5/2/2017 incorporate female results ###

myGetPHProb2 <- function(x, mycoef, ref.race, ref.edu, ref.smk, ref.bmi.mean.55, ref.pky.mean.55, Gender, MYDATA){
			#x is age
			# > x=AGE
			# > x
			# [1] 55

			base0 = mycoef[1]

			mycoef
			# (Intercept) ns(age, 3)1 ns(age, 3)2 ns(age, 3)3       raceA       raceB       raceH ns(bmi, 2)1 ns(bmi, 2)2
			# -3.49454619  0.77391374  0.47549066  0.71956124 -1.13276692 -0.51543523 -0.16658612 -1.11092092  1.54169648
			#         pky
			#  0.00543436

			### female
			#    (Intercept)    ns(age, 2)1    ns(age, 2)2          raceA          raceB          raceH     educollege     edupostcol cigstatCurrent
			#  -2.9344948162   0.6199797377   0.7852675752  -0.4129644378  -0.3181978144   0.1164215527  -0.0006229374   0.1478125267   0.2199251752
			#  cigstatFormer            pky
			#   0.1771213575   0.0022873314


			################ (0) age effect ################################

			myCOEF0 = tt1=mycoef[grep("age",names(mycoef))]; myCOEF0
			# ns(age, 3)1 ns(age, 3)2 ns(age, 3)3
			#   0.7739137   0.4754907   0.7195612

			# ns(age, 2)1 ns(age, 2)2
			#  0.05802336 -0.17318622

			## both gender ###
			nsmat0 = ns(MYDATA[,"age"], 2)  # df=2 according to the model

			# > nsmat0[1:3,]
			#               1         2          3
			# [1,]  0.5520039 0.3504519 -0.0337378
			# [2,]  0.2610429 0.5127676 -0.3033939
			# [3,] -0.1009771 0.5321631 -0.3192979
			# >
			# > ref.pky.mean.55
			# [1] 17.61

			newdata = x # age 50

			ns.new = predict(nsmat0, newdata)
			#ns.new
			#              1         2          3
			#[1,] -0.1302351 0.4435947 -0.2661568

			ave.age = sum(ns.new * myCOEF0)


			#age.eff = mycoef["age"]*x
			#age.eff = mycoef["age"]*AGE
			#age.eff
			#-0.3622469

			############### (1) average over race ##################################
			## coefficient is Hispanic vs. non-hispanic
			ave.race = sum( ref.race[c("B","H","A")] * mycoef[c("raceB","raceH","raceA")] ); ave.race
			#[1] -0.1215088



			################ (2) education effect (female)

			if(Gender=="M") ave.edu=0

			if(Gender=="F"){

					ave.edu = sum( ref.edu[c("college", "postcol")] * mycoef[c("educollege", "edupostcol")] ); ave.edu
			}

			ave.edu

			################ (3) average over BMI ############################

			ave.bmi=0

			if(Gender=="M"){

					myCOEF = tt1=mycoef[grep("bmi",names(mycoef))]
					# ns(bmi, 2)1 ns(bmi, 2)2
					#   -1.110921    1.541696

					nsmat = ns(MYDATA[,"bmi"], 2)


					## I was here ##
					#ref.bmi.mean.55

					# > ref.pky.mean.55
					# [1] 17.61
					newdata = ref.bmi.mean.55
					#newdata = ref.pky.mean.55

					ns.new = predict(nsmat, newdata)
					#ns.new
					#              1         2          3
					#[1,] -0.1302351 0.4435947 -0.2661568

					ave.bmi = sum(ns.new * myCOEF)

			}#end of


			#ave.bmi = getPredict.ns(newdata,nsmat, myCOEF)
			ave.bmi
			#[1] -0.7823369


		################ (3) average over pack-years ############################


			myCOEF = tt1=mycoef[grep("pky",names(mycoef))]
			#        pky
			# 0.00543436

			ave.pky = sum( ref.pky.mean.55 * myCOEF ); ave.pky
			#[1] 0.09569908


			######### (4) cigstat ####

			ave.cigstat = 0

			if(Gender=="F"){

				ave.cigstat = sum( ref.smk[c("Former", "Current")] * mycoef[c("cigstatFormer", "cigstatCurrent")] ); ave.cigstat


			}#end of


			ave.cigstat

			#### average over smoking ##
			# > ref.pky
			#  lst10  10_30  30_60 60_100  gt100
			#   0.51   0.21   0.21   0.07   0.00

			## inner product ##

			#tt1=ref.pky[-1];  tt1
			#tt2=mycoef[paste("pky.", names(ref.pky[-1]),sep="")]  ; tt2
			# > tt1
			#  10_30  30_60 60_100  gt100
			#   0.21   0.21   0.07   0.00
			# > tt2
			#  pky.10_30  pky.30_60 pky.60_100  pky.gt100
			#  0.1959373  0.2335248  0.4192692  0.4597977

			#ave.smk = sum(tt1*tt2)
			#[1] 0.1195359


			############## (4) sum it up #######################

			ans = as.numeric( base0 + ave.age + ave.race + +ave.edu + ave.bmi + ave.pky +ave.cigstat)

			ans2 = inv.logit(ans);
			ans2
			#[1] 0.01232073


	}#end of

myGetPHProb <- function(x, mycoef, ref.race,ref.bmi.mean.55, ref.pky.mean.55, Gender, MYDATA){
			#x is age
			# > x=AGE
			# > x
			# [1] 55

			base0 = mycoef[1]

			mycoef
			# (Intercept) ns(age, 3)1 ns(age, 3)2 ns(age, 3)3       raceA       raceB       raceH ns(bmi, 2)1 ns(bmi, 2)2
			# -3.49454619  0.77391374  0.47549066  0.71956124 -1.13276692 -0.51543523 -0.16658612 -1.11092092  1.54169648
			#         pky
			#  0.00543436

			#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi
			# -2.518529315  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042
			#  ns(pky, 2)1  ns(pky, 2)2
			#  1.030344727  0.852142491

			################ (0) age effect ################################

			myCOEF0 = tt1=mycoef[grep("age",names(mycoef))]; myCOEF0
			# ns(age, 3)1 ns(age, 3)2 ns(age, 3)3
			#   0.7739137   0.4754907   0.7195612

			# ns(age, 2)1 ns(age, 2)2
			#  0.05802336 -0.17318622

	if(Gender=="M") nsmat0 = ns(MYDATA[,"age"], 2)  # df=2 according to the model

			# > nsmat0[1:3,]
			#               1         2          3
			# [1,]  0.5520039 0.3504519 -0.0337378
			# [2,]  0.2610429 0.5127676 -0.3033939
			# [3,] -0.1009771 0.5321631 -0.3192979
			# >
			# > ref.pky.mean.55
			# [1] 17.61

			newdata = x # age 50

			ns.new = predict(nsmat0, newdata)
			#ns.new
			#              1         2          3
			#[1,] -0.1302351 0.4435947 -0.2661568

			ave.age = sum(ns.new * myCOEF0)


			#age.eff = mycoef["age"]*x
			#age.eff = mycoef["age"]*AGE
			#age.eff
			#-0.3622469

			############### (1) average over race ##################################
			## coefficient is Hispanic vs. non-hispanic
			ave.race = sum( ref.race[c("B","H","A")] * mycoef[c("raceB","raceH","raceA")] ); ave.race
			#[1] -0.1215088


			################ (3) average over BMI ############################


			myCOEF = tt1=mycoef[grep("bmi",names(mycoef))]
			# ns(bmi, 2)1 ns(bmi, 2)2
			#   -1.110921    1.541696

			if(Gender=="M") nsmat = ns(MYDATA[,"bmi"], 2)


			## I was here ##
			#ref.bmi.mean.55

			# > ref.pky.mean.55
			# [1] 17.61
			newdata = ref.bmi.mean.55
			#newdata = ref.pky.mean.55

			ns.new = predict(nsmat, newdata)
			#ns.new
			#              1         2          3
			#[1,] -0.1302351 0.4435947 -0.2661568

			ave.bmi = sum(ns.new * myCOEF)


			#ave.bmi = getPredict.ns(newdata,nsmat, myCOEF)
			ave.bmi
			#[1] -0.7823369


		################ (3) average over pack-years ############################


			myCOEF = tt1=mycoef[grep("pky",names(mycoef))]
			#        pky
			# 0.00543436

			ave.pky = sum( ref.pky.mean.55 * myCOEF ); ave.pky
			#[1] 0.09569908



			#### average over smoking ##
			# > ref.pky
			#  lst10  10_30  30_60 60_100  gt100
			#   0.51   0.21   0.21   0.07   0.00

			## inner product ##

			#tt1=ref.pky[-1];  tt1
			#tt2=mycoef[paste("pky.", names(ref.pky[-1]),sep="")]  ; tt2
			# > tt1
			#  10_30  30_60 60_100  gt100
			#   0.21   0.21   0.07   0.00
			# > tt2
			#  pky.10_30  pky.30_60 pky.60_100  pky.gt100
			#  0.1959373  0.2335248  0.4192692  0.4597977

			#ave.smk = sum(tt1*tt2)
			#[1] 0.1195359


			############## (4) sum it up #######################

			ans = as.numeric( base0 + ave.age + ave.race + ave.bmi + ave.pky)

			ans2 = inv.logit(ans);
			ans2
			#[1] 0.01232073


	}#end of


			myGetFHProb <- function(x, mycoef, ref.edu, ref.race,ref.pky.mean.55, Gender, MYDATA){
						#x is age
						# > x=AGE
						# > x
						# [1] 55

						base0 = mycoef[1]

						mycoef
						#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi
						# -2.518529315  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042
						#  ns(pky, 2)1  ns(pky, 2)2
						#  1.030344727  0.852142491

						################ (0) age effect ################################

						myCOEF0 = tt1=mycoef[grep("age",names(mycoef))]; myCOEF0
						# ns(age, 2)1 ns(age, 2)2
						#  0.05802336 -0.17318622

						if(Gender=="M") nsmat0 = ns(MYDATA[,"age"], 2)
						# > nsmat0[1:3,]
						#              1           2
						# [1,] 0.5561763  0.05267204
						# [2,] 0.5662628 -0.21084190
						# [3,] 0.4238313 -0.24371337

						# > ref.pky.mean.55
						# [1] 17.61

					    newdata = x # age 50

						ave.age = getPredict.ns(newdata,nsmat0, myCOEF0)
						ave.age
						#[1]  0.0549219


						#age.eff = mycoef["age"]*x
						#age.eff = mycoef["age"]*AGE
						#age.eff
						#-0.3622469

						################ (1)  average over education ############################
						#ref.edu
						# > ref.edu
						#    high college postcol
						#    0.78    0.15    0.07

						## inner product for education effect ##
						ave.edu = sum( ref.edu[c("college","postcol")] * mycoef[c("educollege", "edupostcol")] ); ave.edu
						#[1] -0.02899613

						### average over race ##
						# > ref.race
						#    W    B    H    A
						# 0.76 0.10 0.08 0.05

						############### (2) average over race ##################################
						## coefficient is Hispanic vs. non-hispanic
						ave.race = sum( ref.race[c("B","H","A")] * mycoef[c("raceB","raceH","raceA")] ); ave.edu
						#[1] -0.05276912
						#ave.race
						#[1] -0.03557426


						################ (3) average over pack-years ############################


						myCOEF = tt1=mycoef[grep("pky",names(mycoef))]
						# ns(pky, 2)1 ns(pky, 2)2
						#   1.0349373   0.8565359

						if(Gender=="M") nsmat = ns(MYDATA[,"pky"], 2)

						# > ref.pky.mean.55
						# [1] 17.61

					    newdata = ref.pky.mean.55

						ave.pky = getPredict.ns(newdata,nsmat, myCOEF)
						ave.pky
						#[1] 0.0920093


						#### average over smoking ##
						# > ref.pky
						#  lst10  10_30  30_60 60_100  gt100
						#   0.51   0.21   0.21   0.07   0.00

						## inner product ##

						#tt1=ref.pky[-1];  tt1
						#tt2=mycoef[paste("pky.", names(ref.pky[-1]),sep="")]  ; tt2
						# > tt1
						#  10_30  30_60 60_100  gt100
						#   0.21   0.21   0.07   0.00
						# > tt2
						#  pky.10_30  pky.30_60 pky.60_100  pky.gt100
						#  0.1959373  0.2335248  0.4192692  0.4597977

						#ave.smk = sum(tt1*tt2)
						#[1] 0.1195359


						############## (4) sum it up #######################

						ans = as.numeric( base0 + ave.age + ave.edu + ave.race + ave.pky)

						ans2 = inv.logit(ans);
						ans2
						#[1] 0.08163258

				}#end of


			###### 4/27/2017 for female: linear effect of age ####
			# > mycoef
			#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol          bmi          pky
			# -2.153809877 -0.067902109  0.114585080 -0.240008776 -0.252735814  0.005706452  0.005957014

			myGetFHProb.F2 <- function(x, mycoef, ref.edu, ref.pky.mean.55,ref.bmi.mean.55, Gender, MYDATA){
						#x is age
						# > x=AGE
						# > x
						# [1] 55


						base0 = mycoef[1]

						mycoef
						#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol          bmi          pky
						# -2.153809877 -0.067902109  0.114585080 -0.240008776 -0.252735814  0.005706452  0.005957014


						#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi
						# -2.518529315  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042
						#  ns(pky, 2)1  ns(pky, 2)2
						#  1.030344727  0.852142491

						################ (0) age effect ################################

						#myCOEF0 = tt1=mycoef[grep("age",names(mycoef))]; myCOEF0
						# ns(age, 2)1 ns(age, 2)2
						#  0.05802336 -0.17318622

						#nsmat0 = ns(MYDATA[,"age"], 2)
						#if(Gender=="M") nsmat0 = ns(MYDATA[,"age"], 2)
						#if(Gender=="F") nsmat0 = ns(MYDATA[,"age"], 2)



						# > nsmat0[1:3,]
						#              1           2
						# [1,] 0.5561763  0.05267204
						# [2,] 0.5662628 -0.21084190
						# [3,] 0.4238313 -0.24371337

						# > ref.pky.mean.55
						# [1] 17.61

					    newdata = x # age 50

						#ave.age = getPredict.ns(newdata,nsmat0, myCOEF0)
						#ave.age
						#[1]  0.0549219


						#age.eff = mycoef["age"]*x
						#age.eff = mycoef["age"]*AGE
						#age.eff
						#-0.3622469

						ave.age = sum( newdata * mycoef[grep("age",names(mycoef))]); ave.age


						################ (1)  average over education ############################
						#ref.edu
						# > ref.edu
						#    high college postcol
						#    0.78    0.15    0.07

						## inner product for education effect ##
						ave.edu = sum( ref.edu[c("college","postcol")] * mycoef[c("educollege", "edupostcol")] ); ave.edu
						#[1] -0.02899613

						### average over race ##
						# > ref.race
						#    W    B    H    A
						# 0.76 0.10 0.08 0.05

						############### (2) average over race ##################################
						## coefficient is Hispanic vs. non-hispanic

						ave.race=0
						#ave.race = sum( ref.race[c("B","H","A")] * mycoef[c("raceB","raceH","raceA")] ); ave.edu
						#[1] -0.05276912
						#ave.race
						#[1] -0.03557426


						################ (3) average over pack-years ############################


						myCOEF = tt1=mycoef[grep("pky",names(mycoef))]
						# ns(pky, 2)1 ns(pky, 2)2
						#   1.0349373   0.8565359

						mycoef[grep("pky",names(mycoef))]


						ave.pky = sum( ref.pky.mean.55 * mycoef[grep("pky",names(mycoef))]); ave.pky



						######### average bmi ###

						ave.bmi = sum( ref.bmi.mean.55 * mycoef[grep("bmi",names(mycoef))]); ave.bmi



						############## (4) sum it up #######################

						ans = as.numeric( base0 + ave.age + ave.edu + ave.pky + ave.bmi)

						ans2 = inv.logit(ans);
						ans2
						#[1] 0.08163258

				}#end of

			myGetFHProb.F <- function(x, mycoef, ref.edu, ref.pky.mean.55,ref.bmi.mean.55, Gender, MYDATA){
						#x is age
						# > x=AGE
						# > x
						# [1] 55


						base0 = mycoef[1]

						mycoef
						#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol          bmi          pky
						# -2.153809877 -0.067902109  0.114585080 -0.240008776 -0.252735814  0.005706452  0.005957014


						#  (Intercept)  ns(age, 2)1  ns(age, 2)2   educollege   edupostcol        raceA        raceB        raceH          bmi
						# -2.518529315  0.058023363 -0.173186220 -0.156089483 -0.114427749 -0.132770683 -0.016110326 -0.555961513  0.007939042
						#  ns(pky, 2)1  ns(pky, 2)2
						#  1.030344727  0.852142491

						################ (0) age effect ################################

						myCOEF0 = tt1=mycoef[grep("age",names(mycoef))]; myCOEF0
						# ns(age, 2)1 ns(age, 2)2
						#  0.05802336 -0.17318622

						nsmat0 = ns(MYDATA[,"age"], 2)
						#if(Gender=="M") nsmat0 = ns(MYDATA[,"age"], 2)
						#if(Gender=="F") nsmat0 = ns(MYDATA[,"age"], 2)



						# > nsmat0[1:3,]
						#              1           2
						# [1,] 0.5561763  0.05267204
						# [2,] 0.5662628 -0.21084190
						# [3,] 0.4238313 -0.24371337

						# > ref.pky.mean.55
						# [1] 17.61

					    newdata = x # age 50

						ave.age = getPredict.ns(newdata,nsmat0, myCOEF0)
						ave.age
						#[1]  0.0549219


						#age.eff = mycoef["age"]*x
						#age.eff = mycoef["age"]*AGE
						#age.eff
						#-0.3622469

						################ (1)  average over education ############################
						#ref.edu
						# > ref.edu
						#    high college postcol
						#    0.78    0.15    0.07

						## inner product for education effect ##
						ave.edu = sum( ref.edu[c("college","postcol")] * mycoef[c("educollege", "edupostcol")] ); ave.edu
						#[1] -0.02899613

						### average over race ##
						# > ref.race
						#    W    B    H    A
						# 0.76 0.10 0.08 0.05

						############### (2) average over race ##################################
						## coefficient is Hispanic vs. non-hispanic

						ave.race=0
						#ave.race = sum( ref.race[c("B","H","A")] * mycoef[c("raceB","raceH","raceA")] ); ave.edu
						#[1] -0.05276912
						#ave.race
						#[1] -0.03557426


						################ (3) average over pack-years ############################


						myCOEF = tt1=mycoef[grep("pky",names(mycoef))]
						# ns(pky, 2)1 ns(pky, 2)2
						#   1.0349373   0.8565359

						mycoef[grep("pky",names(mycoef))]


						ave.pky = sum( ref.pky.mean.55 * mycoef[grep("pky",names(mycoef))]); ave.pky



						######### average bmi ###

						ave.bmi = sum( ref.bmi.mean.55 * mycoef[grep("bmi",names(mycoef))]); ave.bmi



						############## (4) sum it up #######################

						ans = as.numeric( base0 + ave.age + ave.edu + ave.pky + ave.bmi)

						ans2 = inv.logit(ans);
						ans2
						#[1] 0.08163258

				}#end of

### 10/6/2016: it does not sample enough  this is PHC only use first version for FH

mySampleMore2<- function(case, mat.prob, n.require){

			case.update = case # this will be updated with more 1's

			# >case[1:10]
			#  [1]  0  0  0  0  0 NA NA  0  1  0  --> NA died before this age

			# > mat.prob[1:3,]
			# [1] 0.09823288 0.09823288 0.06662215

			# > table(case,useNA="always")
			# case
			#     0     1  <NA>
			#  6624 19414 73962
			# > prop.table(table(case,useNA="always"))
			# case
			#       0       1    <NA>
			# 0.06624 0.19414 0.73962

			# > table(case)
			# case
			#     0     1
			#  6624 19414
			# > prop.table(table(case))
			# case
			#         0         1
			# 0.2543974 0.7456026   <---------this really does not make sense


			### (1) identify candiate to be sampled for 0 and 1 ## who did not die and current status is 0
			ix.cand = is.na(case)==F & case==0

			### (2) number of candidate for further sampling ##
			n.cand = sum(ix.cand); n.cand
			# [1] 6624
			# >
			# > n.require
			# [1] 3715

			### (3) extract the probability of these people
			mat.pr.cand = mat.prob[ix.cand,]

			n.cand
			# [1] 75158
			dim(mat.pr.cand)
			# [1] 75158     1

			## make it as matrix
			dim(mat.pr.cand)=c(length(mat.pr.cand),1)


			#### (4) sample more 0 and 1 ######

			#samp.sm <- function(x) sample(c(0,1), size=1, prob = c(1-x, x))

		samp.sm2 <- function(x) {

								ans=NULL

								if(is.na(x)==F) ans=sample(c(0,1), size=1, prob = c(1-x, x))
								if(is.na(x)==T) ans=NA

								ans
							}


			case.more=apply(mat.pr.cand, 1, samp.sm2)
			# >case.more[1:10]
			#  [1] 0 0 0 0 0 0 0 0 0 0
			sum(case.more)
			# [1] 7860

			length(case.more)
			# [1] 75158

			### (5) Identify who got new 1's ######

			who=NULL

			#### take n.require = 1090 more people #####
			if(sum(case.more) >= n.require){ # if further simulated individuals with fh=1 is larger than what we needed

					who=which(case.more==1)[1:n.require]
					# > who[1:10]
					#  [1] 14 23 24 29 49 56 61 75 81 90
					# > length(who)
					# [1] 1090
					# > n.require
					# [1] 1090

					###### (6) plug in this update status #########

					case.update[ix.cand][who]=1

			}# end of if(sum(fh.more) >= n.require){ #


			if(sum(case.more) < n.require){ # then just get all

					##### (1) take whatever sampled

					who=which(case.more==1)
					case.update[ix.cand][who]=1

					n.require2 = n.require - sum(case.more); n.require2

					kk=1
					while(TRUE){

						print(paste("first while loop i=",kk,sep=""))
						##### (2) sample more #########

						### (2) identify candiate to be sampled for 0 and 1 ## who did not die and current status is 0
						ix.cand2 = is.na(case.update)==F & case.update==0

						### (2) number of candidate for further sampling ##
						n.cand2 = sum(ix.cand2); n.cand2
						# [1] 6624
						# >
						# > n.require
						# [1] 3715

						### (3) extract the probability of these people
						mat.pr.cand2 = mat.prob[ix.cand2,]

						n.cand2
						# [1] 75158
						dim(mat.pr.cand2)
						# [1] 75158     1

						## make it as matrix
						dim(mat.pr.cand2)=c(length(mat.pr.cand2),1)

						case.more=apply(mat.pr.cand2, 1, samp.sm2)


						### quantity further required ##
						n.require.new = n.require2 - sum(case.more); n.require.new

						if(n.require.new <= 0 | (n.require.new >0 & kk >50)) { #case.more is larger


						   who=which(case.more==1)[1:n.require2]
					       case.update[ix.cand2][who]=1

					       {break}


						}

						if(n.require.new > 0 & kk <=50 ){ # case.more is small

							who=which(case.more==1)
							case.update[ix.cand2][who]=1
							n.require2=n.require.new

							print(paste("n.require.new =", n.require.new,sep=""))
						}

						kk=kk+1

					}# end of while

			}## end of if(sum(fh.more) >= n.require){ #

			###### (6) plug in this update status #########

			#case.update[ix.cand][who]=1

			#### prevalence calculation ###

			#### use different prevalence denominator ##
			N2 = sum(is.na(case)==F)  # people who did not die and still at risk

			prev.updated = sum( is.na(case.update)==F & case.update==1) / N2
			#prev.updated = sum( is.na(case.update)==F & case.update==1) / length(case.update)
			prev.updated
			#print(prev.updated)

			list(case.update=case.update, prev.update = prev.updated)


}#end of mySampleMore<- function(case, mat.prob, n.required){


mySampleMore<- function(case, mat.prob, n.require){

			case.update = case # this will be updated with more 1's

			# >case[1:10]
			#  [1]  0  0  0  0  0 NA NA  0  1  0  --> NA died before this age

			# > mat.prob[1:3,]
			# [1] 0.09823288 0.09823288 0.06662215

			# > table(case,useNA="always")
			# case
			#     0     1  <NA>
			#  6624 19414 73962
			# > prop.table(table(case,useNA="always"))
			# case
			#       0       1    <NA>
			# 0.06624 0.19414 0.73962

			# > table(case)
			# case
			#     0     1
			#  6624 19414
			# > prop.table(table(case))
			# case
			#         0         1
			# 0.2543974 0.7456026   <---------this really does not make sense


			### (1) identify candiate to be sampled for 0 and 1 ## who did not die and current status is 0
			ix.cand = is.na(case)==F & case==0

			### (2) number of candidate for further sampling ##
			n.cand = sum(ix.cand); n.cand
			# [1] 6624
			# >
			# > n.require
			# [1] 3715

			### (3) extract the probability of these people
			mat.pr.cand = mat.prob[ix.cand,]

			n.cand
			# [1] 75158
			dim(mat.pr.cand)
			# [1] 75158     1

			## make it as matrix
			dim(mat.pr.cand)=c(length(mat.pr.cand),1)


			#### (4) sample more 0 and 1 ######

			samp.sm <- function(x) sample(c(0,1), size=1, prob = c(1-x, x))

			case.more=apply(mat.pr.cand, 1, samp.sm)
			# >case.more[1:10]
			#  [1] 0 0 0 0 0 0 0 0 0 0
			sum(case.more)
			# [1] 7860

			length(case.more)
			# [1] 75158

			### (5) Identify who got new 1's ######

			who=NULL

			#### take n.require = 1090 more people #####
			if(sum(case.more) >= n.require){ # if further simulated individuals with fh=1 is larger than what we needed

					who=which(case.more==1)[1:n.require]
					# > who[1:10]
					#  [1] 14 23 24 29 49 56 61 75 81 90
					# > length(who)
					# [1] 1090
					# > n.require
					# [1] 1090

					###### (6) plug in this update status #########

					case.update[ix.cand][who]=1

			}# end of if(sum(fh.more) >= n.require){ #


			if(sum(case.more) < n.require){ # then just get all

						who=which(case.more==1)




			}## end of if(sum(fh.more) >= n.require){ #

			###### (6) plug in this update status #########

			#case.update[ix.cand][who]=1

			#### prevalence calculation ###
			prev.updated = sum( is.na(case.update)==F & case.update==1) / length(case.update)
			prev.updated
			#print(prev.updated)

			list(case.update=case.update, prev.update = prev.updated)


}#end of mySampleMore<- function(case, mat.prob, n.required){


########## PLCO risk model Martin tammemagi ############
#LCAriskCalculatorSMKonly-Tammemagi-2SEP13-Locked.xlsx


PLCO.risk <- function(x){   # education, 1:less than high grad
						   #            2:highschool grad
						   #            3:post highschool
						   #            4:some college
						   #            5:college grad
						   #            6:postgrad


				# > x[-1]
				#         age         edu         bmi        copd hist.cancer          fh      race.w      race.b
				#          65           4          27           0           0           0           1           0
				#      race.h      race.a     race.ai     race.hw   smkstatus   intensity    duration         ysq
				#           0           0           0           0           1          20          40           0

				# x=c(1, 55, 2, 25, 1, 0, 0,
				# 		1, 0,0,0,0,0,
				# 		1, 10, 15, 0)
				# x
				# #      intercept age edu bmi copd hist.cancer fh race.w race.b race.h race.a race.ai race.hw smkstatus intensity duration ysq
				# # [1,]         1  55   2  25    1           0  0      1      0      0      0       0       0         1        10       15   0

		if(sum(is.na(x))>0) { ans = NA }

		if(sum(is.na(x))==0){

				# intercept age edu bmi copd hist.cancer fh race.w race.b race.h race.a race.ai race.hw smkstatus intensity duration ysq
				cnames=c("intercept","age",
							"edu","bmi","copd","hist.cancer","fh",
							"race.w", "race.b","race.h","race.a","race.ai","race.hw",
							"smkstatus","intensity","duration","ysq")

				dim(x)=c(1,length(x));colnames(x)=cnames
				x
				#      intercept age edu bmi copd hist.cancer fh race.w race.b race.h race.a race.ai race.hw smkstatus intensity duration ysq
				# [1,]         1  55   2  25    1           0  0      1      0      0      0       0       0         1        10       15   0

				###### define PLCO coefficient ##########
				coef.PLCO = c(-4.532506,
							   0.0778868, -0.0812744, -0.0274194, 0.3553063, 0.4589971, 0.587185,
							   0, 0.3944778, -0.7434744,-0.466585, 0, 1.027152,
							   0.2597431,-1.822606, 0.0317321,-0.0308572)

				names(coef.PLCO)=c(cnames)
				# > coef.PLCO
				#   intercept         age         edu         bmi        copd hist.cancer          fh      race.w      race.b      race.h      race.a     race.ai     race.hw
				#  -4.5325060   0.0778868  -0.0812744  -0.0274194   0.3553063   0.4589971   0.5871850   0.0000000   0.3944778  -0.7434744  -0.4665850   0.0000000   1.0271520
				#   smkstatus   intensity    duration         ysq
				#   0.2597431  -1.8226060   0.0317321  -0.0308572


				###### mean-centered value ##############
				centr = c(0,
				 			62, 4, 27, 0, 0, 0,
				 			0, 0, 0, 0, 0, 0,
				 			0, 0.097845839, 27,10); names(centr)=cnames
				centr
				#   intercept         age         edu         bmi        copd hist.cancer          fh      race.w      race.b      race.h
				#  0.00000000 62.00000000  4.00000000 27.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000  0.00000000
				#      race.a     race.ai     race.hw   smkstatus   intensity    duration         ysq
				#  0.00000000  0.00000000  0.00000000  0.00000000  0.09784584 27.00000000 10.00000000

				####### only smoking intensity has non-linear compponent ######

				nonlin=rep(0,length(cnames));names(nonlin)=cnames
				nonlin["intensity"]=1

				cbind(coef.PLCO, centr, nonlin)
				#              coef.PLCO       centr nonlin
				# intercept   -4.5325060  0.00000000      0
				# age          0.0778868 62.00000000      0
				# edu         -0.0812744  4.00000000      0
				# bmi         -0.0274194 27.00000000      0
				# copd         0.3553063  0.00000000      0
				# hist.cancer  0.4589971  0.00000000      0
				# fh           0.5871850  0.00000000      0
				# race.w       0.0000000  0.00000000      0
				# race.b       0.3944778  0.00000000      0
				# race.h      -0.7434744  0.00000000      0
				# race.a      -0.4665850  0.00000000      0
				# race.ai      0.0000000  0.00000000      0
				# race.hw      1.0271520  0.00000000      0
				# smkstatus    0.2597431  0.00000000      0
				# intensity   -1.8226060  0.09784584      1  <-------- OK this was confusing!!! 0.0984 is NOT a centere value
				# duration     0.0317321 27.00000000      0
				# ysq         -0.0308572 10.00000000      0

				### centerized variable #
				x.cent = x-centr
				# > x.cent
				#      intercept age edu bmi copd hist.cancer fh race.w race.b race.h race.a race.ai race.hw smkstatus intensity duration ysq
				# [1,]         1  -7  -2  -2    1           0  0      1      0      0      0       0       0         1  9.902154      -12 -10


				logit.lin = x.cent[nonlin==0] %*% coef.PLCO[nonlin==0]  #[1] -4.31749
				logit.lin

				#	#Transformation of smoking intensity - (((average number_cigarettes_smoked_per_dat/10)^1)-0.4021541613)

				coef.cpd = coef.PLCO[nonlin==1] #-1.822606
				cpd = x.cent[nonlin==1] # 9.902154
				cpd = x[nonlin==1] # 9.902154

				logit.nonlin = (((cpd/10)^-1)-0.4021541613) %*% coef.cpd


				logit.all = logit.lin + logit.nonlin
				logit.all
				#           [,1]
				# [1,] -5.389294

				ans = as.vector(exp(logit.all)/(1+exp(logit.all)))

				#as.vector(exp(logit.all)/(1+exp(logit.all)))

					doThis=F
					if(doThis==T){
						## example 1, white, 65 year old current smoker, some college, BMI of 27,
						#no copd/personal history/family history smoked for 40 years up to now, 20 CPD on average

						x=c(1, 65,4,27,0,0,0,
						 		1,0,0,0,0,0,
						 		1,20,40,0)
						 names(x)=cnames
						# x
						# # intercept age edu bmi copd hist.cancer fh race.w race.b race.h race.a race.ai race.hw smkstatus intensity duration ysq
						# PLCO.risk(x)

						# > x[-1]
						#         age         edu         bmi        copd hist.cancer          fh      race.w      race.b
						#          65           4          27           0           0           0           1           0
						#      race.h      race.a     race.ai     race.hw   smkstatus   intensity    duration         ysq
						#           0           0           0           0           1          20          40           0
						# >
						# > PLCO.risk(x)*100
						# [1] 2.941633
						# > PLCO.risk(x)
						# [1] 0.02941633

						## example 2, white, 65 year old current smoker, high-school graduate, BMI of 27,
						#having copd, family history, no personal history smoked for 40 years up to now, 20 CPD on average

						# x=c(1, 65,4,27,1,0,1,
						# 		1,0,0,0,0,0,
						# 		1,20,40,0)
						# names(x)=cnames
						# PLCO.risk(x)
						#[1] 0.07216784
				 }#end of



		 }#end of if(sum(is.na(x))==0){

		 ans

}#end of PLCOrisk



		myElig <- function(mydata, op="USPSTF"){  # op = "USPSTF" "NLST" "CMS"

				ageOCM = mydata[,"age_death_OC"]
				# > ageOCM[1:20]
				#  [1]   77   87   67   89   82   29   36 -999   56   78   87   94   83   81   51   53   84   76   62   91
				ageOCM[ageOCM==-999]=999
				#  ageOCM[1:20]
				#  [1]  77  87  67  89  82  29  36 999  56  78  87  94  83  81  51  53  84  76  62  91
				# >
				for(u in 1:length(ages)){

					  ag=ages[u]

					  mat2=cbind(PY=mydata[,paste("PY",ag,sep=".")],YSQ=mydata[,paste("YSQ",ag,sep=".")])
					# > mat2[1:20,]
					#              PY YSQ
					#  [1,]  0.000000  NA
					#  [2,]  0.000000  NA
					#  [3,] 37.469504  NA
					#  [4,] 36.819075  NA
					#  [5,] 30.748738  NA
					#  [6,]  0.000000  NA
					#  [7,] 43.645535  16
					#  [8,]  0.000000  NA
					#  [9,]  0.107161  38
					# [10,] 45.038312  NA
					# [11,] 19.501322  18
					# [12,] 19.863369  NA
					# [13,]  3.391735  26
					# [14,] 16.694054  23
					# [15,] 27.403327  10
					# [16,] 11.285410  NA
					# [17,]  0.000000  NA
					# [18,]  0.987791  35
					# [19,] 10.164026  NA
					# [20,]  0.000000  NA

					### update YSQ: for current smokers == 0 ###
					smkstat=as.character(mydata[,paste("STAT",ag,sep=".")]) # smoking status

					ysq=mat2[,"YSQ"]
					# > ysq[1:20]
					#  [1] NA NA NA NA NA NA  6 NA 28 NA  8 NA 16 13 NA NA NA 25 NA NA

					ysq2=ysq
					ysq2[smkstat=="Current"] = 0


					ysq2[1:10]
					# [1] 45 45  0  0  0 45  6 45 28  0

					mat2[,"YSQ"]=ysq2



					ix = 1*(mat2[,"PY"] >=30  & (is.na(mat2[,"YSQ"])==F & mat2[,"YSQ"] <=15))


 					 cbind(ix,mat2)[1:20,]
					#       ix        PY YSQ
					#  [1,]  0  0.000000  45
					#  [2,]  0  0.000000  45
					#  [3,]  1 37.469504   0
					#  [4,]  1 36.819075   0
					#  [5,]  1 30.748738   0
					#  [6,]  0  0.000000  45
					#  [7,]  1 43.645535   6
					#  [8,]  0  0.000000  45
					#  [9,]  0  0.107161  28
					# [10,]  1 45.038312   0
					# [11,]  0 19.501322   8
					# [12,]  0 19.863369   0
					# [13,]  0  3.391735  16
					# [14,]  0 16.694054  13
					# [15,]  0 27.403327   0
					# [16,]  0 11.285410   0
					# [17,]  0  0.000000  NA
					# [18,]  0  0.987791  25
					# [19,]  0 10.164026   0
					# [20,]  0  0.000000  45


					####### age restriction only 55~80 eligible #########

					if(op=="USPSTF") if(ag < 55 | ag > 80) ix[] = 0
					if(op=="NLST") if(ag < 55 | ag > 75) ix[] = 0
					if(op=="CMS") if(ag < 55 | ag > 77) ix[] = 0


					####### impose OCM (not eligible if died already ########

					ix.dieEarly = ageOCM < ag  # if already died at this age e.g age=45, ageOCM = 44 or 45

					ix[ix.dieEarly]=NA


					if(u==1) el = ix
					if(u>1) el=cbind(el,ix)



				}#end of

				if(op=="USPSTF") colnames(el)=paste("USPSTF",ages,sep=".")
				if(op=="CMS") colnames(el)=paste("CMS",ages,sep=".")
				if(op=="NLST") colnames(el)=paste("NLST",ages,sep=".")

				# > el[1:10,]
				#      USPSTF.45 USPSTF.46 USPSTF.47 USPSTF.48 USPSTF.49 USPSTF.50 USPSTF.51 USPSTF.52 USPSTF.53 USPSTF.54
				#  [1,]         0         0         0         0         0         0         0         0         0         0
				#  [2,]         0         0         0         0         0         0         0         0         0         0
				#  [3,]         0         0         0         0         0         0         0         0         0         0
				#  [4,]         0         0         0         0         0         0         0         0         0         0
				#  [5,]         0         0         0         0         0         0         0         0         0         0
				#  [6,]        NA        NA        NA        NA        NA        NA        NA        NA        NA        NA
				#  [7,]        NA        NA        NA        NA        NA        NA        NA        NA        NA        NA
				#  [8,]         0         0         0         0         0         0         0         0         0         0
				#  [9,]         0         0         0         0         0         0         0         0         0         0
				# [10,]         0         0         0         0         0         0         0         0         0         0

				# > rowSums(el)[1:10]
				#  [1]  0  0 26 26 26  0 26  0  0 26
				n.sc = rowSums(el,na.rm=T)
				hist(n.sc[!n.sc==0],xlim=c(0,26),col="red",nclass=10,prob=T,ylim=c(0,0.5),main=op, xlab="Number of screens each person receives", cex.lab=1.5, cex.axis=1.5)

				percentEl = sum(rowSums(el,na.rm=T) >=1)/nrow(el)  # eligible at least once in life
				# > rowSums(el)[1:10]
				#  [1]  0  0 43 43 37  0 46  0  0 46

				n.sc.per = round(sum(rowSums(el,na.rm=T))/nrow(el),2)
				# [1] 12.3756

				## per screen among whom ever get screened
				n.sc.per2 = round(sum(rowSums(el,na.rm=T))/sum(rowSums(el,na.rm=T) >=1),2)

				print(paste("PercentEl = ",percentEl*100,"%",sep=""))
				print(paste("Number of screens per person = ",n.sc.per,sep=""))
				print(paste("Number of screens per person ever screened= ",n.sc.per2,sep=""))


				ans=list(el=el, percentEl= percentEl, n.screenPerPerson = n.sc.per, n.screesPerElig = n.sc.per2)
				ans


		}#end myeligibility

########### 10/31/2016 accumulated CPD for risk model (not yearly CPD) ##############

LC.risk.by.age <- function(mydata,ages, intensity=3){   # intensity = 1: age-specific intensity (wrong)

#myRiskPLCO.ages.cohort2 <- function(mydata,ages, intensity=3){   # intensity = 1: age-specific intensity (wrong)
																# intensity = 2: average intensity during which one smoked; also take into account 0 intensity during which he quit
																# intensity = 3: average intensity since age 1 to the given time: 0 intensity until the beginning of smoking is counted


			age.quit = mydata[,"age_cess"]
			# > age.quit[1:10]
			#  [1] -999 -999 -999   82   89 -999   39 -999   17   59


			for(u in 1:length(ages)){

					ag=ages[u]

					###  (1) extract matrix for a given age #####

					#if(u==1) intensity=mydata[,paste("CPD",ag,sep=".")]


					if(intensity==1) cpdlabels = paste("CPD",ag,sep=".") # age-specific intensity
					if(intensity==2) cpdlabels = paste("CPD2",ag,sep=".") # average intensity during which one smoked; also take into account 0 intensity during which he quit
					if(intensity==3) cpdlabels = paste("CPD3",ag,sep=".") # average intensity since age 1 to the given time: 0 intensity until the beginning of smoking is counted


					mat= cbind(intercept=rep(1,nrow(mydata)),age=rep(ag,nrow(mydata)),edu=mydata$edu2,bmi=mydata[,paste("BMI",ag,sep=".")],copd=mydata[,paste("COPD",ag,sep=".")], ph=mydata[,paste("PH",ag,sep=".")], fh=mydata[,paste("FH",ag,sep=".")],
									race.w = 1*(mydata[,"race"]=="W"),  race.b = 1*(mydata[,"race"]=="B"), race.h = 1*(mydata[,"race"]=="H"), race.a = 1*(mydata[,"race"]=="A"), race.ai=rep(0, nrow(mydata)), race.hw=rep(0, nrow(mydata)),
									smkstatus=mydata[,paste("STAT",ag,sep=".")], intensity=mydata[,cpdlabels], duration=mydata[,paste("DUR",ag,sep=".")], ysq=mydata[,paste("YSQ",ag,sep=".")])

# 					mat= cbind(intercept=rep(1,nrow(mydata)),age=rep(ag,nrow(mydata)),edu=edu2,bmi=mydata[,paste("BMI",ag,sep=".")],copd=mydata[,paste("COPD",ag,sep=".")], ph=mydata[,paste("PH",ag,sep=".")], fh=mydata[,paste("FH",ag,sep=".")],
# 									race.w = 1*(mydata[,"race"]=="W"),  race.b = 1*(mydata[,"race"]=="B"), race.h = 1*(mydata[,"race"]=="H"), race.a = 1*(mydata[,"race"]=="A"), race.ai=rep(0, nrow(mydata)), race.hw=rep(0, nrow(mydata)),
# 									smkstatus=mydata[,paste("STAT",ag,sep=".")], intensity=ave.cpd.dat2[,paste("CPD2",ag,sep=".")], duration=mydata[,paste("DUR",ag,sep=".")], ysq=mydata[,paste("YSQ",ag,sep=".")])


					#mat= cbind(intercept=rep(1,nrow(mydata)),age=rep(ag,nrow(mydata)),edu=edu2,bmi=mydata[,paste("BMI",ag,sep=".")],copd=mydata[,paste("COPD",ag,sep=".")], ph=mydata[,paste("PH",ag,sep=".")], fh=mydata[,paste("FH",ag,sep=".")],
					#				race.w = 1*(mydata[,"race"]=="W"),  race.b = 1*(mydata[,"race"]=="B"), race.h = 1*(mydata[,"race"]=="H"), race.a = 1*(mydata[,"race"]=="A"), race.ai=rep(0, nrow(mydata)), race.hw=rep(0, nrow(mydata)),
					#				smkstatus=mydata[,paste("STAT",ag,sep=".")], intensity=mydata[,paste("CPD",ag,sep=".")], duration=mydata[,paste("DUR",ag,sep=".")], ysq=mydata[,paste("YSQ",ag,sep=".")])

					# > mat[1:20,]
					#       intercept age edu      bmi copd ph fh race.w race.b race.h race.a race.hw smkstatus intensity duration ysq
					#  [1,]         1  45   2 29.12122    0  0  1      1      0      0      0       0         3  0.000000        0  NA
					#  [2,]         1  45   2 28.89886    0  0  0      0      0      1      0       0         3  0.000000        0  NA
					#  [3,]         1  45   2 27.68076    0  0  0      1      0      0      0       0         1 19.440043       30  NA
					#  [4,]         1  45   2 27.73235    1  0  1      0      1      0      0       0         1 19.440043       29  NA
					#  [5,]         1  45   2 27.63347    0  0  0      0      0      1      0       0         1 14.138794       33  NA
					#  [6,]         1  45   2 29.12122   NA NA NA      1      0      0      0       0         3  0.000000        0  NA
					#  [7,]         1  45   2 28.99155   NA NA NA      1      0      0      0       0         2  0.000000       22   6
					#  [8,]         1  45   2 30.08999    0  0  0      0      1      0      0       0         3  0.000000        0  NA
					#  [9,]         1  45   2 28.09225    0  0  0      1      0      0      0       0         2  0.000000        0  28
					# [10,]         1  45   2 27.79499    0  0  0      1      0      0      0       0         1 24.612381       26  NA
					# [11,]         1  45   2 29.05306    0  0  0      1      0      0      0       0         2  0.000000       28   8
					# [12,]         1  45   2 27.34061    0  0  0      1      0      0      0       0         1 14.138794       16  NA
					# [13,]         1  45   2 28.25777    0  0  0      1      0      0      0       0         2  0.000000        3  16
					# [14,]         1  45   2 26.77352    0  0  0      0      0      0      1       0         2  0.000000       20  13
					# [15,]         1  45   2 27.67951    0  0  0      1      0      0      0       0         1 19.440043       29  NA
					# [16,]         1  45   2 27.38587    0  0  0      0      1      0      0       0         1  5.226369       31  NA
					# [17,]         1  45   2 28.09225    0  0  0      1      0      0      0       0         2  0.000000        0  NA
					# [18,]         1  45   2 28.14768    0  1  1      1      0      0      0       0         2  0.000000        1  25
					# [19,]         1  45   2 27.31707    0  0  0      1      0      0      0       0         1  5.226369       26  NA
					# [20,]         1  45   2 26.79961    1  0  0      0      0      0      1       0         3  0.000000        0  NA

					## above copd, copd, ph = NA people died from other causes ####


					#### (2) reformat ysq variable: Martin model says to put "0" for current smokers and age for never smokers

					smkstat=as.character(mydata[,paste("STAT",ag,sep=".")]) # smoking status
					# > smkstat[1:20]
					#  [1] Never   Never   Current Current Current Never   Former  Never   Former  Current Former  Current Former  Former  Current Current Former  Former  Current
					# [20] Never

					ysq=mat[,"ysq"]
					# > ysq[1:20]
					#  [1] NA NA NA NA NA NA  6 NA 28 NA  8 NA 16 13 NA NA NA 25 NA NA

					ysq2=ysq
					ysq2[smkstat=="Current"] = 0
					ysq2[smkstat=="Never"] = ag

					ysq2[1:10]
					# [1] 45 45  0  0  0 45  6 45 28  0

					mat[,"ysq"]=ysq2

					mat[1:20,]
					#       intercept age edu      bmi copd ph fh race.w race.b race.h race.a race.ai race.hw smkstatus intensity duration ysq
					#  [1,]         1  45   2 29.12122    0  0  1      1      0      0      0       0       0         3  0.000000        0  45
					#  [2,]         1  45   2 28.89886    0  0  0      0      0      1      0       0       0         3  0.000000        0  45
					#  [3,]         1  45   2 27.68076    0  0  0      1      0      0      0       0       0         1 18.702504       30   0
					#  [4,]         1  45   2 27.73235    1  0  1      0      1      0      0       0       0         1 18.898846       29   0
					#  [5,]         1  45   2 27.63347    0  0  0      0      0      1      0       0       0         1 14.777032       33   0
					#  [6,]         1  45   2 29.12122   NA NA NA      1      0      0      0       0       0         3  0.000000        0  45
					#  [7,]         1  45   2 28.99155   NA NA NA      1      0      0      0       0       0         2 39.677759       22   6
					#  [8,]         1  45   2 30.08999    0  0  0      0      1      0      0       0       0         3  0.000000        0  45
					#  [9,]         1  45   2 28.09225    0  0  0      1      0      0      0       0       0         2  0.000000        0  28
					# [10,]         1  45   2 27.79499    0  0  0      1      0      0      0       0       0         1 25.719504       26   0
					# [11,]         1  45   2 29.05306    0  0  0      1      0      0      0       0       0         2 13.929516       28   8
					# [12,]         1  45   2 27.34061    0  0  0      1      0      0      0       0       0         1 16.870917       16   0
					# [13,]         1  45   2 28.25777    0  0  0      1      0      0      0       0       0         2 22.611565        3  16
					# [14,]         1  45   2 26.77352    0  0  0      0      0      0      1       0       0         2 16.694054       20  13
					# [15,]         1  45   2 27.67951    0  0  0      1      0      0      0       0       0         1 18.898846       29   0
					# [16,]         1  45   2 27.38587    0  0  0      0      1      0      0       0       0         1  5.801248       31   0
					# [17,]         1  45   2 28.09225    0  0  0      1      0      0      0       0       0         2  0.000000        0  NA
					# [18,]         1  45   2 28.14768    0  1  1      1      0      0      0       0       0         2 19.755820        1  25
					# [19,]         1  45   2 27.31707    0  0  0      1      0      0      0       0       0         1  6.054270       26   0
					# [20,]         1  45   2 26.79961    1  0  0      0      0      0      1       0       0         3  0.000000        0  45
					# >

					#      intercept age edu      bmi copd ph fh race.w race.b race.h race.a race.hw smkstatus intensity duration ysq
					#  [1,]         1  45   2 29.12122    0  0  1      1      0      0      0       0         3  0.000000        0  45
					#  [2,]         1  45   2 28.89886    0  0  0      0      0      1      0       0         3  0.000000        0  45
					#  [3,]         1  45   2 27.68076    0  0  0      1      0      0      0       0         1 19.440043       30   0
					#  [4,]         1  45   2 27.73235    1  0  1      0      1      0      0       0         1 19.440043       29   0
					#  [5,]         1  45   2 27.63347    0  0  0      0      0      1      0       0         1 14.138794       33   0
					#  [6,]         1  45   2 29.12122   NA NA NA      1      0      0      0       0         3  0.000000        0  45
					#  [7,]         1  45   2 28.99155   NA NA NA      1      0      0      0       0         2  0.000000       22   6
					#  [8,]         1  45   2 30.08999    0  0  0      0      1      0      0       0         3  0.000000        0  45
					#  [9,]         1  45   2 28.09225    0  0  0      1      0      0      0       0         2  0.000000        0  28
					# [10,]         1  45   2 27.79499    0  0  0      1      0      0      0       0         1 24.612381       26   0
					# [11,]         1  45   2 29.05306    0  0  0      1      0      0      0       0         2  0.000000       28   8
					# [12,]         1  45   2 27.34061    0  0  0      1      0      0      0       0         1 14.138794       16   0
					# [13,]         1  45   2 28.25777    0  0  0      1      0      0      0       0         2  0.000000        3  16
					# [14,]         1  45   2 26.77352    0  0  0      0      0      0      1       0         2  0.000000       20  13
					# [15,]         1  45   2 27.67951    0  0  0      1      0      0      0       0         1 19.440043       29   0
					# [16,]         1  45   2 27.38587    0  0  0      0      1      0      0       0         1  5.226369       31   0
					# [17,]         1  45   2 28.09225    0  0  0      1      0      0      0       0         2  0.000000        0  NA
					# [18,]         1  45   2 28.14768    0  1  1      1      0      0      0       0         2  0.000000        1  25
					# [19,]         1  45   2 27.31707    0  0  0      1      0      0      0       0         1  5.226369       26   0
					# [20,]         1  45   2 26.79961    1  0  0      0      0      0      1       0         3  0.000000        0  45

					# 				cnames=c("intercept","age",
					# 							"edu","bmi","copd","hist.cancer","fh",
					# 							"race.w", "race.b","race.h","race.a","race.ai","race.hw",
					# 							"smkstatus","intensity","duration","ysq")

					##### (3) reformat smoking status: 0 for former and 1 for current:  NA for never smokers this
					smkstat=as.character(mydata[,paste("STAT",ag,sep=".")]) # smoking status
					# > table(smkstat)
					# smkstat
					# Current  Former   Never
					#   36679   26712   36609

					smkstat2 = smkstat
					smkstat2[smkstat=="Current"]=1
					smkstat2[smkstat=="Former"]=0
					smkstat2[smkstat=="Never"]=NA

					table(smkstat2, useNA="always")
					# smkstat2
					#     0     1  <NA>
					# 26712 36679 36609


					mat[,"smkstatus"] = as.numeric(smkstat2)
					mat[1:20,]
					 #      intercept age edu      bmi copd ph fh race.w race.b race.h race.a race.ai race.hw smkstatus intensity duration ysq
					#  [1,]         1  45   2 29.12122    0  0  1      1      0      0      0       0       0        NA  0.000000        0  45
					#  [2,]         1  45   2 28.89886    0  0  0      0      0      1      0       0       0        NA  0.000000        0  45
					#  [3,]         1  45   2 27.68076    0  0  0      1      0      0      0       0       0         1 19.440043       30   0
					#  [4,]         1  45   2 27.73235    1  0  1      0      1      0      0       0       0         1 19.440043       29   0
					#  [5,]         1  45   2 27.63347    0  0  0      0      0      1      0       0       0         1 14.138794       33   0
					#  [6,]         1  45   2 29.12122   NA NA NA      1      0      0      0       0       0        NA  0.000000        0  45
					#  [7,]         1  45   2 28.99155   NA NA NA      1      0      0      0       0       0         0  0.000000       22   6
					#  [8,]         1  45   2 30.08999    0  0  0      0      1      0      0       0       0        NA  0.000000        0  45
					#  [9,]         1  45   2 28.09225    0  0  0      1      0      0      0       0       0         0  0.000000        0  28
					# [10,]         1  45   2 27.79499    0  0  0      1      0      0      0       0       0         1 24.612381       26   0
					# [11,]         1  45   2 29.05306    0  0  0      1      0      0      0       0       0         0  0.000000       28   8
					# [12,]         1  45   2 27.34061    0  0  0      1      0      0      0       0       0         1 14.138794       16   0
					# [13,]         1  45   2 28.25777    0  0  0      1      0      0      0       0       0         0  0.000000        3  16
					# [14,]         1  45   2 26.77352    0  0  0      0      0      0      1       0       0         0  0.000000       20  13
					# [15,]         1  45   2 27.67951    0  0  0      1      0      0      0       0       0         1 19.440043       29   0
					# [16,]         1  45   2 27.38587    0  0  0      0      1      0      0       0       0         1  5.226369       31   0
					# [17,]         1  45   2 28.09225    0  0  0      1      0      0      0       0       0         0  0.000000        0  NA
					# [18,]         1  45   2 28.14768    0  1  1      1      0      0      0       0       0         0  0.000000        1  25
					# [19,]         1  45   2 27.31707    0  0  0      1      0      0      0       0       0         1  5.226369       26   0
					# [20,]         1  45   2 26.79961    1  0  0      0      0      0      1       0       0        NA  0.000000        0  45

					#### (3) OK, how to handle already dead people from OCM? do not calculate? Don't calculate #############


					#PLCO.risk(mat[19,])
					#[1] 0.0003630878

					rs = apply(mat,1, PLCO.risk)
					# > rs[1:10]
					#  [1]          NA          NA 0.005200578 0.018891911 0.001922351          NA          NA          NA 0.000000000 0.005558774


					cbind(rs,mat)[1:30,]
					#cbind(rs,mat)[1:30,]
					 #                rs intercept age edu      bmi copd ph fh race.w race.b race.h race.a race.ai race.hw smkstatus intensity duration ysq
					#  [1,]           NA         1  45   2 29.12122    0  0  1      1      0      0      0       0       0        NA  0.000000        0  45
					#  [2,]           NA         1  45   2 28.89886    0  0  0      0      0      1      0       0       0        NA  0.000000        0  45
					#  [3,] 0.0052005777         1  45   2 27.68076    0  0  0      1      0      0      0       0       0         1 19.440043       30   0
					#  [4,] 0.0188919111         1  45   2 27.73235    1  0  1      0      1      0      0       0       0         1 19.440043       29   0
					#  [5,] 0.0019223511         1  45   2 27.63347    0  0  0      0      0      1      0       0       0         1 14.138794       33   0
					#  [6,]           NA         1  45   2 29.12122   NA NA NA      1      0      0      0       0       0        NA  0.000000        0  45
					#  [7,]           NA         1  45   2 28.99155   NA NA NA      1      0      0      0       0       0         0  0.000000       22   6
					#  [8,]           NA         1  45   2 30.08999    0  0  0      0      1      0      0       0       0        NA  0.000000        0  45
					#  [9,] 0.0000000000         1  45   2 28.09225    0  0  0      1      0      0      0       0       0         0  0.000000        0  28
					# [10,] 0.0055587741         1  45   2 27.79499    0  0  0      1      0      0      0       0       0         1 24.612381       26   0
					# [11,] 0.0000000000         1  45   2 29.05306    0  0  0      1      0      0      0       0       0         0  0.000000       28   8
					# [12,] 0.0023753716         1  45   2 27.34061    0  0  0      1      0      0      0       0       0         1 14.138794       16   0
					# [13,] 0.0000000000         1  45   2 28.25777    0  0  0      1      0      0      0       0       0         0  0.000000        3  16
					# [14,] 0.0000000000         1  45   2 26.77352    0  0  0      0      0      0      1       0       0         0  0.000000       20  13
					# [15,] 0.0050391337         1  45   2 27.67951    0  0  0      1      0      0      0       0       0         1 19.440043       29   0
					# [16,] 0.0006299431         1  45   2 27.38587    0  0  0      0      1      0      0       0       0         1  5.226369       31   0
					# [17,]           NA         1  45   2 28.09225    0  0  0      1      0      0      0       0       0         0  0.000000        0  NA
					# [18,] 0.0000000000         1  45   2 28.14768    0  1  1      1      0      0      0       0       0         0  0.000000        1  25
					# [19,] 0.0003630878         1  45   2 27.31707    0  0  0      1      0      0      0       0       0         1  5.226369       26   0
					# [20,]           NA         1  45   2 26.79961    1  0  0      0      0      0      1       0       0        NA  0.000000        0  45
					# [21,]           NA         1  45   2 28.70232   NA NA NA      1      0      0      0       0       0         0  0.000000       12  10
					# [22,] 0.0000000000         1  45   2 29.02054    0  0  0      1      0      0      0       0       0         0  0.000000       24   8
					# [23,] 0.0052005777         1  45   2 27.68076    0  0  0      1      0      0      0       0       0         1 19.440043       30   0
					# [24,] 0.0093283754         1  45   5 27.81171    1  0  0      1      0      0      0       0       0         1 39.882319       30   0
					# [25,] 0.0000000000         1  45   6 27.62331    0  0  0      0      1      0      0       0       0         0  0.000000        4  26
					# [26,]           NA         1  45   2 29.12122    0  0  0      1      0      0      0       0       0        NA  0.000000        0  45
					# [27,]           NA         1  45   2 29.12122   NA NA NA      1      0      0      0       0       0        NA  0.000000        0  45
					# [28,] 0.0003991692         1  45   2 27.33237    0  0  0      1      0      0      0       0       0         1  5.226369       29   0
					# [29,] 0.0093167000         1  45   2 27.68076    0  0  1      1      0      0      0       0       0         1 19.440043       30   0
					# [30,] 0.0102324064         1  45   2 27.85734    0  0  0      0      1      0      0       0       0         1 24.612381       33   0
					# >

					# > sum(is.na(rs))/length(rs)
					# [1] 0.4523
					# >
					# > table(smkstat)
					# smkstat
					# Current  Former   Never
					#   36679   26712   36609
					# > table(smkstat)/length(smkstat)
					# smkstat
					# Current  Former   Never
					# 0.36679 0.26712 0.36609

					ix = rs >= th & is.na(rs)==F  # those above the threshold and not NA

					#sum(ix)/length(rs) ## proportion among all


					if(u==1) myrs = rs
					if(u>1) myrs = cbind(myrs, rs)


			}#end of loop

			colnames(myrs)=paste("RSK",ages,sep=".")
			myrs[1:10,]
			#           RSK.45      RSK.46      RSK.47      RSK.48     RSK.49      RSK.50     RSK.51     RSK.52     RSK.53     RSK.54     RSK.55     RSK.56     RSK.57
			#  [1,]          NA          NA          NA          NA         NA          NA         NA         NA         NA         NA         NA         NA         NA
			#  [2,]          NA          NA          NA          NA         NA          NA         NA         NA         NA         NA         NA         NA         NA
			#  [3,] 0.005200578 0.008220257 0.009127020 0.010132629 0.01124758 0.012483456 0.01385326 0.01537142 0.01705389 0.03352574 0.03712629 0.04110169 0.04548876
			#  [4,] 0.018891911 0.020950215 0.023227204 0.025744809 0.02852687 0.031599349 0.03499096 0.03873305 0.04285960 0.04740739 0.05241608 0.05792825 0.06398943
			#  [5,] 0.001922351 0.003767177 0.004106542 0.004472341 0.00486594 0.005288673 0.00574189 0.00981835 0.01063186 0.01149824 0.01241869 0.01339401 0.01442447
			#  [6,]          NA          NA          NA          NA         NA          NA         NA         NA         NA         NA         NA         NA         NA
			#  [7,]          NA          NA          NA          NA         NA          NA         NA         NA         NA         NA         NA         NA         NA
			#  [8,]          NA          NA          NA          NA         NA          NA         NA         NA         NA         NA         NA         NA         NA
			#  [9,] 0.000000000 0.000000000 0.000000000 0.000000000 0.00000000 0.000000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000         NA         NA

			myrsk=myrs

			####### visualize ######
			doPlot=F
			if(doPlot==T){

					#setwd(outdir)
					#pdf("LC.risk_trajectories.500_errorCorrected.pdf")
					pdf(plotfile)

						kk=500
						par(mar=c(5,6,5,5))

						for(u in 1:kk){

							rcc=as.character(mydata[u,"race"])
							ed=as.character(mydata[u,"edu"])
							ag.quit=as.character(age.quit[u])


								plot(ages, myrsk[u,], pch=16, col="red",cex.lab=1.5,cex.main=1.5, cex.axis=1.5, xlab="Age", ylab="6-year LC Risk", ylim=c(0,0.5),
										main=paste("Subject ID=",u,"\n(gender=",Gender,", race=",rcc,", edu=",ed,  ", & age.quit=", ag.quit,")",  sep=""),axes=F, cex=1.2)
								axis(1,cex.axis=1.5)
								axis(2,cex.axis=1.5)



								axis(4, at=seq(0,1.5, by=0.25), labels=seq(0,1.5, by=0.25)*100, cex.axis=1.5)
								lines(ages, myrsk[u,], lty="dotted", col="red")

								mtext("Cig/day", side=4, line=2.2, cex=1.5)

								### estimated probablity ###

								#lines(ages,COPD.prev[u,]*10,pch=16, col="dark grey")#, lty="dotted")

								 abline(v=mydata[u,"age_death_OC"]-1, col="blue", lty="dotted", lwd=1.5)
								 #points(0, ageOCM[u]

								### cig/day  ###
						cpdnames=cpdlabels
						#cpdnames=paste("CPD3",ages,sep=".")
								fhnames=paste("FH",ages,sep=".")
								phnames=paste("PH",ages,sep=".")
								copdnames=paste("COPD",ages,sep=".")


								lines(ages,mydata[u,cpdnames]/100,lty="dotted", col="dark green")#, lty="dotted")
								points(ages,mydata[u,cpdnames]/100,pch=18, col="dark green")#, lty="dotted")

# 								lines(ages,mydata[u,cpdnames]/100,lty="dotted", col="dark green")#, lty="dotted")
# 								points(ages,mydata[u,cpdnames]/100,pch=18, col="dark green")#, lty="dotted")

								#### family history yes ###
								points(ages, mydata[u,fhnames]*0.1, pch=19, col="purple",cex=0.5)
							    lines(ages,mydata[u,fhnames]*0.1,lty="dotted", col="purple")#, lty="dotted")


								#### COPD yes ###
								points(ages, mydata[u,copdnames]*0.09, pch=19, col="orange",cex=0.5)
							    lines(ages,mydata[u,copdnames]*0.09,lty="dotted", col="orange")#, lty="dotted")


								#### PH yes ###
								points(ages, mydata[u,phnames]*0.08, pch=19, col="pink",cex=0.5)
							    lines(ages,mydata[u,phnames]*0.08,lty="dotted", col="pink")#, lty="dotted")



							#mtext("Cig/Day", side=4, line=2.2,cex=1.5)

								legend(x="topleft",legend=c("LC risk","Cig/Day", "OCM age" , "FH", "COPD","PH"),pch=c(16,18, 16,19), col=c("red","dark green","blue", "purple","orange","pink"),cex=1,
									lty=c("solid","dotted", "dotted","dotted","dotted","dotted"))

							}

				  dev.off()

			}#end of if(doPlot==T){

			myrsk

	   }#end of LC.risk.byage


########### 10/31/2016 accumulated CPD for risk model (not yearly CPD) ##############


myRiskPLCO.ages.cohort2 <- function(mydata,ages, intensity=3){   # intensity = 1: age-specific intensity (wrong)
																# intensity = 2: average intensity during which one smoked; also take into account 0 intensity during which he quit
																# intensity = 3: average intensity since age 1 to the given time: 0 intensity until the beginning of smoking is counted


			age.quit = mydata[,"age_cess"]
			# > age.quit[1:10]
			#  [1] -999 -999 -999   82   89 -999   39 -999   17   59


			for(u in 1:length(ages)){

					ag=ages[u]

					###  (1) extract matrix for a given age #####

					#if(u==1) intensity=mydata[,paste("CPD",ag,sep=".")]


					if(intensity==1) cpdlabels = paste("CPD",ag,sep=".") # age-specific intensity
					if(intensity==2) cpdlabels = paste("CPD2",ag,sep=".") # average intensity during which one smoked; also take into account 0 intensity during which he quit
					if(intensity==3) cpdlabels = paste("CPD3",ag,sep=".") # average intensity since age 1 to the given time: 0 intensity until the beginning of smoking is counted


					mat= cbind(intercept=rep(1,nrow(mydata)),age=rep(ag,nrow(mydata)),edu=edu2,bmi=mydata[,paste("BMI",ag,sep=".")],copd=mydata[,paste("COPD",ag,sep=".")], ph=mydata[,paste("PH",ag,sep=".")], fh=mydata[,paste("FH",ag,sep=".")],
									race.w = 1*(mydata[,"race"]=="W"),  race.b = 1*(mydata[,"race"]=="B"), race.h = 1*(mydata[,"race"]=="H"), race.a = 1*(mydata[,"race"]=="A"), race.ai=rep(0, nrow(mydata)), race.hw=rep(0, nrow(mydata)),
									smkstatus=mydata[,paste("STAT",ag,sep=".")], intensity=mydata[,cpdlabels], duration=mydata[,paste("DUR",ag,sep=".")], ysq=mydata[,paste("YSQ",ag,sep=".")])

# 					mat= cbind(intercept=rep(1,nrow(mydata)),age=rep(ag,nrow(mydata)),edu=edu2,bmi=mydata[,paste("BMI",ag,sep=".")],copd=mydata[,paste("COPD",ag,sep=".")], ph=mydata[,paste("PH",ag,sep=".")], fh=mydata[,paste("FH",ag,sep=".")],
# 									race.w = 1*(mydata[,"race"]=="W"),  race.b = 1*(mydata[,"race"]=="B"), race.h = 1*(mydata[,"race"]=="H"), race.a = 1*(mydata[,"race"]=="A"), race.ai=rep(0, nrow(mydata)), race.hw=rep(0, nrow(mydata)),
# 									smkstatus=mydata[,paste("STAT",ag,sep=".")], intensity=ave.cpd.dat2[,paste("CPD2",ag,sep=".")], duration=mydata[,paste("DUR",ag,sep=".")], ysq=mydata[,paste("YSQ",ag,sep=".")])


					#mat= cbind(intercept=rep(1,nrow(mydata)),age=rep(ag,nrow(mydata)),edu=edu2,bmi=mydata[,paste("BMI",ag,sep=".")],copd=mydata[,paste("COPD",ag,sep=".")], ph=mydata[,paste("PH",ag,sep=".")], fh=mydata[,paste("FH",ag,sep=".")],
					#				race.w = 1*(mydata[,"race"]=="W"),  race.b = 1*(mydata[,"race"]=="B"), race.h = 1*(mydata[,"race"]=="H"), race.a = 1*(mydata[,"race"]=="A"), race.ai=rep(0, nrow(mydata)), race.hw=rep(0, nrow(mydata)),
					#				smkstatus=mydata[,paste("STAT",ag,sep=".")], intensity=mydata[,paste("CPD",ag,sep=".")], duration=mydata[,paste("DUR",ag,sep=".")], ysq=mydata[,paste("YSQ",ag,sep=".")])

					# > mat[1:20,]
					#       intercept age edu      bmi copd ph fh race.w race.b race.h race.a race.hw smkstatus intensity duration ysq
					#  [1,]         1  45   2 29.12122    0  0  1      1      0      0      0       0         3  0.000000        0  NA
					#  [2,]         1  45   2 28.89886    0  0  0      0      0      1      0       0         3  0.000000        0  NA
					#  [3,]         1  45   2 27.68076    0  0  0      1      0      0      0       0         1 19.440043       30  NA
					#  [4,]         1  45   2 27.73235    1  0  1      0      1      0      0       0         1 19.440043       29  NA
					#  [5,]         1  45   2 27.63347    0  0  0      0      0      1      0       0         1 14.138794       33  NA
					#  [6,]         1  45   2 29.12122   NA NA NA      1      0      0      0       0         3  0.000000        0  NA
					#  [7,]         1  45   2 28.99155   NA NA NA      1      0      0      0       0         2  0.000000       22   6
					#  [8,]         1  45   2 30.08999    0  0  0      0      1      0      0       0         3  0.000000        0  NA
					#  [9,]         1  45   2 28.09225    0  0  0      1      0      0      0       0         2  0.000000        0  28
					# [10,]         1  45   2 27.79499    0  0  0      1      0      0      0       0         1 24.612381       26  NA
					# [11,]         1  45   2 29.05306    0  0  0      1      0      0      0       0         2  0.000000       28   8
					# [12,]         1  45   2 27.34061    0  0  0      1      0      0      0       0         1 14.138794       16  NA
					# [13,]         1  45   2 28.25777    0  0  0      1      0      0      0       0         2  0.000000        3  16
					# [14,]         1  45   2 26.77352    0  0  0      0      0      0      1       0         2  0.000000       20  13
					# [15,]         1  45   2 27.67951    0  0  0      1      0      0      0       0         1 19.440043       29  NA
					# [16,]         1  45   2 27.38587    0  0  0      0      1      0      0       0         1  5.226369       31  NA
					# [17,]         1  45   2 28.09225    0  0  0      1      0      0      0       0         2  0.000000        0  NA
					# [18,]         1  45   2 28.14768    0  1  1      1      0      0      0       0         2  0.000000        1  25
					# [19,]         1  45   2 27.31707    0  0  0      1      0      0      0       0         1  5.226369       26  NA
					# [20,]         1  45   2 26.79961    1  0  0      0      0      0      1       0         3  0.000000        0  NA

					## above copd, copd, ph = NA people died from other causes ####


					#### (2) reformat ysq variable: Martin model says to put "0" for current smokers and age for never smokers

					smkstat=as.character(mydata[,paste("STAT",ag,sep=".")]) # smoking status
					# > smkstat[1:20]
					#  [1] Never   Never   Current Current Current Never   Former  Never   Former  Current Former  Current Former  Former  Current Current Former  Former  Current
					# [20] Never

					ysq=mat[,"ysq"]
					# > ysq[1:20]
					#  [1] NA NA NA NA NA NA  6 NA 28 NA  8 NA 16 13 NA NA NA 25 NA NA

					ysq2=ysq
					ysq2[smkstat=="Current"] = 0
					ysq2[smkstat=="Never"] = ag

					ysq2[1:10]
					# [1] 45 45  0  0  0 45  6 45 28  0

					mat[,"ysq"]=ysq2

					mat[1:20,]
					#       intercept age edu      bmi copd ph fh race.w race.b race.h race.a race.ai race.hw smkstatus intensity duration ysq
					#  [1,]         1  45   2 29.12122    0  0  1      1      0      0      0       0       0         3  0.000000        0  45
					#  [2,]         1  45   2 28.89886    0  0  0      0      0      1      0       0       0         3  0.000000        0  45
					#  [3,]         1  45   2 27.68076    0  0  0      1      0      0      0       0       0         1 18.702504       30   0
					#  [4,]         1  45   2 27.73235    1  0  1      0      1      0      0       0       0         1 18.898846       29   0
					#  [5,]         1  45   2 27.63347    0  0  0      0      0      1      0       0       0         1 14.777032       33   0
					#  [6,]         1  45   2 29.12122   NA NA NA      1      0      0      0       0       0         3  0.000000        0  45
					#  [7,]         1  45   2 28.99155   NA NA NA      1      0      0      0       0       0         2 39.677759       22   6
					#  [8,]         1  45   2 30.08999    0  0  0      0      1      0      0       0       0         3  0.000000        0  45
					#  [9,]         1  45   2 28.09225    0  0  0      1      0      0      0       0       0         2  0.000000        0  28
					# [10,]         1  45   2 27.79499    0  0  0      1      0      0      0       0       0         1 25.719504       26   0
					# [11,]         1  45   2 29.05306    0  0  0      1      0      0      0       0       0         2 13.929516       28   8
					# [12,]         1  45   2 27.34061    0  0  0      1      0      0      0       0       0         1 16.870917       16   0
					# [13,]         1  45   2 28.25777    0  0  0      1      0      0      0       0       0         2 22.611565        3  16
					# [14,]         1  45   2 26.77352    0  0  0      0      0      0      1       0       0         2 16.694054       20  13
					# [15,]         1  45   2 27.67951    0  0  0      1      0      0      0       0       0         1 18.898846       29   0
					# [16,]         1  45   2 27.38587    0  0  0      0      1      0      0       0       0         1  5.801248       31   0
					# [17,]         1  45   2 28.09225    0  0  0      1      0      0      0       0       0         2  0.000000        0  NA
					# [18,]         1  45   2 28.14768    0  1  1      1      0      0      0       0       0         2 19.755820        1  25
					# [19,]         1  45   2 27.31707    0  0  0      1      0      0      0       0       0         1  6.054270       26   0
					# [20,]         1  45   2 26.79961    1  0  0      0      0      0      1       0       0         3  0.000000        0  45
					# >

					#      intercept age edu      bmi copd ph fh race.w race.b race.h race.a race.hw smkstatus intensity duration ysq
					#  [1,]         1  45   2 29.12122    0  0  1      1      0      0      0       0         3  0.000000        0  45
					#  [2,]         1  45   2 28.89886    0  0  0      0      0      1      0       0         3  0.000000        0  45
					#  [3,]         1  45   2 27.68076    0  0  0      1      0      0      0       0         1 19.440043       30   0
					#  [4,]         1  45   2 27.73235    1  0  1      0      1      0      0       0         1 19.440043       29   0
					#  [5,]         1  45   2 27.63347    0  0  0      0      0      1      0       0         1 14.138794       33   0
					#  [6,]         1  45   2 29.12122   NA NA NA      1      0      0      0       0         3  0.000000        0  45
					#  [7,]         1  45   2 28.99155   NA NA NA      1      0      0      0       0         2  0.000000       22   6
					#  [8,]         1  45   2 30.08999    0  0  0      0      1      0      0       0         3  0.000000        0  45
					#  [9,]         1  45   2 28.09225    0  0  0      1      0      0      0       0         2  0.000000        0  28
					# [10,]         1  45   2 27.79499    0  0  0      1      0      0      0       0         1 24.612381       26   0
					# [11,]         1  45   2 29.05306    0  0  0      1      0      0      0       0         2  0.000000       28   8
					# [12,]         1  45   2 27.34061    0  0  0      1      0      0      0       0         1 14.138794       16   0
					# [13,]         1  45   2 28.25777    0  0  0      1      0      0      0       0         2  0.000000        3  16
					# [14,]         1  45   2 26.77352    0  0  0      0      0      0      1       0         2  0.000000       20  13
					# [15,]         1  45   2 27.67951    0  0  0      1      0      0      0       0         1 19.440043       29   0
					# [16,]         1  45   2 27.38587    0  0  0      0      1      0      0       0         1  5.226369       31   0
					# [17,]         1  45   2 28.09225    0  0  0      1      0      0      0       0         2  0.000000        0  NA
					# [18,]         1  45   2 28.14768    0  1  1      1      0      0      0       0         2  0.000000        1  25
					# [19,]         1  45   2 27.31707    0  0  0      1      0      0      0       0         1  5.226369       26   0
					# [20,]         1  45   2 26.79961    1  0  0      0      0      0      1       0         3  0.000000        0  45

					# 				cnames=c("intercept","age",
					# 							"edu","bmi","copd","hist.cancer","fh",
					# 							"race.w", "race.b","race.h","race.a","race.ai","race.hw",
					# 							"smkstatus","intensity","duration","ysq")

					##### (3) reformat smoking status: 0 for former and 1 for current:  NA for never smokers this
					smkstat=as.character(mydata[,paste("STAT",ag,sep=".")]) # smoking status
					# > table(smkstat)
					# smkstat
					# Current  Former   Never
					#   36679   26712   36609

					smkstat2 = smkstat
					smkstat2[smkstat=="Current"]=1
					smkstat2[smkstat=="Former"]=0
					smkstat2[smkstat=="Never"]=NA

					table(smkstat2, useNA="always")
					# smkstat2
					#     0     1  <NA>
					# 26712 36679 36609


					mat[,"smkstatus"] = as.numeric(smkstat2)
					mat[1:20,]
					 #      intercept age edu      bmi copd ph fh race.w race.b race.h race.a race.ai race.hw smkstatus intensity duration ysq
					#  [1,]         1  45   2 29.12122    0  0  1      1      0      0      0       0       0        NA  0.000000        0  45
					#  [2,]         1  45   2 28.89886    0  0  0      0      0      1      0       0       0        NA  0.000000        0  45
					#  [3,]         1  45   2 27.68076    0  0  0      1      0      0      0       0       0         1 19.440043       30   0
					#  [4,]         1  45   2 27.73235    1  0  1      0      1      0      0       0       0         1 19.440043       29   0
					#  [5,]         1  45   2 27.63347    0  0  0      0      0      1      0       0       0         1 14.138794       33   0
					#  [6,]         1  45   2 29.12122   NA NA NA      1      0      0      0       0       0        NA  0.000000        0  45
					#  [7,]         1  45   2 28.99155   NA NA NA      1      0      0      0       0       0         0  0.000000       22   6
					#  [8,]         1  45   2 30.08999    0  0  0      0      1      0      0       0       0        NA  0.000000        0  45
					#  [9,]         1  45   2 28.09225    0  0  0      1      0      0      0       0       0         0  0.000000        0  28
					# [10,]         1  45   2 27.79499    0  0  0      1      0      0      0       0       0         1 24.612381       26   0
					# [11,]         1  45   2 29.05306    0  0  0      1      0      0      0       0       0         0  0.000000       28   8
					# [12,]         1  45   2 27.34061    0  0  0      1      0      0      0       0       0         1 14.138794       16   0
					# [13,]         1  45   2 28.25777    0  0  0      1      0      0      0       0       0         0  0.000000        3  16
					# [14,]         1  45   2 26.77352    0  0  0      0      0      0      1       0       0         0  0.000000       20  13
					# [15,]         1  45   2 27.67951    0  0  0      1      0      0      0       0       0         1 19.440043       29   0
					# [16,]         1  45   2 27.38587    0  0  0      0      1      0      0       0       0         1  5.226369       31   0
					# [17,]         1  45   2 28.09225    0  0  0      1      0      0      0       0       0         0  0.000000        0  NA
					# [18,]         1  45   2 28.14768    0  1  1      1      0      0      0       0       0         0  0.000000        1  25
					# [19,]         1  45   2 27.31707    0  0  0      1      0      0      0       0       0         1  5.226369       26   0
					# [20,]         1  45   2 26.79961    1  0  0      0      0      0      1       0       0        NA  0.000000        0  45

					#### (3) OK, how to handle already dead people from OCM? do not calculate? Don't calculate #############


					#PLCO.risk(mat[19,])
					#[1] 0.0003630878

					rs = apply(mat,1, PLCO.risk)
					# > rs[1:10]
					#  [1]          NA          NA 0.005200578 0.018891911 0.001922351          NA          NA          NA 0.000000000 0.005558774


					cbind(rs,mat)[1:30,]
					#cbind(rs,mat)[1:30,]
					 #                rs intercept age edu      bmi copd ph fh race.w race.b race.h race.a race.ai race.hw smkstatus intensity duration ysq
					#  [1,]           NA         1  45   2 29.12122    0  0  1      1      0      0      0       0       0        NA  0.000000        0  45
					#  [2,]           NA         1  45   2 28.89886    0  0  0      0      0      1      0       0       0        NA  0.000000        0  45
					#  [3,] 0.0052005777         1  45   2 27.68076    0  0  0      1      0      0      0       0       0         1 19.440043       30   0
					#  [4,] 0.0188919111         1  45   2 27.73235    1  0  1      0      1      0      0       0       0         1 19.440043       29   0
					#  [5,] 0.0019223511         1  45   2 27.63347    0  0  0      0      0      1      0       0       0         1 14.138794       33   0
					#  [6,]           NA         1  45   2 29.12122   NA NA NA      1      0      0      0       0       0        NA  0.000000        0  45
					#  [7,]           NA         1  45   2 28.99155   NA NA NA      1      0      0      0       0       0         0  0.000000       22   6
					#  [8,]           NA         1  45   2 30.08999    0  0  0      0      1      0      0       0       0        NA  0.000000        0  45
					#  [9,] 0.0000000000         1  45   2 28.09225    0  0  0      1      0      0      0       0       0         0  0.000000        0  28
					# [10,] 0.0055587741         1  45   2 27.79499    0  0  0      1      0      0      0       0       0         1 24.612381       26   0
					# [11,] 0.0000000000         1  45   2 29.05306    0  0  0      1      0      0      0       0       0         0  0.000000       28   8
					# [12,] 0.0023753716         1  45   2 27.34061    0  0  0      1      0      0      0       0       0         1 14.138794       16   0
					# [13,] 0.0000000000         1  45   2 28.25777    0  0  0      1      0      0      0       0       0         0  0.000000        3  16
					# [14,] 0.0000000000         1  45   2 26.77352    0  0  0      0      0      0      1       0       0         0  0.000000       20  13
					# [15,] 0.0050391337         1  45   2 27.67951    0  0  0      1      0      0      0       0       0         1 19.440043       29   0
					# [16,] 0.0006299431         1  45   2 27.38587    0  0  0      0      1      0      0       0       0         1  5.226369       31   0
					# [17,]           NA         1  45   2 28.09225    0  0  0      1      0      0      0       0       0         0  0.000000        0  NA
					# [18,] 0.0000000000         1  45   2 28.14768    0  1  1      1      0      0      0       0       0         0  0.000000        1  25
					# [19,] 0.0003630878         1  45   2 27.31707    0  0  0      1      0      0      0       0       0         1  5.226369       26   0
					# [20,]           NA         1  45   2 26.79961    1  0  0      0      0      0      1       0       0        NA  0.000000        0  45
					# [21,]           NA         1  45   2 28.70232   NA NA NA      1      0      0      0       0       0         0  0.000000       12  10
					# [22,] 0.0000000000         1  45   2 29.02054    0  0  0      1      0      0      0       0       0         0  0.000000       24   8
					# [23,] 0.0052005777         1  45   2 27.68076    0  0  0      1      0      0      0       0       0         1 19.440043       30   0
					# [24,] 0.0093283754         1  45   5 27.81171    1  0  0      1      0      0      0       0       0         1 39.882319       30   0
					# [25,] 0.0000000000         1  45   6 27.62331    0  0  0      0      1      0      0       0       0         0  0.000000        4  26
					# [26,]           NA         1  45   2 29.12122    0  0  0      1      0      0      0       0       0        NA  0.000000        0  45
					# [27,]           NA         1  45   2 29.12122   NA NA NA      1      0      0      0       0       0        NA  0.000000        0  45
					# [28,] 0.0003991692         1  45   2 27.33237    0  0  0      1      0      0      0       0       0         1  5.226369       29   0
					# [29,] 0.0093167000         1  45   2 27.68076    0  0  1      1      0      0      0       0       0         1 19.440043       30   0
					# [30,] 0.0102324064         1  45   2 27.85734    0  0  0      0      1      0      0       0       0         1 24.612381       33   0
					# >

					# > sum(is.na(rs))/length(rs)
					# [1] 0.4523
					# >
					# > table(smkstat)
					# smkstat
					# Current  Former   Never
					#   36679   26712   36609
					# > table(smkstat)/length(smkstat)
					# smkstat
					# Current  Former   Never
					# 0.36679 0.26712 0.36609

					ix = rs >= th & is.na(rs)==F  # those above the threshold and not NA

					#sum(ix)/length(rs) ## proportion among all


					if(u==1) myrs = rs
					if(u>1) myrs = cbind(myrs, rs)


			}#end of loop

			colnames(myrs)=paste("RSK",ages,sep=".")
			myrs[1:10,]
			#           RSK.45      RSK.46      RSK.47      RSK.48     RSK.49      RSK.50     RSK.51     RSK.52     RSK.53     RSK.54     RSK.55     RSK.56     RSK.57
			#  [1,]          NA          NA          NA          NA         NA          NA         NA         NA         NA         NA         NA         NA         NA
			#  [2,]          NA          NA          NA          NA         NA          NA         NA         NA         NA         NA         NA         NA         NA
			#  [3,] 0.005200578 0.008220257 0.009127020 0.010132629 0.01124758 0.012483456 0.01385326 0.01537142 0.01705389 0.03352574 0.03712629 0.04110169 0.04548876
			#  [4,] 0.018891911 0.020950215 0.023227204 0.025744809 0.02852687 0.031599349 0.03499096 0.03873305 0.04285960 0.04740739 0.05241608 0.05792825 0.06398943
			#  [5,] 0.001922351 0.003767177 0.004106542 0.004472341 0.00486594 0.005288673 0.00574189 0.00981835 0.01063186 0.01149824 0.01241869 0.01339401 0.01442447
			#  [6,]          NA          NA          NA          NA         NA          NA         NA         NA         NA         NA         NA         NA         NA
			#  [7,]          NA          NA          NA          NA         NA          NA         NA         NA         NA         NA         NA         NA         NA
			#  [8,]          NA          NA          NA          NA         NA          NA         NA         NA         NA         NA         NA         NA         NA
			#  [9,] 0.000000000 0.000000000 0.000000000 0.000000000 0.00000000 0.000000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000         NA         NA

			myrsk=myrs

			####### visualize ######
			doPlot=F
			if(doPlot==T){

					#setwd(outdir)
					#pdf("LC.risk_trajectories.500_errorCorrected.pdf")
					pdf(plotfile)

						kk=500
						par(mar=c(5,6,5,5))

						for(u in 1:kk){

							rcc=as.character(mydata[u,"race"])
							ed=as.character(mydata[u,"edu"])
							ag.quit=as.character(age.quit[u])


								plot(ages, myrsk[u,], pch=16, col="red",cex.lab=1.5,cex.main=1.5, cex.axis=1.5, xlab="Age", ylab="6-year LC Risk", ylim=c(0,0.5),
										main=paste("Subject ID=",u,"\n(gender=",Gender,", race=",rcc,", edu=",ed,  ", & age.quit=", ag.quit,")",  sep=""),axes=F, cex=1.2)
								axis(1,cex.axis=1.5)
								axis(2,cex.axis=1.5)



								axis(4, at=seq(0,1.5, by=0.25), labels=seq(0,1.5, by=0.25)*100, cex.axis=1.5)
								lines(ages, myrsk[u,], lty="dotted", col="red")

								mtext("Cig/day", side=4, line=2.2, cex=1.5)

								### estimated probablity ###

								#lines(ages,COPD.prev[u,]*10,pch=16, col="dark grey")#, lty="dotted")

								 abline(v=mydata[u,"age_death_OC"]-1, col="blue", lty="dotted", lwd=1.5)
								 #points(0, ageOCM[u]

								### cig/day  ###
						cpdnames=cpdlabels
						#cpdnames=paste("CPD3",ages,sep=".")
								fhnames=paste("FH",ages,sep=".")
								phnames=paste("PH",ages,sep=".")
								copdnames=paste("COPD",ages,sep=".")


								lines(ages,mydata[u,cpdnames]/100,lty="dotted", col="dark green")#, lty="dotted")
								points(ages,mydata[u,cpdnames]/100,pch=18, col="dark green")#, lty="dotted")

# 								lines(ages,mydata[u,cpdnames]/100,lty="dotted", col="dark green")#, lty="dotted")
# 								points(ages,mydata[u,cpdnames]/100,pch=18, col="dark green")#, lty="dotted")

								#### family history yes ###
								points(ages, mydata[u,fhnames]*0.1, pch=19, col="purple",cex=0.5)
							    lines(ages,mydata[u,fhnames]*0.1,lty="dotted", col="purple")#, lty="dotted")


								#### COPD yes ###
								points(ages, mydata[u,copdnames]*0.09, pch=19, col="orange",cex=0.5)
							    lines(ages,mydata[u,copdnames]*0.09,lty="dotted", col="orange")#, lty="dotted")


								#### PH yes ###
								points(ages, mydata[u,phnames]*0.08, pch=19, col="pink",cex=0.5)
							    lines(ages,mydata[u,phnames]*0.08,lty="dotted", col="pink")#, lty="dotted")



							#mtext("Cig/Day", side=4, line=2.2,cex=1.5)

								legend(x="topleft",legend=c("LC risk","Cig/Day", "OCM age" , "FH", "COPD","PH"),pch=c(16,18, 16,19), col=c("red","dark green","blue", "purple","orange","pink"),cex=1,
									lty=c("solid","dotted", "dotted","dotted","dotted","dotted"))

							}

				  dev.off()

			}#end of if(doPlot==T){

			myrsk

	   }#end of myRiskPLCO	myRiskPLCO.ages.cohort


myRiskPLCO.ages.cohort <- function(mydata,ages){

			for(u in 1:length(ages)){

					ag=ages[u]

					###  (1) extract matrix for a given age #####

					mat= cbind(intercept=rep(1,nrow(mydata)),age=rep(ag,nrow(mydata)),edu=edu2,bmi=mydata[,paste("BMI",ag,sep=".")],copd=mydata[,paste("COPD",ag,sep=".")], ph=mydata[,paste("PH",ag,sep=".")], fh=mydata[,paste("FH",ag,sep=".")],
									race.w = 1*(mydata[,"race"]=="W"),  race.b = 1*(mydata[,"race"]=="B"), race.h = 1*(mydata[,"race"]=="H"), race.a = 1*(mydata[,"race"]=="A"), race.ai=rep(0, nrow(mydata)), race.hw=rep(0, nrow(mydata)),
									smkstatus=mydata[,paste("STAT",ag,sep=".")], intensity=mydata[,paste("CPD",ag,sep=".")], duration=mydata[,paste("DUR",ag,sep=".")], ysq=mydata[,paste("YSQ",ag,sep=".")])

					# > mat[1:20,]
					#       intercept age edu      bmi copd ph fh race.w race.b race.h race.a race.hw smkstatus intensity duration ysq
					#  [1,]         1  45   2 29.12122    0  0  1      1      0      0      0       0         3  0.000000        0  NA
					#  [2,]         1  45   2 28.89886    0  0  0      0      0      1      0       0         3  0.000000        0  NA
					#  [3,]         1  45   2 27.68076    0  0  0      1      0      0      0       0         1 19.440043       30  NA
					#  [4,]         1  45   2 27.73235    1  0  1      0      1      0      0       0         1 19.440043       29  NA
					#  [5,]         1  45   2 27.63347    0  0  0      0      0      1      0       0         1 14.138794       33  NA
					#  [6,]         1  45   2 29.12122   NA NA NA      1      0      0      0       0         3  0.000000        0  NA
					#  [7,]         1  45   2 28.99155   NA NA NA      1      0      0      0       0         2  0.000000       22   6
					#  [8,]         1  45   2 30.08999    0  0  0      0      1      0      0       0         3  0.000000        0  NA
					#  [9,]         1  45   2 28.09225    0  0  0      1      0      0      0       0         2  0.000000        0  28
					# [10,]         1  45   2 27.79499    0  0  0      1      0      0      0       0         1 24.612381       26  NA
					# [11,]         1  45   2 29.05306    0  0  0      1      0      0      0       0         2  0.000000       28   8
					# [12,]         1  45   2 27.34061    0  0  0      1      0      0      0       0         1 14.138794       16  NA
					# [13,]         1  45   2 28.25777    0  0  0      1      0      0      0       0         2  0.000000        3  16
					# [14,]         1  45   2 26.77352    0  0  0      0      0      0      1       0         2  0.000000       20  13
					# [15,]         1  45   2 27.67951    0  0  0      1      0      0      0       0         1 19.440043       29  NA
					# [16,]         1  45   2 27.38587    0  0  0      0      1      0      0       0         1  5.226369       31  NA
					# [17,]         1  45   2 28.09225    0  0  0      1      0      0      0       0         2  0.000000        0  NA
					# [18,]         1  45   2 28.14768    0  1  1      1      0      0      0       0         2  0.000000        1  25
					# [19,]         1  45   2 27.31707    0  0  0      1      0      0      0       0         1  5.226369       26  NA
					# [20,]         1  45   2 26.79961    1  0  0      0      0      0      1       0         3  0.000000        0  NA

					## above copd, copd, ph = NA people died from other causes ####


					#### (2) reformat ysq variable: Martin model says to put "0" for current smokers and age for never smokers

					smkstat=as.character(mydata[,paste("STAT",ag,sep=".")]) # smoking status
					# > smkstat[1:20]
					#  [1] Never   Never   Current Current Current Never   Former  Never   Former  Current Former  Current Former  Former  Current Current Former  Former  Current
					# [20] Never

					ysq=mat[,"ysq"]
					# > ysq[1:20]
					#  [1] NA NA NA NA NA NA  6 NA 28 NA  8 NA 16 13 NA NA NA 25 NA NA

					ysq2=ysq
					ysq2[smkstat=="Current"] = 0
					ysq2[smkstat=="Never"] = ag

					ysq2[1:10]
					# [1] 45 45  0  0  0 45  6 45 28  0

					mat[,"ysq"]=ysq2

					mat[1:20,]
					#      intercept age edu      bmi copd ph fh race.w race.b race.h race.a race.hw smkstatus intensity duration ysq
					#  [1,]         1  45   2 29.12122    0  0  1      1      0      0      0       0         3  0.000000        0  45
					#  [2,]         1  45   2 28.89886    0  0  0      0      0      1      0       0         3  0.000000        0  45
					#  [3,]         1  45   2 27.68076    0  0  0      1      0      0      0       0         1 19.440043       30   0
					#  [4,]         1  45   2 27.73235    1  0  1      0      1      0      0       0         1 19.440043       29   0
					#  [5,]         1  45   2 27.63347    0  0  0      0      0      1      0       0         1 14.138794       33   0
					#  [6,]         1  45   2 29.12122   NA NA NA      1      0      0      0       0         3  0.000000        0  45
					#  [7,]         1  45   2 28.99155   NA NA NA      1      0      0      0       0         2  0.000000       22   6
					#  [8,]         1  45   2 30.08999    0  0  0      0      1      0      0       0         3  0.000000        0  45
					#  [9,]         1  45   2 28.09225    0  0  0      1      0      0      0       0         2  0.000000        0  28
					# [10,]         1  45   2 27.79499    0  0  0      1      0      0      0       0         1 24.612381       26   0
					# [11,]         1  45   2 29.05306    0  0  0      1      0      0      0       0         2  0.000000       28   8
					# [12,]         1  45   2 27.34061    0  0  0      1      0      0      0       0         1 14.138794       16   0
					# [13,]         1  45   2 28.25777    0  0  0      1      0      0      0       0         2  0.000000        3  16
					# [14,]         1  45   2 26.77352    0  0  0      0      0      0      1       0         2  0.000000       20  13
					# [15,]         1  45   2 27.67951    0  0  0      1      0      0      0       0         1 19.440043       29   0
					# [16,]         1  45   2 27.38587    0  0  0      0      1      0      0       0         1  5.226369       31   0
					# [17,]         1  45   2 28.09225    0  0  0      1      0      0      0       0         2  0.000000        0  NA
					# [18,]         1  45   2 28.14768    0  1  1      1      0      0      0       0         2  0.000000        1  25
					# [19,]         1  45   2 27.31707    0  0  0      1      0      0      0       0         1  5.226369       26   0
					# [20,]         1  45   2 26.79961    1  0  0      0      0      0      1       0         3  0.000000        0  45

					# 				cnames=c("intercept","age",
					# 							"edu","bmi","copd","hist.cancer","fh",
					# 							"race.w", "race.b","race.h","race.a","race.ai","race.hw",
					# 							"smkstatus","intensity","duration","ysq")

					##### (3) reformat smoking status: 0 for former and 1 for current:  NA for never smokers this
					smkstat=as.character(mydata[,paste("STAT",ag,sep=".")]) # smoking status
					# > table(smkstat)
					# smkstat
					# Current  Former   Never
					#   36679   26712   36609

					smkstat2 = smkstat
					smkstat2[smkstat=="Current"]=1
					smkstat2[smkstat=="Former"]=0
					smkstat2[smkstat=="Never"]=NA

					table(smkstat2, useNA="always")
					# smkstat2
					#     0     1  <NA>
					# 26712 36679 36609


					mat[,"smkstatus"] = as.numeric(smkstat2)
					mat[1:20,]
					 #      intercept age edu      bmi copd ph fh race.w race.b race.h race.a race.ai race.hw smkstatus intensity duration ysq
					#  [1,]         1  45   2 29.12122    0  0  1      1      0      0      0       0       0        NA  0.000000        0  45
					#  [2,]         1  45   2 28.89886    0  0  0      0      0      1      0       0       0        NA  0.000000        0  45
					#  [3,]         1  45   2 27.68076    0  0  0      1      0      0      0       0       0         1 19.440043       30   0
					#  [4,]         1  45   2 27.73235    1  0  1      0      1      0      0       0       0         1 19.440043       29   0
					#  [5,]         1  45   2 27.63347    0  0  0      0      0      1      0       0       0         1 14.138794       33   0
					#  [6,]         1  45   2 29.12122   NA NA NA      1      0      0      0       0       0        NA  0.000000        0  45
					#  [7,]         1  45   2 28.99155   NA NA NA      1      0      0      0       0       0         0  0.000000       22   6
					#  [8,]         1  45   2 30.08999    0  0  0      0      1      0      0       0       0        NA  0.000000        0  45
					#  [9,]         1  45   2 28.09225    0  0  0      1      0      0      0       0       0         0  0.000000        0  28
					# [10,]         1  45   2 27.79499    0  0  0      1      0      0      0       0       0         1 24.612381       26   0
					# [11,]         1  45   2 29.05306    0  0  0      1      0      0      0       0       0         0  0.000000       28   8
					# [12,]         1  45   2 27.34061    0  0  0      1      0      0      0       0       0         1 14.138794       16   0
					# [13,]         1  45   2 28.25777    0  0  0      1      0      0      0       0       0         0  0.000000        3  16
					# [14,]         1  45   2 26.77352    0  0  0      0      0      0      1       0       0         0  0.000000       20  13
					# [15,]         1  45   2 27.67951    0  0  0      1      0      0      0       0       0         1 19.440043       29   0
					# [16,]         1  45   2 27.38587    0  0  0      0      1      0      0       0       0         1  5.226369       31   0
					# [17,]         1  45   2 28.09225    0  0  0      1      0      0      0       0       0         0  0.000000        0  NA
					# [18,]         1  45   2 28.14768    0  1  1      1      0      0      0       0       0         0  0.000000        1  25
					# [19,]         1  45   2 27.31707    0  0  0      1      0      0      0       0       0         1  5.226369       26   0
					# [20,]         1  45   2 26.79961    1  0  0      0      0      0      1       0       0        NA  0.000000        0  45

					#### (3) OK, how to handle already dead people from OCM? do not calculate? Don't calculate #############


					#PLCO.risk(mat[19,])
					#[1] 0.0003630878

					rs = apply(mat,1, PLCO.risk)
					# > rs[1:10]
					#  [1]          NA          NA 0.005200578 0.018891911 0.001922351          NA          NA          NA 0.000000000 0.005558774


					cbind(rs,mat)[1:30,]
					#cbind(rs,mat)[1:30,]
					 #                rs intercept age edu      bmi copd ph fh race.w race.b race.h race.a race.ai race.hw smkstatus intensity duration ysq
					#  [1,]           NA         1  45   2 29.12122    0  0  1      1      0      0      0       0       0        NA  0.000000        0  45
					#  [2,]           NA         1  45   2 28.89886    0  0  0      0      0      1      0       0       0        NA  0.000000        0  45
					#  [3,] 0.0052005777         1  45   2 27.68076    0  0  0      1      0      0      0       0       0         1 19.440043       30   0
					#  [4,] 0.0188919111         1  45   2 27.73235    1  0  1      0      1      0      0       0       0         1 19.440043       29   0
					#  [5,] 0.0019223511         1  45   2 27.63347    0  0  0      0      0      1      0       0       0         1 14.138794       33   0
					#  [6,]           NA         1  45   2 29.12122   NA NA NA      1      0      0      0       0       0        NA  0.000000        0  45
					#  [7,]           NA         1  45   2 28.99155   NA NA NA      1      0      0      0       0       0         0  0.000000       22   6
					#  [8,]           NA         1  45   2 30.08999    0  0  0      0      1      0      0       0       0        NA  0.000000        0  45
					#  [9,] 0.0000000000         1  45   2 28.09225    0  0  0      1      0      0      0       0       0         0  0.000000        0  28
					# [10,] 0.0055587741         1  45   2 27.79499    0  0  0      1      0      0      0       0       0         1 24.612381       26   0
					# [11,] 0.0000000000         1  45   2 29.05306    0  0  0      1      0      0      0       0       0         0  0.000000       28   8
					# [12,] 0.0023753716         1  45   2 27.34061    0  0  0      1      0      0      0       0       0         1 14.138794       16   0
					# [13,] 0.0000000000         1  45   2 28.25777    0  0  0      1      0      0      0       0       0         0  0.000000        3  16
					# [14,] 0.0000000000         1  45   2 26.77352    0  0  0      0      0      0      1       0       0         0  0.000000       20  13
					# [15,] 0.0050391337         1  45   2 27.67951    0  0  0      1      0      0      0       0       0         1 19.440043       29   0
					# [16,] 0.0006299431         1  45   2 27.38587    0  0  0      0      1      0      0       0       0         1  5.226369       31   0
					# [17,]           NA         1  45   2 28.09225    0  0  0      1      0      0      0       0       0         0  0.000000        0  NA
					# [18,] 0.0000000000         1  45   2 28.14768    0  1  1      1      0      0      0       0       0         0  0.000000        1  25
					# [19,] 0.0003630878         1  45   2 27.31707    0  0  0      1      0      0      0       0       0         1  5.226369       26   0
					# [20,]           NA         1  45   2 26.79961    1  0  0      0      0      0      1       0       0        NA  0.000000        0  45
					# [21,]           NA         1  45   2 28.70232   NA NA NA      1      0      0      0       0       0         0  0.000000       12  10
					# [22,] 0.0000000000         1  45   2 29.02054    0  0  0      1      0      0      0       0       0         0  0.000000       24   8
					# [23,] 0.0052005777         1  45   2 27.68076    0  0  0      1      0      0      0       0       0         1 19.440043       30   0
					# [24,] 0.0093283754         1  45   5 27.81171    1  0  0      1      0      0      0       0       0         1 39.882319       30   0
					# [25,] 0.0000000000         1  45   6 27.62331    0  0  0      0      1      0      0       0       0         0  0.000000        4  26
					# [26,]           NA         1  45   2 29.12122    0  0  0      1      0      0      0       0       0        NA  0.000000        0  45
					# [27,]           NA         1  45   2 29.12122   NA NA NA      1      0      0      0       0       0        NA  0.000000        0  45
					# [28,] 0.0003991692         1  45   2 27.33237    0  0  0      1      0      0      0       0       0         1  5.226369       29   0
					# [29,] 0.0093167000         1  45   2 27.68076    0  0  1      1      0      0      0       0       0         1 19.440043       30   0
					# [30,] 0.0102324064         1  45   2 27.85734    0  0  0      0      1      0      0       0       0         1 24.612381       33   0
					# >

					# > sum(is.na(rs))/length(rs)
					# [1] 0.4523
					# >
					# > table(smkstat)
					# smkstat
					# Current  Former   Never
					#   36679   26712   36609
					# > table(smkstat)/length(smkstat)
					# smkstat
					# Current  Former   Never
					# 0.36679 0.26712 0.36609

					ix = rs >= th & is.na(rs)==F  # those above the threshold and not NA

					#sum(ix)/length(rs) ## proportion among all


					if(u==1) myrs = rs
					if(u>1) myrs = cbind(myrs, rs)


			}#end of loop

			colnames(myrs)=paste("RSK",ages,sep=".")
			myrs[1:10,]
			#           RSK.45      RSK.46      RSK.47      RSK.48     RSK.49      RSK.50     RSK.51     RSK.52     RSK.53     RSK.54     RSK.55     RSK.56     RSK.57
			#  [1,]          NA          NA          NA          NA         NA          NA         NA         NA         NA         NA         NA         NA         NA
			#  [2,]          NA          NA          NA          NA         NA          NA         NA         NA         NA         NA         NA         NA         NA
			#  [3,] 0.005200578 0.008220257 0.009127020 0.010132629 0.01124758 0.012483456 0.01385326 0.01537142 0.01705389 0.03352574 0.03712629 0.04110169 0.04548876
			#  [4,] 0.018891911 0.020950215 0.023227204 0.025744809 0.02852687 0.031599349 0.03499096 0.03873305 0.04285960 0.04740739 0.05241608 0.05792825 0.06398943
			#  [5,] 0.001922351 0.003767177 0.004106542 0.004472341 0.00486594 0.005288673 0.00574189 0.00981835 0.01063186 0.01149824 0.01241869 0.01339401 0.01442447
			#  [6,]          NA          NA          NA          NA         NA          NA         NA         NA         NA         NA         NA         NA         NA
			#  [7,]          NA          NA          NA          NA         NA          NA         NA         NA         NA         NA         NA         NA         NA
			#  [8,]          NA          NA          NA          NA         NA          NA         NA         NA         NA         NA         NA         NA         NA
			#  [9,] 0.000000000 0.000000000 0.000000000 0.000000000 0.00000000 0.000000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000         NA         NA

			myrsk=myrs

			####### visualize ######


			doPlot=F
			if(doPlot==T){
					#setwd(outdir)
					pdf("LC.risk_trajectories.500.pdf")

						kk=500
						par(mar=c(5,6,5,5))

						for(u in 1:kk){

							rcc=as.character(mydata[u,"race"])
							ed=as.character(mydata[u,"edu"])


								plot(ages, myrsk[u,], pch=16, col="red",cex.lab=1.5,cex.main=1.5, cex.axis=1.5, xlab="Age", ylab="6-year LC Risk", ylim=c(0,0.5),
										main=paste("Subject ID=",u,"\n(gender=",Gender,", race=",rcc," & edu=",ed,")",  sep=""),axes=F, cex=1.2)
								axis(1,cex.axis=1.5)
								axis(2,cex.axis=1.5)



								axis(4, at=seq(0,1.5, by=0.25), labels=seq(0,1.5, by=0.25)*100, cex.axis=1.5)
								lines(ages, myrsk[u,], lty="dotted", col="red")

								mtext("Cig/day", side=4, line=2.2, cex=1.5)

								### estimated probablity ###

								#lines(ages,COPD.prev[u,]*10,pch=16, col="dark grey")#, lty="dotted")

								 abline(v=mydata[u,"age_death_OC"]-1, col="blue", lty="dotted", lwd=1.5)
								 #points(0, ageOCM[u]

								### cig/day  ###

								cpdnames=paste("CPD",ages,sep=".")
								fhnames=paste("FH",ages,sep=".")
								phnames=paste("PH",ages,sep=".")
								copdnames=paste("COPD",ages,sep=".")


								lines(ages,mydata[u,cpdnames]/100,lty="dotted", col="dark green")#, lty="dotted")
								points(ages,mydata[u,cpdnames]/100,pch=18, col="dark green")#, lty="dotted")

								#### family history yes ###
								points(ages, mydata[u,fhnames]*0.1, pch=19, col="purple",cex=0.5)
							    lines(ages,mydata[u,fhnames]*0.1,lty="dotted", col="purple")#, lty="dotted")


								#### COPD yes ###
								points(ages, mydata[u,copdnames]*0.09, pch=19, col="orange",cex=0.5)
							    lines(ages,mydata[u,copdnames]*0.09,lty="dotted", col="orange")#, lty="dotted")


								#### PH yes ###
								points(ages, mydata[u,phnames]*0.08, pch=19, col="pink",cex=0.5)
							    lines(ages,mydata[u,phnames]*0.08,lty="dotted", col="pink")#, lty="dotted")





							#mtext("Cig/Day", side=4, line=2.2,cex=1.5)

								legend(x="topleft",legend=c("LC risk","Cig/Day", "OCM age" , "FH", "COPD","PH"),pch=c(16,18, 16,19), col=c("red","dark green","blue", "purple","orange","pink"),cex=1,
									lty=c("solid","dotted", "dotted","dotted","dotted","dotted"))

							}

				  dev.off()

			}#end of if(doPlot==T){

			myrsk

	   }#end of myRiskPLCO	myRiskPLCO.ages.cohort

#### 11/1/2016: update the age limit too
myElig.thr2 <- function(mat.risk, thrs,start.age=55, stop.age=75){

				for(u in 1:length(thrs)){

					th= thrs[u]

					## indic matrix

					mat.ix = mat.risk >= th & is.na(mat.risk)==F
					# > mat.ix[1:10,1:10]
					#       RSK.45 RSK.46 RSK.47 RSK.48 RSK.49 RSK.50 RSK.51 RSK.52 RSK.53 RSK.54
					#  [1,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE
					#  [2,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE
					#  [3,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE   TRUE   TRUE   TRUE
					#  [4,]   TRUE   TRUE   TRUE   TRUE   TRUE   TRUE   TRUE   TRUE   TRUE   TRUE
					#  [5,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE
					#  [6,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE
					#  [7,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE
					#  [8,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE
					#  [9,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE
					# [10,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE   TRUE   TRUE   TRUE   TRUE


				   ##### age restriction #####

				   selcol=paste("RSK",start.age:stop.age,sep=".")
					# > selcol
					#  [1] "RSK.55" "RSK.56" "RSK.57" "RSK.58" "RSK.59" "RSK.60" "RSK.61" "RSK.62" "RSK.63" "RSK.64" "RSK.65" "RSK.66" "RSK.67" "RSK.68"
					# [15] "RSK.69" "RSK.70" "RSK.71" "RSK.72" "RSK.73" "RSK.74" "RSK.75"

				   ix.age = !(colnames(mat.risk) %in% selcol) # identify age not included in the range
					# > ix.age
					#  [1]  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
					# [22] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE
					# [43]  TRUE  TRUE  TRUE  TRUE
					# > colnames(mat.risk)[ix.age]
					#  [1] "RSK.45" "RSK.46" "RSK.47" "RSK.48" "RSK.49" "RSK.50" "RSK.51" "RSK.52" "RSK.53" "RSK.54" "RSK.76" "RSK.77" "RSK.78" "RSK.79"
					# [15] "RSK.80" "RSK.81" "RSK.82" "RSK.83" "RSK.84" "RSK.85" "RSK.86" "RSK.87" "RSK.88" "RSK.89" "RSK.90"


				   mat.ix[,ix.age]=FALSE
					# > mat.ix[1:10,1:15]
					#       RSK.45 RSK.46 RSK.47 RSK.48 RSK.49 RSK.50 RSK.51 RSK.52 RSK.53 RSK.54 RSK.55 RSK.56 RSK.57 RSK.58 RSK.59
					#  [1,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE
					#  [2,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE
					#  [3,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE   TRUE   TRUE   TRUE   TRUE   TRUE
					#  [4,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE   TRUE   TRUE   TRUE   TRUE   TRUE
					#  [5,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE   TRUE   TRUE   TRUE   TRUE   TRUE
					#  [6,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE
					#  [7,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE
					#  [8,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE
					#  [9,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE

					## number of screens for each person

					rosum = rowSums(mat.ix)
					# > length(rosum)
					# [1] 100000
					# > rosum[1:10]
					#  [1]  0  0 15 38 24  0  0  0  0  9

					### percent screened ##

					ix.el = rosum >= 1   # at least one time eligible in lifetime
					percentEl = sum(ix.el)/length(ix.el)
					# > percentEl
					# [1] 0.16728


					## number of screens per person ###  200:1

					n.scr = round(sum(rosum) / length(rosum),2)
					#[1] 2.19133

					## number of screens among whom get screens at once
					n.scr2 = round(sum(rosum) / sum(ix.el),2)

					print(paste("Threshold = ", th, sep=""))
					print(paste("PercentEl = ",percentEl*100,"%",sep=""))
					print(paste("Number of screens per person = ",n.scr,sep=""))
					print(paste("Number of screens per person ever screened= ",n.scr2,sep=""))

					ans=c(threshold=th, percentEl= percentEl, n.screenPerPerson = n.scr, n.screesPerElig = n.scr2)


					if(u==1) ANS=ans
					if(u>1) ANS=rbind(ANS,ans)


			}#end of thrs

			row.names(ANS)=1:nrow(ANS)
			ANS


		}#end of function myElig.thr

myElig.thr <- function(mat.risk, thrs){

				for(u in 1:length(thrs)){

					th= thrs[u]

					## indic matrix

					mat.ix = mat.risk >= th & is.na(mat.risk)==F
					# > mat.ix[1:10,1:10]
					#       RSK.45 RSK.46 RSK.47 RSK.48 RSK.49 RSK.50 RSK.51 RSK.52 RSK.53 RSK.54
					#  [1,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE
					#  [2,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE
					#  [3,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE   TRUE   TRUE   TRUE
					#  [4,]   TRUE   TRUE   TRUE   TRUE   TRUE   TRUE   TRUE   TRUE   TRUE   TRUE
					#  [5,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE
					#  [6,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE
					#  [7,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE
					#  [8,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE
					#  [9,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE
					# [10,]  FALSE  FALSE  FALSE  FALSE  FALSE  FALSE   TRUE   TRUE   TRUE   TRUE

					## number of screens for each person

					rosum = rowSums(mat.ix)
					# > length(rosum)
					# [1] 100000
					# > rosum[1:10]
					#  [1]  0  0 15 38 24  0  0  0  0  9

					### percent screened ##

					ix.el = rosum >= 1   # at least one time eligible in lifetime
					percentEl = sum(ix.el)/length(ix.el)
					# > percentEl
					# [1] 0.16728


					## number of screens per person ###  200:1

					n.scr = round(sum(rosum) / length(rosum),2)
					#[1] 2.19133

					## number of screens among whom get screens at once
					n.scr2 = round(sum(rosum) / sum(ix.el),2)

					print(paste("Threshold = ", th, sep=""))
					print(paste("PercentEl = ",percentEl*100,"%",sep=""))
					print(paste("Number of screens per person = ",n.scr,sep=""))
					print(paste("Number of screens per person ever screened= ",n.scr2,sep=""))

					ans=c(threshold=th, percentEl= percentEl, n.screenPerPerson = n.scr, n.screesPerElig = n.scr2)


					if(u==1) ANS=ans
					if(u>1) ANS=rbind(ANS,ans)


			}#end of thrs

			row.names(ANS)=1:nrow(ANS)
			ANS


		}#end of function myElig.thr

		### updated CPD data (average over lifetime ) ###

		myPlot.trj2 <- function(ix=rep(T,nrow(mydata)), kk, mydata, myrsk, el.usps, myth,intensity=3){

																# intensity = 1: age-specific intensity
																# intensity = 2: average intensity during which one smoked; also take into account 0 intensity during which he quit
																# intensity = 3: average intensity since age 1 to the given time: 0 intensity until the beginning of smoking is counted


					par(mar=c(5,6,5,5))
					mydata2 = mydata[ix,]
					myrsk2=myrsk[ix,]
					el.usps2=el.usps[ix,]


					for(u in 1:kk){

							rcc=as.character(mydata2[u,"race"])
							ed=as.character(mydata2[u,"edu"])

							plot(ages, myrsk2[u,], pch=16, col="red",cex.lab=1.5,cex.main=1.5, cex.axis=1.5, xlab="Age", ylab="6-year LC Risk", ylim=c(0,0.5),
									main=paste("Subject ID=",which(ix)[u],"\n(gender=",Gender,", race=",rcc," & edu=",ed,")",  sep=""),axes=F, cex=1.2)
							axis(1,cex.axis=1.5)
							axis(2,cex.axis=1.5)
							axis(4, at=seq(0,1.5, by=0.25), labels=seq(0,1.5, by=0.25)*100, cex.axis=1.5)
							lines(ages, myrsk2[u,], lty="dotted", col="red")

							mtext("Cig/day", side=4, line=2.2, cex=1.5)

							abline(h=myth, col="red")

							### estimated probablity ###
							 abline(v=mydata2[u,"age_death_OC"]-1, col="blue", lty="dotted", lwd=1.5)

						if(intensity==1) cpdnames=paste("CPD",ages,sep=".")
						if(intensity==2) cpdnames=paste("CPD2",ages,sep=".")
						if(intensity==3) cpdnames=paste("CPD3",ages,sep=".")


							fhnames=paste("FH",ages,sep=".")
							phnames=paste("PH",ages,sep=".")
							copdnames=paste("COPD",ages,sep=".")

							lines(ages,mydata2[u,cpdnames]/100,lty="dotted", col="dark green")#, lty="dotted")
							points(ages,mydata2[u,cpdnames]/100,pch=18, col="dark green")#, lty="dotted")

							#### family history yes ###
							points(ages, mydata2[u,fhnames]*0.1, pch=19, col="purple",cex=0.5)
							lines(ages,mydata2[u,fhnames]*0.1,lty="dotted", col="purple")#, lty="dotted")

							#### COPD yes ###
							points(ages, mydata2[u,copdnames]*0.09, pch=19, col="orange",cex=0.5)
							lines(ages,mydata2[u,copdnames]*0.09,lty="dotted", col="orange")#, lty="dotted")

							#### PH yes ###
							points(ages, mydata2[u,phnames]*0.08, pch=19, col="pink",cex=0.5)
							lines(ages,mydata2[u,phnames]*0.08,lty="dotted", col="pink")#, lty="dotted")

							#### USPS yes ###
							points(ages, el.usps2[u,]*0.2, pch=1, col="blue",cex=1)
							lines(ages,el.usps2[u,]*0.2,lty="dotted", col="blue")#, lty="dotted")


							legend(x="topleft",legend=c("LC risk","Cig/Day", "OCM age" , "FH", "COPD","PH","USPSTF-elig"),pch=c(16,18, 16,19,19,19,1), col=c("red","dark green","blue", "purple","orange","pink","blue"),cex=1,
								lty=c("solid","dotted", "dotted","dotted","dotted","dotted","dotted"))

						}#end of loop


	}#end of  function myPlot.trj
		myPlot.trj <- function(ix=rep(T,nrow(mydata)), kk, mydata, myrsk, el.usps, myth){

					par(mar=c(5,6,5,5))




					for(u in 1:kk){

							rcc=as.character(mydata[ix,][u,"race"])
							ed=as.character(mydata[ix,][u,"edu"])

							plot(ages, myrsk[ix,][u,], pch=16, col="red",cex.lab=1.5,cex.main=1.5, cex.axis=1.5, xlab="Age", ylab="6-year LC Risk", ylim=c(0,0.5),
									main=paste("Subject ID=",which(ix)[u],"\n(gender=",Gender,", race=",rcc," & edu=",ed,")",  sep=""),axes=F, cex=1.2)
							axis(1,cex.axis=1.5)
							axis(2,cex.axis=1.5)
							axis(4, at=seq(0,1.5, by=0.25), labels=seq(0,1.5, by=0.25)*100, cex.axis=1.5)
							lines(ages, myrsk[ix,][u,], lty="dotted", col="red")

							mtext("Cig/day", side=4, line=2.2, cex=1.5)

							abline(h=myth, col="red")

							### estimated probablity ###
							 abline(v=mydata[ix,][u,"age_death_OC"]-1, col="blue", lty="dotted", lwd=1.5)

							cpdnames=paste("CPD",ages,sep=".")
							fhnames=paste("FH",ages,sep=".")
							phnames=paste("PH",ages,sep=".")
							copdnames=paste("COPD",ages,sep=".")

							lines(ages,mydata[ix,][u,cpdnames]/100,lty="dotted", col="dark green")#, lty="dotted")
							points(ages,mydata[ix,][u,cpdnames]/100,pch=18, col="dark green")#, lty="dotted")

							#### family history yes ###
							points(ages, mydata[ix,][u,fhnames]*0.1, pch=19, col="purple",cex=0.5)
							lines(ages,mydata[ix,][u,fhnames]*0.1,lty="dotted", col="purple")#, lty="dotted")

							#### COPD yes ###
							points(ages, mydata[ix,][u,copdnames]*0.09, pch=19, col="orange",cex=0.5)
							lines(ages,mydata[ix,][u,copdnames]*0.09,lty="dotted", col="orange")#, lty="dotted")

							#### PH yes ###
							points(ages, mydata[ix,][u,phnames]*0.08, pch=19, col="pink",cex=0.5)
							lines(ages,mydata[ix,][u,phnames]*0.08,lty="dotted", col="pink")#, lty="dotted")

							#### USPS yes ###
							points(ages, el.usps[ix,][u,]*0.2, pch=1, col="blue",cex=1)
							lines(ages,el.usps[ix,][u,]*0.2,lty="dotted", col="blue")#, lty="dotted")


							legend(x="topleft",legend=c("LC risk","Cig/Day", "OCM age" , "FH", "COPD","PH","USPSTF-elig"),pch=c(16,18, 16,19,19,19,1), col=c("red","dark green","blue", "purple","orange","pink","blue"),cex=1,
								lty=c("solid","dotted", "dotted","dotted","dotted","dotted","dotted"))

						}#end of loop


	}#end of  function myPlot.trj


#setwd(work);source("source.NLST.functions.R")
